{"message":"Contenedor de inicio","attributes":{"level":"info"},"timestamp":"2025-11-30T18:34:37.000000000Z"}
{"mensaje":"> rest-express@1.0.0 inicio","atributos":{"nivel":"información"},"marca de tiempo":"2025-11-30T18:34:37.553054138Z"}
{"mensaje":"> NODE_ENV=nodo de producción dist/index.js","atributos":{"nivel":"información"},"marca de tiempo":"2025-11-30T18:34:37.553067791Z"}
{"mensaje":"","atributos":{"nivel":"información"},"marca de tiempo":"2025-11-30T18:34:37.553077391Z"}
{"message":"npm warn config production Use `--omit=dev` en su lugar.","attributes":{"level":"error"},"timestamp":"2025-11-30T18:34:37.553465762Z"}
{"mensaje":"","atributos":{"nivel":"información"},"marca de tiempo":"2025-11-30T18:34:37.553472333Z"}
{"mensaje":"archivo:///app/dist/index.js:1","atributos":{"nivel":"error"},"marca de tiempo":"2025-11-30T18:34:37.952075292Z"}
{"mensaje":"var mt=Object.defineProperty;var fe=(n,t)=>()=>(n&&(t=n(n=0)),t);var xe=(n,t)=>{para(var r en t)mt(n,r,{obtener:t[r],enumerable:!0})};var J={};xe(J,{EnumeraciónDeCadena:()=>ft,PRECIOS:()=>le,CADENAS_SOPORTADAS:()=>me,EnumeraciónDeEstado:()=>yt,LÍMITES_DE_NIVEL:()=>H,EnumeraciónDeNivel:()=>gt,EVENTOS_DE_WEBHOOK:()=>Be,direcciones:()=>S,UsoDeAPI:()=>W,RegistrosDeAuditoría:()=>te,AgregacionesDeFacturación:()=>Q,CriptoTransacciones:()=>de,ConfiguraciónDeGas:()=>X,InsertarEsquemaDeDirección:()=>vt,InsertarEsquemaDeUsoDeAPI:()=>_t,InsertarLoCursoDeAuditoría gSchema:()=>xt,insertarEsquemaDeTransacciónCriptográfica:()=>At,insertarEsquemaDeMonederoMaestro:()=>It,insertarEsquemaDeInquilino:()=>bt,insertarEsquemaDeTransacción:()=>kt,insertarEsquemaDeCuentaVirtual:()=>wt,insertarEsquemaDeWebhook:()=>Tt,MonederosMaestros:()=>z,inquilinos:()=>x,RelacionesDeInquilinos:()=>ht,transacciones:()=>j,CuentasVirtuales:()=>_,webhooks:()=>K});import{sql como M}de\"drizzle-orm\";import{pgTable como q,texto como l,varchar como T,entero como E,booleano como Ve,marca de tiempo como R,jsonb como F,real como he,índice como v}de\"drizzle-orm/pg-core\";import{createInsertSchema como Y}de\"drizzle-zod\";import{z como Ke}de\"zod\";import{relaciones como pt}de\"drizzle-orm\";var gt,yt,ft,x,z,_,de,X,S,j,K,W,Q,te,ht,It,wt,At,bt,vt,kt,Tt,_t,xt,H,le,Be,me,D=fe(()=>{\"use estricto\";gt=Ke.enum([\"inicial\",\"escala\",\"empresa\"]),yt=Ke.enum([\"activo\",\"suspendido\",\"eliminado\"]),ft=Ke.enum([\"bitcoin\",\"ethereum\",\"solana\",\"polígono\",\"tron\",\"bsc\",\"ondulación\",\"cardano\",\"cerca\",\"polkadot\",\"avalancha\",\"arbitrum\",\"optimismo\",\"base\",\"fantom\",\"cronos\",\"cosmos\",\"algorand\"]),x=q(\"inquilinos\",{id:T(\"id\",{length:36}).primaryKey().default(M`gen_rand om_uuid()`), nombre: l(\"nombre\").notNull(), correo electrónico: l(\"correo electrónico\").notNull().único(), nivel: l(\"nivel\").notNull().predeterminado(\"inicial\"), estado: l(\"estado\").notNull().predeterminado(\"activo\"), apiKeyPrefix: T(\"api_key_prefix\",{longitud: 16}).notNull(), apiKeyHash: l(\"api_key_hash\").notNull().único(), hmacSecret: l(\"hmac_secret\").notNull(), allowedChains: l(\"allowed_chains\").array().notNull().predeterminado(M`ARRAY['bitcoin', 'ethereum', 'solana']`), direcciones máximas: E(\"direcciones máximas\").notNull().default(50), webhooks máximos: E(\"webhooks máximos\").notNull().default(1), cuentas virtuales máximas: E(\"cuentas virtuales máximas\").notNull().default(0), límite de tasa: E(\"límite de tasa\").notNull().default(10), cuota mensual: E(\"cuota mensual\").notNull().default(1e4), correo electrónico de facturación: l(\"correo electrónico de facturación\"), nombre de la empresa:l(\"nombre_de_la_empresa\"),sitio_web:l(\"sitio_web\"),lista_blanca_de_ip:l(\"lista_blanca_de_ip\").array(),metadatos:F(\"metadatos\"),createdAt:R(\"created_at\").defaultNow().notNull(),updatedAt:R(\"updated_at\").defaultNow().notNull()},n=>[v(\"id_de_correo_electrónico_de_inquilinos\").on(n.email),v(\"id_hash_de_clave_de_API_de_inquilinos\").on(n.apiKeyHa sh),v(\"idx_estado_inquilinos\").on(n.estado)]),z=q(\"monederos_principales\",{id:T(\"id\",{longitud:36}).clave_primaria().predeterminado(M`gen_random_uuid()`),escenario:l(\"escenario\").notNull(),cadena_de_bloques:l(\"cadena_de_bloques\").notNull(),tipo_de_activo:l(\"tipo_de_activo\").notNull(),nombre_de_activo:l(\"nombre_de_activo\").notNull(),dirección:l( \"dirección\").notNull().unique(),clavepública:l(\"clave pública\"),claveprivadacifrada:l(\"clave privada cifrada\"),claveprivadaIV:T(\"clave privadaIV\",{longitud:32}),etiquetadeautenticacióndeclaveprivada:T(\"etiquetadeautenticacióndeclaveprivada\",{longitud:32}),direccióndecontratointeligente:l(\"direccióndecontratointeligente\"),decimalesdetoken:E(\"decimalesdetoken \"),assignedToTenantId:T(\"id_asignado_al_inquilino\",{length:36}).references(()=>x.id),balance:l(\"saldo\").default(\"0\"),balanceUsd:l(\"saldo_usd\").default(\"0\"),lastSyncTime:R(\"última_sincronización\"),gasMarkupPercentage:E(\"porcentaje_de_margen_de_gas\").default(40),status:l(\"estado\").notNull().de fallo(\"activo\"), metadatos: F(\"metadatos\"), creado en: R(\"creado_en\"). predeterminadoAhora(). no nulo(), actualizado en: R(\"actualizado_en\"). predeterminadoAhora(). no nulo()}, n => [v(\"masters_blockchain_idx\"). en(n. cadena de bloques), v(\"masters_asset_idx\"). en(n. nombre_activo), v(\"masters_address_idx\"). en(n. dirección), v(\"masters_inquilino _idx\").on(n.assignedToTenantId),v(\"masters_scenario_idx\").on(n.scenario)]),_=q(\"cuentas_virtuales\",{id:T(\"id\",{longitud:36}).primaryKey().default(M`gen_random_uuid()`),tenantId:T(\"tenant_id\",{longitud:36}).notNull().references(()=>x.id,{onDelete:\"cascade\"}),accountType:l(\"tipo_de_cuenta\").n otNull(),saldos:F(\"saldos\").predeterminado(M`'{}'`),estado:l(\"estado\").notNull().predeterminado(\"activo\"),congelado:Ve(\"congelado\").predeterminado(!1),metadatos:F(\"metadatos\"),createdAt:R(\"creado_en\").defaultNow().notNull(),updatedAt:R(\"actualizado_en\").defaultNow().notNull()},n=>[v(\"inquilino_de_cuentas_virtuales_i dx\").on(n.Id_de_inquilino),v(\"id_de_estado_de_cuentas_virtualesx\").on(n.estado)]),de=q(\"transacciones_criptográficas\",{id:T(\"id\",{longitud:36}).clave_primaria().predeterminado(M`gen_random_uuid()`),Id_de_inquilino:T(\"id_de_inquilino\",{longitud:36}).notNull().referencias(()=>x.id,{onDelete:\"cascada\"}),tipo:l(\"tipo\").notNull(),escenario:l(\"escenario\").notNull(),fromAccountId:T(\"from_account_id\",{longitud:36}),toAccountId:T(\"to_count_id\",{longitud:36}),toExternalAddress:l(\"to_external_address\"),fromExternalAddress:l(\"from_external_address\"),assetType:l(\"tipo_de_activo\").notNull(),assetName:l(\"nombre_de_activo\").notNull(),blockchain:l(\"blockchain\").notNull(),amount:l(\"mount\"). notNull(),gasReal:l(\"gas_real\"),gasMarkupPercent:E(\"gas_markup_percent\"),gasCharged:l(\"gas_charged\"),commissionAmount:l(\"commission_mont\"),commissionUsd:l(\"comission_usd\"),status:l(\"status\").notNull().default(\"pending\"),txHash:l(\"tx_hash\").unique(),blockNumber:E(\"block_number\"),confirmations:E(\"confirmations\"),metadata:F(\"me tadata\"), creado en: R(\"creado_en\"). predeterminadoAhora(). no nulo(), ejecutado en: R(\"ejecutado_en\"), confirmado en: R(\"confirmado_en\")}, n => [v(\"idx_de_inquilino_de_transacción_criptográfica\"). en(n. id_de_inquilino), v(\"idx_de_tipo_de_transacción_criptográfica\"). en(n. tipo), v(\"idx_de_estado_de_transacción_criptográfica\"). en(n. estado), v(\"idx_hash_de_transacción_criptográfica\"). en(n. hash_de_transacción), v(\"idx_de_escenario_de_transacción_criptográfica\"). en(n. escenario)]), X = q(\"setti_gas ngs\",{id:T(\"id\",{longitud:36}).primaryKey().default(M`gen_random_uuid()`),marcadopredeterminadoglobal:E(\"marcadopredeterminadoglobal\").default(40),marcadomín:E(\"marcadomín\").default(10),marcadomáx:E(\"marcadomáx\").default(100),anulacionesdecliente:F(\"anulacionesdecliente\").default(M`'{}'`),multiplicadoresdecadenadebloques:F(\"multiplicadoresdecadenadebloques\").default(M`'{\"ethereum\": 1.0, \"polígono\": 0.3}'`),Anulaciones de tipo de transacción:F(\"anulaciones de tipo de transacción\").predeterminado(M`'{\"retiro_cripto\": 40, \"transferencia_de_token\": 45}'`),updatedAt:R(\"updated_at\").defaultNow().notNull(),updatedBy:l(\"updated_by\")},n=>[v(\"gas_settings_updated_idx\").on(n.updatedAt)]),S=q(\"direcciones\",{id:T(\"id\",{longitud:36}).primaryKey().default(M`gen_random_uuid()`),tenantId:T(\"tenant_id\",{longitud:36}).notNull().references(()=>x.id,{onDelete:\"cascade\"}),chain:l(\"cadena\").notNull(),currency:l(\"currency\").notNull(),address: l(\"dirección\").notNull(),publicKey:l(\"clave_pública\"),derivationPath:l(\"ruta_derivación\"),label:l(\"etiqueta\"),tags:l(\"etiquetas\").array().default(M`ARRAY[]::text[]`),status:l(\"estado\").notNull().default(\"activo\"),balance:l(\"balance\").default(\"0\"),balanceUsd:l(\"balance_usd\").default(\"0\"),lastSynced:R(\"last_synced\"),webhookUrl:l(\"webhook_url\"),metadatos:F(\"metadatos\"),createdAt:R(\"creado_en\").defaultNow().notNull(),actualizadoEn:R(\"actualizado_en\").defaultNow().notNull(),eliminadoEn:R(\"eliminado_en\")},n=>[v(\"direcciones_idx_de_inquilino\").on(n.Id_de_inquilino),v(\"direcciones_idx_de_cadena\").on(n.cadena),v(\"direcciones_idx_de_estado\").on(n.estado),v(\"direcciones_idx_de_dirección\").on(n.dirección)] ),j=q(\"transacciones\",{id:T(\"id\",{longitud:36}).primaryKey().default(M`gen_random_uuid()`),tenantId:T(\"id_tenant\",{longitud:36}).notNull().references(()=>x.id,{onDelete:\"cascade\"}),txHash:l(\"tx_hash\").notNull(),chain:l(\"cadena\").notNull(),fromAddress:l(\"from_address\"),toAddress:l(\"t o_dirección\"), importe: l(\"importe\").notNull(), moneda: l(\"moneda\").notNull(), cuota: l(\"cuota\"), cuotaUsd: l(\"cuota_usd\"), estado: l(\"estado\").notNull().default(\"pendiente\"), tipo: l(\"tipo\").notNull().default(\"nativo\"), númerodebloque: E(\"númerodebloque\"), confirmaciones: E(\"confirmaciones\").default(0 ), metadatos: F(\"metadatos\"), creado en: R(\"creado_en\"). predeterminado ahora(). no nulo()}, n => [v(\"idx_de_inquilino_de_transacciones\"). en(n. ID_de_inquilino), v(\"idx_de_cadena_de_transacciones\"). en(n. cadena), v(\"idx_de_hash_de_transacciones\"). en(n. Hash_de_tx), v(\"idx_de_estado_de_transacciones\"). en(n. estado)]), K = q(\"webhooks\", {id: T(\"id\", {le longitud: 36}). claveprimaria(). predeterminado(M`gen_random_uuid()`), ID_inquilino: T(\"ID_inquilino\",{longitud: 36}). no nulo(). referencias(()=>x.id,{onDelete:\"cascada\"}), URL: l(\"URL\"). no nulo(), eventos: l(\"eventos\"). matriz(). no nulo(), secreto_hmac: l(\"secreto_hmac\"). no nulo(), activo: Ve(\"activo\"). predeterminado(!0), reintentarCou nt:E(\"retry_count\").default(0),lastTriggered:R(\"last_triggered\"),lastStatus:E(\"last_status\"),metadatos:F(\"metadatos\"),createdAt:R(\"created_at\").defaultNow().notNull()},n=>[v(\"webhooks_tenant_idx\").on(n.tenantId),v(\"webhooks_active_idx\").on(n.active)]),W=q(\"api_usage\",{id:T(\"id \",{longitud:36}).primaryKey().default(M`gen_random_uuid()`),tenantId:T(\"tenant_id\",{longitud:36}).notNull().references(()=>x.id,{onDelete:\"cascade\"}),endpoint:l(\"endpoint\").notNull(),method:l(\"method\").notNull(),chain:l(\"chain\"),action:l(\"action\").notNull(),units:he(\"units\").notN ull(), créditos:he(\"créditos\").notNull(), código de estado:E(\"código de estado\").notNull(), id de solicitud:T(\"id de solicitud\",{longitud:36}).notNull(), tiempo de respuesta Ms:E(\"ms de tiempo de respuesta\"), metadatos:F(\"metadatos\"), marca de tiempo:R(\"marca de tiempo\").defaultNow().notNull()}, n=>[v(\"id de inquilino de uso de API\").on(n.id de inquilino),v(\"api_usage_timestamp_idx\").on(n.timestamp),v(\"api_usage_action_idx\").on(n.action)]),Q=q(\"agregaciones_de_facturación\",{id:T(\"id\",{longitud:36}).primaryKey().default(M`gen_random_uuid()`),tenantId:T(\"id_de_teniente\",{longitud:36}).notNull().references(()=>x.id,{onDelete:\"cascade\"}),periodo:l(\"periodo\").notNull(),periodType:l(\"tipo_de_periodo\").notNull().default(\"diario\"),totalUnits:he(\"unidades_totales\").notNull().def ault(0), totalCredits:he(\"total_créditos\").notNull().default(0), costUsd:he(\"costo_usd\").notNull().default(0), breakdown:F(\"break\"), createdAt:R(\"created_at\").defaultNow().notNull()}, n=>[v(\"billing_tenant_period_idx\").on(n.tenantId,n.period)]), te=q(\"audit_logs\",{id:T(\"id\",{length:36}).primaryKey().default(M`gen_random_uuid()`), tenantId:T(\"tenant_id\",{length:36}).references(()=>x.id,{onDelete:\"set null\"}),ID_usuario:l(\"id_usuario\"),acción:l(\"acción\").notNull(),recurso:l(\"recurso\").notNull(),ID_recurso:l(\"id_recurso\"),cambios:F(\"cambios\"),Dirección_IP:l(\"dirección_IP\"),Agente_usuario:l(\"agente_usuario\"),ID_solicitud:T(\"id_solicitud\",{longitud:36}),marca_de_tiempo:R(\"marca_de_tiempo\").defaultNow().notNull()},n=>[v(\"audit_logs_tenant_idx\").on(n.Id_tenant),v(\"audit_logs_timestamp_idx\").on(n.marca_de_tiempo),v(\"audit _logs_action_idx\").on(n.action)]),ht=pt(x,({muchos:n})=>({direcciones:n(S),transacciones:n(j),webhooks:n(K),cuentasvirtuales:n(_),apiUsage:n(W),agregacionesdefacturación:n(Q),registrosdeauditoría:n(te),monederosprincipales:n(z),criptotransacciones:n(de)})),It=Y(z).omit({id:!0,createdAt:!0,updatedAt:!0}),wt=Y(_).omit({id:!0,createdAt:!0,updatedAt:!0}),At=Y(de).omit({id:!0,createdAt:!0,executedAt:!0,confirmedAt:!0}),bt=Y(x).omit({ id:!0,createdAt:!0,updatedAt:!0}),vt=Y(S).omit({id:!0,createdAt:!0,updatedAt:!0,deletedAt:!0}),kt=Y(j).omit({id:!0,createdAt:!0}),Tt=Y(K).omit({id:!0,createdAt:!0}),_t=Y(W).omit({id:!0,timestamp:!0}),xt=Y(te).omit({id:!0,timestamp:!0}),H={starter:{chains:[\"bitcoin\",\"ethereum\",\"solana\"],maxAddresses:50,maxWebhooks:1,maxVirtualAccounts:0,rateLimit:10,monthlyQuota:1e4,kmsAllowed:!1,archivalAccess :!1, días de retención: 1}, escala: {cadenas: [\"bitcoin\",\"ethereum\",\"solana\",\"polígono\",\"tron\",\"bsc\",\"ripple\",\"cardano\"], direcciones máximas: 1e3, webhooks máximos: 10, cuentas virtuales máximas: 5, límite de tasa: 100, cuota mensual: 1e5, km permitidos:!0, acceso de archivo:!1, días de retención: 7}, empresa: {cadenas: [\"bitcoin\",\"ethereum\",\"solana\",\"polígono\",\"tron\",\"bsc\",\"ripple\",\"cardano\",\"near\",\"polkadot\",\"avalancha\",\"arbitro\",\"optimismo\",\"base\",\"fantasma\",\"cronos\",\"cosmos\",\"algorand\"],máximo de direcciones: -1,máximo de webhooks: -1,máximo de cuentas virtuales: 50,límite de tasa: 1e3,cuota mensual: -1,km permitidos: !0,acceso de archivo: !0,días de retención: 30}},le={creación de dirección:{unidades: 1,costo: 0,001},consulta de saldo:{unidades: 0,costo: 5e-4},saldo de token:{unidades: 1,costo: 0,001},metadatos nft:{unidades: 2,costo: 0,002},tx_br oadcast_btc:{unidades: 50, costo: 0,05}, tx_broadcast_eth:{unidades: 10, costo: 0,01}, tx_broadcast_other:{unidades: 10, costo: 0,01}, tx_history:{unidades: 2, costo: 0,002}, webhook_subscription:{unidades: 0,02, costo: 0,02}, va_create:{unidades: 100, costo: 0,1}, va_transfer:{unidades: 5, costo: 0,005}, tipo de cambio:{unidades: 0,1, costo: 1e-4}, web3_resolve:{unidades: 1, costo: 0,001}, malicioso_check:{unidades: 2, costo: 0,002}, rpc_standard:{u nits:2,costo:2e-4},rpc_eth_call:{unidades:5,costo:5e-4},rpc_debug:{unidades:50,costo:.005}},Be=[\"TRANSACCIÓN_DIRECCIÓN\",\"SALDO_DIRECCIÓN\",\"TRANSACCIÓN_NATIVA_ENTRANTE\",\"TRANSACCIÓN_NATIVA_SALIENTE\",\"TRANSACCIÓN_FUNGIBLE_ENTRANTE\",\"TRANSACCIÓN_FUNGIBLE_SALIENTE\",\"TRANSACCIÓN_NFT_ENTRANTE\",\"TRANSACCIÓN_NFT_SALIENTE\",\"TRANSACCIÓN_MULTITOKEN_ENTRANTE\",\"TRANSACCIÓN_MULTITOKEN_SALIENTE\",\"TRANSACCIÓN_FALLIDA\",\"CUOTA_PAGADA\",\"REGISTRO_DE_CONTRATO _EVENTO\"],me=[{id:\"bitcoin\",nombre:\"Bitcoin\",símbolo:\"BTC\",icono:\"\\u20BF\"},{id:\"ethereum\",nombre:\"Ethereum\",símbolo:\"ETH\",icono:\"\\u039E\"},{id:\"solana\",nombre:\"Solana\",símbolo:\"SOL\",icono:\"\\u25CE\"},{id:\"polígono\",nombre:\"Polígono\",símbolo:\"MATIC\",icono:\"\\u2B21\"},{id:\"tron\",nombre:\"Tron\",símbolo:\"TRX\",icono:\"\\u2666\"},{id:\"bsc\",nombre:\"BNB Cadena\", símbolo:\"BNB\", icono:\"\\u25C6\"},{id:\"ripple\", nombre:\"XRP Ledger\", símbolo:\"XRP\", icono:\"\\u2715\"},{id:\"cardano\", nombre:\"Cardano\", símbolo:\"ADA\", icono:\"\\u20B3\"},{id:\"near\", nombre:\"NEAR\", símbolo:\"NEAR\", icono:\"\\u24C3\"},{id:\"polkadot\", nombre:\"Polkadot\", símbolo:\"DOT\", icono:\"\\u25CF\"},{id:\"avalanche\", nombre:\"Avalanche\", símbolo:\"AVAX\", icono:\"\\u25B2\"},{id:\"arb itrum\", nombre:\"Arbitrum\", símbolo:\"ARB\", icono:\"\\u25C8\"},{id:\"optimism\", nombre:\"Optimism\", símbolo:\"OP\", icono:\"\\u2295\"},{id:\"base\", nombre:\"Base\", símbolo:\"ETH\", icono:\"\\u25EF\"},{id:\"fantom\", nombre:\"Fantom\", símbolo:\"FTM\", icono:\"\\u25C7\"},{id:\"cronos\", nombre:\"Cronos\", símbolo:\"CRO\", icono:\"\\u25CE\"},{id:\"cosmos\",nombre:\"Cosmos\",símbolo:\"ATOM\",icono:\"\\u269B\"},{id:\"algorand\",nombre:\"Algorand\",símbolo:\"ALGO\",icono:\"\\u24B6\"}]});var oe={};xe(oe,{db:()=>f,pool:()=>Ye});import{Pool como St,neonConfig como Pt}desde\"@neondatabase/serverless\";import{drizzle como Rt}desde\"drizzle-orm/neon-serverless\";import Et desde\"ws\";var Ye,f,V=fe(()=>{\"use strict\";D();Pt.webSocketConstructor=Et;if(!process.env.DATABASE_URL)throw new Error(\"DATABASE_URL debe ser ¿Olvidaste aprovisionar una base de datos?\"); Ye=new St({connectionString:process.env.DATABASE_URL}), f=Rt({client:Ye,schema:J})}); function jt(n){return!n||typeof n!=\"string\"||n.length<32?!1:/^[a-zA-Z0-9_-]{32,}$/.test(n)} function Bt(){return P.state===\"open\"?Date.now()-P.lastFailure>=$e.resetTimeoutMs?(P.state=\"half-open\",P.successesInHalfOpen=0,!0):!1:!0} function Dt(){P.estado===\"semiabierto\"?(P.éxitosEnMedioApertura++,P.éxitosEnMedioApertura>=$e.umbralDeÉxitoDeAperturaMedia&&(P.estado=\"cerrado\",P.fallos=0)):P.fallos=0}función ze(){P.fallos++,P.últimoFallo=Fecha.ahora(),(P.estado===\"semiabierto\"||P.fallos>=$e.umbralDeFallo)&&(P.estado=\"abierto\")}función Ut(n,t){devolver t.EstadosReintentables.includes(n)}función Xe(n,t){devolver Math.min(t.baseDelayMs*Math.pow(2,n)+Math.random()*1e3,t.maxDelayMs)}función asíncrona Qe(n){devuelve nueva Promesa(t=>setTimeout(t,n))}función asíncrona N(n,t={},r=Kt){si(!Bt())devuelve{éxito:!1,error:\"Servicio temporalmente no disponible (disyuntor abierto)\",statusCode:503};let i=null;for(let u=0;u<=r.maxRetries;u++)try{let g=new AbortController,h=setTimeout(()=>g.abort(),3e4),s=await fetch(`${Mt}${n}`,{...t,señal:g.señal,encabezados:{\"Tipo-Contenido\":\"aplicación/json\",\"clave-x-api\":Fe||\"\",...t.encabezados}});clearTimeout(h);let a=await s.json().catch(()=>null);if(!s.ok){let e={éxito:!1,error:a?.mensaje||a?.error||`HTTP ${s.estado}`,código-estado:s.estado};if(s.estado===429){let o=s.headers.get(\"Retry-After\");o&&(e.retryAfter=parseInt(o,10)*1e3)}if(Ut(s.status,r)&&u<r.maxRetries){i=e;let o=e.retryAfter||Xe(u,r);await Qe(o);continue}return ze(),e}return Dt(),{éxito:!0,datos:a}}catch(g){let h=g.name===\"Error de cancelación\",s=g.message?.includes(\"obtener\")||g.message?.includes(\"red\"),a={éxito:!1,error:h?\"Tiempo de espera de la solicitud\":g.message||\"Red error\",statusCode:h?408:500};if((h||s)&&u<r.maxRetries){i=a,await Qe(Xe(u,r));continue}return ze(),a}return i||{éxito:!1,error:\"Se excedió el máximo de reintentos\",statusCode:500}}function Je(n){return me.find(t=>t.id===n)}var Mt,Fe,Kt,P,$e,se,B,Oe=fe(()=>{\"use strict\";D();Mt=process.env.TATUM_API_URL||\"https://api.tatum.io\",Fe=process.env.TATUM_API_KEY;Fe?jt(Fe)||console.warn(\"El formato de TATUM_API_KEY parece no ser válido; puede causar errores de API\"):console.warn(\"TATUM_API_KEY no configurado; las llamadas a la API fail\"); Kt={máx.Reintentos:3,Ms.deRetardoBase:1e3,Ms.deRetardoMax:3e4,EstadosReintentables:[408,429,500,502,503,504]}, P={fallos:0,últimoFallo:0,estado:\"cerrado\",éxitosEnMedioApertura:0}, $e={UmbralDeFallo:5,Ms.deRestablecimientoTiempoDeEspera:6e4,UmbralDeÉxitoEnMedioApertura:2}; se={bitcoin:\"bitcoin\",ethereum:\"ethereum\",solana:\"solana\",polygon:\"polígono\",tron:\"tron\",bsc:\"bsc\",ri pple:\"xrp\",cardano:\"ada\",near:\"near\",polkadot:\"dot\",avalanche:\"avax\",arbitrum:\"arbitrum-one\",optimismo:\"optimismo\",base:\"base\",fantom:\"fantom\",cronos:\"cro\",c osmos:\"atom\",algorand:\"algo\"},B={getCircuitBreakerState(){return{...P}},resetCircuitBreaker(){P.failures=0,P.lastFailure=0,P.state=\"closed\",P.successesInHalfOpen=0},async generateAddress(n){let t=se[n]||n;return N(`/v3/${t}/wallet`,{método:\"GET\"})},async getBalance(n,t){let r=se[n]||n;return[\"ethereum\",\"polígono\",\"bsc\",\"arbitrum-one\",\"optimism\",\"base\"].includes(r)?N(`/v3/${r}/account/balance/${t}`):N(r===\"bitcoin\"?`/v3/bitcoin/address/balance/${t}`:r===\"solana\"?`/v3/solana/account/balance/${t}`:`/v3/${r}/account/balance/${t}`)},async getTokens(n,t){let r=se[n]||n;devuelve N(`/v3/data/tokens?chain=${r}&addresses=${t}`)},asincrónico obtenerNFTs(n,t){let r=se[n]||n;devuelve N(`/v3/data/nfts?chain=${r}&addresses=${t}`)},asincrónico obtenerHistorialDeTransacciones(n,t,r){let i=se[n]||n,u=nuevosParámetrosDeBúsquedaDeURL;devuelve r?.TamañoDePágina&&u.set(\"TamañoDePágina\",r.TamañoDePágina.toString()),r?.Desplazamiento&&u.set(\"Desplazamiento\",r.Desplazamiento.toString()),N(`/v3/data/transacciones?chain=${i}&addresses=${t}&${u.toString()}`)},asincrónico getTransaction(n,t){let r=se[n]||n;devuelve N(`/v3/${r}/transaction/${t}`)},async estimateFee(n,t=\"TRANSFER\"){let r=se[n]||n;devuelve N(`/v3/${r}/gas/estimate`,{método:\"POST\",cuerpo:JSON.stringify({tipo:t})})},async broadcastTransaction(n,t){let r=se[n]||n;devuelve N(`/v3/${r}/broadcast`,{método:\"POST\",cuerpo:JSON.stringify({txData:t})})},async getExchangeRates(n){let t=n.join(\",\");devuelve N(`/v3/tatum/rate/${t}?basePair=USD`)}, asíncrono resolveWeb3Name(n){devuelve N(`/v3/blockchain/names/${n}`)}, asíncrono checkMaliciousAddress(n){devuelve N(`/v3/security/address/${n}`)}, asíncrono createWebhook(n){devuelve N(\"/v4/subscription\",{método:\"POST\",cuerpo:JSON.stringify(n)})}, asíncrono deleteWebhook(n){devuelve N(`/v4/subscription/${n}`,{método:\"DELETE\"})}, asíncrono getWebhooks(){devuelve N(\"/v4/subscription\")},async healthCheck(){let n=await N(\"/v3/tatum/version\"); return n.success?{success:!0, data:{status:\"healthy\", version:n.data?.version||\"v3\", circuitBreaker:{...P}}}:{...n, data:{status:\"degraded\", version:\"unknown\", circuitBreaker:{...P}}}}}});var ve={};xe(ve,{GasFeeManager:()=>Ee,gasFeeManager:()=>Le});import{eq as Ge}from\"drizzle-orm\";var Ee,Le,ge=fe(()=>{\"use strict\";V();D();Ee=class{config=null;async loadConfig(){let[t]=await f.select().from(X).limit(1);if(!t){let r={Margen predeterminado global: 40, Margen mínimo: 10, Margen máximo: 100, Anulaciones de cliente:{}, Multiplicadores de cadena de bloques:{ethereum: 1, polígono: .3, bitcoin: 1.2, solana: .1, arbitraje: .2}, Anulaciones de tipo de transacción:{retiro_cripto: 40, transferencia_de_token: 45, contrato_inteligente: 60}};return this.config=r,r}return this.config={globalDefaultMarkup:t.globalDefaultMarkup,minMarkup:t.minMarkup,maxMarkup:t.maxMarkup,clientOverrides:t.clientOverrides||{},blockchainMultipliers:t.blockchainMultipliers||{},transactionTypeOverrides:t.transactionTypeOverrides||{}},this.config}async calculateGasMarkup(t){this.config||await this.loadConfig();let r=this.config.globalDefaultMarkup;if(t.clientId&&this.config.clientOverrides[t.clientId]){let a=this.config.clientOverrides[t.clientId];if(a.expiresAt){let e=new Date(a.expiresAt);new Date<e&&(r=a.markup)}else r=a.markup}let i=this.config.transactionTypeOverrides[t.transactionType];i&&(r=i);let u=this.config.blockchainMultipliers[t.blockchain]||1;r=Math.round(r*u),r=Math.max(this.config.minMarkup,Math.min(this.config.maxMarkup,r));let g=t.gasReal*(r/100),h=t.gasReal+g,s=g;return{gasReal:t.gasReal,gasMarkupPercent:r,gasCharged:h,yourProfit:s}}async updateGlobalMarkup(t,r){t=Math.max(10,Math.min(100,t)),await f.update(X).set({globalDefaultMarkup:t,updatedAt:new Fecha,actualizadoPor:r}).donde(Ge(X.id,\"predeterminado\")),this.config=null,await this.loadConfig()}async setClientMarkup(t,r,i,u,g){this.config||await this.loadConfig();let h=this.config.clientOverrides;h[t]={markup:Math.max(10,Math.min(100,r)),reason:i,expiresAt:g?.toISOString()},await f.update(X).set({clientOverrides:h,actualizadoEn:new Fecha,actualizadoPor:u}).donde(Ge(X.id,\"predeterminado\")),this.config=null,await this.loadConfig()}async removeClientMarkup(t,r){this.config||await this.loadConfig();let i=this.config.clientOverrides;eliminar i[t],esperar f.update(X).set({clientOverrides:i,actualizadoEn:nueva Fecha,actualizadoPor:r}).where(Ge(X.id,\"predeterminado\")),this.config=null,esperar this.loadConfig()}getConfig(){devolver this.config}},Le=new Ee});var ke={};xe(ke,{CryptoGateway:()=>Ne,cryptoGateway:()=>Ht});importar Lt desde\"crypto\";importar{eq como G y como Wt} desde\"drizzle-orm\";var Ne,Ht,Te=fe(()=>{\"usar estricto\";Oe();ge();V();D();Ne=class{async createVirtualAccount(t,r){devolver(esperar f.insert(_).values({Id.inquilino:t,TipoDeCuenta:r,Saldos:JSON.stringify({})}).returning())[0]}async internalSwap(t){let r=await f.query.virtualAccounts.findFirst({where:G(_.id,t.fromAccountId)});if(!r)throw new Error(\"No se encontró la cuenta\");let i=JSON.parse(r.balances||\"{}\"),u=parseFloat(i[t.assetName]||\"0\");if(u<parseFloat(t.fromAmount))throw new Error(\"Saldo insuficiente\");let g=parseFloat(t.toAmount)*.005,h=parseFloat(t.toAmount)-g,s={...i};s[t.assetName]=(u-parseFloat(t.fromAmount)).toString(),await f.update(_).set({balances:JSON.stringify(s)}).where(G(_.id,t.fromAccountId));let a=espera f.consulta.cuentasvirtuales.findFirst({donde:G(_.id,t.toAccountId)}),e=JSON.parse(a?.balances||\"{}\");devuelve e[t.nombreDeActivo]=(parseFloat(e[t.nombreDeActivo]||\"0\")+h).toString(),espera f.update(_).set({balances:JSON.stringify(e)}).donde(G(_.id,t.toAccountId)),{txId:(espera f.insert(de).values({Id.inquilino:t.Id.inquilino,tipo:\"intercambio_interno\",escenario:t.scenario,Id.deCuenta:t.deCuenta,Id.deCuenta:t.deCuenta,Tipo.deActivo:\"cripto\",Nombre.deActivo:t.deActivo,cadena.de.blockchain:t.blockchain,importe:t.deImporte,importe.de.comisión:g.de.Cadena(),comisión.Usd:(g*45e3).de.Cadena(),estado:\"completado\"}).returning())[0].id,estado:\"completado\",deImporte:t.deImporte,de.Importe:t.de.Importe,comisión:g.de.Fijo(8),neto.Recibido:h.de.Fijo(8),ejecutadoEn:nuevaFecha().de.CadenaISO()}}asincrónico externalWithdraw(t){let r=await f.query.masterWallets.findFirst({where:Wt(G(z.assetName,t.assetName),G(z.blockchain,t.blockchain),G(z.scenario,t.scenario))});if(!r)throw new Error(`No se encontró la billetera maestra para ${t.assetName} en ${t.blockchain}`);let i=await B.estimateGas({blockchain:t.blockchain,assetType:t.assetName===r.smartContractAddress?\"token\":\"crypto\",amount:t.amount}),u=await Le.calculateGasMarkup({clientId:t.tenantId,blockchain:t.blockchain,transactionType:t.assetName===\"BTC\"?\"crypto_withdraw\":\"token_transfer\",gasReal:i.gasReal}),g=await f.query.virtualAccounts.findFirst({where:G(_.id,t.fromAccountId)}),h=JSON.parse(g?.balances||\"{}\"),s=parseFloat(h[t.assetName]||\"0\");if(s<parseFloat(t.amount))throw new Error(\"Saldo insuficiente\");h[t.assetName]=(s-parseFloat(t.amount)).toString(),await f.update(_).set({balances:JSON.stringify(h)}).where(G(_.id,t.fromAccountId));let a=`0x${Lt.randomBytes(32).toString(\"hex\")}`;return{txId:(await f.insert(de).values({Id.inquilino:t.inquilino,tipo:\"retiro_externo\",escenario:t.scenario,toExternalAddress:t.toExternalAddress,tipo.activo:\"cripto\",nombre.activo:t.nombre.activo,blockchain:t.blockchain,cantidad:t.cantidad,gasReal:u.gasReal.toString(),porcentaje.de.margen.gas:u.porcentaje.de.margen.gas,gasCargado :u.gasCharged.toString(),commissionAmount:u.yourProfit.toString(),status:\"pendiente\",txHash:a}).returning())[0].id,status:\"pendiente_de_confirmación\",txHash:a,amount:t.amount,gasReal:u.gasReal.toFixed(8),gasCharged:u.gasCharged.toFixed(8),yourProfit:u.yourProfit.toFixed(8),estimatedTime:\"12 segundos\"}}async assignMasterToClient(t,r,i){return await f.update(z).set({assignedToTenantId:r,gasMarkupPercentage:i}).where(G(z.id,t)),{success:!0,masterId:t,assignedTo:r,gasMarkup:i,assignedAt:new Date().toISOString()}}async getVirtualAccountBalance(t){let r=await f.query.virtualAccounts.findFirst({where:G(_.id,t)});if(!r)throw new Error(\"Cuenta no encontrada\");let i=JSON.parse(r.balances||\"{}\"); return{accountId:t,balances:i,totalUsd:Object.entries(i).reduce((u,[g,h])=>{let s={ETH:2500,BTC:45e3,GOLD:500,SILVER:250}; return u+parseFloat(h)*(s[g]||0)},0)}}},Ht=new Ne});import Ce de\"express\";import{z como w} de\"zod\";D();V();import{eq como A,and como Z,desc como ie,sql como De,gte como Nt,lte como Ct} de\"drizzle-orm\";var Ue=class{async getTenant(t){let[r]=await f.select().from(x).where(A(x.id,t));return r||void 0}async getTenantByApiKeyHash(t){let[r]=await f.select().from(x).where(A(x.apiKeyHash,t));return r||void 0}async getTenantByEmail(t){let[r]=await f.select().from(x).where(A(x.email,t));return r||void 0}async getAllTenants(){return f.select().from(x).orderBy(ie(x.createdAt))}async createTenant(t){let[r]=await f.insert(x).values(t).returning();return r}async updateTenant(t,r){let[i]=await f.update(x).set({...r,updatedAt:nueva fecha}).where(A(x.id,t)).returning();devolver i||void 0}async deleteTenant(t){await f.update(x).set({estado:\"eliminado\",updatedAt:nueva fecha}).where(A(x.id,t))}async getAddress(t){let[r]=await f.select().from(S).where(A(S.id,t));devolver r||void 0}async getAddressByAddress(t,r,i){let[u]=await f.select().from(S).where(Z(A(S.tenantId,t),A(S.chain,r),A(S.address,i)));devolver u||void 0}async getAddressesByTenant(t,r){let i=f.select().from(S).where(A(S.tenantId,t)),u=[A(S.tenantId,t)];devuelve r?.chain&&u.push(A(S.chain,r.chain)),r?.status&&u.push(A(S.status,r.status)),f.select().from(S).where(Z(...u)).orderBy(ie(S.createdAt)).limit(r?.limit||50).offset(r?.offset||0)}asincrónico countAddressesByTenant(t){let[r]=await f.select({count:De`count(*)`}).from(S).where(Z(A(S.tenantId,t),A(S.status,\"active\")));devuelve r?.count||0}asincrónico createAddress(t){let[r]=await f.insert(S).values(t).returning();return r}async updateAddress(t,r){let[i]=await f.update(S).set({...r,updatedAt:nueva fecha}).where(A(S.id,t)).returning();return i||void 0}async archiveAddress(t){await f.update(S).set({estado:\"archivado\",eliminadoAt:nueva fecha,updatedAt:nueva fecha}).where(A(S.id,t))}async getTransaction(t){let[r]=await f.select().from(j).where(A(j.id,t));return r||void 0}async getTransactionByHash(t,r){let[i]=await f.select().from(j).where(Z(A(j.chain,t),A(j.txHash,r)));return i||void 0}async getTransactionsByTenant(t,r){let i=[A(j.tenantId,t)];return r?.chain&&i.push(A(j.chain,r.chain)),r?.status&&i.push(A(j.status,r.status)),f.select().from(j).where(Z(...i)).orderBy(ie(j.createdAt)).limit(r?.limit||50).offset(r?.desplazamiento||0)}asincrónico createTransaction(t){let[r]=await f.insert(j).values(t).returning();devolver r}asincrónico updateTransaction(t,r){let[i]=await f.update(j).set(r).where(A(j.id,t)).returning();devolver i||void 0}asincrónico getWebhook(t){let[r]=await f.select().from(K).where(A(K.id,t));devolver r||void 0}asincrónico getWebhooksByTenant(t){devolver f.select().from(K).where(A(K.tenantId,t)).orderBy(ie(K.createdAt))}asincrónico countWebhooksByTenant(t){let[r]=await f.select({count:De`count(*)`}).from(K).where(Z(A(K.tenantId,t),A(K.active,!0)));devuelve r?.count||0}asinc createWebhook(t){let[r]=await f.insert(K).values(t).returning();devuelve r}asinc updateWebhook(t,r){let[i]=await f.update(K).set(r).where(A(K.id,t)).returning();devuelve i||void 0}asinc deleteWebhook(t){await f.delete(K).where(A(K.id,t))}asinc getVirtualAccount(t){let[r]=await f.select().from(_).where(A(_.id,t));devuelve r||void 0}asinc obtenerCuentasVirtualesPorInquilino(t){devolver f.seleccionar().de(_).donde(A(_.IdInquilino,t)).ordenarPor(ie(_.createdAt))}asincrónico contarCuentasVirtualesPorInquilino(t){let[r]=await f.seleccionar({count:De`count(*)`}).de(_).donde(Z(A(_.IdInquilino,t),A(_.estado,\"activo\")));devolver r?.count||0}asincrónico crearCuentaVirtual(t){let[r]=await f.insertar(_).valores(t).devolver();devolver r}asincrónico actualizarCuentaVirtual(t,r){let[i]=await f.actualizar(_).set(r).donde(A(_.id,t)).devolver();devolver i||void 0}asincrónico recordApiUsage(t){let[r]=await f.insert(W).values(t).returning();return r}async getApiUsageByTenant(t,r,i){return f.select().from(W).where(Z(A(W.tenantId,t),Nt(W.timestamp,r),Ct(W.timestamp,i))).orderBy(ie(W.timestamp))}async getApiUsageStats(t,r,i){let u=await this.getApiUsageByTenant(t,r,i),g={},h={},s=0,a=0;for(let e of u)s+=e.unidades,a+=e.créditos,g[e.punto final]=(g[e.punto final]||0)+1,e.cadena&&(h[e.cadena]=(h[e.cadena]||0)+1);return{totalRequests:u.length,totalUnits:s,totalCredits:a,byEndpoint:g,byChain:h}}async getBillingAggregation(t,r){let[i]=await f.select().from(Q).where(Z(A(Q.tenantId,t),A(Q.periodo,r)));return i||void 0}async upsertBillingAggregation(t){let r=await this.getBillingAggregation(t.tenantId,t.periodo);if(r){let[i]=await f.update(Q).set(t).where(A(Q.id,r.id)).returning();return i}else{let[i]=await f.insert(Q).values(t).returning();return i}}async createAuditLog(t){let[r]=await f.insert(te).values(t).returning();return r}async getAuditLogsByTenant(t,r=100){return f.select().from(te).where(A(te.tenantId,t)).orderBy(ie(te.timestamp)).limit(r)}},p=new Ue;Oe();import ce from\"crypto\";D();var Ze=process.env.ADMIN_API_KEY;function Ie(){let n=`tatum_${ce.randomBytes(28).toString(\"hex\")}`,t=n.substring(0,16),r=tt(n);devolver{clave:n,prefijo:t,hash:r}}función tt(n){devolver ce.createHash(\"sha256\").update(n).digest(\"hex\")}función we(){devolver ce.randomBytes(32).toString(\"hex\")}función st(){devolver`req_${ce.randomBytes(16).toString(\"hex\")}`}función asíncrona b(n,t,r){n.requestId=st(),t.setHeader(\"X-Request-ID\",n.requestId);deje que i=n.headers[\"x-api-key\"]; if(!i)return t.status(401).json({success:!1,error:\"Clave API faltante\",requestId:n.requestId});let u=tt(i),g=await p.getTenantByApiKeyHash(u); if(!g)return t.status(401).json({success:!1,error:\"Clave API no válida\",requestId:n.requestId}); if(g.status!==\"activo\")return t.status(403).json({success:!1,error:`La cuenta es ${g.status}`,requestId:n.requestId});n.tenant=g,r()}function $(n,t,r){n.requestId=st(),t.setHeader(\"X-Request-ID\",n.requestId);let i=n.headers[\"x-admin-key\"];if(!Ze)return t.status(503).json({éxito:!1,error:\"API de administración no configurada\",requestId:n.requestId});if(!i)return t.status(401).json({éxito:!1,error:\"Falta la clave de API de administración\",requestId:n.requestId});let u=ce.createHash(\"sha256\").update(i).digest(\"hex\"),g=ce.createHash(\"sha256\").update(Ze).digest(\"hex\");if(!ce.timingSafeEqual(Buffer.from(u),Buffer.from(g)))return t.status(401).json({éxito:!1,error:\"Clave de API de administrador no válida\",requestId:n.requestId});n.isAdmin=!0,r()}var et=new Map;function k(n,t,r){if(!n.tenant)return r();let i=n.tenant.id,u=Date.now(),g=1e3,h=et.get(i);(!h||h.resetAt<u)&&(h={count:0,resetAt:u+g},et.set(i,h)),h.count++;let s=n.tenant.rateLimit,a=Math.max(0,sh.count);if(t.setHeader(\"X-RateLimit-Límite\",s),t.setHeader(\"X-RateLimit-Restante\",a),t.setHeader(\"X-RateLimit-Restablecer\",Math.ceil(h.resetAt/1e3)),h.count>s)return t.status(429).json({éxito:!1,error:\"Límite de tasa excedido\", requestId:n.requestId,retryAfter:Math.ceil((h.resetAt-u)/1e3)});r()}función en(n){return(t,r,i)=>{if(!t.tenant)return r.status(401).json({éxito:!1,error:\"Se requiere autenticación\", requestId:t.requestId});let u=H[t.tenant.tier];if(!u)return r.status(403).json({éxito:!1,error:\"Configuración de nivel no válida\", requestId:t.requestId});if(n===\"kms\"&&!u.kmsAllowed)return r.status(403).json({éxito:!1,error:\"KMS no está disponible en Su nivel. Actualice a Scale o Enterprise.\",requestId:t.requestId,upgrade:!0});if(n===\"archival\"&&!u.archivalAccess)return r.status(403).json({success:!1,error:\"El acceso a archivos no está disponible en su nivel. Actualice a Enterprise.\",requestId:t.requestId,upgrade:!0});i()}}function Ae(n,t,r){if(!n.tenant)return r();let i=n.params.chain||n.body?.chain;if(!i)return r();let g=H[n.tenant.tier]?.chains||n.tenant.allowedChains;if(!g.includes(i))return t.status(403).json({success:!1,error:`La cadena '${i}' no está disponible en su nivel`,allowedChains:g,requestId:n.requestId,upgrade:!0});r()}D();función asíncrona nt(){if(!process.env.SEED_DEMO_DATA)return null;console.log(\"Comprobando si hay un inquilino de demostración...\");let n=await p.getTenantByEmail(\"demo@tatum-gateway.io\");if(n)return console.log(\"El inquilino de demostración ya existe\"),n;console.log(\"Creando inquilino de demostración...\"); let{prefix:t,hash:r}=Ie(),i=H.scale,u=await p.createTenant({name:\"Cuenta de demostración\",email:\"demo@tatum-gateway.io\",tier:\"scale\",status:\"active\",apiKeyPrefix:t,apiKeyHash:r,hmacSecret:we(),allowedChains:i.chains,maxAddresses:i.maxAddresses,maxWebhooks:i.maxWebhooks,maxVirtualAccounts:i.maxVirtualAccounts,rateLimit:i.rateLimit,monthlyQuota:i.monthlyQuota,companyName:\"Demostración de Tatum Gateway\",website:\"https://tatum.io\"});console.log(\"Inquilino de demostración creado:\",u.id),await p.createAuditLog({Id.inquilino:u.id,acción:\"inquilino.creado\",recurso:\"inquilino\",Id.recurso:u.id,cambios:{nivel:\"escala\",origen:\"semilla\"}});para(dejar g=0;g<10;g++)esperar p.recordApiUsage({Id.inquilino:u.id,punto final:`/api/v1/${[\"direcciones\",\"saldos\",\"tokens\",\"transacciones\"][g%4]}`,método:[\"OBTENER\",\"POST\"][g%2],cadena:[\"ethereum\",\"bitcoin\",\"solana\",\"polígono\"][g%4],acción:[\"saldo consulta_de_ance\",\"creación_de_dirección\",\"saldo_de_token\",\"historial_de_transacciones\"][g%4],unidades:[.5,1,1,2][g%4],créditos:[5e-4,.001,.001,.002][g%4],código_de_estado:200,id_de_solicitud:`demo_${g}`,tiempo_de_respuestaMs:50+Math.floor(Math.random()*100)});retorno console.log(\"¡Datos de uso de demostración sembrados!\"),u}D();función O(n){return async(t,r,i)=>{if(!t.tenant)return i();let u=le[n];t.metered={acción:n,unidades:u.units,créditos:u.cost};let g=r.json.bind(r);r.json=h=>{let s=Date.now();return p.recordApiUsage({Id.inquilino:t.id.inquilino, punto final:t.ruta, método:t.método, cadena:t.params.cadena||t.cuerpo?.cadena||nulo, acción:n, unidades:u.unidades, créditos:u.costo, código de estado:r.código de estado, Id.solicitud:t.id.solicitud, tiempo de respuesta:Fecha.ahora()-s, metadatos:{agente-usuario:t.encabezados[\"agente-usuario\"], ip:t.ip}}).catch(consola.error),h&&tipo de h==\"objeto\"&&(h.meta={...h.meta, Id.solicitud:t.id.solicitud, marca de tiempo:nueva Fecha().toISOString(),medido:{acción:n,unidades:u.unidades,créditos:u.costo}}),g(h)},i()}}función asíncrona be(n){let t=nueva fecha,r=nueva fecha(t.getFullYear(),t.getMonth(),1),i=await p.getApiUsageStats(n,r,t);return{totalRequests:i.totalRequests,totalUnits:i.totalUnits,totalCredits:i.totalCredits,costUsd:i.totalCredits}}función asíncrona Se(n,t){if(t===-1)return{permitido:!0,usado:0,restante:-1,porcentajeUsado:0};let r=await ser(n),i=Math.floor(r.totalUnits),u=ti,g=i/t*100;devolver{permitido:u>0,usado:i,restante:Math.max(0,u),porcentajeUsado:Math.min(100,g)}}función ae(n,t,r){si(!n.inquilino)devolver r();Se(n.inquilino.id,n.inquilino.cuotamensual).entonces(i=>{si(t.setHeader(\"X-Cuota-Usada\",i.usada),t.setHeader(\"X-Cuota-Restante\",i.restante),t.setHeader(\"X-Cuota-Porcentaje\",Math.round(i.porcentajeUsado)),!i.permitido)devolver t.status(429).json({success:!1,error:\"Cuota mensual excedida\",requestId:n.requestId,quota:{used:i.used,limit:n.tenant.cuotamensual,porcentajeUsado:i.porcentajeUsado},actualización:!0});r()}).catch(()=>r())}D();importar Ft desde\"crypto\";var $t=1e5,Ot=32,qt=\"sha256\",ne=null,pe=class n{secretomaestro;versión;createdAt;estático SALT_PREFIXES={claveprivada:\"kms:clave_privada:v1\",carteramaestra:\"kms:cartera_maestra:v1\",secretohmac:\"kms:secretohmac:v1\",derivacióndeclaveapi:\"kms:claveapi:v1\",cifradodesesión:\"kms:sesión:v1\"};constructor(t,r=1){if(!t||t.length<32)arrojar nuevo Error(\"El secreto maestro debe ser al menos 32 bytes (usar: openssl rand -hex 16)\");this.masterSecret=t,this.version=r,this.createdAt=new Date,t.length<64&&console.warn(\"\\u26A0\\uFE0F ADVERTENCIA: El secreto del KMS maestro tiene menos de 64 bytes. Considere usar: openssl rand -hex 32\")}static initialize(t){let r=t||process.env.MASTER_KMS_SECRET||process.env.SESSION_SECRET;if(!r)throw new Error(\"Variable de entorno MASTER_KMS_SECRET no establecida. Generar con: openssl rand -hex 32\");return ne||(ne=new n(r),console.log(\"\\u2705 KMS inicializado con secreto maestro\"),ne)}static getInstance(){return ne||(ne=n.initialize()),ne}deriveKey(t,r=\"\"){let i=n.SALT_PREFIXES[t];if(!i)throw new Error(`Tipo de clave desconocida: ${t}`);let u=Buffer.from(`${i}:${r}`);return{key:Ft.pbkdf2Sync(this.masterSecret,u,$t,Ot,qt),version:this.version,keyType:t}}derivePrivateKeyEncryptionKey(t){return this.deriveKey(\"privateKey\",t).key}deriveMasterWalletKey(t){return this.deriveKey(\"masterWallet\",t).key}deriveHmacKey(t){return this.deriveKey(\"hmacSecret\",t).key}deriveSessionEncryptionKey(t){return this.deriveKey(\"sessionEncryption\",t).key}getConfig(){return{masterSecret:\"[CENSURADO]\",version:this.version,createdAt:this.createdAt}}rotate(t){let r=new n(t,this.version+1);return ne=r,console.log(`\\u2705 KMS rotado a la versión ${r.version}`),r}static test(){try{let t=n.getInstance(),r=t.deriveKey(\"privateKey\",\"test-wallet-1\"),i=t.deriveKey(\"privateKey\",\"test-wallet-1\");if(r.key.toString(\"hex\")!==i.key.toString(\"hex\"))throw new Error(\"La derivación de la clave KMS no es determinista\");let u=t.deriveKey(\"privateKey\",\"test-wallet-2\");if(r.key.toString(\"hex\")===u.key.toString(\"hex\"))throw new Error(\"Colisión de derivación de clave KMS detectada\");return console.log(\"\\u2705 Autoprueba de KMS aprobada\"),!0}catch(t){return console.error(\"\\u274C Autoprueba de KMS fallida:\",t),!1}}};try{pe.initialize()}catch(n){console.warn(\"\\u26A0\\uFE0F Advertencia de inicialización de KMS:\",n)}import qe from\"crypto\";var Pe=\"aes-256-gcm\",Re=32,Gt=16;function rt(n,t,r){if(t.length!==Re)throw new Error(`La clave de cifrado debe ser de ${Re} bytes`);let i=qe.randomBytes(Gt),u=qe.createCipheriv(Pe,t,i);r&&u.setAAD(Buffer.from(r));let g=Buffer.concat([u.update(n,\"utf8\"),u.final()]),h=u.getAuthTag();return{ciphertext:g.toString(\"hex\"),iv:i.toString(\"hex\"),authTag:h.toString(\"hex\"),algorithm:Pe}}function ot(n,t,r){if(t.length!==Re)throw new Error(`La clave de cifrado debe tener ${Re} bytes`);if(n.algorithm!==Pe)throw new Error(`Algoritmo no compatible: ${n.algorithm}`);let i=Buffer.from(n.iv,\"hex\"),u=Buffer.from(n.ciphertext,\"hex\"),g=Buffer.from(n.authTag,\"hex\"),h=qe.createDecipheriv(Pe,t,i);r&&h.setAAD(Buffer.from(r)),h.setAuthTag(g);try{return Buffer.concat([h.update(u),h.final()]).toString(\"utf8\")}catch{throw new Error(\"Error de descifrado: los datos pueden estar dañados o alterados\")}}import{sql como Vt}desde\"drizzle-orm\";import{webcrypto como it}desde\"crypto\";var Yt=w.object({nombre:w.string().min(2),correo electrónico:w.string().correo electrónico(),nivel:w.enum([\"starter\",\"scale\",\"enterprise\"]).predeterminado(\"starter\"),nombreDeEmpresa:w.string().opcional(),sitio web:w.string().url().opcional(),correo electrónico de facturación:w.string().correo electrónico().opcional()}),zt=w.object({cadena:w.string(),etiqueta:w.string().opcional(),etiquetas:w.array(w.string()).opcional(),URLdelwebhook:w.string().url().opcional()}),Xt=w.object({url:w.string().url(),eventos:w.array(w.enum(Be)).min(1)});función asíncrona ct(n,t){nt().catch(console.error),t.get(\"/\",(s,a)=>{a.json({name:\"Tatum API Gateway\",version:\"1.0.0\",description:\"API Gateway de blockchain de nivel empresarial compatible con más de 130 blockchains\",status:\"running\",documentation:\"GET /api/docs | GET /api/docs/model | GET /api/docs/examples\",quickStart:\"1. Obtener la clave API del administrador | 2. Agregar el encabezado 'x-api-key: YOUR_KEY' | 3. Enviar por POST a /api/tenants para registrarse\",endpoints:{health:\"GET /api/health\",pricing:\"GET /api/pricing\",chains:\"GET /api/chains\",tenants:\"GET /api/tenants | POST /api/inquilinos\", direcciones:\"GET /api/v1/direcciones | POST /api/v1/direcciones\", transacciones:\"GET /api/v1/transacciones\", webhooks:\"POST /api/v1/webhooks | GET /api/v1/webhooks\", puerta de enlace:\"POST /api/v1/puerta de enlace/cuentas-virtuales | GET /api/v1/puerta de enlace/cuentas-virtuales | POST /api/v1/puerta de enlace/intercambio | POST /api/v1/puerta de enlace/retiro\", administrador:\"GET /api/admin/configuración-gas | PUT /api/admin/configuración-gas/global | GET /api/admin/ingresos | GET /api/admin/transacciones\", rwa:\"POST /api/v1/rwa/tokens | GET /api/v1/rwa/tokens | POST /api/v1/rwa/tokens/:id/transfer\"},businessModel:{type:\"Puerta de enlace API de doble panel (100 % de ingresos de administración)\",panels:{cryptoPanel:{description:\"Control de billetera maestra con sistema de cuentas virtuales\",revenueStreams:{internalSwaps:\"0,5 % de comisión (sin comisiones de gas)\",gasMarkup:\"40 % de margen configurable sobre las comisiones de gas\",setupFees:\"$500 por cliente de RWA\"},annualRevenue:\"$204K (Y1) \\u2192 $1.02M (Y2) \\u2192 $2.04M (Y3)\"}, rwaPanel:{description:\"Infraestructura de tokenización de activos del mundo real\",revenueStreams:{setupFees:\"$500 por token (pago único)\",nnualFees:\"$200 por token al año\",tradingCommissions:\"0.5% del volumen total de operaciones (100% para administración)\"},annualRevenue:\"$654K (Y1) \\u2192 $8.07M (Y2) \\u2192 $60.21M (Y3)\"}},profitMargins:\"82.5% (Y1) \\u2192 91.2% (Y2) \\u2192 96,8 % (año 3)\", totalProjections:{año 1:\"$858 000\", año 2:\"$9,09 000\", año 3:\"$62,25 000\"}}, auth:{type:\"Clave API + HMAC\", method:\"x-api-key header (Tatum v3 recommended)\", example:\"curl -H 'x-api-key: YOUR_API_KEY' https://api.example.com/api/v1/...\", documentation:\"https://docs.tatum.io/docs/authentication\"}, rateLimit:\"Por nivel: Starter 10/s, Scale 100/s, Enterprise 1000/seg\",docs:\"https://api.tatum.io/docs\",github:\"https://github.com/MasterFital/tatum-api-gateway\"})}),t.get(\"/api/docs/model\",(s,a)=>{a.json({title:\"Tatum API Gateway - Modelo de Negocio\",introduction:\"Arquitectura de doble panel que genera el 100% de ingresos administrativos mediante el trading de criptomonedas y la tokenización de RWA\",panels:{crypto:{name:\"Panel CRYPTO (100% de tus ingresos)\",description:\"Controlas las billeteras maestras (BTC, ETH, SOL, MATIC). Los clientes operan a través de cuentas virtuales.\",how_it_works:{step1:\"El administrador crea billeteras maestras mediante POST /api/admin/master-wallets\",step2:\"Los clientes crean cuentas virtuales mediante POST /api/v1/gateway/virtual-accounts\",paso 3:\"Los clientes pueden intercambiar internamente (comisión del 0,5 % para usted) o retirar externamente (margen de beneficio del 40 %)\",paso 4:\"El administrador registra todos los ingresos mediante GET /api/admin/revenue\"},revenue_streams:{internal_swaps:{description:\"El cliente intercambia BTC \\u2192 ETH\",fee:\"0,5 % del importe del intercambio\",gas_cost:\"Cero (interno)\",admin_profit:\"100 % de la comisión\",example:\"El cliente intercambia 1 ETH \\u2192 0,02 BTC | Comisión: 0,0001 BTC (100 % para el administrador)\"},gas_markup:{description:\"El cliente retira criptomonedas a una billetera externa\",fee:\"Margen de beneficio del 40 % sobre el gas real costo\", ejemplo:\"Gas Bitcoin: $3 reales | Cobras: $4.20 | Tu ganancia: $1.20 (40%)\"}}, proyecciones:{año1:{volumen:\"Promedio de 1 millón de USD/mes\", swaps mensuales:\"5K \\xD7 0.5% = $25K\", gas mensual:\"Retiros de 10K \\xD7 $3 \\xD7 40% = $12K\", total mensual:\"$17K\", anual:\"$204K\"}, año2:{volumen:\"Promedio de 5 millones de USD/mes\", anual:\"$1.02M\"}, año3:{volumen:\"Promedio de 10 millones de USD/mes\", anual:\"$2.04M\"}}}, rwa:{nombre:\"Panel RWA (100% Tus Ingresos + Tarifas)\", descripción:\"Los clientes emiten tokens. Tú proporcionas la infraestructura. Te quedas con el 100% de las tarifas y comisiones de trading.\", cómo_funciona:{paso 1:\"El cliente solicita la creación de un token: POST /api/v1/rwa/tokens\", paso 2:\"Cobras $500 de comisión de configuración + implementación del contrato inteligente\", paso 3:\"El token se activa. Los clientes operan internamente (comisión del 0,5 % para ti)\", paso 4:\"Comisión anual de mantenimiento de $200 por token\", paso 5:\"Todos los retiros externos tienen un margen de gas del 40 % (para ti)\", paso 6:\"Seguimiento de los ingresos mediante GET /api/admin/rwa-revenue\"},revenue_streams:{setup_fees:{description:\"Comisión única por token lanzado\",amount:\"$500\",frequency:\"Por token\"},annual_fees:{description:\"Mantenimiento anual por token activo\",amount:\"$200\",frequency:\"Por token por año\"}, comisiones_comerciales:{descripción:\"0.5% del volumen total de operaciones de tokens (100% para el administrador)\", porcentaje:\"0.5%\", ejemplo:\"Volumen de tokens: $100,000/mes | Su comisión: $500/mes = $6,000/año por token\"}, margen_gas:{descripción:\"40% de margen en las comisiones de gas para retiros externos\", porcentaje:\"40%\"}}, beneficios_del_cliente:{beneficio1:\"Infraestructura de tokenización (su costo: ~$0.10 por token)\", beneficio2:\"Mercado listo para usar\", beneficio3:\"Liquidez instantánea (operadores del día 1)\", beneficio4:\"Seguridad y cumplimiento a su cargo\", pago_del_cliente:\"$500 de configuración + $200/año solo\"}, proyecciones:{año1:{tokens:\"20 tokens nuevos\", tarifas_de_configuración:\"20 \\xD7 $500 = $10K\", tarifas_anuales:\"20 \\xD7 $200 = $4K\", comisiones_de_operación:\"0.5% de un volumen de ~$100M = $500K\", total:\"$514K\"}, año2:{tokens:\"100 tokens en total\", tarifas_de_configuración:\"100 \\xD7 $500 = $50K\", tarifas_anuales:\"100 \\xD7 $200 = $20K\", comisiones_de_operación:\"0.5% de un volumen de ~$1.6B = $8M\",total:\"$8.07M\"},año3:{tokens:\"300 tokens en total\",tarifas_de_configuración:\"300 \\xD7 $500 = $150K\",tarifas_anuales:\"300 \\xD7 $200 = $60K\",comisiones_de_comercio:\"0.5% de un volumen de ~$12B = $60M\",total:\"$60.21M\"}}}},resumen_de_ingresos:{título:\"Ingresos combinados (Cripto + RWA)\",año 1:{cripto:\"$204K\",rwa:\"$654K\",total:\"$858K\",margen:\"82.5%\"},año 2:{cripto:\"$1.02M\",rwa:\"$8.07M\",total:\"$9.09M\",margen:\"91.2%\"},año 3:{cripto:\"$2.04M\",rwa:\"$60.21M\",total:\"$62.25M\",margen:\"96.8%\"}},puntos_clave:[\"El 100% de todos los ingresos van al administrador (usted)\",\"Los clientes obtienen acceso a la infraestructura, no a la repartición de ingresos\",\"Las tarifas de configuración son ingresos inmediatos\",\"Las comisiones de trading escalan infinitamente con el volumen\",\"El margen de gas es puro beneficio (costo mínimo de infraestructura)\",\"Costo de adquisición de clientes cero (los clientes se traen a sí mismos)\"]})}),t.get(\"/api/docs/examples\",(s,a)=>{a.json({title:\"Tatum API Gateway - Ejemplos de uso\",autenticación: {descripción:\"Todas las solicitudes requieren el encabezado x-api-key\",ejemplo:\"curl -H 'x-api-key: YOUR_API_KEY' https://api.example.com/api/v1/...\",encabezados:{\"x-api-key\":\"Su clave API del administrador\",\"Content-Type\":\"application/json\"}},crypto_examples: {título:\"Ejemplos del panel CRYPTO\",create_virtual_account: {descripción:\"El cliente crea una cuenta virtual para almacenar criptomonedas\",endpoint:\"POST /api/v1/gateway/virtual-accounts\",solicitud:{tipoDeCuenta:\"individual\"},respuesta:{éxito:!0,cuentaVirtual:{id:\"va-123\",identificadorDeInquilino:\"cliente-1\",tipoDeCuenta:\"individual\",saldos:{BTC:\"0\",ETH:\"0\",SOL:\"0\"},estado:\"activo\"}}},interno_swap_0_5_percent:{descripción:\"El cliente intercambia BTC por ETH (comisión del 0,5 % para el administrador)\",punto final:\"POST /api/v1/gateway/swap\", solicitud: {fromAccountId:\"va-123\", fromAsset:\"BTC\", toAsset:\"ETH\", importe:\"1.0\"}, respuesta: {éxito:!0, intercambio: {id:\"swap-456\", fromAsset:\"BTC\", toAsset:\"ETH\", importe:\"1.0\", comisión:\"0.005 BTC (0.5% para el administrador)\", estado:\"completado\"}, nota:\"Sin comisiones de gas, comisión del 0.5% aplicada\"}}, external_withdraw_40_percent_markup: {descripción:\"El cliente retira a una billetera externa (40% de margen de gas para el administrador)\", punto final:\"POST /api/v1/gateway/withdraw\", solicitud: {fromAccountId:\"va-123\", activo:\"ETH\", importe:\"1.0\", dirección:\"0x1234567890abcdef...\"}, respuesta: {éxito:!0, retiro: {id:\"withdraw-789\", activo:\"ETH\", importe:\"1.0\", dirección:\"0x1234567890abcdef...\", gasReal:\"3 USD\", gasCharged:\"4.20 USD (40% de margen)\", adminProfit:\"1.20 USD\", estado:\"pendiente\", txHash:\"0xabcd...\"}}}, ver_historial_de_transacciones: {descripción:\"El cliente visualiza su transacción historial\", punto final:\"GET /api/v1/transactions?limit=50\", respuesta:{éxito:!0, transacciones:[{id:\"swap-456\", tipo:\"internal_swap\", activo:\"BTC\", importe:\"1.0\", comisión:\"0.005\", estado:\"completado\", creado el:\"2024-11-30T10:00:00Z\"}], paginación:{total:42, límite:50, desplazamiento:0}}}}, ejemplos_rwa:{título:\"Ejemplos de paneles RWA\", crear_rwa_token_500_setup:{descripción:\"El cliente crea un token (paga $500 de tarifa de configuración al administrador)\", punto final:\"POST /api/v1/rwa/tokens\",solicitud:{nombreDeActivo:\"Fondo Inmobiliario\",símbolo:\"REF\",cadenaDeBlockchain:\"Ethereum\",decimales:18,suministroTotal:\"1000000\",nombreDeEmisor:\"RE Properties Inc\",descripción:\"Inversión Inmobiliaria Tokenizada\"},respuesta:{éxito:!0,token:{id:\"token-ref-1\",nombreDeActivo:\"Fondo inmobiliario\", símbolo:\"REF\", cadena de bloques:\"ethereum\", suministro total:\"1000000\", dirección del contrato inteligente:\"0x...\", estado:\"creado\"}, precios: {tarifa de configuración:\"$500 (pago único) - PAGADO AL ADMINISTRADOR\", tarifa anual:\"$200/año - PAGADO AL ADMINISTRADOR\", comisión de negociación:\"0.5% en todas las operaciones - 100% PARA EL ADMINISTRADOR\"}}}, lista_rwa_tokens: {descripción:\"El cliente visualiza sus tokens y volumen de operaciones\", punto final:\"GET /api/v1/rwa/tokens\", respuesta: {éxito:!0, tokens:[{id:\"token-ref-1\", nombre_del_activo:\"Bienes raíces Fondo\", símbolo:\"REF\", cadena de bloques:\"ethereum\", oferta total:\"1000000\", estado:\"activo\", tarifa de configuración:\"500, tarifa anual:\"200, volumen de negociación:\"250000 USD\", comisión de negociación:\"1250 USD (0,5 % para el administrador)\"}], resumen:{totalTokens:\"1, comisiones de negociación totales:\"1250 USD (100 % para el administrador)\", tarifas de configuración cobradas:\"500 USD (100 % para el administrador)\"}}}, rwa_token_transfer_0_5_percent:{descripción:\"El titular del token negocia el token REF (0,5 % de comisión para el administrador)\", punto final:\"POST /api/v1/rwa/tokens/token-ref-1/transfer\",request:{toAddress:\"0xabcd...\",amount:\"100\"},response:{success:!0,transfer:{id:\"transfer-123\",tokenId:\"token-ref-1\",amount:\"100 REF\",toAddress:\"0xabcd...\",commission:\"0.5 REF (0.5% para el administrador)\",status:\"completed\",txHash:\"0x...\"},note:\"0.5% de comisión de trading aplicada y cobrada por el administrador\"}}},admin_examples:{title:\"Ejemplos del panel de administración\",view_revenue:{description:\"El administrador visualiza los ingresos totales (swaps + margen de gas)\",endpoint:\"GET /api/admin/revenue\",respuesta:{éxito:!0,cryptoRevenue:{totalSwapCommissions:\"1245.67 USD\",totalGasMarkupRevenue:\"3456.78 USD\",totalVolume:\"249000 USD\",revenueByBlockchain:{ethereum:\"2345.67\",polygon:\"1234.56\",bitcoin:\"3456.78\"}}}},view_rwa_revenue:{description:\"El administrador visualiza los ingresos de RWA (comisiones de configuración + anuales + de trading)\",endpoint:\"GET /api/admin/rwa-revenue\",respuesta:{éxito:!0,rwaRevenue:{setupFees:{count:12,total:\"6000 USD\", Tarifas anuales: {Clientes activos: 12, Total: 2400 USD\", Comisiones por operaciones: {Este mes: 12500 USD\", Este año: 125000 USD\", Tasa: 0,5 % del volumen total de operaciones\", Ingresos mensuales totales: 15000 USD\", Seguridad: {Autenticación: encabezado x-api-key (recomendado Tatum v3)\", Cifrado: Todas las claves privadas cifradas con AES-256\", Auditoría: Todas las transacciones registradas con registro de auditoría completo\", Límite de tasa: Starter 10/s, Scale 100/s, Enterprise 1000/seg\",documentación:\"https://docs.tatum.io/docs/authentication\"}})}),t.get(\"/api/test-tatum\",async(s,a)=>{try{let e=await B.healthCheck(),o={success:e.success,message:e.success?\"\\u2705 Conectado a la API de Tatum correctamente\":\"\\u274C Error al conectarse a la API de Tatum\",tatumApiUrl:process.env.TATUM_API_URL||\"https://api.tatum.io\",apiKeyConfigured:!!process.env.TATUM_API_KEY,apiKeyLength:process.env.TATUM_API_KEY?.length||0,timestamp:new Date().toISOString()};e.success&&e.data&&(o.blockchainInfo={chain:e.data.chain,blocks:e.data.blocks,mempool:e.data.mempool}),e.error&&(o.error=e.error,o.statusCode=e.statusCode),a.json({success:e.success,test:\"Prueba de conexión a la API de Tatum\",status:o,instructions:{production:\"Configure la variable de entorno TATUM_API_KEY con su API de producción de Tatum key\",documentation:\"https://docs.tatum.io/docs/authentication\",getApiKey:\"https://dashboard.tatum.io\"},requestId:s.requestId})}catch(e){a.status(500).json({success:!1,test:\"Prueba de conexión de la API de Tatum\",error:e.message,message:\"Error al probar la conexión de Tatum\",instructions:{checkApiKey:\"Asegúrese de que TATUM_API_KEY esté configurado en las variables de entorno\",checkUrl:\"Verifique que TATUM_API_URL esté correct\",documentation:\"https://docs.tatum.io/docs/authentication\"},requestId:s.requestId})}}),t.get(\"/api/docs\",(s,a)=>{a.json({title:\"Tatum API Gateway - Documentación completa\",message:\"Para obtener más información, visite estos puntos finales de la documentación:\",available_docs:{business_model:\"GET /api/docs/model - Explicación completa de los flujos de ingresos\",examples:\"GET /api/docs/examples - Ejemplos de uso para Crypto y RWA\",tatum_test:\"GET /api/test-tatum - Conexión de prueba a la API de Tatum (verificación de producción)\",this_endpoint:\"GET /api/docs - Esta página\",api_root:\"GET / - Información de la API y descripción general del modelo de negocio\"},quick_endpoints:{\"Crypto Panel\":[\"POST /api/v1/gateway/virtual-accounts - Crear cuenta virtual\",\"POST /api/v1/gateway/swap - Swap interno (comisión del 0,5%)\",\"POST /api/v1/gateway/withdraw - Retiro externo (margen de beneficio del 40%)\",\"GET /api/v1/transactions - Historial de transacciones\"],\"Panel RWA\":[\"POST /api/v1/rwa/tokens - Crear token (comisión de instalación de 500$)\",\"GET /api/v1/rwa/tokens - Listar tokens\",\"POST /api/v1/rwa/tokens/:id/transfer - Intercambio de tokens (comisión del 0,5%)\"],Admin:[\"GET /api/admin/revenue - Panel de ingresos de criptomonedas\",\"GET /api/admin/rwa-revenue - Panel de ingresos de RWA\",\"GET /api/admin/master-wallets - Lista de billeteras maestras\",\"POST /api/admin/master-wallets - Crear billetera maestra\"]},authentication:{method:\"x-api-key header\",example:\"Authorization: x-api-key YOUR_API_KEY\",documentation:\"https://docs.tatum.io/docs/authentication\"},support:{github:\"https://github.com/MasterFital/tatum-api-gateway\",tatum_docs:\"https://api.tatum.io/docs\",api_reference:\"https://docs.tatum.io/reference/welcome-to-the-tatum-api-reference\"}})}),t.get(\"/api/health\",async(s,a)=>{let e=await B.healthCheck();a.json({éxito:!0,estado:\"saludable\",servicios:{api:\"saludable\",base de datos:\"saludable\",tatum:e.success?\"saludable\":\"degradado\"},marca de tiempo:nueva Fecha().toISOString()})}), t.get(\"/api/pricing\",(s,a)=>{a.json({éxito:!0,precios:le,niveles:Object.entries(H).map(([e,o])=>({id:e,...o,precios:{starter:{mensual:0,incluido:1e4},escala:{mensual:99,incluido:1e5},empresa:{mensual:\"personalizado\",incluido:\"ilimitado\"}}[e]}))})}), t.get(\"/api/cadenas\",(s,a)=>{a.json({éxito:!0,cadenas:me,total:me.length})}), t.post(\"/api/inquilinos\",async(s,a)=>{try{let e=Yt.parse(s.body);if(await p.getTenantByEmail(e.email))return a.status(409).json({éxito:!1,error:\"Correo electrónico ya registrado\"});let{key:c,prefix:d,hash:y}=Ie(),m=H[e.tier],I=await p.createTenant({nombre:e.nombre,correo electrónico:e.correo electrónico,nivel:e.nivel,estado:\"activo\",apiKeyPrefix:d,apiKeyHash:y,hmacSecret:we(),allowedChains:[...m.cadenas],maxAddresses:m.maxAddresses,maxWebhooks:m.maxWebhooks,maxVirtualAccounts:m.maxVirtualAccounts,rateLimit:m.rateLimit,monthlyQuota:m.monthlyQuota,companyName:e.companyName,website:e.website,billingEmail:e.billingEmail});await p.createAuditLog({tenantId:I.id,action:\"tenant.created\",resource:\"tenant\",resourceId:I.id,changes:{tier:e.tier}}),a.status(201).json({success:!0,tenant:{id:I.id,name:I.name,email:I.email,tier:I.tier,status:I.status,apiKey:c,hmacSecret:I.hmacSecret,limits:{chains:I.allowedChains,maxAddresses:I.maxAddresses,maxWebhooks:I.maxWebhooks,maxVirtualAccounts:I.maxVirtualAccounts,rateLimit:I.rateLimit,monthlyQuota:I.monthlyQuota},createdAt:I.createdAt},warning:\"Guarde su clave API ahora. No se puede recuperar de nuevo.\"})}catch(e){if(e.name===\"ZodError\")return a.status(400).json({éxito:!1,error:\"Error de validación\",details:e.errors});console.error(\"Error al crear inquilino:\",e),a.status(500).json({éxito:!1,error:\"Error interno del servidor\"})}}),t.get(\"/api/tenants\",async(s,a)=>{try{let e=await p.getAllTenants(),o=await Promise.all(e.map(async c=>{let d=await be(c.id),y=await p.countAddressesByTenant(c.id); return{id:c.id,name:c.name,email:c.email,tier:c.tier,status:c.status,companyName:c.companyName,addressCount:y,usage:{requests:d.totalRequests,units:Math.floor(d.totalUnits),costUsd:d.costUsd.toFixed(4)},createdAt:c.createdAt}}));a.json({success:!0,tenants:o})}catch(e){console.error(\"Error al obtener inquilinos:\",e),a.status(500).json({success:!1,error:\"Error interno del servidor\"})}}),t.get(\"/api/tenants/:id\",b,async(s,a)=>{try{let e=espera p.getTenant(s.params.id);si(!e)devuelve a.status(404).json({éxito:!1,error:\"No se encontró el inquilino\"}); sea o=await be(e.id),c=await Se(e.id,e.monthlyQuota),d=await p.countAddressesByTenant(e.id),y=await p.countWebhooksByTenant(e.id),m=await p.countVirtualAccountsByTenant(e.id);a.json({éxito:!0, inquilino:{id:e.id, nombre:e.name, correo electrónico:e.email, nivel:e.tier, estado:e.status, nombreDeEmpresa:e.nombreDeEmpresa, sitio web:e.website, correo electrónicoDeFacturación:e.correoElectrónicoDeFacturación, prefijoDeClaveAPI:e.prefijoDeClaveAPI, límites:{cadenas:e.cadenaspermitidas, direccionesmáximas:e.direccionesmáximas, webhooksmáx:e.webhooksmáx, cuentasvirtualesmáx:e.accesoVirtual recuentos, rateLimit:e.rateLimit, monthlyQuota:e.monthlyQuota}, uso:{direcciones:d, webhooks:y, cuentas virtuales:m, solicitudes:o.totalRequests, unidades:Math.floor(o.totalUnits), costoUsd:o.costUsd.toFixed(4), cuota:{usado:c.usado, restante:c.restante, porcentajeUsado:Math.round(c.porcentajeUsado)}}, creadoEn:e.creadoEn, actualizadoEn:e.actualizadoEn}})}catch(e){console.error(\"Obtener Error de inquilino:\",e),a.status(500).json({éxito:!1,error:\"Error interno del servidor\"})}}),t.patch(\"/api/tenants/:id\",b,async(s,a)=>{try{if(s.tenant.id!==s.params.id)return a.status(403).json({éxito:!1,error:\"Solo puede actualizar su propia cuenta\",requestId:s.requestId});let e=s.body,o=[\"nombre\",\"nombreDeEmpresa\",\"sitio web\",\"correo electrónico de facturación\"],c={};for(let y of o)e[y]!==void 0&&(c[y]=e[y]);if(Object.keys(c).length===0)return a.status(400).json({éxito:!1,error:\"No hay campos válidos para actualizar\",requestId:s.requestId});let d=await p.updateTenant(s.params.id,c);if(!d)return a.status(404).json({éxito:!1,error:\"No se encontró el inquilino\"});await p.createAuditLog({tenantId:d.id,acción:\"inquilino.actualizado\",resource:\"inquilino\",resourceId:d.id,cambios:c,ipAddress:s.ip}),a.json({éxito:!0,inquilino:d,requestId:s.requestId})}catch(e){console.error(\"Actualizar inquilino error:\",e),a.status(500).json({éxito:!1,error:\"Error interno del servidor\"})}}),t.post(\"/api/tenants/:id/rotate-key\",b,async(s,a)=>{try{let e=await p.getTenant(s.params.id);if(!e)return a.status(404).json({éxito:!1,error:\"No se encontró el inquilino\"});if(s.tenant.id!==e.id)return a.status(403).json({éxito:!1,error:\"Solo puede rotar su propia clave API\",requestId:s.requestId});let{key:o,prefix:c,hash:d}=Ie();await p.updateTenant(e.id,{apiKeyPrefix:c,apiKeyHash:d}),await p.createAuditLog({tenantId:e.id,action:\"apikey.rotated\",resource:\"tenant\",resourceId:e.id,changes:{rotated:!0}}),a.json({success:!0,apiKey:o,warning:\"Guarde su nueva clave API. La clave anterior ya no es válida y no se puede recuperar.\",requestId:s.requestId})}catch(e){console.error(\"Error al rotar la clave API:\",e),a.status(500).json({success:!1,error:\"Servidor interno error\"})}}),t.patch(\"/api/admin/tenants/:id\",$,async(s,a)=>{try{let e=s.body;if(e.tier){let c=H[e.tier];c&&(e.allowedChains=c.chains,e.maxAddresses=c.maxAddresses,e.maxWebhooks=c.maxWebhooks,e.maxVirtualAccounts=c.maxVirtualAccounts,e.rateLimit=c.rateLimit,e.monthlyQuota=c.monthlyQuota)}let o=await p.updateTenant(s.params.id,e);if(!o)return a.status(404).json({éxito:!1,error:\"No se encontró el inquilino\"});await p.createAuditLog({Id.inquilino:o.id,acción:\"admin.tenant.updated\",recurso:\"inquilino\",Id.recurso:o.id,cambios:e,direcciónIP:s.ip}),a.json({éxito:!0,inquilino:o,Id.solicitud:s.Id.solicitud})}catch(e){console.error(\"El administrador actualiza el inquilino error:\",e),a.status(500).json({éxito:!1,error:\"Error interno del servidor\"})}}),t.post(\"/api/admin/tenants/:id/suspend\",$,async(s,a)=>{try{let e=await p.updateTenant(s.params.id,{status:\"suspendido\"});if(!e)return a.status(404).json({éxito:!1,error:\"Inquilino no encontrado\"});await p.createAuditLog({tenantId:e.id,action:\"admin.tenant.suspended\",resource:\"tenant\",resourceId:e.id,changes:{status:\"suspended\"},ipAddress:s.ip}),a.json({success:!0,message:\"Inquilino suspendido\",requestId:s.requestId})}catch(e){console.error(\"Error de suspensión del inqui
{"mensaje":"","atributos":{"nivel":"información"},"marca de tiempo":"2025-11-30T18:34:39.060112522Z"}
{"mensaje":"> rest-express@1.0.0 inicio","atributos":{"nivel":"información"},"marca de tiempo":"2025-11-30T18:34:39.060124746Z"}
{"mensaje":"> NODE_ENV=nodo de producción dist/index.js","atributos":{"nivel":"información"},"marca de tiempo":"2025-11-30T18:34:39.060134115Z"}
{"mensaje":"","atributos":{"nivel":"información"},"marca de tiempo":"2025-11-30T18:34:39.060140239Z"}
{"mensaje":"archivo:///app/dist/index.js:1","atributos":{"nivel":"error"},"marca de tiempo":"2025-11-30T18:34:39.571308518Z"}
{"mensaje":"var mt=Object.defineProperty;var fe=(n,t)=>()=>(n&&(t=n(n=0)),t);var xe=(n,t)=>{para(var r en t)mt(n,r,{obtener:t[r],enumerable:!0})};var J={};xe(J,{EnumeraciónDeCadena:()=>ft,PRECIOS:()=>le,CADENAS_SOPORTADAS:()=>me,EnumeraciónDeEstado:()=>yt,LÍMITES_DE_NIVEL:()=>H,EnumeraciónDeNivel:()=>gt,EVENTOS_DE_WEBHOOK:()=>Be,direcciones:()=>S,UsoDeAPI:()=>W,RegistrosDeAuditoría:()=>te,AgregacionesDeFacturación:()=>Q,CriptoTransacciones:()=>de,ConfiguraciónDeGas:()=>X,InsertarEsquemaDeDirección:()=>vt,InsertarEsquemaDeUsoDeAPI:()=>_t,InsertarLoCursoDeAuditoría gSchema:()=>xt,insertarEsquemaDeTransacciónCriptográfica:()=>At,insertarEsquemaDeMonederoMaestro:()=>It,insertarEsquemaDeInquilino:()=>bt,insertarEsquemaDeTransacción:()=>kt,insertarEsquemaDeCuentaVirtual:()=>wt,insertarEsquemaDeWebhook:()=>Tt,MonederosMaestros:()=>z,inquilinos:()=>x,RelacionesDeInquilinos:()=>ht,transacciones:()=>j,CuentasVirtuales:()=>_,webhooks:()=>K});import{sql como M}de\"drizzle-orm\";import{pgTable como q,texto como l,varchar como T,entero como E,booleano como Ve,marca de tiempo como R,jsonb como F,real como he,índice como v}de\"drizzle-orm/pg-core\";import{createInsertSchema como Y}de\"drizzle-zod\";import{z como Ke}de\"zod\";import{relaciones como pt}de\"drizzle-orm\";var gt,yt,ft,x,z,_,de,X,S,j,K,W,Q,te,ht,It,wt,At,bt,vt,kt,Tt,_t,xt,H,le,Be,me,D=fe(()=>{\"use estricto\";gt=Ke.enum([\"inicial\",\"escala\",\"empresa\"]),yt=Ke.enum([\"activo\",\"suspendido\",\"eliminado\"]),ft=Ke.enum([\"bitcoin\",\"ethereum\",\"solana\",\"polígono\",\"tron\",\"bsc\",\"ondulación\",\"cardano\",\"cerca\",\"polkadot\",\"avalancha\",\"arbitrum\",\"optimismo\",\"base\",\"fantom\",\"cronos\",\"cosmos\",\"algorand\"]),x=q(\"inquilinos\",{id:T(\"id\",{length:36}).primaryKey().default(M`gen_rand om_uuid()`), nombre: l(\"nombre\").notNull(), correo electrónico: l(\"correo electrónico\").notNull().único(), nivel: l(\"nivel\").notNull().predeterminado(\"inicial\"), estado: l(\"estado\").notNull().predeterminado(\"activo\"), apiKeyPrefix: T(\"api_key_prefix\",{longitud: 16}).notNull(), apiKeyHash: l(\"api_key_hash\").notNull().único(), hmacSecret: l(\"hmac_secret\").notNull(), allowedChains: l(\"allowed_chains\").array().notNull().predeterminado(M`ARRAY['bitcoin', 'ethereum', 'solana']`), direcciones máximas: E(\"direcciones máximas\").notNull().default(50), webhooks máximos: E(\"webhooks máximos\").notNull().default(1), cuentas virtuales máximas: E(\"cuentas virtuales máximas\").notNull().default(0), límite de tasa: E(\"límite de tasa\").notNull().default(10), cuota mensual: E(\"cuota mensual\").notNull().default(1e4), correo electrónico de facturación: l(\"correo electrónico de facturación\"), nombre de la empresa:l(\"nombre_de_la_empresa\"),sitio_web:l(\"sitio_web\"),lista_blanca_de_ip:l(\"lista_blanca_de_ip\").array(),metadatos:F(\"metadatos\"),createdAt:R(\"created_at\").defaultNow().notNull(),updatedAt:R(\"updated_at\").defaultNow().notNull()},n=>[v(\"id_de_correo_electrónico_de_inquilinos\").on(n.email),v(\"id_hash_de_clave_de_API_de_inquilinos\").on(n.apiKeyHa sh),v(\"idx_estado_inquilinos\").on(n.estado)]),z=q(\"monederos_principales\",{id:T(\"id\",{longitud:36}).clave_primaria().predeterminado(M`gen_random_uuid()`),escenario:l(\"escenario\").notNull(),cadena_de_bloques:l(\"cadena_de_bloques\").notNull(),tipo_de_activo:l(\"tipo_de_activo\").notNull(),nombre_de_activo:l(\"nombre_de_activo\").notNull(),dirección:l( \"dirección\").notNull().unique(),clavepública:l(\"clave pública\"),claveprivadacifrada:l(\"clave privada cifrada\"),claveprivadaIV:T(\"clave privadaIV\",{longitud:32}),etiquetadeautenticacióndeclaveprivada:T(\"etiquetadeautenticacióndeclaveprivada\",{longitud:32}),direccióndecontratointeligente:l(\"direccióndecontratointeligente\"),decimalesdetoken:E(\"decimalesdetoken \"),assignedToTenantId:T(\"id_asignado_al_inquilino\",{length:36}).references(()=>x.id),balance:l(\"saldo\").default(\"0\"),balanceUsd:l(\"saldo_usd\").default(\"0\"),lastSyncTime:R(\"última_sincronización\"),gasMarkupPercentage:E(\"porcentaje_de_margen_de_gas\").default(40),status:l(\"estado\").notNull().de fallo(\"activo\"), metadatos: F(\"metadatos\"), creado en: R(\"creado_en\"). predeterminadoAhora(). no nulo(), actualizado en: R(\"actualizado_en\"). predeterminadoAhora(). no nulo()}, n => [v(\"masters_blockchain_idx\"). en(n. cadena de bloques), v(\"masters_asset_idx\"). en(n. nombre_activo), v(\"masters_address_idx\"). en(n. dirección), v(\"masters_inquilino _idx\").on(n.assignedToTenantId),v(\"masters_scenario_idx\").on(n.scenario)]),_=q(\"cuentas_virtuales\",{id:T(\"id\",{longitud:36}).primaryKey().default(M`gen_random_uuid()`),tenantId:T(\"tenant_id\",{longitud:36}).notNull().references(()=>x.id,{onDelete:\"cascade\"}),accountType:l(\"tipo_de_cuenta\").n otNull(),saldos:F(\"saldos\").predeterminado(M`'{}'`),estado:l(\"estado\").notNull().predeterminado(\"activo\"),congelado:Ve(\"congelado\").predeterminado(!1),metadatos:F(\"metadatos\"),createdAt:R(\"creado_en\").defaultNow().notNull(),updatedAt:R(\"actualizado_en\").defaultNow().notNull()},n=>[v(\"inquilino_de_cuentas_virtuales_i dx\").on(n.Id_de_inquilino),v(\"id_de_estado_de_cuentas_virtualesx\").on(n.estado)]),de=q(\"transacciones_criptográficas\",{id:T(\"id\",{longitud:36}).clave_primaria().predeterminado(M`gen_random_uuid()`),Id_de_inquilino:T(\"id_de_inquilino\",{longitud:36}).notNull().referencias(()=>x.id,{onDelete:\"cascada\"}),tipo:l(\"tipo\").notNull(),escenario:l(\"escenario\").notNull(),fromAccountId:T(\"from_account_id\",{longitud:36}),toAccountId:T(\"to_count_id\",{longitud:36}),toExternalAddress:l(\"to_external_address\"),fromExternalAddress:l(\"from_external_address\"),assetType:l(\"tipo_de_activo\").notNull(),assetName:l(\"nombre_de_activo\").notNull(),blockchain:l(\"blockchain\").notNull(),amount:l(\"mount\"). notNull(),gasReal:l(\"gas_real\"),gasMarkupPercent:E(\"gas_markup_percent\"),gasCharged:l(\"gas_charged\"),commissionAmount:l(\"commission_mont\"),commissionUsd:l(\"comission_usd\"),status:l(\"status\").notNull().default(\"pending\"),txHash:l(\"tx_hash\").unique(),blockNumber:E(\"block_number\"),confirmations:E(\"confirmations\"),metadata:F(\"me tadata\"), creado en: R(\"creado_en\"). predeterminadoAhora(). no nulo(), ejecutado en: R(\"ejecutado_en\"), confirmado en: R(\"confirmado_en\")}, n => [v(\"idx_de_inquilino_de_transacción_criptográfica\"). en(n. id_de_inquilino), v(\"idx_de_tipo_de_transacción_criptográfica\"). en(n. tipo), v(\"idx_de_estado_de_transacción_criptográfica\"). en(n. estado), v(\"idx_hash_de_transacción_criptográfica\"). en(n. hash_de_transacción), v(\"idx_de_escenario_de_transacción_criptográfica\"). en(n. escenario)]), X = q(\"setti_gas ngs\",{id:T(\"id\",{longitud:36}).primaryKey().default(M`gen_random_uuid()`),marcadopredeterminadoglobal:E(\"marcadopredeterminadoglobal\").default(40),marcadomín:E(\"marcadomín\").default(10),marcadomáx:E(\"marcadomáx\").default(100),anulacionesdecliente:F(\"anulacionesdecliente\").default(M`'{}'`),multiplicadoresdecadenadebloques:F(\"multiplicadoresdecadenadebloques\").default(M`'{\"ethereum\": 1.0, \"polígono\": 0.3}'`),Anulaciones de tipo de transacción:F(\"anulaciones de tipo de transacción\").predeterminado(M`'{\"retiro_cripto\": 40, \"transferencia_de_token\": 45}'`),updatedAt:R(\"updated_at\").defaultNow().notNull(),updatedBy:l(\"updated_by\")},n=>[v(\"gas_settings_updated_idx\").on(n.updatedAt)]),S=q(\"direcciones\",{id:T(\"id\",{longitud:36}).primaryKey().default(M`gen_random_uuid()`),tenantId:T(\"tenant_id\",{longitud:36}).notNull().references(()=>x.id,{onDelete:\"cascade\"}),chain:l(\"cadena\").notNull(),currency:l(\"currency\").notNull(),address: l(\"dirección\").notNull(),publicKey:l(\"clave_pública\"),derivationPath:l(\"ruta_derivación\"),label:l(\"etiqueta\"),tags:l(\"etiquetas\").array().default(M`ARRAY[]::text[]`),status:l(\"estado\").notNull().default(\"activo\"),balance:l(\"balance\").default(\"0\"),balanceUsd:l(\"balance_usd\").default(\"0\"),lastSynced:R(\"last_synced\"),webhookUrl:l(\"webhook_url\"),metadatos:F(\"metadatos\"),createdAt:R(\"creado_en\").defaultNow().notNull(),actualizadoEn:R(\"actualizado_en\").defaultNow().notNull(),eliminadoEn:R(\"eliminado_en\")},n=>[v(\"direcciones_idx_de_inquilino\").on(n.Id_de_inquilino),v(\"direcciones_idx_de_cadena\").on(n.cadena),v(\"direcciones_idx_de_estado\").on(n.estado),v(\"direcciones_idx_de_dirección\").on(n.dirección)] ),j=q(\"transacciones\",{id:T(\"id\",{longitud:36}).primaryKey().default(M`gen_random_uuid()`),tenantId:T(\"id_tenant\",{longitud:36}).notNull().references(()=>x.id,{onDelete:\"cascade\"}),txHash:l(\"tx_hash\").notNull(),chain:l(\"cadena\").notNull(),fromAddress:l(\"from_address\"),toAddress:l(\"t o_dirección\"), importe: l(\"importe\").notNull(), moneda: l(\"moneda\").notNull(), cuota: l(\"cuota\"), cuotaUsd: l(\"cuota_usd\"), estado: l(\"estado\").notNull().default(\"pendiente\"), tipo: l(\"tipo\").notNull().default(\"nativo\"), númerodebloque: E(\"númerodebloque\"), confirmaciones: E(\"confirmaciones\").default(0 ), metadatos: F(\"metadatos\"), creado en: R(\"creado_en\"). predeterminado ahora(). no nulo()}, n => [v(\"idx_de_inquilino_de_transacciones\"). en(n. ID_de_inquilino), v(\"idx_de_cadena_de_transacciones\"). en(n. cadena), v(\"idx_de_hash_de_transacciones\"). en(n. Hash_de_tx), v(\"idx_de_estado_de_transacciones\"). en(n. estado)]), K = q(\"webhooks\", {id: T(\"id\", {le longitud: 36}). claveprimaria(). predeterminado(M`gen_random_uuid()`), ID_inquilino: T(\"ID_inquilino\",{longitud: 36}). no nulo(). referencias(()=>x.id,{onDelete:\"cascada\"}), URL: l(\"URL\"). no nulo(), eventos: l(\"eventos\"). matriz(). no nulo(), secreto_hmac: l(\"secreto_hmac\"). no nulo(), activo: Ve(\"activo\"). predeterminado(!0), reintentarCou nt:E(\"retry_count\").default(0),lastTriggered:R(\"last_triggered\"),lastStatus:E(\"last_status\"),metadatos:F(\"metadatos\"),createdAt:R(\"created_at\").defaultNow().notNull()},n=>[v(\"webhooks_tenant_idx\").on(n.tenantId),v(\"webhooks_active_idx\").on(n.active)]),W=q(\"api_usage\",{id:T(\"id \",{longitud:36}).primaryKey().default(M`gen_random_uuid()`),tenantId:T(\"tenant_id\",{longitud:36}).notNull().references(()=>x.id,{onDelete:\"cascade\"}),endpoint:l(\"endpoint\").notNull(),method:l(\"method\").notNull(),chain:l(\"chain\"),action:l(\"action\").notNull(),units:he(\"units\").notN ull(), créditos:he(\"créditos\").notNull(), código de estado:E(\"código de estado\").notNull(), id de solicitud:T(\"id de solicitud\",{longitud:36}).notNull(), tiempo de respuesta Ms:E(\"ms de tiempo de respuesta\"), metadatos:F(\"metadatos\"), marca de tiempo:R(\"marca de tiempo\").defaultNow().notNull()}, n=>[v(\"id de inquilino de uso de API\").on(n.id de inquilino),v(\"api_usage_timestamp_idx\").on(n.timestamp),v(\"api_usage_action_idx\").on(n.action)]),Q=q(\"agregaciones_de_facturación\",{id:T(\"id\",{longitud:36}).primaryKey().default(M`gen_random_uuid()`),tenantId:T(\"id_de_teniente\",{longitud:36}).notNull().references(()=>x.id,{onDelete:\"cascade\"}),periodo:l(\"periodo\").notNull(),periodType:l(\"tipo_de_periodo\").notNull().default(\"diario\"),totalUnits:he(\"unidades_totales\").notNull().def ault(0), totalCredits:he(\"total_créditos\").notNull().default(0), costUsd:he(\"costo_usd\").notNull().default(0), breakdown:F(\"break\"), createdAt:R(\"created_at\").defaultNow().notNull()}, n=>[v(\"billing_tenant_period_idx\").on(n.tenantId,n.period)]), te=q(\"audit_logs\",{id:T(\"id\",{length:36}).primaryKey().default(M`gen_random_uuid()`), tenantId:T(\"tenant_id\",{length:36}).references(()=>x.id,{onDelete:\"set null\"}),ID_usuario:l(\"id_usuario\"),acción:l(\"acción\").notNull(),recurso:l(\"recurso\").notNull(),ID_recurso:l(\"id_recurso\"),cambios:F(\"cambios\"),Dirección_IP:l(\"dirección_IP\"),Agente_usuario:l(\"agente_usuario\"),ID_solicitud:T(\"id_solicitud\",{longitud:36}),marca_de_tiempo:R(\"marca_de_tiempo\").defaultNow().notNull()},n=>[v(\"audit_logs_tenant_idx\").on(n.Id_tenant),v(\"audit_logs_timestamp_idx\").on(n.marca_de_tiempo),v(\"audit _logs_action_idx\").on(n.action)]),ht=pt(x,({muchos:n})=>({direcciones:n(S),transacciones:n(j),webhooks:n(K),cuentasvirtuales:n(_),apiUsage:n(W),agregacionesdefacturación:n(Q),registrosdeauditoría:n(te),monederosprincipales:n(z),criptotransacciones:n(de)})),It=Y(z).omit({id:!0,createdAt:!0,updatedAt:!0}),wt=Y(_).omit({id:!0,createdAt:!0,updatedAt:!0}),At=Y(de).omit({id:!0,createdAt:!0,executedAt:!0,confirmedAt:!0}),bt=Y(x).omit({ id:!0,createdAt:!0,updatedAt:!0}),vt=Y(S).omit({id:!0,createdAt:!0,updatedAt:!0,deletedAt:!0}),kt=Y(j).omit({id:!0,createdAt:!0}),Tt=Y(K).omit({id:!0,createdAt:!0}),_t=Y(W).omit({id:!0,timestamp:!0}),xt=Y(te).omit({id:!0,timestamp:!0}),H={starter:{chains:[\"bitcoin\",\"ethereum\",\"solana\"],maxAddresses:50,maxWebhooks:1,maxVirtualAccounts:0,rateLimit:10,monthlyQuota:1e4,kmsAllowed:!1,archivalAccess :!1, días de retención: 1}, escala: {cadenas: [\"bitcoin\",\"ethereum\",\"solana\",\"polígono\",\"tron\",\"bsc\",\"ripple\",\"cardano\"], direcciones máximas: 1e3, webhooks máximos: 10, cuentas virtuales máximas: 5, límite de tasa: 100, cuota mensual: 1e5, km permitidos:!0, acceso de archivo:!1, días de retención: 7}, empresa: {cadenas: [\"bitcoin\",\"ethereum\",\"solana\",\"polígono\",\"tron\",\"bsc\",\"ripple\",\"cardano\",\"near\",\"polkadot\",\"avalancha\",\"arbitro\",\"optimismo\",\"base\",\"fantasma\",\"cronos\",\"cosmos\",\"algorand\"],máximo de direcciones: -1,máximo de webhooks: -1,máximo de cuentas virtuales: 50,límite de tasa: 1e3,cuota mensual: -1,km permitidos: !0,acceso de archivo: !0,días de retención: 30}},le={creación de dirección:{unidades: 1,costo: 0,001},consulta de saldo:{unidades: 0,costo: 5e-4},saldo de token:{unidades: 1,costo: 0,001},metadatos nft:{unidades: 2,costo: 0,002},tx_br oadcast_btc:{unidades: 50, costo: 0,05}, tx_broadcast_eth:{unidades: 10, costo: 0,01}, tx_broadcast_other:{unidades: 10, costo: 0,01}, tx_history:{unidades: 2, costo: 0,002}, webhook_subscription:{unidades: 0,02, costo: 0,02}, va_create:{unidades: 100, costo: 0,1}, va_transfer:{unidades: 5, costo: 0,005}, tipo de cambio:{unidades: 0,1, costo: 1e-4}, web3_resolve:{unidades: 1, costo: 0,001}, malicioso_check:{unidades: 2, costo: 0,002}, rpc_standard:{u nits:2,costo:2e-4},rpc_eth_call:{unidades:5,costo:5e-4},rpc_debug:{unidades:50,costo:.005}},Be=[\"TRANSACCIÓN_DIRECCIÓN\",\"SALDO_DIRECCIÓN\",\"TRANSACCIÓN_NATIVA_ENTRANTE\",\"TRANSACCIÓN_NATIVA_SALIENTE\",\"TRANSACCIÓN_FUNGIBLE_ENTRANTE\",\"TRANSACCIÓN_FUNGIBLE_SALIENTE\",\"TRANSACCIÓN_NFT_ENTRANTE\",\"TRANSACCIÓN_NFT_SALIENTE\",\"TRANSACCIÓN_MULTITOKEN_ENTRANTE\",\"TRANSACCIÓN_MULTITOKEN_SALIENTE\",\"TRANSACCIÓN_FALLIDA\",\"CUOTA_PAGADA\",\"REGISTRO_DE_CONTRATO _EVENTO\"],me=[{id:\"bitcoin\",nombre:\"Bitcoin\",símbolo:\"BTC\",icono:\"\\u20BF\"},{id:\"ethereum\",nombre:\"Ethereum\",símbolo:\"ETH\",icono:\"\\u039E\"},{id:\"solana\",nombre:\"Solana\",símbolo:\"SOL\",icono:\"\\u25CE\"},{id:\"polígono\",nombre:\"Polígono\",símbolo:\"MATIC\",icono:\"\\u2B21\"},{id:\"tron\",nombre:\"Tron\",símbolo:\"TRX\",icono:\"\\u2666\"},{id:\"bsc\",nombre:\"BNB Cadena\", símbolo:\"BNB\", icono:\"\\u25C6\"},{id:\"ripple\", nombre:\"XRP Ledger\", símbolo:\"XRP\", icono:\"\\u2715\"},{id:\"cardano\", nombre:\"Cardano\", símbolo:\"ADA\", icono:\"\\u20B3\"},{id:\"near\", nombre:\"NEAR\", símbolo:\"NEAR\", icono:\"\\u24C3\"},{id:\"polkadot\", nombre:\"Polkadot\", símbolo:\"DOT\", icono:\"\\u25CF\"},{id:\"avalanche\", nombre:\"Avalanche\", símbolo:\"AVAX\", icono:\"\\u25B2\"},{id:\"arb itrum\", nombre:\"Arbitrum\", símbolo:\"ARB\", icono:\"\\u25C8\"},{id:\"optimism\", nombre:\"Optimism\", símbolo:\"OP\", icono:\"\\u2295\"},{id:\"base\", nombre:\"Base\", símbolo:\"ETH\", icono:\"\\u25EF\"},{id:\"fantom\", nombre:\"Fantom\", símbolo:\"FTM\", icono:\"\\u25C7\"},{id:\"cronos\", nombre:\"Cronos\", símbolo:\"CRO\", icono:\"\\u25CE\"},{id:\"cosmos\",nombre:\"Cosmos\",símbolo:\"ATOM\",icono:\"\\u269B\"},{id:\"algorand\",nombre:\"Algorand\",símbolo:\"ALGO\",icono:\"\\u24B6\"}]});var oe={};xe(oe,{db:()=>f,pool:()=>Ye});import{Pool como St,neonConfig como Pt}desde\"@neondatabase/serverless\";import{drizzle como Rt}desde\"drizzle-orm/neon-serverless\";import Et desde\"ws\";var Ye,f,V=fe(()=>{\"use strict\";D();Pt.webSocketConstructor=Et;if(!process.env.DATABASE_URL)throw new Error(\"DATABASE_URL debe ser ¿Olvidaste aprovisionar una base de datos?\"); Ye=new St({connectionString:process.env.DATABASE_URL}), f=Rt({client:Ye,schema:J})}); function jt(n){return!n||typeof n!=\"string\"||n.length<32?!1:/^[a-zA-Z0-9_-]{32,}$/.test(n)} function Bt(){return P.state===\"open\"?Date.now()-P.lastFailure>=$e.resetTimeoutMs?(P.state=\"half-open\",P.successesInHalfOpen=0,!0):!1:!0} function Dt(){P.estado===\"semiabierto\"?(P.éxitosEnMedioApertura++,P.éxitosEnMedioApertura>=$e.umbralDeÉxitoDeAperturaMedia&&(P.estado=\"cerrado\",P.fallos=0)):P.fallos=0}función ze(){P.fallos++,P.últimoFallo=Fecha.ahora(),(P.estado===\"semiabierto\"||P.fallos>=$e.umbralDeFallo)&&(P.estado=\"abierto\")}función Ut(n,t){devolver t.EstadosReintentables.includes(n)}función Xe(n,t){devolver Math.min(t.baseDelayMs*Math.pow(2,n)+Math.random()*1e3,t.maxDelayMs)}función asíncrona Qe(n){devuelve nueva Promesa(t=>setTimeout(t,n))}función asíncrona N(n,t={},r=Kt){si(!Bt())devuelve{éxito:!1,error:\"Servicio temporalmente no disponible (disyuntor abierto)\",statusCode:503};let i=null;for(let u=0;u<=r.maxRetries;u++)try{let g=new AbortController,h=setTimeout(()=>g.abort(),3e4),s=await fetch(`${Mt}${n}`,{...t,señal:g.señal,encabezados:{\"Tipo-Contenido\":\"aplicación/json\",\"clave-x-api\":Fe||\"\",...t.encabezados}});clearTimeout(h);let a=await s.json().catch(()=>null);if(!s.ok){let e={éxito:!1,error:a?.mensaje||a?.error||`HTTP ${s.estado}`,código-estado:s.estado};if(s.estado===429){let o=s.headers.get(\"Retry-After\");o&&(e.retryAfter=parseInt(o,10)*1e3)}if(Ut(s.status,r)&&u<r.maxRetries){i=e;let o=e.retryAfter||Xe(u,r);await Qe(o);continue}return ze(),e}return Dt(),{éxito:!0,datos:a}}catch(g){let h=g.name===\"Error de cancelación\",s=g.message?.includes(\"obtener\")||g.message?.includes(\"red\"),a={éxito:!1,error:h?\"Tiempo de espera de la solicitud\":g.message||\"Red error\",statusCode:h?408:500};if((h||s)&&u<r.maxRetries){i=a,await Qe(Xe(u,r));continue}return ze(),a}return i||{éxito:!1,error:\"Se excedió el máximo de reintentos\",statusCode:500}}function Je(n){return me.find(t=>t.id===n)}var Mt,Fe,Kt,P,$e,se,B,Oe=fe(()=>{\"use strict\";D();Mt=process.env.TATUM_API_URL||\"https://api.tatum.io\",Fe=process.env.TATUM_API_KEY;Fe?jt(Fe)||console.warn(\"El formato de TATUM_API_KEY parece no ser válido; puede causar errores de API\"):console.warn(\"TATUM_API_KEY no configurado; las llamadas a la API fail\"); Kt={máx.Reintentos:3,Ms.deRetardoBase:1e3,Ms.deRetardoMax:3e4,EstadosReintentables:[408,429,500,502,503,504]}, P={fallos:0,últimoFallo:0,estado:\"cerrado\",éxitosEnMedioApertura:0}, $e={UmbralDeFallo:5,Ms.deRestablecimientoTiempoDeEspera:6e4,UmbralDeÉxitoEnMedioApertura:2}; se={bitcoin:\"bitcoin\",ethereum:\"ethereum\",solana:\"solana\",polygon:\"polígono\",tron:\"tron\",bsc:\"bsc\",ri pple:\"xrp\",cardano:\"ada\",near:\"near\",polkadot:\"dot\",avalanche:\"avax\",arbitrum:\"arbitrum-one\",optimismo:\"optimismo\",base:\"base\",fantom:\"fantom\",cronos:\"cro\",c osmos:\"atom\",algorand:\"algo\"},B={getCircuitBreakerState(){return{...P}},resetCircuitBreaker(){P.failures=0,P.lastFailure=0,P.state=\"closed\",P.successesInHalfOpen=0},async generateAddress(n){let t=se[n]||n;return N(`/v3/${t}/wallet`,{método:\"GET\"})},async getBalance(n,t){let r=se[n]||n;return[\"ethereum\",\"polígono\",\"bsc\",\"arbitrum-one\",\"optimism\",\"base\"].includes(r)?N(`/v3/${r}/account/balance/${t}`):N(r===\"bitcoin\"?`/v3/bitcoin/address/balance/${t}`:r===\"solana\"?`/v3/solana/account/balance/${t}`:`/v3/${r}/account/balance/${t}`)},async getTokens(n,t){let r=se[n]||n;devuelve N(`/v3/data/tokens?chain=${r}&addresses=${t}`)},asincrónico obtenerNFTs(n,t){let r=se[n]||n;devuelve N(`/v3/data/nfts?chain=${r}&addresses=${t}`)},asincrónico obtenerHistorialDeTransacciones(n,t,r){let i=se[n]||n,u=nuevosParámetrosDeBúsquedaDeURL;devuelve r?.TamañoDePágina&&u.set(\"TamañoDePágina\",r.TamañoDePágina.toString()),r?.Desplazamiento&&u.set(\"Desplazamiento\",r.Desplazamiento.toString()),N(`/v3/data/transacciones?chain=${i}&addresses=${t}&${u.toString()}`)},asincrónico getTransaction(n,t){let r=se[n]||n;devuelve N(`/v3/${r}/transaction/${t}`)},async estimateFee(n,t=\"TRANSFER\"){let r=se[n]||n;devuelve N(`/v3/${r}/gas/estimate`,{método:\"POST\",cuerpo:JSON.stringify({tipo:t})})},async broadcastTransaction(n,t){let r=se[n]||n;devuelve N(`/v3/${r}/broadcast`,{método:\"POST\",cuerpo:JSON.stringify({txData:t})})},async getExchangeRates(n){let t=n.join(\",\");devuelve N(`/v3/tatum/rate/${t}?basePair=USD`)}, asíncrono resolveWeb3Name(n){devuelve N(`/v3/blockchain/names/${n}`)}, asíncrono checkMaliciousAddress(n){devuelve N(`/v3/security/address/${n}`)}, asíncrono createWebhook(n){devuelve N(\"/v4/subscription\",{método:\"POST\",cuerpo:JSON.stringify(n)})}, asíncrono deleteWebhook(n){devuelve N(`/v4/subscription/${n}`,{método:\"DELETE\"})}, asíncrono getWebhooks(){devuelve N(\"/v4/subscription\")},async healthCheck(){let n=await N(\"/v3/tatum/version\"); return n.success?{success:!0, data:{status:\"healthy\", version:n.data?.version||\"v3\", circuitBreaker:{...P}}}:{...n, data:{status:\"degraded\", version:\"unknown\", circuitBreaker:{...P}}}}}});var ve={};xe(ve,{GasFeeManager:()=>Ee,gasFeeManager:()=>Le});import{eq as Ge}from\"drizzle-orm\";var Ee,Le,ge=fe(()=>{\"use strict\";V();D();Ee=class{config=null;async loadConfig(){let[t]=await f.select().from(X).limit(1);if(!t){let r={Margen predeterminado global: 40, Margen mínimo: 10, Margen máximo: 100, Anulaciones de cliente:{}, Multiplicadores de cadena de bloques:{ethereum: 1, polígono: .3, bitcoin: 1.2, solana: .1, arbitraje: .2}, Anulaciones de tipo de transacción:{retiro_cripto: 40, transferencia_de_token: 45, contrato_inteligente: 60}};return this.config=r,r}return this.config={globalDefaultMarkup:t.globalDefaultMarkup,minMarkup:t.minMarkup,maxMarkup:t.maxMarkup,clientOverrides:t.clientOverrides||{},blockchainMultipliers:t.blockchainMultipliers||{},transactionTypeOverrides:t.transactionTypeOverrides||{}},this.config}async calculateGasMarkup(t){this.config||await this.loadConfig();let r=this.config.globalDefaultMarkup;if(t.clientId&&this.config.clientOverrides[t.clientId]){let a=this.config.clientOverrides[t.clientId];if(a.expiresAt){let e=new Date(a.expiresAt);new Date<e&&(r=a.markup)}else r=a.markup}let i=this.config.transactionTypeOverrides[t.transactionType];i&&(r=i);let u=this.config.blockchainMultipliers[t.blockchain]||1;r=Math.round(r*u),r=Math.max(this.config.minMarkup,Math.min(this.config.maxMarkup,r));let g=t.gasReal*(r/100),h=t.gasReal+g,s=g;return{gasReal:t.gasReal,gasMarkupPercent:r,gasCharged:h,yourProfit:s}}async updateGlobalMarkup(t,r){t=Math.max(10,Math.min(100,t)),await f.update(X).set({globalDefaultMarkup:t,updatedAt:new Fecha,actualizadoPor:r}).donde(Ge(X.id,\"predeterminado\")),this.config=null,await this.loadConfig()}async setClientMarkup(t,r,i,u,g){this.config||await this.loadConfig();let h=this.config.clientOverrides;h[t]={markup:Math.max(10,Math.min(100,r)),reason:i,expiresAt:g?.toISOString()},await f.update(X).set({clientOverrides:h,actualizadoEn:new Fecha,actualizadoPor:u}).donde(Ge(X.id,\"predeterminado\")),this.config=null,await this.loadConfig()}async removeClientMarkup(t,r){this.config||await this.loadConfig();let i=this.config.clientOverrides;eliminar i[t],esperar f.update(X).set({clientOverrides:i,actualizadoEn:nueva Fecha,actualizadoPor:r}).where(Ge(X.id,\"predeterminado\")),this.config=null,esperar this.loadConfig()}getConfig(){devolver this.config}},Le=new Ee});var ke={};xe(ke,{CryptoGateway:()=>Ne,cryptoGateway:()=>Ht});importar Lt desde\"crypto\";importar{eq como G y como Wt} desde\"drizzle-orm\";var Ne,Ht,Te=fe(()=>{\"usar estricto\";Oe();ge();V();D();Ne=class{async createVirtualAccount(t,r){devolver(esperar f.insert(_).values({Id.inquilino:t,TipoDeCuenta:r,Saldos:JSON.stringify({})}).returning())[0]}async internalSwap(t){let r=await f.query.virtualAccounts.findFirst({where:G(_.id,t.fromAccountId)});if(!r)throw new Error(\"No se encontró la cuenta\");let i=JSON.parse(r.balances||\"{}\"),u=parseFloat(i[t.assetName]||\"0\");if(u<parseFloat(t.fromAmount))throw new Error(\"Saldo insuficiente\");let g=parseFloat(t.toAmount)*.005,h=parseFloat(t.toAmount)-g,s={...i};s[t.assetName]=(u-parseFloat(t.fromAmount)).toString(),await f.update(_).set({balances:JSON.stringify(s)}).where(G(_.id,t.fromAccountId));let a=espera f.consulta.cuentasvirtuales.findFirst({donde:G(_.id,t.toAccountId)}),e=JSON.parse(a?.balances||\"{}\");devuelve e[t.nombreDeActivo]=(parseFloat(e[t.nombreDeActivo]||\"0\")+h).toString(),espera f.update(_).set({balances:JSON.stringify(e)}).donde(G(_.id,t.toAccountId)),{txId:(espera f.insert(de).values({Id.inquilino:t.Id.inquilino,tipo:\"intercambio_interno\",escenario:t.scenario,Id.deCuenta:t.deCuenta,Id.deCuenta:t.deCuenta,Tipo.deActivo:\"cripto\",Nombre.deActivo:t.deActivo,cadena.de.blockchain:t.blockchain,importe:t.deImporte,importe.de.comisión:g.de.Cadena(),comisión.Usd:(g*45e3).de.Cadena(),estado:\"completado\"}).returning())[0].id,estado:\"completado\",deImporte:t.deImporte,de.Importe:t.de.Importe,comisión:g.de.Fijo(8),neto.Recibido:h.de.Fijo(8),ejecutadoEn:nuevaFecha().de.CadenaISO()}}asincrónico externalWithdraw(t){let r=await f.query.masterWallets.findFirst({where:Wt(G(z.assetName,t.assetName),G(z.blockchain,t.blockchain),G(z.scenario,t.scenario))});if(!r)throw new Error(`No se encontró la billetera maestra para ${t.assetName} en ${t.blockchain}`);let i=await B.estimateGas({blockchain:t.blockchain,assetType:t.assetName===r.smartContractAddress?\"token\":\"crypto\",amount:t.amount}),u=await Le.calculateGasMarkup({clientId:t.tenantId,blockchain:t.blockchain,transactionType:t.assetName===\"BTC\"?\"crypto_withdraw\":\"token_transfer\",gasReal:i.gasReal}),g=await f.query.virtualAccounts.findFirst({where:G(_.id,t.fromAccountId)}),h=JSON.parse(g?.balances||\"{}\"),s=parseFloat(h[t.assetName]||\"0\");if(s<parseFloat(t.amount))throw new Error(\"Saldo insuficiente\");h[t.assetName]=(s-parseFloat(t.amount)).toString(),await f.update(_).set({balances:JSON.stringify(h)}).where(G(_.id,t.fromAccountId));let a=`0x${Lt.randomBytes(32).toString(\"hex\")}`;return{txId:(await f.insert(de).values({Id.inquilino:t.inquilino,tipo:\"retiro_externo\",escenario:t.scenario,toExternalAddress:t.toExternalAddress,tipo.activo:\"cripto\",nombre.activo:t.nombre.activo,blockchain:t.blockchain,cantidad:t.cantidad,gasReal:u.gasReal.toString(),porcentaje.de.margen.gas:u.porcentaje.de.margen.gas,gasCargado :u.gasCharged.toString(),commissionAmount:u.yourProfit.toString(),status:\"pendiente\",txHash:a}).returning())[0].id,status:\"pendiente_de_confirmación\",txHash:a,amount:t.amount,gasReal:u.gasReal.toFixed(8),gasCharged:u.gasCharged.toFixed(8),yourProfit:u.yourProfit.toFixed(8),estimatedTime:\"12 segundos\"}}async assignMasterToClient(t,r,i){return await f.update(z).set({assignedToTenantId:r,gasMarkupPercentage:i}).where(G(z.id,t)),{success:!0,masterId:t,assignedTo:r,gasMarkup:i,assignedAt:new Date().toISOString()}}async getVirtualAccountBalance(t){let r=await f.query.virtualAccounts.findFirst({where:G(_.id,t)});if(!r)throw new Error(\"Cuenta no encontrada\");let i=JSON.parse(r.balances||\"{}\"); return{accountId:t,balances:i,totalUsd:Object.entries(i).reduce((u,[g,h])=>{let s={ETH:2500,BTC:45e3,GOLD:500,SILVER:250}; return u+parseFloat(h)*(s[g]||0)},0)}}},Ht=new Ne});import Ce de\"express\";import{z como w} de\"zod\";D();V();import{eq como A,and como Z,desc como ie,sql como De,gte como Nt,lte como Ct} de\"drizzle-orm\";var Ue=class{async getTenant(t){let[r]=await f.select().from(x).where(A(x.id,t));return r||void 0}async getTenantByApiKeyHash(t){let[r]=await f.select().from(x).where(A(x.apiKeyHash,t));return r||void 0}async getTenantByEmail(t){let[r]=await f.select().from(x).where(A(x.email,t));return r||void 0}async getAllTenants(){return f.select().from(x).orderBy(ie(x.createdAt))}async createTenant(t){let[r]=await f.insert(x).values(t).returning();return r}async updateTenant(t,r){let[i]=await f.update(x).set({...r,updatedAt:nueva fecha}).where(A(x.id,t)).returning();devolver i||void 0}async deleteTenant(t){await f.update(x).set({estado:\"eliminado\",updatedAt:nueva fecha}).where(A(x.id,t))}async getAddress(t){let[r]=await f.select().from(S).where(A(S.id,t));devolver r||void 0}async getAddressByAddress(t,r,i){let[u]=await f.select().from(S).where(Z(A(S.tenantId,t),A(S.chain,r),A(S.address,i)));devolver u||void 0}async getAddressesByTenant(t,r){let i=f.select().from(S).where(A(S.tenantId,t)),u=[A(S.tenantId,t)];devuelve r?.chain&&u.push(A(S.chain,r.chain)),r?.status&&u.push(A(S.status,r.status)),f.select().from(S).where(Z(...u)).orderBy(ie(S.createdAt)).limit(r?.limit||50).offset(r?.offset||0)}asincrónico countAddressesByTenant(t){let[r]=await f.select({count:De`count(*)`}).from(S).where(Z(A(S.tenantId,t),A(S.status,\"active\")));devuelve r?.count||0}asincrónico createAddress(t){let[r]=await f.insert(S).values(t).returning();return r}async updateAddress(t,r){let[i]=await f.update(S).set({...r,updatedAt:nueva fecha}).where(A(S.id,t)).returning();return i||void 0}async archiveAddress(t){await f.update(S).set({estado:\"archivado\",eliminadoAt:nueva fecha,updatedAt:nueva fecha}).where(A(S.id,t))}async getTransaction(t){let[r]=await f.select().from(j).where(A(j.id,t));return r||void 0}async getTransactionByHash(t,r){let[i]=await f.select().from(j).where(Z(A(j.chain,t),A(j.txHash,r)));return i||void 0}async getTransactionsByTenant(t,r){let i=[A(j.tenantId,t)];return r?.chain&&i.push(A(j.chain,r.chain)),r?.status&&i.push(A(j.status,r.status)),f.select().from(j).where(Z(...i)).orderBy(ie(j.createdAt)).limit(r?.limit||50).offset(r?.desplazamiento||0)}asincrónico createTransaction(t){let[r]=await f.insert(j).values(t).returning();devolver r}asincrónico updateTransaction(t,r){let[i]=await f.update(j).set(r).where(A(j.id,t)).returning();devolver i||void 0}asincrónico getWebhook(t){let[r]=await f.select().from(K).where(A(K.id,t));devolver r||void 0}asincrónico getWebhooksByTenant(t){devolver f.select().from(K).where(A(K.tenantId,t)).orderBy(ie(K.createdAt))}asincrónico countWebhooksByTenant(t){let[r]=await f.select({count:De`count(*)`}).from(K).where(Z(A(K.tenantId,t),A(K.active,!0)));devuelve r?.count||0}asinc createWebhook(t){let[r]=await f.insert(K).values(t).returning();devuelve r}asinc updateWebhook(t,r){let[i]=await f.update(K).set(r).where(A(K.id,t)).returning();devuelve i||void 0}asinc deleteWebhook(t){await f.delete(K).where(A(K.id,t))}asinc getVirtualAccount(t){let[r]=await f.select().from(_).where(A(_.id,t));devuelve r||void 0}asinc obtenerCuentasVirtualesPorInquilino(t){devolver f.seleccionar().de(_).donde(A(_.IdInquilino,t)).ordenarPor(ie(_.createdAt))}asincrónico contarCuentasVirtualesPorInquilino(t){let[r]=await f.seleccionar({count:De`count(*)`}).de(_).donde(Z(A(_.IdInquilino,t),A(_.estado,\"activo\")));devolver r?.count||0}asincrónico crearCuentaVirtual(t){let[r]=await f.insertar(_).valores(t).devolver();devolver r}asincrónico actualizarCuentaVirtual(t,r){let[i]=await f.actualizar(_).set(r).donde(A(_.id,t)).devolver();devolver i||void 0}asincrónico recordApiUsage(t){let[r]=await f.insert(W).values(t).returning();return r}async getApiUsageByTenant(t,r,i){return f.select().from(W).where(Z(A(W.tenantId,t),Nt(W.timestamp,r),Ct(W.timestamp,i))).orderBy(ie(W.timestamp))}async getApiUsageStats(t,r,i){let u=await this.getApiUsageByTenant(t,r,i),g={},h={},s=0,a=0;for(let e of u)s+=e.unidades,a+=e.créditos,g[e.punto final]=(g[e.punto final]||0)+1,e.cadena&&(h[e.cadena]=(h[e.cadena]||0)+1);return{totalRequests:u.length,totalUnits:s,totalCredits:a,byEndpoint:g,byChain:h}}async getBillingAggregation(t,r){let[i]=await f.select().from(Q).where(Z(A(Q.tenantId,t),A(Q.periodo,r)));return i||void 0}async upsertBillingAggregation(t){let r=await this.getBillingAggregation(t.tenantId,t.periodo);if(r){let[i]=await f.update(Q).set(t).where(A(Q.id,r.id)).returning();return i}else{let[i]=await f.insert(Q).values(t).returning();return i}}async createAuditLog(t){let[r]=await f.insert(te).values(t).returning();return r}async getAuditLogsByTenant(t,r=100){return f.select().from(te).where(A(te.tenantId,t)).orderBy(ie(te.timestamp)).limit(r)}},p=new Ue;Oe();import ce from\"crypto\";D();var Ze=process.env.ADMIN_API_KEY;function Ie(){let n=`tatum_${ce.randomBytes(28).toString(\"hex\")}`,t=n.substring(0,16),r=tt(n);devolver{clave:n,prefijo:t,hash:r}}función tt(n){devolver ce.createHash(\"sha256\").update(n).digest(\"hex\")}función we(){devolver ce.randomBytes(32).toString(\"hex\")}función st(){devolver`req_${ce.randomBytes(16).toString(\"hex\")}`}función asíncrona b(n,t,r){n.requestId=st(),t.setHeader(\"X-Request-ID\",n.requestId);deje que i=n.headers[\"x-api-key\"]; if(!i)return t.status(401).json({success:!1,error:\"Clave API faltante\",requestId:n.requestId});let u=tt(i),g=await p.getTenantByApiKeyHash(u); if(!g)return t.status(401).json({success:!1,error:\"Clave API no válida\",requestId:n.requestId}); if(g.status!==\"activo\")return t.status(403).json({success:!1,error:`La cuenta es ${g.status}`,requestId:n.requestId});n.tenant=g,r()}function $(n,t,r){n.requestId=st(),t.setHeader(\"X-Request-ID\",n.requestId);let i=n.headers[\"x-admin-key\"];if(!Ze)return t.status(503).json({éxito:!1,error:\"API de administración no configurada\",requestId:n.requestId});if(!i)return t.status(401).json({éxito:!1,error:\"Falta la clave de API de administración\",requestId:n.requestId});let u=ce.createHash(\"sha256\").update(i).digest(\"hex\"),g=ce.createHash(\"sha256\").update(Ze).digest(\"hex\");if(!ce.timingSafeEqual(Buffer.from(u),Buffer.from(g)))return t.status(401).json({éxito:!1,error:\"Clave de API de administrador no válida\",requestId:n.requestId});n.isAdmin=!0,r()}var et=new Map;function k(n,t,r){if(!n.tenant)return r();let i=n.tenant.id,u=Date.now(),g=1e3,h=et.get(i);(!h||h.resetAt<u)&&(h={count:0,resetAt:u+g},et.set(i,h)),h.count++;let s=n.tenant.rateLimit,a=Math.max(0,sh.count);if(t.setHeader(\"X-RateLimit-Límite\",s),t.setHeader(\"X-RateLimit-Restante\",a),t.setHeader(\"X-RateLimit-Restablecer\",Math.ceil(h.resetAt/1e3)),h.count>s)return t.status(429).json({éxito:!1,error:\"Límite de tasa excedido\", requestId:n.requestId,retryAfter:Math.ceil((h.resetAt-u)/1e3)});r()}función en(n){return(t,r,i)=>{if(!t.tenant)return r.status(401).json({éxito:!1,error:\"Se requiere autenticación\", requestId:t.requestId});let u=H[t.tenant.tier];if(!u)return r.status(403).json({éxito:!1,error:\"Configuración de nivel no válida\", requestId:t.requestId});if(n===\"kms\"&&!u.kmsAllowed)return r.status(403).json({éxito:!1,error:\"KMS no está disponible en Su nivel. Actualice a Scale o Enterprise.\",requestId:t.requestId,upgrade:!0});if(n===\"archival\"&&!u.archivalAccess)return r.status(403).json({success:!1,error:\"El acceso a archivos no está disponible en su nivel. Actualice a Enterprise.\",requestId:t.requestId,upgrade:!0});i()}}function Ae(n,t,r){if(!n.tenant)return r();let i=n.params.chain||n.body?.chain;if(!i)return r();let g=H[n.tenant.tier]?.chains||n.tenant.allowedChains;if(!g.includes(i))return t.status(403).json({success:!1,error:`La cadena '${i}' no está disponible en su nivel`,allowedChains:g,requestId:n.requestId,upgrade:!0});r()}D();función asíncrona nt(){if(!process.env.SEED_DEMO_DATA)return null;console.log(\"Comprobando si hay un inquilino de demostración...\");let n=await p.getTenantByEmail(\"demo@tatum-gateway.io\");if(n)return console.log(\"El inquilino de demostración ya existe\"),n;console.log(\"Creando inquilino de demostración...\"); let{prefix:t,hash:r}=Ie(),i=H.scale,u=await p.createTenant({name:\"Cuenta de demostración\",email:\"demo@tatum-gateway.io\",tier:\"scale\",status:\"active\",apiKeyPrefix:t,apiKeyHash:r,hmacSecret:we(),allowedChains:i.chains,maxAddresses:i.maxAddresses,maxWebhooks:i.maxWebhooks,maxVirtualAccounts:i.maxVirtualAccounts,rateLimit:i.rateLimit,monthlyQuota:i.monthlyQuota,companyName:\"Demostración de Tatum Gateway\",website:\"https://tatum.io\"});console.log(\"Inquilino de demostración creado:\",u.id),await p.createAuditLog({Id.inquilino:u.id,acción:\"inquilino.creado\",recurso:\"inquilino\",Id.recurso:u.id,cambios:{nivel:\"escala\",origen:\"semilla\"}});para(dejar g=0;g<10;g++)esperar p.recordApiUsage({Id.inquilino:u.id,punto final:`/api/v1/${[\"direcciones\",\"saldos\",\"tokens\",\"transacciones\"][g%4]}`,método:[\"OBTENER\",\"POST\"][g%2],cadena:[\"ethereum\",\"bitcoin\",\"solana\",\"polígono\"][g%4],acción:[\"saldo consulta_de_ance\",\"creación_de_dirección\",\"saldo_de_token\",\"historial_de_transacciones\"][g%4],unidades:[.5,1,1,2][g%4],créditos:[5e-4,.001,.001,.002][g%4],código_de_estado:200,id_de_solicitud:`demo_${g}`,tiempo_de_respuestaMs:50+Math.floor(Math.random()*100)});retorno console.log(\"¡Datos de uso de demostración sembrados!\"),u}D();función O(n){return async(t,r,i)=>{if(!t.tenant)return i();let u=le[n];t.metered={acción:n,unidades:u.units,créditos:u.cost};let g=r.json.bind(r);r.json=h=>{let s=Date.now();return p.recordApiUsage({Id.inquilino:t.id.inquilino, punto final:t.ruta, método:t.método, cadena:t.params.cadena||t.cuerpo?.cadena||nulo, acción:n, unidades:u.unidades, créditos:u.costo, código de estado:r.código de estado, Id.solicitud:t.id.solicitud, tiempo de respuesta:Fecha.ahora()-s, metadatos:{agente-usuario:t.encabezados[\"agente-usuario\"], ip:t.ip}}).catch(consola.error),h&&tipo de h==\"objeto\"&&(h.meta={...h.meta, Id.solicitud:t.id.solicitud, marca de tiempo:nueva Fecha().toISOString(),medido:{acción:n,unidades:u.unidades,créditos:u.costo}}),g(h)},i()}}función asíncrona be(n){let t=nueva fecha,r=nueva fecha(t.getFullYear(),t.getMonth(),1),i=await p.getApiUsageStats(n,r,t);return{totalRequests:i.totalRequests,totalUnits:i.totalUnits,totalCredits:i.totalCredits,costUsd:i.totalCredits}}función asíncrona Se(n,t){if(t===-1)return{permitido:!0,usado:0,restante:-1,porcentajeUsado:0};let r=await ser(n),i=Math.floor(r.totalUnits),u=ti,g=i/t*100;devolver{permitido:u>0,usado:i,restante:Math.max(0,u),porcentajeUsado:Math.min(100,g)}}función ae(n,t,r){si(!n.inquilino)devolver r();Se(n.inquilino.id,n.inquilino.cuotamensual).entonces(i=>{si(t.setHeader(\"X-Cuota-Usada\",i.usada),t.setHeader(\"X-Cuota-Restante\",i.restante),t.setHeader(\"X-Cuota-Porcentaje\",Math.round(i.porcentajeUsado)),!i.permitido)devolver t.status(429).json({success:!1,error:\"Cuota mensual excedida\",requestId:n.requestId,quota:{used:i.used,limit:n.tenant.cuotamensual,porcentajeUsado:i.porcentajeUsado},actualización:!0});r()}).catch(()=>r())}D();importar Ft desde\"crypto\";var $t=1e5,Ot=32,qt=\"sha256\",ne=null,pe=class n{secretomaestro;versión;createdAt;estático SALT_PREFIXES={claveprivada:\"kms:clave_privada:v1\",carteramaestra:\"kms:cartera_maestra:v1\",secretohmac:\"kms:secretohmac:v1\",derivacióndeclaveapi:\"kms:claveapi:v1\",cifradodesesión:\"kms:sesión:v1\"};constructor(t,r=1){if(!t||t.length<32)arrojar nuevo Error(\"El secreto maestro debe ser al menos 32 bytes (usar: openssl rand -hex 16)\");this.masterSecret=t,this.version=r,this.createdAt=new Date,t.length<64&&console.warn(\"\\u26A0\\uFE0F ADVERTENCIA: El secreto del KMS maestro tiene menos de 64 bytes. Considere usar: openssl rand -hex 32\")}static initialize(t){let r=t||process.env.MASTER_KMS_SECRET||process.env.SESSION_SECRET;if(!r)throw new Error(\"Variable de entorno MASTER_KMS_SECRET no establecida. Generar con: openssl rand -hex 32\");return ne||(ne=new n(r),console.log(\"\\u2705 KMS inicializado con secreto maestro\"),ne)}static getInstance(){return ne||(ne=n.initialize()),ne}deriveKey(t,r=\"\"){let i=n.SALT_PREFIXES[t];if(!i)throw new Error(`Tipo de clave desconocida: ${t}`);let u=Buffer.from(`${i}:${r}`);return{key:Ft.pbkdf2Sync(this.masterSecret,u,$t,Ot,qt),version:this.version,keyType:t}}derivePrivateKeyEncryptionKey(t){return this.deriveKey(\"privateKey\",t).key}deriveMasterWalletKey(t){return this.deriveKey(\"masterWallet\",t).key}deriveHmacKey(t){return this.deriveKey(\"hmacSecret\",t).key}deriveSessionEncryptionKey(t){return this.deriveKey(\"sessionEncryption\",t).key}getConfig(){return{masterSecret:\"[CENSURADO]\",version:this.version,createdAt:this.createdAt}}rotate(t){let r=new n(t,this.version+1);return ne=r,console.log(`\\u2705 KMS rotado a la versión ${r.version}`),r}static test(){try{let t=n.getInstance(),r=t.deriveKey(\"privateKey\",\"test-wallet-1\"),i=t.deriveKey(\"privateKey\",\"test-wallet-1\");if(r.key.toString(\"hex\")!==i.key.toString(\"hex\"))throw new Error(\"La derivación de la clave KMS no es determinista\");let u=t.deriveKey(\"privateKey\",\"test-wallet-2\");if(r.key.toString(\"hex\")===u.key.toString(\"hex\"))throw new Error(\"Colisión de derivación de clave KMS detectada\");return console.log(\"\\u2705 Autoprueba de KMS aprobada\"),!0}catch(t){return console.error(\"\\u274C Autoprueba de KMS fallida:\",t),!1}}};try{pe.initialize()}catch(n){console.warn(\"\\u26A0\\uFE0F Advertencia de inicialización de KMS:\",n)}import qe from\"crypto\";var Pe=\"aes-256-gcm\",Re=32,Gt=16;function rt(n,t,r){if(t.length!==Re)throw new Error(`La clave de cifrado debe ser de ${Re} bytes`);let i=qe.randomBytes(Gt),u=qe.createCipheriv(Pe,t,i);r&&u.setAAD(Buffer.from(r));let g=Buffer.concat([u.update(n,\"utf8\"),u.final()]),h=u.getAuthTag();return{ciphertext:g.toString(\"hex\"),iv:i.toString(\"hex\"),authTag:h.toString(\"hex\"),algorithm:Pe}}function ot(n,t,r){if(t.length!==Re)throw new Error(`La clave de cifrado debe tener ${Re} bytes`);if(n.algorithm!==Pe)throw new Error(`Algoritmo no compatible: ${n.algorithm}`);let i=Buffer.from(n.iv,\"hex\"),u=Buffer.from(n.ciphertext,\"hex\"),g=Buffer.from(n.authTag,\"hex\"),h=qe.createDecipheriv(Pe,t,i);r&&h.setAAD(Buffer.from(r)),h.setAuthTag(g);try{return Buffer.concat([h.update(u),h.final()]).toString(\"utf8\")}catch{throw new Error(\"Error de descifrado: los datos pueden estar dañados o alterados\")}}import{sql como Vt}desde\"drizzle-orm\";import{webcrypto como it}desde\"crypto\";var Yt=w.object({nombre:w.string().min(2),correo electrónico:w.string().correo electrónico(),nivel:w.enum([\"starter\",\"scale\",\"enterprise\"]).predeterminado(\"starter\"),nombreDeEmpresa:w.string().opcional(),sitio web:w.string().url().opcional(),correo electrónico de facturación:w.string().correo electrónico().opcional()}),zt=w.object({cadena:w.string(),etiqueta:w.string().opcional(),etiquetas:w.array(w.string()).opcional(),URLdelwebhook:w.string().url().opcional()}),Xt=w.object({url:w.string().url(),eventos:w.array(w.enum(Be)).min(1)});función asíncrona ct(n,t){nt().catch(console.error),t.get(\"/\",(s,a)=>{a.json({name:\"Tatum API Gateway\",version:\"1.0.0\",description:\"API Gateway de blockchain de nivel empresarial compatible con más de 130 blockchains\",status:\"running\",documentation:\"GET /api/docs | GET /api/docs/model | GET /api/docs/examples\",quickStart:\"1. Obtener la clave API del administrador | 2. Agregar el encabezado 'x-api-key: YOUR_KEY' | 3. Enviar por POST a /api/tenants para registrarse\",endpoints:{health:\"GET /api/health\",pricing:\"GET /api/pricing\",chains:\"GET /api/chains\",tenants:\"GET /api/tenants | POST /api/inquilinos\", direcciones:\"GET /api/v1/direcciones | POST /api/v1/direcciones\", transacciones:\"GET /api/v1/transacciones\", webhooks:\"POST /api/v1/webhooks | GET /api/v1/webhooks\", puerta de enlace:\"POST /api/v1/puerta de enlace/cuentas-virtuales | GET /api/v1/puerta de enlace/cuentas-virtuales | POST /api/v1/puerta de enlace/intercambio | POST /api/v1/puerta de enlace/retiro\", administrador:\"GET /api/admin/configuración-gas | PUT /api/admin/configuración-gas/global | GET /api/admin/ingresos | GET /api/admin/transacciones\", rwa:\"POST /api/v1/rwa/tokens | GET /api/v1/rwa/tokens | POST /api/v1/rwa/tokens/:id/transfer\"},businessModel:{type:\"Puerta de enlace API de doble panel (100 % de ingresos de administración)\",panels:{cryptoPanel:{description:\"Control de billetera maestra con sistema de cuentas virtuales\",revenueStreams:{internalSwaps:\"0,5 % de comisión (sin comisiones de gas)\",gasMarkup:\"40 % de margen configurable sobre las comisiones de gas\",setupFees:\"$500 por cliente de RWA\"},annualRevenue:\"$204K (Y1) \\u2192 $1.02M (Y2) \\u2192 $2.04M (Y3)\"}, rwaPanel:{description:\"Infraestructura de tokenización de activos del mundo real\",revenueStreams:{setupFees:\"$500 por token (pago único)\",nnualFees:\"$200 por token al año\",tradingCommissions:\"0.5% del volumen total de operaciones (100% para administración)\"},annualRevenue:\"$654K (Y1) \\u2192 $8.07M (Y2) \\u2192 $60.21M (Y3)\"}},profitMargins:\"82.5% (Y1) \\u2192 91.2% (Y2) \\u2192 96,8 % (año 3)\", totalProjections:{año 1:\"$858 000\", año 2:\"$9,09 000\", año 3:\"$62,25 000\"}}, auth:{type:\"Clave API + HMAC\", method:\"x-api-key header (Tatum v3 recommended)\", example:\"curl -H 'x-api-key: YOUR_API_KEY' https://api.example.com/api/v1/...\", documentation:\"https://docs.tatum.io/docs/authentication\"}, rateLimit:\"Por nivel: Starter 10/s, Scale 100/s, Enterprise 1000/seg\",docs:\"https://api.tatum.io/docs\",github:\"https://github.com/MasterFital/tatum-api-gateway\"})}),t.get(\"/api/docs/model\",(s,a)=>{a.json({title:\"Tatum API Gateway - Modelo de Negocio\",introduction:\"Arquitectura de doble panel que genera el 100% de ingresos administrativos mediante el trading de criptomonedas y la tokenización de RWA\",panels:{crypto:{name:\"Panel CRYPTO (100% de tus ingresos)\",description:\"Controlas las billeteras maestras (BTC, ETH, SOL, MATIC). Los clientes operan a través de cuentas virtuales.\",how_it_works:{step1:\"El administrador crea billeteras maestras mediante POST /api/admin/master-wallets\",step2:\"Los clientes crean cuentas virtuales mediante POST /api/v1/gateway/virtual-accounts\",paso 3:\"Los clientes pueden intercambiar internamente (comisión del 0,5 % para usted) o retirar externamente (margen de beneficio del 40 %)\",paso 4:\"El administrador registra todos los ingresos mediante GET /api/admin/revenue\"},revenue_streams:{internal_swaps:{description:\"El cliente intercambia BTC \\u2192 ETH\",fee:\"0,5 % del importe del intercambio\",gas_cost:\"Cero (interno)\",admin_profit:\"100 % de la comisión\",example:\"El cliente intercambia 1 ETH \\u2192 0,02 BTC | Comisión: 0,0001 BTC (100 % para el administrador)\"},gas_markup:{description:\"El cliente retira criptomonedas a una billetera externa\",fee:\"Margen de beneficio del 40 % sobre el gas real costo\", ejemplo:\"Gas Bitcoin: $3 reales | Cobras: $4.20 | Tu ganancia: $1.20 (40%)\"}}, proyecciones:{año1:{volumen:\"Promedio de 1 millón de USD/mes\", swaps mensuales:\"5K \\xD7 0.5% = $25K\", gas mensual:\"Retiros de 10K \\xD7 $3 \\xD7 40% = $12K\", total mensual:\"$17K\", anual:\"$204K\"}, año2:{volumen:\"Promedio de 5 millones de USD/mes\", anual:\"$1.02M\"}, año3:{volumen:\"Promedio de 10 millones de USD/mes\", anual:\"$2.04M\"}}}, rwa:{nombre:\"Panel RWA (100% Tus Ingresos + Tarifas)\", descripción:\"Los clientes emiten tokens. Tú proporcionas la infraestructura. Te quedas con el 100% de las tarifas y comisiones de trading.\", cómo_funciona:{paso 1:\"El cliente solicita la creación de un token: POST /api/v1/rwa/tokens\", paso 2:\"Cobras $500 de comisión de configuración + implementación del contrato inteligente\", paso 3:\"El token se activa. Los clientes operan internamente (comisión del 0,5 % para ti)\", paso 4:\"Comisión anual de mantenimiento de $200 por token\", paso 5:\"Todos los retiros externos tienen un margen de gas del 40 % (para ti)\", paso 6:\"Seguimiento de los ingresos mediante GET /api/admin/rwa-revenue\"},revenue_streams:{setup_fees:{description:\"Comisión única por token lanzado\",amount:\"$500\",frequency:\"Por token\"},annual_fees:{description:\"Mantenimiento anual por token activo\",amount:\"$200\",frequency:\"Por token por año\"}, comisiones_comerciales:{descripción:\"0.5% del volumen total de operaciones de tokens (100% para el administrador)\", porcentaje:\"0.5%\", ejemplo:\"Volumen de tokens: $100,000/mes | Su comisión: $500/mes = $6,000/año por token\"}, margen_gas:{descripción:\"40% de margen en las comisiones de gas para retiros externos\", porcentaje:\"40%\"}}, beneficios_del_cliente:{beneficio1:\"Infraestructura de tokenización (su costo: ~$0.10 por token)\", beneficio2:\"Mercado listo para usar\", beneficio3:\"Liquidez instantánea (operadores del día 1)\", beneficio4:\"Seguridad y cumplimiento a su cargo\", pago_del_cliente:\"$500 de configuración + $200/año solo\"}, proyecciones:{año1:{tokens:\"20 tokens nuevos\", tarifas_de_configuración:\"20 \\xD7 $500 = $10K\", tarifas_anuales:\"20 \\xD7 $200 = $4K\", comisiones_de_operación:\"0.5% de un volumen de ~$100M = $500K\", total:\"$514K\"}, año2:{tokens:\"100 tokens en total\", tarifas_de_configuración:\"100 \\xD7 $500 = $50K\", tarifas_anuales:\"100 \\xD7 $200 = $20K\", comisiones_de_operación:\"0.5% de un volumen de ~$1.6B = $8M\",total:\"$8.07M\"},año3:{tokens:\"300 tokens en total\",tarifas_de_configuración:\"300 \\xD7 $500 = $150K\",tarifas_anuales:\"300 \\xD7 $200 = $60K\",comisiones_de_comercio:\"0.5% de un volumen de ~$12B = $60M\",total:\"$60.21M\"}}}},resumen_de_ingresos:{título:\"Ingresos combinados (Cripto + RWA)\",año 1:{cripto:\"$204K\",rwa:\"$654K\",total:\"$858K\",margen:\"82.5%\"},año 2:{cripto:\"$1.02M\",rwa:\"$8.07M\",total:\"$9.09M\",margen:\"91.2%\"},año 3:{cripto:\"$2.04M\",rwa:\"$60.21M\",total:\"$62.25M\",margen:\"96.8%\"}},puntos_clave:[\"El 100% de todos los ingresos van al administrador (usted)\",\"Los clientes obtienen acceso a la infraestructura, no a la repartición de ingresos\",\"Las tarifas de configuración son ingresos inmediatos\",\"Las comisiones de trading escalan infinitamente con el volumen\",\"El margen de gas es puro beneficio (costo mínimo de infraestructura)\",\"Costo de adquisición de clientes cero (los clientes se traen a sí mismos)\"]})}),t.get(\"/api/docs/examples\",(s,a)=>{a.json({title:\"Tatum API Gateway - Ejemplos de uso\",autenticación: {descripción:\"Todas las solicitudes requieren el encabezado x-api-key\",ejemplo:\"curl -H 'x-api-key: YOUR_API_KEY' https://api.example.com/api/v1/...\",encabezados:{\"x-api-key\":\"Su clave API del administrador\",\"Content-Type\":\"application/json\"}},crypto_examples: {título:\"Ejemplos del panel CRYPTO\",create_virtual_account: {descripción:\"El cliente crea una cuenta virtual para almacenar criptomonedas\",endpoint:\"POST /api/v1/gateway/virtual-accounts\",solicitud:{tipoDeCuenta:\"individual\"},respuesta:{éxito:!0,cuentaVirtual:{id:\"va-123\",identificadorDeInquilino:\"cliente-1\",tipoDeCuenta:\"individual\",saldos:{BTC:\"0\",ETH:\"0\",SOL:\"0\"},estado:\"activo\"}}},interno_swap_0_5_percent:{descripción:\"El cliente intercambia BTC por ETH (comisión del 0,5 % para el administrador)\",punto final:\"POST /api/v1/gateway/swap\", solicitud: {fromAccountId:\"va-123\", fromAsset:\"BTC\", toAsset:\"ETH\", importe:\"1.0\"}, respuesta: {éxito:!0, intercambio: {id:\"swap-456\", fromAsset:\"BTC\", toAsset:\"ETH\", importe:\"1.0\", comisión:\"0.005 BTC (0.5% para el administrador)\", estado:\"completado\"}, nota:\"Sin comisiones de gas, comisión del 0.5% aplicada\"}}, external_withdraw_40_percent_markup: {descripción:\"El cliente retira a una billetera externa (40% de margen de gas para el administrador)\", punto final:\"POST /api/v1/gateway/withdraw\", solicitud: {fromAccountId:\"va-123\", activo:\"ETH\", importe:\"1.0\", dirección:\"0x1234567890abcdef...\"}, respuesta: {éxito:!0, retiro: {id:\"withdraw-789\", activo:\"ETH\", importe:\"1.0\", dirección:\"0x1234567890abcdef...\", gasReal:\"3 USD\", gasCharged:\"4.20 USD (40% de margen)\", adminProfit:\"1.20 USD\", estado:\"pendiente\", txHash:\"0xabcd...\"}}}, ver_historial_de_transacciones: {descripción:\"El cliente visualiza su transacción historial\", punto final:\"GET /api/v1/transactions?limit=50\", respuesta:{éxito:!0, transacciones:[{id:\"swap-456\", tipo:\"internal_swap\", activo:\"BTC\", importe:\"1.0\", comisión:\"0.005\", estado:\"completado\", creado el:\"2024-11-30T10:00:00Z\"}], paginación:{total:42, límite:50, desplazamiento:0}}}}, ejemplos_rwa:{título:\"Ejemplos de paneles RWA\", crear_rwa_token_500_setup:{descripción:\"El cliente crea un token (paga $500 de tarifa de configuración al administrador)\", punto final:\"POST /api/v1/rwa/tokens\",solicitud:{nombreDeActivo:\"Fondo Inmobiliario\",símbolo:\"REF\",cadenaDeBlockchain:\"Ethereum\",decimales:18,suministroTotal:\"1000000\",nombreDeEmisor:\"RE Properties Inc\",descripción:\"Inversión Inmobiliaria Tokenizada\"},respuesta:{éxito:!0,token:{id:\"token-ref-1\",nombreDeActivo:\"Fondo inmobiliario\", símbolo:\"REF\", cadena de bloques:\"ethereum\", suministro total:\"1000000\", dirección del contrato inteligente:\"0x...\", estado:\"creado\"}, precios: {tarifa de configuración:\"$500 (pago único) - PAGADO AL ADMINISTRADOR\", tarifa anual:\"$200/año - PAGADO AL ADMINISTRADOR\", comisión de negociación:\"0.5% en todas las operaciones - 100% PARA EL ADMINISTRADOR\"}}}, lista_rwa_tokens: {descripción:\"El cliente visualiza sus tokens y volumen de operaciones\", punto final:\"GET /api/v1/rwa/tokens\", respuesta: {éxito:!0, tokens:[{id:\"token-ref-1\", nombre_del_activo:\"Bienes raíces Fondo\", símbolo:\"REF\", cadena de bloques:\"ethereum\", oferta total:\"1000000\", estado:\"activo\", tarifa de configuración:\"500, tarifa anual:\"200, volumen de negociación:\"250000 USD\", comisión de negociación:\"1250 USD (0,5 % para el administrador)\"}], resumen:{totalTokens:\"1, comisiones de negociación totales:\"1250 USD (100 % para el administrador)\", tarifas de configuración cobradas:\"500 USD (100 % para el administrador)\"}}}, rwa_token_transfer_0_5_percent:{descripción:\"El titular del token negocia el token REF (0,5 % de comisión para el administrador)\", punto final:\"POST /api/v1/rwa/tokens/token-ref-1/transfer\",request:{toAddress:\"0xabcd...\",amount:\"100\"},response:{success:!0,transfer:{id:\"transfer-123\",tokenId:\"token-ref-1\",amount:\"100 REF\",toAddress:\"0xabcd...\",commission:\"0.5 REF (0.5% para el administrador)\",status:\"completed\",txHash:\"0x...\"},note:\"0.5% de comisión de trading aplicada y cobrada por el administrador\"}}},admin_examples:{title:\"Ejemplos del panel de administración\",view_revenue:{description:\"El administrador visualiza los ingresos totales (swaps + margen de gas)\",endpoint:\"GET /api/admin/revenue\",respuesta:{éxito:!0,cryptoRevenue:{totalSwapCommissions:\"1245.67 USD\",totalGasMarkupRevenue:\"3456.78 USD\",totalVolume:\"249000 USD\",revenueByBlockchain:{ethereum:\"2345.67\",polygon:\"1234.56\",bitcoin:\"3456.78\"}}}},view_rwa_revenue:{description:\"El administrador visualiza los ingresos de RWA (comisiones de configuración + anuales + de trading)\",endpoint:\"GET /api/admin/rwa-revenue\",respuesta:{éxito:!0,rwaRevenue:{setupFees:{count:12,total:\"6000 USD\", Tarifas anuales: {Clientes activos: 12, Total: 2400 USD\", Comisiones por operaciones: {Este mes: 12500 USD\", Este año: 125000 USD\", Tasa: 0,5 % del volumen total de operaciones\", Ingresos mensuales totales: 15000 USD\", Seguridad: {Autenticación: encabezado x-api-key (recomendado Tatum v3)\", Cifrado: Todas las claves privadas cifradas con AES-256\", Auditoría: Todas las transacciones registradas con registro de auditoría completo\", Límite de tasa: Starter 10/s, Scale 100/s, Enterprise 1000/seg\",documentación:\"https://docs.tatum.io/docs/authentication\"}})}),t.get(\"/api/test-tatum\",async(s,a)=>{try{let e=await B.healthCheck(),o={success:e.success,message:e.success?\"\\u2705 Conectado a la API de Tatum correctamente\":\"\\u274C Error al conectarse a la API de Tatum\",tatumApiUrl:process.env.TATUM_API_URL||\"https://api.tatum.io\",apiKeyConfigured:!!process.env.TATUM_API_KEY,apiKeyLength:process.env.TATUM_API_KEY?.length||0,timestamp:new Date().toISOString()};e.success&&e.data&&(o.blockchainInfo={chain:e.data.chain,blocks:e.data.blocks,mempool:e.data.mempool}),e.error&&(o.error=e.error,o.statusCode=e.statusCode),a.json({success:e.success,test:\"Prueba de conexión a la API de Tatum\",status:o,instructions:{production:\"Configure la variable de entorno TATUM_API_KEY con su API de producción de Tatum key\",documentation:\"https://docs.tatum.io/docs/authentication\",getApiKey:\"https://dashboard.tatum.io\"},requestId:s.requestId})}catch(e){a.status(500).json({success:!1,test:\"Prueba de conexión de la API de Tatum\",error:e.message,message:\"Error al probar la conexión de Tatum\",instructions:{checkApiKey:\"Asegúrese de que TATUM_API_KEY esté configurado en las variables de entorno\",checkUrl:\"Verifique que TATUM_API_URL esté correct\",documentation:\"https://docs.tatum.io/docs/authentication\"},requestId:s.requestId})}}),t.get(\"/api/docs\",(s,a)=>{a.json({title:\"Tatum API Gateway - Documentación completa\",message:\"Para obtener más información, visite estos puntos finales de la documentación:\",available_docs:{business_model:\"GET /api/docs/model - Explicación completa de los flujos de ingresos\",examples:\"GET /api/docs/examples - Ejemplos de uso para Crypto y RWA\",tatum_test:\"GET /api/test-tatum - Conexión de prueba a la API de Tatum (verificación de producción)\",this_endpoint:\"GET /api/docs - Esta página\",api_root:\"GET / - Información de la API y descripción general del modelo de negocio\"},quick_endpoints:{\"Crypto Panel\":[\"POST /api/v1/gateway/virtual-accounts - Crear cuenta virtual\",\"POST /api/v1/gateway/swap - Swap interno (comisión del 0,5%)\",\"POST /api/v1/gateway/withdraw - Retiro externo (margen de beneficio del 40%)\",\"GET /api/v1/transactions - Historial de transacciones\"],\"Panel RWA\":[\"POST /api/v1/rwa/tokens - Crear token (comisión de instalación de 500$)\",\"GET /api/v1/rwa/tokens - Listar tokens\",\"POST /api/v1/rwa/tokens/:id/transfer - Intercambio de tokens (comisión del 0,5%)\"],Admin:[\"GET /api/admin/revenue - Panel de ingresos de criptomonedas\",\"GET /api/admin/rwa-revenue - Panel de ingresos de RWA\",\"GET /api/admin/master-wallets - Lista de billeteras maestras\",\"POST /api/admin/master-wallets - Crear billetera maestra\"]},authentication:{method:\"x-api-key header\",example:\"Authorization: x-api-key YOUR_API_KEY\",documentation:\"https://docs.tatum.io/docs/authentication\"},support:{github:\"https://github.com/MasterFital/tatum-api-gateway\",tatum_docs:\"https://api.tatum.io/docs\",api_reference:\"https://docs.tatum.io/reference/welcome-to-the-tatum-api-reference\"}})}),t.get(\"/api/health\",async(s,a)=>{let e=await B.healthCheck();a.json({éxito:!0,estado:\"saludable\",servicios:{api:\"saludable\",base de datos:\"saludable\",tatum:e.success?\"saludable\":\"degradado\"},marca de tiempo:nueva Fecha().toISOString()})}), t.get(\"/api/pricing\",(s,a)=>{a.json({éxito:!0,precios:le,niveles:Object.entries(H).map(([e,o])=>({id:e,...o,precios:{starter:{mensual:0,incluido:1e4},escala:{mensual:99,incluido:1e5},empresa:{mensual:\"personalizado\",incluido:\"ilimitado\"}}[e]}))})}), t.get(\"/api/cadenas\",(s,a)=>{a.json({éxito:!0,cadenas:me,total:me.length})}), t.post(\"/api/inquilinos\",async(s,a)=>{try{let e=Yt.parse(s.body);if(await p.getTenantByEmail(e.email))return a.status(409).json({éxito:!1,error:\"Correo electrónico ya registrado\"});let{key:c,prefix:d,hash:y}=Ie(),m=H[e.tier],I=await p.createTenant({nombre:e.nombre,correo electrónico:e.correo electrónico,nivel:e.nivel,estado:\"activo\",apiKeyPrefix:d,apiKeyHash:y,hmacSecret:we(),allowedChains:[...m.cadenas],maxAddresses:m.maxAddresses,maxWebhooks:m.maxWebhooks,maxVirtualAccounts:m.maxVirtualAccounts,rateLimit:m.rateLimit,monthlyQuota:m.monthlyQuota,companyName:e.companyName,website:e.website,billingEmail:e.billingEmail});await p.createAuditLog({tenantId:I.id,action:\"tenant.created\",resource:\"tenant\",resourceId:I.id,changes:{tier:e.tier}}),a.status(201).json({success:!0,tenant:{id:I.id,name:I.name,email:I.email,tier:I.tier,status:I.status,apiKey:c,hmacSecret:I.hmacSecret,limits:{chains:I.allowedChains,maxAddresses:I.maxAddresses,maxWebhooks:I.maxWebhooks,maxVirtualAccounts:I.maxVirtualAccounts,rateLimit:I.rateLimit,monthlyQuota:I.monthlyQuota},createdAt:I.createdAt},warning:\"Guarde su clave API ahora. No se puede recuperar de nuevo.\"})}catch(e){if(e.name===\"ZodError\")return a.status(400).json({éxito:!1,error:\"Error de validación\",details:e.errors});console.error(\"Error al crear inquilino:\",e),a.status(500).json({éxito:!1,error:\"Error interno del servidor\"})}}),t.get(\"/api/tenants\",async(s,a)=>{try{let e=await p.getAllTenants(),o=await Promise.all(e.map(async c=>{let d=await be(c.id),y=await p.countAddressesByTenant(c.id); return{id:c.id,name:c.name,email:c.email,tier:c.tier,status:c.status,companyName:c.companyName,addressCount:y,usage:{requests:d.totalRequests,units:Math.floor(d.totalUnits),costUsd:d.costUsd.toFixed(4)},createdAt:c.createdAt}}));a.json({success:!0,tenants:o})}catch(e){console.error(\"Error al obtener inquilinos:\",e),a.status(500).json({success:!1,error:\"Error interno del servidor\"})}}),t.get(\"/api/tenants/:id\",b,async(s,a)=>{try{let e=espera p.getTenant(s.params.id);si(!e)devuelve a.status(404).json({éxito:!1,error:\"No se encontró el inquilino\"}); sea o=await be(e.id),c=await Se(e.id,e.monthlyQuota),d=await p.countAddressesByTenant(e.id),y=await p.countWebhooksByTenant(e.id),m=await p.countVirtualAccountsByTenant(e.id);a.json({éxito:!0, inquilino:{id:e.id, nombre:e.name, correo electrónico:e.email, nivel:e.tier, estado:e.status, nombreDeEmpresa:e.nombreDeEmpresa, sitio web:e.website, correo electrónicoDeFacturación:e.correoElectrónicoDeFacturación, prefijoDeClaveAPI:e.prefijoDeClaveAPI, límites:{cadenas:e.cadenaspermitidas, direccionesmáximas:e.direccionesmáximas, webhooksmáx:e.webhooksmáx, cuentasvirtualesmáx:e.accesoVirtual recuentos, rateLimit:e.rateLimit, monthlyQuota:e.monthlyQuota}, uso:{direcciones:d, webhooks:y, cuentas virtuales:m, solicitudes:o.totalRequests, unidades:Math.floor(o.totalUnits), costoUsd:o.costUsd.toFixed(4), cuota:{usado:c.usado, restante:c.restante, porcentajeUsado:Math.round(c.porcentajeUsado)}}, creadoEn:e.creadoEn, actualizadoEn:e.actualizadoEn}})}catch(e){console.error(\"Obtener Error de inquilino:\",e),a.status(500).json({éxito:!1,error:\"Error interno del servidor\"})}}),t.patch(\"/api/tenants/:id\",b,async(s,a)=>{try{if(s.tenant.id!==s.params.id)return a.status(403).json({éxito:!1,error:\"Solo puede actualizar su propia cuenta\",requestId:s.requestId});let e=s.body,o=[\"nombre\",\"nombreDeEmpresa\",\"sitio web\",\"correo electrónico de facturación\"],c={};for(let y of o)e[y]!==void 0&&(c[y]=e[y]);if(Object.keys(c).length===0)return a.status(400).json({éxito:!1,error:\"No hay campos válidos para actualizar\",requestId:s.requestId});let d=await p.updateTenant(s.params.id,c);if(!d)return a.status(404).json({éxito:!1,error:\"No se encontró el inquilino\"});await p.createAuditLog({tenantId:d.id,acción:\"inquilino.actualizado\",resource:\"inquilino\",resourceId:d.id,cambios:c,ipAddress:s.ip}),a.json({éxito:!0,inquilino:d,requestId:s.requestId})}catch(e){console.error(\"Actualizar inquilino error:\",e),a.status(500).json({éxito:!1,error:\"Error interno del servidor\"})}}),t.post(\"/api/tenants/:id/rotate-key\",b,async(s,a)=>{try{let e=await p.getTenant(s.params.id);if(!e)return a.status(404).json({éxito:!1,error:\"No se encontró el inquilino\"});if(s.tenant.id!==e.id)return a.status(403).json({éxito:!1,error:\"Solo puede rotar su propia clave API\",requestId:s.requestId});let{key:o,prefix:c,hash:d}=Ie();await p.updateTenant(e.id,{apiKeyPrefix:c,apiKeyHash:d}),await p.createAuditLog({tenantId:e.id,action:\"apikey.rotated\",resource:\"tenant\",resourceId:e.id,changes:{rotated:!0}}),a.json({success:!0,apiKey:o,warning:\"Guarde su nueva clave API. La clave anterior ya no es válida y no se puede recuperar.\",requestId:s.requestId})}catch(e){console.error(\"Error al rotar la clave API:\",e),a.status(500).json({success:!1,error:\"Servidor interno error\"})}}),t.patch(\"/api/admin/tenants/:id\",$,async(s,a)=>{try{let e=s.body;if(e.tier){let c=H[e.tier];c&&(e.allowedChains=c.chains,e.maxAddresses=c.maxAddresses,e.maxWebhooks=c.maxWebhooks,e.maxVirtualAccounts=c.maxVirtualAccounts,e.rateLimit=c.rateLimit,e.monthlyQuota=c.monthlyQuota)}let o=await p.updateTenant(s.params.id,e);if(!o)return a.status(404).json({éxito:!1,error:\"No se encontró el inquilino\"});await p.createAuditLog({Id.inquilino:o.id,acción:\"admin.tenant.updated\",recurso:\"inquilino\",Id.recurso:o.id,cambios:e,direcciónIP:s.ip}),a.json({éxito:!0,inquilino:o,Id.solicitud:s.Id.solicitud})}catch(e){console.error(\"El administrador actualiza el inquilino error:\",e),a.status(500).json({éxito:!1,error:\"Error interno del servidor\"})}}),t.post(\"/api/admin/tenants/:id/suspend\",$,async(s,a)=>{try{let e=await p.updateTenant(s.params.id,{status:\"suspendido\"});if(!e)return a.status(404).json({éxito:!1,error:\"Inquilino no encontrado\"});await p.createAuditLog({tenantId:e.id,action:\"admin.tenant.suspended\",resource:\"tenant\",resourceId:e.id,changes:{status:\"suspended\"},ipAddress:s.ip}),a.json({success:!0,message:\"Inquilino suspendido\",requestId:s.requestId})}catch(e){console.error(\"Error de suspensión del inqui
{"mensaje":"","atributos":{"nivel":"información"},"marca de tiempo":"2025-11-30T18:34:40.616193839Z"}
{"mensaje":"> rest-express@1.0.0 inicio","atributos":{"nivel":"información"},"marca de tiempo":"2025-11-30T18:34:40.616200804Z"}
{"mensaje":"> NODE_ENV=nodo de producción dist/index.js","atributos":{"nivel":"información"},"marca de tiempo":"2025-11-30T18:34:40.616208365Z"}
{"mensaje":"","atributos":{"nivel":"información"},"marca de tiempo":"2025-11-30T18:34:40.616227158Z"}
{"mensaje":"archivo:///app/dist/index.js:1","atributos":{"nivel":"error"},"marca de tiempo":"2025-11-30T18:34:41.057295974Z"}
{"message":"var mt=Object.defineProperty;var fe=(n,t)=>()=>(n&&(t=n(n=0)),t);var xe=(n,t)=>{for(var r in t)mt(n,r,{get:t[r],enumerable:!0})};var J={};xe(J,{ChainEnum:()=>ft,PRICING:()=>le,SUPPORTED_CHAINS:()=>me,StatusEnum:()=>yt,TIER_LIMITS:()=>H,TierEnum:()=>gt,WEBHOOK_EVENTS:()=>Be,addresses:()=>S,apiUsage:()=>W,auditLogs:()=>te,billingAggregations:()=>Q,cryptoTransactions:()=>de,gasSettings:()=>X,insertAddressSchema:()=>vt,insertApiUsageSchema:()=>_t,insertAuditLogSchema:()=>xt,insertCryptoTransactionSchema:()=>At,insertMasterWalletSchema:()=>It,insertTenantSchema:()=>bt,insertTransactionSchema:()=>kt,insertVirtualAccountSchema:()=>wt,insertWebhookSchema:()=>Tt,masterWallets:()=>z,tenants:()=>x,tenantsRelations:()=>ht,transactions:()=>j,virtualAccounts:()=>_,webhooks:()=>K});import{sql as M}from\"drizzle-orm\";import{pgTable as q,text as l,varchar as T,integer as E,boolean as Ve,timestamp as R,jsonb as F,real as he,index as v}from\"drizzle-orm/pg-core\";import{createInsertSchema as Y}from\"drizzle-zod\";import{z as Ke}from\"zod\";import{relations as pt}from\"drizzle-orm\";var gt,yt,ft,x,z,_,de,X,S,j,K,W,Q,te,ht,It,wt,At,bt,vt,kt,Tt,_t,xt,H,le,Be,me,D=fe(()=>{\"use strict\";gt=Ke.enum([\"starter\",\"scale\",\"enterprise\"]),yt=Ke.enum([\"active\",\"suspended\",\"deleted\"]),ft=Ke.enum([\"bitcoin\",\"ethereum\",\"solana\",\"polygon\",\"tron\",\"bsc\",\"ripple\",\"cardano\",\"near\",\"polkadot\",\"avalanche\",\"arbitrum\",\"optimism\",\"base\",\"fantom\",\"cronos\",\"cosmos\",\"algorand\"]),x=q(\"tenants\",{id:T(\"id\",{length:36}).primaryKey().default(M`gen_random_uuid()`),name:l(\"name\").notNull(),email:l(\"email\").notNull().unique(),tier:l(\"tier\").notNull().default(\"starter\"),status:l(\"status\").notNull().default(\"active\"),apiKeyPrefix:T(\"api_key_prefix\",{length:16}).notNull(),apiKeyHash:l(\"api_key_hash\").notNull().unique(),hmacSecret:l(\"hmac_secret\").notNull(),allowedChains:l(\"allowed_chains\").array().notNull().default(M`ARRAY['bitcoin', 'ethereum', 'solana']`),maxAddresses:E(\"max_addresses\").notNull().default(50),maxWebhooks:E(\"max_webhooks\").notNull().default(1),maxVirtualAccounts:E(\"max_virtual_accounts\").notNull().default(0),rateLimit:E(\"rate_limit\").notNull().default(10),monthlyQuota:E(\"monthly_quota\").notNull().default(1e4),billingEmail:l(\"billing_email\"),companyName:l(\"company_name\"),website:l(\"website\"),ipWhitelist:l(\"ip_whitelist\").array(),metadata:F(\"metadata\"),createdAt:R(\"created_at\").defaultNow().notNull(),updatedAt:R(\"updated_at\").defaultNow().notNull()},n=>[v(\"tenants_email_idx\").on(n.email),v(\"tenants_api_key_hash_idx\").on(n.apiKeyHash),v(\"tenants_status_idx\").on(n.status)]),z=q(\"master_wallets\",{id:T(\"id\",{length:36}).primaryKey().default(M`gen_random_uuid()`),scenario:l(\"scenario\").notNull(),blockchain:l(\"blockchain\").notNull(),assetType:l(\"asset_type\").notNull(),assetName:l(\"asset_name\").notNull(),address:l(\"address\").notNull().unique(),publicKey:l(\"public_key\"),privateKeyEncrypted:l(\"private_key_encrypted\"),privateKeyIv:T(\"private_key_iv\",{length:32}),privateKeyAuthTag:T(\"private_key_auth_tag\",{length:32}),smartContractAddress:l(\"smart_contract_address\"),tokenDecimals:E(\"token_decimals\"),assignedToTenantId:T(\"assigned_to_tenant_id\",{length:36}).references(()=>x.id),balance:l(\"balance\").default(\"0\"),balanceUsd:l(\"balance_usd\").default(\"0\"),lastSyncTime:R(\"last_sync_time\"),gasMarkupPercentage:E(\"gas_markup_percentage\").default(40),status:l(\"status\").notNull().default(\"active\"),metadata:F(\"metadata\"),createdAt:R(\"created_at\").defaultNow().notNull(),updatedAt:R(\"updated_at\").defaultNow().notNull()},n=>[v(\"masters_blockchain_idx\").on(n.blockchain),v(\"masters_asset_idx\").on(n.assetName),v(\"masters_address_idx\").on(n.address),v(\"masters_tenant_idx\").on(n.assignedToTenantId),v(\"masters_scenario_idx\").on(n.scenario)]),_=q(\"virtual_accounts\",{id:T(\"id\",{length:36}).primaryKey().default(M`gen_random_uuid()`),tenantId:T(\"tenant_id\",{length:36}).notNull().references(()=>x.id,{onDelete:\"cascade\"}),accountType:l(\"account_type\").notNull(),balances:F(\"balances\").default(M`'{}'`),status:l(\"status\").notNull().default(\"active\"),frozen:Ve(\"frozen\").default(!1),metadata:F(\"metadata\"),createdAt:R(\"created_at\").defaultNow().notNull(),updatedAt:R(\"updated_at\").defaultNow().notNull()},n=>[v(\"virtual_accounts_tenant_idx\").on(n.tenantId),v(\"virtual_accounts_status_idx\").on(n.status)]),de=q(\"crypto_transactions\",{id:T(\"id\",{length:36}).primaryKey().default(M`gen_random_uuid()`),tenantId:T(\"tenant_id\",{length:36}).notNull().references(()=>x.id,{onDelete:\"cascade\"}),type:l(\"type\").notNull(),scenario:l(\"scenario\").notNull(),fromAccountId:T(\"from_account_id\",{length:36}),toAccountId:T(\"to_account_id\",{length:36}),toExternalAddress:l(\"to_external_address\"),fromExternalAddress:l(\"from_external_address\"),assetType:l(\"asset_type\").notNull(),assetName:l(\"asset_name\").notNull(),blockchain:l(\"blockchain\").notNull(),amount:l(\"amount\").notNull(),gasReal:l(\"gas_real\"),gasMarkupPercent:E(\"gas_markup_percent\"),gasCharged:l(\"gas_charged\"),commissionAmount:l(\"commission_amount\"),commissionUsd:l(\"commission_usd\"),status:l(\"status\").notNull().default(\"pending\"),txHash:l(\"tx_hash\").unique(),blockNumber:E(\"block_number\"),confirmations:E(\"confirmations\"),metadata:F(\"metadata\"),createdAt:R(\"created_at\").defaultNow().notNull(),executedAt:R(\"executed_at\"),confirmedAt:R(\"confirmed_at\")},n=>[v(\"crypto_tx_tenant_idx\").on(n.tenantId),v(\"crypto_tx_type_idx\").on(n.type),v(\"crypto_tx_status_idx\").on(n.status),v(\"crypto_tx_hash_idx\").on(n.txHash),v(\"crypto_tx_scenario_idx\").on(n.scenario)]),X=q(\"gas_settings\",{id:T(\"id\",{length:36}).primaryKey().default(M`gen_random_uuid()`),globalDefaultMarkup:E(\"global_default_markup\").default(40),minMarkup:E(\"min_markup\").default(10),maxMarkup:E(\"max_markup\").default(100),clientOverrides:F(\"client_overrides\").default(M`'{}'`),blockchainMultipliers:F(\"blockchain_multipliers\").default(M`'{\"ethereum\": 1.0, \"polygon\": 0.3}'`),transactionTypeOverrides:F(\"transaction_type_overrides\").default(M`'{\"crypto_withdraw\": 40, \"token_transfer\": 45}'`),updatedAt:R(\"updated_at\").defaultNow().notNull(),updatedBy:l(\"updated_by\")},n=>[v(\"gas_settings_updated_idx\").on(n.updatedAt)]),S=q(\"addresses\",{id:T(\"id\",{length:36}).primaryKey().default(M`gen_random_uuid()`),tenantId:T(\"tenant_id\",{length:36}).notNull().references(()=>x.id,{onDelete:\"cascade\"}),chain:l(\"chain\").notNull(),currency:l(\"currency\").notNull(),address:l(\"address\").notNull(),publicKey:l(\"public_key\"),derivationPath:l(\"derivation_path\"),label:l(\"label\"),tags:l(\"tags\").array().default(M`ARRAY[]::text[]`),status:l(\"status\").notNull().default(\"active\"),balance:l(\"balance\").default(\"0\"),balanceUsd:l(\"balance_usd\").default(\"0\"),lastSynced:R(\"last_synced\"),webhookUrl:l(\"webhook_url\"),metadata:F(\"metadata\"),createdAt:R(\"created_at\").defaultNow().notNull(),updatedAt:R(\"updated_at\").defaultNow().notNull(),deletedAt:R(\"deleted_at\")},n=>[v(\"addresses_tenant_idx\").on(n.tenantId),v(\"addresses_chain_idx\").on(n.chain),v(\"addresses_status_idx\").on(n.status),v(\"addresses_address_idx\").on(n.address)]),j=q(\"transactions\",{id:T(\"id\",{length:36}).primaryKey().default(M`gen_random_uuid()`),tenantId:T(\"tenant_id\",{length:36}).notNull().references(()=>x.id,{onDelete:\"cascade\"}),txHash:l(\"tx_hash\").notNull(),chain:l(\"chain\").notNull(),fromAddress:l(\"from_address\"),toAddress:l(\"to_address\"),amount:l(\"amount\").notNull(),currency:l(\"currency\").notNull(),fee:l(\"fee\"),feeUsd:l(\"fee_usd\"),status:l(\"status\").notNull().default(\"pending\"),type:l(\"type\").notNull().default(\"native\"),blockNumber:E(\"block_number\"),confirmations:E(\"confirmations\").default(0),metadata:F(\"metadata\"),createdAt:R(\"created_at\").defaultNow().notNull()},n=>[v(\"transactions_tenant_idx\").on(n.tenantId),v(\"transactions_chain_idx\").on(n.chain),v(\"transactions_hash_idx\").on(n.txHash),v(\"transactions_status_idx\").on(n.status)]),K=q(\"webhooks\",{id:T(\"id\",{length:36}).primaryKey().default(M`gen_random_uuid()`),tenantId:T(\"tenant_id\",{length:36}).notNull().references(()=>x.id,{onDelete:\"cascade\"}),url:l(\"url\").notNull(),events:l(\"events\").array().notNull(),hmacSecret:l(\"hmac_secret\").notNull(),active:Ve(\"active\").default(!0),retryCount:E(\"retry_count\").default(0),lastTriggered:R(\"last_triggered\"),lastStatus:E(\"last_status\"),metadata:F(\"metadata\"),createdAt:R(\"created_at\").defaultNow().notNull()},n=>[v(\"webhooks_tenant_idx\").on(n.tenantId),v(\"webhooks_active_idx\").on(n.active)]),W=q(\"api_usage\",{id:T(\"id\",{length:36}).primaryKey().default(M`gen_random_uuid()`),tenantId:T(\"tenant_id\",{length:36}).notNull().references(()=>x.id,{onDelete:\"cascade\"}),endpoint:l(\"endpoint\").notNull(),method:l(\"method\").notNull(),chain:l(\"chain\"),action:l(\"action\").notNull(),units:he(\"units\").notNull(),credits:he(\"credits\").notNull(),statusCode:E(\"status_code\").notNull(),requestId:T(\"request_id\",{length:36}).notNull(),responseTimeMs:E(\"response_time_ms\"),metadata:F(\"metadata\"),timestamp:R(\"timestamp\").defaultNow().notNull()},n=>[v(\"api_usage_tenant_idx\").on(n.tenantId),v(\"api_usage_timestamp_idx\").on(n.timestamp),v(\"api_usage_action_idx\").on(n.action)]),Q=q(\"billing_aggregations\",{id:T(\"id\",{length:36}).primaryKey().default(M`gen_random_uuid()`),tenantId:T(\"tenant_id\",{length:36}).notNull().references(()=>x.id,{onDelete:\"cascade\"}),period:l(\"period\").notNull(),periodType:l(\"period_type\").notNull().default(\"daily\"),totalUnits:he(\"total_units\").notNull().default(0),totalCredits:he(\"total_credits\").notNull().default(0),costUsd:he(\"cost_usd\").notNull().default(0),breakdown:F(\"breakdown\"),createdAt:R(\"created_at\").defaultNow().notNull()},n=>[v(\"billing_tenant_period_idx\").on(n.tenantId,n.period)]),te=q(\"audit_logs\",{id:T(\"id\",{length:36}).primaryKey().default(M`gen_random_uuid()`),tenantId:T(\"tenant_id\",{length:36}).references(()=>x.id,{onDelete:\"set null\"}),userId:l(\"user_id\"),action:l(\"action\").notNull(),resource:l(\"resource\").notNull(),resourceId:l(\"resource_id\"),changes:F(\"changes\"),ipAddress:l(\"ip_address\"),userAgent:l(\"user_agent\"),requestId:T(\"request_id\",{length:36}),timestamp:R(\"timestamp\").defaultNow().notNull()},n=>[v(\"audit_logs_tenant_idx\").on(n.tenantId),v(\"audit_logs_timestamp_idx\").on(n.timestamp),v(\"audit_logs_action_idx\").on(n.action)]),ht=pt(x,({many:n})=>({addresses:n(S),transactions:n(j),webhooks:n(K),virtualAccounts:n(_),apiUsage:n(W),billingAggregations:n(Q),auditLogs:n(te),masterWallets:n(z),cryptoTransactions:n(de)})),It=Y(z).omit({id:!0,createdAt:!0,updatedAt:!0}),wt=Y(_).omit({id:!0,createdAt:!0,updatedAt:!0}),At=Y(de).omit({id:!0,createdAt:!0,executedAt:!0,confirmedAt:!0}),bt=Y(x).omit({id:!0,createdAt:!0,updatedAt:!0}),vt=Y(S).omit({id:!0,createdAt:!0,updatedAt:!0,deletedAt:!0}),kt=Y(j).omit({id:!0,createdAt:!0}),Tt=Y(K).omit({id:!0,createdAt:!0}),_t=Y(W).omit({id:!0,timestamp:!0}),xt=Y(te).omit({id:!0,timestamp:!0}),H={starter:{chains:[\"bitcoin\",\"ethereum\",\"solana\"],maxAddresses:50,maxWebhooks:1,maxVirtualAccounts:0,rateLimit:10,monthlyQuota:1e4,kmsAllowed:!1,archivalAccess:!1,retentionDays:1},scale:{chains:[\"bitcoin\",\"ethereum\",\"solana\",\"polygon\",\"tron\",\"bsc\",\"ripple\",\"cardano\"],maxAddresses:1e3,maxWebhooks:10,maxVirtualAccounts:5,rateLimit:100,monthlyQuota:1e5,kmsAllowed:!0,archivalAccess:!1,retentionDays:7},enterprise:{chains:[\"bitcoin\",\"ethereum\",\"solana\",\"polygon\",\"tron\",\"bsc\",\"ripple\",\"cardano\",\"near\",\"polkadot\",\"avalanche\",\"arbitrum\",\"optimism\",\"base\",\"fantom\",\"cronos\",\"cosmos\",\"algorand\"],maxAddresses:-1,maxWebhooks:-1,maxVirtualAccounts:50,rateLimit:1e3,monthlyQuota:-1,kmsAllowed:!0,archivalAccess:!0,retentionDays:30}},le={address_create:{units:1,cost:.001},balance_query:{units:.5,cost:5e-4},token_balance:{units:1,cost:.001},nft_metadata:{units:2,cost:.002},tx_broadcast_btc:{units:50,cost:.05},tx_broadcast_eth:{units:10,cost:.01},tx_broadcast_other:{units:10,cost:.01},tx_history:{units:2,cost:.002},webhook_subscription:{units:.02,cost:.02},va_create:{units:100,cost:.1},va_transfer:{units:5,cost:.005},exchange_rate:{units:.1,cost:1e-4},web3_resolve:{units:1,cost:.001},malicious_check:{units:2,cost:.002},rpc_standard:{units:2,cost:2e-4},rpc_eth_call:{units:5,cost:5e-4},rpc_debug:{units:50,cost:.005}},Be=[\"ADDRESS_TRANSACTION\",\"ADDRESS_BALANCE\",\"INCOMING_NATIVE_TX\",\"OUTGOING_NATIVE_TX\",\"INCOMING_FUNGIBLE_TX\",\"OUTGOING_FUNGIBLE_TX\",\"INCOMING_NFT_TX\",\"OUTGOING_NFT_TX\",\"INCOMING_MULTITOKEN_TX\",\"OUTGOING_MULTITOKEN_TX\",\"FAILED_TX\",\"PAID_FEE\",\"CONTRACT_LOG_EVENT\"],me=[{id:\"bitcoin\",name:\"Bitcoin\",symbol:\"BTC\",icon:\"\\u20BF\"},{id:\"ethereum\",name:\"Ethereum\",symbol:\"ETH\",icon:\"\\u039E\"},{id:\"solana\",name:\"Solana\",symbol:\"SOL\",icon:\"\\u25CE\"},{id:\"polygon\",name:\"Polygon\",symbol:\"MATIC\",icon:\"\\u2B21\"},{id:\"tron\",name:\"Tron\",symbol:\"TRX\",icon:\"\\u2666\"},{id:\"bsc\",name:\"BNB Chain\",symbol:\"BNB\",icon:\"\\u25C6\"},{id:\"ripple\",name:\"XRP Ledger\",symbol:\"XRP\",icon:\"\\u2715\"},{id:\"cardano\",name:\"Cardano\",symbol:\"ADA\",icon:\"\\u20B3\"},{id:\"near\",name:\"NEAR\",symbol:\"NEAR\",icon:\"\\u24C3\"},{id:\"polkadot\",name:\"Polkadot\",symbol:\"DOT\",icon:\"\\u25CF\"},{id:\"avalanche\",name:\"Avalanche\",symbol:\"AVAX\",icon:\"\\u25B2\"},{id:\"arbitrum\",name:\"Arbitrum\",symbol:\"ARB\",icon:\"\\u25C8\"},{id:\"optimism\",name:\"Optimism\",symbol:\"OP\",icon:\"\\u2295\"},{id:\"base\",name:\"Base\",symbol:\"ETH\",icon:\"\\u25EF\"},{id:\"fantom\",name:\"Fantom\",symbol:\"FTM\",icon:\"\\u25C7\"},{id:\"cronos\",name:\"Cronos\",symbol:\"CRO\",icon:\"\\u25CE\"},{id:\"cosmos\",name:\"Cosmos\",symbol:\"ATOM\",icon:\"\\u269B\"},{id:\"algorand\",name:\"Algorand\",symbol:\"ALGO\",icon:\"\\u24B6\"}]});var oe={};xe(oe,{db:()=>f,pool:()=>Ye});import{Pool as St,neonConfig as Pt}from\"@neondatabase/serverless\";import{drizzle as Rt}from\"drizzle-orm/neon-serverless\";import Et from\"ws\";var Ye,f,V=fe(()=>{\"use strict\";D();Pt.webSocketConstructor=Et;if(!process.env.DATABASE_URL)throw new Error(\"DATABASE_URL must be set. Did you forget to provision a database?\");Ye=new St({connectionString:process.env.DATABASE_URL}),f=Rt({client:Ye,schema:J})});function jt(n){return!n||typeof n!=\"string\"||n.length<32?!1:/^[a-zA-Z0-9_-]{32,}$/.test(n)}function Bt(){return P.state===\"open\"?Date.now()-P.lastFailure>=$e.resetTimeoutMs?(P.state=\"half-open\",P.successesInHalfOpen=0,!0):!1:!0}function Dt(){P.state===\"half-open\"?(P.successesInHalfOpen++,P.successesInHalfOpen>=$e.halfOpenSuccessThreshold&&(P.state=\"closed\",P.failures=0)):P.failures=0}function ze(){P.failures++,P.lastFailure=Date.now(),(P.state===\"half-open\"||P.failures>=$e.failureThreshold)&&(P.state=\"open\")}function Ut(n,t){return t.retryableStatuses.includes(n)}function Xe(n,t){return Math.min(t.baseDelayMs*Math.pow(2,n)+Math.random()*1e3,t.maxDelayMs)}async function Qe(n){return new Promise(t=>setTimeout(t,n))}async function N(n,t={},r=Kt){if(!Bt())return{success:!1,error:\"Service temporarily unavailable (circuit breaker open)\",statusCode:503};let i=null;for(let u=0;u<=r.maxRetries;u++)try{let g=new AbortController,h=setTimeout(()=>g.abort(),3e4),s=await fetch(`${Mt}${n}`,{...t,signal:g.signal,headers:{\"Content-Type\":\"application/json\",\"x-api-key\":Fe||\"\",...t.headers}});clearTimeout(h);let a=await s.json().catch(()=>null);if(!s.ok){let e={success:!1,error:a?.message||a?.error||`HTTP ${s.status}`,statusCode:s.status};if(s.status===429){let o=s.headers.get(\"Retry-After\");o&&(e.retryAfter=parseInt(o,10)*1e3)}if(Ut(s.status,r)&&u<r.maxRetries){i=e;let o=e.retryAfter||Xe(u,r);await Qe(o);continue}return ze(),e}return Dt(),{success:!0,data:a}}catch(g){let h=g.name===\"AbortError\",s=g.message?.includes(\"fetch\")||g.message?.includes(\"network\"),a={success:!1,error:h?\"Request timeout\":g.message||\"Network error\",statusCode:h?408:500};if((h||s)&&u<r.maxRetries){i=a,await Qe(Xe(u,r));continue}return ze(),a}return i||{success:!1,error:\"Max retries exceeded\",statusCode:500}}function Je(n){return me.find(t=>t.id===n)}var Mt,Fe,Kt,P,$e,se,B,Oe=fe(()=>{\"use strict\";D();Mt=process.env.TATUM_API_URL||\"https://api.tatum.io\",Fe=process.env.TATUM_API_KEY;Fe?jt(Fe)||console.warn(\"TATUM_API_KEY format appears invalid - may cause API errors\"):console.warn(\"TATUM_API_KEY not configured - API calls will fail\");Kt={maxRetries:3,baseDelayMs:1e3,maxDelayMs:3e4,retryableStatuses:[408,429,500,502,503,504]},P={failures:0,lastFailure:0,state:\"closed\",successesInHalfOpen:0},$e={failureThreshold:5,resetTimeoutMs:6e4,halfOpenSuccessThreshold:2};se={bitcoin:\"bitcoin\",ethereum:\"ethereum\",solana:\"solana\",polygon:\"polygon\",tron:\"tron\",bsc:\"bsc\",ripple:\"xrp\",cardano:\"ada\",near:\"near\",polkadot:\"dot\",avalanche:\"avax\",arbitrum:\"arbitrum-one\",optimism:\"optimism\",base:\"base\",fantom:\"fantom\",cronos:\"cro\",cosmos:\"atom\",algorand:\"algo\"},B={getCircuitBreakerState(){return{...P}},resetCircuitBreaker(){P.failures=0,P.lastFailure=0,P.state=\"closed\",P.successesInHalfOpen=0},async generateAddress(n){let t=se[n]||n;return N(`/v3/${t}/wallet`,{method:\"GET\"})},async getBalance(n,t){let r=se[n]||n;return[\"ethereum\",\"polygon\",\"bsc\",\"arbitrum-one\",\"optimism\",\"base\"].includes(r)?N(`/v3/${r}/account/balance/${t}`):N(r===\"bitcoin\"?`/v3/bitcoin/address/balance/${t}`:r===\"solana\"?`/v3/solana/account/balance/${t}`:`/v3/${r}/account/balance/${t}`)},async getTokens(n,t){let r=se[n]||n;return N(`/v3/data/tokens?chain=${r}&addresses=${t}`)},async getNFTs(n,t){let r=se[n]||n;return N(`/v3/data/nfts?chain=${r}&addresses=${t}`)},async getTransactionHistory(n,t,r){let i=se[n]||n,u=new URLSearchParams;return r?.pageSize&&u.set(\"pageSize\",r.pageSize.toString()),r?.offset&&u.set(\"offset\",r.offset.toString()),N(`/v3/data/transactions?chain=${i}&addresses=${t}&${u.toString()}`)},async getTransaction(n,t){let r=se[n]||n;return N(`/v3/${r}/transaction/${t}`)},async estimateFee(n,t=\"TRANSFER\"){let r=se[n]||n;return N(`/v3/${r}/gas/estimate`,{method:\"POST\",body:JSON.stringify({type:t})})},async broadcastTransaction(n,t){let r=se[n]||n;return N(`/v3/${r}/broadcast`,{method:\"POST\",body:JSON.stringify({txData:t})})},async getExchangeRates(n){let t=n.join(\",\");return N(`/v3/tatum/rate/${t}?basePair=USD`)},async resolveWeb3Name(n){return N(`/v3/blockchain/names/${n}`)},async checkMaliciousAddress(n){return N(`/v3/security/address/${n}`)},async createWebhook(n){return N(\"/v4/subscription\",{method:\"POST\",body:JSON.stringify(n)})},async deleteWebhook(n){return N(`/v4/subscription/${n}`,{method:\"DELETE\"})},async getWebhooks(){return N(\"/v4/subscription\")},async healthCheck(){let n=await N(\"/v3/tatum/version\");return n.success?{success:!0,data:{status:\"healthy\",version:n.data?.version||\"v3\",circuitBreaker:{...P}}}:{...n,data:{status:\"degraded\",version:\"unknown\",circuitBreaker:{...P}}}}}});var ve={};xe(ve,{GasFeeManager:()=>Ee,gasFeeManager:()=>Le});import{eq as Ge}from\"drizzle-orm\";var Ee,Le,ge=fe(()=>{\"use strict\";V();D();Ee=class{config=null;async loadConfig(){let[t]=await f.select().from(X).limit(1);if(!t){let r={globalDefaultMarkup:40,minMarkup:10,maxMarkup:100,clientOverrides:{},blockchainMultipliers:{ethereum:1,polygon:.3,bitcoin:1.2,solana:.1,arbitrum:.2},transactionTypeOverrides:{crypto_withdraw:40,token_transfer:45,smart_contract:60}};return this.config=r,r}return this.config={globalDefaultMarkup:t.globalDefaultMarkup,minMarkup:t.minMarkup,maxMarkup:t.maxMarkup,clientOverrides:t.clientOverrides||{},blockchainMultipliers:t.blockchainMultipliers||{},transactionTypeOverrides:t.transactionTypeOverrides||{}},this.config}async calculateGasMarkup(t){this.config||await this.loadConfig();let r=this.config.globalDefaultMarkup;if(t.clientId&&this.config.clientOverrides[t.clientId]){let a=this.config.clientOverrides[t.clientId];if(a.expiresAt){let e=new Date(a.expiresAt);new Date<e&&(r=a.markup)}else r=a.markup}let i=this.config.transactionTypeOverrides[t.transactionType];i&&(r=i);let u=this.config.blockchainMultipliers[t.blockchain]||1;r=Math.round(r*u),r=Math.max(this.config.minMarkup,Math.min(this.config.maxMarkup,r));let g=t.gasReal*(r/100),h=t.gasReal+g,s=g;return{gasReal:t.gasReal,gasMarkupPercent:r,gasCharged:h,yourProfit:s}}async updateGlobalMarkup(t,r){t=Math.max(10,Math.min(100,t)),await f.update(X).set({globalDefaultMarkup:t,updatedAt:new Date,updatedBy:r}).where(Ge(X.id,\"default\")),this.config=null,await this.loadConfig()}async setClientMarkup(t,r,i,u,g){this.config||await this.loadConfig();let h=this.config.clientOverrides;h[t]={markup:Math.max(10,Math.min(100,r)),reason:i,expiresAt:g?.toISOString()},await f.update(X).set({clientOverrides:h,updatedAt:new Date,updatedBy:u}).where(Ge(X.id,\"default\")),this.config=null,await this.loadConfig()}async removeClientMarkup(t,r){this.config||await this.loadConfig();let i=this.config.clientOverrides;delete i[t],await f.update(X).set({clientOverrides:i,updatedAt:new Date,updatedBy:r}).where(Ge(X.id,\"default\")),this.config=null,await this.loadConfig()}getConfig(){return this.config}},Le=new Ee});var ke={};xe(ke,{CryptoGateway:()=>Ne,cryptoGateway:()=>Ht});import Lt from\"crypto\";import{eq as G,and as Wt}from\"drizzle-orm\";var Ne,Ht,Te=fe(()=>{\"use strict\";Oe();ge();V();D();Ne=class{async createVirtualAccount(t,r){return(await f.insert(_).values({tenantId:t,accountType:r,balances:JSON.stringify({})}).returning())[0]}async internalSwap(t){let r=await f.query.virtualAccounts.findFirst({where:G(_.id,t.fromAccountId)});if(!r)throw new Error(\"From account not found\");let i=JSON.parse(r.balances||\"{}\"),u=parseFloat(i[t.assetName]||\"0\");if(u<parseFloat(t.fromAmount))throw new Error(\"Insufficient balance\");let g=parseFloat(t.toAmount)*.005,h=parseFloat(t.toAmount)-g,s={...i};s[t.assetName]=(u-parseFloat(t.fromAmount)).toString(),await f.update(_).set({balances:JSON.stringify(s)}).where(G(_.id,t.fromAccountId));let a=await f.query.virtualAccounts.findFirst({where:G(_.id,t.toAccountId)}),e=JSON.parse(a?.balances||\"{}\");return e[t.assetName]=(parseFloat(e[t.assetName]||\"0\")+h).toString(),await f.update(_).set({balances:JSON.stringify(e)}).where(G(_.id,t.toAccountId)),{txId:(await f.insert(de).values({tenantId:t.tenantId,type:\"internal_swap\",scenario:t.scenario,fromAccountId:t.fromAccountId,toAccountId:t.toAccountId,assetType:\"crypto\",assetName:t.assetName,blockchain:t.blockchain,amount:t.toAmount,commissionAmount:g.toString(),commissionUsd:(g*45e3).toString(),status:\"completed\"}).returning())[0].id,status:\"completed\",fromAmount:t.fromAmount,toAmount:t.toAmount,commission:g.toFixed(8),netReceived:h.toFixed(8),executedAt:new Date().toISOString()}}async externalWithdraw(t){let r=await f.query.masterWallets.findFirst({where:Wt(G(z.assetName,t.assetName),G(z.blockchain,t.blockchain),G(z.scenario,t.scenario))});if(!r)throw new Error(`No master wallet found for ${t.assetName} on ${t.blockchain}`);let i=await B.estimateGas({blockchain:t.blockchain,assetType:t.assetName===r.smartContractAddress?\"token\":\"crypto\",amount:t.amount}),u=await Le.calculateGasMarkup({clientId:t.tenantId,blockchain:t.blockchain,transactionType:t.assetName===\"BTC\"?\"crypto_withdraw\":\"token_transfer\",gasReal:i.gasReal}),g=await f.query.virtualAccounts.findFirst({where:G(_.id,t.fromAccountId)}),h=JSON.parse(g?.balances||\"{}\"),s=parseFloat(h[t.assetName]||\"0\");if(s<parseFloat(t.amount))throw new Error(\"Insufficient balance\");h[t.assetName]=(s-parseFloat(t.amount)).toString(),await f.update(_).set({balances:JSON.stringify(h)}).where(G(_.id,t.fromAccountId));let a=`0x${Lt.randomBytes(32).toString(\"hex\")}`;return{txId:(await f.insert(de).values({tenantId:t.tenantId,type:\"external_withdraw\",scenario:t.scenario,toExternalAddress:t.toExternalAddress,assetType:\"crypto\",assetName:t.assetName,blockchain:t.blockchain,amount:t.amount,gasReal:u.gasReal.toString(),gasMarkupPercent:u.gasMarkupPercent,gasCharged:u.gasCharged.toString(),commissionAmount:u.yourProfit.toString(),status:\"pending\",txHash:a}).returning())[0].id,status:\"pending_confirmation\",txHash:a,amount:t.amount,gasReal:u.gasReal.toFixed(8),gasCharged:u.gasCharged.toFixed(8),yourProfit:u.yourProfit.toFixed(8),estimatedTime:\"12 seconds\"}}async assignMasterToClient(t,r,i){return await f.update(z).set({assignedToTenantId:r,gasMarkupPercentage:i}).where(G(z.id,t)),{success:!0,masterId:t,assignedTo:r,gasMarkup:i,assignedAt:new Date().toISOString()}}async getVirtualAccountBalance(t){let r=await f.query.virtualAccounts.findFirst({where:G(_.id,t)});if(!r)throw new Error(\"Account not found\");let i=JSON.parse(r.balances||\"{}\");return{accountId:t,balances:i,totalUsd:Object.entries(i).reduce((u,[g,h])=>{let s={ETH:2500,BTC:45e3,GOLD:500,SILVER:250};return u+parseFloat(h)*(s[g]||0)},0)}}},Ht=new Ne});import Ce from\"express\";import{z as w}from\"zod\";D();V();import{eq as A,and as Z,desc as ie,sql as De,gte as Nt,lte as Ct}from\"drizzle-orm\";var Ue=class{async getTenant(t){let[r]=await f.select().from(x).where(A(x.id,t));return r||void 0}async getTenantByApiKeyHash(t){let[r]=await f.select().from(x).where(A(x.apiKeyHash,t));return r||void 0}async getTenantByEmail(t){let[r]=await f.select().from(x).where(A(x.email,t));return r||void 0}async getAllTenants(){return f.select().from(x).orderBy(ie(x.createdAt))}async createTenant(t){let[r]=await f.insert(x).values(t).returning();return r}async updateTenant(t,r){let[i]=await f.update(x).set({...r,updatedAt:new Date}).where(A(x.id,t)).returning();return i||void 0}async deleteTenant(t){await f.update(x).set({status:\"deleted\",updatedAt:new Date}).where(A(x.id,t))}async getAddress(t){let[r]=await f.select().from(S).where(A(S.id,t));return r||void 0}async getAddressByAddress(t,r,i){let[u]=await f.select().from(S).where(Z(A(S.tenantId,t),A(S.chain,r),A(S.address,i)));return u||void 0}async getAddressesByTenant(t,r){let i=f.select().from(S).where(A(S.tenantId,t)),u=[A(S.tenantId,t)];return r?.chain&&u.push(A(S.chain,r.chain)),r?.status&&u.push(A(S.status,r.status)),f.select().from(S).where(Z(...u)).orderBy(ie(S.createdAt)).limit(r?.limit||50).offset(r?.offset||0)}async countAddressesByTenant(t){let[r]=await f.select({count:De`count(*)`}).from(S).where(Z(A(S.tenantId,t),A(S.status,\"active\")));return r?.count||0}async createAddress(t){let[r]=await f.insert(S).values(t).returning();return r}async updateAddress(t,r){let[i]=await f.update(S).set({...r,updatedAt:new Date}).where(A(S.id,t)).returning();return i||void 0}async archiveAddress(t){await f.update(S).set({status:\"archived\",deletedAt:new Date,updatedAt:new Date}).where(A(S.id,t))}async getTransaction(t){let[r]=await f.select().from(j).where(A(j.id,t));return r||void 0}async getTransactionByHash(t,r){let[i]=await f.select().from(j).where(Z(A(j.chain,t),A(j.txHash,r)));return i||void 0}async getTransactionsByTenant(t,r){let i=[A(j.tenantId,t)];return r?.chain&&i.push(A(j.chain,r.chain)),r?.status&&i.push(A(j.status,r.status)),f.select().from(j).where(Z(...i)).orderBy(ie(j.createdAt)).limit(r?.limit||50).offset(r?.offset||0)}async createTransaction(t){let[r]=await f.insert(j).values(t).returning();return r}async updateTransaction(t,r){let[i]=await f.update(j).set(r).where(A(j.id,t)).returning();return i||void 0}async getWebhook(t){let[r]=await f.select().from(K).where(A(K.id,t));return r||void 0}async getWebhooksByTenant(t){return f.select().from(K).where(A(K.tenantId,t)).orderBy(ie(K.createdAt))}async countWebhooksByTenant(t){let[r]=await f.select({count:De`count(*)`}).from(K).where(Z(A(K.tenantId,t),A(K.active,!0)));return r?.count||0}async createWebhook(t){let[r]=await f.insert(K).values(t).returning();return r}async updateWebhook(t,r){let[i]=await f.update(K).set(r).where(A(K.id,t)).returning();return i||void 0}async deleteWebhook(t){await f.delete(K).where(A(K.id,t))}async getVirtualAccount(t){let[r]=await f.select().from(_).where(A(_.id,t));return r||void 0}async getVirtualAccountsByTenant(t){return f.select().from(_).where(A(_.tenantId,t)).orderBy(ie(_.createdAt))}async countVirtualAccountsByTenant(t){let[r]=await f.select({count:De`count(*)`}).from(_).where(Z(A(_.tenantId,t),A(_.status,\"active\")));return r?.count||0}async createVirtualAccount(t){let[r]=await f.insert(_).values(t).returning();return r}async updateVirtualAccount(t,r){let[i]=await f.update(_).set(r).where(A(_.id,t)).returning();return i||void 0}async recordApiUsage(t){let[r]=await f.insert(W).values(t).returning();return r}async getApiUsageByTenant(t,r,i){return f.select().from(W).where(Z(A(W.tenantId,t),Nt(W.timestamp,r),Ct(W.timestamp,i))).orderBy(ie(W.timestamp))}async getApiUsageStats(t,r,i){let u=await this.getApiUsageByTenant(t,r,i),g={},h={},s=0,a=0;for(let e of u)s+=e.units,a+=e.credits,g[e.endpoint]=(g[e.endpoint]||0)+1,e.chain&&(h[e.chain]=(h[e.chain]||0)+1);return{totalRequests:u.length,totalUnits:s,totalCredits:a,byEndpoint:g,byChain:h}}async getBillingAggregation(t,r){let[i]=await f.select().from(Q).where(Z(A(Q.tenantId,t),A(Q.period,r)));return i||void 0}async upsertBillingAggregation(t){let r=await this.getBillingAggregation(t.tenantId,t.period);if(r){let[i]=await f.update(Q).set(t).where(A(Q.id,r.id)).returning();return i}else{let[i]=await f.insert(Q).values(t).returning();return i}}async createAuditLog(t){let[r]=await f.insert(te).values(t).returning();return r}async getAuditLogsByTenant(t,r=100){return f.select().from(te).where(A(te.tenantId,t)).orderBy(ie(te.timestamp)).limit(r)}},p=new Ue;Oe();import ce from\"crypto\";D();var Ze=process.env.ADMIN_API_KEY;function Ie(){let n=`tatum_${ce.randomBytes(28).toString(\"hex\")}`,t=n.substring(0,16),r=tt(n);return{key:n,prefix:t,hash:r}}function tt(n){return ce.createHash(\"sha256\").update(n).digest(\"hex\")}function we(){return ce.randomBytes(32).toString(\"hex\")}function st(){return`req_${ce.randomBytes(16).toString(\"hex\")}`}async function b(n,t,r){n.requestId=st(),t.setHeader(\"X-Request-ID\",n.requestId);let i=n.headers[\"x-api-key\"];if(!i)return t.status(401).json({success:!1,error:\"Missing API key\",requestId:n.requestId});let u=tt(i),g=await p.getTenantByApiKeyHash(u);if(!g)return t.status(401).json({success:!1,error:\"Invalid API key\",requestId:n.requestId});if(g.status!==\"active\")return t.status(403).json({success:!1,error:`Account is ${g.status}`,requestId:n.requestId});n.tenant=g,r()}function $(n,t,r){n.requestId=st(),t.setHeader(\"X-Request-ID\",n.requestId);let i=n.headers[\"x-admin-key\"];if(!Ze)return t.status(503).json({success:!1,error:\"Admin API not configured\",requestId:n.requestId});if(!i)return t.status(401).json({success:!1,error:\"Missing admin API key\",requestId:n.requestId});let u=ce.createHash(\"sha256\").update(i).digest(\"hex\"),g=ce.createHash(\"sha256\").update(Ze).digest(\"hex\");if(!ce.timingSafeEqual(Buffer.from(u),Buffer.from(g)))return t.status(401).json({success:!1,error:\"Invalid admin API key\",requestId:n.requestId});n.isAdmin=!0,r()}var et=new Map;function k(n,t,r){if(!n.tenant)return r();let i=n.tenant.id,u=Date.now(),g=1e3,h=et.get(i);(!h||h.resetAt<u)&&(h={count:0,resetAt:u+g},et.set(i,h)),h.count++;let s=n.tenant.rateLimit,a=Math.max(0,s-h.count);if(t.setHeader(\"X-RateLimit-Limit\",s),t.setHeader(\"X-RateLimit-Remaining\",a),t.setHeader(\"X-RateLimit-Reset\",Math.ceil(h.resetAt/1e3)),h.count>s)return t.status(429).json({success:!1,error:\"Rate limit exceeded\",requestId:n.requestId,retryAfter:Math.ceil((h.resetAt-u)/1e3)});r()}function at(n){return(t,r,i)=>{if(!t.tenant)return r.status(401).json({success:!1,error:\"Authentication required\",requestId:t.requestId});let u=H[t.tenant.tier];if(!u)return r.status(403).json({success:!1,error:\"Invalid tier configuration\",requestId:t.requestId});if(n===\"kms\"&&!u.kmsAllowed)return r.status(403).json({success:!1,error:\"KMS is not available in your tier. Upgrade to Scale or Enterprise.\",requestId:t.requestId,upgrade:!0});if(n===\"archival\"&&!u.archivalAccess)return r.status(403).json({success:!1,error:\"Archival access is not available in your tier. Upgrade to Enterprise.\",requestId:t.requestId,upgrade:!0});i()}}function Ae(n,t,r){if(!n.tenant)return r();let i=n.params.chain||n.body?.chain;if(!i)return r();let g=H[n.tenant.tier]?.chains||n.tenant.allowedChains;if(!g.includes(i))return t.status(403).json({success:!1,error:`Chain '${i}' is not available in your tier`,allowedChains:g,requestId:n.requestId,upgrade:!0});r()}D();async function nt(){if(!process.env.SEED_DEMO_DATA)return null;console.log(\"Checking for demo tenant...\");let n=await p.getTenantByEmail(\"demo@tatum-gateway.io\");if(n)return console.log(\"Demo tenant already exists\"),n;console.log(\"Creating demo tenant...\");let{prefix:t,hash:r}=Ie(),i=H.scale,u=await p.createTenant({name:\"Demo Account\",email:\"demo@tatum-gateway.io\",tier:\"scale\",status:\"active\",apiKeyPrefix:t,apiKeyHash:r,hmacSecret:we(),allowedChains:i.chains,maxAddresses:i.maxAddresses,maxWebhooks:i.maxWebhooks,maxVirtualAccounts:i.maxVirtualAccounts,rateLimit:i.rateLimit,monthlyQuota:i.monthlyQuota,companyName:\"Tatum Gateway Demo\",website:\"https://tatum.io\"});console.log(\"Demo tenant created:\",u.id),await p.createAuditLog({tenantId:u.id,action:\"tenant.created\",resource:\"tenant\",resourceId:u.id,changes:{tier:\"scale\",source:\"seed\"}});for(let g=0;g<10;g++)await p.recordApiUsage({tenantId:u.id,endpoint:`/api/v1/${[\"addresses\",\"balances\",\"tokens\",\"transactions\"][g%4]}`,method:[\"GET\",\"POST\"][g%2],chain:[\"ethereum\",\"bitcoin\",\"solana\",\"polygon\"][g%4],action:[\"balance_query\",\"address_create\",\"token_balance\",\"tx_history\"][g%4],units:[.5,1,1,2][g%4],credits:[5e-4,.001,.001,.002][g%4],statusCode:200,requestId:`demo_${g}`,responseTimeMs:50+Math.floor(Math.random()*100)});return console.log(\"Demo usage data seeded!\"),u}D();function O(n){return async(t,r,i)=>{if(!t.tenant)return i();let u=le[n];t.metered={action:n,units:u.units,credits:u.cost};let g=r.json.bind(r);r.json=h=>{let s=Date.now();return p.recordApiUsage({tenantId:t.tenant.id,endpoint:t.path,method:t.method,chain:t.params.chain||t.body?.chain||null,action:n,units:u.units,credits:u.cost,statusCode:r.statusCode,requestId:t.requestId,responseTimeMs:Date.now()-s,metadata:{userAgent:t.headers[\"user-agent\"],ip:t.ip}}).catch(console.error),h&&typeof h==\"object\"&&(h.meta={...h.meta,requestId:t.requestId,timestamp:new Date().toISOString(),metered:{action:n,units:u.units,credits:u.cost}}),g(h)},i()}}async function be(n){let t=new Date,r=new Date(t.getFullYear(),t.getMonth(),1),i=await p.getApiUsageStats(n,r,t);return{totalRequests:i.totalRequests,totalUnits:i.totalUnits,totalCredits:i.totalCredits,costUsd:i.totalCredits}}async function Se(n,t){if(t===-1)return{allowed:!0,used:0,remaining:-1,percentUsed:0};let r=await be(n),i=Math.floor(r.totalUnits),u=t-i,g=i/t*100;return{allowed:u>0,used:i,remaining:Math.max(0,u),percentUsed:Math.min(100,g)}}function ae(n,t,r){if(!n.tenant)return r();Se(n.tenant.id,n.tenant.monthlyQuota).then(i=>{if(t.setHeader(\"X-Quota-Used\",i.used),t.setHeader(\"X-Quota-Remaining\",i.remaining),t.setHeader(\"X-Quota-Percent\",Math.round(i.percentUsed)),!i.allowed)return t.status(429).json({success:!1,error:\"Monthly quota exceeded\",requestId:n.requestId,quota:{used:i.used,limit:n.tenant.monthlyQuota,percentUsed:i.percentUsed},upgrade:!0});r()}).catch(()=>r())}D();import Ft from\"crypto\";var $t=1e5,Ot=32,qt=\"sha256\",ne=null,pe=class n{masterSecret;version;createdAt;static SALT_PREFIXES={privateKey:\"kms:private_key:v1\",masterWallet:\"kms:master_wallet:v1\",hmacSecret:\"kms:hmac_secret:v1\",apiKeyDerivation:\"kms:api_key:v1\",sessionEncryption:\"kms:session:v1\"};constructor(t,r=1){if(!t||t.length<32)throw new Error(\"Master secret must be at least 32 bytes (use: openssl rand -hex 16)\");this.masterSecret=t,this.version=r,this.createdAt=new Date,t.length<64&&console.warn(\"\\u26A0\\uFE0F  WARNING: Master KMS secret is less than 64 bytes. Consider using: openssl rand -hex 32\")}static initialize(t){let r=t||process.env.MASTER_KMS_SECRET||process.env.SESSION_SECRET;if(!r)throw new Error(\"MASTER_KMS_SECRET environment variable not set. Generate with: openssl rand -hex 32\");return ne||(ne=new n(r),console.log(\"\\u2705 KMS initialized with master secret\"),ne)}static getInstance(){return ne||(ne=n.initialize()),ne}deriveKey(t,r=\"\"){let i=n.SALT_PREFIXES[t];if(!i)throw new Error(`Unknown key type: ${t}`);let u=Buffer.from(`${i}:${r}`);return{key:Ft.pbkdf2Sync(this.masterSecret,u,$t,Ot,qt),version:this.version,keyType:t}}derivePrivateKeyEncryptionKey(t){return this.deriveKey(\"privateKey\",t).key}deriveMasterWalletKey(t){return this.deriveKey(\"masterWallet\",t).key}deriveHmacKey(t){return this.deriveKey(\"hmacSecret\",t).key}deriveSessionEncryptionKey(t){return this.deriveKey(\"sessionEncryption\",t).key}getConfig(){return{masterSecret:\"[REDACTED]\",version:this.version,createdAt:this.createdAt}}rotate(t){let r=new n(t,this.version+1);return ne=r,console.log(`\\u2705 KMS rotated to version ${r.version}`),r}static test(){try{let t=n.getInstance(),r=t.deriveKey(\"privateKey\",\"test-wallet-1\"),i=t.deriveKey(\"privateKey\",\"test-wallet-1\");if(r.key.toString(\"hex\")!==i.key.toString(\"hex\"))throw new Error(\"KMS key derivation not deterministic\");let u=t.deriveKey(\"privateKey\",\"test-wallet-2\");if(r.key.toString(\"hex\")===u.key.toString(\"hex\"))throw new Error(\"KMS key derivation collision detected\");return console.log(\"\\u2705 KMS self-test passed\"),!0}catch(t){return console.error(\"\\u274C KMS self-test failed:\",t),!1}}};try{pe.initialize()}catch(n){console.warn(\"\\u26A0\\uFE0F  KMS initialization warning:\",n)}import qe from\"crypto\";var Pe=\"aes-256-gcm\",Re=32,Gt=16;function rt(n,t,r){if(t.length!==Re)throw new Error(`Encryption key must be ${Re} bytes`);let i=qe.randomBytes(Gt),u=qe.createCipheriv(Pe,t,i);r&&u.setAAD(Buffer.from(r));let g=Buffer.concat([u.update(n,\"utf8\"),u.final()]),h=u.getAuthTag();return{ciphertext:g.toString(\"hex\"),iv:i.toString(\"hex\"),authTag:h.toString(\"hex\"),algorithm:Pe}}function ot(n,t,r){if(t.length!==Re)throw new Error(`Encryption key must be ${Re} bytes`);if(n.algorithm!==Pe)throw new Error(`Unsupported algorithm: ${n.algorithm}`);let i=Buffer.from(n.iv,\"hex\"),u=Buffer.from(n.ciphertext,\"hex\"),g=Buffer.from(n.authTag,\"hex\"),h=qe.createDecipheriv(Pe,t,i);r&&h.setAAD(Buffer.from(r)),h.setAuthTag(g);try{return Buffer.concat([h.update(u),h.final()]).toString(\"utf8\")}catch{throw new Error(\"Decryption failed - data may be corrupted or tampered with\")}}import{sql as Vt}from\"drizzle-orm\";import{webcrypto as it}from\"crypto\";var Yt=w.object({name:w.string().min(2),email:w.string().email(),tier:w.enum([\"starter\",\"scale\",\"enterprise\"]).default(\"starter\"),companyName:w.string().optional(),website:w.string().url().optional(),billingEmail:w.string().email().optional()}),zt=w.object({chain:w.string(),label:w.string().optional(),tags:w.array(w.string()).optional(),webhookUrl:w.string().url().optional()}),Xt=w.object({url:w.string().url(),events:w.array(w.enum(Be)).min(1)});async function ct(n,t){nt().catch(console.error),t.get(\"/\",(s,a)=>{a.json({name:\"Tatum API Gateway\",version:\"1.0.0\",description:\"Enterprise-grade blockchain API gateway supporting 130+ blockchains\",status:\"running\",documentation:\"GET /api/docs | GET /api/docs/model | GET /api/docs/examples\",quickStart:\"1. Get API key from admin | 2. Add 'x-api-key: YOUR_KEY' header | 3. POST /api/tenants to register\",endpoints:{health:\"GET /api/health\",pricing:\"GET /api/pricing\",chains:\"GET /api/chains\",tenants:\"GET /api/tenants | POST /api/tenants\",addresses:\"GET /api/v1/addresses | POST /api/v1/addresses\",transactions:\"GET /api/v1/transactions\",webhooks:\"POST /api/v1/webhooks | GET /api/v1/webhooks\",gateway:\"POST /api/v1/gateway/virtual-accounts | GET /api/v1/gateway/virtual-accounts | POST /api/v1/gateway/swap | POST /api/v1/gateway/withdraw\",admin:\"GET /api/admin/gas-settings | PUT /api/admin/gas-settings/global | GET /api/admin/revenue | GET /api/admin/transactions\",rwa:\"POST /api/v1/rwa/tokens | GET /api/v1/rwa/tokens | POST /api/v1/rwa/tokens/:id/transfer\"},businessModel:{type:\"Dual-Panel API Gateway (100% Admin Revenue)\",panels:{cryptoPanel:{description:\"Master wallet control with virtual accounts system\",revenueStreams:{internalSwaps:\"0.5% commission (zero gas fees)\",gasMarkup:\"40% configurable markup on gas fees\",setupFees:\"$500 per RWA client\"},annualRevenue:\"$204K (Y1) \\u2192 $1.02M (Y2) \\u2192 $2.04M (Y3)\"},rwaPanel:{description:\"Real-world asset tokenization infrastructure\",revenueStreams:{setupFees:\"$500 per token (one-time)\",annualFees:\"$200 per token per year\",tradingCommissions:\"0.5% of all trading volume (100% to admin)\"},annualRevenue:\"$654K (Y1) \\u2192 $8.07M (Y2) \\u2192 $60.21M (Y3)\"}},profitMargins:\"82.5% (Y1) \\u2192 91.2% (Y2) \\u2192 96.8% (Y3)\",totalProjections:{year1:\"$858K\",year2:\"$9.09M\",year3:\"$62.25M\"}},auth:{type:\"API Key + HMAC\",method:\"x-api-key header (Tatum v3 recommended)\",example:\"curl -H 'x-api-key: YOUR_API_KEY' https://api.example.com/api/v1/...\",documentation:\"https://docs.tatum.io/docs/authentication\"},rateLimit:\"Per tier: Starter 10/sec, Scale 100/sec, Enterprise 1000/sec\",docs:\"https://api.tatum.io/docs\",github:\"https://github.com/MasterFital/tatum-api-gateway\"})}),t.get(\"/api/docs/model\",(s,a)=>{a.json({title:\"Tatum API Gateway - Business Model\",introduction:\"Dual-panel architecture generating 100% admin revenue via Crypto trading and RWA tokenization\",panels:{crypto:{name:\"CRYPTO Panel (100% Your Revenue)\",description:\"You control master wallets (BTC, ETH, SOL, MATIC). Clients trade via virtual accounts.\",how_it_works:{step1:\"Admin creates master wallets via POST /api/admin/master-wallets\",step2:\"Clients create virtual accounts via POST /api/v1/gateway/virtual-accounts\",step3:\"Clients can: swap internally (0.5% fee to you) or withdraw externally (40% gas markup)\",step4:\"Admin tracks all revenue via GET /api/admin/revenue\"},revenue_streams:{internal_swaps:{description:\"Client trades BTC \\u2192 ETH\",fee:\"0.5% of swap amount\",gas_cost:\"Zero (internal)\",admin_profit:\"100% of fee\",example:\"Client swaps 1 ETH \\u2192 0.02 BTC | Commission: 0.0001 BTC (100% to admin)\"},gas_markup:{description:\"Client withdraws crypto to external wallet\",fee:\"40% markup on actual gas cost\",example:\"Bitcoin gas: $3 real | You charge: $4.20 | Your profit: $1.20 (40%)\"}},projections:{year1:{volume:\"1M USD/month average\",monthly_swaps:\"5K \\xD7 0.5% = $25K\",monthly_gas:\"10K withdrawals \\xD7 $3 \\xD7 40% = $12K\",total_monthly:\"$17K\",annual:\"$204K\"},year2:{volume:\"5M USD/month average\",annual:\"$1.02M\"},year3:{volume:\"10M USD/month average\",annual:\"$2.04M\"}}},rwa:{name:\"RWA Panel (100% Your Revenue + Fees)\",description:\"Clients issue tokens. You provide infrastructure. You keep 100% of fees and trading commissions.\",how_it_works:{step1:\"Client requests token creation: POST /api/v1/rwa/tokens\",step2:\"You charge $500 setup fee + deploy smart contract\",step3:\"Token goes live. Clients trade internally (0.5% fee to you)\",step4:\"Annual $200 maintenance fee per token\",step5:\"All external withdrawals have 40% gas markup (to you)\",step6:\"Track revenue via GET /api/admin/rwa-revenue\"},revenue_streams:{setup_fees:{description:\"One-time fee per token launched\",amount:\"$500\",frequency:\"Per token\"},annual_fees:{description:\"Yearly maintenance per active token\",amount:\"$200\",frequency:\"Per token per year\"},trading_commissions:{description:\"0.5% of all token trading volume (100% to admin)\",percentage:\"0.5%\",example:\"Token volume: $100K/month | Your commission: $500/month = $6K/year per token\"},gas_markup:{description:\"40% markup on gas fees for external withdrawals\",percentage:\"40%\"}},client_benefits:{benefit1:\"Tokenization infrastructure (your cost: ~$0.10 per token)\",benefit2:\"Ready-to-use marketplace\",benefit3:\"Instant liquidity (day 1 traders)\",benefit4:\"Security & compliance handled by you\",client_pays:\"$500 setup + $200/year only\"},projections:{year1:{tokens:\"20 new tokens\",setup_fees:\"20 \\xD7 $500 = $10K\",annual_fees:\"20 \\xD7 $200 = $4K\",trading_commissions:\"0.5% of ~$100M volume = $500K\",total:\"$514K\"},year2:{tokens:\"100 total tokens\",setup_fees:\"100 \\xD7 $500 = $50K\",annual_fees:\"100 \\xD7 $200 = $20K\",trading_commissions:\"0.5% of ~$1.6B volume = $8M\",total:\"$8.07M\"},year3:{tokens:\"300 total tokens\",setup_fees:\"300 \\xD7 $500 = $150K\",annual_fees:\"300 \\xD7 $200 = $60K\",trading_commissions:\"0.5% of ~$12B volume = $60M\",total:\"$60.21M\"}}}},revenue_summary:{title:\"Combined Revenue (Crypto + RWA)\",year1:{crypto:\"$204K\",rwa:\"$654K\",total:\"$858K\",margin:\"82.5%\"},year2:{crypto:\"$1.02M\",rwa:\"$8.07M\",total:\"$9.09M\",margin:\"91.2%\"},year3:{crypto:\"$2.04M\",rwa:\"$60.21M\",total:\"$62.25M\",margin:\"96.8%\"}},key_points:[\"100% of all revenues go to admin (you)\",\"Clients get access to infrastructure, not revenue sharing\",\"Setup fees are immediate revenue\",\"Trading commissions scale infinitely with volume\",\"Gas markup is pure profit (minimal infrastructure cost)\",\"Zero customer acquisition cost (clients bring themselves)\"]})}),t.get(\"/api/docs/examples\",(s,a)=>{a.json({title:\"Tatum API Gateway - Usage Examples\",authentication:{description:\"All requests require x-api-key header\",example:\"curl -H 'x-api-key: YOUR_API_KEY' https://api.example.com/api/v1/...\",headers:{\"x-api-key\":\"Your API key from admin\",\"Content-Type\":\"application/json\"}},crypto_examples:{title:\"CRYPTO Panel Examples\",create_virtual_account:{description:\"Client creates virtual account to hold crypto\",endpoint:\"POST /api/v1/gateway/virtual-accounts\",request:{accountType:\"individual\"},response:{success:!0,virtualAccount:{id:\"va-123\",tenantId:\"client-1\",accountType:\"individual\",balances:{BTC:\"0\",ETH:\"0\",SOL:\"0\"},status:\"active\"}}},internal_swap_0_5_percent:{description:\"Client swaps BTC to ETH (0.5% commission to admin)\",endpoint:\"POST /api/v1/gateway/swap\",request:{fromAccountId:\"va-123\",fromAsset:\"BTC\",toAsset:\"ETH\",amount:\"1.0\"},response:{success:!0,swap:{id:\"swap-456\",fromAsset:\"BTC\",toAsset:\"ETH\",amount:\"1.0\",commission:\"0.005 BTC (0.5% to admin)\",status:\"completed\"},note:\"Zero gas fees, 0.5% commission applied\"}},external_withdraw_40_percent_markup:{description:\"Client withdraws to external wallet (40% gas markup to admin)\",endpoint:\"POST /api/v1/gateway/withdraw\",request:{fromAccountId:\"va-123\",asset:\"ETH\",amount:\"1.0\",toAddress:\"0x1234567890abcdef...\"},response:{success:!0,withdrawal:{id:\"withdraw-789\",asset:\"ETH\",amount:\"1.0\",toAddress:\"0x1234567890abcdef...\",gasReal:\"3 USD\",gasCharged:\"4.20 USD (40% markup)\",adminProfit:\"1.20 USD\",status:\"pending\",txHash:\"0xabcd...\"}}},view_transaction_history:{description:\"Client views their transaction history\",endpoint:\"GET /api/v1/transactions?limit=50\",response:{success:!0,transactions:[{id:\"swap-456\",type:\"internal_swap\",asset:\"BTC\",amount:\"1.0\",commission:\"0.005\",status:\"completed\",createdAt:\"2024-11-30T10:00:00Z\"}],pagination:{total:42,limit:50,offset:0}}}},rwa_examples:{title:\"RWA Panel Examples\",create_rwa_token_500_setup:{description:\"Client creates token (pays $500 setup fee to admin)\",endpoint:\"POST /api/v1/rwa/tokens\",request:{assetName:\"Real Estate Fund\",symbol:\"REF\",blockchain:\"ethereum\",decimals:18,totalSupply:\"1000000\",issuerName:\"RE Properties Inc\",description:\"Tokenized real estate investment\"},response:{success:!0,token:{id:\"token-ref-1\",assetName:\"Real Estate Fund\",symbol:\"REF\",blockchain:\"ethereum\",totalSupply:\"1000000\",smartContractAddress:\"0x...\",status:\"created\"},pricing:{setupFee:\"$500 (one-time) - PAID TO ADMIN\",annualFee:\"$200/year - PAID TO ADMIN\",tradingCommission:\"0.5% on all trades - 100% TO ADMIN\"}}},list_rwa_tokens:{description:\"Client views their tokens and trading volume\",endpoint:\"GET /api/v1/rwa/tokens\",response:{success:!0,tokens:[{id:\"token-ref-1\",assetName:\"Real Estate Fund\",symbol:\"REF\",blockchain:\"ethereum\",totalSupply:\"1000000\",status:\"active\",setupFee:500,annualFee:200,tradingVolume:\"250000 USD\",tradingCommission:\"1250 USD (0.5% to admin)\"}],summary:{totalTokens:1,totalTradingCommissions:\"1250 USD (100% to admin)\",setupFeesCollected:\"500 USD (100% to admin)\"}}},rwa_token_transfer_0_5_percent:{description:\"Token holder trades REF token (0.5% commission to admin)\",endpoint:\"POST /api/v1/rwa/tokens/token-ref-1/transfer\",request:{toAddress:\"0xabcd...\",amount:\"100\"},response:{success:!0,transfer:{id:\"transfer-123\",tokenId:\"token-ref-1\",amount:\"100 REF\",toAddress:\"0xabcd...\",commission:\"0.5 REF (0.5% to admin)\",status:\"completed\",txHash:\"0x...\"},note:\"0.5% trading commission applied and collected by admin\"}}},admin_examples:{title:\"Admin Dashboard Examples\",view_revenue:{description:\"Admin views total revenue (swaps + gas markup)\",endpoint:\"GET /api/admin/revenue\",response:{success:!0,cryptoRevenue:{totalSwapCommissions:\"1245.67 USD\",totalGasMarkupRevenue:\"3456.78 USD\",totalVolume:\"249000 USD\",revenueByBlockchain:{ethereum:\"2345.67\",polygon:\"1234.56\",bitcoin:\"3456.78\"}}}},view_rwa_revenue:{description:\"Admin views RWA revenue (setup + annual + trading commissions)\",endpoint:\"GET /api/admin/rwa-revenue\",response:{success:!0,rwaRevenue:{setupFees:{count:12,total:\"6000 USD\"},annualFees:{activeClients:12,total:\"2400 USD\"},tradingCommissions:{thisMonth:\"12500 USD\",thisYear:\"125000 USD\",rate:\"0.5% of all trading volume\"},totalMonthlyRevenue:\"15000 USD\"}}}},security:{authentication:\"x-api-key header (Tatum v3 recommended)\",encryption:\"All private keys encrypted with AES-256\",audit:\"All transactions logged with full audit trail\",rateLimit:\"Starter 10/sec, Scale 100/sec, Enterprise 1000/sec\",documentation:\"https://docs.tatum.io/docs/authentication\"}})}),t.get(\"/api/test-tatum\",async(s,a)=>{try{let e=await B.healthCheck(),o={success:e.success,message:e.success?\"\\u2705 Connected to Tatum API successfully\":\"\\u274C Failed to connect to Tatum API\",tatumApiUrl:process.env.TATUM_API_URL||\"https://api.tatum.io\",apiKeyConfigured:!!process.env.TATUM_API_KEY,apiKeyLength:process.env.TATUM_API_KEY?.length||0,timestamp:new Date().toISOString()};e.success&&e.data&&(o.blockchainInfo={chain:e.data.chain,blocks:e.data.blocks,mempool:e.data.mempool}),e.error&&(o.error=e.error,o.statusCode=e.statusCode),a.json({success:e.success,test:\"Tatum API Connection Test\",status:o,instructions:{production:\"Configure TATUM_API_KEY environment variable with your Tatum production API key\",documentation:\"https://docs.tatum.io/docs/authentication\",getApiKey:\"https://dashboard.tatum.io\"},requestId:s.requestId})}catch(e){a.status(500).json({success:!1,test:\"Tatum API Connection Test\",error:e.message,message:\"Failed to test Tatum connection\",instructions:{checkApiKey:\"Ensure TATUM_API_KEY is set in environment variables\",checkUrl:\"Verify TATUM_API_URL is correct\",documentation:\"https://docs.tatum.io/docs/authentication\"},requestId:s.requestId})}}),t.get(\"/api/docs\",(s,a)=>{a.json({title:\"Tatum API Gateway - Complete Documentation\",message:\"For full details, visit these documentation endpoints:\",available_docs:{business_model:\"GET /api/docs/model - Full explanation of revenue streams\",examples:\"GET /api/docs/examples - Usage examples for Crypto and RWA\",tatum_test:\"GET /api/test-tatum - Test connection to Tatum API (production check)\",this_endpoint:\"GET /api/docs - This page\",api_root:\"GET / - API info and business model overview\"},quick_endpoints:{\"Crypto Panel\":[\"POST /api/v1/gateway/virtual-accounts - Create virtual account\",\"POST /api/v1/gateway/swap - Internal swap (0.5% commission)\",\"POST /api/v1/gateway/withdraw - External withdraw (40% gas markup)\",\"GET /api/v1/transactions - Transaction history\"],\"RWA Panel\":[\"POST /api/v1/rwa/tokens - Create token ($500 setup fee)\",\"GET /api/v1/rwa/tokens - List tokens\",\"POST /api/v1/rwa/tokens/:id/transfer - Trade token (0.5% commission)\"],Admin:[\"GET /api/admin/revenue - Crypto revenue dashboard\",\"GET /api/admin/rwa-revenue - RWA revenue dashboard\",\"GET /api/admin/master-wallets - List master wallets\",\"POST /api/admin/master-wallets - Create master wallet\"]},authentication:{method:\"x-api-key header\",example:\"Authorization: x-api-key YOUR_API_KEY\",documentation:\"https://docs.tatum.io/docs/authentication\"},support:{github:\"https://github.com/MasterFital/tatum-api-gateway\",tatum_docs:\"https://api.tatum.io/docs\",api_reference:\"https://docs.tatum.io/reference/welcome-to-the-tatum-api-reference\"}})}),t.get(\"/api/health\",async(s,a)=>{let e=await B.healthCheck();a.json({success:!0,status:\"healthy\",services:{api:\"healthy\",database:\"healthy\",tatum:e.success?\"healthy\":\"degraded\"},timestamp:new Date().toISOString()})}),t.get(\"/api/pricing\",(s,a)=>{a.json({success:!0,pricing:le,tiers:Object.entries(H).map(([e,o])=>({id:e,...o,pricing:{starter:{monthly:0,included:1e4},scale:{monthly:99,included:1e5},enterprise:{monthly:\"custom\",included:\"unlimited\"}}[e]}))})}),t.get(\"/api/chains\",(s,a)=>{a.json({success:!0,chains:me,total:me.length})}),t.post(\"/api/tenants\",async(s,a)=>{try{let e=Yt.parse(s.body);if(await p.getTenantByEmail(e.email))return a.status(409).json({success:!1,error:\"Email already registered\"});let{key:c,prefix:d,hash:y}=Ie(),m=H[e.tier],I=await p.createTenant({name:e.name,email:e.email,tier:e.tier,status:\"active\",apiKeyPrefix:d,apiKeyHash:y,hmacSecret:we(),allowedChains:[...m.chains],maxAddresses:m.maxAddresses,maxWebhooks:m.maxWebhooks,maxVirtualAccounts:m.maxVirtualAccounts,rateLimit:m.rateLimit,monthlyQuota:m.monthlyQuota,companyName:e.companyName,website:e.website,billingEmail:e.billingEmail});await p.createAuditLog({tenantId:I.id,action:\"tenant.created\",resource:\"tenant\",resourceId:I.id,changes:{tier:e.tier}}),a.status(201).json({success:!0,tenant:{id:I.id,name:I.name,email:I.email,tier:I.tier,status:I.status,apiKey:c,hmacSecret:I.hmacSecret,limits:{chains:I.allowedChains,maxAddresses:I.maxAddresses,maxWebhooks:I.maxWebhooks,maxVirtualAccounts:I.maxVirtualAccounts,rateLimit:I.rateLimit,monthlyQuota:I.monthlyQuota},createdAt:I.createdAt},warning:\"Save your API key now. It cannot be retrieved again.\"})}catch(e){if(e.name===\"ZodError\")return a.status(400).json({success:!1,error:\"Validation error\",details:e.errors});console.error(\"Create tenant error:\",e),a.status(500).json({success:!1,error:\"Internal server error\"})}}),t.get(\"/api/tenants\",async(s,a)=>{try{let e=await p.getAllTenants(),o=await Promise.all(e.map(async c=>{let d=await be(c.id),y=await p.countAddressesByTenant(c.id);return{id:c.id,name:c.name,email:c.email,tier:c.tier,status:c.status,companyName:c.companyName,addressCount:y,usage:{requests:d.totalRequests,units:Math.floor(d.totalUnits),costUsd:d.costUsd.toFixed(4)},createdAt:c.createdAt}}));a.json({success:!0,tenants:o})}catch(e){console.error(\"Get tenants error:\",e),a.status(500).json({success:!1,error:\"Internal server error\"})}}),t.get(\"/api/tenants/:id\",b,async(s,a)=>{try{let e=await p.getTenant(s.params.id);if(!e)return a.status(404).json({success:!1,error:\"Tenant not found\"});let o=await be(e.id),c=await Se(e.id,e.monthlyQuota),d=await p.countAddressesByTenant(e.id),y=await p.countWebhooksByTenant(e.id),m=await p.countVirtualAccountsByTenant(e.id);a.json({success:!0,tenant:{id:e.id,name:e.name,email:e.email,tier:e.tier,status:e.status,companyName:e.companyName,website:e.website,billingEmail:e.billingEmail,apiKeyPrefix:e.apiKeyPrefix,limits:{chains:e.allowedChains,maxAddresses:e.maxAddresses,maxWebhooks:e.maxWebhooks,maxVirtualAccounts:e.maxVirtualAccounts,rateLimit:e.rateLimit,monthlyQuota:e.monthlyQuota},usage:{addresses:d,webhooks:y,virtualAccounts:m,requests:o.totalRequests,units:Math.floor(o.totalUnits),costUsd:o.costUsd.toFixed(4),quota:{used:c.used,remaining:c.remaining,percentUsed:Math.round(c.percentUsed)}},createdAt:e.createdAt,updatedAt:e.updatedAt}})}catch(e){console.error(\"Get tenant error:\",e),a.status(500).json({success:!1,error:\"Internal server error\"})}}),t.patch(\"/api/tenants/:id\",b,async(s,a)=>{try{if(s.tenant.id!==s.params.id)return a.status(403).json({success:!1,error:\"You can only update your own account\",requestId:s.requestId});let e=s.body,o=[\"name\",\"companyName\",\"website\",\"billingEmail\"],c={};for(let y of o)e[y]!==void 0&&(c[y]=e[y]);if(Object.keys(c).length===0)return a.status(400).json({success:!1,error:\"No valid fields to update\",requestId:s.requestId});let d=await p.updateTenant(s.params.id,c);if(!d)return a.status(404).json({success:!1,error:\"Tenant not found\"});await p.createAuditLog({tenantId:d.id,action:\"tenant.updated\",resource:\"tenant\",resourceId:d.id,changes:c,ipAddress:s.ip}),a.json({success:!0,tenant:d,requestId:s.requestId})}catch(e){console.error(\"Update tenant error:\",e),a.status(500).json({success:!1,error:\"Internal server error\"})}}),t.post(\"/api/tenants/:id/rotate-key\",b,async(s,a)=>{try{let e=await p.getTenant(s.params.id);if(!e)return a.status(404).json({success:!1,error:\"Tenant not found\"});if(s.tenant.id!==e.id)return a.status(403).json({success:!1,error:\"You can only rotate your own API key\",requestId:s.requestId});let{key:o,prefix:c,hash:d}=Ie();await p.updateTenant(e.id,{apiKeyPrefix:c,apiKeyHash:d}),await p.createAuditLog({tenantId:e.id,action:\"apikey.rotated\",resource:\"tenant\",resourceId:e.id,changes:{rotated:!0}}),a.json({success:!0,apiKey:o,warning:\"Save your new API key now. The old key is now invalid and cannot be recovered.\",requestId:s.requestId})}catch(e){console.error(\"Rotate API key error:\",e),a.status(500).json({success:!1,error:\"Internal server error\"})}}),t.patch(\"/api/admin/tenants/:id\",$,async(s,a)=>{try{let e=s.body;if(e.tier){let c=H[e.tier];c&&(e.allowedChains=c.chains,e.maxAddresses=c.maxAddresses,e.maxWebhooks=c.maxWebhooks,e.maxVirtualAccounts=c.maxVirtualAccounts,e.rateLimit=c.rateLimit,e.monthlyQuota=c.monthlyQuota)}let o=await p.updateTenant(s.params.id,e);if(!o)return a.status(404).json({success:!1,error:\"Tenant not found\"});await p.createAuditLog({tenantId:o.id,action:\"admin.tenant.updated\",resource:\"tenant\",resourceId:o.id,changes:e,ipAddress:s.ip}),a.json({success:!0,tenant:o,requestId:s.requestId})}catch(e){console.error(\"Admin update tenant error:\",e),a.status(500).json({success:!1,error:\"Internal server error\"})}}),t.post(\"/api/admin/tenants/:id/suspend\",$,async(s,a)=>{try{let e=await p.updateTenant(s.params.id,{status:\"suspended\"});if(!e)return a.status(404).json({success:!1,error:\"Tenant not found\"});await p.createAuditLog({tenantId:e.id,action:\"admin.tenant.suspended\",resource:\"tenant\",resourceId:e.id,changes:{status:\"suspended\"},ipAddress:s.ip}),a.json({success:!0,message:\"Tenant suspended\",requestId:s.requestId})}catch(e){console.error(\"Suspend tenant error:\",e),a.status(500).json({success:!1,error:\"Internal server error\"})}}),t.post(\"/api/admin/tenants/:id/activate\",$,async(s,a)=>{try{let e=await p.updateTenant(s.params.id,{status:\"active\"});if(!e)return a.status(404).json({success:!1,error:\"Tenant not found\"});await p.createAuditLog({tenantId:e.id,action:\"admin.tenant.activated\",resource:\"tenant\",resourceId:e.id,changes:{status:\"active\"},ipAddress:s.ip}),a.json({success:!0,message:\"Tenant activated\",requestId:s.requestId})}catch(e){console.error(\"Activate tenant error:\",e),a.status(500).json({success:!1,error:\"Internal server error\"})}}),t.post(\"/api/v1/addresses\",b,k,ae,Ae,O(\"address_create\"),async(s,a)=>{try{let e=zt.parse(s.body),o=s.tenant,c=await p.countAddressesByTenant(o.id);if(o.maxAddresses!==-1&&c>=o.maxAddresses)return a.status(403).json({success:!1,error:`Address limit reached (${o.maxAddresses})`,requestId:s.requestId,upgrade:!0});let d=Je(e.chain);if(!d)return a.status(400).json({success:!1,error:`Unsupported chain: ${e.chain}`,requestId:s.requestId});let y=await B.generateAddress(e.chain);if(!y.success||!y.data)return a.status(502).json({success:!1,error:y.error||\"Failed to generate address\",requestId:s.requestId});let m=await p.createAddress({tenantId:o.id,chain:e.chain,currency:d.symbol,address:y.data.address,publicKey:y.data.publicKey,label:e.label,tags:e.tags||[],webhookUrl:e.webhookUrl,status:\"active\",balance:\"0\",balanceUsd:\"0\"});await p.createAuditLog({tenantId:o.id,action:\"address.created\",resource:\"address\",resourceId:m.id,changes:{chain:e.chain,address:m.address},requestId:s.requestId}),a.status(201).json({success:!0,address:{id:m.id,chain:m.chain,currency:m.currency,address:m.address,label:m.label,tags:m.tags,status:m.status,createdAt:m.createdAt}})}catch(e){if(e.name===\"ZodError\")return a.status(400).json({success:!1,error:\"Validation error\",details:e.errors,requestId:s.requestId});console.error(\"Create address error:\",e),a.status(500).json({success:!1,error:\"Internal server error\",requestId:s.requestId})}}),t.get(\"/api/v1/addresses\",b,k,async(s,a)=>{try{let{chain:e,status:o,limit:c,offset:d}=s.query,y=await p.getAddressesByTenant(s.tenant.id,{chain:e,status:o,limit:parseInt(c)||50,offset:parseInt(d)||0}),m=await p.countAddressesByTenant(s.tenant.id);a.json({success:!0,addresses:y.map(I=>({id:I.id,chain:I.chain,currency:I.currency,address:I.address,label:I.label,tags:I.tags,status:I.status,balance:I.balance,balanceUsd:I.balanceUsd,lastSynced:I.lastSynced,createdAt:I.createdAt})),pagination:{total:m,limit:parseInt(c)||50,offset:parseInt(d)||0}})}catch(e){console.error(\"Get addresses error:\",e),a.status(500).json({success:!1,error:\"Internal server error\",requestId:s.requestId})}}),t.get(\"/api/v1/addresses/:id\",b,k,async(s,a)=>{try{let e=await p.getAddress(s.params.id);if(!e||e.tenantId!==s.tenant.id)return a.status(404).json({success:!1,error:\"Address not found\",requestId:s.requestId});a.json({success:!0,address:e})}catch(e){console.error(\"Get address error:\",e),a.status(500).json({success:!1,error:\"Internal server error\",requestId:s.requestId})}}),t.get(\"/api/v1/addresses/:id/balance\",b,k,ae,O(\"balance_query\"),async(s,a)=>{try{let e=await p.getAddress(s.params.id);if(!e||e.tenantId!==s.tenant.id)return a.status(404).json({success:!1,error:\"Address not found\",requestId:s.requestId});let o=await B.getBalance(e.chain,e.address);if(!o.success)return a.status(502).json({success:!1,error:o.error||\"Failed to fetch balance\",requestId:s.requestId});let d=(await B.getExchangeRates([e.currency])).data?.[e.currency.toUpperCase()]?.usd||0,m=(parseFloat(o.data?.balance||\"0\")*d).toFixed(2);await p.updateAddress(e.id,{balance:o.data?.balance||\"0\",balanceUsd:m,lastSynced:new Date}),a.json({success:!0,balance:{native:o.data?.balance||\"0\",usd:m,currency:e.currency,tokens:o.data?.tokens||[],lastSynced:new Date().toISOString()}})}catch(e){console.error(\"Get balance error:\",e),a.status(500).json({success:!1,error:\"Internal server error\",requestId:s.requestId})}}),t.patch(\"/api/v1/addresses/:id\",b,k,async(s,a)=>{try{let e=await p.getAddress(s.params.id);if(!e||e.tenantId!==s.tenant.id)return a.status(404).json({success:!1,error:\"Address not found\",requestId:s.requestId});let{label:o,tags:c,webhookUrl:d,metadata:y}=s.body,m={};o!==void 0&&(m.label=o),c!==void 0&&(m.tags=c),d!==void 0&&(m.webhookUrl=d),y!==void 0&&(m.metadata=y);let I=await p.updateAddress(s.params.id,m);await p.createAuditLog({tenantId:s.tenant.id,action:\"address.updated\",resource:\"address\",resourceId:e.id,changes:m,requestId:s.requestId}),a.json({success:!0,address:I})}catch(e){console.error(\"Update address error:\",e),a.status(500).json({success:!1,error:\"Internal server error\",requestId:s.requestId})}}),t.delete(\"/api/v1/addresses/:id\",b,k,async(s,a)=>{try{let e=await p.getAddress(s.params.id);if(!e||e.tenantId!==s.tenant.id)return a.status(404).json({success:!1,error:\"Address not found\",requestId:s.requestId});await p.archiveAddress(s.params.id),await p.createAuditLog({tenantId:s.tenant.id,action:\"address.archived\",resource:\"address\",resourceId:e.id,requestId:s.requestId}),a.json({success:!0,message:\"Address archived\"})}catch(e){console.error(\"Archive address error:\",e),a.status(500).json({success:!1,error:\"Internal server error\",requestId:s.requestId})}}),t.get(\"/api/v1/addresses/:id/tokens\",b,k,ae,O(\"token_balance\"),async(s,a)=>{try{let e=await p.getAddress(s.params.id);if(!e||e.tenantId!==s.tenant.id)return a.status(404).json({success:!1,error:\"Address not found\",requestId:s.requestId});let o=await B.getTokens(e.chain,e.address);a.json({success:!0,tokens:o.data||[]})}catch(e){console.error(\"Get tokens error:\",e),a.status(500).json({success:!1,error:\"Internal server error\",requestId:s.requestId})}}),t.get(\"/api/v1/addresses/:id/nfts\",b,k,ae,O(\"nft_metadata\"),async(s,a)=>{try{let e=await p.getAddress(s.params.id);if(!e||e.tenantId!==s.tenant.id)return a.status(404).json({success:!1,error:\"Address not found\",requestId:s.requestId});let o=await B.getNFTs(e.chain,e.address);a.json({success:!0,nfts:o.data||[]})}catch(e){console.error(\"Get NFTs error:\",e),a.status(500).json({success:!1,error:\"Internal server error\",requestId:s.requestId})}}),t.get(\"/api/v1/addresses/:id/transactions\",b,k,ae,O(\"tx_history\"),async(s,a)=>{try{let e=await p.getAddress(s.params.id);if(!e||e.tenantId!==s.tenant.id)return a.status(404).json({success:!1,error:\"Address not found\",requestId:s.requestId});let{pageSize:o,offset:c}=s.query,d=await B.getTransactionHistory(e.chain,e.address,{pageSize:parseInt(o)||50,offset:parseInt(c)||0});a.json({success:!0,transactions:d.data||[]})}catch(e){console.error(\"Get transactions error:\",e),a.status(500).json({success:!1,error:\"Internal server error\",requestId:s.requestId})}}),t.get(\"/api/v1/transactions/:chain/:hash\",b,k,ae,Ae,O(\"tx_history\"),async(s,a)=>{try{let{chain:e,hash:o}=s.params,c=await B.getTransaction(e,o);if(!c.success)return a.status(404).json({success:!1,error:c.error||\"Transaction not found\",requestId:s.requestId});a.json({success:!0,transaction:c.data})}catch(e){console.error(\"Get transaction error:\",e),a.status(500).json({success:!1,error:\"Internal server error\",requestId:s.requestId})}}),t.get(\"/api/v1/fees/:chain\",b,k,Ae,O(\"rpc_standard\"),async(s,a)=>{try{let e=await B.estimateFee(s.params.chain);if(!e.success)return a.status(502).json({success:!1,error:e.error||\"Failed to estimate fees\",requestId:s.requestId});a.json({success:!0,fees:e.data,chain:s.params.chain})}catch(e){console.error(\"Get fees error:\",e),a.status(500).json({success:!1,error:\"Internal server error\",requestId:s.requestId})}}),t.post(\"/api/v1/transactions/:chain/broadcast\",b,k,ae,Ae,O(\"tx_broadcast_eth\"),async(s,a)=>{try{let{txData:e}=s.body;if(!e)return a.status(400).json({success:!1,error:\"txData is required\",requestId:s.requestId});let o=await B.broadcastTransanpm warn config production Use `--omit=dev` instead.","attributes":{"level":"error"},"timestamp":"2025-11-30T18:34:42.092083758Z"}
{"mensaje":"","atributos":{"nivel":"información"},"marca de tiempo":"2025-11-30T18:34:42.610763126Z"}
{"mensaje":"> rest-express@1.0.0 inicio","atributos":{"nivel":"información"},"marca de tiempo":"2025-11-30T18:34:42.610770336Z"}
{"mensaje":"> NODE_ENV=nodo de producción dist/index.js","atributos":{"nivel":"información"},"marca de tiempo":"2025-11-30T18:34:42.610782713Z"}
{"mensaje":"","atributos":{"nivel":"información"},"marca de tiempo":"2025-11-30T18:34:42.610790401Z"}
{"mensaje":"archivo:///app/dist/index.js:1","atributos":{"nivel":"error"},"marca de tiempo":"2025-11-30T18:34:42.679931249Z"}
{"mensaje":"var mt=Object.defineProperty;var fe=(n,t)=>()=>(n&&(t=n(n=0)),t);var xe=(n,t)=>{para(var r en t)mt(n,r,{obtener:t[r],enumerable:!0})};var J={};xe(J,{EnumeraciónDeCadena:()=>ft,PRECIOS:()=>le,CADENAS_SOPORTADAS:()=>me,EnumeraciónDeEstado:()=>yt,LÍMITES_DE_NIVEL:()=>H,EnumeraciónDeNivel:()=>gt,EVENTOS_DE_WEBHOOK:()=>Be,direcciones:()=>S,UsoDeAPI:()=>W,RegistrosDeAuditoría:()=>te,AgregacionesDeFacturación:()=>Q,CriptoTransacciones:()=>de,ConfiguraciónDeGas:()=>X,InsertarEsquemaDeDirección:()=>vt,InsertarEsquemaDeUsoDeAPI:()=>_t,InsertarLoCursoDeAuditoría gSchema:()=>xt,insertarEsquemaDeTransacciónCriptográfica:()=>At,insertarEsquemaDeMonederoMaestro:()=>It,insertarEsquemaDeInquilino:()=>bt,insertarEsquemaDeTransacción:()=>kt,insertarEsquemaDeCuentaVirtual:()=>wt,insertarEsquemaDeWebhook:()=>Tt,MonederosMaestros:()=>z,inquilinos:()=>x,RelacionesDeInquilinos:()=>ht,transacciones:()=>j,CuentasVirtuales:()=>_,webhooks:()=>K});import{sql como M}de\"drizzle-orm\";import{pgTable como q,texto como l,varchar como T,entero como E,booleano como Ve,marca de tiempo como R,jsonb como F,real como he,índice como v}de\"drizzle-orm/pg-core\";import{createInsertSchema como Y}de\"drizzle-zod\";import{z como Ke}de\"zod\";import{relaciones como pt}de\"drizzle-orm\";var gt,yt,ft,x,z,_,de,X,S,j,K,W,Q,te,ht,It,wt,At,bt,vt,kt,Tt,_t,xt,H,le,Be,me,D=fe(()=>{\"use estricto\";gt=Ke.enum([\"inicial\",\"escala\",\"empresa\"]),yt=Ke.enum([\"activo\",\"suspendido\",\"eliminado\"]),ft=Ke.enum([\"bitcoin\",\"ethereum\",\"solana\",\"polígono\",\"tron\",\"bsc\",\"ondulación\",\"cardano\",\"cerca\",\"polkadot\",\"avalancha\",\"arbitrum\",\"optimismo\",\"base\",\"fantom\",\"cronos\",\"cosmos\",\"algorand\"]),x=q(\"inquilinos\",{id:T(\"id\",{length:36}).primaryKey().default(M`gen_rand om_uuid()`), nombre: l(\"nombre\").notNull(), correo electrónico: l(\"correo electrónico\").notNull().único(), nivel: l(\"nivel\").notNull().predeterminado(\"inicial\"), estado: l(\"estado\").notNull().predeterminado(\"activo\"), apiKeyPrefix: T(\"api_key_prefix\",{longitud: 16}).notNull(), apiKeyHash: l(\"api_key_hash\").notNull().único(), hmacSecret: l(\"hmac_secret\").notNull(), allowedChains: l(\"allowed_chains\").array().notNull().predeterminado(M`ARRAY['bitcoin', 'ethereum', 'solana']`), direcciones máximas: E(\"direcciones máximas\").notNull().default(50), webhooks máximos: E(\"webhooks máximos\").notNull().default(1), cuentas virtuales máximas: E(\"cuentas virtuales máximas\").notNull().default(0), límite de tasa: E(\"límite de tasa\").notNull().default(10), cuota mensual: E(\"cuota mensual\").notNull().default(1e4), correo electrónico de facturación: l(\"correo electrónico de facturación\"), nombre de la empresa:l(\"nombre_de_la_empresa\"),sitio_web:l(\"sitio_web\"),lista_blanca_de_ip:l(\"lista_blanca_de_ip\").array(),metadatos:F(\"metadatos\"),createdAt:R(\"created_at\").defaultNow().notNull(),updatedAt:R(\"updated_at\").defaultNow().notNull()},n=>[v(\"id_de_correo_electrónico_de_inquilinos\").on(n.email),v(\"id_hash_de_clave_de_API_de_inquilinos\").on(n.apiKeyHa sh),v(\"idx_estado_inquilinos\").on(n.estado)]),z=q(\"monederos_principales\",{id:T(\"id\",{longitud:36}).clave_primaria().predeterminado(M`gen_random_uuid()`),escenario:l(\"escenario\").notNull(),cadena_de_bloques:l(\"cadena_de_bloques\").notNull(),tipo_de_activo:l(\"tipo_de_activo\").notNull(),nombre_de_activo:l(\"nombre_de_activo\").notNull(),dirección:l( \"dirección\").notNull().unique(),clavepública:l(\"clave pública\"),claveprivadacifrada:l(\"clave privada cifrada\"),claveprivadaIV:T(\"clave privadaIV\",{longitud:32}),etiquetadeautenticacióndeclaveprivada:T(\"etiquetadeautenticacióndeclaveprivada\",{longitud:32}),direccióndecontratointeligente:l(\"direccióndecontratointeligente\"),decimalesdetoken:E(\"decimalesdetoken \"),assignedToTenantId:T(\"id_asignado_al_inquilino\",{length:36}).references(()=>x.id),balance:l(\"saldo\").default(\"0\"),balanceUsd:l(\"saldo_usd\").default(\"0\"),lastSyncTime:R(\"última_sincronización\"),gasMarkupPercentage:E(\"porcentaje_de_margen_de_gas\").default(40),status:l(\"estado\").notNull().de fallo(\"activo\"), metadatos: F(\"metadatos\"), creado en: R(\"creado_en\"). predeterminadoAhora(). no nulo(), actualizado en: R(\"actualizado_en\"). predeterminadoAhora(). no nulo()}, n => [v(\"masters_blockchain_idx\"). en(n. cadena de bloques), v(\"masters_asset_idx\"). en(n. nombre_activo), v(\"masters_address_idx\"). en(n. dirección), v(\"masters_inquilino _idx\").on(n.assignedToTenantId),v(\"masters_scenario_idx\").on(n.scenario)]),_=q(\"cuentas_virtuales\",{id:T(\"id\",{longitud:36}).primaryKey().default(M`gen_random_uuid()`),tenantId:T(\"tenant_id\",{longitud:36}).notNull().references(()=>x.id,{onDelete:\"cascade\"}),accountType:l(\"tipo_de_cuenta\").n otNull(),saldos:F(\"saldos\").predeterminado(M`'{}'`),estado:l(\"estado\").notNull().predeterminado(\"activo\"),congelado:Ve(\"congelado\").predeterminado(!1),metadatos:F(\"metadatos\"),createdAt:R(\"creado_en\").defaultNow().notNull(),updatedAt:R(\"actualizado_en\").defaultNow().notNull()},n=>[v(\"inquilino_de_cuentas_virtuales_i dx\").on(n.Id_de_inquilino),v(\"id_de_estado_de_cuentas_virtualesx\").on(n.estado)]),de=q(\"transacciones_criptográficas\",{id:T(\"id\",{longitud:36}).clave_primaria().predeterminado(M`gen_random_uuid()`),Id_de_inquilino:T(\"id_de_inquilino\",{longitud:36}).notNull().referencias(()=>x.id,{onDelete:\"cascada\"}),tipo:l(\"tipo\").notNull(),escenario:l(\"escenario\").notNull(),fromAccountId:T(\"from_account_id\",{longitud:36}),toAccountId:T(\"to_count_id\",{longitud:36}),toExternalAddress:l(\"to_external_address\"),fromExternalAddress:l(\"from_external_address\"),assetType:l(\"tipo_de_activo\").notNull(),assetName:l(\"nombre_de_activo\").notNull(),blockchain:l(\"blockchain\").notNull(),amount:l(\"mount\"). notNull(),gasReal:l(\"gas_real\"),gasMarkupPercent:E(\"gas_markup_percent\"),gasCharged:l(\"gas_charged\"),commissionAmount:l(\"commission_mont\"),commissionUsd:l(\"comission_usd\"),status:l(\"status\").notNull().default(\"pending\"),txHash:l(\"tx_hash\").unique(),blockNumber:E(\"block_number\"),confirmations:E(\"confirmations\"),metadata:F(\"me tadata\"), creado en: R(\"creado_en\"). predeterminadoAhora(). no nulo(), ejecutado en: R(\"ejecutado_en\"), confirmado en: R(\"confirmado_en\")}, n => [v(\"idx_de_inquilino_de_transacción_criptográfica\"). en(n. id_de_inquilino), v(\"idx_de_tipo_de_transacción_criptográfica\"). en(n. tipo), v(\"idx_de_estado_de_transacción_criptográfica\"). en(n. estado), v(\"idx_hash_de_transacción_criptográfica\"). en(n. hash_de_transacción), v(\"idx_de_escenario_de_transacción_criptográfica\"). en(n. escenario)]), X = q(\"setti_gas ngs\",{id:T(\"id\",{longitud:36}).primaryKey().default(M`gen_random_uuid()`),marcadopredeterminadoglobal:E(\"marcadopredeterminadoglobal\").default(40),marcadomín:E(\"marcadomín\").default(10),marcadomáx:E(\"marcadomáx\").default(100),anulacionesdecliente:F(\"anulacionesdecliente\").default(M`'{}'`),multiplicadoresdecadenadebloques:F(\"multiplicadoresdecadenadebloques\").default(M`'{\"ethereum\": 1.0, \"polígono\": 0.3}'`),Anulaciones de tipo de transacción:F(\"anulaciones de tipo de transacción\").predeterminado(M`'{\"retiro_cripto\": 40, \"transferencia_de_token\": 45}'`),updatedAt:R(\"updated_at\").defaultNow().notNull(),updatedBy:l(\"updated_by\")},n=>[v(\"gas_settings_updated_idx\").on(n.updatedAt)]),S=q(\"direcciones\",{id:T(\"id\",{longitud:36}).primaryKey().default(M`gen_random_uuid()`),tenantId:T(\"tenant_id\",{longitud:36}).notNull().references(()=>x.id,{onDelete:\"cascade\"}),chain:l(\"cadena\").notNull(),currency:l(\"currency\").notNull(),address: l(\"dirección\").notNull(),publicKey:l(\"clave_pública\"),derivationPath:l(\"ruta_derivación\"),label:l(\"etiqueta\"),tags:l(\"etiquetas\").array().default(M`ARRAY[]::text[]`),status:l(\"estado\").notNull().default(\"activo\"),balance:l(\"balance\").default(\"0\"),balanceUsd:l(\"balance_usd\").default(\"0\"),lastSynced:R(\"last_synced\"),webhookUrl:l(\"webhook_url\"),metadatos:F(\"metadatos\"),createdAt:R(\"creado_en\").defaultNow().notNull(),actualizadoEn:R(\"actualizado_en\").defaultNow().notNull(),eliminadoEn:R(\"eliminado_en\")},n=>[v(\"direcciones_idx_de_inquilino\").on(n.Id_de_inquilino),v(\"direcciones_idx_de_cadena\").on(n.cadena),v(\"direcciones_idx_de_estado\").on(n.estado),v(\"direcciones_idx_de_dirección\").on(n.dirección)] ),j=q(\"transacciones\",{id:T(\"id\",{longitud:36}).primaryKey().default(M`gen_random_uuid()`),tenantId:T(\"id_tenant\",{longitud:36}).notNull().references(()=>x.id,{onDelete:\"cascade\"}),txHash:l(\"tx_hash\").notNull(),chain:l(\"cadena\").notNull(),fromAddress:l(\"from_address\"),toAddress:l(\"t o_dirección\"), importe: l(\"importe\").notNull(), moneda: l(\"moneda\").notNull(), cuota: l(\"cuota\"), cuotaUsd: l(\"cuota_usd\"), estado: l(\"estado\").notNull().default(\"pendiente\"), tipo: l(\"tipo\").notNull().default(\"nativo\"), númerodebloque: E(\"númerodebloque\"), confirmaciones: E(\"confirmaciones\").default(0 ), metadatos: F(\"metadatos\"), creado en: R(\"creado_en\"). predeterminado ahora(). no nulo()}, n => [v(\"idx_de_inquilino_de_transacciones\"). en(n. ID_de_inquilino), v(\"idx_de_cadena_de_transacciones\"). en(n. cadena), v(\"idx_de_hash_de_transacciones\"). en(n. Hash_de_tx), v(\"idx_de_estado_de_transacciones\"). en(n. estado)]), K = q(\"webhooks\", {id: T(\"id\", {le longitud: 36}). claveprimaria(). predeterminado(M`gen_random_uuid()`), ID_inquilino: T(\"ID_inquilino\",{longitud: 36}). no nulo(). referencias(()=>x.id,{onDelete:\"cascada\"}), URL: l(\"URL\"). no nulo(), eventos: l(\"eventos\"). matriz(). no nulo(), secreto_hmac: l(\"secreto_hmac\"). no nulo(), activo: Ve(\"activo\"). predeterminado(!0), reintentarCou nt:E(\"retry_count\").default(0),lastTriggered:R(\"last_triggered\"),lastStatus:E(\"last_status\"),metadatos:F(\"metadatos\"),createdAt:R(\"created_at\").defaultNow().notNull()},n=>[v(\"webhooks_tenant_idx\").on(n.tenantId),v(\"webhooks_active_idx\").on(n.active)]),W=q(\"api_usage\",{id:T(\"id \",{longitud:36}).primaryKey().default(M`gen_random_uuid()`),tenantId:T(\"tenant_id\",{longitud:36}).notNull().references(()=>x.id,{onDelete:\"cascade\"}),endpoint:l(\"endpoint\").notNull(),method:l(\"method\").notNull(),chain:l(\"chain\"),action:l(\"action\").notNull(),units:he(\"units\").notN ull(), créditos:he(\"créditos\").notNull(), código de estado:E(\"código de estado\").notNull(), id de solicitud:T(\"id de solicitud\",{longitud:36}).notNull(), tiempo de respuesta Ms:E(\"ms de tiempo de respuesta\"), metadatos:F(\"metadatos\"), marca de tiempo:R(\"marca de tiempo\").defaultNow().notNull()}, n=>[v(\"id de inquilino de uso de API\").on(n.id de inquilino),v(\"api_usage_timestamp_idx\").on(n.timestamp),v(\"api_usage_action_idx\").on(n.action)]),Q=q(\"agregaciones_de_facturación\",{id:T(\"id\",{longitud:36}).primaryKey().default(M`gen_random_uuid()`),tenantId:T(\"id_de_teniente\",{longitud:36}).notNull().references(()=>x.id,{onDelete:\"cascade\"}),periodo:l(\"periodo\").notNull(),periodType:l(\"tipo_de_periodo\").notNull().default(\"diario\"),totalUnits:he(\"unidades_totales\").notNull().def ault(0), totalCredits:he(\"total_créditos\").notNull().default(0), costUsd:he(\"costo_usd\").notNull().default(0), breakdown:F(\"break\"), createdAt:R(\"created_at\").defaultNow().notNull()}, n=>[v(\"billing_tenant_period_idx\").on(n.tenantId,n.period)]), te=q(\"audit_logs\",{id:T(\"id\",{length:36}).primaryKey().default(M`gen_random_uuid()`), tenantId:T(\"tenant_id\",{length:36}).references(()=>x.id,{onDelete:\"set null\"}),ID_usuario:l(\"id_usuario\"),acción:l(\"acción\").notNull(),recurso:l(\"recurso\").notNull(),ID_recurso:l(\"id_recurso\"),cambios:F(\"cambios\"),Dirección_IP:l(\"dirección_IP\"),Agente_usuario:l(\"agente_usuario\"),ID_solicitud:T(\"id_solicitud\",{longitud:36}),marca_de_tiempo:R(\"marca_de_tiempo\").defaultNow().notNull()},n=>[v(\"audit_logs_tenant_idx\").on(n.Id_tenant),v(\"audit_logs_timestamp_idx\").on(n.marca_de_tiempo),v(\"audit _logs_action_idx\").on(n.action)]),ht=pt(x,({muchos:n})=>({direcciones:n(S),transacciones:n(j),webhooks:n(K),cuentasvirtuales:n(_),apiUsage:n(W),agregacionesdefacturación:n(Q),registrosdeauditoría:n(te),monederosprincipales:n(z),criptotransacciones:n(de)})),It=Y(z).omit({id:!0,createdAt:!0,updatedAt:!0}),wt=Y(_).omit({id:!0,createdAt:!0,updatedAt:!0}),At=Y(de).omit({id:!0,createdAt:!0,executedAt:!0,confirmedAt:!0}),bt=Y(x).omit({ id:!0,createdAt:!0,updatedAt:!0}),vt=Y(S).omit({id:!0,createdAt:!0,updatedAt:!0,deletedAt:!0}),kt=Y(j).omit({id:!0,createdAt:!0}),Tt=Y(K).omit({id:!0,createdAt:!0}),_t=Y(W).omit({id:!0,timestamp:!0}),xt=Y(te).omit({id:!0,timestamp:!0}),H={starter:{chains:[\"bitcoin\",\"ethereum\",\"solana\"],maxAddresses:50,maxWebhooks:1,maxVirtualAccounts:0,rateLimit:10,monthlyQuota:1e4,kmsAllowed:!1,archivalAccess :!1, días de retención: 1}, escala: {cadenas: [\"bitcoin\",\"ethereum\",\"solana\",\"polígono\",\"tron\",\"bsc\",\"ripple\",\"cardano\"], direcciones máximas: 1e3, webhooks máximos: 10, cuentas virtuales máximas: 5, límite de tasa: 100, cuota mensual: 1e5, km permitidos:!0, acceso de archivo:!1, días de retención: 7}, empresa: {cadenas: [\"bitcoin\",\"ethereum\",\"solana\",\"polígono\",\"tron\",\"bsc\",\"ripple\",\"cardano\",\"near\",\"polkadot\",\"avalancha\",\"arbitro\",\"optimismo\",\"base\",\"fantasma\",\"cronos\",\"cosmos\",\"algorand\"],máximo de direcciones: -1,máximo de webhooks: -1,máximo de cuentas virtuales: 50,límite de tasa: 1e3,cuota mensual: -1,km permitidos: !0,acceso de archivo: !0,días de retención: 30}},le={creación de dirección:{unidades: 1,costo: 0,001},consulta de saldo:{unidades: 0,costo: 5e-4},saldo de token:{unidades: 1,costo: 0,001},metadatos nft:{unidades: 2,costo: 0,002},tx_br oadcast_btc:{unidades: 50, costo: 0,05}, tx_broadcast_eth:{unidades: 10, costo: 0,01}, tx_broadcast_other:{unidades: 10, costo: 0,01}, tx_history:{unidades: 2, costo: 0,002}, webhook_subscription:{unidades: 0,02, costo: 0,02}, va_create:{unidades: 100, costo: 0,1}, va_transfer:{unidades: 5, costo: 0,005}, tipo de cambio:{unidades: 0,1, costo: 1e-4}, web3_resolve:{unidades: 1, costo: 0,001}, malicioso_check:{unidades: 2, costo: 0,002}, rpc_standard:{u nits:2,costo:2e-4},rpc_eth_call:{unidades:5,costo:5e-4},rpc_debug:{unidades:50,costo:.005}},Be=[\"TRANSACCIÓN_DIRECCIÓN\",\"SALDO_DIRECCIÓN\",\"TRANSACCIÓN_NATIVA_ENTRANTE\",\"TRANSACCIÓN_NATIVA_SALIENTE\",\"TRANSACCIÓN_FUNGIBLE_ENTRANTE\",\"TRANSACCIÓN_FUNGIBLE_SALIENTE\",\"TRANSACCIÓN_NFT_ENTRANTE\",\"TRANSACCIÓN_NFT_SALIENTE\",\"TRANSACCIÓN_MULTITOKEN_ENTRANTE\",\"TRANSACCIÓN_MULTITOKEN_SALIENTE\",\"TRANSACCIÓN_FALLIDA\",\"CUOTA_PAGADA\",\"REGISTRO_DE_CONTRATO _EVENTO\"],me=[{id:\"bitcoin\",nombre:\"Bitcoin\",símbolo:\"BTC\",icono:\"\\u20BF\"},{id:\"ethereum\",nombre:\"Ethereum\",símbolo:\"ETH\",icono:\"\\u039E\"},{id:\"solana\",nombre:\"Solana\",símbolo:\"SOL\",icono:\"\\u25CE\"},{id:\"polígono\",nombre:\"Polígono\",símbolo:\"MATIC\",icono:\"\\u2B21\"},{id:\"tron\",nombre:\"Tron\",símbolo:\"TRX\",icono:\"\\u2666\"},{id:\"bsc\",nombre:\"BNB Cadena\", símbolo:\"BNB\", icono:\"\\u25C6\"},{id:\"ripple\", nombre:\"XRP Ledger\", símbolo:\"XRP\", icono:\"\\u2715\"},{id:\"cardano\", nombre:\"Cardano\", símbolo:\"ADA\", icono:\"\\u20B3\"},{id:\"near\", nombre:\"NEAR\", símbolo:\"NEAR\", icono:\"\\u24C3\"},{id:\"polkadot\", nombre:\"Polkadot\", símbolo:\"DOT\", icono:\"\\u25CF\"},{id:\"avalanche\", nombre:\"Avalanche\", símbolo:\"AVAX\", icono:\"\\u25B2\"},{id:\"arb itrum\", nombre:\"Arbitrum\", símbolo:\"ARB\", icono:\"\\u25C8\"},{id:\"optimism\", nombre:\"Optimism\", símbolo:\"OP\", icono:\"\\u2295\"},{id:\"base\", nombre:\"Base\", símbolo:\"ETH\", icono:\"\\u25EF\"},{id:\"fantom\", nombre:\"Fantom\", símbolo:\"FTM\", icono:\"\\u25C7\"},{id:\"cronos\", nombre:\"Cronos\", símbolo:\"CRO\", icono:\"\\u25CE\"},{id:\"cosmos\",nombre:\"Cosmos\",símbolo:\"ATOM\",icono:\"\\u269B\"},{id:\"algorand\",nombre:\"Algorand\",símbolo:\"ALGO\",icono:\"\\u24B6\"}]});var oe={};xe(oe,{db:()=>f,pool:()=>Ye});import{Pool como St,neonConfig como Pt}desde\"@neondatabase/serverless\";import{drizzle como Rt}desde\"drizzle-orm/neon-serverless\";import Et desde\"ws\";var Ye,f,V=fe(()=>{\"use strict\";D();Pt.webSocketConstructor=Et;if(!process.env.DATABASE_URL)throw new Error(\"DATABASE_URL debe ser ¿Olvidaste aprovisionar una base de datos?\"); Ye=new St({connectionString:process.env.DATABASE_URL}), f=Rt({client:Ye,schema:J})}); function jt(n){return!n||typeof n!=\"string\"||n.length<32?!1:/^[a-zA-Z0-9_-]{32,}$/.test(n)} function Bt(){return P.state===\"open\"?Date.now()-P.lastFailure>=$e.resetTimeoutMs?(P.state=\"half-open\",P.successesInHalfOpen=0,!0):!1:!0} function Dt(){P.estado===\"semiabierto\"?(P.éxitosEnMedioApertura++,P.éxitosEnMedioApertura>=$e.umbralDeÉxitoDeAperturaMedia&&(P.estado=\"cerrado\",P.fallos=0)):P.fallos=0}función ze(){P.fallos++,P.últimoFallo=Fecha.ahora(),(P.estado===\"semiabierto\"||P.fallos>=$e.umbralDeFallo)&&(P.estado=\"abierto\")}función Ut(n,t){devolver t.EstadosReintentables.includes(n)}función Xe(n,t){devolver Math.min(t.baseDelayMs*Math.pow(2,n)+Math.random()*1e3,t.maxDelayMs)}función asíncrona Qe(n){devuelve nueva Promesa(t=>setTimeout(t,n))}función asíncrona N(n,t={},r=Kt){si(!Bt())devuelve{éxito:!1,error:\"Servicio temporalmente no disponible (disyuntor abierto)\",statusCode:503};let i=null;for(let u=0;u<=r.maxRetries;u++)try{let g=new AbortController,h=setTimeout(()=>g.abort(),3e4),s=await fetch(`${Mt}${n}`,{...t,señal:g.señal,encabezados:{\"Tipo-Contenido\":\"aplicación/json\",\"clave-x-api\":Fe||\"\",...t.encabezados}});clearTimeout(h);let a=await s.json().catch(()=>null);if(!s.ok){let e={éxito:!1,error:a?.mensaje||a?.error||`HTTP ${s.estado}`,código-estado:s.estado};if(s.estado===429){let o=s.headers.get(\"Retry-After\");o&&(e.retryAfter=parseInt(o,10)*1e3)}if(Ut(s.status,r)&&u<r.maxRetries){i=e;let o=e.retryAfter||Xe(u,r);await Qe(o);continue}return ze(),e}return Dt(),{éxito:!0,datos:a}}catch(g){let h=g.name===\"Error de cancelación\",s=g.message?.includes(\"obtener\")||g.message?.includes(\"red\"),a={éxito:!1,error:h?\"Tiempo de espera de la solicitud\":g.message||\"Red error\",statusCode:h?408:500};if((h||s)&&u<r.maxRetries){i=a,await Qe(Xe(u,r));continue}return ze(),a}return i||{éxito:!1,error:\"Se excedió el máximo de reintentos\",statusCode:500}}function Je(n){return me.find(t=>t.id===n)}var Mt,Fe,Kt,P,$e,se,B,Oe=fe(()=>{\"use strict\";D();Mt=process.env.TATUM_API_URL||\"https://api.tatum.io\",Fe=process.env.TATUM_API_KEY;Fe?jt(Fe)||console.warn(\"El formato de TATUM_API_KEY parece no ser válido; puede causar errores de API\"):console.warn(\"TATUM_API_KEY no configurado; las llamadas a la API fail\"); Kt={máx.Reintentos:3,Ms.deRetardoBase:1e3,Ms.deRetardoMax:3e4,EstadosReintentables:[408,429,500,502,503,504]}, P={fallos:0,últimoFallo:0,estado:\"cerrado\",éxitosEnMedioApertura:0}, $e={UmbralDeFallo:5,Ms.deRestablecimientoTiempoDeEspera:6e4,UmbralDeÉxitoEnMedioApertura:2}; se={bitcoin:\"bitcoin\",ethereum:\"ethereum\",solana:\"solana\",polygon:\"polígono\",tron:\"tron\",bsc:\"bsc\",ri pple:\"xrp\",cardano:\"ada\",near:\"near\",polkadot:\"dot\",avalanche:\"avax\",arbitrum:\"arbitrum-one\",optimismo:\"optimismo\",base:\"base\",fantom:\"fantom\",cronos:\"cro\",c osmos:\"atom\",algorand:\"algo\"},B={getCircuitBreakerState(){return{...P}},resetCircuitBreaker(){P.failures=0,P.lastFailure=0,P.state=\"closed\",P.successesInHalfOpen=0},async generateAddress(n){let t=se[n]||n;return N(`/v3/${t}/wallet`,{método:\"GET\"})},async getBalance(n,t){let r=se[n]||n;return[\"ethereum\",\"polígono\",\"bsc\",\"arbitrum-one\",\"optimism\",\"base\"].includes(r)?N(`/v3/${r}/account/balance/${t}`):N(r===\"bitcoin\"?`/v3/bitcoin/address/balance/${t}`:r===\"solana\"?`/v3/solana/account/balance/${t}`:`/v3/${r}/account/balance/${t}`)},async getTokens(n,t){let r=se[n]||n;devuelve N(`/v3/data/tokens?chain=${r}&addresses=${t}`)},asincrónico obtenerNFTs(n,t){let r=se[n]||n;devuelve N(`/v3/data/nfts?chain=${r}&addresses=${t}`)},asincrónico obtenerHistorialDeTransacciones(n,t,r){let i=se[n]||n,u=nuevosParámetrosDeBúsquedaDeURL;devuelve r?.TamañoDePágina&&u.set(\"TamañoDePágina\",r.TamañoDePágina.toString()),r?.Desplazamiento&&u.set(\"Desplazamiento\",r.Desplazamiento.toString()),N(`/v3/data/transacciones?chain=${i}&addresses=${t}&${u.toString()}`)},asincrónico getTransaction(n,t){let r=se[n]||n;devuelve N(`/v3/${r}/transaction/${t}`)},async estimateFee(n,t=\"TRANSFER\"){let r=se[n]||n;devuelve N(`/v3/${r}/gas/estimate`,{método:\"POST\",cuerpo:JSON.stringify({tipo:t})})},async broadcastTransaction(n,t){let r=se[n]||n;devuelve N(`/v3/${r}/broadcast`,{método:\"POST\",cuerpo:JSON.stringify({txData:t})})},async getExchangeRates(n){let t=n.join(\",\");devuelve N(`/v3/tatum/rate/${t}?basePair=USD`)}, asíncrono resolveWeb3Name(n){devuelve N(`/v3/blockchain/names/${n}`)}, asíncrono checkMaliciousAddress(n){devuelve N(`/v3/security/address/${n}`)}, asíncrono createWebhook(n){devuelve N(\"/v4/subscription\",{método:\"POST\",cuerpo:JSON.stringify(n)})}, asíncrono deleteWebhook(n){devuelve N(`/v4/subscription/${n}`,{método:\"DELETE\"})}, asíncrono getWebhooks(){devuelve N(\"/v4/subscription\")},async healthCheck(){let n=await N(\"/v3/tatum/version\"); return n.success?{success:!0, data:{status:\"healthy\", version:n.data?.version||\"v3\", circuitBreaker:{...P}}}:{...n, data:{status:\"degraded\", version:\"unknown\", circuitBreaker:{...P}}}}}});var ve={};xe(ve,{GasFeeManager:()=>Ee,gasFeeManager:()=>Le});import{eq as Ge}from\"drizzle-orm\";var Ee,Le,ge=fe(()=>{\"use strict\";V();D();Ee=class{config=null;async loadConfig(){let[t]=await f.select().from(X).limit(1);if(!t){let r={Margen predeterminado global: 40, Margen mínimo: 10, Margen máximo: 100, Anulaciones de cliente:{}, Multiplicadores de cadena de bloques:{ethereum: 1, polígono: .3, bitcoin: 1.2, solana: .1, arbitraje: .2}, Anulaciones de tipo de transacción:{retiro_cripto: 40, transferencia_de_token: 45, contrato_inteligente: 60}};return this.config=r,r}return this.config={globalDefaultMarkup:t.globalDefaultMarkup,minMarkup:t.minMarkup,maxMarkup:t.maxMarkup,clientOverrides:t.clientOverrides||{},blockchainMultipliers:t.blockchainMultipliers||{},transactionTypeOverrides:t.transactionTypeOverrides||{}},this.config}async calculateGasMarkup(t){this.config||await this.loadConfig();let r=this.config.globalDefaultMarkup;if(t.clientId&&this.config.clientOverrides[t.clientId]){let a=this.config.clientOverrides[t.clientId];if(a.expiresAt){let e=new Date(a.expiresAt);new Date<e&&(r=a.markup)}else r=a.markup}let i=this.config.transactionTypeOverrides[t.transactionType];i&&(r=i);let u=this.config.blockchainMultipliers[t.blockchain]||1;r=Math.round(r*u),r=Math.max(this.config.minMarkup,Math.min(this.config.maxMarkup,r));let g=t.gasReal*(r/100),h=t.gasReal+g,s=g;return{gasReal:t.gasReal,gasMarkupPercent:r,gasCharged:h,yourProfit:s}}async updateGlobalMarkup(t,r){t=Math.max(10,Math.min(100,t)),await f.update(X).set({globalDefaultMarkup:t,updatedAt:new Fecha,actualizadoPor:r}).donde(Ge(X.id,\"predeterminado\")),this.config=null,await this.loadConfig()}async setClientMarkup(t,r,i,u,g){this.config||await this.loadConfig();let h=this.config.clientOverrides;h[t]={markup:Math.max(10,Math.min(100,r)),reason:i,expiresAt:g?.toISOString()},await f.update(X).set({clientOverrides:h,actualizadoEn:new Fecha,actualizadoPor:u}).donde(Ge(X.id,\"predeterminado\")),this.config=null,await this.loadConfig()}async removeClientMarkup(t,r){this.config||await this.loadConfig();let i=this.config.clientOverrides;eliminar i[t],esperar f.update(X).set({clientOverrides:i,actualizadoEn:nueva Fecha,actualizadoPor:r}).where(Ge(X.id,\"predeterminado\")),this.config=null,esperar this.loadConfig()}getConfig(){devolver this.config}},Le=new Ee});var ke={};xe(ke,{CryptoGateway:()=>Ne,cryptoGateway:()=>Ht});importar Lt desde\"crypto\";importar{eq como G y como Wt} desde\"drizzle-orm\";var Ne,Ht,Te=fe(()=>{\"usar estricto\";Oe();ge();V();D();Ne=class{async createVirtualAccount(t,r){devolver(esperar f.insert(_).values({Id.inquilino:t,TipoDeCuenta:r,Saldos:JSON.stringify({})}).returning())[0]}async internalSwap(t){let r=await f.query.virtualAccounts.findFirst({where:G(_.id,t.fromAccountId)});if(!r)throw new Error(\"No se encontró la cuenta\");let i=JSON.parse(r.balances||\"{}\"),u=parseFloat(i[t.assetName]||\"0\");if(u<parseFloat(t.fromAmount))throw new Error(\"Saldo insuficiente\");let g=parseFloat(t.toAmount)*.005,h=parseFloat(t.toAmount)-g,s={...i};s[t.assetName]=(u-parseFloat(t.fromAmount)).toString(),await f.update(_).set({balances:JSON.stringify(s)}).where(G(_.id,t.fromAccountId));let a=espera f.consulta.cuentasvirtuales.findFirst({donde:G(_.id,t.toAccountId)}),e=JSON.parse(a?.balances||\"{}\");devuelve e[t.nombreDeActivo]=(parseFloat(e[t.nombreDeActivo]||\"0\")+h).toString(),espera f.update(_).set({balances:JSON.stringify(e)}).donde(G(_.id,t.toAccountId)),{txId:(espera f.insert(de).values({Id.inquilino:t.Id.inquilino,tipo:\"intercambio_interno\",escenario:t.scenario,Id.deCuenta:t.deCuenta,Id.deCuenta:t.deCuenta,Tipo.deActivo:\"cripto\",Nombre.deActivo:t.deActivo,cadena.de.blockchain:t.blockchain,importe:t.deImporte,importe.de.comisión:g.de.Cadena(),comisión.Usd:(g*45e3).de.Cadena(),estado:\"completado\"}).returning())[0].id,estado:\"completado\",deImporte:t.deImporte,de.Importe:t.de.Importe,comisión:g.de.Fijo(8),neto.Recibido:h.de.Fijo(8),ejecutadoEn:nuevaFecha().de.CadenaISO()}}asincrónico externalWithdraw(t){let r=await f.query.masterWallets.findFirst({where:Wt(G(z.assetName,t.assetName),G(z.blockchain,t.blockchain),G(z.scenario,t.scenario))});if(!r)throw new Error(`No se encontró la billetera maestra para ${t.assetName} en ${t.blockchain}`);let i=await B.estimateGas({blockchain:t.blockchain,assetType:t.assetName===r.smartContractAddress?\"token\":\"crypto\",amount:t.amount}),u=await Le.calculateGasMarkup({clientId:t.tenantId,blockchain:t.blockchain,transactionType:t.assetName===\"BTC\"?\"crypto_withdraw\":\"token_transfer\",gasReal:i.gasReal}),g=await f.query.virtualAccounts.findFirst({where:G(_.id,t.fromAccountId)}),h=JSON.parse(g?.balances||\"{}\"),s=parseFloat(h[t.assetName]||\"0\");if(s<parseFloat(t.amount))throw new Error(\"Saldo insuficiente\");h[t.assetName]=(s-parseFloat(t.amount)).toString(),await f.update(_).set({balances:JSON.stringify(h)}).where(G(_.id,t.fromAccountId));let a=`0x${Lt.randomBytes(32).toString(\"hex\")}`;return{txId:(await f.insert(de).values({Id.inquilino:t.inquilino,tipo:\"retiro_externo\",escenario:t.scenario,toExternalAddress:t.toExternalAddress,tipo.activo:\"cripto\",nombre.activo:t.nombre.activo,blockchain:t.blockchain,cantidad:t.cantidad,gasReal:u.gasReal.toString(),porcentaje.de.margen.gas:u.porcentaje.de.margen.gas,gasCargado :u.gasCharged.toString(),commissionAmount:u.yourProfit.toString(),status:\"pendiente\",txHash:a}).returning())[0].id,status:\"pendiente_de_confirmación\",txHash:a,amount:t.amount,gasReal:u.gasReal.toFixed(8),gasCharged:u.gasCharged.toFixed(8),yourProfit:u.yourProfit.toFixed(8),estimatedTime:\"12 segundos\"}}async assignMasterToClient(t,r,i){return await f.update(z).set({assignedToTenantId:r,gasMarkupPercentage:i}).where(G(z.id,t)),{success:!0,masterId:t,assignedTo:r,gasMarkup:i,assignedAt:new Date().toISOString()}}async getVirtualAccountBalance(t){let r=await f.query.virtualAccounts.findFirst({where:G(_.id,t)});if(!r)throw new Error(\"Cuenta no encontrada\");let i=JSON.parse(r.balances||\"{}\"); return{accountId:t,balances:i,totalUsd:Object.entries(i).reduce((u,[g,h])=>{let s={ETH:2500,BTC:45e3,GOLD:500,SILVER:250}; return u+parseFloat(h)*(s[g]||0)},0)}}},Ht=new Ne});import Ce de\"express\";import{z como w} de\"zod\";D();V();import{eq como A,and como Z,desc como ie,sql como De,gte como Nt,lte como Ct} de\"drizzle-orm\";var Ue=class{async getTenant(t){let[r]=await f.select().from(x).where(A(x.id,t));return r||void 0}async getTenantByApiKeyHash(t){let[r]=await f.select().from(x).where(A(x.apiKeyHash,t));return r||void 0}async getTenantByEmail(t){let[r]=await f.select().from(x).where(A(x.email,t));return r||void 0}async getAllTenants(){return f.select().from(x).orderBy(ie(x.createdAt))}async createTenant(t){let[r]=await f.insert(x).values(t).returning();return r}async updateTenant(t,r){let[i]=await f.update(x).set({...r,updatedAt:nueva fecha}).where(A(x.id,t)).returning();devolver i||void 0}async deleteTenant(t){await f.update(x).set({estado:\"eliminado\",updatedAt:nueva fecha}).where(A(x.id,t))}async getAddress(t){let[r]=await f.select().from(S).where(A(S.id,t));devolver r||void 0}async getAddressByAddress(t,r,i){let[u]=await f.select().from(S).where(Z(A(S.tenantId,t),A(S.chain,r),A(S.address,i)));devolver u||void 0}async getAddressesByTenant(t,r){let i=f.select().from(S).where(A(S.tenantId,t)),u=[A(S.tenantId,t)];devuelve r?.chain&&u.push(A(S.chain,r.chain)),r?.status&&u.push(A(S.status,r.status)),f.select().from(S).where(Z(...u)).orderBy(ie(S.createdAt)).limit(r?.limit||50).offset(r?.offset||0)}asincrónico countAddressesByTenant(t){let[r]=await f.select({count:De`count(*)`}).from(S).where(Z(A(S.tenantId,t),A(S.status,\"active\")));devuelve r?.count||0}asincrónico createAddress(t){let[r]=await f.insert(S).values(t).returning();return r}async updateAddress(t,r){let[i]=await f.update(S).set({...r,updatedAt:nueva fecha}).where(A(S.id,t)).returning();return i||void 0}async archiveAddress(t){await f.update(S).set({estado:\"archivado\",eliminadoAt:nueva fecha,updatedAt:nueva fecha}).where(A(S.id,t))}async getTransaction(t){let[r]=await f.select().from(j).where(A(j.id,t));return r||void 0}async getTransactionByHash(t,r){let[i]=await f.select().from(j).where(Z(A(j.chain,t),A(j.txHash,r)));return i||void 0}async getTransactionsByTenant(t,r){let i=[A(j.tenantId,t)];return r?.chain&&i.push(A(j.chain,r.chain)),r?.status&&i.push(A(j.status,r.status)),f.select().from(j).where(Z(...i)).orderBy(ie(j.createdAt)).limit(r?.limit||50).offset(r?.desplazamiento||0)}asincrónico createTransaction(t){let[r]=await f.insert(j).values(t).returning();devolver r}asincrónico updateTransaction(t,r){let[i]=await f.update(j).set(r).where(A(j.id,t)).returning();devolver i||void 0}asincrónico getWebhook(t){let[r]=await f.select().from(K).where(A(K.id,t));devolver r||void 0}asincrónico getWebhooksByTenant(t){devolver f.select().from(K).where(A(K.tenantId,t)).orderBy(ie(K.createdAt))}asincrónico countWebhooksByTenant(t){let[r]=await f.select({count:De`count(*)`}).from(K).where(Z(A(K.tenantId,t),A(K.active,!0)));devuelve r?.count||0}asinc createWebhook(t){let[r]=await f.insert(K).values(t).returning();devuelve r}asinc updateWebhook(t,r){let[i]=await f.update(K).set(r).where(A(K.id,t)).returning();devuelve i||void 0}asinc deleteWebhook(t){await f.delete(K).where(A(K.id,t))}asinc getVirtualAccount(t){let[r]=await f.select().from(_).where(A(_.id,t));devuelve r||void 0}asinc obtenerCuentasVirtualesPorInquilino(t){devolver f.seleccionar().de(_).donde(A(_.IdInquilino,t)).ordenarPor(ie(_.createdAt))}asincrónico contarCuentasVirtualesPorInquilino(t){let[r]=await f.seleccionar({count:De`count(*)`}).de(_).donde(Z(A(_.IdInquilino,t),A(_.estado,\"activo\")));devolver r?.count||0}asincrónico crearCuentaVirtual(t){let[r]=await f.insertar(_).valores(t).devolver();devolver r}asincrónico actualizarCuentaVirtual(t,r){let[i]=await f.actualizar(_).set(r).donde(A(_.id,t)).devolver();devolver i||void 0}asincrónico recordApiUsage(t){let[r]=await f.insert(W).values(t).returning();return r}async getApiUsageByTenant(t,r,i){return f.select().from(W).where(Z(A(W.tenantId,t),Nt(W.timestamp,r),Ct(W.timestamp,i))).orderBy(ie(W.timestamp))}async getApiUsageStats(t,r,i){let u=await this.getApiUsageByTenant(t,r,i),g={},h={},s=0,a=0;for(let e of u)s+=e.unidades,a+=e.créditos,g[e.punto final]=(g[e.punto final]||0)+1,e.cadena&&(h[e.cadena]=(h[e.cadena]||0)+1);return{totalRequests:u.length,totalUnits:s,totalCredits:a,byEndpoint:g,byChain:h}}async getBillingAggregation(t,r){let[i]=await f.select().from(Q).where(Z(A(Q.tenantId,t),A(Q.periodo,r)));return i||void 0}async upsertBillingAggregation(t){let r=await this.getBillingAggregation(t.tenantId,t.periodo);if(r){let[i]=await f.update(Q).set(t).where(A(Q.id,r.id)).returning();return i}else{let[i]=await f.insert(Q).values(t).returning();return i}}async createAuditLog(t){let[r]=await f.insert(te).values(t).returning();return r}async getAuditLogsByTenant(t,r=100){return f.select().from(te).where(A(te.tenantId,t)).orderBy(ie(te.timestamp)).limit(r)}},p=new Ue;Oe();import ce from\"crypto\";D();var Ze=process.env.ADMIN_API_KEY;function Ie(){let n=`tatum_${ce.randomBytes(28).toString(\"hex\")}`,t=n.substring(0,16),r=tt(n);devolver{clave:n,prefijo:t,hash:r}}función tt(n){devolver ce.createHash(\"sha256\").update(n).digest(\"hex\")}función we(){devolver ce.randomBytes(32).toString(\"hex\")}función st(){devolver`req_${ce.randomBytes(16).toString(\"hex\")}`}función asíncrona b(n,t,r){n.requestId=st(),t.setHeader(\"X-Request-ID\",n.requestId);deje que i=n.headers[\"x-api-key\"]; if(!i)return t.status(401).json({success:!1,error:\"Clave API faltante\",requestId:n.requestId});let u=tt(i),g=await p.getTenantByApiKeyHash(u); if(!g)return t.status(401).json({success:!1,error:\"Clave API no válida\",requestId:n.requestId}); if(g.status!==\"activo\")return t.status(403).json({success:!1,error:`La cuenta es ${g.status}`,requestId:n.requestId});n.tenant=g,r()}function $(n,t,r){n.requestId=st(),t.setHeader(\"X-Request-ID\",n.requestId);let i=n.headers[\"x-admin-key\"];if(!Ze)return t.status(503).json({éxito:!1,error:\"API de administración no configurada\",requestId:n.requestId});if(!i)return t.status(401).json({éxito:!1,error:\"Falta la clave de API de administración\",requestId:n.requestId});let u=ce.createHash(\"sha256\").update(i).digest(\"hex\"),g=ce.createHash(\"sha256\").update(Ze).digest(\"hex\");if(!ce.timingSafeEqual(Buffer.from(u),Buffer.from(g)))return t.status(401).json({éxito:!1,error:\"Clave de API de administrador no válida\",requestId:n.requestId});n.isAdmin=!0,r()}var et=new Map;function k(n,t,r){if(!n.tenant)return r();let i=n.tenant.id,u=Date.now(),g=1e3,h=et.get(i);(!h||h.resetAt<u)&&(h={count:0,resetAt:u+g},et.set(i,h)),h.count++;let s=n.tenant.rateLimit,a=Math.max(0,sh.count);if(t.setHeader(\"X-RateLimit-Límite\",s),t.setHeader(\"X-RateLimit-Restante\",a),t.setHeader(\"X-RateLimit-Restablecer\",Math.ceil(h.resetAt/1e3)),h.count>s)return t.status(429).json({éxito:!1,error:\"Límite de tasa excedido\", requestId:n.requestId,retryAfter:Math.ceil((h.resetAt-u)/1e3)});r()}función en(n){return(t,r,i)=>{if(!t.tenant)return r.status(401).json({éxito:!1,error:\"Se requiere autenticación\", requestId:t.requestId});let u=H[t.tenant.tier];if(!u)return r.status(403).json({éxito:!1,error:\"Configuración de nivel no válida\", requestId:t.requestId});if(n===\"kms\"&&!u.kmsAllowed)return r.status(403).json({éxito:!1,error:\"KMS no está disponible en Su nivel. Actualice a Scale o Enterprise.\",requestId:t.requestId,upgrade:!0});if(n===\"archival\"&&!u.archivalAccess)return r.status(403).json({success:!1,error:\"El acceso a archivos no está disponible en su nivel. Actualice a Enterprise.\",requestId:t.requestId,upgrade:!0});i()}}function Ae(n,t,r){if(!n.tenant)return r();let i=n.params.chain||n.body?.chain;if(!i)return r();let g=H[n.tenant.tier]?.chains||n.tenant.allowedChains;if(!g.includes(i))return t.status(403).json({success:!1,error:`La cadena '${i}' no está disponible en su nivel`,allowedChains:g,requestId:n.requestId,upgrade:!0});r()}D();función asíncrona nt(){if(!process.env.SEED_DEMO_DATA)return null;console.log(\"Comprobando si hay un inquilino de demostración...\");let n=await p.getTenantByEmail(\"demo@tatum-gateway.io\");if(n)return console.log(\"El inquilino de demostración ya existe\"),n;console.log(\"Creando inquilino de demostración...\"); let{prefix:t,hash:r}=Ie(),i=H.scale,u=await p.createTenant({name:\"Cuenta de demostración\",email:\"demo@tatum-gateway.io\",tier:\"scale\",status:\"active\",apiKeyPrefix:t,apiKeyHash:r,hmacSecret:we(),allowedChains:i.chains,maxAddresses:i.maxAddresses,maxWebhooks:i.maxWebhooks,maxVirtualAccounts:i.maxVirtualAccounts,rateLimit:i.rateLimit,monthlyQuota:i.monthlyQuota,companyName:\"Demostración de Tatum Gateway\",website:\"https://tatum.io\"});console.log(\"Inquilino de demostración creado:\",u.id),await p.createAuditLog({Id.inquilino:u.id,acción:\"inquilino.creado\",recurso:\"inquilino\",Id.recurso:u.id,cambios:{nivel:\"escala\",origen:\"semilla\"}});para(dejar g=0;g<10;g++)esperar p.recordApiUsage({Id.inquilino:u.id,punto final:`/api/v1/${[\"direcciones\",\"saldos\",\"tokens\",\"transacciones\"][g%4]}`,método:[\"OBTENER\",\"POST\"][g%2],cadena:[\"ethereum\",\"bitcoin\",\"solana\",\"polígono\"][g%4],acción:[\"saldo consulta_de_ance\",\"creación_de_dirección\",\"saldo_de_token\",\"historial_de_transacciones\"][g%4],unidades:[.5,1,1,2][g%4],créditos:[5e-4,.001,.001,.002][g%4],código_de_estado:200,id_de_solicitud:`demo_${g}`,tiempo_de_respuestaMs:50+Math.floor(Math.random()*100)});retorno console.log(\"¡Datos de uso de demostración sembrados!\"),u}D();función O(n){return async(t,r,i)=>{if(!t.tenant)return i();let u=le[n];t.metered={acción:n,unidades:u.units,créditos:u.cost};let g=r.json.bind(r);r.json=h=>{let s=Date.now();return p.recordApiUsage({Id.inquilino:t.id.inquilino, punto final:t.ruta, método:t.método, cadena:t.params.cadena||t.cuerpo?.cadena||nulo, acción:n, unidades:u.unidades, créditos:u.costo, código de estado:r.código de estado, Id.solicitud:t.id.solicitud, tiempo de respuesta:Fecha.ahora()-s, metadatos:{agente-usuario:t.encabezados[\"agente-usuario\"], ip:t.ip}}).catch(consola.error),h&&tipo de h==\"objeto\"&&(h.meta={...h.meta, Id.solicitud:t.id.solicitud, marca de tiempo:nueva Fecha().toISOString(),medido:{acción:n,unidades:u.unidades,créditos:u.costo}}),g(h)},i()}}función asíncrona be(n){let t=nueva fecha,r=nueva fecha(t.getFullYear(),t.getMonth(),1),i=await p.getApiUsageStats(n,r,t);return{totalRequests:i.totalRequests,totalUnits:i.totalUnits,totalCredits:i.totalCredits,costUsd:i.totalCredits}}función asíncrona Se(n,t){if(t===-1)return{permitido:!0,usado:0,restante:-1,porcentajeUsado:0};let r=await ser(n),i=Math.floor(r.totalUnits),u=ti,g=i/t*100;devolver{permitido:u>0,usado:i,restante:Math.max(0,u),porcentajeUsado:Math.min(100,g)}}función ae(n,t,r){si(!n.inquilino)devolver r();Se(n.inquilino.id,n.inquilino.cuotamensual).entonces(i=>{si(t.setHeader(\"X-Cuota-Usada\",i.usada),t.setHeader(\"X-Cuota-Restante\",i.restante),t.setHeader(\"X-Cuota-Porcentaje\",Math.round(i.porcentajeUsado)),!i.permitido)devolver t.status(429).json({success:!1,error:\"Cuota mensual excedida\",requestId:n.requestId,quota:{used:i.used,limit:n.tenant.cuotamensual,porcentajeUsado:i.porcentajeUsado},actualización:!0});r()}).catch(()=>r())}D();importar Ft desde\"crypto\";var $t=1e5,Ot=32,qt=\"sha256\",ne=null,pe=class n{secretomaestro;versión;createdAt;estático SALT_PREFIXES={claveprivada:\"kms:clave_privada:v1\",carteramaestra:\"kms:cartera_maestra:v1\",secretohmac:\"kms:secretohmac:v1\",derivacióndeclaveapi:\"kms:claveapi:v1\",cifradodesesión:\"kms:sesión:v1\"};constructor(t,r=1){if(!t||t.length<32)arrojar nuevo Error(\"El secreto maestro debe ser al menos 32 bytes (usar: openssl rand -hex 16)\");this.masterSecret=t,this.version=r,this.createdAt=new Date,t.length<64&&console.warn(\"\\u26A0\\uFE0F ADVERTENCIA: El secreto del KMS maestro tiene menos de 64 bytes. Considere usar: openssl rand -hex 32\")}static initialize(t){let r=t||process.env.MASTER_KMS_SECRET||process.env.SESSION_SECRET;if(!r)throw new Error(\"Variable de entorno MASTER_KMS_SECRET no establecida. Generar con: openssl rand -hex 32\");return ne||(ne=new n(r),console.log(\"\\u2705 KMS inicializado con secreto maestro\"),ne)}static getInstance(){return ne||(ne=n.initialize()),ne}deriveKey(t,r=\"\"){let i=n.SALT_PREFIXES[t];if(!i)throw new Error(`Tipo de clave desconocida: ${t}`);let u=Buffer.from(`${i}:${r}`);return{key:Ft.pbkdf2Sync(this.masterSecret,u,$t,Ot,qt),version:this.version,keyType:t}}derivePrivateKeyEncryptionKey(t){return this.deriveKey(\"privateKey\",t).key}deriveMasterWalletKey(t){return this.deriveKey(\"masterWallet\",t).key}deriveHmacKey(t){return this.deriveKey(\"hmacSecret\",t).key}deriveSessionEncryptionKey(t){return this.deriveKey(\"sessionEncryption\",t).key}getConfig(){return{masterSecret:\"[CENSURADO]\",version:this.version,createdAt:this.createdAt}}rotate(t){let r=new n(t,this.version+1);return ne=r,console.log(`\\u2705 KMS rotado a la versión ${r.version}`),r}static test(){try{let t=n.getInstance(),r=t.deriveKey(\"privateKey\",\"test-wallet-1\"),i=t.deriveKey(\"privateKey\",\"test-wallet-1\");if(r.key.toString(\"hex\")!==i.key.toString(\"hex\"))throw new Error(\"La derivación de la clave KMS no es determinista\");let u=t.deriveKey(\"privateKey\",\"test-wallet-2\");if(r.key.toString(\"hex\")===u.key.toString(\"hex\"))throw new Error(\"Colisión de derivación de clave KMS detectada\");return console.log(\"\\u2705 Autoprueba de KMS aprobada\"),!0}catch(t){return console.error(\"\\u274C Autoprueba de KMS fallida:\",t),!1}}};try{pe.initialize()}catch(n){console.warn(\"\\u26A0\\uFE0F Advertencia de inicialización de KMS:\",n)}import qe from\"crypto\";var Pe=\"aes-256-gcm\",Re=32,Gt=16;function rt(n,t,r){if(t.length!==Re)throw new Error(`La clave de cifrado debe ser de ${Re} bytes`);let i=qe.randomBytes(Gt),u=qe.createCipheriv(Pe,t,i);r&&u.setAAD(Buffer.from(r));let g=Buffer.concat([u.update(n,\"utf8\"),u.final()]),h=u.getAuthTag();return{ciphertext:g.toString(\"hex\"),iv:i.toString(\"hex\"),authTag:h.toString(\"hex\"),algorithm:Pe}}function ot(n,t,r){if(t.length!==Re)throw new Error(`La clave de cifrado debe tener ${Re} bytes`);if(n.algorithm!==Pe)throw new Error(`Algoritmo no compatible: ${n.algorithm}`);let i=Buffer.from(n.iv,\"hex\"),u=Buffer.from(n.ciphertext,\"hex\"),g=Buffer.from(n.authTag,\"hex\"),h=qe.createDecipheriv(Pe,t,i);r&&h.setAAD(Buffer.from(r)),h.setAuthTag(g);try{return Buffer.concat([h.update(u),h.final()]).toString(\"utf8\")}catch{throw new Error(\"Error de descifrado: los datos pueden estar dañados o alterados\")}}import{sql como Vt}desde\"drizzle-orm\";import{webcrypto como it}desde\"crypto\";var Yt=w.object({nombre:w.string().min(2),correo electrónico:w.string().correo electrónico(),nivel:w.enum([\"starter\",\"scale\",\"enterprise\"]).predeterminado(\"starter\"),nombreDeEmpresa:w.string().opcional(),sitio web:w.string().url().opcional(),correo electrónico de facturación:w.string().correo electrónico().opcional()}),zt=w.object({cadena:w.string(),etiqueta:w.string().opcional(),etiquetas:w.array(w.string()).opcional(),URLdelwebhook:w.string().url().opcional()}),Xt=w.object({url:w.string().url(),eventos:w.array(w.enum(Be)).min(1)});función asíncrona ct(n,t){nt().catch(console.error),t.get(\"/\",(s,a)=>{a.json({name:\"Tatum API Gateway\",version:\"1.0.0\",description:\"API Gateway de blockchain de nivel empresarial compatible con más de 130 blockchains\",status:\"running\",documentation:\"GET /api/docs | GET /api/docs/model | GET /api/docs/examples\",quickStart:\"1. Obtener la clave API del administrador | 2. Agregar el encabezado 'x-api-key: YOUR_KEY' | 3. Enviar por POST a /api/tenants para registrarse\",endpoints:{health:\"GET /api/health\",pricing:\"GET /api/pricing\",chains:\"GET /api/chains\",tenants:\"GET /api/tenants | POST /api/inquilinos\", direcciones:\"GET /api/v1/direcciones | POST /api/v1/direcciones\", transacciones:\"GET /api/v1/transacciones\", webhooks:\"POST /api/v1/webhooks | GET /api/v1/webhooks\", puerta de enlace:\"POST /api/v1/puerta de enlace/cuentas-virtuales | GET /api/v1/puerta de enlace/cuentas-virtuales | POST /api/v1/puerta de enlace/intercambio | POST /api/v1/puerta de enlace/retiro\", administrador:\"GET /api/admin/configuración-gas | PUT /api/admin/configuración-gas/global | GET /api/admin/ingresos | GET /api/admin/transacciones\", rwa:\"POST /api/v1/rwa/tokens | GET /api/v1/rwa/tokens | POST /api/v1/rwa/tokens/:id/transfer\"},businessModel:{type:\"Puerta de enlace API de doble panel (100 % de ingresos de administración)\",panels:{cryptoPanel:{description:\"Control de billetera maestra con sistema de cuentas virtuales\",revenueStreams:{internalSwaps:\"0,5 % de comisión (sin comisiones de gas)\",gasMarkup:\"40 % de margen configurable sobre las comisiones de gas\",setupFees:\"$500 por cliente de RWA\"},annualRevenue:\"$204K (Y1) \\u2192 $1.02M (Y2) \\u2192 $2.04M (Y3)\"}, rwaPanel:{description:\"Infraestructura de tokenización de activos del mundo real\",revenueStreams:{setupFees:\"$500 por token (pago único)\",nnualFees:\"$200 por token al año\",tradingCommissions:\"0.5% del volumen total de operaciones (100% para administración)\"},annualRevenue:\"$654K (Y1) \\u2192 $8.07M (Y2) \\u2192 $60.21M (Y3)\"}},profitMargins:\"82.5% (Y1) \\u2192 91.2% (Y2) \\u2192 96,8 % (año 3)\", totalProjections:{año 1:\"$858 000\", año 2:\"$9,09 000\", año 3:\"$62,25 000\"}}, auth:{type:\"Clave API + HMAC\", method:\"x-api-key header (Tatum v3 recommended)\", example:\"curl -H 'x-api-key: YOUR_API_KEY' https://api.example.com/api/v1/...\", documentation:\"https://docs.tatum.io/docs/authentication\"}, rateLimit:\"Por nivel: Starter 10/s, Scale 100/s, Enterprise 1000/seg\",docs:\"https://api.tatum.io/docs\",github:\"https://github.com/MasterFital/tatum-api-gateway\"})}),t.get(\"/api/docs/model\",(s,a)=>{a.json({title:\"Tatum API Gateway - Modelo de Negocio\",introduction:\"Arquitectura de doble panel que genera el 100% de ingresos administrativos mediante el trading de criptomonedas y la tokenización de RWA\",panels:{crypto:{name:\"Panel CRYPTO (100% de tus ingresos)\",description:\"Controlas las billeteras maestras (BTC, ETH, SOL, MATIC). Los clientes operan a través de cuentas virtuales.\",how_it_works:{step1:\"El administrador crea billeteras maestras mediante POST /api/admin/master-wallets\",step2:\"Los clientes crean cuentas virtuales mediante POST /api/v1/gateway/virtual-accounts\",paso 3:\"Los clientes pueden intercambiar internamente (comisión del 0,5 % para usted) o retirar externamente (margen de beneficio del 40 %)\",paso 4:\"El administrador registra todos los ingresos mediante GET /api/admin/revenue\"},revenue_streams:{internal_swaps:{description:\"El cliente intercambia BTC \\u2192 ETH\",fee:\"0,5 % del importe del intercambio\",gas_cost:\"Cero (interno)\",admin_profit:\"100 % de la comisión\",example:\"El cliente intercambia 1 ETH \\u2192 0,02 BTC | Comisión: 0,0001 BTC (100 % para el administrador)\"},gas_markup:{description:\"El cliente retira criptomonedas a una billetera externa\",fee:\"Margen de beneficio del 40 % sobre el gas real costo\", ejemplo:\"Gas Bitcoin: $3 reales | Cobras: $4.20 | Tu ganancia: $1.20 (40%)\"}}, proyecciones:{año1:{volumen:\"Promedio de 1 millón de USD/mes\", swaps mensuales:\"5K \\xD7 0.5% = $25K\", gas mensual:\"Retiros de 10K \\xD7 $3 \\xD7 40% = $12K\", total mensual:\"$17K\", anual:\"$204K\"}, año2:{volumen:\"Promedio de 5 millones de USD/mes\", anual:\"$1.02M\"}, año3:{volumen:\"Promedio de 10 millones de USD/mes\", anual:\"$2.04M\"}}}, rwa:{nombre:\"Panel RWA (100% Tus Ingresos + Tarifas)\", descripción:\"Los clientes emiten tokens. Tú proporcionas la infraestructura. Te quedas con el 100% de las tarifas y comisiones de trading.\", cómo_funciona:{paso 1:\"El cliente solicita la creación de un token: POST /api/v1/rwa/tokens\", paso 2:\"Cobras $500 de comisión de configuración + implementación del contrato inteligente\", paso 3:\"El token se activa. Los clientes operan internamente (comisión del 0,5 % para ti)\", paso 4:\"Comisión anual de mantenimiento de $200 por token\", paso 5:\"Todos los retiros externos tienen un margen de gas del 40 % (para ti)\", paso 6:\"Seguimiento de los ingresos mediante GET /api/admin/rwa-revenue\"},revenue_streams:{setup_fees:{description:\"Comisión única por token lanzado\",amount:\"$500\",frequency:\"Por token\"},annual_fees:{description:\"Mantenimiento anual por token activo\",amount:\"$200\",frequency:\"Por token por año\"}, comisiones_comerciales:{descripción:\"0.5% del volumen total de operaciones de tokens (100% para el administrador)\", porcentaje:\"0.5%\", ejemplo:\"Volumen de tokens: $100,000/mes | Su comisión: $500/mes = $6,000/año por token\"}, margen_gas:{descripción:\"40% de margen en las comisiones de gas para retiros externos\", porcentaje:\"40%\"}}, beneficios_del_cliente:{beneficio1:\"Infraestructura de tokenización (su costo: ~$0.10 por token)\", beneficio2:\"Mercado listo para usar\", beneficio3:\"Liquidez instantánea (operadores del día 1)\", beneficio4:\"Seguridad y cumplimiento a su cargo\", pago_del_cliente:\"$500 de configuración + $200/año solo\"}, proyecciones:{año1:{tokens:\"20 tokens nuevos\", tarifas_de_configuración:\"20 \\xD7 $500 = $10K\", tarifas_anuales:\"20 \\xD7 $200 = $4K\", comisiones_de_operación:\"0.5% de un volumen de ~$100M = $500K\", total:\"$514K\"}, año2:{tokens:\"100 tokens en total\", tarifas_de_configuración:\"100 \\xD7 $500 = $50K\", tarifas_anuales:\"100 \\xD7 $200 = $20K\", comisiones_de_operación:\"0.5% de un volumen de ~$1.6B = $8M\",total:\"$8.07M\"},año3:{tokens:\"300 tokens en total\",tarifas_de_configuración:\"300 \\xD7 $500 = $150K\",tarifas_anuales:\"300 \\xD7 $200 = $60K\",comisiones_de_comercio:\"0.5% de un volumen de ~$12B = $60M\",total:\"$60.21M\"}}}},resumen_de_ingresos:{título:\"Ingresos combinados (Cripto + RWA)\",año 1:{cripto:\"$204K\",rwa:\"$654K\",total:\"$858K\",margen:\"82.5%\"},año 2:{cripto:\"$1.02M\",rwa:\"$8.07M\",total:\"$9.09M\",margen:\"91.2%\"},año 3:{cripto:\"$2.04M\",rwa:\"$60.21M\",total:\"$62.25M\",margen:\"96.8%\"}},puntos_clave:[\"El 100% de todos los ingresos van al administrador (usted)\",\"Los clientes obtienen acceso a la infraestructura, no a la repartición de ingresos\",\"Las tarifas de configuración son ingresos inmediatos\",\"Las comisiones de trading escalan infinitamente con el volumen\",\"El margen de gas es puro beneficio (costo mínimo de infraestructura)\",\"Costo de adquisición de clientes cero (los clientes se traen a sí mismos)\"]})}),t.get(\"/api/docs/examples\",(s,a)=>{a.json({title:\"Tatum API Gateway - Ejemplos de uso\",autenticación: {descripción:\"Todas las solicitudes requieren el encabezado x-api-key\",ejemplo:\"curl -H 'x-api-key: YOUR_API_KEY' https://api.example.com/api/v1/...\",encabezados:{\"x-api-key\":\"Su clave API del administrador\",\"Content-Type\":\"application/json\"}},crypto_examples: {título:\"Ejemplos del panel CRYPTO\",create_virtual_account: {descripción:\"El cliente crea una cuenta virtual para almacenar criptomonedas\",endpoint:\"POST /api/v1/gateway/virtual-accounts\",solicitud:{tipoDeCuenta:\"individual\"},respuesta:{éxito:!0,cuentaVirtual:{id:\"va-123\",identificadorDeInquilino:\"cliente-1\",tipoDeCuenta:\"individual\",saldos:{BTC:\"0\",ETH:\"0\",SOL:\"0\"},estado:\"activo\"}}},interno_swap_0_5_percent:{descripción:\"El cliente intercambia BTC por ETH (comisión del 0,5 % para el administrador)\",punto final:\"POST /api/v1/gateway/swap\", solicitud: {fromAccountId:\"va-123\", fromAsset:\"BTC\", toAsset:\"ETH\", importe:\"1.0\"}, respuesta: {éxito:!0, intercambio: {id:\"swap-456\", fromAsset:\"BTC\", toAsset:\"ETH\", importe:\"1.0\", comisión:\"0.005 BTC (0.5% para el administrador)\", estado:\"completado\"}, nota:\"Sin comisiones de gas, comisión del 0.5% aplicada\"}}, external_withdraw_40_percent_markup: {descripción:\"El cliente retira a una billetera externa (40% de margen de gas para el administrador)\", punto final:\"POST /api/v1/gateway/withdraw\", solicitud: {fromAccountId:\"va-123\", activo:\"ETH\", importe:\"1.0\", dirección:\"0x1234567890abcdef...\"}, respuesta: {éxito:!0, retiro: {id:\"withdraw-789\", activo:\"ETH\", importe:\"1.0\", dirección:\"0x1234567890abcdef...\", gasReal:\"3 USD\", gasCharged:\"4.20 USD (40% de margen)\", adminProfit:\"1.20 USD\", estado:\"pendiente\", txHash:\"0xabcd...\"}}}, ver_historial_de_transacciones: {descripción:\"El cliente visualiza su transacción historial\", punto final:\"GET /api/v1/transactions?limit=50\", respuesta:{éxito:!0, transacciones:[{id:\"swap-456\", tipo:\"internal_swap\", activo:\"BTC\", importe:\"1.0\", comisión:\"0.005\", estado:\"completado\", creado el:\"2024-11-30T10:00:00Z\"}], paginación:{total:42, límite:50, desplazamiento:0}}}}, ejemplos_rwa:{título:\"Ejemplos de paneles RWA\", crear_rwa_token_500_setup:{descripción:\"El cliente crea un token (paga $500 de tarifa de configuración al administrador)\", punto final:\"POST /api/v1/rwa/tokens\",solicitud:{nombreDeActivo:\"Fondo Inmobiliario\",símbolo:\"REF\",cadenaDeBlockchain:\"Ethereum\",decimales:18,suministroTotal:\"1000000\",nombreDeEmisor:\"RE Properties Inc\",descripción:\"Inversión Inmobiliaria Tokenizada\"},respuesta:{éxito:!0,token:{id:\"token-ref-1\",nombreDeActivo:\"Fondo inmobiliario\", símbolo:\"REF\", cadena de bloques:\"ethereum\", suministro total:\"1000000\", dirección del contrato inteligente:\"0x...\", estado:\"creado\"}, precios: {tarifa de configuración:\"$500 (pago único) - PAGADO AL ADMINISTRADOR\", tarifa anual:\"$200/año - PAGADO AL ADMINISTRADOR\", comisión de negociación:\"0.5% en todas las operaciones - 100% PARA EL ADMINISTRADOR\"}}}, lista_rwa_tokens: {descripción:\"El cliente visualiza sus tokens y volumen de operaciones\", punto final:\"GET /api/v1/rwa/tokens\", respuesta: {éxito:!0, tokens:[{id:\"token-ref-1\", nombre_del_activo:\"Bienes raíces Fondo\", símbolo:\"REF\", cadena de bloques:\"ethereum\", oferta total:\"1000000\", estado:\"activo\", tarifa de configuración:\"500, tarifa anual:\"200, volumen de negociación:\"250000 USD\", comisión de negociación:\"1250 USD (0,5 % para el administrador)\"}], resumen:{totalTokens:\"1, comisiones de negociación totales:\"1250 USD (100 % para el administrador)\", tarifas de configuración cobradas:\"500 USD (100 % para el administrador)\"}}}, rwa_token_transfer_0_5_percent:{descripción:\"El titular del token negocia el token REF (0,5 % de comisión para el administrador)\", punto final:\"POST /api/v1/rwa/tokens/token-ref-1/transfer\",request:{toAddress:\"0xabcd...\",amount:\"100\"},response:{success:!0,transfer:{id:\"transfer-123\",tokenId:\"token-ref-1\",amount:\"100 REF\",toAddress:\"0xabcd...\",commission:\"0.5 REF (0.5% para el administrador)\",status:\"completed\",txHash:\"0x...\"},note:\"0.5% de comisión de trading aplicada y cobrada por el administrador\"}}},admin_examples:{title:\"Ejemplos del panel de administración\",view_revenue:{description:\"El administrador visualiza los ingresos totales (swaps + margen de gas)\",endpoint:\"GET /api/admin/revenue\",respuesta:{éxito:!0,cryptoRevenue:{totalSwapCommissions:\"1245.67 USD\",totalGasMarkupRevenue:\"3456.78 USD\",totalVolume:\"249000 USD\",revenueByBlockchain:{ethereum:\"2345.67\",polygon:\"1234.56\",bitcoin:\"3456.78\"}}}},view_rwa_revenue:{description:\"El administrador visualiza los ingresos de RWA (comisiones de configuración + anuales + de trading)\",endpoint:\"GET /api/admin/rwa-revenue\",respuesta:{éxito:!0,rwaRevenue:{setupFees:{count:12,total:\"6000 USD\", Tarifas anuales: {Clientes activos: 12, Total: 2400 USD\", Comisiones por operaciones: {Este mes: 12500 USD\", Este año: 125000 USD\", Tasa: 0,5 % del volumen total de operaciones\", Ingresos mensuales totales: 15000 USD\", Seguridad: {Autenticación: encabezado x-api-key (recomendado Tatum v3)\", Cifrado: Todas las claves privadas cifradas con AES-256\", Auditoría: Todas las transacciones registradas con registro de auditoría completo\", Límite de tasa: Starter 10/s, Scale 100/s, Enterprise 1000/seg\",documentación:\"https://docs.tatum.io/docs/authentication\"}})}),t.get(\"/api/test-tatum\",async(s,a)=>{try{let e=await B.healthCheck(),o={success:e.success,message:e.success?\"\\u2705 Conectado a la API de Tatum correctamente\":\"\\u274C Error al conectarse a la API de Tatum\",tatumApiUrl:process.env.TATUM_API_URL||\"https://api.tatum.io\",apiKeyConfigured:!!process.env.TATUM_API_KEY,apiKeyLength:process.env.TATUM_API_KEY?.length||0,timestamp:new Date().toISOString()};e.success&&e.data&&(o.blockchainInfo={chain:e.data.chain,blocks:e.data.blocks,mempool:e.data.mempool}),e.error&&(o.error=e.error,o.statusCode=e.statusCode),a.json({success:e.success,test:\"Prueba de conexión a la API de Tatum\",status:o,instructions:{production:\"Configure la variable de entorno TATUM_API_KEY con su API de producción de Tatum key\",documentation:\"https://docs.tatum.io/docs/authentication\",getApiKey:\"https://dashboard.tatum.io\"},requestId:s.requestId})}catch(e){a.status(500).json({success:!1,test:\"Prueba de conexión de la API de Tatum\",error:e.message,message:\"Error al probar la conexión de Tatum\",instructions:{checkApiKey:\"Asegúrese de que TATUM_API_KEY esté configurado en las variables de entorno\",checkUrl:\"Verifique que TATUM_API_URL esté correct\",documentation:\"https://docs.tatum.io/docs/authentication\"},requestId:s.requestId})}}),t.get(\"/api/docs\",(s,a)=>{a.json({title:\"Tatum API Gateway - Documentación completa\",message:\"Para obtener más información, visite estos puntos finales de la documentación:\",available_docs:{business_model:\"GET /api/docs/model - Explicación completa de los flujos de ingresos\",examples:\"GET /api/docs/examples - Ejemplos de uso para Crypto y RWA\",tatum_test:\"GET /api/test-tatum - Conexión de prueba a la API de Tatum (verificación de producción)\",this_endpoint:\"GET /api/docs - Esta página\",api_root:\"GET / - Información de la API y descripción general del modelo de negocio\"},quick_endpoints:{\"Crypto Panel\":[\"POST /api/v1/gateway/virtual-accounts - Crear cuenta virtual\",\"POST /api/v1/gateway/swap - Swap interno (comisión del 0,5%)\",\"POST /api/v1/gateway/withdraw - Retiro externo (margen de beneficio del 40%)\",\"GET /api/v1/transactions - Historial de transacciones\"],\"Panel RWA\":[\"POST /api/v1/rwa/tokens - Crear token (comisión de instalación de 500$)\",\"GET /api/v1/rwa/tokens - Listar tokens\",\"POST /api/v1/rwa/tokens/:id/transfer - Intercambio de tokens (comisión del 0,5%)\"],Admin:[\"GET /api/admin/revenue - Panel de ingresos de criptomonedas\",\"GET /api/admin/rwa-revenue - Panel de ingresos de RWA\",\"GET /api/admin/master-wallets - Lista de billeteras maestras\",\"POST /api/admin/master-wallets - Crear billetera maestra\"]},authentication:{method:\"x-api-key header\",example:\"Authorization: x-api-key YOUR_API_KEY\",documentation:\"https://docs.tatum.io/docs/authentication\"},support:{github:\"https://github.com/MasterFital/tatum-api-gateway\",tatum_docs:\"https://api.tatum.io/docs\",api_reference:\"https://docs.tatum.io/reference/welcome-to-the-tatum-api-reference\"}})}),t.get(\"/api/health\",async(s,a)=>{let e=await B.healthCheck();a.json({éxito:!0,estado:\"saludable\",servicios:{api:\"saludable\",base de datos:\"saludable\",tatum:e.success?\"saludable\":\"degradado\"},marca de tiempo:nueva Fecha().toISOString()})}), t.get(\"/api/pricing\",(s,a)=>{a.json({éxito:!0,precios:le,niveles:Object.entries(H).map(([e,o])=>({id:e,...o,precios:{starter:{mensual:0,incluido:1e4},escala:{mensual:99,incluido:1e5},empresa:{mensual:\"personalizado\",incluido:\"ilimitado\"}}[e]}))})}), t.get(\"/api/cadenas\",(s,a)=>{a.json({éxito:!0,cadenas:me,total:me.length})}), t.post(\"/api/inquilinos\",async(s,a)=>{try{let e=Yt.parse(s.body);if(await p.getTenantByEmail(e.email))return a.status(409).json({éxito:!1,error:\"Correo electrónico ya registrado\"});let{key:c,prefix:d,hash:y}=Ie(),m=H[e.tier],I=await p.createTenant({nombre:e.nombre,correo electrónico:e.correo electrónico,nivel:e.nivel,estado:\"activo\",apiKeyPrefix:d,apiKeyHash:y,hmacSecret:we(),allowedChains:[...m.cadenas],maxAddresses:m.maxAddresses,maxWebhooks:m.maxWebhooks,maxVirtualAccounts:m.maxVirtualAccounts,rateLimit:m.rateLimit,monthlyQuota:m.monthlyQuota,companyName:e.companyName,website:e.website,billingEmail:e.billingEmail});await p.createAuditLog({tenantId:I.id,action:\"tenant.created\",resource:\"tenant\",resourceId:I.id,changes:{tier:e.tier}}),a.status(201).json({success:!0,tenant:{id:I.id,name:I.name,email:I.email,tier:I.tier,status:I.status,apiKey:c,hmacSecret:I.hmacSecret,limits:{chains:I.allowedChains,maxAddresses:I.maxAddresses,maxWebhooks:I.maxWebhooks,maxVirtualAccounts:I.maxVirtualAccounts,rateLimit:I.rateLimit,monthlyQuota:I.monthlyQuota},createdAt:I.createdAt},warning:\"Guarde su clave API ahora. No se puede recuperar de nuevo.\"})}catch(e){if(e.name===\"ZodError\")return a.status(400).json({éxito:!1,error:\"Error de validación\",details:e.errors});console.error(\"Error al crear inquilino:\",e),a.status(500).json({éxito:!1,error:\"Error interno del servidor\"})}}),t.get(\"/api/tenants\",async(s,a)=>{try{let e=await p.getAllTenants(),o=await Promise.all(e.map(async c=>{let d=await be(c.id),y=await p.countAddressesByTenant(c.id); return{id:c.id,name:c.name,email:c.email,tier:c.tier,status:c.status,companyName:c.companyName,addressCount:y,usage:{requests:d.totalRequests,units:Math.floor(d.totalUnits),costUsd:d.costUsd.toFixed(4)},createdAt:c.createdAt}}));a.json({success:!0,tenants:o})}catch(e){console.error(\"Error al obtener inquilinos:\",e),a.status(500).json({success:!1,error:\"Error interno del servidor\"})}}),t.get(\"/api/tenants/:id\",b,async(s,a)=>{try{let e=espera p.getTenant(s.params.id);si(!e)devuelve a.status(404).json({éxito:!1,error:\"No se encontró el inquilino\"}); sea o=await be(e.id),c=await Se(e.id,e.monthlyQuota),d=await p.countAddressesByTenant(e.id),y=await p.countWebhooksByTenant(e.id),m=await p.countVirtualAccountsByTenant(e.id);a.json({éxito:!0, inquilino:{id:e.id, nombre:e.name, correo electrónico:e.email, nivel:e.tier, estado:e.status, nombreDeEmpresa:e.nombreDeEmpresa, sitio web:e.website, correo electrónicoDeFacturación:e.correoElectrónicoDeFacturación, prefijoDeClaveAPI:e.prefijoDeClaveAPI, límites:{cadenas:e.cadenaspermitidas, direccionesmáximas:e.direccionesmáximas, webhooksmáx:e.webhooksmáx, cuentasvirtualesmáx:e.accesoVirtual recuentos, rateLimit:e.rateLimit, monthlyQuota:e.monthlyQuota}, uso:{direcciones:d, webhooks:y, cuentas virtuales:m, solicitudes:o.totalRequests, unidades:Math.floor(o.totalUnits), costoUsd:o.costUsd.toFixed(4), cuota:{usado:c.usado, restante:c.restante, porcentajeUsado:Math.round(c.porcentajeUsado)}}, creadoEn:e.creadoEn, actualizadoEn:e.actualizadoEn}})}catch(e){console.error(\"Obtener Error de inquilino:\",e),a.status(500).json({éxito:!1,error:\"Error interno del servidor\"})}}),t.patch(\"/api/tenants/:id\",b,async(s,a)=>{try{if(s.tenant.id!==s.params.id)return a.status(403).json({éxito:!1,error:\"Solo puede actualizar su propia cuenta\",requestId:s.requestId});let e=s.body,o=[\"nombre\",\"nombreDeEmpresa\",\"sitio web\",\"correo electrónico de facturación\"],c={};for(let y of o)e[y]!==void 0&&(c[y]=e[y]);if(Object.keys(c).length===0)return a.status(400).json({éxito:!1,error:\"No hay campos válidos para actualizar\",requestId:s.requestId});let d=await p.updateTenant(s.params.id,c);if(!d)return a.status(404).json({éxito:!1,error:\"No se encontró el inquilino\"});await p.createAuditLog({tenantId:d.id,acción:\"inquilino.actualizado\",resource:\"inquilino\",resourceId:d.id,cambios:c,ipAddress:s.ip}),a.json({éxito:!0,inquilino:d,requestId:s.requestId})}catch(e){console.error(\"Actualizar inquilino error:\",e),a.status(500).json({éxito:!1,error:\"Error interno del servidor\"})}}),t.post(\"/api/tenants/:id/rotate-key\",b,async(s,a)=>{try{let e=await p.getTenant(s.params.id);if(!e)return a.status(404).json({éxito:!1,error:\"No se encontró el inquilino\"});if(s.tenant.id!==e.id)return a.status(403).json({éxito:!1,error:\"Solo puede rotar su propia clave API\",requestId:s.requestId});let{key:o,prefix:c,hash:d}=Ie();await p.updateTenant(e.id,{apiKeyPrefix:c,apiKeyHash:d}),await p.createAuditLog({tenantId:e.id,action:\"apikey.rotated\",resource:\"tenant\",resourceId:e.id,changes:{rotated:!0}}),a.json({success:!0,apiKey:o,warning:\"Guarde su nueva clave API. La clave anterior ya no es válida y no se puede recuperar.\",requestId:s.requestId})}catch(e){console.error(\"Error al rotar la clave API:\",e),a.status(500).json({success:!1,error:\"Servidor interno error\"})}}),t.patch(\"/api/admin/tenants/:id\",$,async(s,a)=>{try{let e=s.body;if(e.tier){let c=H[e.tier];c&&(e.allowedChains=c.chains,e.maxAddresses=c.maxAddresses,e.maxWebhooks=c.maxWebhooks,e.maxVirtualAccounts=c.maxVirtualAccounts,e.rateLimit=c.rateLimit,e.monthlyQuota=c.monthlyQuota)}let o=await p.updateTenant(s.params.id,e);if(!o)return a.status(404).json({éxito:!1,error:\"No se encontró el inquilino\"});await p.createAuditLog({Id.inquilino:o.id,acción:\"admin.tenant.updated\",recurso:\"inquilino\",Id.recurso:o.id,cambios:e,direcciónIP:s.ip}),a.json({éxito:!0,inquilino:o,Id.solicitud:s.Id.solicitud})}catch(e){console.error(\"El administrador actualiza el inquilino error:\",e),a.status(500).json({éxito:!1,error:\"Error interno del servidor\"})}}),t.post(\"/api/admin/tenants/:id/suspend\",$,async(s,a)=>{try{let e=await p.updateTenant(s.params.id,{status:\"suspendido\"});if(!e)return a.status(404).json({éxito:!1,error:\"Inquilino no encontrado\"});await p.createAuditLog({tenantId:e.id,action:\"admin.tenant.suspended\",resource:\"tenant\",resourceId:e.id,changes:{status:\"suspended\"},ipAddress:s.ip}),a.json({success:!0,message:\"Inquilino suspendido\",requestId:s.requestId})}catch(e){console.error(\"Error de suspensión del inqui
{"mensaje":"","atributos":{"nivel":"información"},"marca de tiempo":"2025-11-30T18:34:43.900126803Z"}
{"mensaje":"> rest-express@1.0.0 inicio","atributos":{"nivel":"información"},"marca de tiempo":"2025-11-30T18:34:43.900136941Z"}
{"mensaje":"> NODE_ENV=nodo de producción dist/index.js","atributos":{"nivel":"información"},"marca de tiempo":"2025-11-30T18:34:43.900144960Z"}
{"mensaje":"","atributos":{"nivel":"información"},"marca de tiempo":"2025-11-30T18:34:43.900151618Z"}
{"mensaje":"archivo:///app/dist/index.js:1","atributos":{"nivel":"error"},"marca de tiempo":"2025-11-30T18:34:44.723955455Z"}
{"mensaje":"var mt=Object.defineProperty;var fe=(n,t)=>()=>(n&&(t=n(n=0)),t);var xe=(n,t)=>{para(var r en t)mt(n,r,{obtener:t[r],enumerable:!0})};var J={};xe(J,{EnumeraciónDeCadena:()=>ft,PRECIOS:()=>le,CADENAS_SOPORTADAS:()=>me,EnumeraciónDeEstado:()=>yt,LÍMITES_DE_NIVEL:()=>H,EnumeraciónDeNivel:()=>gt,EVENTOS_DE_WEBHOOK:()=>Be,direcciones:()=>S,UsoDeAPI:()=>W,RegistrosDeAuditoría:()=>te,AgregacionesDeFacturación:()=>Q,CriptoTransacciones:()=>de,ConfiguraciónDeGas:()=>X,InsertarEsquemaDeDirección:()=>vt,InsertarEsquemaDeUsoDeAPI:()=>_t,InsertarLoCursoDeAuditoría gSchema:()=>xt,insertarEsquemaDeTransacciónCriptográfica:()=>At,insertarEsquemaDeMonederoMaestro:()=>It,insertarEsquemaDeInquilino:()=>bt,insertarEsquemaDeTransacción:()=>kt,insertarEsquemaDeCuentaVirtual:()=>wt,insertarEsquemaDeWebhook:()=>Tt,MonederosMaestros:()=>z,inquilinos:()=>x,RelacionesDeInquilinos:()=>ht,transacciones:()=>j,CuentasVirtuales:()=>_,webhooks:()=>K});import{sql como M}de\"drizzle-orm\";import{pgTable como q,texto como l,varchar como T,entero como E,booleano como Ve,marca de tiempo como R,jsonb como F,real como he,índice como v}de\"drizzle-orm/pg-core\";import{createInsertSchema como Y}de\"drizzle-zod\";import{z como Ke}de\"zod\";import{relaciones como pt}de\"drizzle-orm\";var gt,yt,ft,x,z,_,de,X,S,j,K,W,Q,te,ht,It,wt,At,bt,vt,kt,Tt,_t,xt,H,le,Be,me,D=fe(()=>{\"use estricto\";gt=Ke.enum([\"inicial\",\"escala\",\"empresa\"]),yt=Ke.enum([\"activo\",\"suspendido\",\"eliminado\"]),ft=Ke.enum([\"bitcoin\",\"ethereum\",\"solana\",\"polígono\",\"tron\",\"bsc\",\"ondulación\",\"cardano\",\"cerca\",\"polkadot\",\"avalancha\",\"arbitrum\",\"optimismo\",\"base\",\"fantom\",\"cronos\",\"cosmos\",\"algorand\"]),x=q(\"inquilinos\",{id:T(\"id\",{length:36}).primaryKey().default(M`gen_rand om_uuid()`), nombre: l(\"nombre\").notNull(), correo electrónico: l(\"correo electrónico\").notNull().único(), nivel: l(\"nivel\").notNull().predeterminado(\"inicial\"), estado: l(\"estado\").notNull().predeterminado(\"activo\"), apiKeyPrefix: T(\"api_key_prefix\",{longitud: 16}).notNull(), apiKeyHash: l(\"api_key_hash\").notNull().único(), hmacSecret: l(\"hmac_secret\").notNull(), allowedChains: l(\"allowed_chains\").array().notNull().predeterminado(M`ARRAY['bitcoin', 'ethereum', 'solana']`), direcciones máximas: E(\"direcciones máximas\").notNull().default(50), webhooks máximos: E(\"webhooks máximos\").notNull().default(1), cuentas virtuales máximas: E(\"cuentas virtuales máximas\").notNull().default(0), límite de tasa: E(\"límite de tasa\").notNull().default(10), cuota mensual: E(\"cuota mensual\").notNull().default(1e4), correo electrónico de facturación: l(\"correo electrónico de facturación\"), nombre de la empresa:l(\"nombre_de_la_empresa\"),sitio_web:l(\"sitio_web\"),lista_blanca_de_ip:l(\"lista_blanca_de_ip\").array(),metadatos:F(\"metadatos\"),createdAt:R(\"created_at\").defaultNow().notNull(),updatedAt:R(\"updated_at\").defaultNow().notNull()},n=>[v(\"id_de_correo_electrónico_de_inquilinos\").on(n.email),v(\"id_hash_de_clave_de_API_de_inquilinos\").on(n.apiKeyHa sh),v(\"idx_estado_inquilinos\").on(n.estado)]),z=q(\"monederos_principales\",{id:T(\"id\",{longitud:36}).clave_primaria().predeterminado(M`gen_random_uuid()`),escenario:l(\"escenario\").notNull(),cadena_de_bloques:l(\"cadena_de_bloques\").notNull(),tipo_de_activo:l(\"tipo_de_activo\").notNull(),nombre_de_activo:l(\"nombre_de_activo\").notNull(),dirección:l( \"dirección\").notNull().unique(),clavepública:l(\"clave pública\"),claveprivadacifrada:l(\"clave privada cifrada\"),claveprivadaIV:T(\"clave privadaIV\",{longitud:32}),etiquetadeautenticacióndeclaveprivada:T(\"etiquetadeautenticacióndeclaveprivada\",{longitud:32}),direccióndecontratointeligente:l(\"direccióndecontratointeligente\"),decimalesdetoken:E(\"decimalesdetoken \"),assignedToTenantId:T(\"id_asignado_al_inquilino\",{length:36}).references(()=>x.id),balance:l(\"saldo\").default(\"0\"),balanceUsd:l(\"saldo_usd\").default(\"0\"),lastSyncTime:R(\"última_sincronización\"),gasMarkupPercentage:E(\"porcentaje_de_margen_de_gas\").default(40),status:l(\"estado\").notNull().de fallo(\"activo\"), metadatos: F(\"metadatos\"), creado en: R(\"creado_en\"). predeterminadoAhora(). no nulo(), actualizado en: R(\"actualizado_en\"). predeterminadoAhora(). no nulo()}, n => [v(\"masters_blockchain_idx\"). en(n. cadena de bloques), v(\"masters_asset_idx\"). en(n. nombre_activo), v(\"masters_address_idx\"). en(n. dirección), v(\"masters_inquilino _idx\").on(n.assignedToTenantId),v(\"masters_scenario_idx\").on(n.scenario)]),_=q(\"cuentas_virtuales\",{id:T(\"id\",{longitud:36}).primaryKey().default(M`gen_random_uuid()`),tenantId:T(\"tenant_id\",{longitud:36}).notNull().references(()=>x.id,{onDelete:\"cascade\"}),accountType:l(\"tipo_de_cuenta\").n otNull(),saldos:F(\"saldos\").predeterminado(M`'{}'`),estado:l(\"estado\").notNull().predeterminado(\"activo\"),congelado:Ve(\"congelado\").predeterminado(!1),metadatos:F(\"metadatos\"),createdAt:R(\"creado_en\").defaultNow().notNull(),updatedAt:R(\"actualizado_en\").defaultNow().notNull()},n=>[v(\"inquilino_de_cuentas_virtuales_i dx\").on(n.Id_de_inquilino),v(\"id_de_estado_de_cuentas_virtualesx\").on(n.estado)]),de=q(\"transacciones_criptográficas\",{id:T(\"id\",{longitud:36}).clave_primaria().predeterminado(M`gen_random_uuid()`),Id_de_inquilino:T(\"id_de_inquilino\",{longitud:36}).notNull().referencias(()=>x.id,{onDelete:\"cascada\"}),tipo:l(\"tipo\").notNull(),escenario:l(\"escenario\").notNull(),fromAccountId:T(\"from_account_id\",{longitud:36}),toAccountId:T(\"to_count_id\",{longitud:36}),toExternalAddress:l(\"to_external_address\"),fromExternalAddress:l(\"from_external_address\"),assetType:l(\"tipo_de_activo\").notNull(),assetName:l(\"nombre_de_activo\").notNull(),blockchain:l(\"blockchain\").notNull(),amount:l(\"mount\"). notNull(),gasReal:l(\"gas_real\"),gasMarkupPercent:E(\"gas_markup_percent\"),gasCharged:l(\"gas_charged\"),commissionAmount:l(\"commission_mont\"),commissionUsd:l(\"comission_usd\"),status:l(\"status\").notNull().default(\"pending\"),txHash:l(\"tx_hash\").unique(),blockNumber:E(\"block_number\"),confirmations:E(\"confirmations\"),metadata:F(\"me tadata\"), creado en: R(\"creado_en\"). predeterminadoAhora(). no nulo(), ejecutado en: R(\"ejecutado_en\"), confirmado en: R(\"confirmado_en\")}, n => [v(\"idx_de_inquilino_de_transacción_criptográfica\"). en(n. id_de_inquilino), v(\"idx_de_tipo_de_transacción_criptográfica\"). en(n. tipo), v(\"idx_de_estado_de_transacción_criptográfica\"). en(n. estado), v(\"idx_hash_de_transacción_criptográfica\"). en(n. hash_de_transacción), v(\"idx_de_escenario_de_transacción_criptográfica\"). en(n. escenario)]), X = q(\"setti_gas ngs\",{id:T(\"id\",{longitud:36}).primaryKey().default(M`gen_random_uuid()`),marcadopredeterminadoglobal:E(\"marcadopredeterminadoglobal\").default(40),marcadomín:E(\"marcadomín\").default(10),marcadomáx:E(\"marcadomáx\").default(100),anulacionesdecliente:F(\"anulacionesdecliente\").default(M`'{}'`),multiplicadoresdecadenadebloques:F(\"multiplicadoresdecadenadebloques\").default(M`'{\"ethereum\": 1.0, \"polígono\": 0.3}'`),Anulaciones de tipo de transacción:F(\"anulaciones de tipo de transacción\").predeterminado(M`'{\"retiro_cripto\": 40, \"transferencia_de_token\": 45}'`),updatedAt:R(\"updated_at\").defaultNow().notNull(),updatedBy:l(\"updated_by\")},n=>[v(\"gas_settings_updated_idx\").on(n.updatedAt)]),S=q(\"direcciones\",{id:T(\"id\",{longitud:36}).primaryKey().default(M`gen_random_uuid()`),tenantId:T(\"tenant_id\",{longitud:36}).notNull().references(()=>x.id,{onDelete:\"cascade\"}),chain:l(\"cadena\").notNull(),currency:l(\"currency\").notNull(),address: l(\"dirección\").notNull(),publicKey:l(\"clave_pública\"),derivationPath:l(\"ruta_derivación\"),label:l(\"etiqueta\"),tags:l(\"etiquetas\").array().default(M`ARRAY[]::text[]`),status:l(\"estado\").notNull().default(\"activo\"),balance:l(\"balance\").default(\"0\"),balanceUsd:l(\"balance_usd\").default(\"0\"),lastSynced:R(\"last_synced\"),webhookUrl:l(\"webhook_url\"),metadatos:F(\"metadatos\"),createdAt:R(\"creado_en\").defaultNow().notNull(),actualizadoEn:R(\"actualizado_en\").defaultNow().notNull(),eliminadoEn:R(\"eliminado_en\")},n=>[v(\"direcciones_idx_de_inquilino\").on(n.Id_de_inquilino),v(\"direcciones_idx_de_cadena\").on(n.cadena),v(\"direcciones_idx_de_estado\").on(n.estado),v(\"direcciones_idx_de_dirección\").on(n.dirección)] ),j=q(\"transacciones\",{id:T(\"id\",{longitud:36}).primaryKey().default(M`gen_random_uuid()`),tenantId:T(\"id_tenant\",{longitud:36}).notNull().references(()=>x.id,{onDelete:\"cascade\"}),txHash:l(\"tx_hash\").notNull(),chain:l(\"cadena\").notNull(),fromAddress:l(\"from_address\"),toAddress:l(\"t o_dirección\"), importe: l(\"importe\").notNull(), moneda: l(\"moneda\").notNull(), cuota: l(\"cuota\"), cuotaUsd: l(\"cuota_usd\"), estado: l(\"estado\").notNull().default(\"pendiente\"), tipo: l(\"tipo\").notNull().default(\"nativo\"), númerodebloque: E(\"númerodebloque\"), confirmaciones: E(\"confirmaciones\").default(0 ), metadatos: F(\"metadatos\"), creado en: R(\"creado_en\"). predeterminado ahora(). no nulo()}, n => [v(\"idx_de_inquilino_de_transacciones\"). en(n. ID_de_inquilino), v(\"idx_de_cadena_de_transacciones\"). en(n. cadena), v(\"idx_de_hash_de_transacciones\"). en(n. Hash_de_tx), v(\"idx_de_estado_de_transacciones\"). en(n. estado)]), K = q(\"webhooks\", {id: T(\"id\", {le longitud: 36}). claveprimaria(). predeterminado(M`gen_random_uuid()`), ID_inquilino: T(\"ID_inquilino\",{longitud: 36}). no nulo(). referencias(()=>x.id,{onDelete:\"cascada\"}), URL: l(\"URL\"). no nulo(), eventos: l(\"eventos\"). matriz(). no nulo(), secreto_hmac: l(\"secreto_hmac\"). no nulo(), activo: Ve(\"activo\"). predeterminado(!0), reintentarCou nt:E(\"retry_count\").default(0),lastTriggered:R(\"last_triggered\"),lastStatus:E(\"last_status\"),metadatos:F(\"metadatos\"),createdAt:R(\"created_at\").defaultNow().notNull()},n=>[v(\"webhooks_tenant_idx\").on(n.tenantId),v(\"webhooks_active_idx\").on(n.active)]),W=q(\"api_usage\",{id:T(\"id \",{longitud:36}).primaryKey().default(M`gen_random_uuid()`),tenantId:T(\"tenant_id\",{longitud:36}).notNull().references(()=>x.id,{onDelete:\"cascade\"}),endpoint:l(\"endpoint\").notNull(),method:l(\"method\").notNull(),chain:l(\"chain\"),action:l(\"action\").notNull(),units:he(\"units\").notN ull(), créditos:he(\"créditos\").notNull(), código de estado:E(\"código de estado\").notNull(), id de solicitud:T(\"id de solicitud\",{longitud:36}).notNull(), tiempo de respuesta Ms:E(\"ms de tiempo de respuesta\"), metadatos:F(\"metadatos\"), marca de tiempo:R(\"marca de tiempo\").defaultNow().notNull()}, n=>[v(\"id de inquilino de uso de API\").on(n.id de inquilino),v(\"api_usage_timestamp_idx\").on(n.timestamp),v(\"api_usage_action_idx\").on(n.action)]),Q=q(\"agregaciones_de_facturación\",{id:T(\"id\",{longitud:36}).primaryKey().default(M`gen_random_uuid()`),tenantId:T(\"id_de_teniente\",{longitud:36}).notNull().references(()=>x.id,{onDelete:\"cascade\"}),periodo:l(\"periodo\").notNull(),periodType:l(\"tipo_de_periodo\").notNull().default(\"diario\"),totalUnits:he(\"unidades_totales\").notNull().def ault(0), totalCredits:he(\"total_créditos\").notNull().default(0), costUsd:he(\"costo_usd\").notNull().default(0), breakdown:F(\"break\"), createdAt:R(\"created_at\").defaultNow().notNull()}, n=>[v(\"billing_tenant_period_idx\").on(n.tenantId,n.period)]), te=q(\"audit_logs\",{id:T(\"id\",{length:36}).primaryKey().default(M`gen_random_uuid()`), tenantId:T(\"tenant_id\",{length:36}).references(()=>x.id,{onDelete:\"set null\"}),ID_usuario:l(\"id_usuario\"),acción:l(\"acción\").notNull(),recurso:l(\"recurso\").notNull(),ID_recurso:l(\"id_recurso\"),cambios:F(\"cambios\"),Dirección_IP:l(\"dirección_IP\"),Agente_usuario:l(\"agente_usuario\"),ID_solicitud:T(\"id_solicitud\",{longitud:36}),marca_de_tiempo:R(\"marca_de_tiempo\").defaultNow().notNull()},n=>[v(\"audit_logs_tenant_idx\").on(n.Id_tenant),v(\"audit_logs_timestamp_idx\").on(n.marca_de_tiempo),v(\"audit _logs_action_idx\").on(n.action)]),ht=pt(x,({muchos:n})=>({direcciones:n(S),transacciones:n(j),webhooks:n(K),cuentasvirtuales:n(_),apiUsage:n(W),agregacionesdefacturación:n(Q),registrosdeauditoría:n(te),monederosprincipales:n(z),criptotransacciones:n(de)})),It=Y(z).omit({id:!0,createdAt:!0,updatedAt:!0}),wt=Y(_).omit({id:!0,createdAt:!0,updatedAt:!0}),At=Y(de).omit({id:!0,createdAt:!0,executedAt:!0,confirmedAt:!0}),bt=Y(x).omit({ id:!0,createdAt:!0,updatedAt:!0}),vt=Y(S).omit({id:!0,createdAt:!0,updatedAt:!0,deletedAt:!0}),kt=Y(j).omit({id:!0,createdAt:!0}),Tt=Y(K).omit({id:!0,createdAt:!0}),_t=Y(W).omit({id:!0,timestamp:!0}),xt=Y(te).omit({id:!0,timestamp:!0}),H={starter:{chains:[\"bitcoin\",\"ethereum\",\"solana\"],maxAddresses:50,maxWebhooks:1,maxVirtualAccounts:0,rateLimit:10,monthlyQuota:1e4,kmsAllowed:!1,archivalAccess :!1, días de retención: 1}, escala: {cadenas: [\"bitcoin\",\"ethereum\",\"solana\",\"polígono\",\"tron\",\"bsc\",\"ripple\",\"cardano\"], direcciones máximas: 1e3, webhooks máximos: 10, cuentas virtuales máximas: 5, límite de tasa: 100, cuota mensual: 1e5, km permitidos:!0, acceso de archivo:!1, días de retención: 7}, empresa: {cadenas: [\"bitcoin\",\"ethereum\",\"solana\",\"polígono\",\"tron\",\"bsc\",\"ripple\",\"cardano\",\"near\",\"polkadot\",\"avalancha\",\"arbitro\",\"optimismo\",\"base\",\"fantasma\",\"cronos\",\"cosmos\",\"algorand\"],máximo de direcciones: -1,máximo de webhooks: -1,máximo de cuentas virtuales: 50,límite de tasa: 1e3,cuota mensual: -1,km permitidos: !0,acceso de archivo: !0,días de retención: 30}},le={creación de dirección:{unidades: 1,costo: 0,001},consulta de saldo:{unidades: 0,costo: 5e-4},saldo de token:{unidades: 1,costo: 0,001},metadatos nft:{unidades: 2,costo: 0,002},tx_br oadcast_btc:{unidades: 50, costo: 0,05}, tx_broadcast_eth:{unidades: 10, costo: 0,01}, tx_broadcast_other:{unidades: 10, costo: 0,01}, tx_history:{unidades: 2, costo: 0,002}, webhook_subscription:{unidades: 0,02, costo: 0,02}, va_create:{unidades: 100, costo: 0,1}, va_transfer:{unidades: 5, costo: 0,005}, tipo de cambio:{unidades: 0,1, costo: 1e-4}, web3_resolve:{unidades: 1, costo: 0,001}, malicioso_check:{unidades: 2, costo: 0,002}, rpc_standard:{u nits:2,costo:2e-4},rpc_eth_call:{unidades:5,costo:5e-4},rpc_debug:{unidades:50,costo:.005}},Be=[\"TRANSACCIÓN_DIRECCIÓN\",\"SALDO_DIRECCIÓN\",\"TRANSACCIÓN_NATIVA_ENTRANTE\",\"TRANSACCIÓN_NATIVA_SALIENTE\",\"TRANSACCIÓN_FUNGIBLE_ENTRANTE\",\"TRANSACCIÓN_FUNGIBLE_SALIENTE\",\"TRANSACCIÓN_NFT_ENTRANTE\",\"TRANSACCIÓN_NFT_SALIENTE\",\"TRANSACCIÓN_MULTITOKEN_ENTRANTE\",\"TRANSACCIÓN_MULTITOKEN_SALIENTE\",\"TRANSACCIÓN_FALLIDA\",\"CUOTA_PAGADA\",\"REGISTRO_DE_CONTRATO _EVENTO\"],me=[{id:\"bitcoin\",nombre:\"Bitcoin\",símbolo:\"BTC\",icono:\"\\u20BF\"},{id:\"ethereum\",nombre:\"Ethereum\",símbolo:\"ETH\",icono:\"\\u039E\"},{id:\"solana\",nombre:\"Solana\",símbolo:\"SOL\",icono:\"\\u25CE\"},{id:\"polígono\",nombre:\"Polígono\",símbolo:\"MATIC\",icono:\"\\u2B21\"},{id:\"tron\",nombre:\"Tron\",símbolo:\"TRX\",icono:\"\\u2666\"},{id:\"bsc\",nombre:\"BNB Cadena\", símbolo:\"BNB\", icono:\"\\u25C6\"},{id:\"ripple\", nombre:\"XRP Ledger\", símbolo:\"XRP\", icono:\"\\u2715\"},{id:\"cardano\", nombre:\"Cardano\", símbolo:\"ADA\", icono:\"\\u20B3\"},{id:\"near\", nombre:\"NEAR\", símbolo:\"NEAR\", icono:\"\\u24C3\"},{id:\"polkadot\", nombre:\"Polkadot\", símbolo:\"DOT\", icono:\"\\u25CF\"},{id:\"avalanche\", nombre:\"Avalanche\", símbolo:\"AVAX\", icono:\"\\u25B2\"},{id:\"arb itrum\", nombre:\"Arbitrum\", símbolo:\"ARB\", icono:\"\\u25C8\"},{id:\"optimism\", nombre:\"Optimism\", símbolo:\"OP\", icono:\"\\u2295\"},{id:\"base\", nombre:\"Base\", símbolo:\"ETH\", icono:\"\\u25EF\"},{id:\"fantom\", nombre:\"Fantom\", símbolo:\"FTM\", icono:\"\\u25C7\"},{id:\"cronos\", nombre:\"Cronos\", símbolo:\"CRO\", icono:\"\\u25CE\"},{id:\"cosmos\",nombre:\"Cosmos\",símbolo:\"ATOM\",icono:\"\\u269B\"},{id:\"algorand\",nombre:\"Algorand\",símbolo:\"ALGO\",icono:\"\\u24B6\"}]});var oe={};xe(oe,{db:()=>f,pool:()=>Ye});import{Pool como St,neonConfig como Pt}desde\"@neondatabase/serverless\";import{drizzle como Rt}desde\"drizzle-orm/neon-serverless\";import Et desde\"ws\";var Ye,f,V=fe(()=>{\"use strict\";D();Pt.webSocketConstructor=Et;if(!process.env.DATABASE_URL)throw new Error(\"DATABASE_URL debe ser ¿Olvidaste aprovisionar una base de datos?\"); Ye=new St({connectionString:process.env.DATABASE_URL}), f=Rt({client:Ye,schema:J})}); function jt(n){return!n||typeof n!=\"string\"||n.length<32?!1:/^[a-zA-Z0-9_-]{32,}$/.test(n)} function Bt(){return P.state===\"open\"?Date.now()-P.lastFailure>=$e.resetTimeoutMs?(P.state=\"half-open\",P.successesInHalfOpen=0,!0):!1:!0} function Dt(){P.estado===\"semiabierto\"?(P.éxitosEnMedioApertura++,P.éxitosEnMedioApertura>=$e.umbralDeÉxitoDeAperturaMedia&&(P.estado=\"cerrado\",P.fallos=0)):P.fallos=0}función ze(){P.fallos++,P.últimoFallo=Fecha.ahora(),(P.estado===\"semiabierto\"||P.fallos>=$e.umbralDeFallo)&&(P.estado=\"abierto\")}función Ut(n,t){devolver t.EstadosReintentables.includes(n)}función Xe(n,t){devolver Math.min(t.baseDelayMs*Math.pow(2,n)+Math.random()*1e3,t.maxDelayMs)}función asíncrona Qe(n){devuelve nueva Promesa(t=>setTimeout(t,n))}función asíncrona N(n,t={},r=Kt){si(!Bt())devuelve{éxito:!1,error:\"Servicio temporalmente no disponible (disyuntor abierto)\",statusCode:503};let i=null;for(let u=0;u<=r.maxRetries;u++)try{let g=new AbortController,h=setTimeout(()=>g.abort(),3e4),s=await fetch(`${Mt}${n}`,{...t,señal:g.señal,encabezados:{\"Tipo-Contenido\":\"aplicación/json\",\"clave-x-api\":Fe||\"\",...t.encabezados}});clearTimeout(h);let a=await s.json().catch(()=>null);if(!s.ok){let e={éxito:!1,error:a?.mensaje||a?.error||`HTTP ${s.estado}`,código-estado:s.estado};if(s.estado===429){let o=s.headers.get(\"Retry-After\");o&&(e.retryAfter=parseInt(o,10)*1e3)}if(Ut(s.status,r)&&u<r.maxRetries){i=e;let o=e.retryAfter||Xe(u,r);await Qe(o);continue}return ze(),e}return Dt(),{éxito:!0,datos:a}}catch(g){let h=g.name===\"Error de cancelación\",s=g.message?.includes(\"obtener\")||g.message?.includes(\"red\"),a={éxito:!1,error:h?\"Tiempo de espera de la solicitud\":g.message||\"Red error\",statusCode:h?408:500};if((h||s)&&u<r.maxRetries){i=a,await Qe(Xe(u,r));continue}return ze(),a}return i||{éxito:!1,error:\"Se excedió el máximo de reintentos\",statusCode:500}}function Je(n){return me.find(t=>t.id===n)}var Mt,Fe,Kt,P,$e,se,B,Oe=fe(()=>{\"use strict\";D();Mt=process.env.TATUM_API_URL||\"https://api.tatum.io\",Fe=process.env.TATUM_API_KEY;Fe?jt(Fe)||console.warn(\"El formato de TATUM_API_KEY parece no ser válido; puede causar errores de API\"):console.warn(\"TATUM_API_KEY no configurado; las llamadas a la API fail\"); Kt={máx.Reintentos:3,Ms.deRetardoBase:1e3,Ms.deRetardoMax:3e4,EstadosReintentables:[408,429,500,502,503,504]}, P={fallos:0,últimoFallo:0,estado:\"cerrado\",éxitosEnMedioApertura:0}, $e={UmbralDeFallo:5,Ms.deRestablecimientoTiempoDeEspera:6e4,UmbralDeÉxitoEnMedioApertura:2}; se={bitcoin:\"bitcoin\",ethereum:\"ethereum\",solana:\"solana\",polygon:\"polígono\",tron:\"tron\",bsc:\"bsc\",ri pple:\"xrp\",cardano:\"ada\",near:\"near\",polkadot:\"dot\",avalanche:\"avax\",arbitrum:\"arbitrum-one\",optimismo:\"optimismo\",base:\"base\",fantom:\"fantom\",cronos:\"cro\",c osmos:\"atom\",algorand:\"algo\"},B={getCircuitBreakerState(){return{...P}},resetCircuitBreaker(){P.failures=0,P.lastFailure=0,P.state=\"closed\",P.successesInHalfOpen=0},async generateAddress(n){let t=se[n]||n;return N(`/v3/${t}/wallet`,{método:\"GET\"})},async getBalance(n,t){let r=se[n]||n;return[\"ethereum\",\"polígono\",\"bsc\",\"arbitrum-one\",\"optimism\",\"base\"].includes(r)?N(`/v3/${r}/account/balance/${t}`):N(r===\"bitcoin\"?`/v3/bitcoin/address/balance/${t}`:r===\"solana\"?`/v3/solana/account/balance/${t}`:`/v3/${r}/account/balance/${t}`)},async getTokens(n,t){let r=se[n]||n;devuelve N(`/v3/data/tokens?chain=${r}&addresses=${t}`)},asincrónico obtenerNFTs(n,t){let r=se[n]||n;devuelve N(`/v3/data/nfts?chain=${r}&addresses=${t}`)},asincrónico obtenerHistorialDeTransacciones(n,t,r){let i=se[n]||n,u=nuevosParámetrosDeBúsquedaDeURL;devuelve r?.TamañoDePágina&&u.set(\"TamañoDePágina\",r.TamañoDePágina.toString()),r?.Desplazamiento&&u.set(\"Desplazamiento\",r.Desplazamiento.toString()),N(`/v3/data/transacciones?chain=${i}&addresses=${t}&${u.toString()}`)},asincrónico getTransaction(n,t){let r=se[n]||n;devuelve N(`/v3/${r}/transaction/${t}`)},async estimateFee(n,t=\"TRANSFER\"){let r=se[n]||n;devuelve N(`/v3/${r}/gas/estimate`,{método:\"POST\",cuerpo:JSON.stringify({tipo:t})})},async broadcastTransaction(n,t){let r=se[n]||n;devuelve N(`/v3/${r}/broadcast`,{método:\"POST\",cuerpo:JSON.stringify({txData:t})})},async getExchangeRates(n){let t=n.join(\",\");devuelve N(`/v3/tatum/rate/${t}?basePair=USD`)}, asíncrono resolveWeb3Name(n){devuelve N(`/v3/blockchain/names/${n}`)}, asíncrono checkMaliciousAddress(n){devuelve N(`/v3/security/address/${n}`)}, asíncrono createWebhook(n){devuelve N(\"/v4/subscription\",{método:\"POST\",cuerpo:JSON.stringify(n)})}, asíncrono deleteWebhook(n){devuelve N(`/v4/subscription/${n}`,{método:\"DELETE\"})}, asíncrono getWebhooks(){devuelve N(\"/v4/subscription\")},async healthCheck(){let n=await N(\"/v3/tatum/version\"); return n.success?{success:!0, data:{status:\"healthy\", version:n.data?.version||\"v3\", circuitBreaker:{...P}}}:{...n, data:{status:\"degraded\", version:\"unknown\", circuitBreaker:{...P}}}}}});var ve={};xe(ve,{GasFeeManager:()=>Ee,gasFeeManager:()=>Le});import{eq as Ge}from\"drizzle-orm\";var Ee,Le,ge=fe(()=>{\"use strict\";V();D();Ee=class{config=null;async loadConfig(){let[t]=await f.select().from(X).limit(1);if(!t){let r={Margen predeterminado global: 40, Margen mínimo: 10, Margen máximo: 100, Anulaciones de cliente:{}, Multiplicadores de cadena de bloques:{ethereum: 1, polígono: .3, bitcoin: 1.2, solana: .1, arbitraje: .2}, Anulaciones de tipo de transacción:{retiro_cripto: 40, transferencia_de_token: 45, contrato_inteligente: 60}};return this.config=r,r}return this.config={globalDefaultMarkup:t.globalDefaultMarkup,minMarkup:t.minMarkup,maxMarkup:t.maxMarkup,clientOverrides:t.clientOverrides||{},blockchainMultipliers:t.blockchainMultipliers||{},transactionTypeOverrides:t.transactionTypeOverrides||{}},this.config}async calculateGasMarkup(t){this.config||await this.loadConfig();let r=this.config.globalDefaultMarkup;if(t.clientId&&this.config.clientOverrides[t.clientId]){let a=this.config.clientOverrides[t.clientId];if(a.expiresAt){let e=new Date(a.expiresAt);new Date<e&&(r=a.markup)}else r=a.markup}let i=this.config.transactionTypeOverrides[t.transactionType];i&&(r=i);let u=this.config.blockchainMultipliers[t.blockchain]||1;r=Math.round(r*u),r=Math.max(this.config.minMarkup,Math.min(this.config.maxMarkup,r));let g=t.gasReal*(r/100),h=t.gasReal+g,s=g;return{gasReal:t.gasReal,gasMarkupPercent:r,gasCharged:h,yourProfit:s}}async updateGlobalMarkup(t,r){t=Math.max(10,Math.min(100,t)),await f.update(X).set({globalDefaultMarkup:t,updatedAt:new Fecha,actualizadoPor:r}).donde(Ge(X.id,\"predeterminado\")),this.config=null,await this.loadConfig()}async setClientMarkup(t,r,i,u,g){this.config||await this.loadConfig();let h=this.config.clientOverrides;h[t]={markup:Math.max(10,Math.min(100,r)),reason:i,expiresAt:g?.toISOString()},await f.update(X).set({clientOverrides:h,actualizadoEn:new Fecha,actualizadoPor:u}).donde(Ge(X.id,\"predeterminado\")),this.config=null,await this.loadConfig()}async removeClientMarkup(t,r){this.config||await this.loadConfig();let i=this.config.clientOverrides;eliminar i[t],esperar f.update(X).set({clientOverrides:i,actualizadoEn:nueva Fecha,actualizadoPor:r}).where(Ge(X.id,\"predeterminado\")),this.config=null,esperar this.loadConfig()}getConfig(){devolver this.config}},Le=new Ee});var ke={};xe(ke,{CryptoGateway:()=>Ne,cryptoGateway:()=>Ht});importar Lt desde\"crypto\";importar{eq como G y como Wt} desde\"drizzle-orm\";var Ne,Ht,Te=fe(()=>{\"usar estricto\";Oe();ge();V();D();Ne=class{async createVirtualAccount(t,r){devolver(esperar f.insert(_).values({Id.inquilino:t,TipoDeCuenta:r,Saldos:JSON.stringify({})}).returning())[0]}async internalSwap(t){let r=await f.query.virtualAccounts.findFirst({where:G(_.id,t.fromAccountId)});if(!r)throw new Error(\"No se encontró la cuenta\");let i=JSON.parse(r.balances||\"{}\"),u=parseFloat(i[t.assetName]||\"0\");if(u<parseFloat(t.fromAmount))throw new Error(\"Saldo insuficiente\");let g=parseFloat(t.toAmount)*.005,h=parseFloat(t.toAmount)-g,s={...i};s[t.assetName]=(u-parseFloat(t.fromAmount)).toString(),await f.update(_).set({balances:JSON.stringify(s)}).where(G(_.id,t.fromAccountId));let a=espera f.consulta.cuentasvirtuales.findFirst({donde:G(_.id,t.toAccountId)}),e=JSON.parse(a?.balances||\"{}\");devuelve e[t.nombreDeActivo]=(parseFloat(e[t.nombreDeActivo]||\"0\")+h).toString(),espera f.update(_).set({balances:JSON.stringify(e)}).donde(G(_.id,t.toAccountId)),{txId:(espera f.insert(de).values({Id.inquilino:t.Id.inquilino,tipo:\"intercambio_interno\",escenario:t.scenario,Id.deCuenta:t.deCuenta,Id.deCuenta:t.deCuenta,Tipo.deActivo:\"cripto\",Nombre.deActivo:t.deActivo,cadena.de.blockchain:t.blockchain,importe:t.deImporte,importe.de.comisión:g.de.Cadena(),comisión.Usd:(g*45e3).de.Cadena(),estado:\"completado\"}).returning())[0].id,estado:\"completado\",deImporte:t.deImporte,de.Importe:t.de.Importe,comisión:g.de.Fijo(8),neto.Recibido:h.de.Fijo(8),ejecutadoEn:nuevaFecha().de.CadenaISO()}}asincrónico externalWithdraw(t){let r=await f.query.masterWallets.findFirst({where:Wt(G(z.assetName,t.assetName),G(z.blockchain,t.blockchain),G(z.scenario,t.scenario))});if(!r)throw new Error(`No se encontró la billetera maestra para ${t.assetName} en ${t.blockchain}`);let i=await B.estimateGas({blockchain:t.blockchain,assetType:t.assetName===r.smartContractAddress?\"token\":\"crypto\",amount:t.amount}),u=await Le.calculateGasMarkup({clientId:t.tenantId,blockchain:t.blockchain,transactionType:t.assetName===\"BTC\"?\"crypto_withdraw\":\"token_transfer\",gasReal:i.gasReal}),g=await f.query.virtualAccounts.findFirst({where:G(_.id,t.fromAccountId)}),h=JSON.parse(g?.balances||\"{}\"),s=parseFloat(h[t.assetName]||\"0\");if(s<parseFloat(t.amount))throw new Error(\"Saldo insuficiente\");h[t.assetName]=(s-parseFloat(t.amount)).toString(),await f.update(_).set({balances:JSON.stringify(h)}).where(G(_.id,t.fromAccountId));let a=`0x${Lt.randomBytes(32).toString(\"hex\")}`;return{txId:(await f.insert(de).values({Id.inquilino:t.inquilino,tipo:\"retiro_externo\",escenario:t.scenario,toExternalAddress:t.toExternalAddress,tipo.activo:\"cripto\",nombre.activo:t.nombre.activo,blockchain:t.blockchain,cantidad:t.cantidad,gasReal:u.gasReal.toString(),porcentaje.de.margen.gas:u.porcentaje.de.margen.gas,gasCargado :u.gasCharged.toString(),commissionAmount:u.yourProfit.toString(),status:\"pendiente\",txHash:a}).returning())[0].id,status:\"pendiente_de_confirmación\",txHash:a,amount:t.amount,gasReal:u.gasReal.toFixed(8),gasCharged:u.gasCharged.toFixed(8),yourProfit:u.yourProfit.toFixed(8),estimatedTime:\"12 segundos\"}}async assignMasterToClient(t,r,i){return await f.update(z).set({assignedToTenantId:r,gasMarkupPercentage:i}).where(G(z.id,t)),{success:!0,masterId:t,assignedTo:r,gasMarkup:i,assignedAt:new Date().toISOString()}}async getVirtualAccountBalance(t){let r=await f.query.virtualAccounts.findFirst({where:G(_.id,t)});if(!r)throw new Error(\"Cuenta no encontrada\");let i=JSON.parse(r.balances||\"{}\"); return{accountId:t,balances:i,totalUsd:Object.entries(i).reduce((u,[g,h])=>{let s={ETH:2500,BTC:45e3,GOLD:500,SILVER:250}; return u+parseFloat(h)*(s[g]||0)},0)}}},Ht=new Ne});import Ce de\"express\";import{z como w} de\"zod\";D();V();import{eq como A,and como Z,desc como ie,sql como De,gte como Nt,lte como Ct} de\"drizzle-orm\";var Ue=class{async getTenant(t){let[r]=await f.select().from(x).where(A(x.id,t));return r||void 0}async getTenantByApiKeyHash(t){let[r]=await f.select().from(x).where(A(x.apiKeyHash,t));return r||void 0}async getTenantByEmail(t){let[r]=await f.select().from(x).where(A(x.email,t));return r||void 0}async getAllTenants(){return f.select().from(x).orderBy(ie(x.createdAt))}async createTenant(t){let[r]=await f.insert(x).values(t).returning();return r}async updateTenant(t,r){let[i]=await f.update(x).set({...r,updatedAt:nueva fecha}).where(A(x.id,t)).returning();devolver i||void 0}async deleteTenant(t){await f.update(x).set({estado:\"eliminado\",updatedAt:nueva fecha}).where(A(x.id,t))}async getAddress(t){let[r]=await f.select().from(S).where(A(S.id,t));devolver r||void 0}async getAddressByAddress(t,r,i){let[u]=await f.select().from(S).where(Z(A(S.tenantId,t),A(S.chain,r),A(S.address,i)));devolver u||void 0}async getAddressesByTenant(t,r){let i=f.select().from(S).where(A(S.tenantId,t)),u=[A(S.tenantId,t)];devuelve r?.chain&&u.push(A(S.chain,r.chain)),r?.status&&u.push(A(S.status,r.status)),f.select().from(S).where(Z(...u)).orderBy(ie(S.createdAt)).limit(r?.limit||50).offset(r?.offset||0)}asincrónico countAddressesByTenant(t){let[r]=await f.select({count:De`count(*)`}).from(S).where(Z(A(S.tenantId,t),A(S.status,\"active\")));devuelve r?.count||0}asincrónico createAddress(t){let[r]=await f.insert(S).values(t).returning();return r}async updateAddress(t,r){let[i]=await f.update(S).set({...r,updatedAt:nueva fecha}).where(A(S.id,t)).returning();return i||void 0}async archiveAddress(t){await f.update(S).set({estado:\"archivado\",eliminadoAt:nueva fecha,updatedAt:nueva fecha}).where(A(S.id,t))}async getTransaction(t){let[r]=await f.select().from(j).where(A(j.id,t));return r||void 0}async getTransactionByHash(t,r){let[i]=await f.select().from(j).where(Z(A(j.chain,t),A(j.txHash,r)));return i||void 0}async getTransactionsByTenant(t,r){let i=[A(j.tenantId,t)];return r?.chain&&i.push(A(j.chain,r.chain)),r?.status&&i.push(A(j.status,r.status)),f.select().from(j).where(Z(...i)).orderBy(ie(j.createdAt)).limit(r?.limit||50).offset(r?.desplazamiento||0)}asincrónico createTransaction(t){let[r]=await f.insert(j).values(t).returning();devolver r}asincrónico updateTransaction(t,r){let[i]=await f.update(j).set(r).where(A(j.id,t)).returning();devolver i||void 0}asincrónico getWebhook(t){let[r]=await f.select().from(K).where(A(K.id,t));devolver r||void 0}asincrónico getWebhooksByTenant(t){devolver f.select().from(K).where(A(K.tenantId,t)).orderBy(ie(K.createdAt))}asincrónico countWebhooksByTenant(t){let[r]=await f.select({count:De`count(*)`}).from(K).where(Z(A(K.tenantId,t),A(K.active,!0)));devuelve r?.count||0}asinc createWebhook(t){let[r]=await f.insert(K).values(t).returning();devuelve r}asinc updateWebhook(t,r){let[i]=await f.update(K).set(r).where(A(K.id,t)).returning();devuelve i||void 0}asinc deleteWebhook(t){await f.delete(K).where(A(K.id,t))}asinc getVirtualAccount(t){let[r]=await f.select().from(_).where(A(_.id,t));devuelve r||void 0}asinc obtenerCuentasVirtualesPorInquilino(t){devolver f.seleccionar().de(_).donde(A(_.IdInquilino,t)).ordenarPor(ie(_.createdAt))}asincrónico contarCuentasVirtualesPorInquilino(t){let[r]=await f.seleccionar({count:De`count(*)`}).de(_).donde(Z(A(_.IdInquilino,t),A(_.estado,\"activo\")));devolver r?.count||0}asincrónico crearCuentaVirtual(t){let[r]=await f.insertar(_).valores(t).devolver();devolver r}asincrónico actualizarCuentaVirtual(t,r){let[i]=await f.actualizar(_).set(r).donde(A(_.id,t)).devolver();devolver i||void 0}asincrónico recordApiUsage(t){let[r]=await f.insert(W).values(t).returning();return r}async getApiUsageByTenant(t,r,i){return f.select().from(W).where(Z(A(W.tenantId,t),Nt(W.timestamp,r),Ct(W.timestamp,i))).orderBy(ie(W.timestamp))}async getApiUsageStats(t,r,i){let u=await this.getApiUsageByTenant(t,r,i),g={},h={},s=0,a=0;for(let e of u)s+=e.unidades,a+=e.créditos,g[e.punto final]=(g[e.punto final]||0)+1,e.cadena&&(h[e.cadena]=(h[e.cadena]||0)+1);return{totalRequests:u.length,totalUnits:s,totalCredits:a,byEndpoint:g,byChain:h}}async getBillingAggregation(t,r){let[i]=await f.select().from(Q).where(Z(A(Q.tenantId,t),A(Q.periodo,r)));return i||void 0}async upsertBillingAggregation(t){let r=await this.getBillingAggregation(t.tenantId,t.periodo);if(r){let[i]=await f.update(Q).set(t).where(A(Q.id,r.id)).returning();return i}else{let[i]=await f.insert(Q).values(t).returning();return i}}async createAuditLog(t){let[r]=await f.insert(te).values(t).returning();return r}async getAuditLogsByTenant(t,r=100){return f.select().from(te).where(A(te.tenantId,t)).orderBy(ie(te.timestamp)).limit(r)}},p=new Ue;Oe();import ce from\"crypto\";D();var Ze=process.env.ADMIN_API_KEY;function Ie(){let n=`tatum_${ce.randomBytes(28).toString(\"hex\")}`,t=n.substring(0,16),r=tt(n);devolver{clave:n,prefijo:t,hash:r}}función tt(n){devolver ce.createHash(\"sha256\").update(n).digest(\"hex\")}función we(){devolver ce.randomBytes(32).toString(\"hex\")}función st(){devolver`req_${ce.randomBytes(16).toString(\"hex\")}`}función asíncrona b(n,t,r){n.requestId=st(),t.setHeader(\"X-Request-ID\",n.requestId);deje que i=n.headers[\"x-api-key\"]; if(!i)return t.status(401).json({success:!1,error:\"Clave API faltante\",requestId:n.requestId});let u=tt(i),g=await p.getTenantByApiKeyHash(u); if(!g)return t.status(401).json({success:!1,error:\"Clave API no válida\",requestId:n.requestId}); if(g.status!==\"activo\")return t.status(403).json({success:!1,error:`La cuenta es ${g.status}`,requestId:n.requestId});n.tenant=g,r()}function $(n,t,r){n.requestId=st(),t.setHeader(\"X-Request-ID\",n.requestId);let i=n.headers[\"x-admin-key\"];if(!Ze)return t.status(503).json({éxito:!1,error:\"API de administración no configurada\",requestId:n.requestId});if(!i)return t.status(401).json({éxito:!1,error:\"Falta la clave de API de administración\",requestId:n.requestId});let u=ce.createHash(\"sha256\").update(i).digest(\"hex\"),g=ce.createHash(\"sha256\").update(Ze).digest(\"hex\");if(!ce.timingSafeEqual(Buffer.from(u),Buffer.from(g)))return t.status(401).json({éxito:!1,error:\"Clave de API de administrador no válida\",requestId:n.requestId});n.isAdmin=!0,r()}var et=new Map;function k(n,t,r){if(!n.tenant)return r();let i=n.tenant.id,u=Date.now(),g=1e3,h=et.get(i);(!h||h.resetAt<u)&&(h={count:0,resetAt:u+g},et.set(i,h)),h.count++;let s=n.tenant.rateLimit,a=Math.max(0,sh.count);if(t.setHeader(\"X-RateLimit-Límite\",s),t.setHeader(\"X-RateLimit-Restante\",a),t.setHeader(\"X-RateLimit-Restablecer\",Math.ceil(h.resetAt/1e3)),h.count>s)return t.status(429).json({éxito:!1,error:\"Límite de tasa excedido\", requestId:n.requestId,retryAfter:Math.ceil((h.resetAt-u)/1e3)});r()}función en(n){return(t,r,i)=>{if(!t.tenant)return r.status(401).json({éxito:!1,error:\"Se requiere autenticación\", requestId:t.requestId});let u=H[t.tenant.tier];if(!u)return r.status(403).json({éxito:!1,error:\"Configuración de nivel no válida\", requestId:t.requestId});if(n===\"kms\"&&!u.kmsAllowed)return r.status(403).json({éxito:!1,error:\"KMS no está disponible en Su nivel. Actualice a Scale o Enterprise.\",requestId:t.requestId,upgrade:!0});if(n===\"archival\"&&!u.archivalAccess)return r.status(403).json({success:!1,error:\"El acceso a archivos no está disponible en su nivel. Actualice a Enterprise.\",requestId:t.requestId,upgrade:!0});i()}}function Ae(n,t,r){if(!n.tenant)return r();let i=n.params.chain||n.body?.chain;if(!i)return r();let g=H[n.tenant.tier]?.chains||n.tenant.allowedChains;if(!g.includes(i))return t.status(403).json({success:!1,error:`La cadena '${i}' no está disponible en su nivel`,allowedChains:g,requestId:n.requestId,upgrade:!0});r()}D();función asíncrona nt(){if(!process.env.SEED_DEMO_DATA)return null;console.log(\"Comprobando si hay un inquilino de demostración...\");let n=await p.getTenantByEmail(\"demo@tatum-gateway.io\");if(n)return console.log(\"El inquilino de demostración ya existe\"),n;console.log(\"Creando inquilino de demostración...\"); let{prefix:t,hash:r}=Ie(),i=H.scale,u=await p.createTenant({name:\"Cuenta de demostración\",email:\"demo@tatum-gateway.io\",tier:\"scale\",status:\"active\",apiKeyPrefix:t,apiKeyHash:r,hmacSecret:we(),allowedChains:i.chains,maxAddresses:i.maxAddresses,maxWebhooks:i.maxWebhooks,maxVirtualAccounts:i.maxVirtualAccounts,rateLimit:i.rateLimit,monthlyQuota:i.monthlyQuota,companyName:\"Demostración de Tatum Gateway\",website:\"https://tatum.io\"});console.log(\"Inquilino de demostración creado:\",u.id),await p.createAuditLog({Id.inquilino:u.id,acción:\"inquilino.creado\",recurso:\"inquilino\",Id.recurso:u.id,cambios:{nivel:\"escala\",origen:\"semilla\"}});para(dejar g=0;g<10;g++)esperar p.recordApiUsage({Id.inquilino:u.id,punto final:`/api/v1/${[\"direcciones\",\"saldos\",\"tokens\",\"transacciones\"][g%4]}`,método:[\"OBTENER\",\"POST\"][g%2],cadena:[\"ethereum\",\"bitcoin\",\"solana\",\"polígono\"][g%4],acción:[\"saldo consulta_de_ance\",\"creación_de_dirección\",\"saldo_de_token\",\"historial_de_transacciones\"][g%4],unidades:[.5,1,1,2][g%4],créditos:[5e-4,.001,.001,.002][g%4],código_de_estado:200,id_de_solicitud:`demo_${g}`,tiempo_de_respuestaMs:50+Math.floor(Math.random()*100)});retorno console.log(\"¡Datos de uso de demostración sembrados!\"),u}D();función O(n){return async(t,r,i)=>{if(!t.tenant)return i();let u=le[n];t.metered={acción:n,unidades:u.units,créditos:u.cost};let g=r.json.bind(r);r.json=h=>{let s=Date.now();return p.recordApiUsage({Id.inquilino:t.id.inquilino, punto final:t.ruta, método:t.método, cadena:t.params.cadena||t.cuerpo?.cadena||nulo, acción:n, unidades:u.unidades, créditos:u.costo, código de estado:r.código de estado, Id.solicitud:t.id.solicitud, tiempo de respuesta:Fecha.ahora()-s, metadatos:{agente-usuario:t.encabezados[\"agente-usuario\"], ip:t.ip}}).catch(consola.error),h&&tipo de h==\"objeto\"&&(h.meta={...h.meta, Id.solicitud:t.id.solicitud, marca de tiempo:nueva Fecha().toISOString(),medido:{acción:n,unidades:u.unidades,créditos:u.costo}}),g(h)},i()}}función asíncrona be(n){let t=nueva fecha,r=nueva fecha(t.getFullYear(),t.getMonth(),1),i=await p.getApiUsageStats(n,r,t);return{totalRequests:i.totalRequests,totalUnits:i.totalUnits,totalCredits:i.totalCredits,costUsd:i.totalCredits}}función asíncrona Se(n,t){if(t===-1)return{permitido:!0,usado:0,restante:-1,porcentajeUsado:0};let r=await ser(n),i=Math.floor(r.totalUnits),u=ti,g=i/t*100;devolver{permitido:u>0,usado:i,restante:Math.max(0,u),porcentajeUsado:Math.min(100,g)}}función ae(n,t,r){si(!n.inquilino)devolver r();Se(n.inquilino.id,n.inquilino.cuotamensual).entonces(i=>{si(t.setHeader(\"X-Cuota-Usada\",i.usada),t.setHeader(\"X-Cuota-Restante\",i.restante),t.setHeader(\"X-Cuota-Porcentaje\",Math.round(i.porcentajeUsado)),!i.permitido)devolver t.status(429).json({success:!1,error:\"Cuota mensual excedida\",requestId:n.requestId,quota:{used:i.used,limit:n.tenant.cuotamensual,porcentajeUsado:i.porcentajeUsado},actualización:!0});r()}).catch(()=>r())}D();importar Ft desde\"crypto\";var $t=1e5,Ot=32,qt=\"sha256\",ne=null,pe=class n{secretomaestro;versión;createdAt;estático SALT_PREFIXES={claveprivada:\"kms:clave_privada:v1\",carteramaestra:\"kms:cartera_maestra:v1\",secretohmac:\"kms:secretohmac:v1\",derivacióndeclaveapi:\"kms:claveapi:v1\",cifradodesesión:\"kms:sesión:v1\"};constructor(t,r=1){if(!t||t.length<32)arrojar nuevo Error(\"El secreto maestro debe ser al menos 32 bytes (usar: openssl rand -hex 16)\");this.masterSecret=t,this.version=r,this.createdAt=new Date,t.length<64&&console.warn(\"\\u26A0\\uFE0F ADVERTENCIA: El secreto del KMS maestro tiene menos de 64 bytes. Considere usar: openssl rand -hex 32\")}static initialize(t){let r=t||process.env.MASTER_KMS_SECRET||process.env.SESSION_SECRET;if(!r)throw new Error(\"Variable de entorno MASTER_KMS_SECRET no establecida. Generar con: openssl rand -hex 32\");return ne||(ne=new n(r),console.log(\"\\u2705 KMS inicializado con secreto maestro\"),ne)}static getInstance(){return ne||(ne=n.initialize()),ne}deriveKey(t,r=\"\"){let i=n.SALT_PREFIXES[t];if(!i)throw new Error(`Tipo de clave desconocida: ${t}`);let u=Buffer.from(`${i}:${r}`);return{key:Ft.pbkdf2Sync(this.masterSecret,u,$t,Ot,qt),version:this.version,keyType:t}}derivePrivateKeyEncryptionKey(t){return this.deriveKey(\"privateKey\",t).key}deriveMasterWalletKey(t){return this.deriveKey(\"masterWallet\",t).key}deriveHmacKey(t){return this.deriveKey(\"hmacSecret\",t).key}deriveSessionEncryptionKey(t){return this.deriveKey(\"sessionEncryption\",t).key}getConfig(){return{masterSecret:\"[CENSURADO]\",version:this.version,createdAt:this.createdAt}}rotate(t){let r=new n(t,this.version+1);return ne=r,console.log(`\\u2705 KMS rotado a la versión ${r.version}`),r}static test(){try{let t=n.getInstance(),r=t.deriveKey(\"privateKey\",\"test-wallet-1\"),i=t.deriveKey(\"privateKey\",\"test-wallet-1\");if(r.key.toString(\"hex\")!==i.key.toString(\"hex\"))throw new Error(\"La derivación de la clave KMS no es determinista\");let u=t.deriveKey(\"privateKey\",\"test-wallet-2\");if(r.key.toString(\"hex\")===u.key.toString(\"hex\"))throw new Error(\"Colisión de derivación de clave KMS detectada\");return console.log(\"\\u2705 Autoprueba de KMS aprobada\"),!0}catch(t){return console.error(\"\\u274C Autoprueba de KMS fallida:\",t),!1}}};try{pe.initialize()}catch(n){console.warn(\"\\u26A0\\uFE0F Advertencia de inicialización de KMS:\",n)}import qe from\"crypto\";var Pe=\"aes-256-gcm\",Re=32,Gt=16;function rt(n,t,r){if(t.length!==Re)throw new Error(`La clave de cifrado debe ser de ${Re} bytes`);let i=qe.randomBytes(Gt),u=qe.createCipheriv(Pe,t,i);r&&u.setAAD(Buffer.from(r));let g=Buffer.concat([u.update(n,\"utf8\"),u.final()]),h=u.getAuthTag();return{ciphertext:g.toString(\"hex\"),iv:i.toString(\"hex\"),authTag:h.toString(\"hex\"),algorithm:Pe}}function ot(n,t,r){if(t.length!==Re)throw new Error(`La clave de cifrado debe tener ${Re} bytes`);if(n.algorithm!==Pe)throw new Error(`Algoritmo no compatible: ${n.algorithm}`);let i=Buffer.from(n.iv,\"hex\"),u=Buffer.from(n.ciphertext,\"hex\"),g=Buffer.from(n.authTag,\"hex\"),h=qe.createDecipheriv(Pe,t,i);r&&h.setAAD(Buffer.from(r)),h.setAuthTag(g);try{return Buffer.concat([h.update(u),h.final()]).toString(\"utf8\")}catch{throw new Error(\"Error de descifrado: los datos pueden estar dañados o alterados\")}}import{sql como Vt}desde\"drizzle-orm\";import{webcrypto como it}desde\"crypto\";var Yt=w.object({nombre:w.string().min(2),correo electrónico:w.string().correo electrónico(),nivel:w.enum([\"starter\",\"scale\",\"enterprise\"]).predeterminado(\"starter\"),nombreDeEmpresa:w.string().opcional(),sitio web:w.string().url().opcional(),correo electrónico de facturación:w.string().correo electrónico().opcional()}),zt=w.object({cadena:w.string(),etiqueta:w.string().opcional(),etiquetas:w.array(w.string()).opcional(),URLdelwebhook:w.string().url().opcional()}),Xt=w.object({url:w.string().url(),eventos:w.array(w.enum(Be)).min(1)});función asíncrona ct(n,t){nt().catch(console.error),t.get(\"/\",(s,a)=>{a.json({name:\"Tatum API Gateway\",version:\"1.0.0\",description:\"API Gateway de blockchain de nivel empresarial compatible con más de 130 blockchains\",status:\"running\",documentation:\"GET /api/docs | GET /api/docs/model | GET /api/docs/examples\",quickStart:\"1. Obtener la clave API del administrador | 2. Agregar el encabezado 'x-api-key: YOUR_KEY' | 3. Enviar por POST a /api/tenants para registrarse\",endpoints:{health:\"GET /api/health\",pricing:\"GET /api/pricing\",chains:\"GET /api/chains\",tenants:\"GET /api/tenants | POST /api/inquilinos\", direcciones:\"GET /api/v1/direcciones | POST /api/v1/direcciones\", transacciones:\"GET /api/v1/transacciones\", webhooks:\"POST /api/v1/webhooks | GET /api/v1/webhooks\", puerta de enlace:\"POST /api/v1/puerta de enlace/cuentas-virtuales | GET /api/v1/puerta de enlace/cuentas-virtuales | POST /api/v1/puerta de enlace/intercambio | POST /api/v1/puerta de enlace/retiro\", administrador:\"GET /api/admin/configuración-gas | PUT /api/admin/configuración-gas/global | GET /api/admin/ingresos | GET /api/admin/transacciones\", rwa:\"POST /api/v1/rwa/tokens | GET /api/v1/rwa/tokens | POST /api/v1/rwa/tokens/:id/transfer\"},businessModel:{type:\"Puerta de enlace API de doble panel (100 % de ingresos de administración)\",panels:{cryptoPanel:{description:\"Control de billetera maestra con sistema de cuentas virtuales\",revenueStreams:{internalSwaps:\"0,5 % de comisión (sin comisiones de gas)\",gasMarkup:\"40 % de margen configurable sobre las comisiones de gas\",setupFees:\"$500 por cliente de RWA\"},annualRevenue:\"$204K (Y1) \\u2192 $1.02M (Y2) \\u2192 $2.04M (Y3)\"}, rwaPanel:{description:\"Infraestructura de tokenización de activos del mundo real\",revenueStreams:{setupFees:\"$500 por token (pago único)\",nnualFees:\"$200 por token al año\",tradingCommissions:\"0.5% del volumen total de operaciones (100% para administración)\"},annualRevenue:\"$654K (Y1) \\u2192 $8.07M (Y2) \\u2192 $60.21M (Y3)\"}},profitMargins:\"82.5% (Y1) \\u2192 91.2% (Y2) \\u2192 96,8 % (año 3)\", totalProjections:{año 1:\"$858 000\", año 2:\"$9,09 000\", año 3:\"$62,25 000\"}}, auth:{type:\"Clave API + HMAC\", method:\"x-api-key header (Tatum v3 recommended)\", example:\"curl -H 'x-api-key: YOUR_API_KEY' https://api.example.com/api/v1/...\", documentation:\"https://docs.tatum.io/docs/authentication\"}, rateLimit:\"Por nivel: Starter 10/s, Scale 100/s, Enterprise 1000/seg\",docs:\"https://api.tatum.io/docs\",github:\"https://github.com/MasterFital/tatum-api-gateway\"})}),t.get(\"/api/docs/model\",(s,a)=>{a.json({title:\"Tatum API Gateway - Modelo de Negocio\",introduction:\"Arquitectura de doble panel que genera el 100% de ingresos administrativos mediante el trading de criptomonedas y la tokenización de RWA\",panels:{crypto:{name:\"Panel CRYPTO (100% de tus ingresos)\",description:\"Controlas las billeteras maestras (BTC, ETH, SOL, MATIC). Los clientes operan a través de cuentas virtuales.\",how_it_works:{step1:\"El administrador crea billeteras maestras mediante POST /api/admin/master-wallets\",step2:\"Los clientes crean cuentas virtuales mediante POST /api/v1/gateway/virtual-accounts\",paso 3:\"Los clientes pueden intercambiar internamente (comisión del 0,5 % para usted) o retirar externamente (margen de beneficio del 40 %)\",paso 4:\"El administrador registra todos los ingresos mediante GET /api/admin/revenue\"},revenue_streams:{internal_swaps:{description:\"El cliente intercambia BTC \\u2192 ETH\",fee:\"0,5 % del importe del intercambio\",gas_cost:\"Cero (interno)\",admin_profit:\"100 % de la comisión\",example:\"El cliente intercambia 1 ETH \\u2192 0,02 BTC | Comisión: 0,0001 BTC (100 % para el administrador)\"},gas_markup:{description:\"El cliente retira criptomonedas a una billetera externa\",fee:\"Margen de beneficio del 40 % sobre el gas real costo\", ejemplo:\"Gas Bitcoin: $3 reales | Cobras: $4.20 | Tu ganancia: $1.20 (40%)\"}}, proyecciones:{año1:{volumen:\"Promedio de 1 millón de USD/mes\", swaps mensuales:\"5K \\xD7 0.5% = $25K\", gas mensual:\"Retiros de 10K \\xD7 $3 \\xD7 40% = $12K\", total mensual:\"$17K\", anual:\"$204K\"}, año2:{volumen:\"Promedio de 5 millones de USD/mes\", anual:\"$1.02M\"}, año3:{volumen:\"Promedio de 10 millones de USD/mes\", anual:\"$2.04M\"}}}, rwa:{nombre:\"Panel RWA (100% Tus Ingresos + Tarifas)\", descripción:\"Los clientes emiten tokens. Tú proporcionas la infraestructura. Te quedas con el 100% de las tarifas y comisiones de trading.\", cómo_funciona:{paso 1:\"El cliente solicita la creación de un token: POST /api/v1/rwa/tokens\", paso 2:\"Cobras $500 de comisión de configuración + implementación del contrato inteligente\", paso 3:\"El token se activa. Los clientes operan internamente (comisión del 0,5 % para ti)\", paso 4:\"Comisión anual de mantenimiento de $200 por token\", paso 5:\"Todos los retiros externos tienen un margen de gas del 40 % (para ti)\", paso 6:\"Seguimiento de los ingresos mediante GET /api/admin/rwa-revenue\"},revenue_streams:{setup_fees:{description:\"Comisión única por token lanzado\",amount:\"$500\",frequency:\"Por token\"},annual_fees:{description:\"Mantenimiento anual por token activo\",amount:\"$200\",frequency:\"Por token por año\"}, comisiones_comerciales:{descripción:\"0.5% del volumen total de operaciones de tokens (100% para el administrador)\", porcentaje:\"0.5%\", ejemplo:\"Volumen de tokens: $100,000/mes | Su comisión: $500/mes = $6,000/año por token\"}, margen_gas:{descripción:\"40% de margen en las comisiones de gas para retiros externos\", porcentaje:\"40%\"}}, beneficios_del_cliente:{beneficio1:\"Infraestructura de tokenización (su costo: ~$0.10 por token)\", beneficio2:\"Mercado listo para usar\", beneficio3:\"Liquidez instantánea (operadores del día 1)\", beneficio4:\"Seguridad y cumplimiento a su cargo\", pago_del_cliente:\"$500 de configuración + $200/año solo\"}, proyecciones:{año1:{tokens:\"20 tokens nuevos\", tarifas_de_configuración:\"20 \\xD7 $500 = $10K\", tarifas_anuales:\"20 \\xD7 $200 = $4K\", comisiones_de_operación:\"0.5% de un volumen de ~$100M = $500K\", total:\"$514K\"}, año2:{tokens:\"100 tokens en total\", tarifas_de_configuración:\"100 \\xD7 $500 = $50K\", tarifas_anuales:\"100 \\xD7 $200 = $20K\", comisiones_de_operación:\"0.5% de un volumen de ~$1.6B = $8M\",total:\"$8.07M\"},año3:{tokens:\"300 tokens en total\",tarifas_de_configuración:\"300 \\xD7 $500 = $150K\",tarifas_anuales:\"300 \\xD7 $200 = $60K\",comisiones_de_comercio:\"0.5% de un volumen de ~$12B = $60M\",total:\"$60.21M\"}}}},resumen_de_ingresos:{título:\"Ingresos combinados (Cripto + RWA)\",año 1:{cripto:\"$204K\",rwa:\"$654K\",total:\"$858K\",margen:\"82.5%\"},año 2:{cripto:\"$1.02M\",rwa:\"$8.07M\",total:\"$9.09M\",margen:\"91.2%\"},año 3:{cripto:\"$2.04M\",rwa:\"$60.21M\",total:\"$62.25M\",margen:\"96.8%\"}},puntos_clave:[\"El 100% de todos los ingresos van al administrador (usted)\",\"Los clientes obtienen acceso a la infraestructura, no a la repartición de ingresos\",\"Las tarifas de configuración son ingresos inmediatos\",\"Las comisiones de trading escalan infinitamente con el volumen\",\"El margen de gas es puro beneficio (costo mínimo de infraestructura)\",\"Costo de adquisición de clientes cero (los clientes se traen a sí mismos)\"]})}),t.get(\"/api/docs/examples\",(s,a)=>{a.json({title:\"Tatum API Gateway - Ejemplos de uso\",autenticación: {descripción:\"Todas las solicitudes requieren el encabezado x-api-key\",ejemplo:\"curl -H 'x-api-key: YOUR_API_KEY' https://api.example.com/api/v1/...\",encabezados:{\"x-api-key\":\"Su clave API del administrador\",\"Content-Type\":\"application/json\"}},crypto_examples: {título:\"Ejemplos del panel CRYPTO\",create_virtual_account: {descripción:\"El cliente crea una cuenta virtual para almacenar criptomonedas\",endpoint:\"POST /api/v1/gateway/virtual-accounts\",solicitud:{tipoDeCuenta:\"individual\"},respuesta:{éxito:!0,cuentaVirtual:{id:\"va-123\",identificadorDeInquilino:\"cliente-1\",tipoDeCuenta:\"individual\",saldos:{BTC:\"0\",ETH:\"0\",SOL:\"0\"},estado:\"activo\"}}},interno_swap_0_5_percent:{descripción:\"El cliente intercambia BTC por ETH (comisión del 0,5 % para el administrador)\",punto final:\"POST /api/v1/gateway/swap\", solicitud: {fromAccountId:\"va-123\", fromAsset:\"BTC\", toAsset:\"ETH\", importe:\"1.0\"}, respuesta: {éxito:!0, intercambio: {id:\"swap-456\", fromAsset:\"BTC\", toAsset:\"ETH\", importe:\"1.0\", comisión:\"0.005 BTC (0.5% para el administrador)\", estado:\"completado\"}, nota:\"Sin comisiones de gas, comisión del 0.5% aplicada\"}}, external_withdraw_40_percent_markup: {descripción:\"El cliente retira a una billetera externa (40% de margen de gas para el administrador)\", punto final:\"POST /api/v1/gateway/withdraw\", solicitud: {fromAccountId:\"va-123\", activo:\"ETH\", importe:\"1.0\", dirección:\"0x1234567890abcdef...\"}, respuesta: {éxito:!0, retiro: {id:\"withdraw-789\", activo:\"ETH\", importe:\"1.0\", dirección:\"0x1234567890abcdef...\", gasReal:\"3 USD\", gasCharged:\"4.20 USD (40% de margen)\", adminProfit:\"1.20 USD\", estado:\"pendiente\", txHash:\"0xabcd...\"}}}, ver_historial_de_transacciones: {descripción:\"El cliente visualiza su transacción historial\", punto final:\"GET /api/v1/transactions?limit=50\", respuesta:{éxito:!0, transacciones:[{id:\"swap-456\", tipo:\"internal_swap\", activo:\"BTC\", importe:\"1.0\", comisión:\"0.005\", estado:\"completado\", creado el:\"2024-11-30T10:00:00Z\"}], paginación:{total:42, límite:50, desplazamiento:0}}}}, ejemplos_rwa:{título:\"Ejemplos de paneles RWA\", crear_rwa_token_500_setup:{descripción:\"El cliente crea un token (paga $500 de tarifa de configuración al administrador)\", punto final:\"POST /api/v1/rwa/tokens\",solicitud:{nombreDeActivo:\"Fondo Inmobiliario\",símbolo:\"REF\",cadenaDeBlockchain:\"Ethereum\",decimales:18,suministroTotal:\"1000000\",nombreDeEmisor:\"RE Properties Inc\",descripción:\"Inversión Inmobiliaria Tokenizada\"},respuesta:{éxito:!0,token:{id:\"token-ref-1\",nombreDeActivo:\"Fondo inmobiliario\", símbolo:\"REF\", cadena de bloques:\"ethereum\", suministro total:\"1000000\", dirección del contrato inteligente:\"0x...\", estado:\"creado\"}, precios: {tarifa de configuración:\"$500 (pago único) - PAGADO AL ADMINISTRADOR\", tarifa anual:\"$200/año - PAGADO AL ADMINISTRADOR\", comisión de negociación:\"0.5% en todas las operaciones - 100% PARA EL ADMINISTRADOR\"}}}, lista_rwa_tokens: {descripción:\"El cliente visualiza sus tokens y volumen de operaciones\", punto final:\"GET /api/v1/rwa/tokens\", respuesta: {éxito:!0, tokens:[{id:\"token-ref-1\", nombre_del_activo:\"Bienes raíces Fondo\", símbolo:\"REF\", cadena de bloques:\"ethereum\", oferta total:\"1000000\", estado:\"activo\", tarifa de configuración:\"500, tarifa anual:\"200, volumen de negociación:\"250000 USD\", comisión de negociación:\"1250 USD (0,5 % para el administrador)\"}], resumen:{totalTokens:\"1, comisiones de negociación totales:\"1250 USD (100 % para el administrador)\", tarifas de configuración cobradas:\"500 USD (100 % para el administrador)\"}}}, rwa_token_transfer_0_5_percent:{descripción:\"El titular del token negocia el token REF (0,5 % de comisión para el administrador)\", punto final:\"POST /api/v1/rwa/tokens/token-ref-1/transfer\",request:{toAddress:\"0xabcd...\",amount:\"100\"},response:{success:!0,transfer:{id:\"transfer-123\",tokenId:\"token-ref-1\",amount:\"100 REF\",toAddress:\"0xabcd...\",commission:\"0.5 REF (0.5% para el administrador)\",status:\"completed\",txHash:\"0x...\"},note:\"0.5% de comisión de trading aplicada y cobrada por el administrador\"}}},admin_examples:{title:\"Ejemplos del panel de administración\",view_revenue:{description:\"El administrador visualiza los ingresos totales (swaps + margen de gas)\",endpoint:\"GET /api/admin/revenue\",respuesta:{éxito:!0,cryptoRevenue:{totalSwapCommissions:\"1245.67 USD\",totalGasMarkupRevenue:\"3456.78 USD\",totalVolume:\"249000 USD\",revenueByBlockchain:{ethereum:\"2345.67\",polygon:\"1234.56\",bitcoin:\"3456.78\"}}}},view_rwa_revenue:{description:\"El administrador visualiza los ingresos de RWA (comisiones de configuración + anuales + de trading)\",endpoint:\"GET /api/admin/rwa-revenue\",respuesta:{éxito:!0,rwaRevenue:{setupFees:{count:12,total:\"6000 USD\", Tarifas anuales: {Clientes activos: 12, Total: 2400 USD\", Comisiones por operaciones: {Este mes: 12500 USD\", Este año: 125000 USD\", Tasa: 0,5 % del volumen total de operaciones\", Ingresos mensuales totales: 15000 USD\", Seguridad: {Autenticación: encabezado x-api-key (recomendado Tatum v3)\", Cifrado: Todas las claves privadas cifradas con AES-256\", Auditoría: Todas las transacciones registradas con registro de auditoría completo\", Límite de tasa: Starter 10/s, Scale 100/s, Enterprise 1000/seg\",documentación:\"https://docs.tatum.io/docs/authentication\"}})}),t.get(\"/api/test-tatum\",async(s,a)=>{try{let e=await B.healthCheck(),o={success:e.success,message:e.success?\"\\u2705 Conectado a la API de Tatum correctamente\":\"\\u274C Error al conectarse a la API de Tatum\",tatumApiUrl:process.env.TATUM_API_URL||\"https://api.tatum.io\",apiKeyConfigured:!!process.env.TATUM_API_KEY,apiKeyLength:process.env.TATUM_API_KEY?.length||0,timestamp:new Date().toISOString()};e.success&&e.data&&(o.blockchainInfo={chain:e.data.chain,blocks:e.data.blocks,mempool:e.data.mempool}),e.error&&(o.error=e.error,o.statusCode=e.statusCode),a.json({success:e.success,test:\"Prueba de conexión a la API de Tatum\",status:o,instructions:{production:\"Configure la variable de entorno TATUM_API_KEY con su API de producción de Tatum key\",documentation:\"https://docs.tatum.io/docs/authentication\",getApiKey:\"https://dashboard.tatum.io\"},requestId:s.requestId})}catch(e){a.status(500).json({success:!1,test:\"Prueba de conexión de la API de Tatum\",error:e.message,message:\"Error al probar la conexión de Tatum\",instructions:{checkApiKey:\"Asegúrese de que TATUM_API_KEY esté configurado en las variables de entorno\",checkUrl:\"Verifique que TATUM_API_URL esté correct\",documentation:\"https://docs.tatum.io/docs/authentication\"},requestId:s.requestId})}}),t.get(\"/api/docs\",(s,a)=>{a.json({title:\"Tatum API Gateway - Documentación completa\",message:\"Para obtener más información, visite estos puntos finales de la documentación:\",available_docs:{business_model:\"GET /api/docs/model - Explicación completa de los flujos de ingresos\",examples:\"GET /api/docs/examples - Ejemplos de uso para Crypto y RWA\",tatum_test:\"GET /api/test-tatum - Conexión de prueba a la API de Tatum (verificación de producción)\",this_endpoint:\"GET /api/docs - Esta página\",api_root:\"GET / - Información de la API y descripción general del modelo de negocio\"},quick_endpoints:{\"Crypto Panel\":[\"POST /api/v1/gateway/virtual-accounts - Crear cuenta virtual\",\"POST /api/v1/gateway/swap - Swap interno (comisión del 0,5%)\",\"POST /api/v1/gateway/withdraw - Retiro externo (margen de beneficio del 40%)\",\"GET /api/v1/transactions - Historial de transacciones\"],\"Panel RWA\":[\"POST /api/v1/rwa/tokens - Crear token (comisión de instalación de 500$)\",\"GET /api/v1/rwa/tokens - Listar tokens\",\"POST /api/v1/rwa/tokens/:id/transfer - Intercambio de tokens (comisión del 0,5%)\"],Admin:[\"GET /api/admin/revenue - Panel de ingresos de criptomonedas\",\"GET /api/admin/rwa-revenue - Panel de ingresos de RWA\",\"GET /api/admin/master-wallets - Lista de billeteras maestras\",\"POST /api/admin/master-wallets - Crear billetera maestra\"]},authentication:{method:\"x-api-key header\",example:\"Authorization: x-api-key YOUR_API_KEY\",documentation:\"https://docs.tatum.io/docs/authentication\"},support:{github:\"https://github.com/MasterFital/tatum-api-gateway\",tatum_docs:\"https://api.tatum.io/docs\",api_reference:\"https://docs.tatum.io/reference/welcome-to-the-tatum-api-reference\"}})}),t.get(\"/api/health\",async(s,a)=>{let e=await B.healthCheck();a.json({éxito:!0,estado:\"saludable\",servicios:{api:\"saludable\",base de datos:\"saludable\",tatum:e.success?\"saludable\":\"degradado\"},marca de tiempo:nueva Fecha().toISOString()})}), t.get(\"/api/pricing\",(s,a)=>{a.json({éxito:!0,precios:le,niveles:Object.entries(H).map(([e,o])=>({id:e,...o,precios:{starter:{mensual:0,incluido:1e4},escala:{mensual:99,incluido:1e5},empresa:{mensual:\"personalizado\",incluido:\"ilimitado\"}}[e]}))})}), t.get(\"/api/cadenas\",(s,a)=>{a.json({éxito:!0,cadenas:me,total:me.length})}), t.post(\"/api/inquilinos\",async(s,a)=>{try{let e=Yt.parse(s.body);if(await p.getTenantByEmail(e.email))return a.status(409).json({éxito:!1,error:\"Correo electrónico ya registrado\"});let{key:c,prefix:d,hash:y}=Ie(),m=H[e.tier],I=await p.createTenant({nombre:e.nombre,correo electrónico:e.correo electrónico,nivel:e.nivel,estado:\"activo\",apiKeyPrefix:d,apiKeyHash:y,hmacSecret:we(),allowedChains:[...m.cadenas],maxAddresses:m.maxAddresses,maxWebhooks:m.maxWebhooks,maxVirtualAccounts:m.maxVirtualAccounts,rateLimit:m.rateLimit,monthlyQuota:m.monthlyQuota,companyName:e.companyName,website:e.website,billingEmail:e.billingEmail});await p.createAuditLog({tenantId:I.id,action:\"tenant.created\",resource:\"tenant\",resourceId:I.id,changes:{tier:e.tier}}),a.status(201).json({success:!0,tenant:{id:I.id,name:I.name,email:I.email,tier:I.tier,status:I.status,apiKey:c,hmacSecret:I.hmacSecret,limits:{chains:I.allowedChains,maxAddresses:I.maxAddresses,maxWebhooks:I.maxWebhooks,maxVirtualAccounts:I.maxVirtualAccounts,rateLimit:I.rateLimit,monthlyQuota:I.monthlyQuota},createdAt:I.createdAt},warning:\"Guarde su clave API ahora. No se puede recuperar de nuevo.\"})}catch(e){if(e.name===\"ZodError\")return a.status(400).json({éxito:!1,error:\"Error de validación\",details:e.errors});console.error(\"Error al crear inquilino:\",e),a.status(500).json({éxito:!1,error:\"Error interno del servidor\"})}}),t.get(\"/api/tenants\",async(s,a)=>{try{let e=await p.getAllTenants(),o=await Promise.all(e.map(async c=>{let d=await be(c.id),y=await p.countAddressesByTenant(c.id); return{id:c.id,name:c.name,email:c.email,tier:c.tier,status:c.status,companyName:c.companyName,addressCount:y,usage:{requests:d.totalRequests,units:Math.floor(d.totalUnits),costUsd:d.costUsd.toFixed(4)},createdAt:c.createdAt}}));a.json({success:!0,tenants:o})}catch(e){console.error(\"Error al obtener inquilinos:\",e),a.status(500).json({success:!1,error:\"Error interno del servidor\"})}}),t.get(\"/api/tenants/:id\",b,async(s,a)=>{try{let e=espera p.getTenant(s.params.id);si(!e)devuelve a.status(404).json({éxito:!1,error:\"No se encontró el inquilino\"}); sea o=await be(e.id),c=await Se(e.id,e.monthlyQuota),d=await p.countAddressesByTenant(e.id),y=await p.countWebhooksByTenant(e.id),m=await p.countVirtualAccountsByTenant(e.id);a.json({éxito:!0, inquilino:{id:e.id, nombre:e.name, correo electrónico:e.email, nivel:e.tier, estado:e.status, nombreDeEmpresa:e.nombreDeEmpresa, sitio web:e.website, correo electrónicoDeFacturación:e.correoElectrónicoDeFacturación, prefijoDeClaveAPI:e.prefijoDeClaveAPI, límites:{cadenas:e.cadenaspermitidas, direccionesmáximas:e.direccionesmáximas, webhooksmáx:e.webhooksmáx, cuentasvirtualesmáx:e.accesoVirtual recuentos, rateLimit:e.rateLimit, monthlyQuota:e.monthlyQuota}, uso:{direcciones:d, webhooks:y, cuentas virtuales:m, solicitudes:o.totalRequests, unidades:Math.floor(o.totalUnits), costoUsd:o.costUsd.toFixed(4), cuota:{usado:c.usado, restante:c.restante, porcentajeUsado:Math.round(c.porcentajeUsado)}}, creadoEn:e.creadoEn, actualizadoEn:e.actualizadoEn}})}catch(e){console.error(\"Obtener Error de inquilino:\",e),a.status(500).json({éxito:!1,error:\"Error interno del servidor\"})}}),t.patch(\"/api/tenants/:id\",b,async(s,a)=>{try{if(s.tenant.id!==s.params.id)return a.status(403).json({éxito:!1,error:\"Solo puede actualizar su propia cuenta\",requestId:s.requestId});let e=s.body,o=[\"nombre\",\"nombreDeEmpresa\",\"sitio web\",\"correo electrónico de facturación\"],c={};for(let y of o)e[y]!==void 0&&(c[y]=e[y]);if(Object.keys(c).length===0)return a.status(400).json({éxito:!1,error:\"No hay campos válidos para actualizar\",requestId:s.requestId});let d=await p.updateTenant(s.params.id,c);if(!d)return a.status(404).json({éxito:!1,error:\"No se encontró el inquilino\"});await p.createAuditLog({tenantId:d.id,acción:\"inquilino.actualizado\",resource:\"inquilino\",resourceId:d.id,cambios:c,ipAddress:s.ip}),a.json({éxito:!0,inquilino:d,requestId:s.requestId})}catch(e){console.error(\"Actualizar inquilino error:\",e),a.status(500).json({éxito:!1,error:\"Error interno del servidor\"})}}),t.post(\"/api/tenants/:id/rotate-key\",b,async(s,a)=>{try{let e=await p.getTenant(s.params.id);if(!e)return a.status(404).json({éxito:!1,error:\"No se encontró el inquilino\"});if(s.tenant.id!==e.id)return a.status(403).json({éxito:!1,error:\"Solo puede rotar su propia clave API\",requestId:s.requestId});let{key:o,prefix:c,hash:d}=Ie();await p.updateTenant(e.id,{apiKeyPrefix:c,apiKeyHash:d}),await p.createAuditLog({tenantId:e.id,action:\"apikey.rotated\",resource:\"tenant\",resourceId:e.id,changes:{rotated:!0}}),a.json({success:!0,apiKey:o,warning:\"Guarde su nueva clave API. La clave anterior ya no es válida y no se puede recuperar.\",requestId:s.requestId})}catch(e){console.error(\"Error al rotar la clave API:\",e),a.status(500).json({success:!1,error:\"Servidor interno error\"})}}),t.patch(\"/api/admin/tenants/:id\",$,async(s,a)=>{try{let e=s.body;if(e.tier){let c=H[e.tier];c&&(e.allowedChains=c.chains,e.maxAddresses=c.maxAddresses,e.maxWebhooks=c.maxWebhooks,e.maxVirtualAccounts=c.maxVirtualAccounts,e.rateLimit=c.rateLimit,e.monthlyQuota=c.monthlyQuota)}let o=await p.updateTenant(s.params.id,e);if(!o)return a.status(404).json({éxito:!1,error:\"No se encontró el inquilino\"});await p.createAuditLog({Id.inquilino:o.id,acción:\"admin.tenant.updated\",recurso:\"inquilino\",Id.recurso:o.id,cambios:e,direcciónIP:s.ip}),a.json({éxito:!0,inquilino:o,Id.solicitud:s.Id.solicitud})}catch(e){console.error(\"El administrador actualiza el inquilino error:\",e),a.status(500).json({éxito:!1,error:\"Error interno del servidor\"})}}),t.post(\"/api/admin/tenants/:id/suspend\",$,async(s,a)=>{try{let e=await p.updateTenant(s.params.id,{status:\"suspendido\"});if(!e)return a.status(404).json({éxito:!1,error:\"Inquilino no encontrado\"});await p.createAuditLog({tenantId:e.id,action:\"admin.tenant.suspended\",resource:\"tenant\",resourceId:e.id,changes:{status:\"suspended\"},ipAddress:s.ip}),a.json({success:!0,message:\"Inquilino suspendido\",requestId:s.requestId})}catch(e){console.error(\"Error de suspensión del inqui
{"mensaje":"","atributos":{"nivel":"información"},"marca de tiempo":"2025-11-30T18:34:45.701728269Z"}
{"mensaje":"> rest-express@1.0.0 inicio","atributos":{"nivel":"información"},"marca de tiempo":"2025-11-30T18:34:45.701733595Z"}
{"mensaje":"> NODE_ENV=nodo de producción dist/index.js","atributos":{"nivel":"información"},"marca de tiempo":"2025-11-30T18:34:45.701738589Z"}
{"mensaje":"","atributos":{"nivel":"información"},"marca de tiempo":"2025-11-30T18:34:45.701744802Z"}
{"mensaje":"archivo:///app/dist/index.js:1","atributos":{"nivel":"error"},"marca de tiempo":"2025-11-30T18:34:46.720915067Z"}
{"mensaje":"var mt=Object.defineProperty;var fe=(n,t)=>()=>(n&&(t=n(n=0)),t);var xe=(n,t)=>{para(var r en t)mt(n,r,{obtener:t[r],enumerable:!0})};var J={};xe(J,{EnumeraciónDeCadena:()=>ft,PRECIOS:()=>le,CADENAS_SOPORTADAS:()=>me,EnumeraciónDeEstado:()=>yt,LÍMITES_DE_NIVEL:()=>H,EnumeraciónDeNivel:()=>gt,EVENTOS_DE_WEBHOOK:()=>Be,direcciones:()=>S,UsoDeAPI:()=>W,RegistrosDeAuditoría:()=>te,AgregacionesDeFacturación:()=>Q,CriptoTransacciones:()=>de,ConfiguraciónDeGas:()=>X,InsertarEsquemaDeDirección:()=>vt,InsertarEsquemaDeUsoDeAPI:()=>_t,InsertarLoCursoDeAuditoría gSchema:()=>xt,insertarEsquemaDeTransacciónCriptográfica:()=>At,insertarEsquemaDeMonederoMaestro:()=>It,insertarEsquemaDeInquilino:()=>bt,insertarEsquemaDeTransacción:()=>kt,insertarEsquemaDeCuentaVirtual:()=>wt,insertarEsquemaDeWebhook:()=>Tt,MonederosMaestros:()=>z,inquilinos:()=>x,RelacionesDeInquilinos:()=>ht,transacciones:()=>j,CuentasVirtuales:()=>_,webhooks:()=>K});import{sql como M}de\"drizzle-orm\";import{pgTable como q,texto como l,varchar como T,entero como E,booleano como Ve,marca de tiempo como R,jsonb como F,real como he,índice como v}de\"drizzle-orm/pg-core\";import{createInsertSchema como Y}de\"drizzle-zod\";import{z como Ke}de\"zod\";import{relaciones como pt}de\"drizzle-orm\";var gt,yt,ft,x,z,_,de,X,S,j,K,W,Q,te,ht,It,wt,At,bt,vt,kt,Tt,_t,xt,H,le,Be,me,D=fe(()=>{\"use estricto\";gt=Ke.enum([\"inicial\",\"escala\",\"empresa\"]),yt=Ke.enum([\"activo\",\"suspendido\",\"eliminado\"]),ft=Ke.enum([\"bitcoin\",\"ethereum\",\"solana\",\"polígono\",\"tron\",\"bsc\",\"ondulación\",\"cardano\",\"cerca\",\"polkadot\",\"avalancha\",\"arbitrum\",\"optimismo\",\"base\",\"fantom\",\"cronos\",\"cosmos\",\"algorand\"]),x=q(\"inquilinos\",{id:T(\"id\",{length:36}).primaryKey().default(M`gen_rand om_uuid()`), nombre: l(\"nombre\").notNull(), correo electrónico: l(\"correo electrónico\").notNull().único(), nivel: l(\"nivel\").notNull().predeterminado(\"inicial\"), estado: l(\"estado\").notNull().predeterminado(\"activo\"), apiKeyPrefix: T(\"api_key_prefix\",{longitud: 16}).notNull(), apiKeyHash: l(\"api_key_hash\").notNull().único(), hmacSecret: l(\"hmac_secret\").notNull(), allowedChains: l(\"allowed_chains\").array().notNull().predeterminado(M`ARRAY['bitcoin', 'ethereum', 'solana']`), direcciones máximas: E(\"direcciones máximas\").notNull().default(50), webhooks máximos: E(\"webhooks máximos\").notNull().default(1), cuentas virtuales máximas: E(\"cuentas virtuales máximas\").notNull().default(0), límite de tasa: E(\"límite de tasa\").notNull().default(10), cuota mensual: E(\"cuota mensual\").notNull().default(1e4), correo electrónico de facturación: l(\"correo electrónico de facturación\"), nombre de la empresa:l(\"nombre_de_la_empresa\"),sitio_web:l(\"sitio_web\"),lista_blanca_de_ip:l(\"lista_blanca_de_ip\").array(),metadatos:F(\"metadatos\"),createdAt:R(\"created_at\").defaultNow().notNull(),updatedAt:R(\"updated_at\").defaultNow().notNull()},n=>[v(\"id_de_correo_electrónico_de_inquilinos\").on(n.email),v(\"id_hash_de_clave_de_API_de_inquilinos\").on(n.apiKeyHa sh),v(\"idx_estado_inquilinos\").on(n.estado)]),z=q(\"monederos_principales\",{id:T(\"id\",{longitud:36}).clave_primaria().predeterminado(M`gen_random_uuid()`),escenario:l(\"escenario\").notNull(),cadena_de_bloques:l(\"cadena_de_bloques\").notNull(),tipo_de_activo:l(\"tipo_de_activo\").notNull(),nombre_de_activo:l(\"nombre_de_activo\").notNull(),dirección:l( \"dirección\").notNull().unique(),clavepública:l(\"clave pública\"),claveprivadacifrada:l(\"clave privada cifrada\"),claveprivadaIV:T(\"clave privadaIV\",{longitud:32}),etiquetadeautenticacióndeclaveprivada:T(\"etiquetadeautenticacióndeclaveprivada\",{longitud:32}),direccióndecontratointeligente:l(\"direccióndecontratointeligente\"),decimalesdetoken:E(\"decimalesdetoken \"),assignedToTenantId:T(\"id_asignado_al_inquilino\",{length:36}).references(()=>x.id),balance:l(\"saldo\").default(\"0\"),balanceUsd:l(\"saldo_usd\").default(\"0\"),lastSyncTime:R(\"última_sincronización\"),gasMarkupPercentage:E(\"porcentaje_de_margen_de_gas\").default(40),status:l(\"estado\").notNull().de fallo(\"activo\"), metadatos: F(\"metadatos\"), creado en: R(\"creado_en\"). predeterminadoAhora(). no nulo(), actualizado en: R(\"actualizado_en\"). predeterminadoAhora(). no nulo()}, n => [v(\"masters_blockchain_idx\"). en(n. cadena de bloques), v(\"masters_asset_idx\"). en(n. nombre_activo), v(\"masters_address_idx\"). en(n. dirección), v(\"masters_inquilino _idx\").on(n.assignedToTenantId),v(\"masters_scenario_idx\").on(n.scenario)]),_=q(\"cuentas_virtuales\",{id:T(\"id\",{longitud:36}).primaryKey().default(M`gen_random_uuid()`),tenantId:T(\"tenant_id\",{longitud:36}).notNull().references(()=>x.id,{onDelete:\"cascade\"}),accountType:l(\"tipo_de_cuenta\").n otNull(),saldos:F(\"saldos\").predeterminado(M`'{}'`),estado:l(\"estado\").notNull().predeterminado(\"activo\"),congelado:Ve(\"congelado\").predeterminado(!1),metadatos:F(\"metadatos\"),createdAt:R(\"creado_en\").defaultNow().notNull(),updatedAt:R(\"actualizado_en\").defaultNow().notNull()},n=>[v(\"inquilino_de_cuentas_virtuales_i dx\").on(n.Id_de_inquilino),v(\"id_de_estado_de_cuentas_virtualesx\").on(n.estado)]),de=q(\"transacciones_criptográficas\",{id:T(\"id\",{longitud:36}).clave_primaria().predeterminado(M`gen_random_uuid()`),Id_de_inquilino:T(\"id_de_inquilino\",{longitud:36}).notNull().referencias(()=>x.id,{onDelete:\"cascada\"}),tipo:l(\"tipo\").notNull(),escenario:l(\"escenario\").notNull(),fromAccountId:T(\"from_account_id\",{longitud:36}),toAccountId:T(\"to_count_id\",{longitud:36}),toExternalAddress:l(\"to_external_address\"),fromExternalAddress:l(\"from_external_address\"),assetType:l(\"tipo_de_activo\").notNull(),assetName:l(\"nombre_de_activo\").notNull(),blockchain:l(\"blockchain\").notNull(),amount:l(\"mount\"). notNull(),gasReal:l(\"gas_real\"),gasMarkupPercent:E(\"gas_markup_percent\"),gasCharged:l(\"gas_charged\"),commissionAmount:l(\"commission_mont\"),commissionUsd:l(\"comission_usd\"),status:l(\"status\").notNull().default(\"pending\"),txHash:l(\"tx_hash\").unique(),blockNumber:E(\"block_number\"),confirmations:E(\"confirmations\"),metadata:F(\"me tadata\"), creado en: R(\"creado_en\"). predeterminadoAhora(). no nulo(), ejecutado en: R(\"ejecutado_en\"), confirmado en: R(\"confirmado_en\")}, n => [v(\"idx_de_inquilino_de_transacción_criptográfica\"). en(n. id_de_inquilino), v(\"idx_de_tipo_de_transacción_criptográfica\"). en(n. tipo), v(\"idx_de_estado_de_transacción_criptográfica\"). en(n. estado), v(\"idx_hash_de_transacción_criptográfica\"). en(n. hash_de_transacción), v(\"idx_de_escenario_de_transacción_criptográfica\"). en(n. escenario)]), X = q(\"setti_gas ngs\",{id:T(\"id\",{longitud:36}).primaryKey().default(M`gen_random_uuid()`),marcadopredeterminadoglobal:E(\"marcadopredeterminadoglobal\").default(40),marcadomín:E(\"marcadomín\").default(10),marcadomáx:E(\"marcadomáx\").default(100),anulacionesdecliente:F(\"anulacionesdecliente\").default(M`'{}'`),multiplicadoresdecadenadebloques:F(\"multiplicadoresdecadenadebloques\").default(M`'{\"ethereum\": 1.0, \"polígono\": 0.3}'`),Anulaciones de tipo de transacción:F(\"anulaciones de tipo de transacción\").predeterminado(M`'{\"retiro_cripto\": 40, \"transferencia_de_token\": 45}'`),updatedAt:R(\"updated_at\").defaultNow().notNull(),updatedBy:l(\"updated_by\")},n=>[v(\"gas_settings_updated_idx\").on(n.updatedAt)]),S=q(\"direcciones\",{id:T(\"id\",{longitud:36}).primaryKey().default(M`gen_random_uuid()`),tenantId:T(\"tenant_id\",{longitud:36}).notNull().references(()=>x.id,{onDelete:\"cascade\"}),chain:l(\"cadena\").notNull(),currency:l(\"currency\").notNull(),address: l(\"dirección\").notNull(),publicKey:l(\"clave_pública\"),derivationPath:l(\"ruta_derivación\"),label:l(\"etiqueta\"),tags:l(\"etiquetas\").array().default(M`ARRAY[]::text[]`),status:l(\"estado\").notNull().default(\"activo\"),balance:l(\"balance\").default(\"0\"),balanceUsd:l(\"balance_usd\").default(\"0\"),lastSynced:R(\"last_synced\"),webhookUrl:l(\"webhook_url\"),metadatos:F(\"metadatos\"),createdAt:R(\"creado_en\").defaultNow().notNull(),actualizadoEn:R(\"actualizado_en\").defaultNow().notNull(),eliminadoEn:R(\"eliminado_en\")},n=>[v(\"direcciones_idx_de_inquilino\").on(n.Id_de_inquilino),v(\"direcciones_idx_de_cadena\").on(n.cadena),v(\"direcciones_idx_de_estado\").on(n.estado),v(\"direcciones_idx_de_dirección\").on(n.dirección)] ),j=q(\"transacciones\",{id:T(\"id\",{longitud:36}).primaryKey().default(M`gen_random_uuid()`),tenantId:T(\"id_tenant\",{longitud:36}).notNull().references(()=>x.id,{onDelete:\"cascade\"}),txHash:l(\"tx_hash\").notNull(),chain:l(\"cadena\").notNull(),fromAddress:l(\"from_address\"),toAddress:l(\"t o_dirección\"), importe: l(\"importe\").notNull(), moneda: l(\"moneda\").notNull(), cuota: l(\"cuota\"), cuotaUsd: l(\"cuota_usd\"), estado: l(\"estado\").notNull().default(\"pendiente\"), tipo: l(\"tipo\").notNull().default(\"nativo\"), númerodebloque: E(\"númerodebloque\"), confirmaciones: E(\"confirmaciones\").default(0 ), metadatos: F(\"metadatos\"), creado en: R(\"creado_en\"). predeterminado ahora(). no nulo()}, n => [v(\"idx_de_inquilino_de_transacciones\"). en(n. ID_de_inquilino), v(\"idx_de_cadena_de_transacciones\"). en(n. cadena), v(\"idx_de_hash_de_transacciones\"). en(n. Hash_de_tx), v(\"idx_de_estado_de_transacciones\"). en(n. estado)]), K = q(\"webhooks\", {id: T(\"id\", {le longitud: 36}). claveprimaria(). predeterminado(M`gen_random_uuid()`), ID_inquilino: T(\"ID_inquilino\",{longitud: 36}). no nulo(). referencias(()=>x.id,{onDelete:\"cascada\"}), URL: l(\"URL\"). no nulo(), eventos: l(\"eventos\"). matriz(). no nulo(), secreto_hmac: l(\"secreto_hmac\"). no nulo(), activo: Ve(\"activo\"). predeterminado(!0), reintentarCou nt:E(\"retry_count\").default(0),lastTriggered:R(\"last_triggered\"),lastStatus:E(\"last_status\"),metadatos:F(\"metadatos\"),createdAt:R(\"created_at\").defaultNow().notNull()},n=>[v(\"webhooks_tenant_idx\").on(n.tenantId),v(\"webhooks_active_idx\").on(n.active)]),W=q(\"api_usage\",{id:T(\"id \",{longitud:36}).primaryKey().default(M`gen_random_uuid()`),tenantId:T(\"tenant_id\",{longitud:36}).notNull().references(()=>x.id,{onDelete:\"cascade\"}),endpoint:l(\"endpoint\").notNull(),method:l(\"method\").notNull(),chain:l(\"chain\"),action:l(\"action\").notNull(),units:he(\"units\").notN ull(), créditos:he(\"créditos\").notNull(), código de estado:E(\"código de estado\").notNull(), id de solicitud:T(\"id de solicitud\",{longitud:36}).notNull(), tiempo de respuesta Ms:E(\"ms de tiempo de respuesta\"), metadatos:F(\"metadatos\"), marca de tiempo:R(\"marca de tiempo\").defaultNow().notNull()}, n=>[v(\"id de inquilino de uso de API\").on(n.id de inquilino),v(\"api_usage_timestamp_idx\").on(n.timestamp),v(\"api_usage_action_idx\").on(n.action)]),Q=q(\"agregaciones_de_facturación\",{id:T(\"id\",{longitud:36}).primaryKey().default(M`gen_random_uuid()`),tenantId:T(\"id_de_teniente\",{longitud:36}).notNull().references(()=>x.id,{onDelete:\"cascade\"}),periodo:l(\"periodo\").notNull(),periodType:l(\"tipo_de_periodo\").notNull().default(\"diario\"),totalUnits:he(\"unidades_totales\").notNull().def ault(0), totalCredits:he(\"total_créditos\").notNull().default(0), costUsd:he(\"costo_usd\").notNull().default(0), breakdown:F(\"break\"), createdAt:R(\"created_at\").defaultNow().notNull()}, n=>[v(\"billing_tenant_period_idx\").on(n.tenantId,n.period)]), te=q(\"audit_logs\",{id:T(\"id\",{length:36}).primaryKey().default(M`gen_random_uuid()`), tenantId:T(\"tenant_id\",{length:36}).references(()=>x.id,{onDelete:\"set null\"}),ID_usuario:l(\"id_usuario\"),acción:l(\"acción\").notNull(),recurso:l(\"recurso\").notNull(),ID_recurso:l(\"id_recurso\"),cambios:F(\"cambios\"),Dirección_IP:l(\"dirección_IP\"),Agente_usuario:l(\"agente_usuario\"),ID_solicitud:T(\"id_solicitud\",{longitud:36}),marca_de_tiempo:R(\"marca_de_tiempo\").defaultNow().notNull()},n=>[v(\"audit_logs_tenant_idx\").on(n.Id_tenant),v(\"audit_logs_timestamp_idx\").on(n.marca_de_tiempo),v(\"audit _logs_action_idx\").on(n.action)]),ht=pt(x,({muchos:n})=>({direcciones:n(S),transacciones:n(j),webhooks:n(K),cuentasvirtuales:n(_),apiUsage:n(W),agregacionesdefacturación:n(Q),registrosdeauditoría:n(te),monederosprincipales:n(z),criptotransacciones:n(de)})),It=Y(z).omit({id:!0,createdAt:!0,updatedAt:!0}),wt=Y(_).omit({id:!0,createdAt:!0,updatedAt:!0}),At=Y(de).omit({id:!0,createdAt:!0,executedAt:!0,confirmedAt:!0}),bt=Y(x).omit({ id:!0,createdAt:!0,updatedAt:!0}),vt=Y(S).omit({id:!0,createdAt:!0,updatedAt:!0,deletedAt:!0}),kt=Y(j).omit({id:!0,createdAt:!0}),Tt=Y(K).omit({id:!0,createdAt:!0}),_t=Y(W).omit({id:!0,timestamp:!0}),xt=Y(te).omit({id:!0,timestamp:!0}),H={starter:{chains:[\"bitcoin\",\"ethereum\",\"solana\"],maxAddresses:50,maxWebhooks:1,maxVirtualAccounts:0,rateLimit:10,monthlyQuota:1e4,kmsAllowed:!1,archivalAccess :!1, días de retención: 1}, escala: {cadenas: [\"bitcoin\",\"ethereum\",\"solana\",\"polígono\",\"tron\",\"bsc\",\"ripple\",\"cardano\"], direcciones máximas: 1e3, webhooks máximos: 10, cuentas virtuales máximas: 5, límite de tasa: 100, cuota mensual: 1e5, km permitidos:!0, acceso de archivo:!1, días de retención: 7}, empresa: {cadenas: [\"bitcoin\",\"ethereum\",\"solana\",\"polígono\",\"tron\",\"bsc\",\"ripple\",\"cardano\",\"near\",\"polkadot\",\"avalancha\",\"arbitro\",\"optimismo\",\"base\",\"fantasma\",\"cronos\",\"cosmos\",\"algorand\"],máximo de direcciones: -1,máximo de webhooks: -1,máximo de cuentas virtuales: 50,límite de tasa: 1e3,cuota mensual: -1,km permitidos: !0,acceso de archivo: !0,días de retención: 30}},le={creación de dirección:{unidades: 1,costo: 0,001},consulta de saldo:{unidades: 0,costo: 5e-4},saldo de token:{unidades: 1,costo: 0,001},metadatos nft:{unidades: 2,costo: 0,002},tx_br oadcast_btc:{unidades: 50, costo: 0,05}, tx_broadcast_eth:{unidades: 10, costo: 0,01}, tx_broadcast_other:{unidades: 10, costo: 0,01}, tx_history:{unidades: 2, costo: 0,002}, webhook_subscription:{unidades: 0,02, costo: 0,02}, va_create:{unidades: 100, costo: 0,1}, va_transfer:{unidades: 5, costo: 0,005}, tipo de cambio:{unidades: 0,1, costo: 1e-4}, web3_resolve:{unidades: 1, costo: 0,001}, malicioso_check:{unidades: 2, costo: 0,002}, rpc_standard:{u nits:2,costo:2e-4},rpc_eth_call:{unidades:5,costo:5e-4},rpc_debug:{unidades:50,costo:.005}},Be=[\"TRANSACCIÓN_DIRECCIÓN\",\"SALDO_DIRECCIÓN\",\"TRANSACCIÓN_NATIVA_ENTRANTE\",\"TRANSACCIÓN_NATIVA_SALIENTE\",\"TRANSACCIÓN_FUNGIBLE_ENTRANTE\",\"TRANSACCIÓN_FUNGIBLE_SALIENTE\",\"TRANSACCIÓN_NFT_ENTRANTE\",\"TRANSACCIÓN_NFT_SALIENTE\",\"TRANSACCIÓN_MULTITOKEN_ENTRANTE\",\"TRANSACCIÓN_MULTITOKEN_SALIENTE\",\"TRANSACCIÓN_FALLIDA\",\"CUOTA_PAGADA\",\"REGISTRO_DE_CONTRATO _EVENTO\"],me=[{id:\"bitcoin\",nombre:\"Bitcoin\",símbolo:\"BTC\",icono:\"\\u20BF\"},{id:\"ethereum\",nombre:\"Ethereum\",símbolo:\"ETH\",icono:\"\\u039E\"},{id:\"solana\",nombre:\"Solana\",símbolo:\"SOL\",icono:\"\\u25CE\"},{id:\"polígono\",nombre:\"Polígono\",símbolo:\"MATIC\",icono:\"\\u2B21\"},{id:\"tron\",nombre:\"Tron\",símbolo:\"TRX\",icono:\"\\u2666\"},{id:\"bsc\",nombre:\"BNB Cadena\", símbolo:\"BNB\", icono:\"\\u25C6\"},{id:\"ripple\", nombre:\"XRP Ledger\", símbolo:\"XRP\", icono:\"\\u2715\"},{id:\"cardano\", nombre:\"Cardano\", símbolo:\"ADA\", icono:\"\\u20B3\"},{id:\"near\", nombre:\"NEAR\", símbolo:\"NEAR\", icono:\"\\u24C3\"},{id:\"polkadot\", nombre:\"Polkadot\", símbolo:\"DOT\", icono:\"\\u25CF\"},{id:\"avalanche\", nombre:\"Avalanche\", símbolo:\"AVAX\", icono:\"\\u25B2\"},{id:\"arb itrum\", nombre:\"Arbitrum\", símbolo:\"ARB\", icono:\"\\u25C8\"},{id:\"optimism\", nombre:\"Optimism\", símbolo:\"OP\", icono:\"\\u2295\"},{id:\"base\", nombre:\"Base\", símbolo:\"ETH\", icono:\"\\u25EF\"},{id:\"fantom\", nombre:\"Fantom\", símbolo:\"FTM\", icono:\"\\u25C7\"},{id:\"cronos\", nombre:\"Cronos\", símbolo:\"CRO\", icono:\"\\u25CE\"},{id:\"cosmos\",nombre:\"Cosmos\",símbolo:\"ATOM\",icono:\"\\u269B\"},{id:\"algorand\",nombre:\"Algorand\",símbolo:\"ALGO\",icono:\"\\u24B6\"}]});var oe={};xe(oe,{db:()=>f,pool:()=>Ye});import{Pool como St,neonConfig como Pt}desde\"@neondatabase/serverless\";import{drizzle como Rt}desde\"drizzle-orm/neon-serverless\";import Et desde\"ws\";var Ye,f,V=fe(()=>{\"use strict\";D();Pt.webSocketConstructor=Et;if(!process.env.DATABASE_URL)throw new Error(\"DATABASE_URL debe ser ¿Olvidaste aprovisionar una base de datos?\"); Ye=new St({connectionString:process.env.DATABASE_URL}), f=Rt({client:Ye,schema:J})}); function jt(n){return!n||typeof n!=\"string\"||n.length<32?!1:/^[a-zA-Z0-9_-]{32,}$/.test(n)} function Bt(){return P.state===\"open\"?Date.now()-P.lastFailure>=$e.resetTimeoutMs?(P.state=\"half-open\",P.successesInHalfOpen=0,!0):!1:!0} function Dt(){P.estado===\"semiabierto\"?(P.éxitosEnMedioApertura++,P.éxitosEnMedioApertura>=$e.umbralDeÉxitoDeAperturaMedia&&(P.estado=\"cerrado\",P.fallos=0)):P.fallos=0}función ze(){P.fallos++,P.últimoFallo=Fecha.ahora(),(P.estado===\"semiabierto\"||P.fallos>=$e.umbralDeFallo)&&(P.estado=\"abierto\")}función Ut(n,t){devolver t.EstadosReintentables.includes(n)}función Xe(n,t){devolver Math.min(t.baseDelayMs*Math.pow(2,n)+Math.random()*1e3,t.maxDelayMs)}función asíncrona Qe(n){devuelve nueva Promesa(t=>setTimeout(t,n))}función asíncrona N(n,t={},r=Kt){si(!Bt())devuelve{éxito:!1,error:\"Servicio temporalmente no disponible (disyuntor abierto)\",statusCode:503};let i=null;for(let u=0;u<=r.maxRetries;u++)try{let g=new AbortController,h=setTimeout(()=>g.abort(),3e4),s=await fetch(`${Mt}${n}`,{...t,señal:g.señal,encabezados:{\"Tipo-Contenido\":\"aplicación/json\",\"clave-x-api\":Fe||\"\",...t.encabezados}});clearTimeout(h);let a=await s.json().catch(()=>null);if(!s.ok){let e={éxito:!1,error:a?.mensaje||a?.error||`HTTP ${s.estado}`,código-estado:s.estado};if(s.estado===429){let o=s.headers.get(\"Retry-After\");o&&(e.retryAfter=parseInt(o,10)*1e3)}if(Ut(s.status,r)&&u<r.maxRetries){i=e;let o=e.retryAfter||Xe(u,r);await Qe(o);continue}return ze(),e}return Dt(),{éxito:!0,datos:a}}catch(g){let h=g.name===\"Error de cancelación\",s=g.message?.includes(\"obtener\")||g.message?.includes(\"red\"),a={éxito:!1,error:h?\"Tiempo de espera de la solicitud\":g.message||\"Red error\",statusCode:h?408:500};if((h||s)&&u<r.maxRetries){i=a,await Qe(Xe(u,r));continue}return ze(),a}return i||{éxito:!1,error:\"Se excedió el máximo de reintentos\",statusCode:500}}function Je(n){return me.find(t=>t.id===n)}var Mt,Fe,Kt,P,$e,se,B,Oe=fe(()=>{\"use strict\";D();Mt=process.env.TATUM_API_URL||\"https://api.tatum.io\",Fe=process.env.TATUM_API_KEY;Fe?jt(Fe)||console.warn(\"El formato de TATUM_API_KEY parece no ser válido; puede causar errores de API\"):console.warn(\"TATUM_API_KEY no configurado; las llamadas a la API fail\"); Kt={máx.Reintentos:3,Ms.deRetardoBase:1e3,Ms.deRetardoMax:3e4,EstadosReintentables:[408,429,500,502,503,504]}, P={fallos:0,últimoFallo:0,estado:\"cerrado\",éxitosEnMedioApertura:0}, $e={UmbralDeFallo:5,Ms.deRestablecimientoTiempoDeEspera:6e4,UmbralDeÉxitoEnMedioApertura:2}; se={bitcoin:\"bitcoin\",ethereum:\"ethereum\",solana:\"solana\",polygon:\"polígono\",tron:\"tron\",bsc:\"bsc\",ri pple:\"xrp\",cardano:\"ada\",near:\"near\",polkadot:\"dot\",avalanche:\"avax\",arbitrum:\"arbitrum-one\",optimismo:\"optimismo\",base:\"base\",fantom:\"fantom\",cronos:\"cro\",c osmos:\"atom\",algorand:\"algo\"},B={getCircuitBreakerState(){return{...P}},resetCircuitBreaker(){P.failures=0,P.lastFailure=0,P.state=\"closed\",P.successesInHalfOpen=0},async generateAddress(n){let t=se[n]||n;return N(`/v3/${t}/wallet`,{método:\"GET\"})},async getBalance(n,t){let r=se[n]||n;return[\"ethereum\",\"polígono\",\"bsc\",\"arbitrum-one\",\"optimism\",\"base\"].includes(r)?N(`/v3/${r}/account/balance/${t}`):N(r===\"bitcoin\"?`/v3/bitcoin/address/balance/${t}`:r===\"solana\"?`/v3/solana/account/balance/${t}`:`/v3/${r}/account/balance/${t}`)},async getTokens(n,t){let r=se[n]||n;devuelve N(`/v3/data/tokens?chain=${r}&addresses=${t}`)},asincrónico obtenerNFTs(n,t){let r=se[n]||n;devuelve N(`/v3/data/nfts?chain=${r}&addresses=${t}`)},asincrónico obtenerHistorialDeTransacciones(n,t,r){let i=se[n]||n,u=nuevosParámetrosDeBúsquedaDeURL;devuelve r?.TamañoDePágina&&u.set(\"TamañoDePágina\",r.TamañoDePágina.toString()),r?.Desplazamiento&&u.set(\"Desplazamiento\",r.Desplazamiento.toString()),N(`/v3/data/transacciones?chain=${i}&addresses=${t}&${u.toString()}`)},asincrónico getTransaction(n,t){let r=se[n]||n;devuelve N(`/v3/${r}/transaction/${t}`)},async estimateFee(n,t=\"TRANSFER\"){let r=se[n]||n;devuelve N(`/v3/${r}/gas/estimate`,{método:\"POST\",cuerpo:JSON.stringify({tipo:t})})},async broadcastTransaction(n,t){let r=se[n]||n;devuelve N(`/v3/${r}/broadcast`,{método:\"POST\",cuerpo:JSON.stringify({txData:t})})},async getExchangeRates(n){let t=n.join(\",\");devuelve N(`/v3/tatum/rate/${t}?basePair=USD`)}, asíncrono resolveWeb3Name(n){devuelve N(`/v3/blockchain/names/${n}`)}, asíncrono checkMaliciousAddress(n){devuelve N(`/v3/security/address/${n}`)}, asíncrono createWebhook(n){devuelve N(\"/v4/subscription\",{método:\"POST\",cuerpo:JSON.stringify(n)})}, asíncrono deleteWebhook(n){devuelve N(`/v4/subscription/${n}`,{método:\"DELETE\"})}, asíncrono getWebhooks(){devuelve N(\"/v4/subscription\")},async healthCheck(){let n=await N(\"/v3/tatum/version\"); return n.success?{success:!0, data:{status:\"healthy\", version:n.data?.version||\"v3\", circuitBreaker:{...P}}}:{...n, data:{status:\"degraded\", version:\"unknown\", circuitBreaker:{...P}}}}}});var ve={};xe(ve,{GasFeeManager:()=>Ee,gasFeeManager:()=>Le});import{eq as Ge}from\"drizzle-orm\";var Ee,Le,ge=fe(()=>{\"use strict\";V();D();Ee=class{config=null;async loadConfig(){let[t]=await f.select().from(X).limit(1);if(!t){let r={Margen predeterminado global: 40, Margen mínimo: 10, Margen máximo: 100, Anulaciones de cliente:{}, Multiplicadores de cadena de bloques:{ethereum: 1, polígono: .3, bitcoin: 1.2, solana: .1, arbitraje: .2}, Anulaciones de tipo de transacción:{retiro_cripto: 40, transferencia_de_token: 45, contrato_inteligente: 60}};return this.config=r,r}return this.config={globalDefaultMarkup:t.globalDefaultMarkup,minMarkup:t.minMarkup,maxMarkup:t.maxMarkup,clientOverrides:t.clientOverrides||{},blockchainMultipliers:t.blockchainMultipliers||{},transactionTypeOverrides:t.transactionTypeOverrides||{}},this.config}async calculateGasMarkup(t){this.config||await this.loadConfig();let r=this.config.globalDefaultMarkup;if(t.clientId&&this.config.clientOverrides[t.clientId]){let a=this.config.clientOverrides[t.clientId];if(a.expiresAt){let e=new Date(a.expiresAt);new Date<e&&(r=a.markup)}else r=a.markup}let i=this.config.transactionTypeOverrides[t.transactionType];i&&(r=i);let u=this.config.blockchainMultipliers[t.blockchain]||1;r=Math.round(r*u),r=Math.max(this.config.minMarkup,Math.min(this.config.maxMarkup,r));let g=t.gasReal*(r/100),h=t.gasReal+g,s=g;return{gasReal:t.gasReal,gasMarkupPercent:r,gasCharged:h,yourProfit:s}}async updateGlobalMarkup(t,r){t=Math.max(10,Math.min(100,t)),await f.update(X).set({globalDefaultMarkup:t,updatedAt:new Fecha,actualizadoPor:r}).donde(Ge(X.id,\"predeterminado\")),this.config=null,await this.loadConfig()}async setClientMarkup(t,r,i,u,g){this.config||await this.loadConfig();let h=this.config.clientOverrides;h[t]={markup:Math.max(10,Math.min(100,r)),reason:i,expiresAt:g?.toISOString()},await f.update(X).set({clientOverrides:h,actualizadoEn:new Fecha,actualizadoPor:u}).donde(Ge(X.id,\"predeterminado\")),this.config=null,await this.loadConfig()}async removeClientMarkup(t,r){this.config||await this.loadConfig();let i=this.config.clientOverrides;eliminar i[t],esperar f.update(X).set({clientOverrides:i,actualizadoEn:nueva Fecha,actualizadoPor:r}).where(Ge(X.id,\"predeterminado\")),this.config=null,esperar this.loadConfig()}getConfig(){devolver this.config}},Le=new Ee});var ke={};xe(ke,{CryptoGateway:()=>Ne,cryptoGateway:()=>Ht});importar Lt desde\"crypto\";importar{eq como G y como Wt} desde\"drizzle-orm\";var Ne,Ht,Te=fe(()=>{\"usar estricto\";Oe();ge();V();D();Ne=class{async createVirtualAccount(t,r){devolver(esperar f.insert(_).values({Id.inquilino:t,TipoDeCuenta:r,Saldos:JSON.stringify({})}).returning())[0]}async internalSwap(t){let r=await f.query.virtualAccounts.findFirst({where:G(_.id,t.fromAccountId)});if(!r)throw new Error(\"No se encontró la cuenta\");let i=JSON.parse(r.balances||\"{}\"),u=parseFloat(i[t.assetName]||\"0\");if(u<parseFloat(t.fromAmount))throw new Error(\"Saldo insuficiente\");let g=parseFloat(t.toAmount)*.005,h=parseFloat(t.toAmount)-g,s={...i};s[t.assetName]=(u-parseFloat(t.fromAmount)).toString(),await f.update(_).set({balances:JSON.stringify(s)}).where(G(_.id,t.fromAccountId));let a=espera f.consulta.cuentasvirtuales.findFirst({donde:G(_.id,t.toAccountId)}),e=JSON.parse(a?.balances||\"{}\");devuelve e[t.nombreDeActivo]=(parseFloat(e[t.nombreDeActivo]||\"0\")+h).toString(),espera f.update(_).set({balances:JSON.stringify(e)}).donde(G(_.id,t.toAccountId)),{txId:(espera f.insert(de).values({Id.inquilino:t.Id.inquilino,tipo:\"intercambio_interno\",escenario:t.scenario,Id.deCuenta:t.deCuenta,Id.deCuenta:t.deCuenta,Tipo.deActivo:\"cripto\",Nombre.deActivo:t.deActivo,cadena.de.blockchain:t.blockchain,importe:t.deImporte,importe.de.comisión:g.de.Cadena(),comisión.Usd:(g*45e3).de.Cadena(),estado:\"completado\"}).returning())[0].id,estado:\"completado\",deImporte:t.deImporte,de.Importe:t.de.Importe,comisión:g.de.Fijo(8),neto.Recibido:h.de.Fijo(8),ejecutadoEn:nuevaFecha().de.CadenaISO()}}asincrónico externalWithdraw(t){let r=await f.query.masterWallets.findFirst({where:Wt(G(z.assetName,t.assetName),G(z.blockchain,t.blockchain),G(z.scenario,t.scenario))});if(!r)throw new Error(`No se encontró la billetera maestra para ${t.assetName} en ${t.blockchain}`);let i=await B.estimateGas({blockchain:t.blockchain,assetType:t.assetName===r.smartContractAddress?\"token\":\"crypto\",amount:t.amount}),u=await Le.calculateGasMarkup({clientId:t.tenantId,blockchain:t.blockchain,transactionType:t.assetName===\"BTC\"?\"crypto_withdraw\":\"token_transfer\",gasReal:i.gasReal}),g=await f.query.virtualAccounts.findFirst({where:G(_.id,t.fromAccountId)}),h=JSON.parse(g?.balances||\"{}\"),s=parseFloat(h[t.assetName]||\"0\");if(s<parseFloat(t.amount))throw new Error(\"Saldo insuficiente\");h[t.assetName]=(s-parseFloat(t.amount)).toString(),await f.update(_).set({balances:JSON.stringify(h)}).where(G(_.id,t.fromAccountId));let a=`0x${Lt.randomBytes(32).toString(\"hex\")}`;return{txId:(await f.insert(de).values({Id.inquilino:t.inquilino,tipo:\"retiro_externo\",escenario:t.scenario,toExternalAddress:t.toExternalAddress,tipo.activo:\"cripto\",nombre.activo:t.nombre.activo,blockchain:t.blockchain,cantidad:t.cantidad,gasReal:u.gasReal.toString(),porcentaje.de.margen.gas:u.porcentaje.de.margen.gas,gasCargado :u.gasCharged.toString(),commissionAmount:u.yourProfit.toString(),status:\"pendiente\",txHash:a}).returning())[0].id,status:\"pendiente_de_confirmación\",txHash:a,amount:t.amount,gasReal:u.gasReal.toFixed(8),gasCharged:u.gasCharged.toFixed(8),yourProfit:u.yourProfit.toFixed(8),estimatedTime:\"12 segundos\"}}async assignMasterToClient(t,r,i){return await f.update(z).set({assignedToTenantId:r,gasMarkupPercentage:i}).where(G(z.id,t)),{success:!0,masterId:t,assignedTo:r,gasMarkup:i,assignedAt:new Date().toISOString()}}async getVirtualAccountBalance(t){let r=await f.query.virtualAccounts.findFirst({where:G(_.id,t)});if(!r)throw new Error(\"Cuenta no encontrada\");let i=JSON.parse(r.balances||\"{}\"); return{accountId:t,balances:i,totalUsd:Object.entries(i).reduce((u,[g,h])=>{let s={ETH:2500,BTC:45e3,GOLD:500,SILVER:250}; return u+parseFloat(h)*(s[g]||0)},0)}}},Ht=new Ne});import Ce de\"express\";import{z como w} de\"zod\";D();V();import{eq como A,and como Z,desc como ie,sql como De,gte como Nt,lte como Ct} de\"drizzle-orm\";var Ue=class{async getTenant(t){let[r]=await f.select().from(x).where(A(x.id,t));return r||void 0}async getTenantByApiKeyHash(t){let[r]=await f.select().from(x).where(A(x.apiKeyHash,t));return r||void 0}async getTenantByEmail(t){let[r]=await f.select().from(x).where(A(x.email,t));return r||void 0}async getAllTenants(){return f.select().from(x).orderBy(ie(x.createdAt))}async createTenant(t){let[r]=await f.insert(x).values(t).returning();return r}async updateTenant(t,r){let[i]=await f.update(x).set({...r,updatedAt:nueva fecha}).where(A(x.id,t)).returning();devolver i||void 0}async deleteTenant(t){await f.update(x).set({estado:\"eliminado\",updatedAt:nueva fecha}).where(A(x.id,t))}async getAddress(t){let[r]=await f.select().from(S).where(A(S.id,t));devolver r||void 0}async getAddressByAddress(t,r,i){let[u]=await f.select().from(S).where(Z(A(S.tenantId,t),A(S.chain,r),A(S.address,i)));devolver u||void 0}async getAddressesByTenant(t,r){let i=f.select().from(S).where(A(S.tenantId,t)),u=[A(S.tenantId,t)];devuelve r?.chain&&u.push(A(S.chain,r.chain)),r?.status&&u.push(A(S.status,r.status)),f.select().from(S).where(Z(...u)).orderBy(ie(S.createdAt)).limit(r?.limit||50).offset(r?.offset||0)}asincrónico countAddressesByTenant(t){let[r]=await f.select({count:De`count(*)`}).from(S).where(Z(A(S.tenantId,t),A(S.status,\"active\")));devuelve r?.count||0}asincrónico createAddress(t){let[r]=await f.insert(S).values(t).returning();return r}async updateAddress(t,r){let[i]=await f.update(S).set({...r,updatedAt:nueva fecha}).where(A(S.id,t)).returning();return i||void 0}async archiveAddress(t){await f.update(S).set({estado:\"archivado\",eliminadoAt:nueva fecha,updatedAt:nueva fecha}).where(A(S.id,t))}async getTransaction(t){let[r]=await f.select().from(j).where(A(j.id,t));return r||void 0}async getTransactionByHash(t,r){let[i]=await f.select().from(j).where(Z(A(j.chain,t),A(j.txHash,r)));return i||void 0}async getTransactionsByTenant(t,r){let i=[A(j.tenantId,t)];return r?.chain&&i.push(A(j.chain,r.chain)),r?.status&&i.push(A(j.status,r.status)),f.select().from(j).where(Z(...i)).orderBy(ie(j.createdAt)).limit(r?.limit||50).offset(r?.desplazamiento||0)}asincrónico createTransaction(t){let[r]=await f.insert(j).values(t).returning();devolver r}asincrónico updateTransaction(t,r){let[i]=await f.update(j).set(r).where(A(j.id,t)).returning();devolver i||void 0}asincrónico getWebhook(t){let[r]=await f.select().from(K).where(A(K.id,t));devolver r||void 0}asincrónico getWebhooksByTenant(t){devolver f.select().from(K).where(A(K.tenantId,t)).orderBy(ie(K.createdAt))}asincrónico countWebhooksByTenant(t){let[r]=await f.select({count:De`count(*)`}).from(K).where(Z(A(K.tenantId,t),A(K.active,!0)));devuelve r?.count||0}asinc createWebhook(t){let[r]=await f.insert(K).values(t).returning();devuelve r}asinc updateWebhook(t,r){let[i]=await f.update(K).set(r).where(A(K.id,t)).returning();devuelve i||void 0}asinc deleteWebhook(t){await f.delete(K).where(A(K.id,t))}asinc getVirtualAccount(t){let[r]=await f.select().from(_).where(A(_.id,t));devuelve r||void 0}asinc obtenerCuentasVirtualesPorInquilino(t){devolver f.seleccionar().de(_).donde(A(_.IdInquilino,t)).ordenarPor(ie(_.createdAt))}asincrónico contarCuentasVirtualesPorInquilino(t){let[r]=await f.seleccionar({count:De`count(*)`}).de(_).donde(Z(A(_.IdInquilino,t),A(_.estado,\"activo\")));devolver r?.count||0}asincrónico crearCuentaVirtual(t){let[r]=await f.insertar(_).valores(t).devolver();devolver r}asincrónico actualizarCuentaVirtual(t,r){let[i]=await f.actualizar(_).set(r).donde(A(_.id,t)).devolver();devolver i||void 0}asincrónico recordApiUsage(t){let[r]=await f.insert(W).values(t).returning();return r}async getApiUsageByTenant(t,r,i){return f.select().from(W).where(Z(A(W.tenantId,t),Nt(W.timestamp,r),Ct(W.timestamp,i))).orderBy(ie(W.timestamp))}async getApiUsageStats(t,r,i){let u=await this.getApiUsageByTenant(t,r,i),g={},h={},s=0,a=0;for(let e of u)s+=e.unidades,a+=e.créditos,g[e.punto final]=(g[e.punto final]||0)+1,e.cadena&&(h[e.cadena]=(h[e.cadena]||0)+1);return{totalRequests:u.length,totalUnits:s,totalCredits:a,byEndpoint:g,byChain:h}}async getBillingAggregation(t,r){let[i]=await f.select().from(Q).where(Z(A(Q.tenantId,t),A(Q.periodo,r)));return i||void 0}async upsertBillingAggregation(t){let r=await this.getBillingAggregation(t.tenantId,t.periodo);if(r){let[i]=await f.update(Q).set(t).where(A(Q.id,r.id)).returning();return i}else{let[i]=await f.insert(Q).values(t).returning();return i}}async createAuditLog(t){let[r]=await f.insert(te).values(t).returning();return r}async getAuditLogsByTenant(t,r=100){return f.select().from(te).where(A(te.tenantId,t)).orderBy(ie(te.timestamp)).limit(r)}},p=new Ue;Oe();import ce from\"crypto\";D();var Ze=process.env.ADMIN_API_KEY;function Ie(){let n=`tatum_${ce.randomBytes(28).toString(\"hex\")}`,t=n.substring(0,16),r=tt(n);devolver{clave:n,prefijo:t,hash:r}}función tt(n){devolver ce.createHash(\"sha256\").update(n).digest(\"hex\")}función we(){devolver ce.randomBytes(32).toString(\"hex\")}función st(){devolver`req_${ce.randomBytes(16).toString(\"hex\")}`}función asíncrona b(n,t,r){n.requestId=st(),t.setHeader(\"X-Request-ID\",n.requestId);deje que i=n.headers[\"x-api-key\"]; if(!i)return t.status(401).json({success:!1,error:\"Clave API faltante\",requestId:n.requestId});let u=tt(i),g=await p.getTenantByApiKeyHash(u); if(!g)return t.status(401).json({success:!1,error:\"Clave API no válida\",requestId:n.requestId}); if(g.status!==\"activo\")return t.status(403).json({success:!1,error:`La cuenta es ${g.status}`,requestId:n.requestId});n.tenant=g,r()}function $(n,t,r){n.requestId=st(),t.setHeader(\"X-Request-ID\",n.requestId);let i=n.headers[\"x-admin-key\"];if(!Ze)return t.status(503).json({éxito:!1,error:\"API de administración no configurada\",requestId:n.requestId});if(!i)return t.status(401).json({éxito:!1,error:\"Falta la clave de API de administración\",requestId:n.requestId});let u=ce.createHash(\"sha256\").update(i).digest(\"hex\"),g=ce.createHash(\"sha256\").update(Ze).digest(\"hex\");if(!ce.timingSafeEqual(Buffer.from(u),Buffer.from(g)))return t.status(401).json({éxito:!1,error:\"Clave de API de administrador no válida\",requestId:n.requestId});n.isAdmin=!0,r()}var et=new Map;function k(n,t,r){if(!n.tenant)return r();let i=n.tenant.id,u=Date.now(),g=1e3,h=et.get(i);(!h||h.resetAt<u)&&(h={count:0,resetAt:u+g},et.set(i,h)),h.count++;let s=n.tenant.rateLimit,a=Math.max(0,sh.count);if(t.setHeader(\"X-RateLimit-Límite\",s),t.setHeader(\"X-RateLimit-Restante\",a),t.setHeader(\"X-RateLimit-Restablecer\",Math.ceil(h.resetAt/1e3)),h.count>s)return t.status(429).json({éxito:!1,error:\"Límite de tasa excedido\", requestId:n.requestId,retryAfter:Math.ceil((h.resetAt-u)/1e3)});r()}función en(n){return(t,r,i)=>{if(!t.tenant)return r.status(401).json({éxito:!1,error:\"Se requiere autenticación\", requestId:t.requestId});let u=H[t.tenant.tier];if(!u)return r.status(403).json({éxito:!1,error:\"Configuración de nivel no válida\", requestId:t.requestId});if(n===\"kms\"&&!u.kmsAllowed)return r.status(403).json({éxito:!1,error:\"KMS no está disponible en Su nivel. Actualice a Scale o Enterprise.\",requestId:t.requestId,upgrade:!0});if(n===\"archival\"&&!u.archivalAccess)return r.status(403).json({success:!1,error:\"El acceso a archivos no está disponible en su nivel. Actualice a Enterprise.\",requestId:t.requestId,upgrade:!0});i()}}function Ae(n,t,r){if(!n.tenant)return r();let i=n.params.chain||n.body?.chain;if(!i)return r();let g=H[n.tenant.tier]?.chains||n.tenant.allowedChains;if(!g.includes(i))return t.status(403).json({success:!1,error:`La cadena '${i}' no está disponible en su nivel`,allowedChains:g,requestId:n.requestId,upgrade:!0});r()}D();función asíncrona nt(){if(!process.env.SEED_DEMO_DATA)return null;console.log(\"Comprobando si hay un inquilino de demostración...\");let n=await p.getTenantByEmail(\"demo@tatum-gateway.io\");if(n)return console.log(\"El inquilino de demostración ya existe\"),n;console.log(\"Creando inquilino de demostración...\"); let{prefix:t,hash:r}=Ie(),i=H.scale,u=await p.createTenant({name:\"Cuenta de demostración\",email:\"demo@tatum-gateway.io\",tier:\"scale\",status:\"active\",apiKeyPrefix:t,apiKeyHash:r,hmacSecret:we(),allowedChains:i.chains,maxAddresses:i.maxAddresses,maxWebhooks:i.maxWebhooks,maxVirtualAccounts:i.maxVirtualAccounts,rateLimit:i.rateLimit,monthlyQuota:i.monthlyQuota,companyName:\"Demostración de Tatum Gateway\",website:\"https://tatum.io\"});console.log(\"Inquilino de demostración creado:\",u.id),await p.createAuditLog({Id.inquilino:u.id,acción:\"inquilino.creado\",recurso:\"inquilino\",Id.recurso:u.id,cambios:{nivel:\"escala\",origen:\"semilla\"}});para(dejar g=0;g<10;g++)esperar p.recordApiUsage({Id.inquilino:u.id,punto final:`/api/v1/${[\"direcciones\",\"saldos\",\"tokens\",\"transacciones\"][g%4]}`,método:[\"OBTENER\",\"POST\"][g%2],cadena:[\"ethereum\",\"bitcoin\",\"solana\",\"polígono\"][g%4],acción:[\"saldo consulta_de_ance\",\"creación_de_dirección\",\"saldo_de_token\",\"historial_de_transacciones\"][g%4],unidades:[.5,1,1,2][g%4],créditos:[5e-4,.001,.001,.002][g%4],código_de_estado:200,id_de_solicitud:`demo_${g}`,tiempo_de_respuestaMs:50+Math.floor(Math.random()*100)});retorno console.log(\"¡Datos de uso de demostración sembrados!\"),u}D();función O(n){return async(t,r,i)=>{if(!t.tenant)return i();let u=le[n];t.metered={acción:n,unidades:u.units,créditos:u.cost};let g=r.json.bind(r);r.json=h=>{let s=Date.now();return p.recordApiUsage({Id.inquilino:t.id.inquilino, punto final:t.ruta, método:t.método, cadena:t.params.cadena||t.cuerpo?.cadena||nulo, acción:n, unidades:u.unidades, créditos:u.costo, código de estado:r.código de estado, Id.solicitud:t.id.solicitud, tiempo de respuesta:Fecha.ahora()-s, metadatos:{agente-usuario:t.encabezados[\"agente-usuario\"], ip:t.ip}}).catch(consola.error),h&&tipo de h==\"objeto\"&&(h.meta={...h.meta, Id.solicitud:t.id.solicitud, marca de tiempo:nueva Fecha().toISOString(),medido:{acción:n,unidades:u.unidades,créditos:u.costo}}),g(h)},i()}}función asíncrona be(n){let t=nueva fecha,r=nueva fecha(t.getFullYear(),t.getMonth(),1),i=await p.getApiUsageStats(n,r,t);return{totalRequests:i.totalRequests,totalUnits:i.totalUnits,totalCredits:i.totalCredits,costUsd:i.totalCredits}}función asíncrona Se(n,t){if(t===-1)return{permitido:!0,usado:0,restante:-1,porcentajeUsado:0};let r=await ser(n),i=Math.floor(r.totalUnits),u=ti,g=i/t*100;devolver{permitido:u>0,usado:i,restante:Math.max(0,u),porcentajeUsado:Math.min(100,g)}}función ae(n,t,r){si(!n.inquilino)devolver r();Se(n.inquilino.id,n.inquilino.cuotamensual).entonces(i=>{si(t.setHeader(\"X-Cuota-Usada\",i.usada),t.setHeader(\"X-Cuota-Restante\",i.restante),t.setHeader(\"X-Cuota-Porcentaje\",Math.round(i.porcentajeUsado)),!i.permitido)devolver t.status(429).json({success:!1,error:\"Cuota mensual excedida\",requestId:n.requestId,quota:{used:i.used,limit:n.tenant.cuotamensual,porcentajeUsado:i.porcentajeUsado},actualización:!0});r()}).catch(()=>r())}D();importar Ft desde\"crypto\";var $t=1e5,Ot=32,qt=\"sha256\",ne=null,pe=class n{secretomaestro;versión;createdAt;estático SALT_PREFIXES={claveprivada:\"kms:clave_privada:v1\",carteramaestra:\"kms:cartera_maestra:v1\",secretohmac:\"kms:secretohmac:v1\",derivacióndeclaveapi:\"kms:claveapi:v1\",cifradodesesión:\"kms:sesión:v1\"};constructor(t,r=1){if(!t||t.length<32)arrojar nuevo Error(\"El secreto maestro debe ser al menos 32 bytes (usar: openssl rand -hex 16)\");this.masterSecret=t,this.version=r,this.createdAt=new Date,t.length<64&&console.warn(\"\\u26A0\\uFE0F ADVERTENCIA: El secreto del KMS maestro tiene menos de 64 bytes. Considere usar: openssl rand -hex 32\")}static initialize(t){let r=t||process.env.MASTER_KMS_SECRET||process.env.SESSION_SECRET;if(!r)throw new Error(\"Variable de entorno MASTER_KMS_SECRET no establecida. Generar con: openssl rand -hex 32\");return ne||(ne=new n(r),console.log(\"\\u2705 KMS inicializado con secreto maestro\"),ne)}static getInstance(){return ne||(ne=n.initialize()),ne}deriveKey(t,r=\"\"){let i=n.SALT_PREFIXES[t];if(!i)throw new Error(`Tipo de clave desconocida: ${t}`);let u=Buffer.from(`${i}:${r}`);return{key:Ft.pbkdf2Sync(this.masterSecret,u,$t,Ot,qt),version:this.version,keyType:t}}derivePrivateKeyEncryptionKey(t){return this.deriveKey(\"privateKey\",t).key}deriveMasterWalletKey(t){return this.deriveKey(\"masterWallet\",t).key}deriveHmacKey(t){return this.deriveKey(\"hmacSecret\",t).key}deriveSessionEncryptionKey(t){return this.deriveKey(\"sessionEncryption\",t).key}getConfig(){return{masterSecret:\"[CENSURADO]\",version:this.version,createdAt:this.createdAt}}rotate(t){let r=new n(t,this.version+1);return ne=r,console.log(`\\u2705 KMS rotado a la versión ${r.version}`),r}static test(){try{let t=n.getInstance(),r=t.deriveKey(\"privateKey\",\"test-wallet-1\"),i=t.deriveKey(\"privateKey\",\"test-wallet-1\");if(r.key.toString(\"hex\")!==i.key.toString(\"hex\"))throw new Error(\"La derivación de la clave KMS no es determinista\");let u=t.deriveKey(\"privateKey\",\"test-wallet-2\");if(r.key.toString(\"hex\")===u.key.toString(\"hex\"))throw new Error(\"Colisión de derivación de clave KMS detectada\");return console.log(\"\\u2705 Autoprueba de KMS aprobada\"),!0}catch(t){return console.error(\"\\u274C Autoprueba de KMS fallida:\",t),!1}}};try{pe.initialize()}catch(n){console.warn(\"\\u26A0\\uFE0F Advertencia de inicialización de KMS:\",n)}import qe from\"crypto\";var Pe=\"aes-256-gcm\",Re=32,Gt=16;function rt(n,t,r){if(t.length!==Re)throw new Error(`La clave de cifrado debe ser de ${Re} bytes`);let i=qe.randomBytes(Gt),u=qe.createCipheriv(Pe,t,i);r&&u.setAAD(Buffer.from(r));let g=Buffer.concat([u.update(n,\"utf8\"),u.final()]),h=u.getAuthTag();return{ciphertext:g.toString(\"hex\"),iv:i.toString(\"hex\"),authTag:h.toString(\"hex\"),algorithm:Pe}}function ot(n,t,r){if(t.length!==Re)throw new Error(`La clave de cifrado debe tener ${Re} bytes`);if(n.algorithm!==Pe)throw new Error(`Algoritmo no compatible: ${n.algorithm}`);let i=Buffer.from(n.iv,\"hex\"),u=Buffer.from(n.ciphertext,\"hex\"),g=Buffer.from(n.authTag,\"hex\"),h=qe.createDecipheriv(Pe,t,i);r&&h.setAAD(Buffer.from(r)),h.setAuthTag(g);try{return Buffer.concat([h.update(u),h.final()]).toString(\"utf8\")}catch{throw new Error(\"Error de descifrado: los datos pueden estar dañados o alterados\")}}import{sql como Vt}desde\"drizzle-orm\";import{webcrypto como it}desde\"crypto\";var Yt=w.object({nombre:w.string().min(2),correo electrónico:w.string().correo electrónico(),nivel:w.enum([\"starter\",\"scale\",\"enterprise\"]).predeterminado(\"starter\"),nombreDeEmpresa:w.string().opcional(),sitio web:w.string().url().opcional(),correo electrónico de facturación:w.string().correo electrónico().opcional()}),zt=w.object({cadena:w.string(),etiqueta:w.string().opcional(),etiquetas:w.array(w.string()).opcional(),URLdelwebhook:w.string().url().opcional()}),Xt=w.object({url:w.string().url(),eventos:w.array(w.enum(Be)).min(1)});función asíncrona ct(n,t){nt().catch(console.error),t.get(\"/\",(s,a)=>{a.json({name:\"Tatum API Gateway\",version:\"1.0.0\",description:\"API Gateway de blockchain de nivel empresarial compatible con más de 130 blockchains\",status:\"running\",documentation:\"GET /api/docs | GET /api/docs/model | GET /api/docs/examples\",quickStart:\"1. Obtener la clave API del administrador | 2. Agregar el encabezado 'x-api-key: YOUR_KEY' | 3. Enviar por POST a /api/tenants para registrarse\",endpoints:{health:\"GET /api/health\",pricing:\"GET /api/pricing\",chains:\"GET /api/chains\",tenants:\"GET /api/tenants | POST /api/inquilinos\", direcciones:\"GET /api/v1/direcciones | POST /api/v1/direcciones\", transacciones:\"GET /api/v1/transacciones\", webhooks:\"POST /api/v1/webhooks | GET /api/v1/webhooks\", puerta de enlace:\"POST /api/v1/puerta de enlace/cuentas-virtuales | GET /api/v1/puerta de enlace/cuentas-virtuales | POST /api/v1/puerta de enlace/intercambio | POST /api/v1/puerta de enlace/retiro\", administrador:\"GET /api/admin/configuración-gas | PUT /api/admin/configuración-gas/global | GET /api/admin/ingresos | GET /api/admin/transacciones\", rwa:\"POST /api/v1/rwa/tokens | GET /api/v1/rwa/tokens | POST /api/v1/rwa/tokens/:id/transfer\"},businessModel:{type:\"Puerta de enlace API de doble panel (100 % de ingresos de administración)\",panels:{cryptoPanel:{description:\"Control de billetera maestra con sistema de cuentas virtuales\",revenueStreams:{internalSwaps:\"0,5 % de comisión (sin comisiones de gas)\",gasMarkup:\"40 % de margen configurable sobre las comisiones de gas\",setupFees:\"$500 por cliente de RWA\"},annualRevenue:\"$204K (Y1) \\u2192 $1.02M (Y2) \\u2192 $2.04M (Y3)\"}, rwaPanel:{description:\"Infraestructura de tokenización de activos del mundo real\",revenueStreams:{setupFees:\"$500 por token (pago único)\",nnualFees:\"$200 por token al año\",tradingCommissions:\"0.5% del volumen total de operaciones (100% para administración)\"},annualRevenue:\"$654K (Y1) \\u2192 $8.07M (Y2) \\u2192 $60.21M (Y3)\"}},profitMargins:\"82.5% (Y1) \\u2192 91.2% (Y2) \\u2192 96,8 % (año 3)\", totalProjections:{año 1:\"$858 000\", año 2:\"$9,09 000\", año 3:\"$62,25 000\"}}, auth:{type:\"Clave API + HMAC\", method:\"x-api-key header (Tatum v3 recommended)\", example:\"curl -H 'x-api-key: YOUR_API_KEY' https://api.example.com/api/v1/...\", documentation:\"https://docs.tatum.io/docs/authentication\"}, rateLimit:\"Por nivel: Starter 10/s, Scale 100/s, Enterprise 1000/seg\",docs:\"https://api.tatum.io/docs\",github:\"https://github.com/MasterFital/tatum-api-gateway\"})}),t.get(\"/api/docs/model\",(s,a)=>{a.json({title:\"Tatum API Gateway - Modelo de Negocio\",introduction:\"Arquitectura de doble panel que genera el 100% de ingresos administrativos mediante el trading de criptomonedas y la tokenización de RWA\",panels:{crypto:{name:\"Panel CRYPTO (100% de tus ingresos)\",description:\"Controlas las billeteras maestras (BTC, ETH, SOL, MATIC). Los clientes operan a través de cuentas virtuales.\",how_it_works:{step1:\"El administrador crea billeteras maestras mediante POST /api/admin/master-wallets\",step2:\"Los clientes crean cuentas virtuales mediante POST /api/v1/gateway/virtual-accounts\",paso 3:\"Los clientes pueden intercambiar internamente (comisión del 0,5 % para usted) o retirar externamente (margen de beneficio del 40 %)\",paso 4:\"El administrador registra todos los ingresos mediante GET /api/admin/revenue\"},revenue_streams:{internal_swaps:{description:\"El cliente intercambia BTC \\u2192 ETH\",fee:\"0,5 % del importe del intercambio\",gas_cost:\"Cero (interno)\",admin_profit:\"100 % de la comisión\",example:\"El cliente intercambia 1 ETH \\u2192 0,02 BTC | Comisión: 0,0001 BTC (100 % para el administrador)\"},gas_markup:{description:\"El cliente retira criptomonedas a una billetera externa\",fee:\"Margen de beneficio del 40 % sobre el gas real costo\", ejemplo:\"Gas Bitcoin: $3 reales | Cobras: $4.20 | Tu ganancia: $1.20 (40%)\"}}, proyecciones:{año1:{volumen:\"Promedio de 1 millón de USD/mes\", swaps mensuales:\"5K \\xD7 0.5% = $25K\", gas mensual:\"Retiros de 10K \\xD7 $3 \\xD7 40% = $12K\", total mensual:\"$17K\", anual:\"$204K\"}, año2:{volumen:\"Promedio de 5 millones de USD/mes\", anual:\"$1.02M\"}, año3:{volumen:\"Promedio de 10 millones de USD/mes\", anual:\"$2.04M\"}}}, rwa:{nombre:\"Panel RWA (100% Tus Ingresos + Tarifas)\", descripción:\"Los clientes emiten tokens. Tú proporcionas la infraestructura. Te quedas con el 100% de las tarifas y comisiones de trading.\", cómo_funciona:{paso 1:\"El cliente solicita la creación de un token: POST /api/v1/rwa/tokens\", paso 2:\"Cobras $500 de comisión de configuración + implementación del contrato inteligente\", paso 3:\"El token se activa. Los clientes operan internamente (comisión del 0,5 % para ti)\", paso 4:\"Comisión anual de mantenimiento de $200 por token\", paso 5:\"Todos los retiros externos tienen un margen de gas del 40 % (para ti)\", paso 6:\"Seguimiento de los ingresos mediante GET /api/admin/rwa-revenue\"},revenue_streams:{setup_fees:{description:\"Comisión única por token lanzado\",amount:\"$500\",frequency:\"Por token\"},annual_fees:{description:\"Mantenimiento anual por token activo\",amount:\"$200\",frequency:\"Por token por año\"}, comisiones_comerciales:{descripción:\"0.5% del volumen total de operaciones de tokens (100% para el administrador)\", porcentaje:\"0.5%\", ejemplo:\"Volumen de tokens: $100,000/mes | Su comisión: $500/mes = $6,000/año por token\"}, margen_gas:{descripción:\"40% de margen en las comisiones de gas para retiros externos\", porcentaje:\"40%\"}}, beneficios_del_cliente:{beneficio1:\"Infraestructura de tokenización (su costo: ~$0.10 por token)\", beneficio2:\"Mercado listo para usar\", beneficio3:\"Liquidez instantánea (operadores del día 1)\", beneficio4:\"Seguridad y cumplimiento a su cargo\", pago_del_cliente:\"$500 de configuración + $200/año solo\"}, proyecciones:{año1:{tokens:\"20 tokens nuevos\", tarifas_de_configuración:\"20 \\xD7 $500 = $10K\", tarifas_anuales:\"20 \\xD7 $200 = $4K\", comisiones_de_operación:\"0.5% de un volumen de ~$100M = $500K\", total:\"$514K\"}, año2:{tokens:\"100 tokens en total\", tarifas_de_configuración:\"100 \\xD7 $500 = $50K\", tarifas_anuales:\"100 \\xD7 $200 = $20K\", comisiones_de_operación:\"0.5% de un volumen de ~$1.6B = $8M\",total:\"$8.07M\"},año3:{tokens:\"300 tokens en total\",tarifas_de_configuración:\"300 \\xD7 $500 = $150K\",tarifas_anuales:\"300 \\xD7 $200 = $60K\",comisiones_de_comercio:\"0.5% de un volumen de ~$12B = $60M\",total:\"$60.21M\"}}}},resumen_de_ingresos:{título:\"Ingresos combinados (Cripto + RWA)\",año 1:{cripto:\"$204K\",rwa:\"$654K\",total:\"$858K\",margen:\"82.5%\"},año 2:{cripto:\"$1.02M\",rwa:\"$8.07M\",total:\"$9.09M\",margen:\"91.2%\"},año 3:{cripto:\"$2.04M\",rwa:\"$60.21M\",total:\"$62.25M\",margen:\"96.8%\"}},puntos_clave:[\"El 100% de todos los ingresos van al administrador (usted)\",\"Los clientes obtienen acceso a la infraestructura, no a la repartición de ingresos\",\"Las tarifas de configuración son ingresos inmediatos\",\"Las comisiones de trading escalan infinitamente con el volumen\",\"El margen de gas es puro beneficio (costo mínimo de infraestructura)\",\"Costo de adquisición de clientes cero (los clientes se traen a sí mismos)\"]})}),t.get(\"/api/docs/examples\",(s,a)=>{a.json({title:\"Tatum API Gateway - Ejemplos de uso\",autenticación: {descripción:\"Todas las solicitudes requieren el encabezado x-api-key\",ejemplo:\"curl -H 'x-api-key: YOUR_API_KEY' https://api.example.com/api/v1/...\",encabezados:{\"x-api-key\":\"Su clave API del administrador\",\"Content-Type\":\"application/json\"}},crypto_examples: {título:\"Ejemplos del panel CRYPTO\",create_virtual_account: {descripción:\"El cliente crea una cuenta virtual para almacenar criptomonedas\",endpoint:\"POST /api/v1/gateway/virtual-accounts\",solicitud:{tipoDeCuenta:\"individual\"},respuesta:{éxito:!0,cuentaVirtual:{id:\"va-123\",identificadorDeInquilino:\"cliente-1\",tipoDeCuenta:\"individual\",saldos:{BTC:\"0\",ETH:\"0\",SOL:\"0\"},estado:\"activo\"}}},interno_swap_0_5_percent:{descripción:\"El cliente intercambia BTC por ETH (comisión del 0,5 % para el administrador)\",punto final:\"POST /api/v1/gateway/swap\", solicitud: {fromAccountId:\"va-123\", fromAsset:\"BTC\", toAsset:\"ETH\", importe:\"1.0\"}, respuesta: {éxito:!0, intercambio: {id:\"swap-456\", fromAsset:\"BTC\", toAsset:\"ETH\", importe:\"1.0\", comisión:\"0.005 BTC (0.5% para el administrador)\", estado:\"completado\"}, nota:\"Sin comisiones de gas, comisión del 0.5% aplicada\"}}, external_withdraw_40_percent_markup: {descripción:\"El cliente retira a una billetera externa (40% de margen de gas para el administrador)\", punto final:\"POST /api/v1/gateway/withdraw\", solicitud: {fromAccountId:\"va-123\", activo:\"ETH\", importe:\"1.0\", dirección:\"0x1234567890abcdef...\"}, respuesta: {éxito:!0, retiro: {id:\"withdraw-789\", activo:\"ETH\", importe:\"1.0\", dirección:\"0x1234567890abcdef...\", gasReal:\"3 USD\", gasCharged:\"4.20 USD (40% de margen)\", adminProfit:\"1.20 USD\", estado:\"pendiente\", txHash:\"0xabcd...\"}}}, ver_historial_de_transacciones: {descripción:\"El cliente visualiza su transacción historial\", punto final:\"GET /api/v1/transactions?limit=50\", respuesta:{éxito:!0, transacciones:[{id:\"swap-456\", tipo:\"internal_swap\", activo:\"BTC\", importe:\"1.0\", comisión:\"0.005\", estado:\"completado\", creado el:\"2024-11-30T10:00:00Z\"}], paginación:{total:42, límite:50, desplazamiento:0}}}}, ejemplos_rwa:{título:\"Ejemplos de paneles RWA\", crear_rwa_token_500_setup:{descripción:\"El cliente crea un token (paga $500 de tarifa de configuración al administrador)\", punto final:\"POST /api/v1/rwa/tokens\",solicitud:{nombreDeActivo:\"Fondo Inmobiliario\",símbolo:\"REF\",cadenaDeBlockchain:\"Ethereum\",decimales:18,suministroTotal:\"1000000\",nombreDeEmisor:\"RE Properties Inc\",descripción:\"Inversión Inmobiliaria Tokenizada\"},respuesta:{éxito:!0,token:{id:\"token-ref-1\",nombreDeActivo:\"Fondo inmobiliario\", símbolo:\"REF\", cadena de bloques:\"ethereum\", suministro total:\"1000000\", dirección del contrato inteligente:\"0x...\", estado:\"creado\"}, precios: {tarifa de configuración:\"$500 (pago único) - PAGADO AL ADMINISTRADOR\", tarifa anual:\"$200/año - PAGADO AL ADMINISTRADOR\", comisión de negociación:\"0.5% en todas las operaciones - 100% PARA EL ADMINISTRADOR\"}}}, lista_rwa_tokens: {descripción:\"El cliente visualiza sus tokens y volumen de operaciones\", punto final:\"GET /api/v1/rwa/tokens\", respuesta: {éxito:!0, tokens:[{id:\"token-ref-1\", nombre_del_activo:\"Bienes raíces Fondo\", símbolo:\"REF\", cadena de bloques:\"ethereum\", oferta total:\"1000000\", estado:\"activo\", tarifa de configuración:\"500, tarifa anual:\"200, volumen de negociación:\"250000 USD\", comisión de negociación:\"1250 USD (0,5 % para el administrador)\"}], resumen:{totalTokens:\"1, comisiones de negociación totales:\"1250 USD (100 % para el administrador)\", tarifas de configuración cobradas:\"500 USD (100 % para el administrador)\"}}}, rwa_token_transfer_0_5_percent:{descripción:\"El titular del token negocia el token REF (0,5 % de comisión para el administrador)\", punto final:\"POST /api/v1/rwa/tokens/token-ref-1/transfer\",request:{toAddress:\"0xabcd...\",amount:\"100\"},response:{success:!0,transfer:{id:\"transfer-123\",tokenId:\"token-ref-1\",amount:\"100 REF\",toAddress:\"0xabcd...\",commission:\"0.5 REF (0.5% para el administrador)\",status:\"completed\",txHash:\"0x...\"},note:\"0.5% de comisión de trading aplicada y cobrada por el administrador\"}}},admin_examples:{title:\"Ejemplos del panel de administración\",view_revenue:{description:\"El administrador visualiza los ingresos totales (swaps + margen de gas)\",endpoint:\"GET /api/admin/revenue\",respuesta:{éxito:!0,cryptoRevenue:{totalSwapCommissions:\"1245.67 USD\",totalGasMarkupRevenue:\"3456.78 USD\",totalVolume:\"249000 USD\",revenueByBlockchain:{ethereum:\"2345.67\",polygon:\"1234.56\",bitcoin:\"3456.78\"}}}},view_rwa_revenue:{description:\"El administrador visualiza los ingresos de RWA (comisiones de configuración + anuales + de trading)\",endpoint:\"GET /api/admin/rwa-revenue\",respuesta:{éxito:!0,rwaRevenue:{setupFees:{count:12,total:\"6000 USD\", Tarifas anuales: {Clientes activos: 12, Total: 2400 USD\", Comisiones por operaciones: {Este mes: 12500 USD\", Este año: 125000 USD\", Tasa: 0,5 % del volumen total de operaciones\", Ingresos mensuales totales: 15000 USD\", Seguridad: {Autenticación: encabezado x-api-key (recomendado Tatum v3)\", Cifrado: Todas las claves privadas cifradas con AES-256\", Auditoría: Todas las transacciones registradas con registro de auditoría completo\", Límite de tasa: Starter 10/s, Scale 100/s, Enterprise 1000/seg\",documentación:\"https://docs.tatum.io/docs/authentication\"}})}),t.get(\"/api/test-tatum\",async(s,a)=>{try{let e=await B.healthCheck(),o={success:e.success,message:e.success?\"\\u2705 Conectado a la API de Tatum correctamente\":\"\\u274C Error al conectarse a la API de Tatum\",tatumApiUrl:process.env.TATUM_API_URL||\"https://api.tatum.io\",apiKeyConfigured:!!process.env.TATUM_API_KEY,apiKeyLength:process.env.TATUM_API_KEY?.length||0,timestamp:new Date().toISOString()};e.success&&e.data&&(o.blockchainInfo={chain:e.data.chain,blocks:e.data.blocks,mempool:e.data.mempool}),e.error&&(o.error=e.error,o.statusCode=e.statusCode),a.json({success:e.success,test:\"Prueba de conexión a la API de Tatum\",status:o,instructions:{production:\"Configure la variable de entorno TATUM_API_KEY con su API de producción de Tatum key\",documentation:\"https://docs.tatum.io/docs/authentication\",getApiKey:\"https://dashboard.tatum.io\"},requestId:s.requestId})}catch(e){a.status(500).json({success:!1,test:\"Prueba de conexión de la API de Tatum\",error:e.message,message:\"Error al probar la conexión de Tatum\",instructions:{checkApiKey:\"Asegúrese de que TATUM_API_KEY esté configurado en las variables de entorno\",checkUrl:\"Verifique que TATUM_API_URL esté correct\",documentation:\"https://docs.tatum.io/docs/authentication\"},requestId:s.requestId})}}),t.get(\"/api/docs\",(s,a)=>{a.json({title:\"Tatum API Gateway - Documentación completa\",message:\"Para obtener más información, visite estos puntos finales de la documentación:\",available_docs:{business_model:\"GET /api/docs/model - Explicación completa de los flujos de ingresos\",examples:\"GET /api/docs/examples - Ejemplos de uso para Crypto y RWA\",tatum_test:\"GET /api/test-tatum - Conexión de prueba a la API de Tatum (verificación de producción)\",this_endpoint:\"GET /api/docs - Esta página\",api_root:\"GET / - Información de la API y descripción general del modelo de negocio\"},quick_endpoints:{\"Crypto Panel\":[\"POST /api/v1/gateway/virtual-accounts - Crear cuenta virtual\",\"POST /api/v1/gateway/swap - Swap interno (comisión del 0,5%)\",\"POST /api/v1/gateway/withdraw - Retiro externo (margen de beneficio del 40%)\",\"GET /api/v1/transactions - Historial de transacciones\"],\"Panel RWA\":[\"POST /api/v1/rwa/tokens - Crear token (comisión de instalación de 500$)\",\"GET /api/v1/rwa/tokens - Listar tokens\",\"POST /api/v1/rwa/tokens/:id/transfer - Intercambio de tokens (comisión del 0,5%)\"],Admin:[\"GET /api/admin/revenue - Panel de ingresos de criptomonedas\",\"GET /api/admin/rwa-revenue - Panel de ingresos de RWA\",\"GET /api/admin/master-wallets - Lista de billeteras maestras\",\"POST /api/admin/master-wallets - Crear billetera maestra\"]},authentication:{method:\"x-api-key header\",example:\"Authorization: x-api-key YOUR_API_KEY\",documentation:\"https://docs.tatum.io/docs/authentication\"},support:{github:\"https://github.com/MasterFital/tatum-api-gateway\",tatum_docs:\"https://api.tatum.io/docs\",api_reference:\"https://docs.tatum.io/reference/welcome-to-the-tatum-api-reference\"}})}),t.get(\"/api/health\",async(s,a)=>{let e=await B.healthCheck();a.json({éxito:!0,estado:\"saludable\",servicios:{api:\"saludable\",base de datos:\"saludable\",tatum:e.success?\"saludable\":\"degradado\"},marca de tiempo:nueva Fecha().toISOString()})}), t.get(\"/api/pricing\",(s,a)=>{a.json({éxito:!0,precios:le,niveles:Object.entries(H).map(([e,o])=>({id:e,...o,precios:{starter:{mensual:0,incluido:1e4},escala:{mensual:99,incluido:1e5},empresa:{mensual:\"personalizado\",incluido:\"ilimitado\"}}[e]}))})}), t.get(\"/api/cadenas\",(s,a)=>{a.json({éxito:!0,cadenas:me,total:me.length})}), t.post(\"/api/inquilinos\",async(s,a)=>{try{let e=Yt.parse(s.body);if(await p.getTenantByEmail(e.email))return a.status(409).json({éxito:!1,error:\"Correo electrónico ya registrado\"});let{key:c,prefix:d,hash:y}=Ie(),m=H[e.tier],I=await p.createTenant({nombre:e.nombre,correo electrónico:e.correo electrónico,nivel:e.nivel,estado:\"activo\",apiKeyPrefix:d,apiKeyHash:y,hmacSecret:we(),allowedChains:[...m.cadenas],maxAddresses:m.maxAddresses,maxWebhooks:m.maxWebhooks,maxVirtualAccounts:m.maxVirtualAccounts,rateLimit:m.rateLimit,monthlyQuota:m.monthlyQuota,companyName:e.companyName,website:e.website,billingEmail:e.billingEmail});await p.createAuditLog({tenantId:I.id,action:\"tenant.created\",resource:\"tenant\",resourceId:I.id,changes:{tier:e.tier}}),a.status(201).json({success:!0,tenant:{id:I.id,name:I.name,email:I.email,tier:I.tier,status:I.status,apiKey:c,hmacSecret:I.hmacSecret,limits:{chains:I.allowedChains,maxAddresses:I.maxAddresses,maxWebhooks:I.maxWebhooks,maxVirtualAccounts:I.maxVirtualAccounts,rateLimit:I.rateLimit,monthlyQuota:I.monthlyQuota},createdAt:I.createdAt},warning:\"Guarde su clave API ahora. No se puede recuperar de nuevo.\"})}catch(e){if(e.name===\"ZodError\")return a.status(400).json({éxito:!1,error:\"Error de validación\",details:e.errors});console.error(\"Error al crear inquilino:\",e),a.status(500).json({éxito:!1,error:\"Error interno del servidor\"})}}),t.get(\"/api/tenants\",async(s,a)=>{try{let e=await p.getAllTenants(),o=await Promise.all(e.map(async c=>{let d=await be(c.id),y=await p.countAddressesByTenant(c.id); return{id:c.id,name:c.name,email:c.email,tier:c.tier,status:c.status,companyName:c.companyName,addressCount:y,usage:{requests:d.totalRequests,units:Math.floor(d.totalUnits),costUsd:d.costUsd.toFixed(4)},createdAt:c.createdAt}}));a.json({success:!0,tenants:o})}catch(e){console.error(\"Error al obtener inquilinos:\",e),a.status(500).json({success:!1,error:\"Error interno del servidor\"})}}),t.get(\"/api/tenants/:id\",b,async(s,a)=>{try{let e=espera p.getTenant(s.params.id);si(!e)devuelve a.status(404).json({éxito:!1,error:\"No se encontró el inquilino\"}); sea o=await be(e.id),c=await Se(e.id,e.monthlyQuota),d=await p.countAddressesByTenant(e.id),y=await p.countWebhooksByTenant(e.id),m=await p.countVirtualAccountsByTenant(e.id);a.json({éxito:!0, inquilino:{id:e.id, nombre:e.name, correo electrónico:e.email, nivel:e.tier, estado:e.status, nombreDeEmpresa:e.nombreDeEmpresa, sitio web:e.website, correo electrónicoDeFacturación:e.correoElectrónicoDeFacturación, prefijoDeClaveAPI:e.prefijoDeClaveAPI, límites:{cadenas:e.cadenaspermitidas, direccionesmáximas:e.direccionesmáximas, webhooksmáx:e.webhooksmáx, cuentasvirtualesmáx:e.accesoVirtual recuentos, rateLimit:e.rateLimit, monthlyQuota:e.monthlyQuota}, uso:{direcciones:d, webhooks:y, cuentas virtuales:m, solicitudes:o.totalRequests, unidades:Math.floor(o.totalUnits), costoUsd:o.costUsd.toFixed(4), cuota:{usado:c.usado, restante:c.restante, porcentajeUsado:Math.round(c.porcentajeUsado)}}, creadoEn:e.creadoEn, actualizadoEn:e.actualizadoEn}})}catch(e){console.error(\"Obtener Error de inquilino:\",e),a.status(500).json({éxito:!1,error:\"Error interno del servidor\"})}}),t.patch(\"/api/tenants/:id\",b,async(s,a)=>{try{if(s.tenant.id!==s.params.id)return a.status(403).json({éxito:!1,error:\"Solo puede actualizar su propia cuenta\",requestId:s.requestId});let e=s.body,o=[\"nombre\",\"nombreDeEmpresa\",\"sitio web\",\"correo electrónico de facturación\"],c={};for(let y of o)e[y]!==void 0&&(c[y]=e[y]);if(Object.keys(c).length===0)return a.status(400).json({éxito:!1,error:\"No hay campos válidos para actualizar\",requestId:s.requestId});let d=await p.updateTenant(s.params.id,c);if(!d)return a.status(404).json({éxito:!1,error:\"No se encontró el inquilino\"});await p.createAuditLog({tenantId:d.id,acción:\"inquilino.actualizado\",resource:\"inquilino\",resourceId:d.id,cambios:c,ipAddress:s.ip}),a.json({éxito:!0,inquilino:d,requestId:s.requestId})}catch(e){console.error(\"Actualizar inquilino error:\",e),a.status(500).json({éxito:!1,error:\"Error interno del servidor\"})}}),t.post(\"/api/tenants/:id/rotate-key\",b,async(s,a)=>{try{let e=await p.getTenant(s.params.id);if(!e)return a.status(404).json({éxito:!1,error:\"No se encontró el inquilino\"});if(s.tenant.id!==e.id)return a.status(403).json({éxito:!1,error:\"Solo puede rotar su propia clave API\",requestId:s.requestId});let{key:o,prefix:c,hash:d}=Ie();await p.updateTenant(e.id,{apiKeyPrefix:c,apiKeyHash:d}),await p.createAuditLog({tenantId:e.id,action:\"apikey.rotated\",resource:\"tenant\",resourceId:e.id,changes:{rotated:!0}}),a.json({success:!0,apiKey:o,warning:\"Guarde su nueva clave API. La clave anterior ya no es válida y no se puede recuperar.\",requestId:s.requestId})}catch(e){console.error(\"Error al rotar la clave API:\",e),a.status(500).json({success:!1,error:\"Servidor interno error\"})}}),t.patch(\"/api/admin/tenants/:id\",$,async(s,a)=>{try{let e=s.body;if(e.tier){let c=H[e.tier];c&&(e.allowedChains=c.chains,e.maxAddresses=c.maxAddresses,e.maxWebhooks=c.maxWebhooks,e.maxVirtualAccounts=c.maxVirtualAccounts,e.rateLimit=c.rateLimit,e.monthlyQuota=c.monthlyQuota)}let o=await p.updateTenant(s.params.id,e);if(!o)return a.status(404).json({éxito:!1,error:\"No se encontró el inquilino\"});await p.createAuditLog({Id.inquilino:o.id,acción:\"admin.tenant.updated\",recurso:\"inquilino\",Id.recurso:o.id,cambios:e,direcciónIP:s.ip}),a.json({éxito:!0,inquilino:o,Id.solicitud:s.Id.solicitud})}catch(e){console.error(\"El administrador actualiza el inquilino error:\",e),a.status(500).json({éxito:!1,error:\"Error interno del servidor\"})}}),t.post(\"/api/admin/tenants/:id/suspend\",$,async(s,a)=>{try{let e=await p.updateTenant(s.params.id,{status:\"suspendido\"});if(!e)return a.status(404).json({éxito:!1,error:\"Inquilino no encontrado\"});await p.createAuditLog({tenantId:e.id,action:\"admin.tenant.suspended\",resource:\"tenant\",resourceId:e.id,changes:{status:\"suspended\"},ipAddress:s.ip}),a.json({success:!0,message:\"Inquilino suspendido\",requestId:s.requestId})}catch(e){console.error(\"Error de suspensión del inqui
{"mensaje":"","atributos":{"nivel":"información"},"marca de tiempo":"2025-11-30T18:34:47.752329652Z"}
{"mensaje":"> rest-express@1.0.0 inicio","atributos":{"nivel":"información"},"marca de tiempo":"2025-11-30T18:34:47.752337073Z"}
{"mensaje":"> NODE_ENV=nodo de producción dist/index.js","atributos":{"nivel":"información"},"marca de tiempo":"2025-11-30T18:34:47.752342682Z"}
{"mensaje":"","atributos":{"nivel":"información"},"marca de tiempo":"2025-11-30T18:34:47.752348165Z"}
{"mensaje":"archivo:///app/dist/index.js:1","atributos":{"nivel":"error"},"marca de tiempo":"2025-11-30T18:34:47.912137264Z"}
{"mensaje":"var mt=Object.defineProperty;var fe=(n,t)=>()=>(n&&(t=n(n=0)),t);var xe=(n,t)=>{para(var r en t)mt(n,r,{obtener:t[r],enumerable:!0})};var J={};xe(J,{EnumeraciónDeCadena:()=>ft,PRECIOS:()=>le,CADENAS_SOPORTADAS:()=>me,EnumeraciónDeEstado:()=>yt,LÍMITES_DE_NIVEL:()=>H,EnumeraciónDeNivel:()=>gt,EVENTOS_DE_WEBHOOK:()=>Be,direcciones:()=>S,UsoDeAPI:()=>W,RegistrosDeAuditoría:()=>te,AgregacionesDeFacturación:()=>Q,CriptoTransacciones:()=>de,ConfiguraciónDeGas:()=>X,InsertarEsquemaDeDirección:()=>vt,InsertarEsquemaDeUsoDeAPI:()=>_t,InsertarLoCursoDeAuditoría gSchema:()=>xt,insertarEsquemaDeTransacciónCriptográfica:()=>At,insertarEsquemaDeMonederoMaestro:()=>It,insertarEsquemaDeInquilino:()=>bt,insertarEsquemaDeTransacción:()=>kt,insertarEsquemaDeCuentaVirtual:()=>wt,insertarEsquemaDeWebhook:()=>Tt,MonederosMaestros:()=>z,inquilinos:()=>x,RelacionesDeInquilinos:()=>ht,transacciones:()=>j,CuentasVirtuales:()=>_,webhooks:()=>K});import{sql como M}de\"drizzle-orm\";import{pgTable como q,texto como l,varchar como T,entero como E,booleano como Ve,marca de tiempo como R,jsonb como F,real como he,índice como v}de\"drizzle-orm/pg-core\";import{createInsertSchema como Y}de\"drizzle-zod\";import{z como Ke}de\"zod\";import{relaciones como pt}de\"drizzle-orm\";var gt,yt,ft,x,z,_,de,X,S,j,K,W,Q,te,ht,It,wt,At,bt,vt,kt,Tt,_t,xt,H,le,Be,me,D=fe(()=>{\"use estricto\";gt=Ke.enum([\"inicial\",\"escala\",\"empresa\"]),yt=Ke.enum([\"activo\",\"suspendido\",\"eliminado\"]),ft=Ke.enum([\"bitcoin\",\"ethereum\",\"solana\",\"polígono\",\"tron\",\"bsc\",\"ondulación\",\"cardano\",\"cerca\",\"polkadot\",\"avalancha\",\"arbitrum\",\"optimismo\",\"base\",\"fantom\",\"cronos\",\"cosmos\",\"algorand\"]),x=q(\"inquilinos\",{id:T(\"id\",{length:36}).primaryKey().default(M`gen_rand om_uuid()`), nombre: l(\"nombre\").notNull(), correo electrónico: l(\"correo electrónico\").notNull().único(), nivel: l(\"nivel\").notNull().predeterminado(\"inicial\"), estado: l(\"estado\").notNull().predeterminado(\"activo\"), apiKeyPrefix: T(\"api_key_prefix\",{longitud: 16}).notNull(), apiKeyHash: l(\"api_key_hash\").notNull().único(), hmacSecret: l(\"hmac_secret\").notNull(), allowedChains: l(\"allowed_chains\").array().notNull().predeterminado(M`ARRAY['bitcoin', 'ethereum', 'solana']`), direcciones máximas: E(\"direcciones máximas\").notNull().default(50), webhooks máximos: E(\"webhooks máximos\").notNull().default(1), cuentas virtuales máximas: E(\"cuentas virtuales máximas\").notNull().default(0), límite de tasa: E(\"límite de tasa\").notNull().default(10), cuota mensual: E(\"cuota mensual\").notNull().default(1e4), correo electrónico de facturación: l(\"correo electrónico de facturación\"), nombre de la empresa:l(\"nombre_de_la_empresa\"),sitio_web:l(\"sitio_web\"),lista_blanca_de_ip:l(\"lista_blanca_de_ip\").array(),metadatos:F(\"metadatos\"),createdAt:R(\"created_at\").defaultNow().notNull(),updatedAt:R(\"updated_at\").defaultNow().notNull()},n=>[v(\"id_de_correo_electrónico_de_inquilinos\").on(n.email),v(\"id_hash_de_clave_de_API_de_inquilinos\").on(n.apiKeyHa sh),v(\"idx_estado_inquilinos\").on(n.estado)]),z=q(\"monederos_principales\",{id:T(\"id\",{longitud:36}).clave_primaria().predeterminado(M`gen_random_uuid()`),escenario:l(\"escenario\").notNull(),cadena_de_bloques:l(\"cadena_de_bloques\").notNull(),tipo_de_activo:l(\"tipo_de_activo\").notNull(),nombre_de_activo:l(\"nombre_de_activo\").notNull(),dirección:l( \"dirección\").notNull().unique(),clavepública:l(\"clave pública\"),claveprivadacifrada:l(\"clave privada cifrada\"),claveprivadaIV:T(\"clave privadaIV\",{longitud:32}),etiquetadeautenticacióndeclaveprivada:T(\"etiquetadeautenticacióndeclaveprivada\",{longitud:32}),direccióndecontratointeligente:l(\"direccióndecontratointeligente\"),decimalesdetoken:E(\"decimalesdetoken \"),assignedToTenantId:T(\"id_asignado_al_inquilino\",{length:36}).references(()=>x.id),balance:l(\"saldo\").default(\"0\"),balanceUsd:l(\"saldo_usd\").default(\"0\"),lastSyncTime:R(\"última_sincronización\"),gasMarkupPercentage:E(\"porcentaje_de_margen_de_gas\").default(40),status:l(\"estado\").notNull().de fallo(\"activo\"), metadatos: F(\"metadatos\"), creado en: R(\"creado_en\"). predeterminadoAhora(). no nulo(), actualizado en: R(\"actualizado_en\"). predeterminadoAhora(). no nulo()}, n => [v(\"masters_blockchain_idx\"). en(n. cadena de bloques), v(\"masters_asset_idx\"). en(n. nombre_activo), v(\"masters_address_idx\"). en(n. dirección), v(\"masters_inquilino _idx\").on(n.assignedToTenantId),v(\"masters_scenario_idx\").on(n.scenario)]),_=q(\"cuentas_virtuales\",{id:T(\"id\",{longitud:36}).primaryKey().default(M`gen_random_uuid()`),tenantId:T(\"tenant_id\",{longitud:36}).notNull().references(()=>x.id,{onDelete:\"cascade\"}),accountType:l(\"tipo_de_cuenta\").n otNull(),saldos:F(\"saldos\").predeterminado(M`'{}'`),estado:l(\"estado\").notNull().predeterminado(\"activo\"),congelado:Ve(\"congelado\").predeterminado(!1),metadatos:F(\"metadatos\"),createdAt:R(\"creado_en\").defaultNow().notNull(),updatedAt:R(\"actualizado_en\").defaultNow().notNull()},n=>[v(\"inquilino_de_cuentas_virtuales_i dx\").on(n.Id_de_inquilino),v(\"id_de_estado_de_cuentas_virtualesx\").on(n.estado)]),de=q(\"transacciones_criptográficas\",{id:T(\"id\",{longitud:36}).clave_primaria().predeterminado(M`gen_random_uuid()`),Id_de_inquilino:T(\"id_de_inquilino\",{longitud:36}).notNull().referencias(()=>x.id,{onDelete:\"cascada\"}),tipo:l(\"tipo\").notNull(),escenario:l(\"escenario\").notNull(),fromAccountId:T(\"from_account_id\",{longitud:36}),toAccountId:T(\"to_count_id\",{longitud:36}),toExternalAddress:l(\"to_external_address\"),fromExternalAddress:l(\"from_external_address\"),assetType:l(\"tipo_de_activo\").notNull(),assetName:l(\"nombre_de_activo\").notNull(),blockchain:l(\"blockchain\").notNull(),amount:l(\"mount\"). notNull(),gasReal:l(\"gas_real\"),gasMarkupPercent:E(\"gas_markup_percent\"),gasCharged:l(\"gas_charged\"),commissionAmount:l(\"commission_mont\"),commissionUsd:l(\"comission_usd\"),status:l(\"status\").notNull().default(\"pending\"),txHash:l(\"tx_hash\").unique(),blockNumber:E(\"block_number\"),confirmations:E(\"confirmations\"),metadata:F(\"me tadata\"), creado en: R(\"creado_en\"). predeterminadoAhora(). no nulo(), ejecutado en: R(\"ejecutado_en\"), confirmado en: R(\"confirmado_en\")}, n => [v(\"idx_de_inquilino_de_transacción_criptográfica\"). en(n. id_de_inquilino), v(\"idx_de_tipo_de_transacción_criptográfica\"). en(n. tipo), v(\"idx_de_estado_de_transacción_criptográfica\"). en(n. estado), v(\"idx_hash_de_transacción_criptográfica\"). en(n. hash_de_transacción), v(\"idx_de_escenario_de_transacción_criptográfica\"). en(n. escenario)]), X = q(\"setti_gas ngs\",{id:T(\"id\",{longitud:36}).primaryKey().default(M`gen_random_uuid()`),marcadopredeterminadoglobal:E(\"marcadopredeterminadoglobal\").default(40),marcadomín:E(\"marcadomín\").default(10),marcadomáx:E(\"marcadomáx\").default(100),anulacionesdecliente:F(\"anulacionesdecliente\").default(M`'{}'`),multiplicadoresdecadenadebloques:F(\"multiplicadoresdecadenadebloques\").default(M`'{\"ethereum\": 1.0, \"polígono\": 0.3}'`),Anulaciones de tipo de transacción:F(\"anulaciones de tipo de transacción\").predeterminado(M`'{\"retiro_cripto\": 40, \"transferencia_de_token\": 45}'`),updatedAt:R(\"updated_at\").defaultNow().notNull(),updatedBy:l(\"updated_by\")},n=>[v(\"gas_settings_updated_idx\").on(n.updatedAt)]),S=q(\"direcciones\",{id:T(\"id\",{longitud:36}).primaryKey().default(M`gen_random_uuid()`),tenantId:T(\"tenant_id\",{longitud:36}).notNull().references(()=>x.id,{onDelete:\"cascade\"}),chain:l(\"cadena\").notNull(),currency:l(\"currency\").notNull(),address: l(\"dirección\").notNull(),publicKey:l(\"clave_pública\"),derivationPath:l(\"ruta_derivación\"),label:l(\"etiqueta\"),tags:l(\"etiquetas\").array().default(M`ARRAY[]::text[]`),status:l(\"estado\").notNull().default(\"activo\"),balance:l(\"balance\").default(\"0\"),balanceUsd:l(\"balance_usd\").default(\"0\"),lastSynced:R(\"last_synced\"),webhookUrl:l(\"webhook_url\"),metadatos:F(\"metadatos\"),createdAt:R(\"creado_en\").defaultNow().notNull(),actualizadoEn:R(\"actualizado_en\").defaultNow().notNull(),eliminadoEn:R(\"eliminado_en\")},n=>[v(\"direcciones_idx_de_inquilino\").on(n.Id_de_inquilino),v(\"direcciones_idx_de_cadena\").on(n.cadena),v(\"direcciones_idx_de_estado\").on(n.estado),v(\"direcciones_idx_de_dirección\").on(n.dirección)] ),j=q(\"transacciones\",{id:T(\"id\",{longitud:36}).primaryKey().default(M`gen_random_uuid()`),tenantId:T(\"id_tenant\",{longitud:36}).notNull().references(()=>x.id,{onDelete:\"cascade\"}),txHash:l(\"tx_hash\").notNull(),chain:l(\"cadena\").notNull(),fromAddress:l(\"from_address\"),toAddress:l(\"t o_dirección\"), importe: l(\"importe\").notNull(), moneda: l(\"moneda\").notNull(), cuota: l(\"cuota\"), cuotaUsd: l(\"cuota_usd\"), estado: l(\"estado\").notNull().default(\"pendiente\"), tipo: l(\"tipo\").notNull().default(\"nativo\"), númerodebloque: E(\"númerodebloque\"), confirmaciones: E(\"confirmaciones\").default(0 ), metadatos: F(\"metadatos\"), creado en: R(\"creado_en\"). predeterminado ahora(). no nulo()}, n => [v(\"idx_de_inquilino_de_transacciones\"). en(n. ID_de_inquilino), v(\"idx_de_cadena_de_transacciones\"). en(n. cadena), v(\"idx_de_hash_de_transacciones\"). en(n. Hash_de_tx), v(\"idx_de_estado_de_transacciones\"). en(n. estado)]), K = q(\"webhooks\", {id: T(\"id\", {le longitud: 36}). claveprimaria(). predeterminado(M`gen_random_uuid()`), ID_inquilino: T(\"ID_inquilino\",{longitud: 36}). no nulo(). referencias(()=>x.id,{onDelete:\"cascada\"}), URL: l(\"URL\"). no nulo(), eventos: l(\"eventos\"). matriz(). no nulo(), secreto_hmac: l(\"secreto_hmac\"). no nulo(), activo: Ve(\"activo\"). predeterminado(!0), reintentarCou nt:E(\"retry_count\").default(0),lastTriggered:R(\"last_triggered\"),lastStatus:E(\"last_status\"),metadatos:F(\"metadatos\"),createdAt:R(\"created_at\").defaultNow().notNull()},n=>[v(\"webhooks_tenant_idx\").on(n.tenantId),v(\"webhooks_active_idx\").on(n.active)]),W=q(\"api_usage\",{id:T(\"id \",{longitud:36}).primaryKey().default(M`gen_random_uuid()`),tenantId:T(\"tenant_id\",{longitud:36}).notNull().references(()=>x.id,{onDelete:\"cascade\"}),endpoint:l(\"endpoint\").notNull(),method:l(\"method\").notNull(),chain:l(\"chain\"),action:l(\"action\").notNull(),units:he(\"units\").notN ull(), créditos:he(\"créditos\").notNull(), código de estado:E(\"código de estado\").notNull(), id de solicitud:T(\"id de solicitud\",{longitud:36}).notNull(), tiempo de respuesta Ms:E(\"ms de tiempo de respuesta\"), metadatos:F(\"metadatos\"), marca de tiempo:R(\"marca de tiempo\").defaultNow().notNull()}, n=>[v(\"id de inquilino de uso de API\").on(n.id de inquilino),v(\"api_usage_timestamp_idx\").on(n.timestamp),v(\"api_usage_action_idx\").on(n.action)]),Q=q(\"agregaciones_de_facturación\",{id:T(\"id\",{longitud:36}).primaryKey().default(M`gen_random_uuid()`),tenantId:T(\"id_de_teniente\",{longitud:36}).notNull().references(()=>x.id,{onDelete:\"cascade\"}),periodo:l(\"periodo\").notNull(),periodType:l(\"tipo_de_periodo\").notNull().default(\"diario\"),totalUnits:he(\"unidades_totales\").notNull().def ault(0), totalCredits:he(\"total_créditos\").notNull().default(0), costUsd:he(\"costo_usd\").notNull().default(0), breakdown:F(\"break\"), createdAt:R(\"created_at\").defaultNow().notNull()}, n=>[v(\"billing_tenant_period_idx\").on(n.tenantId,n.period)]), te=q(\"audit_logs\",{id:T(\"id\",{length:36}).primaryKey().default(M`gen_random_uuid()`), tenantId:T(\"tenant_id\",{length:36}).references(()=>x.id,{onDelete:\"set null\"}),ID_usuario:l(\"id_usuario\"),acción:l(\"acción\").notNull(),recurso:l(\"recurso\").notNull(),ID_recurso:l(\"id_recurso\"),cambios:F(\"cambios\"),Dirección_IP:l(\"dirección_IP\"),Agente_usuario:l(\"agente_usuario\"),ID_solicitud:T(\"id_solicitud\",{longitud:36}),marca_de_tiempo:R(\"marca_de_tiempo\").defaultNow().notNull()},n=>[v(\"audit_logs_tenant_idx\").on(n.Id_tenant),v(\"audit_logs_timestamp_idx\").on(n.marca_de_tiempo),v(\"audit _logs_action_idx\").on(n.action)]),ht=pt(x,({muchos:n})=>({direcciones:n(S),transacciones:n(j),webhooks:n(K),cuentasvirtuales:n(_),apiUsage:n(W),agregacionesdefacturación:n(Q),registrosdeauditoría:n(te),monederosprincipales:n(z),criptotransacciones:n(de)})),It=Y(z).omit({id:!0,createdAt:!0,updatedAt:!0}),wt=Y(_).omit({id:!0,createdAt:!0,updatedAt:!0}),At=Y(de).omit({id:!0,createdAt:!0,executedAt:!0,confirmedAt:!0}),bt=Y(x).omit({ id:!0,createdAt:!0,updatedAt:!0}),vt=Y(S).omit({id:!0,createdAt:!0,updatedAt:!0,deletedAt:!0}),kt=Y(j).omit({id:!0,createdAt:!0}),Tt=Y(K).omit({id:!0,createdAt:!0}),_t=Y(W).omit({id:!0,timestamp:!0}),xt=Y(te).omit({id:!0,timestamp:!0}),H={starter:{chains:[\"bitcoin\",\"ethereum\",\"solana\"],maxAddresses:50,maxWebhooks:1,maxVirtualAccounts:0,rateLimit:10,monthlyQuota:1e4,kmsAllowed:!1,archivalAccess :!1, días de retención: 1}, escala: {cadenas: [\"bitcoin\",\"ethereum\",\"solana\",\"polígono\",\"tron\",\"bsc\",\"ripple\",\"cardano\"], direcciones máximas: 1e3, webhooks máximos: 10, cuentas virtuales máximas: 5, límite de tasa: 100, cuota mensual: 1e5, km permitidos:!0, acceso de archivo:!1, días de retención: 7}, empresa: {cadenas: [\"bitcoin\",\"ethereum\",\"solana\",\"polígono\",\"tron\",\"bsc\",\"ripple\",\"cardano\",\"near\",\"polkadot\",\"avalancha\",\"arbitro\",\"optimismo\",\"base\",\"fantasma\",\"cronos\",\"cosmos\",\"algorand\"],máximo de direcciones: -1,máximo de webhooks: -1,máximo de cuentas virtuales: 50,límite de tasa: 1e3,cuota mensual: -1,km permitidos: !0,acceso de archivo: !0,días de retención: 30}},le={creación de dirección:{unidades: 1,costo: 0,001},consulta de saldo:{unidades: 0,costo: 5e-4},saldo de token:{unidades: 1,costo: 0,001},metadatos nft:{unidades: 2,costo: 0,002},tx_br oadcast_btc:{unidades: 50, costo: 0,05}, tx_broadcast_eth:{unidades: 10, costo: 0,01}, tx_broadcast_other:{unidades: 10, costo: 0,01}, tx_history:{unidades: 2, costo: 0,002}, webhook_subscription:{unidades: 0,02, costo: 0,02}, va_create:{unidades: 100, costo: 0,1}, va_transfer:{unidades: 5, costo: 0,005}, tipo de cambio:{unidades: 0,1, costo: 1e-4}, web3_resolve:{unidades: 1, costo: 0,001}, malicioso_check:{unidades: 2, costo: 0,002}, rpc_standard:{u nits:2,costo:2e-4},rpc_eth_call:{unidades:5,costo:5e-4},rpc_debug:{unidades:50,costo:.005}},Be=[\"TRANSACCIÓN_DIRECCIÓN\",\"SALDO_DIRECCIÓN\",\"TRANSACCIÓN_NATIVA_ENTRANTE\",\"TRANSACCIÓN_NATIVA_SALIENTE\",\"TRANSACCIÓN_FUNGIBLE_ENTRANTE\",\"TRANSACCIÓN_FUNGIBLE_SALIENTE\",\"TRANSACCIÓN_NFT_ENTRANTE\",\"TRANSACCIÓN_NFT_SALIENTE\",\"TRANSACCIÓN_MULTITOKEN_ENTRANTE\",\"TRANSACCIÓN_MULTITOKEN_SALIENTE\",\"TRANSACCIÓN_FALLIDA\",\"CUOTA_PAGADA\",\"REGISTRO_DE_CONTRATO _EVENTO\"],me=[{id:\"bitcoin\",nombre:\"Bitcoin\",símbolo:\"BTC\",icono:\"\\u20BF\"},{id:\"ethereum\",nombre:\"Ethereum\",símbolo:\"ETH\",icono:\"\\u039E\"},{id:\"solana\",nombre:\"Solana\",símbolo:\"SOL\",icono:\"\\u25CE\"},{id:\"polígono\",nombre:\"Polígono\",símbolo:\"MATIC\",icono:\"\\u2B21\"},{id:\"tron\",nombre:\"Tron\",símbolo:\"TRX\",icono:\"\\u2666\"},{id:\"bsc\",nombre:\"BNB Cadena\", símbolo:\"BNB\", icono:\"\\u25C6\"},{id:\"ripple\", nombre:\"XRP Ledger\", símbolo:\"XRP\", icono:\"\\u2715\"},{id:\"cardano\", nombre:\"Cardano\", símbolo:\"ADA\", icono:\"\\u20B3\"},{id:\"near\", nombre:\"NEAR\", símbolo:\"NEAR\", icono:\"\\u24C3\"},{id:\"polkadot\", nombre:\"Polkadot\", símbolo:\"DOT\", icono:\"\\u25CF\"},{id:\"avalanche\", nombre:\"Avalanche\", símbolo:\"AVAX\", icono:\"\\u25B2\"},{id:\"arb itrum\", nombre:\"Arbitrum\", símbolo:\"ARB\", icono:\"\\u25C8\"},{id:\"optimism\", nombre:\"Optimism\", símbolo:\"OP\", icono:\"\\u2295\"},{id:\"base\", nombre:\"Base\", símbolo:\"ETH\", icono:\"\\u25EF\"},{id:\"fantom\", nombre:\"Fantom\", símbolo:\"FTM\", icono:\"\\u25C7\"},{id:\"cronos\", nombre:\"Cronos\", símbolo:\"CRO\", icono:\"\\u25CE\"},{id:\"cosmos\",nombre:\"Cosmos\",símbolo:\"ATOM\",icono:\"\\u269B\"},{id:\"algorand\",nombre:\"Algorand\",símbolo:\"ALGO\",icono:\"\\u24B6\"}]});var oe={};xe(oe,{db:()=>f,pool:()=>Ye});import{Pool como St,neonConfig como Pt}desde\"@neondatabase/serverless\";import{drizzle como Rt}desde\"drizzle-orm/neon-serverless\";import Et desde\"ws\";var Ye,f,V=fe(()=>{\"use strict\";D();Pt.webSocketConstructor=Et;if(!process.env.DATABASE_URL)throw new Error(\"DATABASE_URL debe ser ¿Olvidaste aprovisionar una base de datos?\"); Ye=new St({connectionString:process.env.DATABASE_URL}), f=Rt({client:Ye,schema:J})}); function jt(n){return!n||typeof n!=\"string\"||n.length<32?!1:/^[a-zA-Z0-9_-]{32,}$/.test(n)} function Bt(){return P.state===\"open\"?Date.now()-P.lastFailure>=$e.resetTimeoutMs?(P.state=\"half-open\",P.successesInHalfOpen=0,!0):!1:!0} function Dt(){P.estado===\"semiabierto\"?(P.éxitosEnMedioApertura++,P.éxitosEnMedioApertura>=$e.umbralDeÉxitoDeAperturaMedia&&(P.estado=\"cerrado\",P.fallos=0)):P.fallos=0}función ze(){P.fallos++,P.últimoFallo=Fecha.ahora(),(P.estado===\"semiabierto\"||P.fallos>=$e.umbralDeFallo)&&(P.estado=\"abierto\")}función Ut(n,t){devolver t.EstadosReintentables.includes(n)}función Xe(n,t){devolver Math.min(t.baseDelayMs*Math.pow(2,n)+Math.random()*1e3,t.maxDelayMs)}función asíncrona Qe(n){devuelve nueva Promesa(t=>setTimeout(t,n))}función asíncrona N(n,t={},r=Kt){si(!Bt())devuelve{éxito:!1,error:\"Servicio temporalmente no disponible (disyuntor abierto)\",statusCode:503};let i=null;for(let u=0;u<=r.maxRetries;u++)try{let g=new AbortController,h=setTimeout(()=>g.abort(),3e4),s=await fetch(`${Mt}${n}`,{...t,señal:g.señal,encabezados:{\"Tipo-Contenido\":\"aplicación/json\",\"clave-x-api\":Fe||\"\",...t.encabezados}});clearTimeout(h);let a=await s.json().catch(()=>null);if(!s.ok){let e={éxito:!1,error:a?.mensaje||a?.error||`HTTP ${s.estado}`,código-estado:s.estado};if(s.estado===429){let o=s.headers.get(\"Retry-After\");o&&(e.retryAfter=parseInt(o,10)*1e3)}if(Ut(s.status,r)&&u<r.maxRetries){i=e;let o=e.retryAfter||Xe(u,r);await Qe(o);continue}return ze(),e}return Dt(),{éxito:!0,datos:a}}catch(g){let h=g.name===\"Error de cancelación\",s=g.message?.includes(\"obtener\")||g.message?.includes(\"red\"),a={éxito:!1,error:h?\"Tiempo de espera de la solicitud\":g.message||\"Red error\",statusCode:h?408:500};if((h||s)&&u<r.maxRetries){i=a,await Qe(Xe(u,r));continue}return ze(),a}return i||{éxito:!1,error:\"Se excedió el máximo de reintentos\",statusCode:500}}function Je(n){return me.find(t=>t.id===n)}var Mt,Fe,Kt,P,$e,se,B,Oe=fe(()=>{\"use strict\";D();Mt=process.env.TATUM_API_URL||\"https://api.tatum.io\",Fe=process.env.TATUM_API_KEY;Fe?jt(Fe)||console.warn(\"El formato de TATUM_API_KEY parece no ser válido; puede causar errores de API\"):console.warn(\"TATUM_API_KEY no configurado; las llamadas a la API fail\"); Kt={máx.Reintentos:3,Ms.deRetardoBase:1e3,Ms.deRetardoMax:3e4,EstadosReintentables:[408,429,500,502,503,504]}, P={fallos:0,últimoFallo:0,estado:\"cerrado\",éxitosEnMedioApertura:0}, $e={UmbralDeFallo:5,Ms.deRestablecimientoTiempoDeEspera:6e4,UmbralDeÉxitoEnMedioApertura:2}; se={bitcoin:\"bitcoin\",ethereum:\"ethereum\",solana:\"solana\",polygon:\"polígono\",tron:\"tron\",bsc:\"bsc\",ri pple:\"xrp\",cardano:\"ada\",near:\"near\",polkadot:\"dot\",avalanche:\"avax\",arbitrum:\"arbitrum-one\",optimismo:\"optimismo\",base:\"base\",fantom:\"fantom\",cronos:\"cro\",c osmos:\"atom\",algorand:\"algo\"},B={getCircuitBreakerState(){return{...P}},resetCircuitBreaker(){P.failures=0,P.lastFailure=0,P.state=\"closed\",P.successesInHalfOpen=0},async generateAddress(n){let t=se[n]||n;return N(`/v3/${t}/wallet`,{método:\"GET\"})},async getBalance(n,t){let r=se[n]||n;return[\"ethereum\",\"polígono\",\"bsc\",\"arbitrum-one\",\"optimism\",\"base\"].includes(r)?N(`/v3/${r}/account/balance/${t}`):N(r===\"bitcoin\"?`/v3/bitcoin/address/balance/${t}`:r===\"solana\"?`/v3/solana/account/balance/${t}`:`/v3/${r}/account/balance/${t}`)},async getTokens(n,t){let r=se[n]||n;devuelve N(`/v3/data/tokens?chain=${r}&addresses=${t}`)},asincrónico obtenerNFTs(n,t){let r=se[n]||n;devuelve N(`/v3/data/nfts?chain=${r}&addresses=${t}`)},asincrónico obtenerHistorialDeTransacciones(n,t,r){let i=se[n]||n,u=nuevosParámetrosDeBúsquedaDeURL;devuelve r?.TamañoDePágina&&u.set(\"TamañoDePágina\",r.TamañoDePágina.toString()),r?.Desplazamiento&&u.set(\"Desplazamiento\",r.Desplazamiento.toString()),N(`/v3/data/transacciones?chain=${i}&addresses=${t}&${u.toString()}`)},asincrónico getTransaction(n,t){let r=se[n]||n;devuelve N(`/v3/${r}/transaction/${t}`)},async estimateFee(n,t=\"TRANSFER\"){let r=se[n]||n;devuelve N(`/v3/${r}/gas/estimate`,{método:\"POST\",cuerpo:JSON.stringify({tipo:t})})},async broadcastTransaction(n,t){let r=se[n]||n;devuelve N(`/v3/${r}/broadcast`,{método:\"POST\",cuerpo:JSON.stringify({txData:t})})},async getExchangeRates(n){let t=n.join(\",\");devuelve N(`/v3/tatum/rate/${t}?basePair=USD`)}, asíncrono resolveWeb3Name(n){devuelve N(`/v3/blockchain/names/${n}`)}, asíncrono checkMaliciousAddress(n){devuelve N(`/v3/security/address/${n}`)}, asíncrono createWebhook(n){devuelve N(\"/v4/subscription\",{método:\"POST\",cuerpo:JSON.stringify(n)})}, asíncrono deleteWebhook(n){devuelve N(`/v4/subscription/${n}`,{método:\"DELETE\"})}, asíncrono getWebhooks(){devuelve N(\"/v4/subscription\")},async healthCheck(){let n=await N(\"/v3/tatum/version\"); return n.success?{success:!0, data:{status:\"healthy\", version:n.data?.version||\"v3\", circuitBreaker:{...P}}}:{...n, data:{status:\"degraded\", version:\"unknown\", circuitBreaker:{...P}}}}}});var ve={};xe(ve,{GasFeeManager:()=>Ee,gasFeeManager:()=>Le});import{eq as Ge}from\"drizzle-orm\";var Ee,Le,ge=fe(()=>{\"use strict\";V();D();Ee=class{config=null;async loadConfig(){let[t]=await f.select().from(X).limit(1);if(!t){let r={Margen predeterminado global: 40, Margen mínimo: 10, Margen máximo: 100, Anulaciones de cliente:{}, Multiplicadores de cadena de bloques:{ethereum: 1, polígono: .3, bitcoin: 1.2, solana: .1, arbitraje: .2}, Anulaciones de tipo de transacción:{retiro_cripto: 40, transferencia_de_token: 45, contrato_inteligente: 60}};return this.config=r,r}return this.config={globalDefaultMarkup:t.globalDefaultMarkup,minMarkup:t.minMarkup,maxMarkup:t.maxMarkup,clientOverrides:t.clientOverrides||{},blockchainMultipliers:t.blockchainMultipliers||{},transactionTypeOverrides:t.transactionTypeOverrides||{}},this.config}async calculateGasMarkup(t){this.config||await this.loadConfig();let r=this.config.globalDefaultMarkup;if(t.clientId&&this.config.clientOverrides[t.clientId]){let a=this.config.clientOverrides[t.clientId];if(a.expiresAt){let e=new Date(a.expiresAt);new Date<e&&(r=a.markup)}else r=a.markup}let i=this.config.transactionTypeOverrides[t.transactionType];i&&(r=i);let u=this.config.blockchainMultipliers[t.blockchain]||1;r=Math.round(r*u),r=Math.max(this.config.minMarkup,Math.min(this.config.maxMarkup,r));let g=t.gasReal*(r/100),h=t.gasReal+g,s=g;return{gasReal:t.gasReal,gasMarkupPercent:r,gasCharged:h,yourProfit:s}}async updateGlobalMarkup(t,r){t=Math.max(10,Math.min(100,t)),await f.update(X).set({globalDefaultMarkup:t,updatedAt:new Fecha,actualizadoPor:r}).donde(Ge(X.id,\"predeterminado\")),this.config=null,await this.loadConfig()}async setClientMarkup(t,r,i,u,g){this.config||await this.loadConfig();let h=this.config.clientOverrides;h[t]={markup:Math.max(10,Math.min(100,r)),reason:i,expiresAt:g?.toISOString()},await f.update(X).set({clientOverrides:h,actualizadoEn:new Fecha,actualizadoPor:u}).donde(Ge(X.id,\"predeterminado\")),this.config=null,await this.loadConfig()}async removeClientMarkup(t,r){this.config||await this.loadConfig();let i=this.config.clientOverrides;eliminar i[t],esperar f.update(X).set({clientOverrides:i,actualizadoEn:nueva Fecha,actualizadoPor:r}).where(Ge(X.id,\"predeterminado\")),this.config=null,esperar this.loadConfig()}getConfig(){devolver this.config}},Le=new Ee});var ke={};xe(ke,{CryptoGateway:()=>Ne,cryptoGateway:()=>Ht});importar Lt desde\"crypto\";importar{eq como G y como Wt} desde\"drizzle-orm\";var Ne,Ht,Te=fe(()=>{\"usar estricto\";Oe();ge();V();D();Ne=class{async createVirtualAccount(t,r){devolver(esperar f.insert(_).values({Id.inquilino:t,TipoDeCuenta:r,Saldos:JSON.stringify({})}).returning())[0]}async internalSwap(t){let r=await f.query.virtualAccounts.findFirst({where:G(_.id,t.fromAccountId)});if(!r)throw new Error(\"No se encontró la cuenta\");let i=JSON.parse(r.balances||\"{}\"),u=parseFloat(i[t.assetName]||\"0\");if(u<parseFloat(t.fromAmount))throw new Error(\"Saldo insuficiente\");let g=parseFloat(t.toAmount)*.005,h=parseFloat(t.toAmount)-g,s={...i};s[t.assetName]=(u-parseFloat(t.fromAmount)).toString(),await f.update(_).set({balances:JSON.stringify(s)}).where(G(_.id,t.fromAccountId));let a=espera f.consulta.cuentasvirtuales.findFirst({donde:G(_.id,t.toAccountId)}),e=JSON.parse(a?.balances||\"{}\");devuelve e[t.nombreDeActivo]=(parseFloat(e[t.nombreDeActivo]||\"0\")+h).toString(),espera f.update(_).set({balances:JSON.stringify(e)}).donde(G(_.id,t.toAccountId)),{txId:(espera f.insert(de).values({Id.inquilino:t.Id.inquilino,tipo:\"intercambio_interno\",escenario:t.scenario,Id.deCuenta:t.deCuenta,Id.deCuenta:t.deCuenta,Tipo.deActivo:\"cripto\",Nombre.deActivo:t.deActivo,cadena.de.blockchain:t.blockchain,importe:t.deImporte,importe.de.comisión:g.de.Cadena(),comisión.Usd:(g*45e3).de.Cadena(),estado:\"completado\"}).returning())[0].id,estado:\"completado\",deImporte:t.deImporte,de.Importe:t.de.Importe,comisión:g.de.Fijo(8),neto.Recibido:h.de.Fijo(8),ejecutadoEn:nuevaFecha().de.CadenaISO()}}asincrónico externalWithdraw(t){let r=await f.query.masterWallets.findFirst({where:Wt(G(z.assetName,t.assetName),G(z.blockchain,t.blockchain),G(z.scenario,t.scenario))});if(!r)throw new Error(`No se encontró la billetera maestra para ${t.assetName} en ${t.blockchain}`);let i=await B.estimateGas({blockchain:t.blockchain,assetType:t.assetName===r.smartContractAddress?\"token\":\"crypto\",amount:t.amount}),u=await Le.calculateGasMarkup({clientId:t.tenantId,blockchain:t.blockchain,transactionType:t.assetName===\"BTC\"?\"crypto_withdraw\":\"token_transfer\",gasReal:i.gasReal}),g=await f.query.virtualAccounts.findFirst({where:G(_.id,t.fromAccountId)}),h=JSON.parse(g?.balances||\"{}\"),s=parseFloat(h[t.assetName]||\"0\");if(s<parseFloat(t.amount))throw new Error(\"Saldo insuficiente\");h[t.assetName]=(s-parseFloat(t.amount)).toString(),await f.update(_).set({balances:JSON.stringify(h)}).where(G(_.id,t.fromAccountId));let a=`0x${Lt.randomBytes(32).toString(\"hex\")}`;return{txId:(await f.insert(de).values({Id.inquilino:t.inquilino,tipo:\"retiro_externo\",escenario:t.scenario,toExternalAddress:t.toExternalAddress,tipo.activo:\"cripto\",nombre.activo:t.nombre.activo,blockchain:t.blockchain,cantidad:t.cantidad,gasReal:u.gasReal.toString(),porcentaje.de.margen.gas:u.porcentaje.de.margen.gas,gasCargado :u.gasCharged.toString(),commissionAmount:u.yourProfit.toString(),status:\"pendiente\",txHash:a}).returning())[0].id,status:\"pendiente_de_confirmación\",txHash:a,amount:t.amount,gasReal:u.gasReal.toFixed(8),gasCharged:u.gasCharged.toFixed(8),yourProfit:u.yourProfit.toFixed(8),estimatedTime:\"12 segundos\"}}async assignMasterToClient(t,r,i){return await f.update(z).set({assignedToTenantId:r,gasMarkupPercentage:i}).where(G(z.id,t)),{success:!0,masterId:t,assignedTo:r,gasMarkup:i,assignedAt:new Date().toISOString()}}async getVirtualAccountBalance(t){let r=await f.query.virtualAccounts.findFirst({where:G(_.id,t)});if(!r)throw new Error(\"Cuenta no encontrada\");let i=JSON.parse(r.balances||\"{}\"); return{accountId:t,balances:i,totalUsd:Object.entries(i).reduce((u,[g,h])=>{let s={ETH:2500,BTC:45e3,GOLD:500,SILVER:250}; return u+parseFloat(h)*(s[g]||0)},0)}}},Ht=new Ne});import Ce de\"express\";import{z como w} de\"zod\";D();V();import{eq como A,and como Z,desc como ie,sql como De,gte como Nt,lte como Ct} de\"drizzle-orm\";var Ue=class{async getTenant(t){let[r]=await f.select().from(x).where(A(x.id,t));return r||void 0}async getTenantByApiKeyHash(t){let[r]=await f.select().from(x).where(A(x.apiKeyHash,t));return r||void 0}async getTenantByEmail(t){let[r]=await f.select().from(x).where(A(x.email,t));return r||void 0}async getAllTenants(){return f.select().from(x).orderBy(ie(x.createdAt))}async createTenant(t){let[r]=await f.insert(x).values(t).returning();return r}async updateTenant(t,r){let[i]=await f.update(x).set({...r,updatedAt:nueva fecha}).where(A(x.id,t)).returning();devolver i||void 0}async deleteTenant(t){await f.update(x).set({estado:\"eliminado\",updatedAt:nueva fecha}).where(A(x.id,t))}async getAddress(t){let[r]=await f.select().from(S).where(A(S.id,t));devolver r||void 0}async getAddressByAddress(t,r,i){let[u]=await f.select().from(S).where(Z(A(S.tenantId,t),A(S.chain,r),A(S.address,i)));devolver u||void 0}async getAddressesByTenant(t,r){let i=f.select().from(S).where(A(S.tenantId,t)),u=[A(S.tenantId,t)];devuelve r?.chain&&u.push(A(S.chain,r.chain)),r?.status&&u.push(A(S.status,r.status)),f.select().from(S).where(Z(...u)).orderBy(ie(S.createdAt)).limit(r?.limit||50).offset(r?.offset||0)}asincrónico countAddressesByTenant(t){let[r]=await f.select({count:De`count(*)`}).from(S).where(Z(A(S.tenantId,t),A(S.status,\"active\")));devuelve r?.count||0}asincrónico createAddress(t){let[r]=await f.insert(S).values(t).returning();return r}async updateAddress(t,r){let[i]=await f.update(S).set({...r,updatedAt:nueva fecha}).where(A(S.id,t)).returning();return i||void 0}async archiveAddress(t){await f.update(S).set({estado:\"archivado\",eliminadoAt:nueva fecha,updatedAt:nueva fecha}).where(A(S.id,t))}async getTransaction(t){let[r]=await f.select().from(j).where(A(j.id,t));return r||void 0}async getTransactionByHash(t,r){let[i]=await f.select().from(j).where(Z(A(j.chain,t),A(j.txHash,r)));return i||void 0}async getTransactionsByTenant(t,r){let i=[A(j.tenantId,t)];return r?.chain&&i.push(A(j.chain,r.chain)),r?.status&&i.push(A(j.status,r.status)),f.select().from(j).where(Z(...i)).orderBy(ie(j.createdAt)).limit(r?.limit||50).offset(r?.desplazamiento||0)}asincrónico createTransaction(t){let[r]=await f.insert(j).values(t).returning();devolver r}asincrónico updateTransaction(t,r){let[i]=await f.update(j).set(r).where(A(j.id,t)).returning();devolver i||void 0}asincrónico getWebhook(t){let[r]=await f.select().from(K).where(A(K.id,t));devolver r||void 0}asincrónico getWebhooksByTenant(t){devolver f.select().from(K).where(A(K.tenantId,t)).orderBy(ie(K.createdAt))}asincrónico countWebhooksByTenant(t){let[r]=await f.select({count:De`count(*)`}).from(K).where(Z(A(K.tenantId,t),A(K.active,!0)));devuelve r?.count||0}asinc createWebhook(t){let[r]=await f.insert(K).values(t).returning();devuelve r}asinc updateWebhook(t,r){let[i]=await f.update(K).set(r).where(A(K.id,t)).returning();devuelve i||void 0}asinc deleteWebhook(t){await f.delete(K).where(A(K.id,t))}asinc getVirtualAccount(t){let[r]=await f.select().from(_).where(A(_.id,t));devuelve r||void 0}asinc obtenerCuentasVirtualesPorInquilino(t){devolver f.seleccionar().de(_).donde(A(_.IdInquilino,t)).ordenarPor(ie(_.createdAt))}asincrónico contarCuentasVirtualesPorInquilino(t){let[r]=await f.seleccionar({count:De`count(*)`}).de(_).donde(Z(A(_.IdInquilino,t),A(_.estado,\"activo\")));devolver r?.count||0}asincrónico crearCuentaVirtual(t){let[r]=await f.insertar(_).valores(t).devolver();devolver r}asincrónico actualizarCuentaVirtual(t,r){let[i]=await f.actualizar(_).set(r).donde(A(_.id,t)).devolver();devolver i||void 0}asincrónico recordApiUsage(t){let[r]=await f.insert(W).values(t).returning();return r}async getApiUsageByTenant(t,r,i){return f.select().from(W).where(Z(A(W.tenantId,t),Nt(W.timestamp,r),Ct(W.timestamp,i))).orderBy(ie(W.timestamp))}async getApiUsageStats(t,r,i){let u=await this.getApiUsageByTenant(t,r,i),g={},h={},s=0,a=0;for(let e of u)s+=e.unidades,a+=e.créditos,g[e.punto final]=(g[e.punto final]||0)+1,e.cadena&&(h[e.cadena]=(h[e.cadena]||0)+1);return{totalRequests:u.length,totalUnits:s,totalCredits:a,byEndpoint:g,byChain:h}}async getBillingAggregation(t,r){let[i]=await f.select().from(Q).where(Z(A(Q.tenantId,t),A(Q.periodo,r)));return i||void 0}async upsertBillingAggregation(t){let r=await this.getBillingAggregation(t.tenantId,t.periodo);if(r){let[i]=await f.update(Q).set(t).where(A(Q.id,r.id)).returning();return i}else{let[i]=await f.insert(Q).values(t).returning();return i}}async createAuditLog(t){let[r]=await f.insert(te).values(t).returning();return r}async getAuditLogsByTenant(t,r=100){return f.select().from(te).where(A(te.tenantId,t)).orderBy(ie(te.timestamp)).limit(r)}},p=new Ue;Oe();import ce from\"crypto\";D();var Ze=process.env.ADMIN_API_KEY;function Ie(){let n=`tatum_${ce.randomBytes(28).toString(\"hex\")}`,t=n.substring(0,16),r=tt(n);devolver{clave:n,prefijo:t,hash:r}}función tt(n){devolver ce.createHash(\"sha256\").update(n).digest(\"hex\")}función we(){devolver ce.randomBytes(32).toString(\"hex\")}función st(){devolver`req_${ce.randomBytes(16).toString(\"hex\")}`}función asíncrona b(n,t,r){n.requestId=st(),t.setHeader(\"X-Request-ID\",n.requestId);deje que i=n.headers[\"x-api-key\"]; if(!i)return t.status(401).json({success:!1,error:\"Clave API faltante\",requestId:n.requestId});let u=tt(i),g=await p.getTenantByApiKeyHash(u); if(!g)return t.status(401).json({success:!1,error:\"Clave API no válida\",requestId:n.requestId}); if(g.status!==\"activo\")return t.status(403).json({success:!1,error:`La cuenta es ${g.status}`,requestId:n.requestId});n.tenant=g,r()}function $(n,t,r){n.requestId=st(),t.setHeader(\"X-Request-ID\",n.requestId);let i=n.headers[\"x-admin-key\"];if(!Ze)return t.status(503).json({éxito:!1,error:\"API de administración no configurada\",requestId:n.requestId});if(!i)return t.status(401).json({éxito:!1,error:\"Falta la clave de API de administración\",requestId:n.requestId});let u=ce.createHash(\"sha256\").update(i).digest(\"hex\"),g=ce.createHash(\"sha256\").update(Ze).digest(\"hex\");if(!ce.timingSafeEqual(Buffer.from(u),Buffer.from(g)))return t.status(401).json({éxito:!1,error:\"Clave de API de administrador no válida\",requestId:n.requestId});n.isAdmin=!0,r()}var et=new Map;function k(n,t,r){if(!n.tenant)return r();let i=n.tenant.id,u=Date.now(),g=1e3,h=et.get(i);(!h||h.resetAt<u)&&(h={count:0,resetAt:u+g},et.set(i,h)),h.count++;let s=n.tenant.rateLimit,a=Math.max(0,sh.count);if(t.setHeader(\"X-RateLimit-Límite\",s),t.setHeader(\"X-RateLimit-Restante\",a),t.setHeader(\"X-RateLimit-Restablecer\",Math.ceil(h.resetAt/1e3)),h.count>s)return t.status(429).json({éxito:!1,error:\"Límite de tasa excedido\", requestId:n.requestId,retryAfter:Math.ceil((h.resetAt-u)/1e3)});r()}función en(n){return(t,r,i)=>{if(!t.tenant)return r.status(401).json({éxito:!1,error:\"Se requiere autenticación\", requestId:t.requestId});let u=H[t.tenant.tier];if(!u)return r.status(403).json({éxito:!1,error:\"Configuración de nivel no válida\", requestId:t.requestId});if(n===\"kms\"&&!u.kmsAllowed)return r.status(403).json({éxito:!1,error:\"KMS no está disponible en Su nivel. Actualice a Scale o Enterprise.\",requestId:t.requestId,upgrade:!0});if(n===\"archival\"&&!u.archivalAccess)return r.status(403).json({success:!1,error:\"El acceso a archivos no está disponible en su nivel. Actualice a Enterprise.\",requestId:t.requestId,upgrade:!0});i()}}function Ae(n,t,r){if(!n.tenant)return r();let i=n.params.chain||n.body?.chain;if(!i)return r();let g=H[n.tenant.tier]?.chains||n.tenant.allowedChains;if(!g.includes(i))return t.status(403).json({success:!1,error:`La cadena '${i}' no está disponible en su nivel`,allowedChains:g,requestId:n.requestId,upgrade:!0});r()}D();función asíncrona nt(){if(!process.env.SEED_DEMO_DATA)return null;console.log(\"Comprobando si hay un inquilino de demostración...\");let n=await p.getTenantByEmail(\"demo@tatum-gateway.io\");if(n)return console.log(\"El inquilino de demostración ya existe\"),n;console.log(\"Creando inquilino de demostración...\"); let{prefix:t,hash:r}=Ie(),i=H.scale,u=await p.createTenant({name:\"Cuenta de demostración\",email:\"demo@tatum-gateway.io\",tier:\"scale\",status:\"active\",apiKeyPrefix:t,apiKeyHash:r,hmacSecret:we(),allowedChains:i.chains,maxAddresses:i.maxAddresses,maxWebhooks:i.maxWebhooks,maxVirtualAccounts:i.maxVirtualAccounts,rateLimit:i.rateLimit,monthlyQuota:i.monthlyQuota,companyName:\"Demostración de Tatum Gateway\",website:\"https://tatum.io\"});console.log(\"Inquilino de demostración creado:\",u.id),await p.createAuditLog({Id.inquilino:u.id,acción:\"inquilino.creado\",recurso:\"inquilino\",Id.recurso:u.id,cambios:{nivel:\"escala\",origen:\"semilla\"}});para(dejar g=0;g<10;g++)esperar p.recordApiUsage({Id.inquilino:u.id,punto final:`/api/v1/${[\"direcciones\",\"saldos\",\"tokens\",\"transacciones\"][g%4]}`,método:[\"OBTENER\",\"POST\"][g%2],cadena:[\"ethereum\",\"bitcoin\",\"solana\",\"polígono\"][g%4],acción:[\"saldo consulta_de_ance\",\"creación_de_dirección\",\"saldo_de_token\",\"historial_de_transacciones\"][g%4],unidades:[.5,1,1,2][g%4],créditos:[5e-4,.001,.001,.002][g%4],código_de_estado:200,id_de_solicitud:`demo_${g}`,tiempo_de_respuestaMs:50+Math.floor(Math.random()*100)});retorno console.log(\"¡Datos de uso de demostración sembrados!\"),u}D();función O(n){return async(t,r,i)=>{if(!t.tenant)return i();let u=le[n];t.metered={acción:n,unidades:u.units,créditos:u.cost};let g=r.json.bind(r);r.json=h=>{let s=Date.now();return p.recordApiUsage({Id.inquilino:t.id.inquilino, punto final:t.ruta, método:t.método, cadena:t.params.cadena||t.cuerpo?.cadena||nulo, acción:n, unidades:u.unidades, créditos:u.costo, código de estado:r.código de estado, Id.solicitud:t.id.solicitud, tiempo de respuesta:Fecha.ahora()-s, metadatos:{agente-usuario:t.encabezados[\"agente-usuario\"], ip:t.ip}}).catch(consola.error),h&&tipo de h==\"objeto\"&&(h.meta={...h.meta, Id.solicitud:t.id.solicitud, marca de tiempo:nueva Fecha().toISOString(),medido:{acción:n,unidades:u.unidades,créditos:u.costo}}),g(h)},i()}}función asíncrona be(n){let t=nueva fecha,r=nueva fecha(t.getFullYear(),t.getMonth(),1),i=await p.getApiUsageStats(n,r,t);return{totalRequests:i.totalRequests,totalUnits:i.totalUnits,totalCredits:i.totalCredits,costUsd:i.totalCredits}}función asíncrona Se(n,t){if(t===-1)return{permitido:!0,usado:0,restante:-1,porcentajeUsado:0};let r=await ser(n),i=Math.floor(r.totalUnits),u=ti,g=i/t*100;devolver{permitido:u>0,usado:i,restante:Math.max(0,u),porcentajeUsado:Math.min(100,g)}}función ae(n,t,r){si(!n.inquilino)devolver r();Se(n.inquilino.id,n.inquilino.cuotamensual).entonces(i=>{si(t.setHeader(\"X-Cuota-Usada\",i.usada),t.setHeader(\"X-Cuota-Restante\",i.restante),t.setHeader(\"X-Cuota-Porcentaje\",Math.round(i.porcentajeUsado)),!i.permitido)devolver t.status(429).json({success:!1,error:\"Cuota mensual excedida\",requestId:n.requestId,quota:{used:i.used,limit:n.tenant.cuotamensual,porcentajeUsado:i.porcentajeUsado},actualización:!0});r()}).catch(()=>r())}D();importar Ft desde\"crypto\";var $t=1e5,Ot=32,qt=\"sha256\",ne=null,pe=class n{secretomaestro;versión;createdAt;estático SALT_PREFIXES={claveprivada:\"kms:clave_privada:v1\",carteramaestra:\"kms:cartera_maestra:v1\",secretohmac:\"kms:secretohmac:v1\",derivacióndeclaveapi:\"kms:claveapi:v1\",cifradodesesión:\"kms:sesión:v1\"};constructor(t,r=1){if(!t||t.length<32)arrojar nuevo Error(\"El secreto maestro debe ser al menos 32 bytes (usar: openssl rand -hex 16)\");this.masterSecret=t,this.version=r,this.createdAt=new Date,t.length<64&&console.warn(\"\\u26A0\\uFE0F ADVERTENCIA: El secreto del KMS maestro tiene menos de 64 bytes. Considere usar: openssl rand -hex 32\")}static initialize(t){let r=t||process.env.MASTER_KMS_SECRET||process.env.SESSION_SECRET;if(!r)throw new Error(\"Variable de entorno MASTER_KMS_SECRET no establecida. Generar con: openssl rand -hex 32\");return ne||(ne=new n(r),console.log(\"\\u2705 KMS inicializado con secreto maestro\"),ne)}static getInstance(){return ne||(ne=n.initialize()),ne}deriveKey(t,r=\"\"){let i=n.SALT_PREFIXES[t];if(!i)throw new Error(`Tipo de clave desconocida: ${t}`);let u=Buffer.from(`${i}:${r}`);return{key:Ft.pbkdf2Sync(this.masterSecret,u,$t,Ot,qt),version:this.version,keyType:t}}derivePrivateKeyEncryptionKey(t){return this.deriveKey(\"privateKey\",t).key}deriveMasterWalletKey(t){return this.deriveKey(\"masterWallet\",t).key}deriveHmacKey(t){return this.deriveKey(\"hmacSecret\",t).key}deriveSessionEncryptionKey(t){return this.deriveKey(\"sessionEncryption\",t).key}getConfig(){return{masterSecret:\"[CENSURADO]\",version:this.version,createdAt:this.createdAt}}rotate(t){let r=new n(t,this.version+1);return ne=r,console.log(`\\u2705 KMS rotado a la versión ${r.version}`),r}static test(){try{let t=n.getInstance(),r=t.deriveKey(\"privateKey\",\"test-wallet-1\"),i=t.deriveKey(\"privateKey\",\"test-wallet-1\");if(r.key.toString(\"hex\")!==i.key.toString(\"hex\"))throw new Error(\"La derivación de la clave KMS no es determinista\");let u=t.deriveKey(\"privateKey\",\"test-wallet-2\");if(r.key.toString(\"hex\")===u.key.toString(\"hex\"))throw new Error(\"Colisión de derivación de clave KMS detectada\");return console.log(\"\\u2705 Autoprueba de KMS aprobada\"),!0}catch(t){return console.error(\"\\u274C Autoprueba de KMS fallida:\",t),!1}}};try{pe.initialize()}catch(n){console.warn(\"\\u26A0\\uFE0F Advertencia de inicialización de KMS:\",n)}import qe from\"crypto\";var Pe=\"aes-256-gcm\",Re=32,Gt=16;function rt(n,t,r){if(t.length!==Re)throw new Error(`La clave de cifrado debe ser de ${Re} bytes`);let i=qe.randomBytes(Gt),u=qe.createCipheriv(Pe,t,i);r&&u.setAAD(Buffer.from(r));let g=Buffer.concat([u.update(n,\"utf8\"),u.final()]),h=u.getAuthTag();return{ciphertext:g.toString(\"hex\"),iv:i.toString(\"hex\"),authTag:h.toString(\"hex\"),algorithm:Pe}}function ot(n,t,r){if(t.length!==Re)throw new Error(`La clave de cifrado debe tener ${Re} bytes`);if(n.algorithm!==Pe)throw new Error(`Algoritmo no compatible: ${n.algorithm}`);let i=Buffer.from(n.iv,\"hex\"),u=Buffer.from(n.ciphertext,\"hex\"),g=Buffer.from(n.authTag,\"hex\"),h=qe.createDecipheriv(Pe,t,i);r&&h.setAAD(Buffer.from(r)),h.setAuthTag(g);try{return Buffer.concat([h.update(u),h.final()]).toString(\"utf8\")}catch{throw new Error(\"Error de descifrado: los datos pueden estar dañados o alterados\")}}import{sql como Vt}desde\"drizzle-orm\";import{webcrypto como it}desde\"crypto\";var Yt=w.object({nombre:w.string().min(2),correo electrónico:w.string().correo electrónico(),nivel:w.enum([\"starter\",\"scale\",\"enterprise\"]).predeterminado(\"starter\"),nombreDeEmpresa:w.string().opcional(),sitio web:w.string().url().opcional(),correo electrónico de facturación:w.string().correo electrónico().opcional()}),zt=w.object({cadena:w.string(),etiqueta:w.string().opcional(),etiquetas:w.array(w.string()).opcional(),URLdelwebhook:w.string().url().opcional()}),Xt=w.object({url:w.string().url(),eventos:w.array(w.enum(Be)).min(1)});función asíncrona ct(n,t){nt().catch(console.error),t.get(\"/\",(s,a)=>{a.json({name:\"Tatum API Gateway\",version:\"1.0.0\",description:\"API Gateway de blockchain de nivel empresarial compatible con más de 130 blockchains\",status:\"running\",documentation:\"GET /api/docs | GET /api/docs/model | GET /api/docs/examples\",quickStart:\"1. Obtener la clave API del administrador | 2. Agregar el encabezado 'x-api-key: YOUR_KEY' | 3. Enviar por POST a /api/tenants para registrarse\",endpoints:{health:\"GET /api/health\",pricing:\"GET /api/pricing\",chains:\"GET /api/chains\",tenants:\"GET /api/tenants | POST /api/inquilinos\", direcciones:\"GET /api/v1/direcciones | POST /api/v1/direcciones\", transacciones:\"GET /api/v1/transacciones\", webhooks:\"POST /api/v1/webhooks | GET /api/v1/webhooks\", puerta de enlace:\"POST /api/v1/puerta de enlace/cuentas-virtuales | GET /api/v1/puerta de enlace/cuentas-virtuales | POST /api/v1/puerta de enlace/intercambio | POST /api/v1/puerta de enlace/retiro\", administrador:\"GET /api/admin/configuración-gas | PUT /api/admin/configuración-gas/global | GET /api/admin/ingresos | GET /api/admin/transacciones\", rwa:\"POST /api/v1/rwa/tokens | GET /api/v1/rwa/tokens | POST /api/v1/rwa/tokens/:id/transfer\"},businessModel:{type:\"Puerta de enlace API de doble panel (100 % de ingresos de administración)\",panels:{cryptoPanel:{description:\"Control de billetera maestra con sistema de cuentas virtuales\",revenueStreams:{internalSwaps:\"0,5 % de comisión (sin comisiones de gas)\",gasMarkup:\"40 % de margen configurable sobre las comisiones de gas\",setupFees:\"$500 por cliente de RWA\"},annualRevenue:\"$204K (Y1) \\u2192 $1.02M (Y2) \\u2192 $2.04M (Y3)\"}, rwaPanel:{description:\"Infraestructura de tokenización de activos del mundo real\",revenueStreams:{setupFees:\"$500 por token (pago único)\",nnualFees:\"$200 por token al año\",tradingCommissions:\"0.5% del volumen total de operaciones (100% para administración)\"},annualRevenue:\"$654K (Y1) \\u2192 $8.07M (Y2) \\u2192 $60.21M (Y3)\"}},profitMargins:\"82.5% (Y1) \\u2192 91.2% (Y2) \\u2192 96,8 % (año 3)\", totalProjections:{año 1:\"$858 000\", año 2:\"$9,09 000\", año 3:\"$62,25 000\"}}, auth:{type:\"Clave API + HMAC\", method:\"x-api-key header (Tatum v3 recommended)\", example:\"curl -H 'x-api-key: YOUR_API_KEY' https://api.example.com/api/v1/...\", documentation:\"https://docs.tatum.io/docs/authentication\"}, rateLimit:\"Por nivel: Starter 10/s, Scale 100/s, Enterprise 1000/seg\",docs:\"https://api.tatum.io/docs\",github:\"https://github.com/MasterFital/tatum-api-gateway\"})}),t.get(\"/api/docs/model\",(s,a)=>{a.json({title:\"Tatum API Gateway - Modelo de Negocio\",introduction:\"Arquitectura de doble panel que genera el 100% de ingresos administrativos mediante el trading de criptomonedas y la tokenización de RWA\",panels:{crypto:{name:\"Panel CRYPTO (100% de tus ingresos)\",description:\"Controlas las billeteras maestras (BTC, ETH, SOL, MATIC). Los clientes operan a través de cuentas virtuales.\",how_it_works:{step1:\"El administrador crea billeteras maestras mediante POST /api/admin/master-wallets\",step2:\"Los clientes crean cuentas virtuales mediante POST /api/v1/gateway/virtual-accounts\",paso 3:\"Los clientes pueden intercambiar internamente (comisión del 0,5 % para usted) o retirar externamente (margen de beneficio del 40 %)\",paso 4:\"El administrador registra todos los ingresos mediante GET /api/admin/revenue\"},revenue_streams:{internal_swaps:{description:\"El cliente intercambia BTC \\u2192 ETH\",fee:\"0,5 % del importe del intercambio\",gas_cost:\"Cero (interno)\",admin_profit:\"100 % de la comisión\",example:\"El cliente intercambia 1 ETH \\u2192 0,02 BTC | Comisión: 0,0001 BTC (100 % para el administrador)\"},gas_markup:{description:\"El cliente retira criptomonedas a una billetera externa\",fee:\"Margen de beneficio del 40 % sobre el gas real costo\", ejemplo:\"Gas Bitcoin: $3 reales | Cobras: $4.20 | Tu ganancia: $1.20 (40%)\"}}, proyecciones:{año1:{volumen:\"Promedio de 1 millón de USD/mes\", swaps mensuales:\"5K \\xD7 0.5% = $25K\", gas mensual:\"Retiros de 10K \\xD7 $3 \\xD7 40% = $12K\", total mensual:\"$17K\", anual:\"$204K\"}, año2:{volumen:\"Promedio de 5 millones de USD/mes\", anual:\"$1.02M\"}, año3:{volumen:\"Promedio de 10 millones de USD/mes\", anual:\"$2.04M\"}}}, rwa:{nombre:\"Panel RWA (100% Tus Ingresos + Tarifas)\", descripción:\"Los clientes emiten tokens. Tú proporcionas la infraestructura. Te quedas con el 100% de las tarifas y comisiones de trading.\", cómo_funciona:{paso 1:\"El cliente solicita la creación de un token: POST /api/v1/rwa/tokens\", paso 2:\"Cobras $500 de comisión de configuración + implementación del contrato inteligente\", paso 3:\"El token se activa. Los clientes operan internamente (comisión del 0,5 % para ti)\", paso 4:\"Comisión anual de mantenimiento de $200 por token\", paso 5:\"Todos los retiros externos tienen un margen de gas del 40 % (para ti)\", paso 6:\"Seguimiento de los ingresos mediante GET /api/admin/rwa-revenue\"},revenue_streams:{setup_fees:{description:\"Comisión única por token lanzado\",amount:\"$500\",frequency:\"Por token\"},annual_fees:{description:\"Mantenimiento anual por token activo\",amount:\"$200\",frequency:\"Por token por año\"}, comisiones_comerciales:{descripción:\"0.5% del volumen total de operaciones de tokens (100% para el administrador)\", porcentaje:\"0.5%\", ejemplo:\"Volumen de tokens: $100,000/mes | Su comisión: $500/mes = $6,000/año por token\"}, margen_gas:{descripción:\"40% de margen en las comisiones de gas para retiros externos\", porcentaje:\"40%\"}}, beneficios_del_cliente:{beneficio1:\"Infraestructura de tokenización (su costo: ~$0.10 por token)\", beneficio2:\"Mercado listo para usar\", beneficio3:\"Liquidez instantánea (operadores del día 1)\", beneficio4:\"Seguridad y cumplimiento a su cargo\", pago_del_cliente:\"$500 de configuración + $200/año solo\"}, proyecciones:{año1:{tokens:\"20 tokens nuevos\", tarifas_de_configuración:\"20 \\xD7 $500 = $10K\", tarifas_anuales:\"20 \\xD7 $200 = $4K\", comisiones_de_operación:\"0.5% de un volumen de ~$100M = $500K\", total:\"$514K\"}, año2:{tokens:\"100 tokens en total\", tarifas_de_configuración:\"100 \\xD7 $500 = $50K\", tarifas_anuales:\"100 \\xD7 $200 = $20K\", comisiones_de_operación:\"0.5% de un volumen de ~$1.6B = $8M\",total:\"$8.07M\"},año3:{tokens:\"300 tokens en total\",tarifas_de_configuración:\"300 \\xD7 $500 = $150K\",tarifas_anuales:\"300 \\xD7 $200 = $60K\",comisiones_de_comercio:\"0.5% de un volumen de ~$12B = $60M\",total:\"$60.21M\"}}}},resumen_de_ingresos:{título:\"Ingresos combinados (Cripto + RWA)\",año 1:{cripto:\"$204K\",rwa:\"$654K\",total:\"$858K\",margen:\"82.5%\"},año 2:{cripto:\"$1.02M\",rwa:\"$8.07M\",total:\"$9.09M\",margen:\"91.2%\"},año 3:{cripto:\"$2.04M\",rwa:\"$60.21M\",total:\"$62.25M\",margen:\"96.8%\"}},puntos_clave:[\"El 100% de todos los ingresos van al administrador (usted)\",\"Los clientes obtienen acceso a la infraestructura, no a la repartición de ingresos\",\"Las tarifas de configuración son ingresos inmediatos\",\"Las comisiones de trading escalan infinitamente con el volumen\",\"El margen de gas es puro beneficio (costo mínimo de infraestructura)\",\"Costo de adquisición de clientes cero (los clientes se traen a sí mismos)\"]})}),t.get(\"/api/docs/examples\",(s,a)=>{a.json({title:\"Tatum API Gateway - Ejemplos de uso\",autenticación: {descripción:\"Todas las solicitudes requieren el encabezado x-api-key\",ejemplo:\"curl -H 'x-api-key: YOUR_API_KEY' https://api.example.com/api/v1/...\",encabezados:{\"x-api-key\":\"Su clave API del administrador\",\"Content-Type\":\"application/json\"}},crypto_examples: {título:\"Ejemplos del panel CRYPTO\",create_virtual_account: {descripción:\"El cliente crea una cuenta virtual para almacenar criptomonedas\",endpoint:\"POST /api/v1/gateway/virtual-accounts\",solicitud:{tipoDeCuenta:\"individual\"},respuesta:{éxito:!0,cuentaVirtual:{id:\"va-123\",identificadorDeInquilino:\"cliente-1\",tipoDeCuenta:\"individual\",saldos:{BTC:\"0\",ETH:\"0\",SOL:\"0\"},estado:\"activo\"}}},interno_swap_0_5_percent:{descripción:\"El cliente intercambia BTC por ETH (comisión del 0,5 % para el administrador)\",punto final:\"POST /api/v1/gateway/swap\", solicitud: {fromAccountId:\"va-123\", fromAsset:\"BTC\", toAsset:\"ETH\", importe:\"1.0\"}, respuesta: {éxito:!0, intercambio: {id:\"swap-456\", fromAsset:\"BTC\", toAsset:\"ETH\", importe:\"1.0\", comisión:\"0.005 BTC (0.5% para el administrador)\", estado:\"completado\"}, nota:\"Sin comisiones de gas, comisión del 0.5% aplicada\"}}, external_withdraw_40_percent_markup: {descripción:\"El cliente retira a una billetera externa (40% de margen de gas para el administrador)\", punto final:\"POST /api/v1/gateway/withdraw\", solicitud: {fromAccountId:\"va-123\", activo:\"ETH\", importe:\"1.0\", dirección:\"0x1234567890abcdef...\"}, respuesta: {éxito:!0, retiro: {id:\"withdraw-789\", activo:\"ETH\", importe:\"1.0\", dirección:\"0x1234567890abcdef...\", gasReal:\"3 USD\", gasCharged:\"4.20 USD (40% de margen)\", adminProfit:\"1.20 USD\", estado:\"pendiente\", txHash:\"0xabcd...\"}}}, ver_historial_de_transacciones: {descripción:\"El cliente visualiza su transacción historial\", punto final:\"GET /api/v1/transactions?limit=50\", respuesta:{éxito:!0, transacciones:[{id:\"swap-456\", tipo:\"internal_swap\", activo:\"BTC\", importe:\"1.0\", comisión:\"0.005\", estado:\"completado\", creado el:\"2024-11-30T10:00:00Z\"}], paginación:{total:42, límite:50, desplazamiento:0}}}}, ejemplos_rwa:{título:\"Ejemplos de paneles RWA\", crear_rwa_token_500_setup:{descripción:\"El cliente crea un token (paga $500 de tarifa de configuración al administrador)\", punto final:\"POST /api/v1/rwa/tokens\",solicitud:{nombreDeActivo:\"Fondo Inmobiliario\",símbolo:\"REF\",cadenaDeBlockchain:\"Ethereum\",decimales:18,suministroTotal:\"1000000\",nombreDeEmisor:\"RE Properties Inc\",descripción:\"Inversión Inmobiliaria Tokenizada\"},respuesta:{éxito:!0,token:{id:\"token-ref-1\",nombreDeActivo:\"Fondo inmobiliario\", símbolo:\"REF\", cadena de bloques:\"ethereum\", suministro total:\"1000000\", dirección del contrato inteligente:\"0x...\", estado:\"creado\"}, precios: {tarifa de configuración:\"$500 (pago único) - PAGADO AL ADMINISTRADOR\", tarifa anual:\"$200/año - PAGADO AL ADMINISTRADOR\", comisión de negociación:\"0.5% en todas las operaciones - 100% PARA EL ADMINISTRADOR\"}}}, lista_rwa_tokens: {descripción:\"El cliente visualiza sus tokens y volumen de operaciones\", punto final:\"GET /api/v1/rwa/tokens\", respuesta: {éxito:!0, tokens:[{id:\"token-ref-1\", nombre_del_activo:\"Bienes raíces Fondo\", símbolo:\"REF\", cadena de bloques:\"ethereum\", oferta total:\"1000000\", estado:\"activo\", tarifa de configuración:\"500, tarifa anual:\"200, volumen de negociación:\"250000 USD\", comisión de negociación:\"1250 USD (0,5 % para el administrador)\"}], resumen:{totalTokens:\"1, comisiones de negociación totales:\"1250 USD (100 % para el administrador)\", tarifas de configuración cobradas:\"500 USD (100 % para el administrador)\"}}}, rwa_token_transfer_0_5_percent:{descripción:\"El titular del token negocia el token REF (0,5 % de comisión para el administrador)\", punto final:\"POST /api/v1/rwa/tokens/token-ref-1/transfer\",request:{toAddress:\"0xabcd...\",amount:\"100\"},response:{success:!0,transfer:{id:\"transfer-123\",tokenId:\"token-ref-1\",amount:\"100 REF\",toAddress:\"0xabcd...\",commission:\"0.5 REF (0.5% para el administrador)\",status:\"completed\",txHash:\"0x...\"},note:\"0.5% de comisión de trading aplicada y cobrada por el administrador\"}}},admin_examples:{title:\"Ejemplos del panel de administración\",view_revenue:{description:\"El administrador visualiza los ingresos totales (swaps + margen de gas)\",endpoint:\"GET /api/admin/revenue\",respuesta:{éxito:!0,cryptoRevenue:{totalSwapCommissions:\"1245.67 USD\",totalGasMarkupRevenue:\"3456.78 USD\",totalVolume:\"249000 USD\",revenueByBlockchain:{ethereum:\"2345.67\",polygon:\"1234.56\",bitcoin:\"3456.78\"}}}},view_rwa_revenue:{description:\"El administrador visualiza los ingresos de RWA (comisiones de configuración + anuales + de trading)\",endpoint:\"GET /api/admin/rwa-revenue\",respuesta:{éxito:!0,rwaRevenue:{setupFees:{count:12,total:\"6000 USD\", Tarifas anuales: {Clientes activos: 12, Total: 2400 USD\", Comisiones por operaciones: {Este mes: 12500 USD\", Este año: 125000 USD\", Tasa: 0,5 % del volumen total de operaciones\", Ingresos mensuales totales: 15000 USD\", Seguridad: {Autenticación: encabezado x-api-key (recomendado Tatum v3)\", Cifrado: Todas las claves privadas cifradas con AES-256\", Auditoría: Todas las transacciones registradas con registro de auditoría completo\", Límite de tasa: Starter 10/s, Scale 100/s, Enterprise 1000/seg\",documentación:\"https://docs.tatum.io/docs/authentication\"}})}),t.get(\"/api/test-tatum\",async(s,a)=>{try{let e=await B.healthCheck(),o={success:e.success,message:e.success?\"\\u2705 Conectado a la API de Tatum correctamente\":\"\\u274C Error al conectarse a la API de Tatum\",tatumApiUrl:process.env.TATUM_API_URL||\"https://api.tatum.io\",apiKeyConfigured:!!process.env.TATUM_API_KEY,apiKeyLength:process.env.TATUM_API_KEY?.length||0,timestamp:new Date().toISOString()};e.success&&e.data&&(o.blockchainInfo={chain:e.data.chain,blocks:e.data.blocks,mempool:e.data.mempool}),e.error&&(o.error=e.error,o.statusCode=e.statusCode),a.json({success:e.success,test:\"Prueba de conexión a la API de Tatum\",status:o,instructions:{production:\"Configure la variable de entorno TATUM_API_KEY con su API de producción de Tatum key\",documentation:\"https://docs.tatum.io/docs/authentication\",getApiKey:\"https://dashboard.tatum.io\"},requestId:s.requestId})}catch(e){a.status(500).json({success:!1,test:\"Prueba de conexión de la API de Tatum\",error:e.message,message:\"Error al probar la conexión de Tatum\",instructions:{checkApiKey:\"Asegúrese de que TATUM_API_KEY esté configurado en las variables de entorno\",checkUrl:\"Verifique que TATUM_API_URL esté correct\",documentation:\"https://docs.tatum.io/docs/authentication\"},requestId:s.requestId})}}),t.get(\"/api/docs\",(s,a)=>{a.json({title:\"Tatum API Gateway - Documentación completa\",message:\"Para obtener más información, visite estos puntos finales de la documentación:\",available_docs:{business_model:\"GET /api/docs/model - Explicación completa de los flujos de ingresos\",examples:\"GET /api/docs/examples - Ejemplos de uso para Crypto y RWA\",tatum_test:\"GET /api/test-tatum - Conexión de prueba a la API de Tatum (verificación de producción)\",this_endpoint:\"GET /api/docs - Esta página\",api_root:\"GET / - Información de la API y descripción general del modelo de negocio\"},quick_endpoints:{\"Crypto Panel\":[\"POST /api/v1/gateway/virtual-accounts - Crear cuenta virtual\",\"POST /api/v1/gateway/swap - Swap interno (comisión del 0,5%)\",\"POST /api/v1/gateway/withdraw - Retiro externo (margen de beneficio del 40%)\",\"GET /api/v1/transactions - Historial de transacciones\"],\"Panel RWA\":[\"POST /api/v1/rwa/tokens - Crear token (comisión de instalación de 500$)\",\"GET /api/v1/rwa/tokens - Listar tokens\",\"POST /api/v1/rwa/tokens/:id/transfer - Intercambio de tokens (comisión del 0,5%)\"],Admin:[\"GET /api/admin/revenue - Panel de ingresos de criptomonedas\",\"GET /api/admin/rwa-revenue - Panel de ingresos de RWA\",\"GET /api/admin/master-wallets - Lista de billeteras maestras\",\"POST /api/admin/master-wallets - Crear billetera maestra\"]},authentication:{method:\"x-api-key header\",example:\"Authorization: x-api-key YOUR_API_KEY\",documentation:\"https://docs.tatum.io/docs/authentication\"},support:{github:\"https://github.com/MasterFital/tatum-api-gateway\",tatum_docs:\"https://api.tatum.io/docs\",api_reference:\"https://docs.tatum.io/reference/welcome-to-the-tatum-api-reference\"}})}),t.get(\"/api/health\",async(s,a)=>{let e=await B.healthCheck();a.json({éxito:!0,estado:\"saludable\",servicios:{api:\"saludable\",base de datos:\"saludable\",tatum:e.success?\"saludable\":\"degradado\"},marca de tiempo:nueva Fecha().toISOString()})}), t.get(\"/api/pricing\",(s,a)=>{a.json({éxito:!0,precios:le,niveles:Object.entries(H).map(([e,o])=>({id:e,...o,precios:{starter:{mensual:0,incluido:1e4},escala:{mensual:99,incluido:1e5},empresa:{mensual:\"personalizado\",incluido:\"ilimitado\"}}[e]}))})}), t.get(\"/api/cadenas\",(s,a)=>{a.json({éxito:!0,cadenas:me,total:me.length})}), t.post(\"/api/inquilinos\",async(s,a)=>{try{let e=Yt.parse(s.body);if(await p.getTenantByEmail(e.email))return a.status(409).json({éxito:!1,error:\"Correo electrónico ya registrado\"});let{key:c,prefix:d,hash:y}=Ie(),m=H[e.tier],I=await p.createTenant({nombre:e.nombre,correo electrónico:e.correo electrónico,nivel:e.nivel,estado:\"activo\",apiKeyPrefix:d,apiKeyHash:y,hmacSecret:we(),allowedChains:[...m.cadenas],maxAddresses:m.maxAddresses,maxWebhooks:m.maxWebhooks,maxVirtualAccounts:m.maxVirtualAccounts,rateLimit:m.rateLimit,monthlyQuota:m.monthlyQuota,companyName:e.companyName,website:e.website,billingEmail:e.billingEmail});await p.createAuditLog({tenantId:I.id,action:\"tenant.created\",resource:\"tenant\",resourceId:I.id,changes:{tier:e.tier}}),a.status(201).json({success:!0,tenant:{id:I.id,name:I.name,email:I.email,tier:I.tier,status:I.status,apiKey:c,hmacSecret:I.hmacSecret,limits:{chains:I.allowedChains,maxAddresses:I.maxAddresses,maxWebhooks:I.maxWebhooks,maxVirtualAccounts:I.maxVirtualAccounts,rateLimit:I.rateLimit,monthlyQuota:I.monthlyQuota},createdAt:I.createdAt},warning:\"Guarde su clave API ahora. No se puede recuperar de nuevo.\"})}catch(e){if(e.name===\"ZodError\")return a.status(400).json({éxito:!1,error:\"Error de validación\",details:e.errors});console.error(\"Error al crear inquilino:\",e),a.status(500).json({éxito:!1,error:\"Error interno del servidor\"})}}),t.get(\"/api/tenants\",async(s,a)=>{try{let e=await p.getAllTenants(),o=await Promise.all(e.map(async c=>{let d=await be(c.id),y=await p.countAddressesByTenant(c.id); return{id:c.id,name:c.name,email:c.email,tier:c.tier,status:c.status,companyName:c.companyName,addressCount:y,usage:{requests:d.totalRequests,units:Math.floor(d.totalUnits),costUsd:d.costUsd.toFixed(4)},createdAt:c.createdAt}}));a.json({success:!0,tenants:o})}catch(e){console.error(\"Error al obtener inquilinos:\",e),a.status(500).json({success:!1,error:\"Error interno del servidor\"})}}),t.get(\"/api/tenants/:id\",b,async(s,a)=>{try{let e=espera p.getTenant(s.params.id);si(!e)devuelve a.status(404).json({éxito:!1,error:\"No se encontró el inquilino\"}); sea o=await be(e.id),c=await Se(e.id,e.monthlyQuota),d=await p.countAddressesByTenant(e.id),y=await p.countWebhooksByTenant(e.id),m=await p.countVirtualAccountsByTenant(e.id);a.json({éxito:!0, inquilino:{id:e.id, nombre:e.name, correo electrónico:e.email, nivel:e.tier, estado:e.status, nombreDeEmpresa:e.nombreDeEmpresa, sitio web:e.website, correo electrónicoDeFacturación:e.correoElectrónicoDeFacturación, prefijoDeClaveAPI:e.prefijoDeClaveAPI, límites:{cadenas:e.cadenaspermitidas, direccionesmáximas:e.direccionesmáximas, webhooksmáx:e.webhooksmáx, cuentasvirtualesmáx:e.accesoVirtual recuentos, rateLimit:e.rateLimit, monthlyQuota:e.monthlyQuota}, uso:{direcciones:d, webhooks:y, cuentas virtuales:m, solicitudes:o.totalRequests, unidades:Math.floor(o.totalUnits), costoUsd:o.costUsd.toFixed(4), cuota:{usado:c.usado, restante:c.restante, porcentajeUsado:Math.round(c.porcentajeUsado)}}, creadoEn:e.creadoEn, actualizadoEn:e.actualizadoEn}})}catch(e){console.error(\"Obtener Error de inquilino:\",e),a.status(500).json({éxito:!1,error:\"Error interno del servidor\"})}}),t.patch(\"/api/tenants/:id\",b,async(s,a)=>{try{if(s.tenant.id!==s.params.id)return a.status(403).json({éxito:!1,error:\"Solo puede actualizar su propia cuenta\",requestId:s.requestId});let e=s.body,o=[\"nombre\",\"nombreDeEmpresa\",\"sitio web\",\"correo electrónico de facturación\"],c={};for(let y of o)e[y]!==void 0&&(c[y]=e[y]);if(Object.keys(c).length===0)return a.status(400).json({éxito:!1,error:\"No hay campos válidos para actualizar\",requestId:s.requestId});let d=await p.updateTenant(s.params.id,c);if(!d)return a.status(404).json({éxito:!1,error:\"No se encontró el inquilino\"});await p.createAuditLog({tenantId:d.id,acción:\"inquilino.actualizado\",resource:\"inquilino\",resourceId:d.id,cambios:c,ipAddress:s.ip}),a.json({éxito:!0,inquilino:d,requestId:s.requestId})}catch(e){console.error(\"Actualizar inquilino error:\",e),a.status(500).json({éxito:!1,error:\"Error interno del servidor\"})}}),t.post(\"/api/tenants/:id/rotate-key\",b,async(s,a)=>{try{let e=await p.getTenant(s.params.id);if(!e)return a.status(404).json({éxito:!1,error:\"No se encontró el inquilino\"});if(s.tenant.id!==e.id)return a.status(403).json({éxito:!1,error:\"Solo puede rotar su propia clave API\",requestId:s.requestId});let{key:o,prefix:c,hash:d}=Ie();await p.updateTenant(e.id,{apiKeyPrefix:c,apiKeyHash:d}),await p.createAuditLog({tenantId:e.id,action:\"apikey.rotated\",resource:\"tenant\",resourceId:e.id,changes:{rotated:!0}}),a.json({success:!0,apiKey:o,warning:\"Guarde su nueva clave API. La clave anterior ya no es válida y no se puede recuperar.\",requestId:s.requestId})}catch(e){console.error(\"Error al rotar la clave API:\",e),a.status(500).json({success:!1,error:\"Servidor interno error\"})}}),t.patch(\"/api/admin/tenants/:id\",$,async(s,a)=>{try{let e=s.body;if(e.tier){let c=H[e.tier];c&&(e.allowedChains=c.chains,e.maxAddresses=c.maxAddresses,e.maxWebhooks=c.maxWebhooks,e.maxVirtualAccounts=c.maxVirtualAccounts,e.rateLimit=c.rateLimit,e.monthlyQuota=c.monthlyQuota)}let o=await p.updateTenant(s.params.id,e);if(!o)return a.status(404).json({éxito:!1,error:\"No se encontró el inquilino\"});await p.createAuditLog({Id.inquilino:o.id,acción:\"admin.tenant.updated\",recurso:\"inquilino\",Id.recurso:o.id,cambios:e,direcciónIP:s.ip}),a.json({éxito:!0,inquilino:o,Id.solicitud:s.Id.solicitud})}catch(e){console.error(\"El administrador actualiza el inquilino error:\",e),a.status(500).json({éxito:!1,error:\"Error interno del servidor\"})}}),t.post(\"/api/admin/tenants/:id/suspend\",$,async(s,a)=>{try{let e=await p.updateTenant(s.params.id,{status:\"suspendido\"});if(!e)return a.status(404).json({éxito:!1,error:\"Inquilino no encontrado\"});await p.createAuditLog({tenantId:e.id,action:\"admin.tenant.suspended\",resource:\"tenant\",resourceId:e.id,changes:{status:\"suspended\"},ipAddress:s.ip}),a.json({success:!0,message:\"Inquilino suspendido\",requestId:s.requestId})}catch(e){console.error(\"Error de suspensión del inqui
{"mensaje":"","atributos":{"nivel":"información"},"marca de tiempo":"2025-11-30T18:34:48.948559473Z"}
{"mensaje":"> rest-express@1.0.0 inicio","atributos":{"nivel":"información"},"marca de tiempo":"2025-11-30T18:34:48.948568302Z"}
{"mensaje":"> NODE_ENV=nodo de producción dist/index.js","atributos":{"nivel":"información"},"marca de tiempo":"2025-11-30T18:34:48.948574731Z"}
{"mensaje":"","atributos":{"nivel":"información"},"marca de tiempo":"2025-11-30T18:34:48.948580067Z"}
{"mensaje":"archivo:///app/dist/index.js:1","atributos":{"nivel":"error"},"marca de tiempo":"2025-11-30T18:34:49.642688199Z"}
{"mensaje":"var mt=Object.defineProperty;var fe=(n,t)=>()=>(n&&(t=n(n=0)),t);var xe=(n,t)=>{para(var r en t)mt(n,r,{obtener:t[r],enumerable:!0})};var J={};xe(J,{EnumeraciónDeCadena:()=>ft,PRECIOS:()=>le,CADENAS_SOPORTADAS:()=>me,EnumeraciónDeEstado:()=>yt,LÍMITES_DE_NIVEL:()=>H,EnumeraciónDeNivel:()=>gt,EVENTOS_DE_WEBHOOK:()=>Be,direcciones:()=>S,UsoDeAPI:()=>W,RegistrosDeAuditoría:()=>te,AgregacionesDeFacturación:()=>Q,CriptoTransacciones:()=>de,ConfiguraciónDeGas:()=>X,InsertarEsquemaDeDirección:()=>vt,InsertarEsquemaDeUsoDeAPI:()=>_t,InsertarLoCursoDeAuditoría gSchema:()=>xt,insertarEsquemaDeTransacciónCriptográfica:()=>At,insertarEsquemaDeMonederoMaestro:()=>It,insertarEsquemaDeInquilino:()=>bt,insertarEsquemaDeTransacción:()=>kt,insertarEsquemaDeCuentaVirtual:()=>wt,insertarEsquemaDeWebhook:()=>Tt,MonederosMaestros:()=>z,inquilinos:()=>x,RelacionesDeInquilinos:()=>ht,transacciones:()=>j,CuentasVirtuales:()=>_,webhooks:()=>K});import{sql como M}de\"drizzle-orm\";import{pgTable como q,texto como l,varchar como T,entero como E,booleano como Ve,marca de tiempo como R,jsonb como F,real como he,índice como v}de\"drizzle-orm/pg-core\";import{createInsertSchema como Y}de\"drizzle-zod\";import{z como Ke}de\"zod\";import{relaciones como pt}de\"drizzle-orm\";var gt,yt,ft,x,z,_,de,X,S,j,K,W,Q,te,ht,It,wt,At,bt,vt,kt,Tt,_t,xt,H,le,Be,me,D=fe(()=>{\"use estricto\";gt=Ke.enum([\"inicial\",\"escala\",\"empresa\"]),yt=Ke.enum([\"activo\",\"suspendido\",\"eliminado\"]),ft=Ke.enum([\"bitcoin\",\"ethereum\",\"solana\",\"polígono\",\"tron\",\"bsc\",\"ondulación\",\"cardano\",\"cerca\",\"polkadot\",\"avalancha\",\"arbitrum\",\"optimismo\",\"base\",\"fantom\",\"cronos\",\"cosmos\",\"algorand\"]),x=q(\"inquilinos\",{id:T(\"id\",{length:36}).primaryKey().default(M`gen_rand om_uuid()`), nombre: l(\"nombre\").notNull(), correo electrónico: l(\"correo electrónico\").notNull().único(), nivel: l(\"nivel\").notNull().predeterminado(\"inicial\"), estado: l(\"estado\").notNull().predeterminado(\"activo\"), apiKeyPrefix: T(\"api_key_prefix\",{longitud: 16}).notNull(), apiKeyHash: l(\"api_key_hash\").notNull().único(), hmacSecret: l(\"hmac_secret\").notNull(), allowedChains: l(\"allowed_chains\").array().notNull().predeterminado(M`ARRAY['bitcoin', 'ethereum', 'solana']`), direcciones máximas: E(\"direcciones máximas\").notNull().default(50), webhooks máximos: E(\"webhooks máximos\").notNull().default(1), cuentas virtuales máximas: E(\"cuentas virtuales máximas\").notNull().default(0), límite de tasa: E(\"límite de tasa\").notNull().default(10), cuota mensual: E(\"cuota mensual\").notNull().default(1e4), correo electrónico de facturación: l(\"correo electrónico de facturación\"), nombre de la empresa:l(\"nombre_de_la_empresa\"),sitio_web:l(\"sitio_web\"),lista_blanca_de_ip:l(\"lista_blanca_de_ip\").array(),metadatos:F(\"metadatos\"),createdAt:R(\"created_at\").defaultNow().notNull(),updatedAt:R(\"updated_at\").defaultNow().notNull()},n=>[v(\"id_de_correo_electrónico_de_inquilinos\").on(n.email),v(\"id_hash_de_clave_de_API_de_inquilinos\").on(n.apiKeyHa sh),v(\"idx_estado_inquilinos\").on(n.estado)]),z=q(\"monederos_principales\",{id:T(\"id\",{longitud:36}).clave_primaria().predeterminado(M`gen_random_uuid()`),escenario:l(\"escenario\").notNull(),cadena_de_bloques:l(\"cadena_de_bloques\").notNull(),tipo_de_activo:l(\"tipo_de_activo\").notNull(),nombre_de_activo:l(\"nombre_de_activo\").notNull(),dirección:l( \"dirección\").notNull().unique(),clavepública:l(\"clave pública\"),claveprivadacifrada:l(\"clave privada cifrada\"),claveprivadaIV:T(\"clave privadaIV\",{longitud:32}),etiquetadeautenticacióndeclaveprivada:T(\"etiquetadeautenticacióndeclaveprivada\",{longitud:32}),direccióndecontratointeligente:l(\"direccióndecontratointeligente\"),decimalesdetoken:E(\"decimalesdetoken \"),assignedToTenantId:T(\"id_asignado_al_inquilino\",{length:36}).references(()=>x.id),balance:l(\"saldo\").default(\"0\"),balanceUsd:l(\"saldo_usd\").default(\"0\"),lastSyncTime:R(\"última_sincronización\"),gasMarkupPercentage:E(\"porcentaje_de_margen_de_gas\").default(40),status:l(\"estado\").notNull().de fallo(\"activo\"), metadatos: F(\"metadatos\"), creado en: R(\"creado_en\"). predeterminadoAhora(). no nulo(), actualizado en: R(\"actualizado_en\"). predeterminadoAhora(). no nulo()}, n => [v(\"masters_blockchain_idx\"). en(n. cadena de bloques), v(\"masters_asset_idx\"). en(n. nombre_activo), v(\"masters_address_idx\"). en(n. dirección), v(\"masters_inquilino _idx\").on(n.assignedToTenantId),v(\"masters_scenario_idx\").on(n.scenario)]),_=q(\"cuentas_virtuales\",{id:T(\"id\",{longitud:36}).primaryKey().default(M`gen_random_uuid()`),tenantId:T(\"tenant_id\",{longitud:36}).notNull().references(()=>x.id,{onDelete:\"cascade\"}),accountType:l(\"tipo_de_cuenta\").n otNull(),saldos:F(\"saldos\").predeterminado(M`'{}'`),estado:l(\"estado\").notNull().predeterminado(\"activo\"),congelado:Ve(\"congelado\").predeterminado(!1),metadatos:F(\"metadatos\"),createdAt:R(\"creado_en\").defaultNow().notNull(),updatedAt:R(\"actualizado_en\").defaultNow().notNull()},n=>[v(\"inquilino_de_cuentas_virtuales_i dx\").on(n.Id_de_inquilino),v(\"id_de_estado_de_cuentas_virtualesx\").on(n.estado)]),de=q(\"transacciones_criptográficas\",{id:T(\"id\",{longitud:36}).clave_primaria().predeterminado(M`gen_random_uuid()`),Id_de_inquilino:T(\"id_de_inquilino\",{longitud:36}).notNull().referencias(()=>x.id,{onDelete:\"cascada\"}),tipo:l(\"tipo\").notNull(),escenario:l(\"escenario\").notNull(),fromAccountId:T(\"from_account_id\",{longitud:36}),toAccountId:T(\"to_count_id\",{longitud:36}),toExternalAddress:l(\"to_external_address\"),fromExternalAddress:l(\"from_external_address\"),assetType:l(\"tipo_de_activo\").notNull(),assetName:l(\"nombre_de_activo\").notNull(),blockchain:l(\"blockchain\").notNull(),amount:l(\"mount\"). notNull(),gasReal:l(\"gas_real\"),gasMarkupPercent:E(\"gas_markup_percent\"),gasCharged:l(\"gas_charged\"),commissionAmount:l(\"commission_mont\"),commissionUsd:l(\"comission_usd\"),status:l(\"status\").notNull().default(\"pending\"),txHash:l(\"tx_hash\").unique(),blockNumber:E(\"block_number\"),confirmations:E(\"confirmations\"),metadata:F(\"me tadata\"), creado en: R(\"creado_en\"). predeterminadoAhora(). no nulo(), ejecutado en: R(\"ejecutado_en\"), confirmado en: R(\"confirmado_en\")}, n => [v(\"idx_de_inquilino_de_transacción_criptográfica\"). en(n. id_de_inquilino), v(\"idx_de_tipo_de_transacción_criptográfica\"). en(n. tipo), v(\"idx_de_estado_de_transacción_criptográfica\"). en(n. estado), v(\"idx_hash_de_transacción_criptográfica\"). en(n. hash_de_transacción), v(\"idx_de_escenario_de_transacción_criptográfica\"). en(n. escenario)]), X = q(\"setti_gas ngs\",{id:T(\"id\",{longitud:36}).primaryKey().default(M`gen_random_uuid()`),marcadopredeterminadoglobal:E(\"marcadopredeterminadoglobal\").default(40),marcadomín:E(\"marcadomín\").default(10),marcadomáx:E(\"marcadomáx\").default(100),anulacionesdecliente:F(\"anulacionesdecliente\").default(M`'{}'`),multiplicadoresdecadenadebloques:F(\"multiplicadoresdecadenadebloques\").default(M`'{\"ethereum\": 1.0, \"polígono\": 0.3}'`),Anulaciones de tipo de transacción:F(\"anulaciones de tipo de transacción\").predeterminado(M`'{\"retiro_cripto\": 40, \"transferencia_de_token\": 45}'`),updatedAt:R(\"updated_at\").defaultNow().notNull(),updatedBy:l(\"updated_by\")},n=>[v(\"gas_settings_updated_idx\").on(n.updatedAt)]),S=q(\"direcciones\",{id:T(\"id\",{longitud:36}).primaryKey().default(M`gen_random_uuid()`),tenantId:T(\"tenant_id\",{longitud:36}).notNull().references(()=>x.id,{onDelete:\"cascade\"}),chain:l(\"cadena\").notNull(),currency:l(\"currency\").notNull(),address: l(\"dirección\").notNull(),publicKey:l(\"clave_pública\"),derivationPath:l(\"ruta_derivación\"),label:l(\"etiqueta\"),tags:l(\"etiquetas\").array().default(M`ARRAY[]::text[]`),status:l(\"estado\").notNull().default(\"activo\"),balance:l(\"balance\").default(\"0\"),balanceUsd:l(\"balance_usd\").default(\"0\"),lastSynced:R(\"last_synced\"),webhookUrl:l(\"webhook_url\"),metadatos:F(\"metadatos\"),createdAt:R(\"creado_en\").defaultNow().notNull(),actualizadoEn:R(\"actualizado_en\").defaultNow().notNull(),eliminadoEn:R(\"eliminado_en\")},n=>[v(\"direcciones_idx_de_inquilino\").on(n.Id_de_inquilino),v(\"direcciones_idx_de_cadena\").on(n.cadena),v(\"direcciones_idx_de_estado\").on(n.estado),v(\"direcciones_idx_de_dirección\").on(n.dirección)] ),j=q(\"transacciones\",{id:T(\"id\",{longitud:36}).primaryKey().default(M`gen_random_uuid()`),tenantId:T(\"id_tenant\",{longitud:36}).notNull().references(()=>x.id,{onDelete:\"cascade\"}),txHash:l(\"tx_hash\").notNull(),chain:l(\"cadena\").notNull(),fromAddress:l(\"from_address\"),toAddress:l(\"t o_dirección\"), importe: l(\"importe\").notNull(), moneda: l(\"moneda\").notNull(), cuota: l(\"cuota\"), cuotaUsd: l(\"cuota_usd\"), estado: l(\"estado\").notNull().default(\"pendiente\"), tipo: l(\"tipo\").notNull().default(\"nativo\"), númerodebloque: E(\"númerodebloque\"), confirmaciones: E(\"confirmaciones\").default(0 ), metadatos: F(\"metadatos\"), creado en: R(\"creado_en\"). predeterminado ahora(). no nulo()}, n => [v(\"idx_de_inquilino_de_transacciones\"). en(n. ID_de_inquilino), v(\"idx_de_cadena_de_transacciones\"). en(n. cadena), v(\"idx_de_hash_de_transacciones\"). en(n. Hash_de_tx), v(\"idx_de_estado_de_transacciones\"). en(n. estado)]), K = q(\"webhooks\", {id: T(\"id\", {le longitud: 36}). claveprimaria(). predeterminado(M`gen_random_uuid()`), ID_inquilino: T(\"ID_inquilino\",{longitud: 36}). no nulo(). referencias(()=>x.id,{onDelete:\"cascada\"}), URL: l(\"URL\"). no nulo(), eventos: l(\"eventos\"). matriz(). no nulo(), secreto_hmac: l(\"secreto_hmac\"). no nulo(), activo: Ve(\"activo\"). predeterminado(!0), reintentarCou nt:E(\"retry_count\").default(0),lastTriggered:R(\"last_triggered\"),lastStatus:E(\"last_status\"),metadatos:F(\"metadatos\"),createdAt:R(\"created_at\").defaultNow().notNull()},n=>[v(\"webhooks_tenant_idx\").on(n.tenantId),v(\"webhooks_active_idx\").on(n.active)]),W=q(\"api_usage\",{id:T(\"id \",{longitud:36}).primaryKey().default(M`gen_random_uuid()`),tenantId:T(\"tenant_id\",{longitud:36}).notNull().references(()=>x.id,{onDelete:\"cascade\"}),endpoint:l(\"endpoint\").notNull(),method:l(\"method\").notNull(),chain:l(\"chain\"),action:l(\"action\").notNull(),units:he(\"units\").notN ull(), créditos:he(\"créditos\").notNull(), código de estado:E(\"código de estado\").notNull(), id de solicitud:T(\"id de solicitud\",{longitud:36}).notNull(), tiempo de respuesta Ms:E(\"ms de tiempo de respuesta\"), metadatos:F(\"metadatos\"), marca de tiempo:R(\"marca de tiempo\").defaultNow().notNull()}, n=>[v(\"id de inquilino de uso de API\").on(n.id de inquilino),v(\"api_usage_timestamp_idx\").on(n.timestamp),v(\"api_usage_action_idx\").on(n.action)]),Q=q(\"agregaciones_de_facturación\",{id:T(\"id\",{longitud:36}).primaryKey().default(M`gen_random_uuid()`),tenantId:T(\"id_de_teniente\",{longitud:36}).notNull().references(()=>x.id,{onDelete:\"cascade\"}),periodo:l(\"periodo\").notNull(),periodType:l(\"tipo_de_periodo\").notNull().default(\"diario\"),totalUnits:he(\"unidades_totales\").notNull().def ault(0), totalCredits:he(\"total_créditos\").notNull().default(0), costUsd:he(\"costo_usd\").notNull().default(0), breakdown:F(\"break\"), createdAt:R(\"created_at\").defaultNow().notNull()}, n=>[v(\"billing_tenant_period_idx\").on(n.tenantId,n.period)]), te=q(\"audit_logs\",{id:T(\"id\",{length:36}).primaryKey().default(M`gen_random_uuid()`), tenantId:T(\"tenant_id\",{length:36}).references(()=>x.id,{onDelete:\"set null\"}),ID_usuario:l(\"id_usuario\"),acción:l(\"acción\").notNull(),recurso:l(\"recurso\").notNull(),ID_recurso:l(\"id_recurso\"),cambios:F(\"cambios\"),Dirección_IP:l(\"dirección_IP\"),Agente_usuario:l(\"agente_usuario\"),ID_solicitud:T(\"id_solicitud\",{longitud:36}),marca_de_tiempo:R(\"marca_de_tiempo\").defaultNow().notNull()},n=>[v(\"audit_logs_tenant_idx\").on(n.Id_tenant),v(\"audit_logs_timestamp_idx\").on(n.marca_de_tiempo),v(\"audit _logs_action_idx\").on(n.action)]),ht=pt(x,({muchos:n})=>({direcciones:n(S),transacciones:n(j),webhooks:n(K),cuentasvirtuales:n(_),apiUsage:n(W),agregacionesdefacturación:n(Q),registrosdeauditoría:n(te),monederosprincipales:n(z),criptotransacciones:n(de)})),It=Y(z).omit({id:!0,createdAt:!0,updatedAt:!0}),wt=Y(_).omit({id:!0,createdAt:!0,updatedAt:!0}),At=Y(de).omit({id:!0,createdAt:!0,executedAt:!0,confirmedAt:!0}),bt=Y(x).omit({ id:!0,createdAt:!0,updatedAt:!0}),vt=Y(S).omit({id:!0,createdAt:!0,updatedAt:!0,deletedAt:!0}),kt=Y(j).omit({id:!0,createdAt:!0}),Tt=Y(K).omit({id:!0,createdAt:!0}),_t=Y(W).omit({id:!0,timestamp:!0}),xt=Y(te).omit({id:!0,timestamp:!0}),H={starter:{chains:[\"bitcoin\",\"ethereum\",\"solana\"],maxAddresses:50,maxWebhooks:1,maxVirtualAccounts:0,rateLimit:10,monthlyQuota:1e4,kmsAllowed:!1,archivalAccess :!1, días de retención: 1}, escala: {cadenas: [\"bitcoin\",\"ethereum\",\"solana\",\"polígono\",\"tron\",\"bsc\",\"ripple\",\"cardano\"], direcciones máximas: 1e3, webhooks máximos: 10, cuentas virtuales máximas: 5, límite de tasa: 100, cuota mensual: 1e5, km permitidos:!0, acceso de archivo:!1, días de retención: 7}, empresa: {cadenas: [\"bitcoin\",\"ethereum\",\"solana\",\"polígono\",\"tron\",\"bsc\",\"ripple\",\"cardano\",\"near\",\"polkadot\",\"avalancha\",\"arbitro\",\"optimismo\",\"base\",\"fantasma\",\"cronos\",\"cosmos\",\"algorand\"],máximo de direcciones: -1,máximo de webhooks: -1,máximo de cuentas virtuales: 50,límite de tasa: 1e3,cuota mensual: -1,km permitidos: !0,acceso de archivo: !0,días de retención: 30}},le={creación de dirección:{unidades: 1,costo: 0,001},consulta de saldo:{unidades: 0,costo: 5e-4},saldo de token:{unidades: 1,costo: 0,001},metadatos nft:{unidades: 2,costo: 0,002},tx_br oadcast_btc:{unidades: 50, costo: 0,05}, tx_broadcast_eth:{unidades: 10, costo: 0,01}, tx_broadcast_other:{unidades: 10, costo: 0,01}, tx_history:{unidades: 2, costo: 0,002}, webhook_subscription:{unidades: 0,02, costo: 0,02}, va_create:{unidades: 100, costo: 0,1}, va_transfer:{unidades: 5, costo: 0,005}, tipo de cambio:{unidades: 0,1, costo: 1e-4}, web3_resolve:{unidades: 1, costo: 0,001}, malicioso_check:{unidades: 2, costo: 0,002}, rpc_standard:{u nits:2,costo:2e-4},rpc_eth_call:{unidades:5,costo:5e-4},rpc_debug:{unidades:50,costo:.005}},Be=[\"TRANSACCIÓN_DIRECCIÓN\",\"SALDO_DIRECCIÓN\",\"TRANSACCIÓN_NATIVA_ENTRANTE\",\"TRANSACCIÓN_NATIVA_SALIENTE\",\"TRANSACCIÓN_FUNGIBLE_ENTRANTE\",\"TRANSACCIÓN_FUNGIBLE_SALIENTE\",\"TRANSACCIÓN_NFT_ENTRANTE\",\"TRANSACCIÓN_NFT_SALIENTE\",\"TRANSACCIÓN_MULTITOKEN_ENTRANTE\",\"TRANSACCIÓN_MULTITOKEN_SALIENTE\",\"TRANSACCIÓN_FALLIDA\",\"CUOTA_PAGADA\",\"REGISTRO_DE_CONTRATO _EVENTO\"],me=[{id:\"bitcoin\",nombre:\"Bitcoin\",símbolo:\"BTC\",icono:\"\\u20BF\"},{id:\"ethereum\",nombre:\"Ethereum\",símbolo:\"ETH\",icono:\"\\u039E\"},{id:\"solana\",nombre:\"Solana\",símbolo:\"SOL\",icono:\"\\u25CE\"},{id:\"polígono\",nombre:\"Polígono\",símbolo:\"MATIC\",icono:\"\\u2B21\"},{id:\"tron\",nombre:\"Tron\",símbolo:\"TRX\",icono:\"\\u2666\"},{id:\"bsc\",nombre:\"BNB Cadena\", símbolo:\"BNB\", icono:\"\\u25C6\"},{id:\"ripple\", nombre:\"XRP Ledger\", símbolo:\"XRP\", icono:\"\\u2715\"},{id:\"cardano\", nombre:\"Cardano\", símbolo:\"ADA\", icono:\"\\u20B3\"},{id:\"near\", nombre:\"NEAR\", símbolo:\"NEAR\", icono:\"\\u24C3\"},{id:\"polkadot\", nombre:\"Polkadot\", símbolo:\"DOT\", icono:\"\\u25CF\"},{id:\"avalanche\", nombre:\"Avalanche\", símbolo:\"AVAX\", icono:\"\\u25B2\"},{id:\"arb itrum\", nombre:\"Arbitrum\", símbolo:\"ARB\", icono:\"\\u25C8\"},{id:\"optimism\", nombre:\"Optimism\", símbolo:\"OP\", icono:\"\\u2295\"},{id:\"base\", nombre:\"Base\", símbolo:\"ETH\", icono:\"\\u25EF\"},{id:\"fantom\", nombre:\"Fantom\", símbolo:\"FTM\", icono:\"\\u25C7\"},{id:\"cronos\", nombre:\"Cronos\", símbolo:\"CRO\", icono:\"\\u25CE\"},{id:\"cosmos\",nombre:\"Cosmos\",símbolo:\"ATOM\",icono:\"\\u269B\"},{id:\"algorand\",nombre:\"Algorand\",símbolo:\"ALGO\",icono:\"\\u24B6\"}]});var oe={};xe(oe,{db:()=>f,pool:()=>Ye});import{Pool como St,neonConfig como Pt}desde\"@neondatabase/serverless\";import{drizzle como Rt}desde\"drizzle-orm/neon-serverless\";import Et desde\"ws\";var Ye,f,V=fe(()=>{\"use strict\";D();Pt.webSocketConstructor=Et;if(!process.env.DATABASE_URL)throw new Error(\"DATABASE_URL debe ser ¿Olvidaste aprovisionar una base de datos?\"); Ye=new St({connectionString:process.env.DATABASE_URL}), f=Rt({client:Ye,schema:J})}); function jt(n){return!n||typeof n!=\"string\"||n.length<32?!1:/^[a-zA-Z0-9_-]{32,}$/.test(n)} function Bt(){return P.state===\"open\"?Date.now()-P.lastFailure>=$e.resetTimeoutMs?(P.state=\"half-open\",P.successesInHalfOpen=0,!0):!1:!0} function Dt(){P.estado===\"semiabierto\"?(P.éxitosEnMedioApertura++,P.éxitosEnMedioApertura>=$e.umbralDeÉxitoDeAperturaMedia&&(P.estado=\"cerrado\",P.fallos=0)):P.fallos=0}función ze(){P.fallos++,P.últimoFallo=Fecha.ahora(),(P.estado===\"semiabierto\"||P.fallos>=$e.umbralDeFallo)&&(P.estado=\"abierto\")}función Ut(n,t){devolver t.EstadosReintentables.includes(n)}función Xe(n,t){devolver Math.min(t.baseDelayMs*Math.pow(2,n)+Math.random()*1e3,t.maxDelayMs)}función asíncrona Qe(n){devuelve nueva Promesa(t=>setTimeout(t,n))}función asíncrona N(n,t={},r=Kt){si(!Bt())devuelve{éxito:!1,error:\"Servicio temporalmente no disponible (disyuntor abierto)\",statusCode:503};let i=null;for(let u=0;u<=r.maxRetries;u++)try{let g=new AbortController,h=setTimeout(()=>g.abort(),3e4),s=await fetch(`${Mt}${n}`,{...t,señal:g.señal,encabezados:{\"Tipo-Contenido\":\"aplicación/json\",\"clave-x-api\":Fe||\"\",...t.encabezados}});clearTimeout(h);let a=await s.json().catch(()=>null);if(!s.ok){let e={éxito:!1,error:a?.mensaje||a?.error||`HTTP ${s.estado}`,código-estado:s.estado};if(s.estado===429){let o=s.headers.get(\"Retry-After\");o&&(e.retryAfter=parseInt(o,10)*1e3)}if(Ut(s.status,r)&&u<r.maxRetries){i=e;let o=e.retryAfter||Xe(u,r);await Qe(o);continue}return ze(),e}return Dt(),{éxito:!0,datos:a}}catch(g){let h=g.name===\"Error de cancelación\",s=g.message?.includes(\"obtener\")||g.message?.includes(\"red\"),a={éxito:!1,error:h?\"Tiempo de espera de la solicitud\":g.message||\"Red error\",statusCode:h?408:500};if((h||s)&&u<r.maxRetries){i=a,await Qe(Xe(u,r));continue}return ze(),a}return i||{éxito:!1,error:\"Se excedió el máximo de reintentos\",statusCode:500}}function Je(n){return me.find(t=>t.id===n)}var Mt,Fe,Kt,P,$e,se,B,Oe=fe(()=>{\"use strict\";D();Mt=process.env.TATUM_API_URL||\"https://api.tatum.io\",Fe=process.env.TATUM_API_KEY;Fe?jt(Fe)||console.warn(\"El formato de TATUM_API_KEY parece no ser válido; puede causar errores de API\"):console.warn(\"TATUM_API_KEY no configurado; las llamadas a la API fail\"); Kt={máx.Reintentos:3,Ms.deRetardoBase:1e3,Ms.deRetardoMax:3e4,EstadosReintentables:[408,429,500,502,503,504]}, P={fallos:0,últimoFallo:0,estado:\"cerrado\",éxitosEnMedioApertura:0}, $e={UmbralDeFallo:5,Ms.deRestablecimientoTiempoDeEspera:6e4,UmbralDeÉxitoEnMedioApertura:2}; se={bitcoin:\"bitcoin\",ethereum:\"ethereum\",solana:\"solana\",polygon:\"polígono\",tron:\"tron\",bsc:\"bsc\",ri pple:\"xrp\",cardano:\"ada\",near:\"near\",polkadot:\"dot\",avalanche:\"avax\",arbitrum:\"arbitrum-one\",optimismo:\"optimismo\",base:\"base\",fantom:\"fantom\",cronos:\"cro\",c osmos:\"atom\",algorand:\"algo\"},B={getCircuitBreakerState(){return{...P}},resetCircuitBreaker(){P.failures=0,P.lastFailure=0,P.state=\"closed\",P.successesInHalfOpen=0},async generateAddress(n){let t=se[n]||n;return N(`/v3/${t}/wallet`,{método:\"GET\"})},async getBalance(n,t){let r=se[n]||n;return[\"ethereum\",\"polígono\",\"bsc\",\"arbitrum-one\",\"optimism\",\"base\"].includes(r)?N(`/v3/${r}/account/balance/${t}`):N(r===\"bitcoin\"?`/v3/bitcoin/address/balance/${t}`:r===\"solana\"?`/v3/solana/account/balance/${t}`:`/v3/${r}/account/balance/${t}`)},async getTokens(n,t){let r=se[n]||n;devuelve N(`/v3/data/tokens?chain=${r}&addresses=${t}`)},asincrónico obtenerNFTs(n,t){let r=se[n]||n;devuelve N(`/v3/data/nfts?chain=${r}&addresses=${t}`)},asincrónico obtenerHistorialDeTransacciones(n,t,r){let i=se[n]||n,u=nuevosParámetrosDeBúsquedaDeURL;devuelve r?.TamañoDePágina&&u.set(\"TamañoDePágina\",r.TamañoDePágina.toString()),r?.Desplazamiento&&u.set(\"Desplazamiento\",r.Desplazamiento.toString()),N(`/v3/data/transacciones?chain=${i}&addresses=${t}&${u.toString()}`)},asincrónico getTransaction(n,t){let r=se[n]||n;devuelve N(`/v3/${r}/transaction/${t}`)},async estimateFee(n,t=\"TRANSFER\"){let r=se[n]||n;devuelve N(`/v3/${r}/gas/estimate`,{método:\"POST\",cuerpo:JSON.stringify({tipo:t})})},async broadcastTransaction(n,t){let r=se[n]||n;devuelve N(`/v3/${r}/broadcast`,{método:\"POST\",cuerpo:JSON.stringify({txData:t})})},async getExchangeRates(n){let t=n.join(\",\");devuelve N(`/v3/tatum/rate/${t}?basePair=USD`)}, asíncrono resolveWeb3Name(n){devuelve N(`/v3/blockchain/names/${n}`)}, asíncrono checkMaliciousAddress(n){devuelve N(`/v3/security/address/${n}`)}, asíncrono createWebhook(n){devuelve N(\"/v4/subscription\",{método:\"POST\",cuerpo:JSON.stringify(n)})}, asíncrono deleteWebhook(n){devuelve N(`/v4/subscription/${n}`,{método:\"DELETE\"})}, asíncrono getWebhooks(){devuelve N(\"/v4/subscription\")},async healthCheck(){let n=await N(\"/v3/tatum/version\"); return n.success?{success:!0, data:{status:\"healthy\", version:n.data?.version||\"v3\", circuitBreaker:{...P}}}:{...n, data:{status:\"degraded\", version:\"unknown\", circuitBreaker:{...P}}}}}});var ve={};xe(ve,{GasFeeManager:()=>Ee,gasFeeManager:()=>Le});import{eq as Ge}from\"drizzle-orm\";var Ee,Le,ge=fe(()=>{\"use strict\";V();D();Ee=class{config=null;async loadConfig(){let[t]=await f.select().from(X).limit(1);if(!t){let r={Margen predeterminado global: 40, Margen mínimo: 10, Margen máximo: 100, Anulaciones de cliente:{}, Multiplicadores de cadena de bloques:{ethereum: 1, polígono: .3, bitcoin: 1.2, solana: .1, arbitraje: .2}, Anulaciones de tipo de transacción:{retiro_cripto: 40, transferencia_de_token: 45, contrato_inteligente: 60}};return this.config=r,r}return this.config={globalDefaultMarkup:t.globalDefaultMarkup,minMarkup:t.minMarkup,maxMarkup:t.maxMarkup,clientOverrides:t.clientOverrides||{},blockchainMultipliers:t.blockchainMultipliers||{},transactionTypeOverrides:t.transactionTypeOverrides||{}},this.config}async calculateGasMarkup(t){this.config||await this.loadConfig();let r=this.config.globalDefaultMarkup;if(t.clientId&&this.config.clientOverrides[t.clientId]){let a=this.config.clientOverrides[t.clientId];if(a.expiresAt){let e=new Date(a.expiresAt);new Date<e&&(r=a.markup)}else r=a.markup}let i=this.config.transactionTypeOverrides[t.transactionType];i&&(r=i);let u=this.config.blockchainMultipliers[t.blockchain]||1;r=Math.round(r*u),r=Math.max(this.config.minMarkup,Math.min(this.config.maxMarkup,r));let g=t.gasReal*(r/100),h=t.gasReal+g,s=g;return{gasReal:t.gasReal,gasMarkupPercent:r,gasCharged:h,yourProfit:s}}async updateGlobalMarkup(t,r){t=Math.max(10,Math.min(100,t)),await f.update(X).set({globalDefaultMarkup:t,updatedAt:new Fecha,actualizadoPor:r}).donde(Ge(X.id,\"predeterminado\")),this.config=null,await this.loadConfig()}async setClientMarkup(t,r,i,u,g){this.config||await this.loadConfig();let h=this.config.clientOverrides;h[t]={markup:Math.max(10,Math.min(100,r)),reason:i,expiresAt:g?.toISOString()},await f.update(X).set({clientOverrides:h,actualizadoEn:new Fecha,actualizadoPor:u}).donde(Ge(X.id,\"predeterminado\")),this.config=null,await this.loadConfig()}async removeClientMarkup(t,r){this.config||await this.loadConfig();let i=this.config.clientOverrides;eliminar i[t],esperar f.update(X).set({clientOverrides:i,actualizadoEn:nueva Fecha,actualizadoPor:r}).where(Ge(X.id,\"predeterminado\")),this.config=null,esperar this.loadConfig()}getConfig(){devolver this.config}},Le=new Ee});var ke={};xe(ke,{CryptoGateway:()=>Ne,cryptoGateway:()=>Ht});importar Lt desde\"crypto\";importar{eq como G y como Wt} desde\"drizzle-orm\";var Ne,Ht,Te=fe(()=>{\"usar estricto\";Oe();ge();V();D();Ne=class{async createVirtualAccount(t,r){devolver(esperar f.insert(_).values({Id.inquilino:t,TipoDeCuenta:r,Saldos:JSON.stringify({})}).returning())[0]}async internalSwap(t){let r=await f.query.virtualAccounts.findFirst({where:G(_.id,t.fromAccountId)});if(!r)throw new Error(\"No se encontró la cuenta\");let i=JSON.parse(r.balances||\"{}\"),u=parseFloat(i[t.assetName]||\"0\");if(u<parseFloat(t.fromAmount))throw new Error(\"Saldo insuficiente\");let g=parseFloat(t.toAmount)*.005,h=parseFloat(t.toAmount)-g,s={...i};s[t.assetName]=(u-parseFloat(t.fromAmount)).toString(),await f.update(_).set({balances:JSON.stringify(s)}).where(G(_.id,t.fromAccountId));let a=espera f.consulta.cuentasvirtuales.findFirst({donde:G(_.id,t.toAccountId)}),e=JSON.parse(a?.balances||\"{}\");devuelve e[t.nombreDeActivo]=(parseFloat(e[t.nombreDeActivo]||\"0\")+h).toString(),espera f.update(_).set({balances:JSON.stringify(e)}).donde(G(_.id,t.toAccountId)),{txId:(espera f.insert(de).values({Id.inquilino:t.Id.inquilino,tipo:\"intercambio_interno\",escenario:t.scenario,Id.deCuenta:t.deCuenta,Id.deCuenta:t.deCuenta,Tipo.deActivo:\"cripto\",Nombre.deActivo:t.deActivo,cadena.de.blockchain:t.blockchain,importe:t.deImporte,importe.de.comisión:g.de.Cadena(),comisión.Usd:(g*45e3).de.Cadena(),estado:\"completado\"}).returning())[0].id,estado:\"completado\",deImporte:t.deImporte,de.Importe:t.de.Importe,comisión:g.de.Fijo(8),neto.Recibido:h.de.Fijo(8),ejecutadoEn:nuevaFecha().de.CadenaISO()}}asincrónico externalWithdraw(t){let r=await f.query.masterWallets.findFirst({where:Wt(G(z.assetName,t.assetName),G(z.blockchain,t.blockchain),G(z.scenario,t.scenario))});if(!r)throw new Error(`No se encontró la billetera maestra para ${t.assetName} en ${t.blockchain}`);let i=await B.estimateGas({blockchain:t.blockchain,assetType:t.assetName===r.smartContractAddress?\"token\":\"crypto\",amount:t.amount}),u=await Le.calculateGasMarkup({clientId:t.tenantId,blockchain:t.blockchain,transactionType:t.assetName===\"BTC\"?\"crypto_withdraw\":\"token_transfer\",gasReal:i.gasReal}),g=await f.query.virtualAccounts.findFirst({where:G(_.id,t.fromAccountId)}),h=JSON.parse(g?.balances||\"{}\"),s=parseFloat(h[t.assetName]||\"0\");if(s<parseFloat(t.amount))throw new Error(\"Saldo insuficiente\");h[t.assetName]=(s-parseFloat(t.amount)).toString(),await f.update(_).set({balances:JSON.stringify(h)}).where(G(_.id,t.fromAccountId));let a=`0x${Lt.randomBytes(32).toString(\"hex\")}`;return{txId:(await f.insert(de).values({Id.inquilino:t.inquilino,tipo:\"retiro_externo\",escenario:t.scenario,toExternalAddress:t.toExternalAddress,tipo.activo:\"cripto\",nombre.activo:t.nombre.activo,blockchain:t.blockchain,cantidad:t.cantidad,gasReal:u.gasReal.toString(),porcentaje.de.margen.gas:u.porcentaje.de.margen.gas,gasCargado :u.gasCharged.toString(),commissionAmount:u.yourProfit.toString(),status:\"pendiente\",txHash:a}).returning())[0].id,status:\"pendiente_de_confirmación\",txHash:a,amount:t.amount,gasReal:u.gasReal.toFixed(8),gasCharged:u.gasCharged.toFixed(8),yourProfit:u.yourProfit.toFixed(8),estimatedTime:\"12 segundos\"}}async assignMasterToClient(t,r,i){return await f.update(z).set({assignedToTenantId:r,gasMarkupPercentage:i}).where(G(z.id,t)),{success:!0,masterId:t,assignedTo:r,gasMarkup:i,assignedAt:new Date().toISOString()}}async getVirtualAccountBalance(t){let r=await f.query.virtualAccounts.findFirst({where:G(_.id,t)});if(!r)throw new Error(\"Cuenta no encontrada\");let i=JSON.parse(r.balances||\"{}\"); return{accountId:t,balances:i,totalUsd:Object.entries(i).reduce((u,[g,h])=>{let s={ETH:2500,BTC:45e3,GOLD:500,SILVER:250}; return u+parseFloat(h)*(s[g]||0)},0)}}},Ht=new Ne});import Ce de\"express\";import{z como w} de\"zod\";D();V();import{eq como A,and como Z,desc como ie,sql como De,gte como Nt,lte como Ct} de\"drizzle-orm\";var Ue=class{async getTenant(t){let[r]=await f.select().from(x).where(A(x.id,t));return r||void 0}async getTenantByApiKeyHash(t){let[r]=await f.select().from(x).where(A(x.apiKeyHash,t));return r||void 0}async getTenantByEmail(t){let[r]=await f.select().from(x).where(A(x.email,t));return r||void 0}async getAllTenants(){return f.select().from(x).orderBy(ie(x.createdAt))}async createTenant(t){let[r]=await f.insert(x).values(t).returning();return r}async updateTenant(t,r){let[i]=await f.update(x).set({...r,updatedAt:nueva fecha}).where(A(x.id,t)).returning();devolver i||void 0}async deleteTenant(t){await f.update(x).set({estado:\"eliminado\",updatedAt:nueva fecha}).where(A(x.id,t))}async getAddress(t){let[r]=await f.select().from(S).where(A(S.id,t));devolver r||void 0}async getAddressByAddress(t,r,i){let[u]=await f.select().from(S).where(Z(A(S.tenantId,t),A(S.chain,r),A(S.address,i)));devolver u||void 0}async getAddressesByTenant(t,r){let i=f.select().from(S).where(A(S.tenantId,t)),u=[A(S.tenantId,t)];devuelve r?.chain&&u.push(A(S.chain,r.chain)),r?.status&&u.push(A(S.status,r.status)),f.select().from(S).where(Z(...u)).orderBy(ie(S.createdAt)).limit(r?.limit||50).offset(r?.offset||0)}asincrónico countAddressesByTenant(t){let[r]=await f.select({count:De`count(*)`}).from(S).where(Z(A(S.tenantId,t),A(S.status,\"active\")));devuelve r?.count||0}asincrónico createAddress(t){let[r]=await f.insert(S).values(t).returning();return r}async updateAddress(t,r){let[i]=await f.update(S).set({...r,updatedAt:nueva fecha}).where(A(S.id,t)).returning();return i||void 0}async archiveAddress(t){await f.update(S).set({estado:\"archivado\",eliminadoAt:nueva fecha,updatedAt:nueva fecha}).where(A(S.id,t))}async getTransaction(t){let[r]=await f.select().from(j).where(A(j.id,t));return r||void 0}async getTransactionByHash(t,r){let[i]=await f.select().from(j).where(Z(A(j.chain,t),A(j.txHash,r)));return i||void 0}async getTransactionsByTenant(t,r){let i=[A(j.tenantId,t)];return r?.chain&&i.push(A(j.chain,r.chain)),r?.status&&i.push(A(j.status,r.status)),f.select().from(j).where(Z(...i)).orderBy(ie(j.createdAt)).limit(r?.limit||50).offset(r?.desplazamiento||0)}asincrónico createTransaction(t){let[r]=await f.insert(j).values(t).returning();devolver r}asincrónico updateTransaction(t,r){let[i]=await f.update(j).set(r).where(A(j.id,t)).returning();devolver i||void 0}asincrónico getWebhook(t){let[r]=await f.select().from(K).where(A(K.id,t));devolver r||void 0}asincrónico getWebhooksByTenant(t){devolver f.select().from(K).where(A(K.tenantId,t)).orderBy(ie(K.createdAt))}asincrónico countWebhooksByTenant(t){let[r]=await f.select({count:De`count(*)`}).from(K).where(Z(A(K.tenantId,t),A(K.active,!0)));devuelve r?.count||0}asinc createWebhook(t){let[r]=await f.insert(K).values(t).returning();devuelve r}asinc updateWebhook(t,r){let[i]=await f.update(K).set(r).where(A(K.id,t)).returning();devuelve i||void 0}asinc deleteWebhook(t){await f.delete(K).where(A(K.id,t))}asinc getVirtualAccount(t){let[r]=await f.select().from(_).where(A(_.id,t));devuelve r||void 0}asinc obtenerCuentasVirtualesPorInquilino(t){devolver f.seleccionar().de(_).donde(A(_.IdInquilino,t)).ordenarPor(ie(_.createdAt))}asincrónico contarCuentasVirtualesPorInquilino(t){let[r]=await f.seleccionar({count:De`count(*)`}).de(_).donde(Z(A(_.IdInquilino,t),A(_.estado,\"activo\")));devolver r?.count||0}asincrónico crearCuentaVirtual(t){let[r]=await f.insertar(_).valores(t).devolver();devolver r}asincrónico actualizarCuentaVirtual(t,r){let[i]=await f.actualizar(_).set(r).donde(A(_.id,t)).devolver();devolver i||void 0}asincrónico recordApiUsage(t){let[r]=await f.insert(W).values(t).returning();return r}async getApiUsageByTenant(t,r,i){return f.select().from(W).where(Z(A(W.tenantId,t),Nt(W.timestamp,r),Ct(W.timestamp,i))).orderBy(ie(W.timestamp))}async getApiUsageStats(t,r,i){let u=await this.getApiUsageByTenant(t,r,i),g={},h={},s=0,a=0;for(let e of u)s+=e.unidades,a+=e.créditos,g[e.punto final]=(g[e.punto final]||0)+1,e.cadena&&(h[e.cadena]=(h[e.cadena]||0)+1);return{totalRequests:u.length,totalUnits:s,totalCredits:a,byEndpoint:g,byChain:h}}async getBillingAggregation(t,r){let[i]=await f.select().from(Q).where(Z(A(Q.tenantId,t),A(Q.periodo,r)));return i||void 0}async upsertBillingAggregation(t){let r=await this.getBillingAggregation(t.tenantId,t.periodo);if(r){let[i]=await f.update(Q).set(t).where(A(Q.id,r.id)).returning();return i}else{let[i]=await f.insert(Q).values(t).returning();return i}}async createAuditLog(t){let[r]=await f.insert(te).values(t).returning();return r}async getAuditLogsByTenant(t,r=100){return f.select().from(te).where(A(te.tenantId,t)).orderBy(ie(te.timestamp)).limit(r)}},p=new Ue;Oe();import ce from\"crypto\";D();var Ze=process.env.ADMIN_API_KEY;function Ie(){let n=`tatum_${ce.randomBytes(28).toString(\"hex\")}`,t=n.substring(0,16),r=tt(n);devolver{clave:n,prefijo:t,hash:r}}función tt(n){devolver ce.createHash(\"sha256\").update(n).digest(\"hex\")}función we(){devolver ce.randomBytes(32).toString(\"hex\")}función st(){devolver`req_${ce.randomBytes(16).toString(\"hex\")}`}función asíncrona b(n,t,r){n.requestId=st(),t.setHeader(\"X-Request-ID\",n.requestId);deje que i=n.headers[\"x-api-key\"]; if(!i)return t.status(401).json({success:!1,error:\"Clave API faltante\",requestId:n.requestId});let u=tt(i),g=await p.getTenantByApiKeyHash(u); if(!g)return t.status(401).json({success:!1,error:\"Clave API no válida\",requestId:n.requestId}); if(g.status!==\"activo\")return t.status(403).json({success:!1,error:`La cuenta es ${g.status}`,requestId:n.requestId});n.tenant=g,r()}function $(n,t,r){n.requestId=st(),t.setHeader(\"X-Request-ID\",n.requestId);let i=n.headers[\"x-admin-key\"];if(!Ze)return t.status(503).json({éxito:!1,error:\"API de administración no configurada\",requestId:n.requestId});if(!i)return t.status(401).json({éxito:!1,error:\"Falta la clave de API de administración\",requestId:n.requestId});let u=ce.createHash(\"sha256\").update(i).digest(\"hex\"),g=ce.createHash(\"sha256\").update(Ze).digest(\"hex\");if(!ce.timingSafeEqual(Buffer.from(u),Buffer.from(g)))return t.status(401).json({éxito:!1,error:\"Clave de API de administrador no válida\",requestId:n.requestId});n.isAdmin=!0,r()}var et=new Map;function k(n,t,r){if(!n.tenant)return r();let i=n.tenant.id,u=Date.now(),g=1e3,h=et.get(i);(!h||h.resetAt<u)&&(h={count:0,resetAt:u+g},et.set(i,h)),h.count++;let s=n.tenant.rateLimit,a=Math.max(0,sh.count);if(t.setHeader(\"X-RateLimit-Límite\",s),t.setHeader(\"X-RateLimit-Restante\",a),t.setHeader(\"X-RateLimit-Restablecer\",Math.ceil(h.resetAt/1e3)),h.count>s)return t.status(429).json({éxito:!1,error:\"Límite de tasa excedido\", requestId:n.requestId,retryAfter:Math.ceil((h.resetAt-u)/1e3)});r()}función en(n){return(t,r,i)=>{if(!t.tenant)return r.status(401).json({éxito:!1,error:\"Se requiere autenticación\", requestId:t.requestId});let u=H[t.tenant.tier];if(!u)return r.status(403).json({éxito:!1,error:\"Configuración de nivel no válida\", requestId:t.requestId});if(n===\"kms\"&&!u.kmsAllowed)return r.status(403).json({éxito:!1,error:\"KMS no está disponible en Su nivel. Actualice a Scale o Enterprise.\",requestId:t.requestId,upgrade:!0});if(n===\"archival\"&&!u.archivalAccess)return r.status(403).json({success:!1,error:\"El acceso a archivos no está disponible en su nivel. Actualice a Enterprise.\",requestId:t.requestId,upgrade:!0});i()}}function Ae(n,t,r){if(!n.tenant)return r();let i=n.params.chain||n.body?.chain;if(!i)return r();let g=H[n.tenant.tier]?.chains||n.tenant.allowedChains;if(!g.includes(i))return t.status(403).json({success:!1,error:`La cadena '${i}' no está disponible en su nivel`,allowedChains:g,requestId:n.requestId,upgrade:!0});r()}D();función asíncrona nt(){if(!process.env.SEED_DEMO_DATA)return null;console.log(\"Comprobando si hay un inquilino de demostración...\");let n=await p.getTenantByEmail(\"demo@tatum-gateway.io\");if(n)return console.log(\"El inquilino de demostración ya existe\"),n;console.log(\"Creando inquilino de demostración...\"); let{prefix:t,hash:r}=Ie(),i=H.scale,u=await p.createTenant({name:\"Cuenta de demostración\",email:\"demo@tatum-gateway.io\",tier:\"scale\",status:\"active\",apiKeyPrefix:t,apiKeyHash:r,hmacSecret:we(),allowedChains:i.chains,maxAddresses:i.maxAddresses,maxWebhooks:i.maxWebhooks,maxVirtualAccounts:i.maxVirtualAccounts,rateLimit:i.rateLimit,monthlyQuota:i.monthlyQuota,companyName:\"Demostración de Tatum Gateway\",website:\"https://tatum.io\"});console.log(\"Inquilino de demostración creado:\",u.id),await p.createAuditLog({Id.inquilino:u.id,acción:\"inquilino.creado\",recurso:\"inquilino\",Id.recurso:u.id,cambios:{nivel:\"escala\",origen:\"semilla\"}});para(dejar g=0;g<10;g++)esperar p.recordApiUsage({Id.inquilino:u.id,punto final:`/api/v1/${[\"direcciones\",\"saldos\",\"tokens\",\"transacciones\"][g%4]}`,método:[\"OBTENER\",\"POST\"][g%2],cadena:[\"ethereum\",\"bitcoin\",\"solana\",\"polígono\"][g%4],acción:[\"saldo consulta_de_ance\",\"creación_de_dirección\",\"saldo_de_token\",\"historial_de_transacciones\"][g%4],unidades:[.5,1,1,2][g%4],créditos:[5e-4,.001,.001,.002][g%4],código_de_estado:200,id_de_solicitud:`demo_${g}`,tiempo_de_respuestaMs:50+Math.floor(Math.random()*100)});retorno console.log(\"¡Datos de uso de demostración sembrados!\"),u}D();función O(n){return async(t,r,i)=>{if(!t.tenant)return i();let u=le[n];t.metered={acción:n,unidades:u.units,créditos:u.cost};let g=r.json.bind(r);r.json=h=>{let s=Date.now();return p.recordApiUsage({Id.inquilino:t.id.inquilino, punto final:t.ruta, método:t.método, cadena:t.params.cadena||t.cuerpo?.cadena||nulo, acción:n, unidades:u.unidades, créditos:u.costo, código de estado:r.código de estado, Id.solicitud:t.id.solicitud, tiempo de respuesta:Fecha.ahora()-s, metadatos:{agente-usuario:t.encabezados[\"agente-usuario\"], ip:t.ip}}).catch(consola.error),h&&tipo de h==\"objeto\"&&(h.meta={...h.meta, Id.solicitud:t.id.solicitud, marca de tiempo:nueva Fecha().toISOString(),medido:{acción:n,unidades:u.unidades,créditos:u.costo}}),g(h)},i()}}función asíncrona be(n){let t=nueva fecha,r=nueva fecha(t.getFullYear(),t.getMonth(),1),i=await p.getApiUsageStats(n,r,t);return{totalRequests:i.totalRequests,totalUnits:i.totalUnits,totalCredits:i.totalCredits,costUsd:i.totalCredits}}función asíncrona Se(n,t){if(t===-1)return{permitido:!0,usado:0,restante:-1,porcentajeUsado:0};let r=await ser(n),i=Math.floor(r.totalUnits),u=ti,g=i/t*100;devolver{permitido:u>0,usado:i,restante:Math.max(0,u),porcentajeUsado:Math.min(100,g)}}función ae(n,t,r){si(!n.inquilino)devolver r();Se(n.inquilino.id,n.inquilino.cuotamensual).entonces(i=>{si(t.setHeader(\"X-Cuota-Usada\",i.usada),t.setHeader(\"X-Cuota-Restante\",i.restante),t.setHeader(\"X-Cuota-Porcentaje\",Math.round(i.porcentajeUsado)),!i.permitido)devolver t.status(429).json({success:!1,error:\"Cuota mensual excedida\",requestId:n.requestId,quota:{used:i.used,limit:n.tenant.cuotamensual,porcentajeUsado:i.porcentajeUsado},actualización:!0});r()}).catch(()=>r())}D();importar Ft desde\"crypto\";var $t=1e5,Ot=32,qt=\"sha256\",ne=null,pe=class n{secretomaestro;versión;createdAt;estático SALT_PREFIXES={claveprivada:\"kms:clave_privada:v1\",carteramaestra:\"kms:cartera_maestra:v1\",secretohmac:\"kms:secretohmac:v1\",derivacióndeclaveapi:\"kms:claveapi:v1\",cifradodesesión:\"kms:sesión:v1\"};constructor(t,r=1){if(!t||t.length<32)arrojar nuevo Error(\"El secreto maestro debe ser al menos 32 bytes (usar: openssl rand -hex 16)\");this.masterSecret=t,this.version=r,this.createdAt=new Date,t.length<64&&console.warn(\"\\u26A0\\uFE0F ADVERTENCIA: El secreto del KMS maestro tiene menos de 64 bytes. Considere usar: openssl rand -hex 32\")}static initialize(t){let r=t||process.env.MASTER_KMS_SECRET||process.env.SESSION_SECRET;if(!r)throw new Error(\"Variable de entorno MASTER_KMS_SECRET no establecida. Generar con: openssl rand -hex 32\");return ne||(ne=new n(r),console.log(\"\\u2705 KMS inicializado con secreto maestro\"),ne)}static getInstance(){return ne||(ne=n.initialize()),ne}deriveKey(t,r=\"\"){let i=n.SALT_PREFIXES[t];if(!i)throw new Error(`Tipo de clave desconocida: ${t}`);let u=Buffer.from(`${i}:${r}`);return{key:Ft.pbkdf2Sync(this.masterSecret,u,$t,Ot,qt),version:this.version,keyType:t}}derivePrivateKeyEncryptionKey(t){return this.deriveKey(\"privateKey\",t).key}deriveMasterWalletKey(t){return this.deriveKey(\"masterWallet\",t).key}deriveHmacKey(t){return this.deriveKey(\"hmacSecret\",t).key}deriveSessionEncryptionKey(t){return this.deriveKey(\"sessionEncryption\",t).key}getConfig(){return{masterSecret:\"[CENSURADO]\",version:this.version,createdAt:this.createdAt}}rotate(t){let r=new n(t,this.version+1);return ne=r,console.log(`\\u2705 KMS rotado a la versión ${r.version}`),r}static test(){try{let t=n.getInstance(),r=t.deriveKey(\"privateKey\",\"test-wallet-1\"),i=t.deriveKey(\"privateKey\",\"test-wallet-1\");if(r.key.toString(\"hex\")!==i.key.toString(\"hex\"))throw new Error(\"La derivación de la clave KMS no es determinista\");let u=t.deriveKey(\"privateKey\",\"test-wallet-2\");if(r.key.toString(\"hex\")===u.key.toString(\"hex\"))throw new Error(\"Colisión de derivación de clave KMS detectada\");return console.log(\"\\u2705 Autoprueba de KMS aprobada\"),!0}catch(t){return console.error(\"\\u274C Autoprueba de KMS fallida:\",t),!1}}};try{pe.initialize()}catch(n){console.warn(\"\\u26A0\\uFE0F Advertencia de inicialización de KMS:\",n)}import qe from\"crypto\";var Pe=\"aes-256-gcm\",Re=32,Gt=16;function rt(n,t,r){if(t.length!==Re)throw new Error(`La clave de cifrado debe ser de ${Re} bytes`);let i=qe.randomBytes(Gt),u=qe.createCipheriv(Pe,t,i);r&&u.setAAD(Buffer.from(r));let g=Buffer.concat([u.update(n,\"utf8\"),u.final()]),h=u.getAuthTag();return{ciphertext:g.toString(\"hex\"),iv:i.toString(\"hex\"),authTag:h.toString(\"hex\"),algorithm:Pe}}function ot(n,t,r){if(t.length!==Re)throw new Error(`La clave de cifrado debe tener ${Re} bytes`);if(n.algorithm!==Pe)throw new Error(`Algoritmo no compatible: ${n.algorithm}`);let i=Buffer.from(n.iv,\"hex\"),u=Buffer.from(n.ciphertext,\"hex\"),g=Buffer.from(n.authTag,\"hex\"),h=qe.createDecipheriv(Pe,t,i);r&&h.setAAD(Buffer.from(r)),h.setAuthTag(g);try{return Buffer.concat([h.update(u),h.final()]).toString(\"utf8\")}catch{throw new Error(\"Error de descifrado: los datos pueden estar dañados o alterados\")}}import{sql como Vt}desde\"drizzle-orm\";import{webcrypto como it}desde\"crypto\";var Yt=w.object({nombre:w.string().min(2),correo electrónico:w.string().correo electrónico(),nivel:w.enum([\"starter\",\"scale\",\"enterprise\"]).predeterminado(\"starter\"),nombreDeEmpresa:w.string().opcional(),sitio web:w.string().url().opcional(),correo electrónico de facturación:w.string().correo electrónico().opcional()}),zt=w.object({cadena:w.string(),etiqueta:w.string().opcional(),etiquetas:w.array(w.string()).opcional(),URLdelwebhook:w.string().url().opcional()}),Xt=w.object({url:w.string().url(),eventos:w.array(w.enum(Be)).min(1)});función asíncrona ct(n,t){nt().catch(console.error),t.get(\"/\",(s,a)=>{a.json({name:\"Tatum API Gateway\",version:\"1.0.0\",description:\"API Gateway de blockchain de nivel empresarial compatible con más de 130 blockchains\",status:\"running\",documentation:\"GET /api/docs | GET /api/docs/model | GET /api/docs/examples\",quickStart:\"1. Obtener la clave API del administrador | 2. Agregar el encabezado 'x-api-key: YOUR_KEY' | 3. Enviar por POST a /api/tenants para registrarse\",endpoints:{health:\"GET /api/health\",pricing:\"GET /api/pricing\",chains:\"GET /api/chains\",tenants:\"GET /api/tenants | POST /api/inquilinos\", direcciones:\"GET /api/v1/direcciones | POST /api/v1/direcciones\", transacciones:\"GET /api/v1/transacciones\", webhooks:\"POST /api/v1/webhooks | GET /api/v1/webhooks\", puerta de enlace:\"POST /api/v1/puerta de enlace/cuentas-virtuales | GET /api/v1/puerta de enlace/cuentas-virtuales | POST /api/v1/puerta de enlace/intercambio | POST /api/v1/puerta de enlace/retiro\", administrador:\"GET /api/admin/configuración-gas | PUT /api/admin/configuración-gas/global | GET /api/admin/ingresos | GET /api/admin/transacciones\", rwa:\"POST /api/v1/rwa/tokens | GET /api/v1/rwa/tokens | POST /api/v1/rwa/tokens/:id/transfer\"},businessModel:{type:\"Puerta de enlace API de doble panel (100 % de ingresos de administración)\",panels:{cryptoPanel:{description:\"Control de billetera maestra con sistema de cuentas virtuales\",revenueStreams:{internalSwaps:\"0,5 % de comisión (sin comisiones de gas)\",gasMarkup:\"40 % de margen configurable sobre las comisiones de gas\",setupFees:\"$500 por cliente de RWA\"},annualRevenue:\"$204K (Y1) \\u2192 $1.02M (Y2) \\u2192 $2.04M (Y3)\"}, rwaPanel:{description:\"Infraestructura de tokenización de activos del mundo real\",revenueStreams:{setupFees:\"$500 por token (pago único)\",nnualFees:\"$200 por token al año\",tradingCommissions:\"0.5% del volumen total de operaciones (100% para administración)\"},annualRevenue:\"$654K (Y1) \\u2192 $8.07M (Y2) \\u2192 $60.21M (Y3)\"}},profitMargins:\"82.5% (Y1) \\u2192 91.2% (Y2) \\u2192 96,8 % (año 3)\", totalProjections:{año 1:\"$858 000\", año 2:\"$9,09 000\", año 3:\"$62,25 000\"}}, auth:{type:\"Clave API + HMAC\", method:\"x-api-key header (Tatum v3 recommended)\", example:\"curl -H 'x-api-key: YOUR_API_KEY' https://api.example.com/api/v1/...\", documentation:\"https://docs.tatum.io/docs/authentication\"}, rateLimit:\"Por nivel: Starter 10/s, Scale 100/s, Enterprise 1000/seg\",docs:\"https://api.tatum.io/docs\",github:\"https://github.com/MasterFital/tatum-api-gateway\"})}),t.get(\"/api/docs/model\",(s,a)=>{a.json({title:\"Tatum API Gateway - Modelo de Negocio\",introduction:\"Arquitectura de doble panel que genera el 100% de ingresos administrativos mediante el trading de criptomonedas y la tokenización de RWA\",panels:{crypto:{name:\"Panel CRYPTO (100% de tus ingresos)\",description:\"Controlas las billeteras maestras (BTC, ETH, SOL, MATIC). Los clientes operan a través de cuentas virtuales.\",how_it_works:{step1:\"El administrador crea billeteras maestras mediante POST /api/admin/master-wallets\",step2:\"Los clientes crean cuentas virtuales mediante POST /api/v1/gateway/virtual-accounts\",paso 3:\"Los clientes pueden intercambiar internamente (comisión del 0,5 % para usted) o retirar externamente (margen de beneficio del 40 %)\",paso 4:\"El administrador registra todos los ingresos mediante GET /api/admin/revenue\"},revenue_streams:{internal_swaps:{description:\"El cliente intercambia BTC \\u2192 ETH\",fee:\"0,5 % del importe del intercambio\",gas_cost:\"Cero (interno)\",admin_profit:\"100 % de la comisión\",example:\"El cliente intercambia 1 ETH \\u2192 0,02 BTC | Comisión: 0,0001 BTC (100 % para el administrador)\"},gas_markup:{description:\"El cliente retira criptomonedas a una billetera externa\",fee:\"Margen de beneficio del 40 % sobre el gas real costo\", ejemplo:\"Gas Bitcoin: $3 reales | Cobras: $4.20 | Tu ganancia: $1.20 (40%)\"}}, proyecciones:{año1:{volumen:\"Promedio de 1 millón de USD/mes\", swaps mensuales:\"5K \\xD7 0.5% = $25K\", gas mensual:\"Retiros de 10K \\xD7 $3 \\xD7 40% = $12K\", total mensual:\"$17K\", anual:\"$204K\"}, año2:{volumen:\"Promedio de 5 millones de USD/mes\", anual:\"$1.02M\"}, año3:{volumen:\"Promedio de 10 millones de USD/mes\", anual:\"$2.04M\"}}}, rwa:{nombre:\"Panel RWA (100% Tus Ingresos + Tarifas)\", descripción:\"Los clientes emiten tokens. Tú proporcionas la infraestructura. Te quedas con el 100% de las tarifas y comisiones de trading.\", cómo_funciona:{paso 1:\"El cliente solicita la creación de un token: POST /api/v1/rwa/tokens\", paso 2:\"Cobras $500 de comisión de configuración + implementación del contrato inteligente\", paso 3:\"El token se activa. Los clientes operan internamente (comisión del 0,5 % para ti)\", paso 4:\"Comisión anual de mantenimiento de $200 por token\", paso 5:\"Todos los retiros externos tienen un margen de gas del 40 % (para ti)\", paso 6:\"Seguimiento de los ingresos mediante GET /api/admin/rwa-revenue\"},revenue_streams:{setup_fees:{description:\"Comisión única por token lanzado\",amount:\"$500\",frequency:\"Por token\"},annual_fees:{description:\"Mantenimiento anual por token activo\",amount:\"$200\",frequency:\"Por token por año\"}, comisiones_comerciales:{descripción:\"0.5% del volumen total de operaciones de tokens (100% para el administrador)\", porcentaje:\"0.5%\", ejemplo:\"Volumen de tokens: $100,000/mes | Su comisión: $500/mes = $6,000/año por token\"}, margen_gas:{descripción:\"40% de margen en las comisiones de gas para retiros externos\", porcentaje:\"40%\"}}, beneficios_del_cliente:{beneficio1:\"Infraestructura de tokenización (su costo: ~$0.10 por token)\", beneficio2:\"Mercado listo para usar\", beneficio3:\"Liquidez instantánea (operadores del día 1)\", beneficio4:\"Seguridad y cumplimiento a su cargo\", pago_del_cliente:\"$500 de configuración + $200/año solo\"}, proyecciones:{año1:{tokens:\"20 tokens nuevos\", tarifas_de_configuración:\"20 \\xD7 $500 = $10K\", tarifas_anuales:\"20 \\xD7 $200 = $4K\", comisiones_de_operación:\"0.5% de un volumen de ~$100M = $500K\", total:\"$514K\"}, año2:{tokens:\"100 tokens en total\", tarifas_de_configuración:\"100 \\xD7 $500 = $50K\", tarifas_anuales:\"100 \\xD7 $200 = $20K\", comisiones_de_operación:\"0.5% de un volumen de ~$1.6B = $8M\",total:\"$8.07M\"},año3:{tokens:\"300 tokens en total\",tarifas_de_configuración:\"300 \\xD7 $500 = $150K\",tarifas_anuales:\"300 \\xD7 $200 = $60K\",comisiones_de_comercio:\"0.5% de un volumen de ~$12B = $60M\",total:\"$60.21M\"}}}},resumen_de_ingresos:{título:\"Ingresos combinados (Cripto + RWA)\",año 1:{cripto:\"$204K\",rwa:\"$654K\",total:\"$858K\",margen:\"82.5%\"},año 2:{cripto:\"$1.02M\",rwa:\"$8.07M\",total:\"$9.09M\",margen:\"91.2%\"},año 3:{cripto:\"$2.04M\",rwa:\"$60.21M\",total:\"$62.25M\",margen:\"96.8%\"}},puntos_clave:[\"El 100% de todos los ingresos van al administrador (usted)\",\"Los clientes obtienen acceso a la infraestructura, no a la repartición de ingresos\",\"Las tarifas de configuración son ingresos inmediatos\",\"Las comisiones de trading escalan infinitamente con el volumen\",\"El margen de gas es puro beneficio (costo mínimo de infraestructura)\",\"Costo de adquisición de clientes cero (los clientes se traen a sí mismos)\"]})}),t.get(\"/api/docs/examples\",(s,a)=>{a.json({title:\"Tatum API Gateway - Ejemplos de uso\",autenticación: {descripción:\"Todas las solicitudes requieren el encabezado x-api-key\",ejemplo:\"curl -H 'x-api-key: YOUR_API_KEY' https://api.example.com/api/v1/...\",encabezados:{\"x-api-key\":\"Su clave API del administrador\",\"Content-Type\":\"application/json\"}},crypto_examples: {título:\"Ejemplos del panel CRYPTO\",create_virtual_account: {descripción:\"El cliente crea una cuenta virtual para almacenar criptomonedas\",endpoint:\"POST /api/v1/gateway/virtual-accounts\",solicitud:{tipoDeCuenta:\"individual\"},respuesta:{éxito:!0,cuentaVirtual:{id:\"va-123\",identificadorDeInquilino:\"cliente-1\",tipoDeCuenta:\"individual\",saldos:{BTC:\"0\",ETH:\"0\",SOL:\"0\"},estado:\"activo\"}}},interno_swap_0_5_percent:{descripción:\"El cliente intercambia BTC por ETH (comisión del 0,5 % para el administrador)\",punto final:\"POST /api/v1/gateway/swap\", solicitud: {fromAccountId:\"va-123\", fromAsset:\"BTC\", toAsset:\"ETH\", importe:\"1.0\"}, respuesta: {éxito:!0, intercambio: {id:\"swap-456\", fromAsset:\"BTC\", toAsset:\"ETH\", importe:\"1.0\", comisión:\"0.005 BTC (0.5% para el administrador)\", estado:\"completado\"}, nota:\"Sin comisiones de gas, comisión del 0.5% aplicada\"}}, external_withdraw_40_percent_markup: {descripción:\"El cliente retira a una billetera externa (40% de margen de gas para el administrador)\", punto final:\"POST /api/v1/gateway/withdraw\", solicitud: {fromAccountId:\"va-123\", activo:\"ETH\", importe:\"1.0\", dirección:\"0x1234567890abcdef...\"}, respuesta: {éxito:!0, retiro: {id:\"withdraw-789\", activo:\"ETH\", importe:\"1.0\", dirección:\"0x1234567890abcdef...\", gasReal:\"3 USD\", gasCharged:\"4.20 USD (40% de margen)\", adminProfit:\"1.20 USD\", estado:\"pendiente\", txHash:\"0xabcd...\"}}}, ver_historial_de_transacciones: {descripción:\"El cliente visualiza su transacción historial\", punto final:\"GET /api/v1/transactions?limit=50\", respuesta:{éxito:!0, transacciones:[{id:\"swap-456\", tipo:\"internal_swap\", activo:\"BTC\", importe:\"1.0\", comisión:\"0.005\", estado:\"completado\", creado el:\"2024-11-30T10:00:00Z\"}], paginación:{total:42, límite:50, desplazamiento:0}}}}, ejemplos_rwa:{título:\"Ejemplos de paneles RWA\", crear_rwa_token_500_setup:{descripción:\"El cliente crea un token (paga $500 de tarifa de configuración al administrador)\", punto final:\"POST /api/v1/rwa/tokens\",solicitud:{nombreDeActivo:\"Fondo Inmobiliario\",símbolo:\"REF\",cadenaDeBlockchain:\"Ethereum\",decimales:18,suministroTotal:\"1000000\",nombreDeEmisor:\"RE Properties Inc\",descripción:\"Inversión Inmobiliaria Tokenizada\"},respuesta:{éxito:!0,token:{id:\"token-ref-1\",nombreDeActivo:\"Fondo inmobiliario\", símbolo:\"REF\", cadena de bloques:\"ethereum\", suministro total:\"1000000\", dirección del contrato inteligente:\"0x...\", estado:\"creado\"}, precios: {tarifa de configuración:\"$500 (pago único) - PAGADO AL ADMINISTRADOR\", tarifa anual:\"$200/año - PAGADO AL ADMINISTRADOR\", comisión de negociación:\"0.5% en todas las operaciones - 100% PARA EL ADMINISTRADOR\"}}}, lista_rwa_tokens: {descripción:\"El cliente visualiza sus tokens y volumen de operaciones\", punto final:\"GET /api/v1/rwa/tokens\", respuesta: {éxito:!0, tokens:[{id:\"token-ref-1\", nombre_del_activo:\"Bienes raíces Fondo\", símbolo:\"REF\", cadena de bloques:\"ethereum\", oferta total:\"1000000\", estado:\"activo\", tarifa de configuración:\"500, tarifa anual:\"200, volumen de negociación:\"250000 USD\", comisión de negociación:\"1250 USD (0,5 % para el administrador)\"}], resumen:{totalTokens:\"1, comisiones de negociación totales:\"1250 USD (100 % para el administrador)\", tarifas de configuración cobradas:\"500 USD (100 % para el administrador)\"}}}, rwa_token_transfer_0_5_percent:{descripción:\"El titular del token negocia el token REF (0,5 % de comisión para el administrador)\", punto final:\"POST /api/v1/rwa/tokens/token-ref-1/transfer\",request:{toAddress:\"0xabcd...\",amount:\"100\"},response:{success:!0,transfer:{id:\"transfer-123\",tokenId:\"token-ref-1\",amount:\"100 REF\",toAddress:\"0xabcd...\",commission:\"0.5 REF (0.5% para el administrador)\",status:\"completed\",txHash:\"0x...\"},note:\"0.5% de comisión de trading aplicada y cobrada por el administrador\"}}},admin_examples:{title:\"Ejemplos del panel de administración\",view_revenue:{description:\"El administrador visualiza los ingresos totales (swaps + margen de gas)\",endpoint:\"GET /api/admin/revenue\",respuesta:{éxito:!0,cryptoRevenue:{totalSwapCommissions:\"1245.67 USD\",totalGasMarkupRevenue:\"3456.78 USD\",totalVolume:\"249000 USD\",revenueByBlockchain:{ethereum:\"2345.67\",polygon:\"1234.56\",bitcoin:\"3456.78\"}}}},view_rwa_revenue:{description:\"El administrador visualiza los ingresos de RWA (comisiones de configuración + anuales + de trading)\",endpoint:\"GET /api/admin/rwa-revenue\",respuesta:{éxito:!0,rwaRevenue:{setupFees:{count:12,total:\"6000 USD\", Tarifas anuales: {Clientes activos: 12, Total: 2400 USD\", Comisiones por operaciones: {Este mes: 12500 USD\", Este año: 125000 USD\", Tasa: 0,5 % del volumen total de operaciones\", Ingresos mensuales totales: 15000 USD\", Seguridad: {Autenticación: encabezado x-api-key (recomendado Tatum v3)\", Cifrado: Todas las claves privadas cifradas con AES-256\", Auditoría: Todas las transacciones registradas con registro de auditoría completo\", Límite de tasa: Starter 10/s, Scale 100/s, Enterprise 1000/seg\",documentación:\"https://docs.tatum.io/docs/authentication\"}})}),t.get(\"/api/test-tatum\",async(s,a)=>{try{let e=await B.healthCheck(),o={success:e.success,message:e.success?\"\\u2705 Conectado a la API de Tatum correctamente\":\"\\u274C Error al conectarse a la API de Tatum\",tatumApiUrl:process.env.TATUM_API_URL||\"https://api.tatum.io\",apiKeyConfigured:!!process.env.TATUM_API_KEY,apiKeyLength:process.env.TATUM_API_KEY?.length||0,timestamp:new Date().toISOString()};e.success&&e.data&&(o.blockchainInfo={chain:e.data.chain,blocks:e.data.blocks,mempool:e.data.mempool}),e.error&&(o.error=e.error,o.statusCode=e.statusCode),a.json({success:e.success,test:\"Prueba de conexión a la API de Tatum\",status:o,instructions:{production:\"Configure la variable de entorno TATUM_API_KEY con su API de producción de Tatum key\",documentation:\"https://docs.tatum.io/docs/authentication\",getApiKey:\"https://dashboard.tatum.io\"},requestId:s.requestId})}catch(e){a.status(500).json({success:!1,test:\"Prueba de conexión de la API de Tatum\",error:e.message,message:\"Error al probar la conexión de Tatum\",instructions:{checkApiKey:\"Asegúrese de que TATUM_API_KEY esté configurado en las variables de entorno\",checkUrl:\"Verifique que TATUM_API_URL esté correct\",documentation:\"https://docs.tatum.io/docs/authentication\"},requestId:s.requestId})}}),t.get(\"/api/docs\",(s,a)=>{a.json({title:\"Tatum API Gateway - Documentación completa\",message:\"Para obtener más información, visite estos puntos finales de la documentación:\",available_docs:{business_model:\"GET /api/docs/model - Explicación completa de los flujos de ingresos\",examples:\"GET /api/docs/examples - Ejemplos de uso para Crypto y RWA\",tatum_test:\"GET /api/test-tatum - Conexión de prueba a la API de Tatum (verificación de producción)\",this_endpoint:\"GET /api/docs - Esta página\",api_root:\"GET / - Información de la API y descripción general del modelo de negocio\"},quick_endpoints:{\"Crypto Panel\":[\"POST /api/v1/gateway/virtual-accounts - Crear cuenta virtual\",\"POST /api/v1/gateway/swap - Swap interno (comisión del 0,5%)\",\"POST /api/v1/gateway/withdraw - Retiro externo (margen de beneficio del 40%)\",\"GET /api/v1/transactions - Historial de transacciones\"],\"Panel RWA\":[\"POST /api/v1/rwa/tokens - Crear token (comisión de instalación de 500$)\",\"GET /api/v1/rwa/tokens - Listar tokens\",\"POST /api/v1/rwa/tokens/:id/transfer - Intercambio de tokens (comisión del 0,5%)\"],Admin:[\"GET /api/admin/revenue - Panel de ingresos de criptomonedas\",\"GET /api/admin/rwa-revenue - Panel de ingresos de RWA\",\"GET /api/admin/master-wallets - Lista de billeteras maestras\",\"POST /api/admin/master-wallets - Crear billetera maestra\"]},authentication:{method:\"x-api-key header\",example:\"Authorization: x-api-key YOUR_API_KEY\",documentation:\"https://docs.tatum.io/docs/authentication\"},support:{github:\"https://github.com/MasterFital/tatum-api-gateway\",tatum_docs:\"https://api.tatum.io/docs\",api_reference:\"https://docs.tatum.io/reference/welcome-to-the-tatum-api-reference\"}})}),t.get(\"/api/health\",async(s,a)=>{let e=await B.healthCheck();a.json({éxito:!0,estado:\"saludable\",servicios:{api:\"saludable\",base de datos:\"saludable\",tatum:e.success?\"saludable\":\"degradado\"},marca de tiempo:nueva Fecha().toISOString()})}), t.get(\"/api/pricing\",(s,a)=>{a.json({éxito:!0,precios:le,niveles:Object.entries(H).map(([e,o])=>({id:e,...o,precios:{starter:{mensual:0,incluido:1e4},escala:{mensual:99,incluido:1e5},empresa:{mensual:\"personalizado\",incluido:\"ilimitado\"}}[e]}))})}), t.get(\"/api/cadenas\",(s,a)=>{a.json({éxito:!0,cadenas:me,total:me.length})}), t.post(\"/api/inquilinos\",async(s,a)=>{try{let e=Yt.parse(s.body);if(await p.getTenantByEmail(e.email))return a.status(409).json({éxito:!1,error:\"Correo electrónico ya registrado\"});let{key:c,prefix:d,hash:y}=Ie(),m=H[e.tier],I=await p.createTenant({nombre:e.nombre,correo electrónico:e.correo electrónico,nivel:e.nivel,estado:\"activo\",apiKeyPrefix:d,apiKeyHash:y,hmacSecret:we(),allowedChains:[...m.cadenas],maxAddresses:m.maxAddresses,maxWebhooks:m.maxWebhooks,maxVirtualAccounts:m.maxVirtualAccounts,rateLimit:m.rateLimit,monthlyQuota:m.monthlyQuota,companyName:e.companyName,website:e.website,billingEmail:e.billingEmail});await p.createAuditLog({tenantId:I.id,action:\"tenant.created\",resource:\"tenant\",resourceId:I.id,changes:{tier:e.tier}}),a.status(201).json({success:!0,tenant:{id:I.id,name:I.name,email:I.email,tier:I.tier,status:I.status,apiKey:c,hmacSecret:I.hmacSecret,limits:{chains:I.allowedChains,maxAddresses:I.maxAddresses,maxWebhooks:I.maxWebhooks,maxVirtualAccounts:I.maxVirtualAccounts,rateLimit:I.rateLimit,monthlyQuota:I.monthlyQuota},createdAt:I.createdAt},warning:\"Guarde su clave API ahora. No se puede recuperar de nuevo.\"})}catch(e){if(e.name===\"ZodError\")return a.status(400).json({éxito:!1,error:\"Error de validación\",details:e.errors});console.error(\"Error al crear inquilino:\",e),a.status(500).json({éxito:!1,error:\"Error interno del servidor\"})}}),t.get(\"/api/tenants\",async(s,a)=>{try{let e=await p.getAllTenants(),o=await Promise.all(e.map(async c=>{let d=await be(c.id),y=await p.countAddressesByTenant(c.id); return{id:c.id,name:c.name,email:c.email,tier:c.tier,status:c.status,companyName:c.companyName,addressCount:y,usage:{requests:d.totalRequests,units:Math.floor(d.totalUnits),costUsd:d.costUsd.toFixed(4)},createdAt:c.createdAt}}));a.json({success:!0,tenants:o})}catch(e){console.error(\"Error al obtener inquilinos:\",e),a.status(500).json({success:!1,error:\"Error interno del servidor\"})}}),t.get(\"/api/tenants/:id\",b,async(s,a)=>{try{let e=espera p.getTenant(s.params.id);si(!e)devuelve a.status(404).json({éxito:!1,error:\"No se encontró el inquilino\"}); sea o=await be(e.id),c=await Se(e.id,e.monthlyQuota),d=await p.countAddressesByTenant(e.id),y=await p.countWebhooksByTenant(e.id),m=await p.countVirtualAccountsByTenant(e.id);a.json({éxito:!0, inquilino:{id:e.id, nombre:e.name, correo electrónico:e.email, nivel:e.tier, estado:e.status, nombreDeEmpresa:e.nombreDeEmpresa, sitio web:e.website, correo electrónicoDeFacturación:e.correoElectrónicoDeFacturación, prefijoDeClaveAPI:e.prefijoDeClaveAPI, límites:{cadenas:e.cadenaspermitidas, direccionesmáximas:e.direccionesmáximas, webhooksmáx:e.webhooksmáx, cuentasvirtualesmáx:e.accesoVirtual recuentos, rateLimit:e.rateLimit, monthlyQuota:e.monthlyQuota}, uso:{direcciones:d, webhooks:y, cuentas virtuales:m, solicitudes:o.totalRequests, unidades:Math.floor(o.totalUnits), costoUsd:o.costUsd.toFixed(4), cuota:{usado:c.usado, restante:c.restante, porcentajeUsado:Math.round(c.porcentajeUsado)}}, creadoEn:e.creadoEn, actualizadoEn:e.actualizadoEn}})}catch(e){console.error(\"Obtener Error de inquilino:\",e),a.status(500).json({éxito:!1,error:\"Error interno del servidor\"})}}),t.patch(\"/api/tenants/:id\",b,async(s,a)=>{try{if(s.tenant.id!==s.params.id)return a.status(403).json({éxito:!1,error:\"Solo puede actualizar su propia cuenta\",requestId:s.requestId});let e=s.body,o=[\"nombre\",\"nombreDeEmpresa\",\"sitio web\",\"correo electrónico de facturación\"],c={};for(let y of o)e[y]!==void 0&&(c[y]=e[y]);if(Object.keys(c).length===0)return a.status(400).json({éxito:!1,error:\"No hay campos válidos para actualizar\",requestId:s.requestId});let d=await p.updateTenant(s.params.id,c);if(!d)return a.status(404).json({éxito:!1,error:\"No se encontró el inquilino\"});await p.createAuditLog({tenantId:d.id,acción:\"inquilino.actualizado\",resource:\"inquilino\",resourceId:d.id,cambios:c,ipAddress:s.ip}),a.json({éxito:!0,inquilino:d,requestId:s.requestId})}catch(e){console.error(\"Actualizar inquilino error:\",e),a.status(500).json({éxito:!1,error:\"Error interno del servidor\"})}}),t.post(\"/api/tenants/:id/rotate-key\",b,async(s,a)=>{try{let e=await p.getTenant(s.params.id);if(!e)return a.status(404).json({éxito:!1,error:\"No se encontró el inquilino\"});if(s.tenant.id!==e.id)return a.status(403).json({éxito:!1,error:\"Solo puede rotar su propia clave API\",requestId:s.requestId});let{key:o,prefix:c,hash:d}=Ie();await p.updateTenant(e.id,{apiKeyPrefix:c,apiKeyHash:d}),await p.createAuditLog({tenantId:e.id,action:\"apikey.rotated\",resource:\"tenant\",resourceId:e.id,changes:{rotated:!0}}),a.json({success:!0,apiKey:o,warning:\"Guarde su nueva clave API. La clave anterior ya no es válida y no se puede recuperar.\",requestId:s.requestId})}catch(e){console.error(\"Error al rotar la clave API:\",e),a.status(500).json({success:!1,error:\"Servidor interno error\"})}}),t.patch(\"/api/admin/tenants/:id\",$,async(s,a)=>{try{let e=s.body;if(e.tier){let c=H[e.tier];c&&(e.allowedChains=c.chains,e.maxAddresses=c.maxAddresses,e.maxWebhooks=c.maxWebhooks,e.maxVirtualAccounts=c.maxVirtualAccounts,e.rateLimit=c.rateLimit,e.monthlyQuota=c.monthlyQuota)}let o=await p.updateTenant(s.params.id,e);if(!o)return a.status(404).json({éxito:!1,error:\"No se encontró el inquilino\"});await p.createAuditLog({Id.inquilino:o.id,acción:\"admin.tenant.updated\",recurso:\"inquilino\",Id.recurso:o.id,cambios:e,direcciónIP:s.ip}),a.json({éxito:!0,inquilino:o,Id.solicitud:s.Id.solicitud})}catch(e){console.error(\"El administrador actualiza el inquilino error:\",e),a.status(500).json({éxito:!1,error:\"Error interno del servidor\"})}}),t.post(\"/api/admin/tenants/:id/suspend\",$,async(s,a)=>{try{let e=await p.updateTenant(s.params.id,{status:\"suspendido\"});if(!e)return a.status(404).json({éxito:!1,error:\"Inquilino no encontrado\"});await p.createAuditLog({tenantId:e.id,action:\"admin.tenant.suspended\",resource:\"tenant\",resourceId:e.id,changes:{status:\"suspended\"},ipAddress:s.ip}),a.json({success:!0,message:\"Inquilino suspendido\",requestId:s.requestId})}catch(e){console.error(\"Error de suspensión del inqui
{"mensaje":"","atributos":{"nivel":"información"},"marca de tiempo":"2025-11-30T18:34:50.698762315Z"}
{"mensaje":"> rest-express@1.0.0 inicio","atributos":{"nivel":"información"},"marca de tiempo":"2025-11-30T18:34:50.698767865Z"}
{"mensaje":"> NODE_ENV=nodo de producción dist/index.js","atributos":{"nivel":"información"},"marca de tiempo":"2025-11-30T18:34:50.698774233Z"}
{"mensaje":"","atributos":{"nivel":"información"},"marca de tiempo":"2025-11-30T18:34:50.698781044Z"}
{"mensaje":"archivo:///app/dist/index.js:1","atributos":{"nivel":"error"},"marca de tiempo":"2025-11-30T18:34:50.958944546Z"}
{"mensaje":"var mt=Object.defineProperty;var fe=(n,t)=>()=>(n&&(t=n(n=0)),t);var xe=(n,t)=>{para(var r en t)mt(n,r,{obtener:t[r],enumerable:!0})};var J={};xe(J,{EnumeraciónDeCadena:()=>ft,PRECIOS:()=>le,CADENAS_SOPORTADAS:()=>me,EnumeraciónDeEstado:()=>yt,LÍMITES_DE_NIVEL:()=>H,EnumeraciónDeNivel:()=>gt,EVENTOS_DE_WEBHOOK:()=>Be,direcciones:()=>S,UsoDeAPI:()=>W,RegistrosDeAuditoría:()=>te,AgregacionesDeFacturación:()=>Q,CriptoTransacciones:()=>de,ConfiguraciónDeGas:()=>X,InsertarEsquemaDeDirección:()=>vt,InsertarEsquemaDeUsoDeAPI:()=>_t,InsertarLoCursoDeAuditoría gSchema:()=>xt,insertarEsquemaDeTransacciónCriptográfica:()=>At,insertarEsquemaDeMonederoMaestro:()=>It,insertarEsquemaDeInquilino:()=>bt,insertarEsquemaDeTransacción:()=>kt,insertarEsquemaDeCuentaVirtual:()=>wt,insertarEsquemaDeWebhook:()=>Tt,MonederosMaestros:()=>z,inquilinos:()=>x,RelacionesDeInquilinos:()=>ht,transacciones:()=>j,CuentasVirtuales:()=>_,webhooks:()=>K});import{sql como M}de\"drizzle-orm\";import{pgTable como q,texto como l,varchar como T,entero como E,booleano como Ve,marca de tiempo como R,jsonb como F,real como he,índice como v}de\"drizzle-orm/pg-core\";import{createInsertSchema como Y}de\"drizzle-zod\";import{z como Ke}de\"zod\";import{relaciones como pt}de\"drizzle-orm\";var gt,yt,ft,x,z,_,de,X,S,j,K,W,Q,te,ht,It,wt,At,bt,vt,kt,Tt,_t,xt,H,le,Be,me,D=fe(()=>{\"use estricto\";gt=Ke.enum([\"inicial\",\"escala\",\"empresa\"]),yt=Ke.enum([\"activo\",\"suspendido\",\"eliminado\"]),ft=Ke.enum([\"bitcoin\",\"ethereum\",\"solana\",\"polígono\",\"tron\",\"bsc\",\"ondulación\",\"cardano\",\"cerca\",\"polkadot\",\"avalancha\",\"arbitrum\",\"optimismo\",\"base\",\"fantom\",\"cronos\",\"cosmos\",\"algorand\"]),x=q(\"inquilinos\",{id:T(\"id\",{length:36}).primaryKey().default(M`gen_rand om_uuid()`), nombre: l(\"nombre\").notNull(), correo electrónico: l(\"correo electrónico\").notNull().único(), nivel: l(\"nivel\").notNull().predeterminado(\"inicial\"), estado: l(\"estado\").notNull().predeterminado(\"activo\"), apiKeyPrefix: T(\"api_key_prefix\",{longitud: 16}).notNull(), apiKeyHash: l(\"api_key_hash\").notNull().único(), hmacSecret: l(\"hmac_secret\").notNull(), allowedChains: l(\"allowed_chains\").array().notNull().predeterminado(M`ARRAY['bitcoin', 'ethereum', 'solana']`), direcciones máximas: E(\"direcciones máximas\").notNull().default(50), webhooks máximos: E(\"webhooks máximos\").notNull().default(1), cuentas virtuales máximas: E(\"cuentas virtuales máximas\").notNull().default(0), límite de tasa: E(\"límite de tasa\").notNull().default(10), cuota mensual: E(\"cuota mensual\").notNull().default(1e4), correo electrónico de facturación: l(\"correo electrónico de facturación\"), nombre de la empresa:l(\"nombre_de_la_empresa\"),sitio_web:l(\"sitio_web\"),lista_blanca_de_ip:l(\"lista_blanca_de_ip\").array(),metadatos:F(\"metadatos\"),createdAt:R(\"created_at\").defaultNow().notNull(),updatedAt:R(\"updated_at\").defaultNow().notNull()},n=>[v(\"id_de_correo_electrónico_de_inquilinos\").on(n.email),v(\"id_hash_de_clave_de_API_de_inquilinos\").on(n.apiKeyHa sh),v(\"idx_estado_inquilinos\").on(n.estado)]),z=q(\"monederos_principales\",{id:T(\"id\",{longitud:36}).clave_primaria().predeterminado(M`gen_random_uuid()`),escenario:l(\"escenario\").notNull(),cadena_de_bloques:l(\"cadena_de_bloques\").notNull(),tipo_de_activo:l(\"tipo_de_activo\").notNull(),nombre_de_activo:l(\"nombre_de_activo\").notNull(),dirección:l( \"dirección\").notNull().unique(),clavepública:l(\"clave pública\"),claveprivadacifrada:l(\"clave privada cifrada\"),claveprivadaIV:T(\"clave privadaIV\",{longitud:32}),etiquetadeautenticacióndeclaveprivada:T(\"etiquetadeautenticacióndeclaveprivada\",{longitud:32}),direccióndecontratointeligente:l(\"direccióndecontratointeligente\"),decimalesdetoken:E(\"decimalesdetoken \"),assignedToTenantId:T(\"id_asignado_al_inquilino\",{length:36}).references(()=>x.id),balance:l(\"saldo\").default(\"0\"),balanceUsd:l(\"saldo_usd\").default(\"0\"),lastSyncTime:R(\"última_sincronización\"),gasMarkupPercentage:E(\"porcentaje_de_margen_de_gas\").default(40),status:l(\"estado\").notNull().de fallo(\"activo\"), metadatos: F(\"metadatos\"), creado en: R(\"creado_en\"). predeterminadoAhora(). no nulo(), actualizado en: R(\"actualizado_en\"). predeterminadoAhora(). no nulo()}, n => [v(\"masters_blockchain_idx\"). en(n. cadena de bloques), v(\"masters_asset_idx\"). en(n. nombre_activo), v(\"masters_address_idx\"). en(n. dirección), v(\"masters_inquilino _idx\").on(n.assignedToTenantId),v(\"masters_scenario_idx\").on(n.scenario)]),_=q(\"cuentas_virtuales\",{id:T(\"id\",{longitud:36}).primaryKey().default(M`gen_random_uuid()`),tenantId:T(\"tenant_id\",{longitud:36}).notNull().references(()=>x.id,{onDelete:\"cascade\"}),accountType:l(\"tipo_de_cuenta\").n otNull(),saldos:F(\"saldos\").predeterminado(M`'{}'`),estado:l(\"estado\").notNull().predeterminado(\"activo\"),congelado:Ve(\"congelado\").predeterminado(!1),metadatos:F(\"metadatos\"),createdAt:R(\"creado_en\").defaultNow().notNull(),updatedAt:R(\"actualizado_en\").defaultNow().notNull()},n=>[v(\"inquilino_de_cuentas_virtuales_i dx\").on(n.Id_de_inquilino),v(\"id_de_estado_de_cuentas_virtualesx\").on(n.estado)]),de=q(\"transacciones_criptográficas\",{id:T(\"id\",{longitud:36}).clave_primaria().predeterminado(M`gen_random_uuid()`),Id_de_inquilino:T(\"id_de_inquilino\",{longitud:36}).notNull().referencias(()=>x.id,{onDelete:\"cascada\"}),tipo:l(\"tipo\").notNull(),escenario:l(\"escenario\").notNull(),fromAccountId:T(\"from_account_id\",{longitud:36}),toAccountId:T(\"to_count_id\",{longitud:36}),toExternalAddress:l(\"to_external_address\"),fromExternalAddress:l(\"from_external_address\"),assetType:l(\"tipo_de_activo\").notNull(),assetName:l(\"nombre_de_activo\").notNull(),blockchain:l(\"blockchain\").notNull(),amount:l(\"mount\"). notNull(),gasReal:l(\"gas_real\"),gasMarkupPercent:E(\"gas_markup_percent\"),gasCharged:l(\"gas_charged\"),commissionAmount:l(\"commission_mont\"),commissionUsd:l(\"comission_usd\"),status:l(\"status\").notNull().default(\"pending\"),txHash:l(\"tx_hash\").unique(),blockNumber:E(\"block_number\"),confirmations:E(\"confirmations\"),metadata:F(\"me tadata\"), creado en: R(\"creado_en\"). predeterminadoAhora(). no nulo(), ejecutado en: R(\"ejecutado_en\"), confirmado en: R(\"confirmado_en\")}, n => [v(\"idx_de_inquilino_de_transacción_criptográfica\"). en(n. id_de_inquilino), v(\"idx_de_tipo_de_transacción_criptográfica\"). en(n. tipo), v(\"idx_de_estado_de_transacción_criptográfica\"). en(n. estado), v(\"idx_hash_de_transacción_criptográfica\"). en(n. hash_de_transacción), v(\"idx_de_escenario_de_transacción_criptográfica\"). en(n. escenario)]), X = q(\"setti_gas ngs\",{id:T(\"id\",{longitud:36}).primaryKey().default(M`gen_random_uuid()`),marcadopredeterminadoglobal:E(\"marcadopredeterminadoglobal\").default(40),marcadomín:E(\"marcadomín\").default(10),marcadomáx:E(\"marcadomáx\").default(100),anulacionesdecliente:F(\"anulacionesdecliente\").default(M`'{}'`),multiplicadoresdecadenadebloques:F(\"multiplicadoresdecadenadebloques\").default(M`'{\"ethereum\": 1.0, \"polígono\": 0.3}'`),Anulaciones de tipo de transacción:F(\"anulaciones de tipo de transacción\").predeterminado(M`'{\"retiro_cripto\": 40, \"transferencia_de_token\": 45}'`),updatedAt:R(\"updated_at\").defaultNow().notNull(),updatedBy:l(\"updated_by\")},n=>[v(\"gas_settings_updated_idx\").on(n.updatedAt)]),S=q(\"direcciones\",{id:T(\"id\",{longitud:36}).primaryKey().default(M`gen_random_uuid()`),tenantId:T(\"tenant_id\",{longitud:36}).notNull().references(()=>x.id,{onDelete:\"cascade\"}),chain:l(\"cadena\").notNull(),currency:l(\"currency\").notNull(),address: l(\"dirección\").notNull(),publicKey:l(\"clave_pública\"),derivationPath:l(\"ruta_derivación\"),label:l(\"etiqueta\"),tags:l(\"etiquetas\").array().default(M`ARRAY[]::text[]`),status:l(\"estado\").notNull().default(\"activo\"),balance:l(\"balance\").default(\"0\"),balanceUsd:l(\"balance_usd\").default(\"0\"),lastSynced:R(\"last_synced\"),webhookUrl:l(\"webhook_url\"),metadatos:F(\"metadatos\"),createdAt:R(\"creado_en\").defaultNow().notNull(),actualizadoEn:R(\"actualizado_en\").defaultNow().notNull(),eliminadoEn:R(\"eliminado_en\")},n=>[v(\"direcciones_idx_de_inquilino\").on(n.Id_de_inquilino),v(\"direcciones_idx_de_cadena\").on(n.cadena),v(\"direcciones_idx_de_estado\").on(n.estado),v(\"direcciones_idx_de_dirección\").on(n.dirección)] ),j=q(\"transacciones\",{id:T(\"id\",{longitud:36}).primaryKey().default(M`gen_random_uuid()`),tenantId:T(\"id_tenant\",{longitud:36}).notNull().references(()=>x.id,{onDelete:\"cascade\"}),txHash:l(\"tx_hash\").notNull(),chain:l(\"cadena\").notNull(),fromAddress:l(\"from_address\"),toAddress:l(\"t o_dirección\"), importe: l(\"importe\").notNull(), moneda: l(\"moneda\").notNull(), cuota: l(\"cuota\"), cuotaUsd: l(\"cuota_usd\"), estado: l(\"estado\").notNull().default(\"pendiente\"), tipo: l(\"tipo\").notNull().default(\"nativo\"), númerodebloque: E(\"númerodebloque\"), confirmaciones: E(\"confirmaciones\").default(0 ), metadatos: F(\"metadatos\"), creado en: R(\"creado_en\"). predeterminado ahora(). no nulo()}, n => [v(\"idx_de_inquilino_de_transacciones\"). en(n. ID_de_inquilino), v(\"idx_de_cadena_de_transacciones\"). en(n. cadena), v(\"idx_de_hash_de_transacciones\"). en(n. Hash_de_tx), v(\"idx_de_estado_de_transacciones\"). en(n. estado)]), K = q(\"webhooks\", {id: T(\"id\", {le longitud: 36}). claveprimaria(). predeterminado(M`gen_random_uuid()`), ID_inquilino: T(\"ID_inquilino\",{longitud: 36}). no nulo(). referencias(()=>x.id,{onDelete:\"cascada\"}), URL: l(\"URL\"). no nulo(), eventos: l(\"eventos\"). matriz(). no nulo(), secreto_hmac: l(\"secreto_hmac\"). no nulo(), activo: Ve(\"activo\"). predeterminado(!0), reintentarCou nt:E(\"retry_count\").default(0),lastTriggered:R(\"last_triggered\"),lastStatus:E(\"last_status\"),metadatos:F(\"metadatos\"),createdAt:R(\"created_at\").defaultNow().notNull()},n=>[v(\"webhooks_tenant_idx\").on(n.tenantId),v(\"webhooks_active_idx\").on(n.active)]),W=q(\"api_usage\",{id:T(\"id \",{longitud:36}).primaryKey().default(M`gen_random_uuid()`),tenantId:T(\"tenant_id\",{longitud:36}).notNull().references(()=>x.id,{onDelete:\"cascade\"}),endpoint:l(\"endpoint\").notNull(),method:l(\"method\").notNull(),chain:l(\"chain\"),action:l(\"action\").notNull(),units:he(\"units\").notN ull(), créditos:he(\"créditos\").notNull(), código de estado:E(\"código de estado\").notNull(), id de solicitud:T(\"id de solicitud\",{longitud:36}).notNull(), tiempo de respuesta Ms:E(\"ms de tiempo de respuesta\"), metadatos:F(\"metadatos\"), marca de tiempo:R(\"marca de tiempo\").defaultNow().notNull()}, n=>[v(\"id de inquilino de uso de API\").on(n.id de inquilino),v(\"api_usage_timestamp_idx\").on(n.timestamp),v(\"api_usage_action_idx\").on(n.action)]),Q=q(\"agregaciones_de_facturación\",{id:T(\"id\",{longitud:36}).primaryKey().default(M`gen_random_uuid()`),tenantId:T(\"id_de_teniente\",{longitud:36}).notNull().references(()=>x.id,{onDelete:\"cascade\"}),periodo:l(\"periodo\").notNull(),periodType:l(\"tipo_de_periodo\").notNull().default(\"diario\"),totalUnits:he(\"unidades_totales\").notNull().def ault(0), totalCredits:he(\"total_créditos\").notNull().default(0), costUsd:he(\"costo_usd\").notNull().default(0), breakdown:F(\"break\"), createdAt:R(\"created_at\").defaultNow().notNull()}, n=>[v(\"billing_tenant_period_idx\").on(n.tenantId,n.period)]), te=q(\"audit_logs\",{id:T(\"id\",{length:36}).primaryKey().default(M`gen_random_uuid()`), tenantId:T(\"tenant_id\",{length:36}).references(()=>x.id,{onDelete:\"set null\"}),ID_usuario:l(\"id_usuario\"),acción:l(\"acción\").notNull(),recurso:l(\"recurso\").notNull(),ID_recurso:l(\"id_recurso\"),cambios:F(\"cambios\"),Dirección_IP:l(\"dirección_IP\"),Agente_usuario:l(\"agente_usuario\"),ID_solicitud:T(\"id_solicitud\",{longitud:36}),marca_de_tiempo:R(\"marca_de_tiempo\").defaultNow().notNull()},n=>[v(\"audit_logs_tenant_idx\").on(n.Id_tenant),v(\"audit_logs_timestamp_idx\").on(n.marca_de_tiempo),v(\"audit _logs_action_idx\").on(n.action)]),ht=pt(x,({muchos:n})=>({direcciones:n(S),transacciones:n(j),webhooks:n(K),cuentasvirtuales:n(_),apiUsage:n(W),agregacionesdefacturación:n(Q),registrosdeauditoría:n(te),monederosprincipales:n(z),criptotransacciones:n(de)})),It=Y(z).omit({id:!0,createdAt:!0,updatedAt:!0}),wt=Y(_).omit({id:!0,createdAt:!0,updatedAt:!0}),At=Y(de).omit({id:!0,createdAt:!0,executedAt:!0,confirmedAt:!0}),bt=Y(x).omit({ id:!0,createdAt:!0,updatedAt:!0}),vt=Y(S).omit({id:!0,createdAt:!0,updatedAt:!0,deletedAt:!0}),kt=Y(j).omit({id:!0,createdAt:!0}),Tt=Y(K).omit({id:!0,createdAt:!0}),_t=Y(W).omit({id:!0,timestamp:!0}),xt=Y(te).omit({id:!0,timestamp:!0}),H={starter:{chains:[\"bitcoin\",\"ethereum\",\"solana\"],maxAddresses:50,maxWebhooks:1,maxVirtualAccounts:0,rateLimit:10,monthlyQuota:1e4,kmsAllowed:!1,archivalAccess :!1, días de retención: 1}, escala: {cadenas: [\"bitcoin\",\"ethereum\",\"solana\",\"polígono\",\"tron\",\"bsc\",\"ripple\",\"cardano\"], direcciones máximas: 1e3, webhooks máximos: 10, cuentas virtuales máximas: 5, límite de tasa: 100, cuota mensual: 1e5, km permitidos:!0, acceso de archivo:!1, días de retención: 7}, empresa: {cadenas: [\"bitcoin\",\"ethereum\",\"solana\",\"polígono\",\"tron\",\"bsc\",\"ripple\",\"cardano\",\"near\",\"polkadot\",\"avalancha\",\"arbitro\",\"optimismo\",\"base\",\"fantasma\",\"cronos\",\"cosmos\",\"algorand\"],máximo de direcciones: -1,máximo de webhooks: -1,máximo de cuentas virtuales: 50,límite de tasa: 1e3,cuota mensual: -1,km permitidos: !0,acceso de archivo: !0,días de retención: 30}},le={creación de dirección:{unidades: 1,costo: 0,001},consulta de saldo:{unidades: 0,costo: 5e-4},saldo de token:{unidades: 1,costo: 0,001},metadatos nft:{unidades: 2,costo: 0,002},tx_br oadcast_btc:{unidades: 50, costo: 0,05}, tx_broadcast_eth:{unidades: 10, costo: 0,01}, tx_broadcast_other:{unidades: 10, costo: 0,01}, tx_history:{unidades: 2, costo: 0,002}, webhook_subscription:{unidades: 0,02, costo: 0,02}, va_create:{unidades: 100, costo: 0,1}, va_transfer:{unidades: 5, costo: 0,005}, tipo de cambio:{unidades: 0,1, costo: 1e-4}, web3_resolve:{unidades: 1, costo: 0,001}, malicioso_check:{unidades: 2, costo: 0,002}, rpc_standard:{u nits:2,costo:2e-4},rpc_eth_call:{unidades:5,costo:5e-4},rpc_debug:{unidades:50,costo:.005}},Be=[\"TRANSACCIÓN_DIRECCIÓN\",\"SALDO_DIRECCIÓN\",\"TRANSACCIÓN_NATIVA_ENTRANTE\",\"TRANSACCIÓN_NATIVA_SALIENTE\",\"TRANSACCIÓN_FUNGIBLE_ENTRANTE\",\"TRANSACCIÓN_FUNGIBLE_SALIENTE\",\"TRANSACCIÓN_NFT_ENTRANTE\",\"TRANSACCIÓN_NFT_SALIENTE\",\"TRANSACCIÓN_MULTITOKEN_ENTRANTE\",\"TRANSACCIÓN_MULTITOKEN_SALIENTE\",\"TRANSACCIÓN_FALLIDA\",\"CUOTA_PAGADA\",\"REGISTRO_DE_CONTRATO _EVENTO\"],me=[{id:\"bitcoin\",nombre:\"Bitcoin\",símbolo:\"BTC\",icono:\"\\u20BF\"},{id:\"ethereum\",nombre:\"Ethereum\",símbolo:\"ETH\",icono:\"\\u039E\"},{id:\"solana\",nombre:\"Solana\",símbolo:\"SOL\",icono:\"\\u25CE\"},{id:\"polígono\",nombre:\"Polígono\",símbolo:\"MATIC\",icono:\"\\u2B21\"},{id:\"tron\",nombre:\"Tron\",símbolo:\"TRX\",icono:\"\\u2666\"},{id:\"bsc\",nombre:\"BNB Cadena\", símbolo:\"BNB\", icono:\"\\u25C6\"},{id:\"ripple\", nombre:\"XRP Ledger\", símbolo:\"XRP\", icono:\"\\u2715\"},{id:\"cardano\", nombre:\"Cardano\", símbolo:\"ADA\", icono:\"\\u20B3\"},{id:\"near\", nombre:\"NEAR\", símbolo:\"NEAR\", icono:\"\\u24C3\"},{id:\"polkadot\", nombre:\"Polkadot\", símbolo:\"DOT\", icono:\"\\u25CF\"},{id:\"avalanche\", nombre:\"Avalanche\", símbolo:\"AVAX\", icono:\"\\u25B2\"},{id:\"arb itrum\", nombre:\"Arbitrum\", símbolo:\"ARB\", icono:\"\\u25C8\"},{id:\"optimism\", nombre:\"Optimism\", símbolo:\"OP\", icono:\"\\u2295\"},{id:\"base\", nombre:\"Base\", símbolo:\"ETH\", icono:\"\\u25EF\"},{id:\"fantom\", nombre:\"Fantom\", símbolo:\"FTM\", icono:\"\\u25C7\"},{id:\"cronos\", nombre:\"Cronos\", símbolo:\"CRO\", icono:\"\\u25CE\"},{id:\"cosmos\",nombre:\"Cosmos\",símbolo:\"ATOM\",icono:\"\\u269B\"},{id:\"algorand\",nombre:\"Algorand\",símbolo:\"ALGO\",icono:\"\\u24B6\"}]});var oe={};xe(oe,{db:()=>f,pool:()=>Ye});import{Pool como St,neonConfig como Pt}desde\"@neondatabase/serverless\";import{drizzle como Rt}desde\"drizzle-orm/neon-serverless\";import Et desde\"ws\";var Ye,f,V=fe(()=>{\"use strict\";D();Pt.webSocketConstructor=Et;if(!process.env.DATABASE_URL)throw new Error(\"DATABASE_URL debe ser ¿Olvidaste aprovisionar una base de datos?\"); Ye=new St({connectionString:process.env.DATABASE_URL}), f=Rt({client:Ye,schema:J})}); function jt(n){return!n||typeof n!=\"string\"||n.length<32?!1:/^[a-zA-Z0-9_-]{32,}$/.test(n)} function Bt(){return P.state===\"open\"?Date.now()-P.lastFailure>=$e.resetTimeoutMs?(P.state=\"half-open\",P.successesInHalfOpen=0,!0):!1:!0} function Dt(){P.estado===\"semiabierto\"?(P.éxitosEnMedioApertura++,P.éxitosEnMedioApertura>=$e.umbralDeÉxitoDeAperturaMedia&&(P.estado=\"cerrado\",P.fallos=0)):P.fallos=0}función ze(){P.fallos++,P.últimoFallo=Fecha.ahora(),(P.estado===\"semiabierto\"||P.fallos>=$e.umbralDeFallo)&&(P.estado=\"abierto\")}función Ut(n,t){devolver t.EstadosReintentables.includes(n)}función Xe(n,t){devolver Math.min(t.baseDelayMs*Math.pow(2,n)+Math.random()*1e3,t.maxDelayMs)}función asíncrona Qe(n){devuelve nueva Promesa(t=>setTimeout(t,n))}función asíncrona N(n,t={},r=Kt){si(!Bt())devuelve{éxito:!1,error:\"Servicio temporalmente no disponible (disyuntor abierto)\",statusCode:503};let i=null;for(let u=0;u<=r.maxRetries;u++)try{let g=new AbortController,h=setTimeout(()=>g.abort(),3e4),s=await fetch(`${Mt}${n}`,{...t,señal:g.señal,encabezados:{\"Tipo-Contenido\":\"aplicación/json\",\"clave-x-api\":Fe||\"\",...t.encabezados}});clearTimeout(h);let a=await s.json().catch(()=>null);if(!s.ok){let e={éxito:!1,error:a?.mensaje||a?.error||`HTTP ${s.estado}`,código-estado:s.estado};if(s.estado===429){let o=s.headers.get(\"Retry-After\");o&&(e.retryAfter=parseInt(o,10)*1e3)}if(Ut(s.status,r)&&u<r.maxRetries){i=e;let o=e.retryAfter||Xe(u,r);await Qe(o);continue}return ze(),e}return Dt(),{éxito:!0,datos:a}}catch(g){let h=g.name===\"Error de cancelación\",s=g.message?.includes(\"obtener\")||g.message?.includes(\"red\"),a={éxito:!1,error:h?\"Tiempo de espera de la solicitud\":g.message||\"Red error\",statusCode:h?408:500};if((h||s)&&u<r.maxRetries){i=a,await Qe(Xe(u,r));continue}return ze(),a}return i||{éxito:!1,error:\"Se excedió el máximo de reintentos\",statusCode:500}}function Je(n){return me.find(t=>t.id===n)}var Mt,Fe,Kt,P,$e,se,B,Oe=fe(()=>{\"use strict\";D();Mt=process.env.TATUM_API_URL||\"https://api.tatum.io\",Fe=process.env.TATUM_API_KEY;Fe?jt(Fe)||console.warn(\"El formato de TATUM_API_KEY parece no ser válido; puede causar errores de API\"):console.warn(\"TATUM_API_KEY no configurado; las llamadas a la API fail\"); Kt={máx.Reintentos:3,Ms.deRetardoBase:1e3,Ms.deRetardoMax:3e4,EstadosReintentables:[408,429,500,502,503,504]}, P={fallos:0,últimoFallo:0,estado:\"cerrado\",éxitosEnMedioApertura:0}, $e={UmbralDeFallo:5,Ms.deRestablecimientoTiempoDeEspera:6e4,UmbralDeÉxitoEnMedioApertura:2}; se={bitcoin:\"bitcoin\",ethereum:\"ethereum\",solana:\"solana\",polygon:\"polígono\",tron:\"tron\",bsc:\"bsc\",ri pple:\"xrp\",cardano:\"ada\",near:\"near\",polkadot:\"dot\",avalanche:\"avax\",arbitrum:\"arbitrum-one\",optimismo:\"optimismo\",base:\"base\",fantom:\"fantom\",cronos:\"cro\",c osmos:\"atom\",algorand:\"algo\"},B={getCircuitBreakerState(){return{...P}},resetCircuitBreaker(){P.failures=0,P.lastFailure=0,P.state=\"closed\",P.successesInHalfOpen=0},async generateAddress(n){let t=se[n]||n;return N(`/v3/${t}/wallet`,{método:\"GET\"})},async getBalance(n,t){let r=se[n]||n;return[\"ethereum\",\"polígono\",\"bsc\",\"arbitrum-one\",\"optimism\",\"base\"].includes(r)?N(`/v3/${r}/account/balance/${t}`):N(r===\"bitcoin\"?`/v3/bitcoin/address/balance/${t}`:r===\"solana\"?`/v3/solana/account/balance/${t}`:`/v3/${r}/account/balance/${t}`)},async getTokens(n,t){let r=se[n]||n;devuelve N(`/v3/data/tokens?chain=${r}&addresses=${t}`)},asincrónico obtenerNFTs(n,t){let r=se[n]||n;devuelve N(`/v3/data/nfts?chain=${r}&addresses=${t}`)},asincrónico obtenerHistorialDeTransacciones(n,t,r){let i=se[n]||n,u=nuevosParámetrosDeBúsquedaDeURL;devuelve r?.TamañoDePágina&&u.set(\"TamañoDePágina\",r.TamañoDePágina.toString()),r?.Desplazamiento&&u.set(\"Desplazamiento\",r.Desplazamiento.toString()),N(`/v3/data/transacciones?chain=${i}&addresses=${t}&${u.toString()}`)},asincrónico getTransaction(n,t){let r=se[n]||n;devuelve N(`/v3/${r}/transaction/${t}`)},async estimateFee(n,t=\"TRANSFER\"){let r=se[n]||n;devuelve N(`/v3/${r}/gas/estimate`,{método:\"POST\",cuerpo:JSON.stringify({tipo:t})})},async broadcastTransaction(n,t){let r=se[n]||n;devuelve N(`/v3/${r}/broadcast`,{método:\"POST\",cuerpo:JSON.stringify({txData:t})})},async getExchangeRates(n){let t=n.join(\",\");devuelve N(`/v3/tatum/rate/${t}?basePair=USD`)}, asíncrono resolveWeb3Name(n){devuelve N(`/v3/blockchain/names/${n}`)}, asíncrono checkMaliciousAddress(n){devuelve N(`/v3/security/address/${n}`)}, asíncrono createWebhook(n){devuelve N(\"/v4/subscription\",{método:\"POST\",cuerpo:JSON.stringify(n)})}, asíncrono deleteWebhook(n){devuelve N(`/v4/subscription/${n}`,{método:\"DELETE\"})}, asíncrono getWebhooks(){devuelve N(\"/v4/subscription\")},async healthCheck(){let n=await N(\"/v3/tatum/version\"); return n.success?{success:!0, data:{status:\"healthy\", version:n.data?.version||\"v3\", circuitBreaker:{...P}}}:{...n, data:{status:\"degraded\", version:\"unknown\", circuitBreaker:{...P}}}}}});var ve={};xe(ve,{GasFeeManager:()=>Ee,gasFeeManager:()=>Le});import{eq as Ge}from\"drizzle-orm\";var Ee,Le,ge=fe(()=>{\"use strict\";V();D();Ee=class{config=null;async loadConfig(){let[t]=await f.select().from(X).limit(1);if(!t){let r={Margen predeterminado global: 40, Margen mínimo: 10, Margen máximo: 100, Anulaciones de cliente:{}, Multiplicadores de cadena de bloques:{ethereum: 1, polígono: .3, bitcoin: 1.2, solana: .1, arbitraje: .2}, Anulaciones de tipo de transacción:{retiro_cripto: 40, transferencia_de_token: 45, contrato_inteligente: 60}};return this.config=r,r}return this.config={globalDefaultMarkup:t.globalDefaultMarkup,minMarkup:t.minMarkup,maxMarkup:t.maxMarkup,clientOverrides:t.clientOverrides||{},blockchainMultipliers:t.blockchainMultipliers||{},transactionTypeOverrides:t.transactionTypeOverrides||{}},this.config}async calculateGasMarkup(t){this.config||await this.loadConfig();let r=this.config.globalDefaultMarkup;if(t.clientId&&this.config.clientOverrides[t.clientId]){let a=this.config.clientOverrides[t.clientId];if(a.expiresAt){let e=new Date(a.expiresAt);new Date<e&&(r=a.markup)}else r=a.markup}let i=this.config.transactionTypeOverrides[t.transactionType];i&&(r=i);let u=this.config.blockchainMultipliers[t.blockchain]||1;r=Math.round(r*u),r=Math.max(this.config.minMarkup,Math.min(this.config.maxMarkup,r));let g=t.gasReal*(r/100),h=t.gasReal+g,s=g;return{gasReal:t.gasReal,gasMarkupPercent:r,gasCharged:h,yourProfit:s}}async updateGlobalMarkup(t,r){t=Math.max(10,Math.min(100,t)),await f.update(X).set({globalDefaultMarkup:t,updatedAt:new Fecha,actualizadoPor:r}).donde(Ge(X.id,\"predeterminado\")),this.config=null,await this.loadConfig()}async setClientMarkup(t,r,i,u,g){this.config||await this.loadConfig();let h=this.config.clientOverrides;h[t]={markup:Math.max(10,Math.min(100,r)),reason:i,expiresAt:g?.toISOString()},await f.update(X).set({clientOverrides:h,actualizadoEn:new Fecha,actualizadoPor:u}).donde(Ge(X.id,\"predeterminado\")),this.config=null,await this.loadConfig()}async removeClientMarkup(t,r){this.config||await this.loadConfig();let i=this.config.clientOverrides;eliminar i[t],esperar f.update(X).set({clientOverrides:i,actualizadoEn:nueva Fecha,actualizadoPor:r}).where(Ge(X.id,\"predeterminado\")),this.config=null,esperar this.loadConfig()}getConfig(){devolver this.config}},Le=new Ee});var ke={};xe(ke,{CryptoGateway:()=>Ne,cryptoGateway:()=>Ht});importar Lt desde\"crypto\";importar{eq como G y como Wt} desde\"drizzle-orm\";var Ne,Ht,Te=fe(()=>{\"usar estricto\";Oe();ge();V();D();Ne=class{async createVirtualAccount(t,r){devolver(esperar f.insert(_).values({Id.inquilino:t,TipoDeCuenta:r,Saldos:JSON.stringify({})}).returning())[0]}async internalSwap(t){let r=await f.query.virtualAccounts.findFirst({where:G(_.id,t.fromAccountId)});if(!r)throw new Error(\"No se encontró la cuenta\");let i=JSON.parse(r.balances||\"{}\"),u=parseFloat(i[t.assetName]||\"0\");if(u<parseFloat(t.fromAmount))throw new Error(\"Saldo insuficiente\");let g=parseFloat(t.toAmount)*.005,h=parseFloat(t.toAmount)-g,s={...i};s[t.assetName]=(u-parseFloat(t.fromAmount)).toString(),await f.update(_).set({balances:JSON.stringify(s)}).where(G(_.id,t.fromAccountId));let a=espera f.consulta.cuentasvirtuales.findFirst({donde:G(_.id,t.toAccountId)}),e=JSON.parse(a?.balances||\"{}\");devuelve e[t.nombreDeActivo]=(parseFloat(e[t.nombreDeActivo]||\"0\")+h).toString(),espera f.update(_).set({balances:JSON.stringify(e)}).donde(G(_.id,t.toAccountId)),{txId:(espera f.insert(de).values({Id.inquilino:t.Id.inquilino,tipo:\"intercambio_interno\",escenario:t.scenario,Id.deCuenta:t.deCuenta,Id.deCuenta:t.deCuenta,Tipo.deActivo:\"cripto\",Nombre.deActivo:t.deActivo,cadena.de.blockchain:t.blockchain,importe:t.deImporte,importe.de.comisión:g.de.Cadena(),comisión.Usd:(g*45e3).de.Cadena(),estado:\"completado\"}).returning())[0].id,estado:\"completado\",deImporte:t.deImporte,de.Importe:t.de.Importe,comisión:g.de.Fijo(8),neto.Recibido:h.de.Fijo(8),ejecutadoEn:nuevaFecha().de.CadenaISO()}}asincrónico externalWithdraw(t){let r=await f.query.masterWallets.findFirst({where:Wt(G(z.assetName,t.assetName),G(z.blockchain,t.blockchain),G(z.scenario,t.scenario))});if(!r)throw new Error(`No se encontró la billetera maestra para ${t.assetName} en ${t.blockchain}`);let i=await B.estimateGas({blockchain:t.blockchain,assetType:t.assetName===r.smartContractAddress?\"token\":\"crypto\",amount:t.amount}),u=await Le.calculateGasMarkup({clientId:t.tenantId,blockchain:t.blockchain,transactionType:t.assetName===\"BTC\"?\"crypto_withdraw\":\"token_transfer\",gasReal:i.gasReal}),g=await f.query.virtualAccounts.findFirst({where:G(_.id,t.fromAccountId)}),h=JSON.parse(g?.balances||\"{}\"),s=parseFloat(h[t.assetName]||\"0\");if(s<parseFloat(t.amount))throw new Error(\"Saldo insuficiente\");h[t.assetName]=(s-parseFloat(t.amount)).toString(),await f.update(_).set({balances:JSON.stringify(h)}).where(G(_.id,t.fromAccountId));let a=`0x${Lt.randomBytes(32).toString(\"hex\")}`;return{txId:(await f.insert(de).values({Id.inquilino:t.inquilino,tipo:\"retiro_externo\",escenario:t.scenario,toExternalAddress:t.toExternalAddress,tipo.activo:\"cripto\",nombre.activo:t.nombre.activo,blockchain:t.blockchain,cantidad:t.cantidad,gasReal:u.gasReal.toString(),porcentaje.de.margen.gas:u.porcentaje.de.margen.gas,gasCargado :u.gasCharged.toString(),commissionAmount:u.yourProfit.toString(),status:\"pendiente\",txHash:a}).returning())[0].id,status:\"pendiente_de_confirmación\",txHash:a,amount:t.amount,gasReal:u.gasReal.toFixed(8),gasCharged:u.gasCharged.toFixed(8),yourProfit:u.yourProfit.toFixed(8),estimatedTime:\"12 segundos\"}}async assignMasterToClient(t,r,i){return await f.update(z).set({assignedToTenantId:r,gasMarkupPercentage:i}).where(G(z.id,t)),{success:!0,masterId:t,assignedTo:r,gasMarkup:i,assignedAt:new Date().toISOString()}}async getVirtualAccountBalance(t){let r=await f.query.virtualAccounts.findFirst({where:G(_.id,t)});if(!r)throw new Error(\"Cuenta no encontrada\");let i=JSON.parse(r.balances||\"{}\"); return{accountId:t,balances:i,totalUsd:Object.entries(i).reduce((u,[g,h])=>{let s={ETH:2500,BTC:45e3,GOLD:500,SILVER:250}; return u+parseFloat(h)*(s[g]||0)},0)}}},Ht=new Ne});import Ce de\"express\";import{z como w} de\"zod\";D();V();import{eq como A,and como Z,desc como ie,sql como De,gte como Nt,lte como Ct} de\"drizzle-orm\";var Ue=class{async getTenant(t){let[r]=await f.select().from(x).where(A(x.id,t));return r||void 0}async getTenantByApiKeyHash(t){let[r]=await f.select().from(x).where(A(x.apiKeyHash,t));return r||void 0}async getTenantByEmail(t){let[r]=await f.select().from(x).where(A(x.email,t));return r||void 0}async getAllTenants(){return f.select().from(x).orderBy(ie(x.createdAt))}async createTenant(t){let[r]=await f.insert(x).values(t).returning();return r}async updateTenant(t,r){let[i]=await f.update(x).set({...r,updatedAt:nueva fecha}).where(A(x.id,t)).returning();devolver i||void 0}async deleteTenant(t){await f.update(x).set({estado:\"eliminado\",updatedAt:nueva fecha}).where(A(x.id,t))}async getAddress(t){let[r]=await f.select().from(S).where(A(S.id,t));devolver r||void 0}async getAddressByAddress(t,r,i){let[u]=await f.select().from(S).where(Z(A(S.tenantId,t),A(S.chain,r),A(S.address,i)));devolver u||void 0}async getAddressesByTenant(t,r){let i=f.select().from(S).where(A(S.tenantId,t)),u=[A(S.tenantId,t)];devuelve r?.chain&&u.push(A(S.chain,r.chain)),r?.status&&u.push(A(S.status,r.status)),f.select().from(S).where(Z(...u)).orderBy(ie(S.createdAt)).limit(r?.limit||50).offset(r?.offset||0)}asincrónico countAddressesByTenant(t){let[r]=await f.select({count:De`count(*)`}).from(S).where(Z(A(S.tenantId,t),A(S.status,\"active\")));devuelve r?.count||0}asincrónico createAddress(t){let[r]=await f.insert(S).values(t).returning();return r}async updateAddress(t,r){let[i]=await f.update(S).set({...r,updatedAt:nueva fecha}).where(A(S.id,t)).returning();return i||void 0}async archiveAddress(t){await f.update(S).set({estado:\"archivado\",eliminadoAt:nueva fecha,updatedAt:nueva fecha}).where(A(S.id,t))}async getTransaction(t){let[r]=await f.select().from(j).where(A(j.id,t));return r||void 0}async getTransactionByHash(t,r){let[i]=await f.select().from(j).where(Z(A(j.chain,t),A(j.txHash,r)));return i||void 0}async getTransactionsByTenant(t,r){let i=[A(j.tenantId,t)];return r?.chain&&i.push(A(j.chain,r.chain)),r?.status&&i.push(A(j.status,r.status)),f.select().from(j).where(Z(...i)).orderBy(ie(j.createdAt)).limit(r?.limit||50).offset(r?.desplazamiento||0)}asincrónico createTransaction(t){let[r]=await f.insert(j).values(t).returning();devolver r}asincrónico updateTransaction(t,r){let[i]=await f.update(j).set(r).where(A(j.id,t)).returning();devolver i||void 0}asincrónico getWebhook(t){let[r]=await f.select().from(K).where(A(K.id,t));devolver r||void 0}asincrónico getWebhooksByTenant(t){devolver f.select().from(K).where(A(K.tenantId,t)).orderBy(ie(K.createdAt))}asincrónico countWebhooksByTenant(t){let[r]=await f.select({count:De`count(*)`}).from(K).where(Z(A(K.tenantId,t),A(K.active,!0)));devuelve r?.count||0}asinc createWebhook(t){let[r]=await f.insert(K).values(t).returning();devuelve r}asinc updateWebhook(t,r){let[i]=await f.update(K).set(r).where(A(K.id,t)).returning();devuelve i||void 0}asinc deleteWebhook(t){await f.delete(K).where(A(K.id,t))}asinc getVirtualAccount(t){let[r]=await f.select().from(_).where(A(_.id,t));devuelve r||void 0}asinc obtenerCuentasVirtualesPorInquilino(t){devolver f.seleccionar().de(_).donde(A(_.IdInquilino,t)).ordenarPor(ie(_.createdAt))}asincrónico contarCuentasVirtualesPorInquilino(t){let[r]=await f.seleccionar({count:De`count(*)`}).de(_).donde(Z(A(_.IdInquilino,t),A(_.estado,\"activo\")));devolver r?.count||0}asincrónico crearCuentaVirtual(t){let[r]=await f.insertar(_).valores(t).devolver();devolver r}asincrónico actualizarCuentaVirtual(t,r){let[i]=await f.actualizar(_).set(r).donde(A(_.id,t)).devolver();devolver i||void 0}asincrónico recordApiUsage(t){let[r]=await f.insert(W).values(t).returning();return r}async getApiUsageByTenant(t,r,i){return f.select().from(W).where(Z(A(W.tenantId,t),Nt(W.timestamp,r),Ct(W.timestamp,i))).orderBy(ie(W.timestamp))}async getApiUsageStats(t,r,i){let u=await this.getApiUsageByTenant(t,r,i),g={},h={},s=0,a=0;for(let e of u)s+=e.unidades,a+=e.créditos,g[e.punto final]=(g[e.punto final]||0)+1,e.cadena&&(h[e.cadena]=(h[e.cadena]||0)+1);return{totalRequests:u.length,totalUnits:s,totalCredits:a,byEndpoint:g,byChain:h}}async getBillingAggregation(t,r){let[i]=await f.select().from(Q).where(Z(A(Q.tenantId,t),A(Q.periodo,r)));return i||void 0}async upsertBillingAggregation(t){let r=await this.getBillingAggregation(t.tenantId,t.periodo);if(r){let[i]=await f.update(Q).set(t).where(A(Q.id,r.id)).returning();return i}else{let[i]=await f.insert(Q).values(t).returning();return i}}async createAuditLog(t){let[r]=await f.insert(te).values(t).returning();return r}async getAuditLogsByTenant(t,r=100){return f.select().from(te).where(A(te.tenantId,t)).orderBy(ie(te.timestamp)).limit(r)}},p=new Ue;Oe();import ce from\"crypto\";D();var Ze=process.env.ADMIN_API_KEY;function Ie(){let n=`tatum_${ce.randomBytes(28).toString(\"hex\")}`,t=n.substring(0,16),r=tt(n);devolver{clave:n,prefijo:t,hash:r}}función tt(n){devolver ce.createHash(\"sha256\").update(n).digest(\"hex\")}función we(){devolver ce.randomBytes(32).toString(\"hex\")}función st(){devolver`req_${ce.randomBytes(16).toString(\"hex\")}`}función asíncrona b(n,t,r){n.requestId=st(),t.setHeader(\"X-Request-ID\",n.requestId);deje que i=n.headers[\"x-api-key\"]; if(!i)return t.status(401).json({success:!1,error:\"Clave API faltante\",requestId:n.requestId});let u=tt(i),g=await p.getTenantByApiKeyHash(u); if(!g)return t.status(401).json({success:!1,error:\"Clave API no válida\",requestId:n.requestId}); if(g.status!==\"activo\")return t.status(403).json({success:!1,error:`La cuenta es ${g.status}`,requestId:n.requestId});n.tenant=g,r()}function $(n,t,r){n.requestId=st(),t.setHeader(\"X-Request-ID\",n.requestId);let i=n.headers[\"x-admin-key\"];if(!Ze)return t.status(503).json({éxito:!1,error:\"API de administración no configurada\",requestId:n.requestId});if(!i)return t.status(401).json({éxito:!1,error:\"Falta la clave de API de administración\",requestId:n.requestId});let u=ce.createHash(\"sha256\").update(i).digest(\"hex\"),g=ce.createHash(\"sha256\").update(Ze).digest(\"hex\");if(!ce.timingSafeEqual(Buffer.from(u),Buffer.from(g)))return t.status(401).json({éxito:!1,error:\"Clave de API de administrador no válida\",requestId:n.requestId});n.isAdmin=!0,r()}var et=new Map;function k(n,t,r){if(!n.tenant)return r();let i=n.tenant.id,u=Date.now(),g=1e3,h=et.get(i);(!h||h.resetAt<u)&&(h={count:0,resetAt:u+g},et.set(i,h)),h.count++;let s=n.tenant.rateLimit,a=Math.max(0,sh.count);if(t.setHeader(\"X-RateLimit-Límite\",s),t.setHeader(\"X-RateLimit-Restante\",a),t.setHeader(\"X-RateLimit-Restablecer\",Math.ceil(h.resetAt/1e3)),h.count>s)return t.status(429).json({éxito:!1,error:\"Límite de tasa excedido\", requestId:n.requestId,retryAfter:Math.ceil((h.resetAt-u)/1e3)});r()}función en(n){return(t,r,i)=>{if(!t.tenant)return r.status(401).json({éxito:!1,error:\"Se requiere autenticación\", requestId:t.requestId});let u=H[t.tenant.tier];if(!u)return r.status(403).json({éxito:!1,error:\"Configuración de nivel no válida\", requestId:t.requestId});if(n===\"kms\"&&!u.kmsAllowed)return r.status(403).json({éxito:!1,error:\"KMS no está disponible en Su nivel. Actualice a Scale o Enterprise.\",requestId:t.requestId,upgrade:!0});if(n===\"archival\"&&!u.archivalAccess)return r.status(403).json({success:!1,error:\"El acceso a archivos no está disponible en su nivel. Actualice a Enterprise.\",requestId:t.requestId,upgrade:!0});i()}}function Ae(n,t,r){if(!n.tenant)return r();let i=n.params.chain||n.body?.chain;if(!i)return r();let g=H[n.tenant.tier]?.chains||n.tenant.allowedChains;if(!g.includes(i))return t.status(403).json({success:!1,error:`La cadena '${i}' no está disponible en su nivel`,allowedChains:g,requestId:n.requestId,upgrade:!0});r()}D();función asíncrona nt(){if(!process.env.SEED_DEMO_DATA)return null;console.log(\"Comprobando si hay un inquilino de demostración...\");let n=await p.getTenantByEmail(\"demo@tatum-gateway.io\");if(n)return console.log(\"El inquilino de demostración ya existe\"),n;console.log(\"Creando inquilino de demostración...\"); let{prefix:t,hash:r}=Ie(),i=H.scale,u=await p.createTenant({name:\"Cuenta de demostración\",email:\"demo@tatum-gateway.io\",tier:\"scale\",status:\"active\",apiKeyPrefix:t,apiKeyHash:r,hmacSecret:we(),allowedChains:i.chains,maxAddresses:i.maxAddresses,maxWebhooks:i.maxWebhooks,maxVirtualAccounts:i.maxVirtualAccounts,rateLimit:i.rateLimit,monthlyQuota:i.monthlyQuota,companyName:\"Demostración de Tatum Gateway\",website:\"https://tatum.io\"});console.log(\"Inquilino de demostración creado:\",u.id),await p.createAuditLog({Id.inquilino:u.id,acción:\"inquilino.creado\",recurso:\"inquilino\",Id.recurso:u.id,cambios:{nivel:\"escala\",origen:\"semilla\"}});para(dejar g=0;g<10;g++)esperar p.recordApiUsage({Id.inquilino:u.id,punto final:`/api/v1/${[\"direcciones\",\"saldos\",\"tokens\",\"transacciones\"][g%4]}`,método:[\"OBTENER\",\"POST\"][g%2],cadena:[\"ethereum\",\"bitcoin\",\"solana\",\"polígono\"][g%4],acción:[\"saldo consulta_de_ance\",\"creación_de_dirección\",\"saldo_de_token\",\"historial_de_transacciones\"][g%4],unidades:[.5,1,1,2][g%4],créditos:[5e-4,.001,.001,.002][g%4],código_de_estado:200,id_de_solicitud:`demo_${g}`,tiempo_de_respuestaMs:50+Math.floor(Math.random()*100)});retorno console.log(\"¡Datos de uso de demostración sembrados!\"),u}D();función O(n){return async(t,r,i)=>{if(!t.tenant)return i();let u=le[n];t.metered={acción:n,unidades:u.units,créditos:u.cost};let g=r.json.bind(r);r.json=h=>{let s=Date.now();return p.recordApiUsage({Id.inquilino:t.id.inquilino, punto final:t.ruta, método:t.método, cadena:t.params.cadena||t.cuerpo?.cadena||nulo, acción:n, unidades:u.unidades, créditos:u.costo, código de estado:r.código de estado, Id.solicitud:t.id.solicitud, tiempo de respuesta:Fecha.ahora()-s, metadatos:{agente-usuario:t.encabezados[\"agente-usuario\"], ip:t.ip}}).catch(consola.error),h&&tipo de h==\"objeto\"&&(h.meta={...h.meta, Id.solicitud:t.id.solicitud, marca de tiempo:nueva Fecha().toISOString(),medido:{acción:n,unidades:u.unidades,créditos:u.costo}}),g(h)},i()}}función asíncrona be(n){let t=nueva fecha,r=nueva fecha(t.getFullYear(),t.getMonth(),1),i=await p.getApiUsageStats(n,r,t);return{totalRequests:i.totalRequests,totalUnits:i.totalUnits,totalCredits:i.totalCredits,costUsd:i.totalCredits}}función asíncrona Se(n,t){if(t===-1)return{permitido:!0,usado:0,restante:-1,porcentajeUsado:0};let r=await ser(n),i=Math.floor(r.totalUnits),u=ti,g=i/t*100;devolver{permitido:u>0,usado:i,restante:Math.max(0,u),porcentajeUsado:Math.min(100,g)}}función ae(n,t,r){si(!n.inquilino)devolver r();Se(n.inquilino.id,n.inquilino.cuotamensual).entonces(i=>{si(t.setHeader(\"X-Cuota-Usada\",i.usada),t.setHeader(\"X-Cuota-Restante\",i.restante),t.setHeader(\"X-Cuota-Porcentaje\",Math.round(i.porcentajeUsado)),!i.permitido)devolver t.status(429).json({success:!1,error:\"Cuota mensual excedida\",requestId:n.requestId,quota:{used:i.used,limit:n.tenant.cuotamensual,porcentajeUsado:i.porcentajeUsado},actualización:!0});r()}).catch(()=>r())}D();importar Ft desde\"crypto\";var $t=1e5,Ot=32,qt=\"sha256\",ne=null,pe=class n{secretomaestro;versión;createdAt;estático SALT_PREFIXES={claveprivada:\"kms:clave_privada:v1\",carteramaestra:\"kms:cartera_maestra:v1\",secretohmac:\"kms:secretohmac:v1\",derivacióndeclaveapi:\"kms:claveapi:v1\",cifradodesesión:\"kms:sesión:v1\"};constructor(t,r=1){if(!t||t.length<32)arrojar nuevo Error(\"El secreto maestro debe ser al menos 32 bytes (usar: openssl rand -hex 16)\");this.masterSecret=t,this.version=r,this.createdAt=new Date,t.length<64&&console.warn(\"\\u26A0\\uFE0F ADVERTENCIA: El secreto del KMS maestro tiene menos de 64 bytes. Considere usar: openssl rand -hex 32\")}static initialize(t){let r=t||process.env.MASTER_KMS_SECRET||process.env.SESSION_SECRET;if(!r)throw new Error(\"Variable de entorno MASTER_KMS_SECRET no establecida. Generar con: openssl rand -hex 32\");return ne||(ne=new n(r),console.log(\"\\u2705 KMS inicializado con secreto maestro\"),ne)}static getInstance(){return ne||(ne=n.initialize()),ne}deriveKey(t,r=\"\"){let i=n.SALT_PREFIXES[t];if(!i)throw new Error(`Tipo de clave desconocida: ${t}`);let u=Buffer.from(`${i}:${r}`);return{key:Ft.pbkdf2Sync(this.masterSecret,u,$t,Ot,qt),version:this.version,keyType:t}}derivePrivateKeyEncryptionKey(t){return this.deriveKey(\"privateKey\",t).key}deriveMasterWalletKey(t){return this.deriveKey(\"masterWallet\",t).key}deriveHmacKey(t){return this.deriveKey(\"hmacSecret\",t).key}deriveSessionEncryptionKey(t){return this.deriveKey(\"sessionEncryption\",t).key}getConfig(){return{masterSecret:\"[CENSURADO]\",version:this.version,createdAt:this.createdAt}}rotate(t){let r=new n(t,this.version+1);return ne=r,console.log(`\\u2705 KMS rotado a la versión ${r.version}`),r}static test(){try{let t=n.getInstance(),r=t.deriveKey(\"privateKey\",\"test-wallet-1\"),i=t.deriveKey(\"privateKey\",\"test-wallet-1\");if(r.key.toString(\"hex\")!==i.key.toString(\"hex\"))throw new Error(\"La derivación de la clave KMS no es determinista\");let u=t.deriveKey(\"privateKey\",\"test-wallet-2\");if(r.key.toString(\"hex\")===u.key.toString(\"hex\"))throw new Error(\"Colisión de derivación de clave KMS detectada\");return console.log(\"\\u2705 Autoprueba de KMS aprobada\"),!0}catch(t){return console.error(\"\\u274C Autoprueba de KMS fallida:\",t),!1}}};try{pe.initialize()}catch(n){console.warn(\"\\u26A0\\uFE0F Advertencia de inicialización de KMS:\",n)}import qe from\"crypto\";var Pe=\"aes-256-gcm\",Re=32,Gt=16;function rt(n,t,r){if(t.length!==Re)throw new Error(`La clave de cifrado debe ser de ${Re} bytes`);let i=qe.randomBytes(Gt),u=qe.createCipheriv(Pe,t,i);r&&u.setAAD(Buffer.from(r));let g=Buffer.concat([u.update(n,\"utf8\"),u.final()]),h=u.getAuthTag();return{ciphertext:g.toString(\"hex\"),iv:i.toString(\"hex\"),authTag:h.toString(\"hex\"),algorithm:Pe}}function ot(n,t,r){if(t.length!==Re)throw new Error(`La clave de cifrado debe tener ${Re} bytes`);if(n.algorithm!==Pe)throw new Error(`Algoritmo no compatible: ${n.algorithm}`);let i=Buffer.from(n.iv,\"hex\"),u=Buffer.from(n.ciphertext,\"hex\"),g=Buffer.from(n.authTag,\"hex\"),h=qe.createDecipheriv(Pe,t,i);r&&h.setAAD(Buffer.from(r)),h.setAuthTag(g);try{return Buffer.concat([h.update(u),h.final()]).toString(\"utf8\")}catch{throw new Error(\"Error de descifrado: los datos pueden estar dañados o alterados\")}}import{sql como Vt}desde\"drizzle-orm\";import{webcrypto como it}desde\"crypto\";var Yt=w.object({nombre:w.string().min(2),correo electrónico:w.string().correo electrónico(),nivel:w.enum([\"starter\",\"scale\",\"enterprise\"]).predeterminado(\"starter\"),nombreDeEmpresa:w.string().opcional(),sitio web:w.string().url().opcional(),correo electrónico de facturación:w.string().correo electrónico().opcional()}),zt=w.object({cadena:w.string(),etiqueta:w.string().opcional(),etiquetas:w.array(w.string()).opcional(),URLdelwebhook:w.string().url().opcional()}),Xt=w.object({url:w.string().url(),eventos:w.array(w.enum(Be)).min(1)});función asíncrona ct(n,t){nt().catch(console.error),t.get(\"/\",(s,a)=>{a.json({name:\"Tatum API Gateway\",version:\"1.0.0\",description:\"API Gateway de blockchain de nivel empresarial compatible con más de 130 blockchains\",status:\"running\",documentation:\"GET /api/docs | GET /api/docs/model | GET /api/docs/examples\",quickStart:\"1. Obtener la clave API del administrador | 2. Agregar el encabezado 'x-api-key: YOUR_KEY' | 3. Enviar por POST a /api/tenants para registrarse\",endpoints:{health:\"GET /api/health\",pricing:\"GET /api/pricing\",chains:\"GET /api/chains\",tenants:\"GET /api/tenants | POST /api/inquilinos\", direcciones:\"GET /api/v1/direcciones | POST /api/v1/direcciones\", transacciones:\"GET /api/v1/transacciones\", webhooks:\"POST /api/v1/webhooks | GET /api/v1/webhooks\", puerta de enlace:\"POST /api/v1/puerta de enlace/cuentas-virtuales | GET /api/v1/puerta de enlace/cuentas-virtuales | POST /api/v1/puerta de enlace/intercambio | POST /api/v1/puerta de enlace/retiro\", administrador:\"GET /api/admin/configuración-gas | PUT /api/admin/configuración-gas/global | GET /api/admin/ingresos | GET /api/admin/transacciones\", rwa:\"POST /api/v1/rwa/tokens | GET /api/v1/rwa/tokens | POST /api/v1/rwa/tokens/:id/transfer\"},businessModel:{type:\"Puerta de enlace API de doble panel (100 % de ingresos de administración)\",panels:{cryptoPanel:{description:\"Control de billetera maestra con sistema de cuentas virtuales\",revenueStreams:{internalSwaps:\"0,5 % de comisión (sin comisiones de gas)\",gasMarkup:\"40 % de margen configurable sobre las comisiones de gas\",setupFees:\"$500 por cliente de RWA\"},annualRevenue:\"$204K (Y1) \\u2192 $1.02M (Y2) \\u2192 $2.04M (Y3)\"}, rwaPanel:{description:\"Infraestructura de tokenización de activos del mundo real\",revenueStreams:{setupFees:\"$500 por token (pago único)\",nnualFees:\"$200 por token al año\",tradingCommissions:\"0.5% del volumen total de operaciones (100% para administración)\"},annualRevenue:\"$654K (Y1) \\u2192 $8.07M (Y2) \\u2192 $60.21M (Y3)\"}},profitMargins:\"82.5% (Y1) \\u2192 91.2% (Y2) \\u2192 96,8 % (año 3)\", totalProjections:{año 1:\"$858 000\", año 2:\"$9,09 000\", año 3:\"$62,25 000\"}}, auth:{type:\"Clave API + HMAC\", method:\"x-api-key header (Tatum v3 recommended)\", example:\"curl -H 'x-api-key: YOUR_API_KEY' https://api.example.com/api/v1/...\", documentation:\"https://docs.tatum.io/docs/authentication\"}, rateLimit:\"Por nivel: Starter 10/s, Scale 100/s, Enterprise 1000/seg\",docs:\"https://api.tatum.io/docs\",github:\"https://github.com/MasterFital/tatum-api-gateway\"})}),t.get(\"/api/docs/model\",(s,a)=>{a.json({title:\"Tatum API Gateway - Modelo de Negocio\",introduction:\"Arquitectura de doble panel que genera el 100% de ingresos administrativos mediante el trading de criptomonedas y la tokenización de RWA\",panels:{crypto:{name:\"Panel CRYPTO (100% de tus ingresos)\",description:\"Controlas las billeteras maestras (BTC, ETH, SOL, MATIC). Los clientes operan a través de cuentas virtuales.\",how_it_works:{step1:\"El administrador crea billeteras maestras mediante POST /api/admin/master-wallets\",step2:\"Los clientes crean cuentas virtuales mediante POST /api/v1/gateway/virtual-accounts\",paso 3:\"Los clientes pueden intercambiar internamente (comisión del 0,5 % para usted) o retirar externamente (margen de beneficio del 40 %)\",paso 4:\"El administrador registra todos los ingresos mediante GET /api/admin/revenue\"},revenue_streams:{internal_swaps:{description:\"El cliente intercambia BTC \\u2192 ETH\",fee:\"0,5 % del importe del intercambio\",gas_cost:\"Cero (interno)\",admin_profit:\"100 % de la comisión\",example:\"El cliente intercambia 1 ETH \\u2192 0,02 BTC | Comisión: 0,0001 BTC (100 % para el administrador)\"},gas_markup:{description:\"El cliente retira criptomonedas a una billetera externa\",fee:\"Margen de beneficio del 40 % sobre el gas real costo\", ejemplo:\"Gas Bitcoin: $3 reales | Cobras: $4.20 | Tu ganancia: $1.20 (40%)\"}}, proyecciones:{año1:{volumen:\"Promedio de 1 millón de USD/mes\", swaps mensuales:\"5K \\xD7 0.5% = $25K\", gas mensual:\"Retiros de 10K \\xD7 $3 \\xD7 40% = $12K\", total mensual:\"$17K\", anual:\"$204K\"}, año2:{volumen:\"Promedio de 5 millones de USD/mes\", anual:\"$1.02M\"}, año3:{volumen:\"Promedio de 10 millones de USD/mes\", anual:\"$2.04M\"}}}, rwa:{nombre:\"Panel RWA (100% Tus Ingresos + Tarifas)\", descripción:\"Los clientes emiten tokens. Tú proporcionas la infraestructura. Te quedas con el 100% de las tarifas y comisiones de trading.\", cómo_funciona:{paso 1:\"El cliente solicita la creación de un token: POST /api/v1/rwa/tokens\", paso 2:\"Cobras $500 de comisión de configuración + implementación del contrato inteligente\", paso 3:\"El token se activa. Los clientes operan internamente (comisión del 0,5 % para ti)\", paso 4:\"Comisión anual de mantenimiento de $200 por token\", paso 5:\"Todos los retiros externos tienen un margen de gas del 40 % (para ti)\", paso 6:\"Seguimiento de los ingresos mediante GET /api/admin/rwa-revenue\"},revenue_streams:{setup_fees:{description:\"Comisión única por token lanzado\",amount:\"$500\",frequency:\"Por token\"},annual_fees:{description:\"Mantenimiento anual por token activo\",amount:\"$200\",frequency:\"Por token por año\"}, comisiones_comerciales:{descripción:\"0.5% del volumen total de operaciones de tokens (100% para el administrador)\", porcentaje:\"0.5%\", ejemplo:\"Volumen de tokens: $100,000/mes | Su comisión: $500/mes = $6,000/año por token\"}, margen_gas:{descripción:\"40% de margen en las comisiones de gas para retiros externos\", porcentaje:\"40%\"}}, beneficios_del_cliente:{beneficio1:\"Infraestructura de tokenización (su costo: ~$0.10 por token)\", beneficio2:\"Mercado listo para usar\", beneficio3:\"Liquidez instantánea (operadores del día 1)\", beneficio4:\"Seguridad y cumplimiento a su cargo\", pago_del_cliente:\"$500 de configuración + $200/año solo\"}, proyecciones:{año1:{tokens:\"20 tokens nuevos\", tarifas_de_configuración:\"20 \\xD7 $500 = $10K\", tarifas_anuales:\"20 \\xD7 $200 = $4K\", comisiones_de_operación:\"0.5% de un volumen de ~$100M = $500K\", total:\"$514K\"}, año2:{tokens:\"100 tokens en total\", tarifas_de_configuración:\"100 \\xD7 $500 = $50K\", tarifas_anuales:\"100 \\xD7 $200 = $20K\", comisiones_de_operación:\"0.5% de un volumen de ~$1.6B = $8M\",total:\"$8.07M\"},año3:{tokens:\"300 tokens en total\",tarifas_de_configuración:\"300 \\xD7 $500 = $150K\",tarifas_anuales:\"300 \\xD7 $200 = $60K\",comisiones_de_comercio:\"0.5% de un volumen de ~$12B = $60M\",total:\"$60.21M\"}}}},resumen_de_ingresos:{título:\"Ingresos combinados (Cripto + RWA)\",año 1:{cripto:\"$204K\",rwa:\"$654K\",total:\"$858K\",margen:\"82.5%\"},año 2:{cripto:\"$1.02M\",rwa:\"$8.07M\",total:\"$9.09M\",margen:\"91.2%\"},año 3:{cripto:\"$2.04M\",rwa:\"$60.21M\",total:\"$62.25M\",margen:\"96.8%\"}},puntos_clave:[\"El 100% de todos los ingresos van al administrador (usted)\",\"Los clientes obtienen acceso a la infraestructura, no a la repartición de ingresos\",\"Las tarifas de configuración son ingresos inmediatos\",\"Las comisiones de trading escalan infinitamente con el volumen\",\"El margen de gas es puro beneficio (costo mínimo de infraestructura)\",\"Costo de adquisición de clientes cero (los clientes se traen a sí mismos)\"]})}),t.get(\"/api/docs/examples\",(s,a)=>{a.json({title:\"Tatum API Gateway - Ejemplos de uso\",autenticación: {descripción:\"Todas las solicitudes requieren el encabezado x-api-key\",ejemplo:\"curl -H 'x-api-key: YOUR_API_KEY' https://api.example.com/api/v1/...\",encabezados:{\"x-api-key\":\"Su clave API del administrador\",\"Content-Type\":\"application/json\"}},crypto_examples: {título:\"Ejemplos del panel CRYPTO\",create_virtual_account: {descripción:\"El cliente crea una cuenta virtual para almacenar criptomonedas\",endpoint:\"POST /api/v1/gateway/virtual-accounts\",solicitud:{tipoDeCuenta:\"individual\"},respuesta:{éxito:!0,cuentaVirtual:{id:\"va-123\",identificadorDeInquilino:\"cliente-1\",tipoDeCuenta:\"individual\",saldos:{BTC:\"0\",ETH:\"0\",SOL:\"0\"},estado:\"activo\"}}},interno_swap_0_5_percent:{descripción:\"El cliente intercambia BTC por ETH (comisión del 0,5 % para el administrador)\",punto final:\"POST /api/v1/gateway/swap\", solicitud: {fromAccountId:\"va-123\", fromAsset:\"BTC\", toAsset:\"ETH\", importe:\"1.0\"}, respuesta: {éxito:!0, intercambio: {id:\"swap-456\", fromAsset:\"BTC\", toAsset:\"ETH\", importe:\"1.0\", comisión:\"0.005 BTC (0.5% para el administrador)\", estado:\"completado\"}, nota:\"Sin comisiones de gas, comisión del 0.5% aplicada\"}}, external_withdraw_40_percent_markup: {descripción:\"El cliente retira a una billetera externa (40% de margen de gas para el administrador)\", punto final:\"POST /api/v1/gateway/withdraw\", solicitud: {fromAccountId:\"va-123\", activo:\"ETH\", importe:\"1.0\", dirección:\"0x1234567890abcdef...\"}, respuesta: {éxito:!0, retiro: {id:\"withdraw-789\", activo:\"ETH\", importe:\"1.0\", dirección:\"0x1234567890abcdef...\", gasReal:\"3 USD\", gasCharged:\"4.20 USD (40% de margen)\", adminProfit:\"1.20 USD\", estado:\"pendiente\", txHash:\"0xabcd...\"}}}, ver_historial_de_transacciones: {descripción:\"El cliente visualiza su transacción historial\", punto final:\"GET /api/v1/transactions?limit=50\", respuesta:{éxito:!0, transacciones:[{id:\"swap-456\", tipo:\"internal_swap\", activo:\"BTC\", importe:\"1.0\", comisión:\"0.005\", estado:\"completado\", creado el:\"2024-11-30T10:00:00Z\"}], paginación:{total:42, límite:50, desplazamiento:0}}}}, ejemplos_rwa:{título:\"Ejemplos de paneles RWA\", crear_rwa_token_500_setup:{descripción:\"El cliente crea un token (paga $500 de tarifa de configuración al administrador)\", punto final:\"POST /api/v1/rwa/tokens\",solicitud:{nombreDeActivo:\"Fondo Inmobiliario\",símbolo:\"REF\",cadenaDeBlockchain:\"Ethereum\",decimales:18,suministroTotal:\"1000000\",nombreDeEmisor:\"RE Properties Inc\",descripción:\"Inversión Inmobiliaria Tokenizada\"},respuesta:{éxito:!0,token:{id:\"token-ref-1\",nombreDeActivo:\"Fondo inmobiliario\", símbolo:\"REF\", cadena de bloques:\"ethereum\", suministro total:\"1000000\", dirección del contrato inteligente:\"0x...\", estado:\"creado\"}, precios: {tarifa de configuración:\"$500 (pago único) - PAGADO AL ADMINISTRADOR\", tarifa anual:\"$200/año - PAGADO AL ADMINISTRADOR\", comisión de negociación:\"0.5% en todas las operaciones - 100% PARA EL ADMINISTRADOR\"}}}, lista_rwa_tokens: {descripción:\"El cliente visualiza sus tokens y volumen de operaciones\", punto final:\"GET /api/v1/rwa/tokens\", respuesta: {éxito:!0, tokens:[{id:\"token-ref-1\", nombre_del_activo:\"Bienes raíces Fondo\", símbolo:\"REF\", cadena de bloques:\"ethereum\", oferta total:\"1000000\", estado:\"activo\", tarifa de configuración:\"500, tarifa anual:\"200, volumen de negociación:\"250000 USD\", comisión de negociación:\"1250 USD (0,5 % para el administrador)\"}], resumen:{totalTokens:\"1, comisiones de negociación totales:\"1250 USD (100 % para el administrador)\", tarifas de configuración cobradas:\"500 USD (100 % para el administrador)\"}}}, rwa_token_transfer_0_5_percent:{descripción:\"El titular del token negocia el token REF (0,5 % de comisión para el administrador)\", punto final:\"POST /api/v1/rwa/tokens/token-ref-1/transfer\",request:{toAddress:\"0xabcd...\",amount:\"100\"},response:{success:!0,transfer:{id:\"transfer-123\",tokenId:\"token-ref-1\",amount:\"100 REF\",toAddress:\"0xabcd...\",commission:\"0.5 REF (0.5% para el administrador)\",status:\"completed\",txHash:\"0x...\"},note:\"0.5% de comisión de trading aplicada y cobrada por el administrador\"}}},admin_examples:{title:\"Ejemplos del panel de administración\",view_revenue:{description:\"El administrador visualiza los ingresos totales (swaps + margen de gas)\",endpoint:\"GET /api/admin/revenue\",respuesta:{éxito:!0,cryptoRevenue:{totalSwapCommissions:\"1245.67 USD\",totalGasMarkupRevenue:\"3456.78 USD\",totalVolume:\"249000 USD\",revenueByBlockchain:{ethereum:\"2345.67\",polygon:\"1234.56\",bitcoin:\"3456.78\"}}}},view_rwa_revenue:{description:\"El administrador visualiza los ingresos de RWA (comisiones de configuración + anuales + de trading)\",endpoint:\"GET /api/admin/rwa-revenue\",respuesta:{éxito:!0,rwaRevenue:{setupFees:{count:12,total:\"6000 USD\", Tarifas anuales: {Clientes activos: 12, Total: 2400 USD\", Comisiones por operaciones: {Este mes: 12500 USD\", Este año: 125000 USD\", Tasa: 0,5 % del volumen total de operaciones\", Ingresos mensuales totales: 15000 USD\", Seguridad: {Autenticación: encabezado x-api-key (recomendado Tatum v3)\", Cifrado: Todas las claves privadas cifradas con AES-256\", Auditoría: Todas las transacciones registradas con registro de auditoría completo\", Límite de tasa: Starter 10/s, Scale 100/s, Enterprise 1000/seg\",documentación:\"https://docs.tatum.io/docs/authentication\"}})}),t.get(\"/api/test-tatum\",async(s,a)=>{try{let e=await B.healthCheck(),o={success:e.success,message:e.success?\"\\u2705 Conectado a la API de Tatum correctamente\":\"\\u274C Error al conectarse a la API de Tatum\",tatumApiUrl:process.env.TATUM_API_URL||\"https://api.tatum.io\",apiKeyConfigured:!!process.env.TATUM_API_KEY,apiKeyLength:process.env.TATUM_API_KEY?.length||0,timestamp:new Date().toISOString()};e.success&&e.data&&(o.blockchainInfo={chain:e.data.chain,blocks:e.data.blocks,mempool:e.data.mempool}),e.error&&(o.error=e.error,o.statusCode=e.statusCode),a.json({success:e.success,test:\"Prueba de conexión a la API de Tatum\",status:o,instructions:{production:\"Configure la variable de entorno TATUM_API_KEY con su API de producción de Tatum key\",documentation:\"https://docs.tatum.io/docs/authentication\",getApiKey:\"https://dashboard.tatum.io\"},requestId:s.requestId})}catch(e){a.status(500).json({success:!1,test:\"Prueba de conexión de la API de Tatum\",error:e.message,message:\"Error al probar la conexión de Tatum\",instructions:{checkApiKey:\"Asegúrese de que TATUM_API_KEY esté configurado en las variables de entorno\",checkUrl:\"Verifique que TATUM_API_URL esté correct\",documentation:\"https://docs.tatum.io/docs/authentication\"},requestId:s.requestId})}}),t.get(\"/api/docs\",(s,a)=>{a.json({title:\"Tatum API Gateway - Documentación completa\",message:\"Para obtener más información, visite estos puntos finales de la documentación:\",available_docs:{business_model:\"GET /api/docs/model - Explicación completa de los flujos de ingresos\",examples:\"GET /api/docs/examples - Ejemplos de uso para Crypto y RWA\",tatum_test:\"GET /api/test-tatum - Conexión de prueba a la API de Tatum (verificación de producción)\",this_endpoint:\"GET /api/docs - Esta página\",api_root:\"GET / - Información de la API y descripción general del modelo de negocio\"},quick_endpoints:{\"Crypto Panel\":[\"POST /api/v1/gateway/virtual-accounts - Crear cuenta virtual\",\"POST /api/v1/gateway/swap - Swap interno (comisión del 0,5%)\",\"POST /api/v1/gateway/withdraw - Retiro externo (margen de beneficio del 40%)\",\"GET /api/v1/transactions - Historial de transacciones\"],\"Panel RWA\":[\"POST /api/v1/rwa/tokens - Crear token (comisión de instalación de 500$)\",\"GET /api/v1/rwa/tokens - Listar tokens\",\"POST /api/v1/rwa/tokens/:id/transfer - Intercambio de tokens (comisión del 0,5%)\"],Admin:[\"GET /api/admin/revenue - Panel de ingresos de criptomonedas\",\"GET /api/admin/rwa-revenue - Panel de ingresos de RWA\",\"GET /api/admin/master-wallets - Lista de billeteras maestras\",\"POST /api/admin/master-wallets - Crear billetera maestra\"]},authentication:{method:\"x-api-key header\",example:\"Authorization: x-api-key YOUR_API_KEY\",documentation:\"https://docs.tatum.io/docs/authentication\"},support:{github:\"https://github.com/MasterFital/tatum-api-gateway\",tatum_docs:\"https://api.tatum.io/docs\",api_reference:\"https://docs.tatum.io/reference/welcome-to-the-tatum-api-reference\"}})}),t.get(\"/api/health\",async(s,a)=>{let e=await B.healthCheck();a.json({éxito:!0,estado:\"saludable\",servicios:{api:\"saludable\",base de datos:\"saludable\",tatum:e.success?\"saludable\":\"degradado\"},marca de tiempo:nueva Fecha().toISOString()})}), t.get(\"/api/pricing\",(s,a)=>{a.json({éxito:!0,precios:le,niveles:Object.entries(H).map(([e,o])=>({id:e,...o,precios:{starter:{mensual:0,incluido:1e4},escala:{mensual:99,incluido:1e5},empresa:{mensual:\"personalizado\",incluido:\"ilimitado\"}}[e]}))})}), t.get(\"/api/cadenas\",(s,a)=>{a.json({éxito:!0,cadenas:me,total:me.length})}), t.post(\"/api/inquilinos\",async(s,a)=>{try{let e=Yt.parse(s.body);if(await p.getTenantByEmail(e.email))return a.status(409).json({éxito:!1,error:\"Correo electrónico ya registrado\"});let{key:c,prefix:d,hash:y}=Ie(),m=H[e.tier],I=await p.createTenant({nombre:e.nombre,correo electrónico:e.correo electrónico,nivel:e.nivel,estado:\"activo\",apiKeyPrefix:d,apiKeyHash:y,hmacSecret:we(),allowedChains:[...m.cadenas],maxAddresses:m.maxAddresses,maxWebhooks:m.maxWebhooks,maxVirtualAccounts:m.maxVirtualAccounts,rateLimit:m.rateLimit,monthlyQuota:m.monthlyQuota,companyName:e.companyName,website:e.website,billingEmail:e.billingEmail});await p.createAuditLog({tenantId:I.id,action:\"tenant.created\",resource:\"tenant\",resourceId:I.id,changes:{tier:e.tier}}),a.status(201).json({success:!0,tenant:{id:I.id,name:I.name,email:I.email,tier:I.tier,status:I.status,apiKey:c,hmacSecret:I.hmacSecret,limits:{chains:I.allowedChains,maxAddresses:I.maxAddresses,maxWebhooks:I.maxWebhooks,maxVirtualAccounts:I.maxVirtualAccounts,rateLimit:I.rateLimit,monthlyQuota:I.monthlyQuota},createdAt:I.createdAt},warning:\"Guarde su clave API ahora. No se puede recuperar de nuevo.\"})}catch(e){if(e.name===\"ZodError\")return a.status(400).json({éxito:!1,error:\"Error de validación\",details:e.errors});console.error(\"Error al crear inquilino:\",e),a.status(500).json({éxito:!1,error:\"Error interno del servidor\"})}}),t.get(\"/api/tenants\",async(s,a)=>{try{let e=await p.getAllTenants(),o=await Promise.all(e.map(async c=>{let d=await be(c.id),y=await p.countAddressesByTenant(c.id); return{id:c.id,name:c.name,email:c.email,tier:c.tier,status:c.status,companyName:c.companyName,addressCount:y,usage:{requests:d.totalRequests,units:Math.floor(d.totalUnits),costUsd:d.costUsd.toFixed(4)},createdAt:c.createdAt}}));a.json({success:!0,tenants:o})}catch(e){console.error(\"Error al obtener inquilinos:\",e),a.status(500).json({success:!1,error:\"Error interno del servidor\"})}}),t.get(\"/api/tenants/:id\",b,async(s,a)=>{try{let e=espera p.getTenant(s.params.id);si(!e)devuelve a.status(404).json({éxito:!1,error:\"No se encontró el inquilino\"}); sea o=await be(e.id),c=await Se(e.id,e.monthlyQuota),d=await p.countAddressesByTenant(e.id),y=await p.countWebhooksByTenant(e.id),m=await p.countVirtualAccountsByTenant(e.id);a.json({éxito:!0, inquilino:{id:e.id, nombre:e.name, correo electrónico:e.email, nivel:e.tier, estado:e.status, nombreDeEmpresa:e.nombreDeEmpresa, sitio web:e.website, correo electrónicoDeFacturación:e.correoElectrónicoDeFacturación, prefijoDeClaveAPI:e.prefijoDeClaveAPI, límites:{cadenas:e.cadenaspermitidas, direccionesmáximas:e.direccionesmáximas, webhooksmáx:e.webhooksmáx, cuentasvirtualesmáx:e.accesoVirtual recuentos, rateLimit:e.rateLimit, monthlyQuota:e.monthlyQuota}, uso:{direcciones:d, webhooks:y, cuentas virtuales:m, solicitudes:o.totalRequests, unidades:Math.floor(o.totalUnits), costoUsd:o.costUsd.toFixed(4), cuota:{usado:c.usado, restante:c.restante, porcentajeUsado:Math.round(c.porcentajeUsado)}}, creadoEn:e.creadoEn, actualizadoEn:e.actualizadoEn}})}catch(e){console.error(\"Obtener Error de inquilino:\",e),a.status(500).json({éxito:!1,error:\"Error interno del servidor\"})}}),t.patch(\"/api/tenants/:id\",b,async(s,a)=>{try{if(s.tenant.id!==s.params.id)return a.status(403).json({éxito:!1,error:\"Solo puede actualizar su propia cuenta\",requestId:s.requestId});let e=s.body,o=[\"nombre\",\"nombreDeEmpresa\",\"sitio web\",\"correo electrónico de facturación\"],c={};for(let y of o)e[y]!==void 0&&(c[y]=e[y]);if(Object.keys(c).length===0)return a.status(400).json({éxito:!1,error:\"No hay campos válidos para actualizar\",requestId:s.requestId});let d=await p.updateTenant(s.params.id,c);if(!d)return a.status(404).json({éxito:!1,error:\"No se encontró el inquilino\"});await p.createAuditLog({tenantId:d.id,acción:\"inquilino.actualizado\",resource:\"inquilino\",resourceId:d.id,cambios:c,ipAddress:s.ip}),a.json({éxito:!0,inquilino:d,requestId:s.requestId})}catch(e){console.error(\"Actualizar inquilino error:\",e),a.status(500).json({éxito:!1,error:\"Error interno del servidor\"})}}),t.post(\"/api/tenants/:id/rotate-key\",b,async(s,a)=>{try{let e=await p.getTenant(s.params.id);if(!e)return a.status(404).json({éxito:!1,error:\"No se encontró el inquilino\"});if(s.tenant.id!==e.id)return a.status(403).json({éxito:!1,error:\"Solo puede rotar su propia clave API\",requestId:s.requestId});let{key:o,prefix:c,hash:d}=Ie();await p.updateTenant(e.id,{apiKeyPrefix:c,apiKeyHash:d}),await p.createAuditLog({tenantId:e.id,action:\"apikey.rotated\",resource:\"tenant\",resourceId:e.id,changes:{rotated:!0}}),a.json({success:!0,apiKey:o,warning:\"Guarde su nueva clave API. La clave anterior ya no es válida y no se puede recuperar.\",requestId:s.requestId})}catch(e){console.error(\"Error al rotar la clave API:\",e),a.status(500).json({success:!1,error:\"Servidor interno error\"})}}),t.patch(\"/api/admin/tenants/:id\",$,async(s,a)=>{try{let e=s.body;if(e.tier){let c=H[e.tier];c&&(e.allowedChains=c.chains,e.maxAddresses=c.maxAddresses,e.maxWebhooks=c.maxWebhooks,e.maxVirtualAccounts=c.maxVirtualAccounts,e.rateLimit=c.rateLimit,e.monthlyQuota=c.monthlyQuota)}let o=await p.updateTenant(s.params.id,e);if(!o)return a.status(404).json({éxito:!1,error:\"No se encontró el inquilino\"});await p.createAuditLog({Id.inquilino:o.id,acción:\"admin.tenant.updated\",recurso:\"inquilino\",Id.recurso:o.id,cambios:e,direcciónIP:s.ip}),a.json({éxito:!0,inquilino:o,Id.solicitud:s.Id.solicitud})}catch(e){console.error(\"El administrador actualiza el inquilino error:\",e),a.status(500).json({éxito:!1,error:\"Error interno del servidor\"})}}),t.post(\"/api/admin/tenants/:id/suspend\",$,async(s,a)=>{try{let e=await p.updateTenant(s.params.id,{status:\"suspendido\"});if(!e)return a.status(404).json({éxito:!1,error:\"Inquilino no encontrado\"});await p.createAuditLog({tenantId:e.id,action:\"admin.tenant.suspended\",resource:\"tenant\",resourceId:e.id,changes:{status:\"suspended\"},ipAddress:s.ip}),a.json({success:!0,message:\"Inquilino suspendido\",requestId:s.requestId})}catch(e){console.error(\"Error de suspensión del inqui
{"mensaje":"","atributos":{"nivel":"información"},"marca de tiempo":"2025-11-30T18:34:51.927181279Z"}
{"mensaje":"> rest-express@1.0.0 inicio","atributos":{"nivel":"información"},"marca de tiempo":"2025-11-30T18:34:51.927188778Z"}
{"mensaje":"> NODE_ENV=nodo de producción dist/index.js","atributos":{"nivel":"información"},"marca de tiempo":"2025-11-30T18:34:51.927194694Z"}
{"mensaje":"","atributos":{"nivel":"información"},"marca de tiempo":"2025-11-30T18:34:51.927200045Z"}
{"mensaje":"archivo:///app/dist/index.js:1","atributos":{"nivel":"error"},"marca de tiempo":"2025-11-30T18:34:52.648782788Z"}
{"mensaje":"var mt=Object.defineProperty;var fe=(n,t)=>()=>(n&&(t=n(n=0)),t);var xe=(n,t)=>{para(var r en t)mt(n,r,{obtener:t[r],enumerable:!0})};var J={};xe(J,{EnumeraciónDeCadena:()=>ft,PRECIOS:()=>le,CADENAS_SOPORTADAS:()=>me,EnumeraciónDeEstado:()=>yt,LÍMITES_DE_NIVEL:()=>H,EnumeraciónDeNivel:()=>gt,EVENTOS_DE_WEBHOOK:()=>Be,direcciones:()=>S,UsoDeAPI:()=>W,RegistrosDeAuditoría:()=>te,AgregacionesDeFacturación:()=>Q,CriptoTransacciones:()=>de,ConfiguraciónDeGas:()=>X,InsertarEsquemaDeDirección:()=>vt,InsertarEsquemaDeUsoDeAPI:()=>_t,InsertarLoCursoDeAuditoría gSchema:()=>xt,insertarEsquemaDeTransacciónCriptográfica:()=>At,insertarEsquemaDeMonederoMaestro:()=>It,insertarEsquemaDeInquilino:()=>bt,insertarEsquemaDeTransacción:()=>kt,insertarEsquemaDeCuentaVirtual:()=>wt,insertarEsquemaDeWebhook:()=>Tt,MonederosMaestros:()=>z,inquilinos:()=>x,RelacionesDeInquilinos:()=>ht,transacciones:()=>j,CuentasVirtuales:()=>_,webhooks:()=>K});import{sql como M}de\"drizzle-orm\";import{pgTable como q,texto como l,varchar como T,entero como E,booleano como Ve,marca de tiempo como R,jsonb como F,real como he,índice como v}de\"drizzle-orm/pg-core\";import{createInsertSchema como Y}de\"drizzle-zod\";import{z como Ke}de\"zod\";import{relaciones como pt}de\"drizzle-orm\";var gt,yt,ft,x,z,_,de,X,S,j,K,W,Q,te,ht,It,wt,At,bt,vt,kt,Tt,_t,xt,H,le,Be,me,D=fe(()=>{\"use estricto\";gt=Ke.enum([\"inicial\",\"escala\",\"empresa\"]),yt=Ke.enum([\"activo\",\"suspendido\",\"eliminado\"]),ft=Ke.enum([\"bitcoin\",\"ethereum\",\"solana\",\"polígono\",\"tron\",\"bsc\",\"ondulación\",\"cardano\",\"cerca\",\"polkadot\",\"avalancha\",\"arbitrum\",\"optimismo\",\"base\",\"fantom\",\"cronos\",\"cosmos\",\"algorand\"]),x=q(\"inquilinos\",{id:T(\"id\",{length:36}).primaryKey().default(M`gen_rand om_uuid()`), nombre: l(\"nombre\").notNull(), correo electrónico: l(\"correo electrónico\").notNull().único(), nivel: l(\"nivel\").notNull().predeterminado(\"inicial\"), estado: l(\"estado\").notNull().predeterminado(\"activo\"), apiKeyPrefix: T(\"api_key_prefix\",{longitud: 16}).notNull(), apiKeyHash: l(\"api_key_hash\").notNull().único(), hmacSecret: l(\"hmac_secret\").notNull(), allowedChains: l(\"allowed_chains\").array().notNull().predeterminado(M`ARRAY['bitcoin', 'ethereum', 'solana']`), direcciones máximas: E(\"direcciones máximas\").notNull().default(50), webhooks máximos: E(\"webhooks máximos\").notNull().default(1), cuentas virtuales máximas: E(\"cuentas virtuales máximas\").notNull().default(0), límite de tasa: E(\"límite de tasa\").notNull().default(10), cuota mensual: E(\"cuota mensual\").notNull().default(1e4), correo electrónico de facturación: l(\"correo electrónico de facturación\"), nombre de la empresa:l(\"nombre_de_la_empresa\"),sitio_web:l(\"sitio_web\"),lista_blanca_de_ip:l(\"lista_blanca_de_ip\").array(),metadatos:F(\"metadatos\"),createdAt:R(\"created_at\").defaultNow().notNull(),updatedAt:R(\"updated_at\").defaultNow().notNull()},n=>[v(\"id_de_correo_electrónico_de_inquilinos\").on(n.email),v(\"id_hash_de_clave_de_API_de_inquilinos\").on(n.apiKeyHa sh),v(\"idx_estado_inquilinos\").on(n.estado)]),z=q(\"monederos_principales\",{id:T(\"id\",{longitud:36}).clave_primaria().predeterminado(M`gen_random_uuid()`),escenario:l(\"escenario\").notNull(),cadena_de_bloques:l(\"cadena_de_bloques\").notNull(),tipo_de_activo:l(\"tipo_de_activo\").notNull(),nombre_de_activo:l(\"nombre_de_activo\").notNull(),dirección:l( \"dirección\").notNull().unique(),clavepública:l(\"clave pública\"),claveprivadacifrada:l(\"clave privada cifrada\"),claveprivadaIV:T(\"clave privadaIV\",{longitud:32}),etiquetadeautenticacióndeclaveprivada:T(\"etiquetadeautenticacióndeclaveprivada\",{longitud:32}),direccióndecontratointeligente:l(\"direccióndecontratointeligente\"),decimalesdetoken:E(\"decimalesdetoken \"),assignedToTenantId:T(\"id_asignado_al_inquilino\",{length:36}).references(()=>x.id),balance:l(\"saldo\").default(\"0\"),balanceUsd:l(\"saldo_usd\").default(\"0\"),lastSyncTime:R(\"última_sincronización\"),gasMarkupPercentage:E(\"porcentaje_de_margen_de_gas\").default(40),status:l(\"estado\").notNull().de fallo(\"activo\"), metadatos: F(\"metadatos\"), creado en: R(\"creado_en\"). predeterminadoAhora(). no nulo(), actualizado en: R(\"actualizado_en\"). predeterminadoAhora(). no nulo()}, n => [v(\"masters_blockchain_idx\"). en(n. cadena de bloques), v(\"masters_asset_idx\"). en(n. nombre_activo), v(\"masters_address_idx\"). en(n. dirección), v(\"masters_inquilino _idx\").on(n.assignedToTenantId),v(\"masters_scenario_idx\").on(n.scenario)]),_=q(\"cuentas_virtuales\",{id:T(\"id\",{longitud:36}).primaryKey().default(M`gen_random_uuid()`),tenantId:T(\"tenant_id\",{longitud:36}).notNull().references(()=>x.id,{onDelete:\"cascade\"}),accountType:l(\"tipo_de_cuenta\").n otNull(),saldos:F(\"saldos\").predeterminado(M`'{}'`),estado:l(\"estado\").notNull().predeterminado(\"activo\"),congelado:Ve(\"congelado\").predeterminado(!1),metadatos:F(\"metadatos\"),createdAt:R(\"creado_en\").defaultNow().notNull(),updatedAt:R(\"actualizado_en\").defaultNow().notNull()},n=>[v(\"inquilino_de_cuentas_virtuales_i dx\").on(n.Id_de_inquilino),v(\"id_de_estado_de_cuentas_virtualesx\").on(n.estado)]),de=q(\"transacciones_criptográficas\",{id:T(\"id\",{longitud:36}).clave_primaria().predeterminado(M`gen_random_uuid()`),Id_de_inquilino:T(\"id_de_inquilino\",{longitud:36}).notNull().referencias(()=>x.id,{onDelete:\"cascada\"}),tipo:l(\"tipo\").notNull(),escenario:l(\"escenario\").notNull(),fromAccountId:T(\"from_account_id\",{longitud:36}),toAccountId:T(\"to_count_id\",{longitud:36}),toExternalAddress:l(\"to_external_address\"),fromExternalAddress:l(\"from_external_address\"),assetType:l(\"tipo_de_activo\").notNull(),assetName:l(\"nombre_de_activo\").notNull(),blockchain:l(\"blockchain\").notNull(),amount:l(\"mount\"). notNull(),gasReal:l(\"gas_real\"),gasMarkupPercent:E(\"gas_markup_percent\"),gasCharged:l(\"gas_charged\"),commissionAmount:l(\"commission_mont\"),commissionUsd:l(\"comission_usd\"),status:l(\"status\").notNull().default(\"pending\"),txHash:l(\"tx_hash\").unique(),blockNumber:E(\"block_number\"),confirmations:E(\"confirmations\"),metadata:F(\"me tadata\"), creado en: R(\"creado_en\"). predeterminadoAhora(). no nulo(), ejecutado en: R(\"ejecutado_en\"), confirmado en: R(\"confirmado_en\")}, n => [v(\"idx_de_inquilino_de_transacción_criptográfica\"). en(n. id_de_inquilino), v(\"idx_de_tipo_de_transacción_criptográfica\"). en(n. tipo), v(\"idx_de_estado_de_transacción_criptográfica\"). en(n. estado), v(\"idx_hash_de_transacción_criptográfica\"). en(n. hash_de_transacción), v(\"idx_de_escenario_de_transacción_criptográfica\"). en(n. escenario)]), X = q(\"setti_gas ngs\",{id:T(\"id\",{longitud:36}).primaryKey().default(M`gen_random_uuid()`),marcadopredeterminadoglobal:E(\"marcadopredeterminadoglobal\").default(40),marcadomín:E(\"marcadomín\").default(10),marcadomáx:E(\"marcadomáx\").default(100),anulacionesdecliente:F(\"anulacionesdecliente\").default(M`'{}'`),multiplicadoresdecadenadebloques:F(\"multiplicadoresdecadenadebloques\").default(M`'{\"ethereum\": 1.0, \"polígono\": 0.3}'`),Anulaciones de tipo de transacción:F(\"anulaciones de tipo de transacción\").predeterminado(M`'{\"retiro_cripto\": 40, \"transferencia_de_token\": 45}'`),updatedAt:R(\"updated_at\").defaultNow().notNull(),updatedBy:l(\"updated_by\")},n=>[v(\"gas_settings_updated_idx\").on(n.updatedAt)]),S=q(\"direcciones\",{id:T(\"id\",{longitud:36}).primaryKey().default(M`gen_random_uuid()`),tenantId:T(\"tenant_id\",{longitud:36}).notNull().references(()=>x.id,{onDelete:\"cascade\"}),chain:l(\"cadena\").notNull(),currency:l(\"currency\").notNull(),address: l(\"dirección\").notNull(),publicKey:l(\"clave_pública\"),derivationPath:l(\"ruta_derivación\"),label:l(\"etiqueta\"),tags:l(\"etiquetas\").array().default(M`ARRAY[]::text[]`),status:l(\"estado\").notNull().default(\"activo\"),balance:l(\"balance\").default(\"0\"),balanceUsd:l(\"balance_usd\").default(\"0\"),lastSynced:R(\"last_synced\"),webhookUrl:l(\"webhook_url\"),metadatos:F(\"metadatos\"),createdAt:R(\"creado_en\").defaultNow().notNull(),actualizadoEn:R(\"actualizado_en\").defaultNow().notNull(),eliminadoEn:R(\"eliminado_en\")},n=>[v(\"direcciones_idx_de_inquilino\").on(n.Id_de_inquilino),v(\"direcciones_idx_de_cadena\").on(n.cadena),v(\"direcciones_idx_de_estado\").on(n.estado),v(\"direcciones_idx_de_dirección\").on(n.dirección)] ),j=q(\"transacciones\",{id:T(\"id\",{longitud:36}).primaryKey().default(M`gen_random_uuid()`),tenantId:T(\"id_tenant\",{longitud:36}).notNull().references(()=>x.id,{onDelete:\"cascade\"}),txHash:l(\"tx_hash\").notNull(),chain:l(\"cadena\").notNull(),fromAddress:l(\"from_address\"),toAddress:l(\"t o_dirección\"), importe: l(\"importe\").notNull(), moneda: l(\"moneda\").notNull(), cuota: l(\"cuota\"), cuotaUsd: l(\"cuota_usd\"), estado: l(\"estado\").notNull().default(\"pendiente\"), tipo: l(\"tipo\").notNull().default(\"nativo\"), númerodebloque: E(\"númerodebloque\"), confirmaciones: E(\"confirmaciones\").default(0 ), metadatos: F(\"metadatos\"), creado en: R(\"creado_en\"). predeterminado ahora(). no nulo()}, n => [v(\"idx_de_inquilino_de_transacciones\"). en(n. ID_de_inquilino), v(\"idx_de_cadena_de_transacciones\"). en(n. cadena), v(\"idx_de_hash_de_transacciones\"). en(n. Hash_de_tx), v(\"idx_de_estado_de_transacciones\"). en(n. estado)]), K = q(\"webhooks\", {id: T(\"id\", {le longitud: 36}). claveprimaria(). predeterminado(M`gen_random_uuid()`), ID_inquilino: T(\"ID_inquilino\",{longitud: 36}). no nulo(). referencias(()=>x.id,{onDelete:\"cascada\"}), URL: l(\"URL\"). no nulo(), eventos: l(\"eventos\"). matriz(). no nulo(), secreto_hmac: l(\"secreto_hmac\"). no nulo(), activo: Ve(\"activo\"). predeterminado(!0), reintentarCou nt:E(\"retry_count\").default(0),lastTriggered:R(\"last_triggered\"),lastStatus:E(\"last_status\"),metadatos:F(\"metadatos\"),createdAt:R(\"created_at\").defaultNow().notNull()},n=>[v(\"webhooks_tenant_idx\").on(n.tenantId),v(\"webhooks_active_idx\").on(n.active)]),W=q(\"api_usage\",{id:T(\"id \",{longitud:36}).primaryKey().default(M`gen_random_uuid()`),tenantId:T(\"tenant_id\",{longitud:36}).notNull().references(()=>x.id,{onDelete:\"cascade\"}),endpoint:l(\"endpoint\").notNull(),method:l(\"method\").notNull(),chain:l(\"chain\"),action:l(\"action\").notNull(),units:he(\"units\").notN ull(), créditos:he(\"créditos\").notNull(), código de estado:E(\"código de estado\").notNull(), id de solicitud:T(\"id de solicitud\",{longitud:36}).notNull(), tiempo de respuesta Ms:E(\"ms de tiempo de respuesta\"), metadatos:F(\"metadatos\"), marca de tiempo:R(\"marca de tiempo\").defaultNow().notNull()}, n=>[v(\"id de inquilino de uso de API\").on(n.id de inquilino),v(\"api_usage_timestamp_idx\").on(n.timestamp),v(\"api_usage_action_idx\").on(n.action)]),Q=q(\"agregaciones_de_facturación\",{id:T(\"id\",{longitud:36}).primaryKey().default(M`gen_random_uuid()`),tenantId:T(\"id_de_teniente\",{longitud:36}).notNull().references(()=>x.id,{onDelete:\"cascade\"}),periodo:l(\"periodo\").notNull(),periodType:l(\"tipo_de_periodo\").notNull().default(\"diario\"),totalUnits:he(\"unidades_totales\").notNull().def ault(0), totalCredits:he(\"total_créditos\").notNull().default(0), costUsd:he(\"costo_usd\").notNull().default(0), breakdown:F(\"break\"), createdAt:R(\"created_at\").defaultNow().notNull()}, n=>[v(\"billing_tenant_period_idx\").on(n.tenantId,n.period)]), te=q(\"audit_logs\",{id:T(\"id\",{length:36}).primaryKey().default(M`gen_random_uuid()`), tenantId:T(\"tenant_id\",{length:36}).references(()=>x.id,{onDelete:\"set null\"}),ID_usuario:l(\"id_usuario\"),acción:l(\"acción\").notNull(),recurso:l(\"recurso\").notNull(),ID_recurso:l(\"id_recurso\"),cambios:F(\"cambios\"),Dirección_IP:l(\"dirección_IP\"),Agente_usuario:l(\"agente_usuario\"),ID_solicitud:T(\"id_solicitud\",{longitud:36}),marca_de_tiempo:R(\"marca_de_tiempo\").defaultNow().notNull()},n=>[v(\"audit_logs_tenant_idx\").on(n.Id_tenant),v(\"audit_logs_timestamp_idx\").on(n.marca_de_tiempo),v(\"audit _logs_action_idx\").on(n.action)]),ht=pt(x,({muchos:n})=>({direcciones:n(S),transacciones:n(j),webhooks:n(K),cuentasvirtuales:n(_),apiUsage:n(W),agregacionesdefacturación:n(Q),registrosdeauditoría:n(te),monederosprincipales:n(z),criptotransacciones:n(de)})),It=Y(z).omit({id:!0,createdAt:!0,updatedAt:!0}),wt=Y(_).omit({id:!0,createdAt:!0,updatedAt:!0}),At=Y(de).omit({id:!0,createdAt:!0,executedAt:!0,confirmedAt:!0}),bt=Y(x).omit({ id:!0,createdAt:!0,updatedAt:!0}),vt=Y(S).omit({id:!0,createdAt:!0,updatedAt:!0,deletedAt:!0}),kt=Y(j).omit({id:!0,createdAt:!0}),Tt=Y(K).omit({id:!0,createdAt:!0}),_t=Y(W).omit({id:!0,timestamp:!0}),xt=Y(te).omit({id:!0,timestamp:!0}),H={starter:{chains:[\"bitcoin\",\"ethereum\",\"solana\"],maxAddresses:50,maxWebhooks:1,maxVirtualAccounts:0,rateLimit:10,monthlyQuota:1e4,kmsAllowed:!1,archivalAccess :!1, días de retención: 1}, escala: {cadenas: [\"bitcoin\",\"ethereum\",\"solana\",\"polígono\",\"tron\",\"bsc\",\"ripple\",\"cardano\"], direcciones máximas: 1e3, webhooks máximos: 10, cuentas virtuales máximas: 5, límite de tasa: 100, cuota mensual: 1e5, km permitidos:!0, acceso de archivo:!1, días de retención: 7}, empresa: {cadenas: [\"bitcoin\",\"ethereum\",\"solana\",\"polígono\",\"tron\",\"bsc\",\"ripple\",\"cardano\",\"near\",\"polkadot\",\"avalancha\",\"arbitro\",\"optimismo\",\"base\",\"fantasma\",\"cronos\",\"cosmos\",\"algorand\"],máximo de direcciones: -1,máximo de webhooks: -1,máximo de cuentas virtuales: 50,límite de tasa: 1e3,cuota mensual: -1,km permitidos: !0,acceso de archivo: !0,días de retención: 30}},le={creación de dirección:{unidades: 1,costo: 0,001},consulta de saldo:{unidades: 0,costo: 5e-4},saldo de token:{unidades: 1,costo: 0,001},metadatos nft:{unidades: 2,costo: 0,002},tx_br oadcast_btc:{unidades: 50, costo: 0,05}, tx_broadcast_eth:{unidades: 10, costo: 0,01}, tx_broadcast_other:{unidades: 10, costo: 0,01}, tx_history:{unidades: 2, costo: 0,002}, webhook_subscription:{unidades: 0,02, costo: 0,02}, va_create:{unidades: 100, costo: 0,1}, va_transfer:{unidades: 5, costo: 0,005}, tipo de cambio:{unidades: 0,1, costo: 1e-4}, web3_resolve:{unidades: 1, costo: 0,001}, malicioso_check:{unidades: 2, costo: 0,002}, rpc_standard:{u nits:2,costo:2e-4},rpc_eth_call:{unidades:5,costo:5e-4},rpc_debug:{unidades:50,costo:.005}},Be=[\"TRANSACCIÓN_DIRECCIÓN\",\"SALDO_DIRECCIÓN\",\"TRANSACCIÓN_NATIVA_ENTRANTE\",\"TRANSACCIÓN_NATIVA_SALIENTE\",\"TRANSACCIÓN_FUNGIBLE_ENTRANTE\",\"TRANSACCIÓN_FUNGIBLE_SALIENTE\",\"TRANSACCIÓN_NFT_ENTRANTE\",\"TRANSACCIÓN_NFT_SALIENTE\",\"TRANSACCIÓN_MULTITOKEN_ENTRANTE\",\"TRANSACCIÓN_MULTITOKEN_SALIENTE\",\"TRANSACCIÓN_FALLIDA\",\"CUOTA_PAGADA\",\"REGISTRO_DE_CONTRATO _EVENTO\"],me=[{id:\"bitcoin\",nombre:\"Bitcoin\",símbolo:\"BTC\",icono:\"\\u20BF\"},{id:\"ethereum\",nombre:\"Ethereum\",símbolo:\"ETH\",icono:\"\\u039E\"},{id:\"solana\",nombre:\"Solana\",símbolo:\"SOL\",icono:\"\\u25CE\"},{id:\"polígono\",nombre:\"Polígono\",símbolo:\"MATIC\",icono:\"\\u2B21\"},{id:\"tron\",nombre:\"Tron\",símbolo:\"TRX\",icono:\"\\u2666\"},{id:\"bsc\",nombre:\"BNB Cadena\", símbolo:\"BNB\", icono:\"\\u25C6\"},{id:\"ripple\", nombre:\"XRP Ledger\", símbolo:\"XRP\", icono:\"\\u2715\"},{id:\"cardano\", nombre:\"Cardano\", símbolo:\"ADA\", icono:\"\\u20B3\"},{id:\"near\", nombre:\"NEAR\", símbolo:\"NEAR\", icono:\"\\u24C3\"},{id:\"polkadot\", nombre:\"Polkadot\", símbolo:\"DOT\", icono:\"\\u25CF\"},{id:\"avalanche\", nombre:\"Avalanche\", símbolo:\"AVAX\", icono:\"\\u25B2\"},{id:\"arb itrum\", nombre:\"Arbitrum\", símbolo:\"ARB\", icono:\"\\u25C8\"},{id:\"optimism\", nombre:\"Optimism\", símbolo:\"OP\", icono:\"\\u2295\"},{id:\"base\", nombre:\"Base\", símbolo:\"ETH\", icono:\"\\u25EF\"},{id:\"fantom\", nombre:\"Fantom\", símbolo:\"FTM\", icono:\"\\u25C7\"},{id:\"cronos\", nombre:\"Cronos\", símbolo:\"CRO\", icono:\"\\u25CE\"},{id:\"cosmos\",nombre:\"Cosmos\",símbolo:\"ATOM\",icono:\"\\u269B\"},{id:\"algorand\",nombre:\"Algorand\",símbolo:\"ALGO\",icono:\"\\u24B6\"}]});var oe={};xe(oe,{db:()=>f,pool:()=>Ye});import{Pool como St,neonConfig como Pt}desde\"@neondatabase/serverless\";import{drizzle como Rt}desde\"drizzle-orm/neon-serverless\";import Et desde\"ws\";var Ye,f,V=fe(()=>{\"use strict\";D();Pt.webSocketConstructor=Et;if(!process.env.DATABASE_URL)throw new Error(\"DATABASE_URL debe ser ¿Olvidaste aprovisionar una base de datos?\"); Ye=new St({connectionString:process.env.DATABASE_URL}), f=Rt({client:Ye,schema:J})}); function jt(n){return!n||typeof n!=\"string\"||n.length<32?!1:/^[a-zA-Z0-9_-]{32,}$/.test(n)} function Bt(){return P.state===\"open\"?Date.now()-P.lastFailure>=$e.resetTimeoutMs?(P.state=\"half-open\",P.successesInHalfOpen=0,!0):!1:!0} function Dt(){P.estado===\"semiabierto\"?(P.éxitosEnMedioApertura++,P.éxitosEnMedioApertura>=$e.umbralDeÉxitoDeAperturaMedia&&(P.estado=\"cerrado\",P.fallos=0)):P.fallos=0}función ze(){P.fallos++,P.últimoFallo=Fecha.ahora(),(P.estado===\"semiabierto\"||P.fallos>=$e.umbralDeFallo)&&(P.estado=\"abierto\")}función Ut(n,t){devolver t.EstadosReintentables.includes(n)}función Xe(n,t){devolver Math.min(t.baseDelayMs*Math.pow(2,n)+Math.random()*1e3,t.maxDelayMs)}función asíncrona Qe(n){devuelve nueva Promesa(t=>setTimeout(t,n))}función asíncrona N(n,t={},r=Kt){si(!Bt())devuelve{éxito:!1,error:\"Servicio temporalmente no disponible (disyuntor abierto)\",statusCode:503};let i=null;for(let u=0;u<=r.maxRetries;u++)try{let g=new AbortController,h=setTimeout(()=>g.abort(),3e4),s=await fetch(`${Mt}${n}`,{...t,señal:g.señal,encabezados:{\"Tipo-Contenido\":\"aplicación/json\",\"clave-x-api\":Fe||\"\",...t.encabezados}});clearTimeout(h);let a=await s.json().catch(()=>null);if(!s.ok){let e={éxito:!1,error:a?.mensaje||a?.error||`HTTP ${s.estado}`,código-estado:s.estado};if(s.estado===429){let o=s.headers.get(\"Retry-After\");o&&(e.retryAfter=parseInt(o,10)*1e3)}if(Ut(s.status,r)&&u<r.maxRetries){i=e;let o=e.retryAfter||Xe(u,r);await Qe(o);continue}return ze(),e}return Dt(),{éxito:!0,datos:a}}catch(g){let h=g.name===\"Error de cancelación\",s=g.message?.includes(\"obtener\")||g.message?.includes(\"red\"),a={éxito:!1,error:h?\"Tiempo de espera de la solicitud\":g.message||\"Red error\",statusCode:h?408:500};if((h||s)&&u<r.maxRetries){i=a,await Qe(Xe(u,r));continue}return ze(),a}return i||{éxito:!1,error:\"Se excedió el máximo de reintentos\",statusCode:500}}function Je(n){return me.find(t=>t.id===n)}var Mt,Fe,Kt,P,$e,se,B,Oe=fe(()=>{\"use strict\";D();Mt=process.env.TATUM_API_URL||\"https://api.tatum.io\",Fe=process.env.TATUM_API_KEY;Fe?jt(Fe)||console.warn(\"El formato de TATUM_API_KEY parece no ser válido; puede causar errores de API\"):console.warn(\"TATUM_API_KEY no configurado; las llamadas a la API fail\"); Kt={máx.Reintentos:3,Ms.deRetardoBase:1e3,Ms.deRetardoMax:3e4,EstadosReintentables:[408,429,500,502,503,504]}, P={fallos:0,últimoFallo:0,estado:\"cerrado\",éxitosEnMedioApertura:0}, $e={UmbralDeFallo:5,Ms.deRestablecimientoTiempoDeEspera:6e4,UmbralDeÉxitoEnMedioApertura:2}; se={bitcoin:\"bitcoin\",ethereum:\"ethereum\",solana:\"solana\",polygon:\"polígono\",tron:\"tron\",bsc:\"bsc\",ri pple:\"xrp\",cardano:\"ada\",near:\"near\",polkadot:\"dot\",avalanche:\"avax\",arbitrum:\"arbitrum-one\",optimismo:\"optimismo\",base:\"base\",fantom:\"fantom\",cronos:\"cro\",c osmos:\"atom\",algorand:\"algo\"},B={getCircuitBreakerState(){return{...P}},resetCircuitBreaker(){P.failures=0,P.lastFailure=0,P.state=\"closed\",P.successesInHalfOpen=0},async generateAddress(n){let t=se[n]||n;return N(`/v3/${t}/wallet`,{método:\"GET\"})},async getBalance(n,t){let r=se[n]||n;return[\"ethereum\",\"polígono\",\"bsc\",\"arbitrum-one\",\"optimism\",\"base\"].includes(r)?N(`/v3/${r}/account/balance/${t}`):N(r===\"bitcoin\"?`/v3/bitcoin/address/balance/${t}`:r===\"solana\"?`/v3/solana/account/balance/${t}`:`/v3/${r}/account/balance/${t}`)},async getTokens(n,t){let r=se[n]||n;devuelve N(`/v3/data/tokens?chain=${r}&addresses=${t}`)},asincrónico obtenerNFTs(n,t){let r=se[n]||n;devuelve N(`/v3/data/nfts?chain=${r}&addresses=${t}`)},asincrónico obtenerHistorialDeTransacciones(n,t,r){let i=se[n]||n,u=nuevosParámetrosDeBúsquedaDeURL;devuelve r?.TamañoDePágina&&u.set(\"TamañoDePágina\",r.TamañoDePágina.toString()),r?.Desplazamiento&&u.set(\"Desplazamiento\",r.Desplazamiento.toString()),N(`/v3/data/transacciones?chain=${i}&addresses=${t}&${u.toString()}`)},asincrónico getTransaction(n,t){let r=se[n]||n;devuelve N(`/v3/${r}/transaction/${t}`)},async estimateFee(n,t=\"TRANSFER\"){let r=se[n]||n;devuelve N(`/v3/${r}/gas/estimate`,{método:\"POST\",cuerpo:JSON.stringify({tipo:t})})},async broadcastTransaction(n,t){let r=se[n]||n;devuelve N(`/v3/${r}/broadcast`,{método:\"POST\",cuerpo:JSON.stringify({txData:t})})},async getExchangeRates(n){let t=n.join(\",\");devuelve N(`/v3/tatum/rate/${t}?basePair=USD`)}, asíncrono resolveWeb3Name(n){devuelve N(`/v3/blockchain/names/${n}`)}, asíncrono checkMaliciousAddress(n){devuelve N(`/v3/security/address/${n}`)}, asíncrono createWebhook(n){devuelve N(\"/v4/subscription\",{método:\"POST\",cuerpo:JSON.stringify(n)})}, asíncrono deleteWebhook(n){devuelve N(`/v4/subscription/${n}`,{método:\"DELETE\"})}, asíncrono getWebhooks(){devuelve N(\"/v4/subscription\")},async healthCheck(){let n=await N(\"/v3/tatum/version\"); return n.success?{success:!0, data:{status:\"healthy\", version:n.data?.version||\"v3\", circuitBreaker:{...P}}}:{...n, data:{status:\"degraded\", version:\"unknown\", circuitBreaker:{...P}}}}}});var ve={};xe(ve,{GasFeeManager:()=>Ee,gasFeeManager:()=>Le});import{eq as Ge}from\"drizzle-orm\";var Ee,Le,ge=fe(()=>{\"use strict\";V();D();Ee=class{config=null;async loadConfig(){let[t]=await f.select().from(X).limit(1);if(!t){let r={Margen predeterminado global: 40, Margen mínimo: 10, Margen máximo: 100, Anulaciones de cliente:{}, Multiplicadores de cadena de bloques:{ethereum: 1, polígono: .3, bitcoin: 1.2, solana: .1, arbitraje: .2}, Anulaciones de tipo de transacción:{retiro_cripto: 40, transferencia_de_token: 45, contrato_inteligente: 60}};return this.config=r,r}return this.config={globalDefaultMarkup:t.globalDefaultMarkup,minMarkup:t.minMarkup,maxMarkup:t.maxMarkup,clientOverrides:t.clientOverrides||{},blockchainMultipliers:t.blockchainMultipliers||{},transactionTypeOverrides:t.transactionTypeOverrides||{}},this.config}async calculateGasMarkup(t){this.config||await this.loadConfig();let r=this.config.globalDefaultMarkup;if(t.clientId&&this.config.clientOverrides[t.clientId]){let a=this.config.clientOverrides[t.clientId];if(a.expiresAt){let e=new Date(a.expiresAt);new Date<e&&(r=a.markup)}else r=a.markup}let i=this.config.transactionTypeOverrides[t.transactionType];i&&(r=i);let u=this.config.blockchainMultipliers[t.blockchain]||1;r=Math.round(r*u),r=Math.max(this.config.minMarkup,Math.min(this.config.maxMarkup,r));let g=t.gasReal*(r/100),h=t.gasReal+g,s=g;return{gasReal:t.gasReal,gasMarkupPercent:r,gasCharged:h,yourProfit:s}}async updateGlobalMarkup(t,r){t=Math.max(10,Math.min(100,t)),await f.update(X).set({globalDefaultMarkup:t,updatedAt:new Fecha,actualizadoPor:r}).donde(Ge(X.id,\"predeterminado\")),this.config=null,await this.loadConfig()}async setClientMarkup(t,r,i,u,g){this.config||await this.loadConfig();let h=this.config.clientOverrides;h[t]={markup:Math.max(10,Math.min(100,r)),reason:i,expiresAt:g?.toISOString()},await f.update(X).set({clientOverrides:h,actualizadoEn:new Fecha,actualizadoPor:u}).donde(Ge(X.id,\"predeterminado\")),this.config=null,await this.loadConfig()}async removeClientMarkup(t,r){this.config||await this.loadConfig();let i=this.config.clientOverrides;eliminar i[t],esperar f.update(X).set({clientOverrides:i,actualizadoEn:nueva Fecha,actualizadoPor:r}).where(Ge(X.id,\"predeterminado\")),this.config=null,esperar this.loadConfig()}getConfig(){devolver this.config}},Le=new Ee});var ke={};xe(ke,{CryptoGateway:()=>Ne,cryptoGateway:()=>Ht});importar Lt desde\"crypto\";importar{eq como G y como Wt} desde\"drizzle-orm\";var Ne,Ht,Te=fe(()=>{\"usar estricto\";Oe();ge();V();D();Ne=class{async createVirtualAccount(t,r){devolver(esperar f.insert(_).values({Id.inquilino:t,TipoDeCuenta:r,Saldos:JSON.stringify({})}).returning())[0]}async internalSwap(t){let r=await f.query.virtualAccounts.findFirst({where:G(_.id,t.fromAccountId)});if(!r)throw new Error(\"No se encontró la cuenta\");let i=JSON.parse(r.balances||\"{}\"),u=parseFloat(i[t.assetName]||\"0\");if(u<parseFloat(t.fromAmount))throw new Error(\"Saldo insuficiente\");let g=parseFloat(t.toAmount)*.005,h=parseFloat(t.toAmount)-g,s={...i};s[t.assetName]=(u-parseFloat(t.fromAmount)).toString(),await f.update(_).set({balances:JSON.stringify(s)}).where(G(_.id,t.fromAccountId));let a=espera f.consulta.cuentasvirtuales.findFirst({donde:G(_.id,t.toAccountId)}),e=JSON.parse(a?.balances||\"{}\");devuelve e[t.nombreDeActivo]=(parseFloat(e[t.nombreDeActivo]||\"0\")+h).toString(),espera f.update(_).set({balances:JSON.stringify(e)}).donde(G(_.id,t.toAccountId)),{txId:(espera f.insert(de).values({Id.inquilino:t.Id.inquilino,tipo:\"intercambio_interno\",escenario:t.scenario,Id.deCuenta:t.deCuenta,Id.deCuenta:t.deCuenta,Tipo.deActivo:\"cripto\",Nombre.deActivo:t.deActivo,cadena.de.blockchain:t.blockchain,importe:t.deImporte,importe.de.comisión:g.de.Cadena(),comisión.Usd:(g*45e3).de.Cadena(),estado:\"completado\"}).returning())[0].id,estado:\"completado\",deImporte:t.deImporte,de.Importe:t.de.Importe,comisión:g.de.Fijo(8),neto.Recibido:h.de.Fijo(8),ejecutadoEn:nuevaFecha().de.CadenaISO()}}asincrónico externalWithdraw(t){let r=await f.query.masterWallets.findFirst({where:Wt(G(z.assetName,t.assetName),G(z.blockchain,t.blockchain),G(z.scenario,t.scenario))});if(!r)throw new Error(`No se encontró la billetera maestra para ${t.assetName} en ${t.blockchain}`);let i=await B.estimateGas({blockchain:t.blockchain,assetType:t.assetName===r.smartContractAddress?\"token\":\"crypto\",amount:t.amount}),u=await Le.calculateGasMarkup({clientId:t.tenantId,blockchain:t.blockchain,transactionType:t.assetName===\"BTC\"?\"crypto_withdraw\":\"token_transfer\",gasReal:i.gasReal}),g=await f.query.virtualAccounts.findFirst({where:G(_.id,t.fromAccountId)}),h=JSON.parse(g?.balances||\"{}\"),s=parseFloat(h[t.assetName]||\"0\");if(s<parseFloat(t.amount))throw new Error(\"Saldo insuficiente\");h[t.assetName]=(s-parseFloat(t.amount)).toString(),await f.update(_).set({balances:JSON.stringify(h)}).where(G(_.id,t.fromAccountId));let a=`0x${Lt.randomBytes(32).toString(\"hex\")}`;return{txId:(await f.insert(de).values({Id.inquilino:t.inquilino,tipo:\"retiro_externo\",escenario:t.scenario,toExternalAddress:t.toExternalAddress,tipo.activo:\"cripto\",nombre.activo:t.nombre.activo,blockchain:t.blockchain,cantidad:t.cantidad,gasReal:u.gasReal.toString(),porcentaje.de.margen.gas:u.porcentaje.de.margen.gas,gasCargado :u.gasCharged.toString(),commissionAmount:u.yourProfit.toString(),status:\"pendiente\",txHash:a}).returning())[0].id,status:\"pendiente_de_confirmación\",txHash:a,amount:t.amount,gasReal:u.gasReal.toFixed(8),gasCharged:u.gasCharged.toFixed(8),yourProfit:u.yourProfit.toFixed(8),estimatedTime:\"12 segundos\"}}async assignMasterToClient(t,r,i){return await f.update(z).set({assignedToTenantId:r,gasMarkupPercentage:i}).where(G(z.id,t)),{success:!0,masterId:t,assignedTo:r,gasMarkup:i,assignedAt:new Date().toISOString()}}async getVirtualAccountBalance(t){let r=await f.query.virtualAccounts.findFirst({where:G(_.id,t)});if(!r)throw new Error(\"Cuenta no encontrada\");let i=JSON.parse(r.balances||\"{}\"); return{accountId:t,balances:i,totalUsd:Object.entries(i).reduce((u,[g,h])=>{let s={ETH:2500,BTC:45e3,GOLD:500,SILVER:250}; return u+parseFloat(h)*(s[g]||0)},0)}}},Ht=new Ne});import Ce de\"express\";import{z como w} de\"zod\";D();V();import{eq como A,and como Z,desc como ie,sql como De,gte como Nt,lte como Ct} de\"drizzle-orm\";var Ue=class{async getTenant(t){let[r]=await f.select().from(x).where(A(x.id,t));return r||void 0}async getTenantByApiKeyHash(t){let[r]=await f.select().from(x).where(A(x.apiKeyHash,t));return r||void 0}async getTenantByEmail(t){let[r]=await f.select().from(x).where(A(x.email,t));return r||void 0}async getAllTenants(){return f.select().from(x).orderBy(ie(x.createdAt))}async createTenant(t){let[r]=await f.insert(x).values(t).returning();return r}async updateTenant(t,r){let[i]=await f.update(x).set({...r,updatedAt:nueva fecha}).where(A(x.id,t)).returning();devolver i||void 0}async deleteTenant(t){await f.update(x).set({estado:\"eliminado\",updatedAt:nueva fecha}).where(A(x.id,t))}async getAddress(t){let[r]=await f.select().from(S).where(A(S.id,t));devolver r||void 0}async getAddressByAddress(t,r,i){let[u]=await f.select().from(S).where(Z(A(S.tenantId,t),A(S.chain,r),A(S.address,i)));devolver u||void 0}async getAddressesByTenant(t,r){let i=f.select().from(S).where(A(S.tenantId,t)),u=[A(S.tenantId,t)];devuelve r?.chain&&u.push(A(S.chain,r.chain)),r?.status&&u.push(A(S.status,r.status)),f.select().from(S).where(Z(...u)).orderBy(ie(S.createdAt)).limit(r?.limit||50).offset(r?.offset||0)}asincrónico countAddressesByTenant(t){let[r]=await f.select({count:De`count(*)`}).from(S).where(Z(A(S.tenantId,t),A(S.status,\"active\")));devuelve r?.count||0}asincrónico createAddress(t){let[r]=await f.insert(S).values(t).returning();return r}async updateAddress(t,r){let[i]=await f.update(S).set({...r,updatedAt:nueva fecha}).where(A(S.id,t)).returning();return i||void 0}async archiveAddress(t){await f.update(S).set({estado:\"archivado\",eliminadoAt:nueva fecha,updatedAt:nueva fecha}).where(A(S.id,t))}async getTransaction(t){let[r]=await f.select().from(j).where(A(j.id,t));return r||void 0}async getTransactionByHash(t,r){let[i]=await f.select().from(j).where(Z(A(j.chain,t),A(j.txHash,r)));return i||void 0}async getTransactionsByTenant(t,r){let i=[A(j.tenantId,t)];return r?.chain&&i.push(A(j.chain,r.chain)),r?.status&&i.push(A(j.status,r.status)),f.select().from(j).where(Z(...i)).orderBy(ie(j.createdAt)).limit(r?.limit||50).offset(r?.desplazamiento||0)}asincrónico createTransaction(t){let[r]=await f.insert(j).values(t).returning();devolver r}asincrónico updateTransaction(t,r){let[i]=await f.update(j).set(r).where(A(j.id,t)).returning();devolver i||void 0}asincrónico getWebhook(t){let[r]=await f.select().from(K).where(A(K.id,t));devolver r||void 0}asincrónico getWebhooksByTenant(t){devolver f.select().from(K).where(A(K.tenantId,t)).orderBy(ie(K.createdAt))}asincrónico countWebhooksByTenant(t){let[r]=await f.select({count:De`count(*)`}).from(K).where(Z(A(K.tenantId,t),A(K.active,!0)));devuelve r?.count||0}asinc createWebhook(t){let[r]=await f.insert(K).values(t).returning();devuelve r}asinc updateWebhook(t,r){let[i]=await f.update(K).set(r).where(A(K.id,t)).returning();devuelve i||void 0}asinc deleteWebhook(t){await f.delete(K).where(A(K.id,t))}asinc getVirtualAccount(t){let[r]=await f.select().from(_).where(A(_.id,t));devuelve r||void 0}asinc obtenerCuentasVirtualesPorInquilino(t){devolver f.seleccionar().de(_).donde(A(_.IdInquilino,t)).ordenarPor(ie(_.createdAt))}asincrónico contarCuentasVirtualesPorInquilino(t){let[r]=await f.seleccionar({count:De`count(*)`}).de(_).donde(Z(A(_.IdInquilino,t),A(_.estado,\"activo\")));devolver r?.count||0}asincrónico crearCuentaVirtual(t){let[r]=await f.insertar(_).valores(t).devolver();devolver r}asincrónico actualizarCuentaVirtual(t,r){let[i]=await f.actualizar(_).set(r).donde(A(_.id,t)).devolver();devolver i||void 0}asincrónico recordApiUsage(t){let[r]=await f.insert(W).values(t).returning();return r}async getApiUsageByTenant(t,r,i){return f.select().from(W).where(Z(A(W.tenantId,t),Nt(W.timestamp,r),Ct(W.timestamp,i))).orderBy(ie(W.timestamp))}async getApiUsageStats(t,r,i){let u=await this.getApiUsageByTenant(t,r,i),g={},h={},s=0,a=0;for(let e of u)s+=e.unidades,a+=e.créditos,g[e.punto final]=(g[e.punto final]||0)+1,e.cadena&&(h[e.cadena]=(h[e.cadena]||0)+1);return{totalRequests:u.length,totalUnits:s,totalCredits:a,byEndpoint:g,byChain:h}}async getBillingAggregation(t,r){let[i]=await f.select().from(Q).where(Z(A(Q.tenantId,t),A(Q.periodo,r)));return i||void 0}async upsertBillingAggregation(t){let r=await this.getBillingAggregation(t.tenantId,t.periodo);if(r){let[i]=await f.update(Q).set(t).where(A(Q.id,r.id)).returning();return i}else{let[i]=await f.insert(Q).values(t).returning();return i}}async createAuditLog(t){let[r]=await f.insert(te).values(t).returning();return r}async getAuditLogsByTenant(t,r=100){return f.select().from(te).where(A(te.tenantId,t)).orderBy(ie(te.timestamp)).limit(r)}},p=new Ue;Oe();import ce from\"crypto\";D();var Ze=process.env.ADMIN_API_KEY;function Ie(){let n=`tatum_${ce.randomBytes(28).toString(\"hex\")}`,t=n.substring(0,16),r=tt(n);devolver{clave:n,prefijo:t,hash:r}}función tt(n){devolver ce.createHash(\"sha256\").update(n).digest(\"hex\")}función we(){devolver ce.randomBytes(32).toString(\"hex\")}función st(){devolver`req_${ce.randomBytes(16).toString(\"hex\")}`}función asíncrona b(n,t,r){n.requestId=st(),t.setHeader(\"X-Request-ID\",n.requestId);deje que i=n.headers[\"x-api-key\"]; if(!i)return t.status(401).json({success:!1,error:\"Clave API faltante\",requestId:n.requestId});let u=tt(i),g=await p.getTenantByApiKeyHash(u); if(!g)return t.status(401).json({success:!1,error:\"Clave API no válida\",requestId:n.requestId}); if(g.status!==\"activo\")return t.status(403).json({success:!1,error:`La cuenta es ${g.status}`,requestId:n.requestId});n.tenant=g,r()}function $(n,t,r){n.requestId=st(),t.setHeader(\"X-Request-ID\",n.requestId);let i=n.headers[\"x-admin-key\"];if(!Ze)return t.status(503).json({éxito:!1,error:\"API de administración no configurada\",requestId:n.requestId});if(!i)return t.status(401).json({éxito:!1,error:\"Falta la clave de API de administración\",requestId:n.requestId});let u=ce.createHash(\"sha256\").update(i).digest(\"hex\"),g=ce.createHash(\"sha256\").update(Ze).digest(\"hex\");if(!ce.timingSafeEqual(Buffer.from(u),Buffer.from(g)))return t.status(401).json({éxito:!1,error:\"Clave de API de administrador no válida\",requestId:n.requestId});n.isAdmin=!0,r()}var et=new Map;function k(n,t,r){if(!n.tenant)return r();let i=n.tenant.id,u=Date.now(),g=1e3,h=et.get(i);(!h||h.resetAt<u)&&(h={count:0,resetAt:u+g},et.set(i,h)),h.count++;let s=n.tenant.rateLimit,a=Math.max(0,sh.count);if(t.setHeader(\"X-RateLimit-Límite\",s),t.setHeader(\"X-RateLimit-Restante\",a),t.setHeader(\"X-RateLimit-Restablecer\",Math.ceil(h.resetAt/1e3)),h.count>s)return t.status(429).json({éxito:!1,error:\"Límite de tasa excedido\", requestId:n.requestId,retryAfter:Math.ceil((h.resetAt-u)/1e3)});r()}función en(n){return(t,r,i)=>{if(!t.tenant)return r.status(401).json({éxito:!1,error:\"Se requiere autenticación\", requestId:t.requestId});let u=H[t.tenant.tier];if(!u)return r.status(403).json({éxito:!1,error:\"Configuración de nivel no válida\", requestId:t.requestId});if(n===\"kms\"&&!u.kmsAllowed)return r.status(403).json({éxito:!1,error:\"KMS no está disponible en Su nivel. Actualice a Scale o Enterprise.\",requestId:t.requestId,upgrade:!0});if(n===\"archival\"&&!u.archivalAccess)return r.status(403).json({success:!1,error:\"El acceso a archivos no está disponible en su nivel. Actualice a Enterprise.\",requestId:t.requestId,upgrade:!0});i()}}function Ae(n,t,r){if(!n.tenant)return r();let i=n.params.chain||n.body?.chain;if(!i)return r();let g=H[n.tenant.tier]?.chains||n.tenant.allowedChains;if(!g.includes(i))return t.status(403).json({success:!1,error:`La cadena '${i}' no está disponible en su nivel`,allowedChains:g,requestId:n.requestId,upgrade:!0});r()}D();función asíncrona nt(){if(!process.env.SEED_DEMO_DATA)return null;console.log(\"Comprobando si hay un inquilino de demostración...\");let n=await p.getTenantByEmail(\"demo@tatum-gateway.io\");if(n)return console.log(\"El inquilino de demostración ya existe\"),n;console.log(\"Creando inquilino de demostración...\"); let{prefix:t,hash:r}=Ie(),i=H.scale,u=await p.createTenant({name:\"Cuenta de demostración\",email:\"demo@tatum-gateway.io\",tier:\"scale\",status:\"active\",apiKeyPrefix:t,apiKeyHash:r,hmacSecret:we(),allowedChains:i.chains,maxAddresses:i.maxAddresses,maxWebhooks:i.maxWebhooks,maxVirtualAccounts:i.maxVirtualAccounts,rateLimit:i.rateLimit,monthlyQuota:i.monthlyQuota,companyName:\"Demostración de Tatum Gateway\",website:\"https://tatum.io\"});console.log(\"Inquilino de demostración creado:\",u.id),await p.createAuditLog({Id.inquilino:u.id,acción:\"inquilino.creado\",recurso:\"inquilino\",Id.recurso:u.id,cambios:{nivel:\"escala\",origen:\"semilla\"}});para(dejar g=0;g<10;g++)esperar p.recordApiUsage({Id.inquilino:u.id,punto final:`/api/v1/${[\"direcciones\",\"saldos\",\"tokens\",\"transacciones\"][g%4]}`,método:[\"OBTENER\",\"POST\"][g%2],cadena:[\"ethereum\",\"bitcoin\",\"solana\",\"polígono\"][g%4],acción:[\"saldo consulta_de_ance\",\"creación_de_dirección\",\"saldo_de_token\",\"historial_de_transacciones\"][g%4],unidades:[.5,1,1,2][g%4],créditos:[5e-4,.001,.001,.002][g%4],código_de_estado:200,id_de_solicitud:`demo_${g}`,tiempo_de_respuestaMs:50+Math.floor(Math.random()*100)});retorno console.log(\"¡Datos de uso de demostración sembrados!\"),u}D();función O(n){return async(t,r,i)=>{if(!t.tenant)return i();let u=le[n];t.metered={acción:n,unidades:u.units,créditos:u.cost};let g=r.json.bind(r);r.json=h=>{let s=Date.now();return p.recordApiUsage({Id.inquilino:t.id.inquilino, punto final:t.ruta, método:t.método, cadena:t.params.cadena||t.cuerpo?.cadena||nulo, acción:n, unidades:u.unidades, créditos:u.costo, código de estado:r.código de estado, Id.solicitud:t.id.solicitud, tiempo de respuesta:Fecha.ahora()-s, metadatos:{agente-usuario:t.encabezados[\"agente-usuario\"], ip:t.ip}}).catch(consola.error),h&&tipo de h==\"objeto\"&&(h.meta={...h.meta, Id.solicitud:t.id.solicitud, marca de tiempo:nueva Fecha().toISOString(),medido:{acción:n,unidades:u.unidades,créditos:u.costo}}),g(h)},i()}}función asíncrona be(n){let t=nueva fecha,r=nueva fecha(t.getFullYear(),t.getMonth(),1),i=await p.getApiUsageStats(n,r,t);return{totalRequests:i.totalRequests,totalUnits:i.totalUnits,totalCredits:i.totalCredits,costUsd:i.totalCredits}}función asíncrona Se(n,t){if(t===-1)return{permitido:!0,usado:0,restante:-1,porcentajeUsado:0};let r=await ser(n),i=Math.floor(r.totalUnits),u=ti,g=i/t*100;devolver{permitido:u>0,usado:i,restante:Math.max(0,u),porcentajeUsado:Math.min(100,g)}}función ae(n,t,r){si(!n.inquilino)devolver r();Se(n.inquilino.id,n.inquilino.cuotamensual).entonces(i=>{si(t.setHeader(\"X-Cuota-Usada\",i.usada),t.setHeader(\"X-Cuota-Restante\",i.restante),t.setHeader(\"X-Cuota-Porcentaje\",Math.round(i.porcentajeUsado)),!i.permitido)devolver t.status(429).json({success:!1,error:\"Cuota mensual excedida\",requestId:n.requestId,quota:{used:i.used,limit:n.tenant.cuotamensual,porcentajeUsado:i.porcentajeUsado},actualización:!0});r()}).catch(()=>r())}D();importar Ft desde\"crypto\";var $t=1e5,Ot=32,qt=\"sha256\",ne=null,pe=class n{secretomaestro;versión;createdAt;estático SALT_PREFIXES={claveprivada:\"kms:clave_privada:v1\",carteramaestra:\"kms:cartera_maestra:v1\",secretohmac:\"kms:secretohmac:v1\",derivacióndeclaveapi:\"kms:claveapi:v1\",cifradodesesión:\"kms:sesión:v1\"};constructor(t,r=1){if(!t||t.length<32)arrojar nuevo Error(\"El secreto maestro debe ser al menos 32 bytes (usar: openssl rand -hex 16)\");this.masterSecret=t,this.version=r,this.createdAt=new Date,t.length<64&&console.warn(\"\\u26A0\\uFE0F ADVERTENCIA: El secreto del KMS maestro tiene menos de 64 bytes. Considere usar: openssl rand -hex 32\")}static initialize(t){let r=t||process.env.MASTER_KMS_SECRET||process.env.SESSION_SECRET;if(!r)throw new Error(\"Variable de entorno MASTER_KMS_SECRET no establecida. Generar con: openssl rand -hex 32\");return ne||(ne=new n(r),console.log(\"\\u2705 KMS inicializado con secreto maestro\"),ne)}static getInstance(){return ne||(ne=n.initialize()),ne}deriveKey(t,r=\"\"){let i=n.SALT_PREFIXES[t];if(!i)throw new Error(`Tipo de clave desconocida: ${t}`);let u=Buffer.from(`${i}:${r}`);return{key:Ft.pbkdf2Sync(this.masterSecret,u,$t,Ot,qt),version:this.version,keyType:t}}derivePrivateKeyEncryptionKey(t){return this.deriveKey(\"privateKey\",t).key}deriveMasterWalletKey(t){return this.deriveKey(\"masterWallet\",t).key}deriveHmacKey(t){return this.deriveKey(\"hmacSecret\",t).key}deriveSessionEncryptionKey(t){return this.deriveKey(\"sessionEncryption\",t).key}getConfig(){return{masterSecret:\"[CENSURADO]\",version:this.version,createdAt:this.createdAt}}rotate(t){let r=new n(t,this.version+1);return ne=r,console.log(`\\u2705 KMS rotado a la versión ${r.version}`),r}static test(){try{let t=n.getInstance(),r=t.deriveKey(\"privateKey\",\"test-wallet-1\"),i=t.deriveKey(\"privateKey\",\"test-wallet-1\");if(r.key.toString(\"hex\")!==i.key.toString(\"hex\"))throw new Error(\"La derivación de la clave KMS no es determinista\");let u=t.deriveKey(\"privateKey\",\"test-wallet-2\");if(r.key.toString(\"hex\")===u.key.toString(\"hex\"))throw new Error(\"Colisión de derivación de clave KMS detectada\");return console.log(\"\\u2705 Autoprueba de KMS aprobada\"),!0}catch(t){return console.error(\"\\u274C Autoprueba de KMS fallida:\",t),!1}}};try{pe.initialize()}catch(n){console.warn(\"\\u26A0\\uFE0F Advertencia de inicialización de KMS:\",n)}import qe from\"crypto\";var Pe=\"aes-256-gcm\",Re=32,Gt=16;function rt(n,t,r){if(t.length!==Re)throw new Error(`La clave de cifrado debe ser de ${Re} bytes`);let i=qe.randomBytes(Gt),u=qe.createCipheriv(Pe,t,i);r&&u.setAAD(Buffer.from(r));let g=Buffer.concat([u.update(n,\"utf8\"),u.final()]),h=u.getAuthTag();return{ciphertext:g.toString(\"hex\"),iv:i.toString(\"hex\"),authTag:h.toString(\"hex\"),algorithm:Pe}}function ot(n,t,r){if(t.length!==Re)throw new Error(`La clave de cifrado debe tener ${Re} bytes`);if(n.algorithm!==Pe)throw new Error(`Algoritmo no compatible: ${n.algorithm}`);let i=Buffer.from(n.iv,\"hex\"),u=Buffer.from(n.ciphertext,\"hex\"),g=Buffer.from(n.authTag,\"hex\"),h=qe.createDecipheriv(Pe,t,i);r&&h.setAAD(Buffer.from(r)),h.setAuthTag(g);try{return Buffer.concat([h.update(u),h.final()]).toString(\"utf8\")}catch{throw new Error(\"Error de descifrado: los datos pueden estar dañados o alterados\")}}import{sql como Vt}desde\"drizzle-orm\";import{webcrypto como it}desde\"crypto\";var Yt=w.object({nombre:w.string().min(2),correo electrónico:w.string().correo electrónico(),nivel:w.enum([\"starter\",\"scale\",\"enterprise\"]).predeterminado(\"starter\"),nombreDeEmpresa:w.string().opcional(),sitio web:w.string().url().opcional(),correo electrónico de facturación:w.string().correo electrónico().opcional()}),zt=w.object({cadena:w.string(),etiqueta:w.string().opcional(),etiquetas:w.array(w.string()).opcional(),URLdelwebhook:w.string().url().opcional()}),Xt=w.object({url:w.string().url(),eventos:w.array(w.enum(Be)).min(1)});función asíncrona ct(n,t){nt().catch(console.error),t.get(\"/\",(s,a)=>{a.json({name:\"Tatum API Gateway\",version:\"1.0.0\",description:\"API Gateway de blockchain de nivel empresarial compatible con más de 130 blockchains\",status:\"running\",documentation:\"GET /api/docs | GET /api/docs/model | GET /api/docs/examples\",quickStart:\"1. Obtener la clave API del administrador | 2. Agregar el encabezado 'x-api-key: YOUR_KEY' | 3. Enviar por POST a /api/tenants para registrarse\",endpoints:{health:\"GET /api/health\",pricing:\"GET /api/pricing\",chains:\"GET /api/chains\",tenants:\"GET /api/tenants | POST /api/inquilinos\", direcciones:\"GET /api/v1/direcciones | POST /api/v1/direcciones\", transacciones:\"GET /api/v1/transacciones\", webhooks:\"POST /api/v1/webhooks | GET /api/v1/webhooks\", puerta de enlace:\"POST /api/v1/puerta de enlace/cuentas-virtuales | GET /api/v1/puerta de enlace/cuentas-virtuales | POST /api/v1/puerta de enlace/intercambio | POST /api/v1/puerta de enlace/retiro\", administrador:\"GET /api/admin/configuración-gas | PUT /api/admin/configuración-gas/global | GET /api/admin/ingresos | GET /api/admin/transacciones\", rwa:\"POST /api/v1/rwa/tokens | GET /api/v1/rwa/tokens | POST /api/v1/rwa/tokens/:id/transfer\"},businessModel:{type:\"Puerta de enlace API de doble panel (100 % de ingresos de administración)\",panels:{cryptoPanel:{description:\"Control de billetera maestra con sistema de cuentas virtuales\",revenueStreams:{internalSwaps:\"0,5 % de comisión (sin comisiones de gas)\",gasMarkup:\"40 % de margen configurable sobre las comisiones de gas\",setupFees:\"$500 por cliente de RWA\"},annualRevenue:\"$204K (Y1) \\u2192 $1.02M (Y2) \\u2192 $2.04M (Y3)\"}, rwaPanel:{description:\"Infraestructura de tokenización de activos del mundo real\",revenueStreams:{setupFees:\"$500 por token (pago único)\",nnualFees:\"$200 por token al año\",tradingCommissions:\"0.5% del volumen total de operaciones (100% para administración)\"},annualRevenue:\"$654K (Y1) \\u2192 $8.07M (Y2) \\u2192 $60.21M (Y3)\"}},profitMargins:\"82.5% (Y1) \\u2192 91.2% (Y2) \\u2192 96,8 % (año 3)\", totalProjections:{año 1:\"$858 000\", año 2:\"$9,09 000\", año 3:\"$62,25 000\"}}, auth:{type:\"Clave API + HMAC\", method:\"x-api-key header (Tatum v3 recommended)\", example:\"curl -H 'x-api-key: YOUR_API_KEY' https://api.example.com/api/v1/...\", documentation:\"https://docs.tatum.io/docs/authentication\"}, rateLimit:\"Por nivel: Starter 10/s, Scale 100/s, Enterprise 1000/seg\",docs:\"https://api.tatum.io/docs\",github:\"https://github.com/MasterFital/tatum-api-gateway\"})}),t.get(\"/api/docs/model\",(s,a)=>{a.json({title:\"Tatum API Gateway - Modelo de Negocio\",introduction:\"Arquitectura de doble panel que genera el 100% de ingresos administrativos mediante el trading de criptomonedas y la tokenización de RWA\",panels:{crypto:{name:\"Panel CRYPTO (100% de tus ingresos)\",description:\"Controlas las billeteras maestras (BTC, ETH, SOL, MATIC). Los clientes operan a través de cuentas virtuales.\",how_it_works:{step1:\"El administrador crea billeteras maestras mediante POST /api/admin/master-wallets\",step2:\"Los clientes crean cuentas virtuales mediante POST /api/v1/gateway/virtual-accounts\",paso 3:\"Los clientes pueden intercambiar internamente (comisión del 0,5 % para usted) o retirar externamente (margen de beneficio del 40 %)\",paso 4:\"El administrador registra todos los ingresos mediante GET /api/admin/revenue\"},revenue_streams:{internal_swaps:{description:\"El cliente intercambia BTC \\u2192 ETH\",fee:\"0,5 % del importe del intercambio\",gas_cost:\"Cero (interno)\",admin_profit:\"100 % de la comisión\",example:\"El cliente intercambia 1 ETH \\u2192 0,02 BTC | Comisión: 0,0001 BTC (100 % para el administrador)\"},gas_markup:{description:\"El cliente retira criptomonedas a una billetera externa\",fee:\"Margen de beneficio del 40 % sobre el gas real costo\", ejemplo:\"Gas Bitcoin: $3 reales | Cobras: $4.20 | Tu ganancia: $1.20 (40%)\"}}, proyecciones:{año1:{volumen:\"Promedio de 1 millón de USD/mes\", swaps mensuales:\"5K \\xD7 0.5% = $25K\", gas mensual:\"Retiros de 10K \\xD7 $3 \\xD7 40% = $12K\", total mensual:\"$17K\", anual:\"$204K\"}, año2:{volumen:\"Promedio de 5 millones de USD/mes\", anual:\"$1.02M\"}, año3:{volumen:\"Promedio de 10 millones de USD/mes\", anual:\"$2.04M\"}}}, rwa:{nombre:\"Panel RWA (100% Tus Ingresos + Tarifas)\", descripción:\"Los clientes emiten tokens. Tú proporcionas la infraestructura. Te quedas con el 100% de las tarifas y comisiones de trading.\", cómo_funciona:{paso 1:\"El cliente solicita la creación de un token: POST /api/v1/rwa/tokens\", paso 2:\"Cobras $500 de comisión de configuración + implementación del contrato inteligente\", paso 3:\"El token se activa. Los clientes operan internamente (comisión del 0,5 % para ti)\", paso 4:\"Comisión anual de mantenimiento de $200 por token\", paso 5:\"Todos los retiros externos tienen un margen de gas del 40 % (para ti)\", paso 6:\"Seguimiento de los ingresos mediante GET /api/admin/rwa-revenue\"},revenue_streams:{setup_fees:{description:\"Comisión única por token lanzado\",amount:\"$500\",frequency:\"Por token\"},annual_fees:{description:\"Mantenimiento anual por token activo\",amount:\"$200\",frequency:\"Por token por año\"}, comisiones_comerciales:{descripción:\"0.5% del volumen total de operaciones de tokens (100% para el administrador)\", porcentaje:\"0.5%\", ejemplo:\"Volumen de tokens: $100,000/mes | Su comisión: $500/mes = $6,000/año por token\"}, margen_gas:{descripción:\"40% de margen en las comisiones de gas para retiros externos\", porcentaje:\"40%\"}}, beneficios_del_cliente:{beneficio1:\"Infraestructura de tokenización (su costo: ~$0.10 por token)\", beneficio2:\"Mercado listo para usar\", beneficio3:\"Liquidez instantánea (operadores del día 1)\", beneficio4:\"Seguridad y cumplimiento a su cargo\", pago_del_cliente:\"$500 de configuración + $200/año solo\"}, proyecciones:{año1:{tokens:\"20 tokens nuevos\", tarifas_de_configuración:\"20 \\xD7 $500 = $10K\", tarifas_anuales:\"20 \\xD7 $200 = $4K\", comisiones_de_operación:\"0.5% de un volumen de ~$100M = $500K\", total:\"$514K\"}, año2:{tokens:\"100 tokens en total\", tarifas_de_configuración:\"100 \\xD7 $500 = $50K\", tarifas_anuales:\"100 \\xD7 $200 = $20K\", comisiones_de_operación:\"0.5% de un volumen de ~$1.6B = $8M\",total:\"$8.07M\"},año3:{tokens:\"300 tokens en total\",tarifas_de_configuración:\"300 \\xD7 $500 = $150K\",tarifas_anuales:\"300 \\xD7 $200 = $60K\",comisiones_de_comercio:\"0.5% de un volumen de ~$12B = $60M\",total:\"$60.21M\"}}}},resumen_de_ingresos:{título:\"Ingresos combinados (Cripto + RWA)\",año 1:{cripto:\"$204K\",rwa:\"$654K\",total:\"$858K\",margen:\"82.5%\"},año 2:{cripto:\"$1.02M\",rwa:\"$8.07M\",total:\"$9.09M\",margen:\"91.2%\"},año 3:{cripto:\"$2.04M\",rwa:\"$60.21M\",total:\"$62.25M\",margen:\"96.8%\"}},puntos_clave:[\"El 100% de todos los ingresos van al administrador (usted)\",\"Los clientes obtienen acceso a la infraestructura, no a la repartición de ingresos\",\"Las tarifas de configuración son ingresos inmediatos\",\"Las comisiones de trading escalan infinitamente con el volumen\",\"El margen de gas es puro beneficio (costo mínimo de infraestructura)\",\"Costo de adquisición de clientes cero (los clientes se traen a sí mismos)\"]})}),t.get(\"/api/docs/examples\",(s,a)=>{a.json({title:\"Tatum API Gateway - Ejemplos de uso\",autenticación: {descripción:\"Todas las solicitudes requieren el encabezado x-api-key\",ejemplo:\"curl -H 'x-api-key: YOUR_API_KEY' https://api.example.com/api/v1/...\",encabezados:{\"x-api-key\":\"Su clave API del administrador\",\"Content-Type\":\"application/json\"}},crypto_examples: {título:\"Ejemplos del panel CRYPTO\",create_virtual_account: {descripción:\"El cliente crea una cuenta virtual para almacenar criptomonedas\",endpoint:\"POST /api/v1/gateway/virtual-accounts\",solicitud:{tipoDeCuenta:\"individual\"},respuesta:{éxito:!0,cuentaVirtual:{id:\"va-123\",identificadorDeInquilino:\"cliente-1\",tipoDeCuenta:\"individual\",saldos:{BTC:\"0\",ETH:\"0\",SOL:\"0\"},estado:\"activo\"}}},interno_swap_0_5_percent:{descripción:\"El cliente intercambia BTC por ETH (comisión del 0,5 % para el administrador)\",punto final:\"POST /api/v1/gateway/swap\", solicitud: {fromAccountId:\"va-123\", fromAsset:\"BTC\", toAsset:\"ETH\", importe:\"1.0\"}, respuesta: {éxito:!0, intercambio: {id:\"swap-456\", fromAsset:\"BTC\", toAsset:\"ETH\", importe:\"1.0\", comisión:\"0.005 BTC (0.5% para el administrador)\", estado:\"completado\"}, nota:\"Sin comisiones de gas, comisión del 0.5% aplicada\"}}, external_withdraw_40_percent_markup: {descripción:\"El cliente retira a una billetera externa (40% de margen de gas para el administrador)\", punto final:\"POST /api/v1/gateway/withdraw\", solicitud: {fromAccountId:\"va-123\", activo:\"ETH\", importe:\"1.0\", dirección:\"0x1234567890abcdef...\"}, respuesta: {éxito:!0, retiro: {id:\"withdraw-789\", activo:\"ETH\", importe:\"1.0\", dirección:\"0x1234567890abcdef...\", gasReal:\"3 USD\", gasCharged:\"4.20 USD (40% de margen)\", adminProfit:\"1.20 USD\", estado:\"pendiente\", txHash:\"0xabcd...\"}}}, ver_historial_de_transacciones: {descripción:\"El cliente visualiza su transacción historial\", punto final:\"GET /api/v1/transactions?limit=50\", respuesta:{éxito:!0, transacciones:[{id:\"swap-456\", tipo:\"internal_swap\", activo:\"BTC\", importe:\"1.0\", comisión:\"0.005\", estado:\"completado\", creado el:\"2024-11-30T10:00:00Z\"}], paginación:{total:42, límite:50, desplazamiento:0}}}}, ejemplos_rwa:{título:\"Ejemplos de paneles RWA\", crear_rwa_token_500_setup:{descripción:\"El cliente crea un token (paga $500 de tarifa de configuración al administrador)\", punto final:\"POST /api/v1/rwa/tokens\",solicitud:{nombreDeActivo:\"Fondo Inmobiliario\",símbolo:\"REF\",cadenaDeBlockchain:\"Ethereum\",decimales:18,suministroTotal:\"1000000\",nombreDeEmisor:\"RE Properties Inc\",descripción:\"Inversión Inmobiliaria Tokenizada\"},respuesta:{éxito:!0,token:{id:\"token-ref-1\",nombreDeActivo:\"Fondo inmobiliario\", símbolo:\"REF\", cadena de bloques:\"ethereum\", suministro total:\"1000000\", dirección del contrato inteligente:\"0x...\", estado:\"creado\"}, precios: {tarifa de configuración:\"$500 (pago único) - PAGADO AL ADMINISTRADOR\", tarifa anual:\"$200/año - PAGADO AL ADMINISTRADOR\", comisión de negociación:\"0.5% en todas las operaciones - 100% PARA EL ADMINISTRADOR\"}}}, lista_rwa_tokens: {descripción:\"El cliente visualiza sus tokens y volumen de operaciones\", punto final:\"GET /api/v1/rwa/tokens\", respuesta: {éxito:!0, tokens:[{id:\"token-ref-1\", nombre_del_activo:\"Bienes raíces Fondo\", símbolo:\"REF\", cadena de bloques:\"ethereum\", oferta total:\"1000000\", estado:\"activo\", tarifa de configuración:\"500, tarifa anual:\"200, volumen de negociación:\"250000 USD\", comisión de negociación:\"1250 USD (0,5 % para el administrador)\"}], resumen:{totalTokens:\"1, comisiones de negociación totales:\"1250 USD (100 % para el administrador)\", tarifas de configuración cobradas:\"500 USD (100 % para el administrador)\"}}}, rwa_token_transfer_0_5_percent:{descripción:\"El titular del token negocia el token REF (0,5 % de comisión para el administrador)\", punto final:\"POST /api/v1/rwa/tokens/token-ref-1/transfer\",request:{toAddress:\"0xabcd...\",amount:\"100\"},response:{success:!0,transfer:{id:\"transfer-123\",tokenId:\"token-ref-1\",amount:\"100 REF\",toAddress:\"0xabcd...\",commission:\"0.5 REF (0.5% para el administrador)\",status:\"completed\",txHash:\"0x...\"},note:\"0.5% de comisión de trading aplicada y cobrada por el administrador\"}}},admin_examples:{title:\"Ejemplos del panel de administración\",view_revenue:{description:\"El administrador visualiza los ingresos totales (swaps + margen de gas)\",endpoint:\"GET /api/admin/revenue\",respuesta:{éxito:!0,cryptoRevenue:{totalSwapCommissions:\"1245.67 USD\",totalGasMarkupRevenue:\"3456.78 USD\",totalVolume:\"249000 USD\",revenueByBlockchain:{ethereum:\"2345.67\",polygon:\"1234.56\",bitcoin:\"3456.78\"}}}},view_rwa_revenue:{description:\"El administrador visualiza los ingresos de RWA (comisiones de configuración + anuales + de trading)\",endpoint:\"GET /api/admin/rwa-revenue\",respuesta:{éxito:!0,rwaRevenue:{setupFees:{count:12,total:\"6000 USD\", Tarifas anuales: {Clientes activos: 12, Total: 2400 USD\", Comisiones por operaciones: {Este mes: 12500 USD\", Este año: 125000 USD\", Tasa: 0,5 % del volumen total de operaciones\", Ingresos mensuales totales: 15000 USD\", Seguridad: {Autenticación: encabezado x-api-key (recomendado Tatum v3)\", Cifrado: Todas las claves privadas cifradas con AES-256\", Auditoría: Todas las transacciones registradas con registro de auditoría completo\", Límite de tasa: Starter 10/s, Scale 100/s, Enterprise 1000/seg\",documentación:\"https://docs.tatum.io/docs/authentication\"}})}),t.get(\"/api/test-tatum\",async(s,a)=>{try{let e=await B.healthCheck(),o={success:e.success,message:e.success?\"\\u2705 Conectado a la API de Tatum correctamente\":\"\\u274C Error al conectarse a la API de Tatum\",tatumApiUrl:process.env.TATUM_API_URL||\"https://api.tatum.io\",apiKeyConfigured:!!process.env.TATUM_API_KEY,apiKeyLength:process.env.TATUM_API_KEY?.length||0,timestamp:new Date().toISOString()};e.success&&e.data&&(o.blockchainInfo={chain:e.data.chain,blocks:e.data.blocks,mempool:e.data.mempool}),e.error&&(o.error=e.error,o.statusCode=e.statusCode),a.json({success:e.success,test:\"Prueba de conexión a la API de Tatum\",status:o,instructions:{production:\"Configure la variable de entorno TATUM_API_KEY con su API de producción de Tatum key\",documentation:\"https://docs.tatum.io/docs/authentication\",getApiKey:\"https://dashboard.tatum.io\"},requestId:s.requestId})}catch(e){a.status(500).json({success:!1,test:\"Prueba de conexión de la API de Tatum\",error:e.message,message:\"Error al probar la conexión de Tatum\",instructions:{checkApiKey:\"Asegúrese de que TATUM_API_KEY esté configurado en las variables de entorno\",checkUrl:\"Verifique que TATUM_API_URL esté correct\",documentation:\"https://docs.tatum.io/docs/authentication\"},requestId:s.requestId})}}),t.get(\"/api/docs\",(s,a)=>{a.json({title:\"Tatum API Gateway - Documentación completa\",message:\"Para obtener más información, visite estos puntos finales de la documentación:\",available_docs:{business_model:\"GET /api/docs/model - Explicación completa de los flujos de ingresos\",examples:\"GET /api/docs/examples - Ejemplos de uso para Crypto y RWA\",tatum_test:\"GET /api/test-tatum - Conexión de prueba a la API de Tatum (verificación de producción)\",this_endpoint:\"GET /api/docs - Esta página\",api_root:\"GET / - Información de la API y descripción general del modelo de negocio\"},quick_endpoints:{\"Crypto Panel\":[\"POST /api/v1/gateway/virtual-accounts - Crear cuenta virtual\",\"POST /api/v1/gateway/swap - Swap interno (comisión del 0,5%)\",\"POST /api/v1/gateway/withdraw - Retiro externo (margen de beneficio del 40%)\",\"GET /api/v1/transactions - Historial de transacciones\"],\"Panel RWA\":[\"POST /api/v1/rwa/tokens - Crear token (comisión de instalación de 500$)\",\"GET /api/v1/rwa/tokens - Listar tokens\",\"POST /api/v1/rwa/tokens/:id/transfer - Intercambio de tokens (comisión del 0,5%)\"],Admin:[\"GET /api/admin/revenue - Panel de ingresos de criptomonedas\",\"GET /api/admin/rwa-revenue - Panel de ingresos de RWA\",\"GET /api/admin/master-wallets - Lista de billeteras maestras\",\"POST /api/admin/master-wallets - Crear billetera maestra\"]},authentication:{method:\"x-api-key header\",example:\"Authorization: x-api-key YOUR_API_KEY\",documentation:\"https://docs.tatum.io/docs/authentication\"},support:{github:\"https://github.com/MasterFital/tatum-api-gateway\",tatum_docs:\"https://api.tatum.io/docs\",api_reference:\"https://docs.tatum.io/reference/welcome-to-the-tatum-api-reference\"}})}),t.get(\"/api/health\",async(s,a)=>{let e=await B.healthCheck();a.json({éxito:!0,estado:\"saludable\",servicios:{api:\"saludable\",base de datos:\"saludable\",tatum:e.success?\"saludable\":\"degradado\"},marca de tiempo:nueva Fecha().toISOString()})}), t.get(\"/api/pricing\",(s,a)=>{a.json({éxito:!0,precios:le,niveles:Object.entries(H).map(([e,o])=>({id:e,...o,precios:{starter:{mensual:0,incluido:1e4},escala:{mensual:99,incluido:1e5},empresa:{mensual:\"personalizado\",incluido:\"ilimitado\"}}[e]}))})}), t.get(\"/api/cadenas\",(s,a)=>{a.json({éxito:!0,cadenas:me,total:me.length})}), t.post(\"/api/inquilinos\",async(s,a)=>{try{let e=Yt.parse(s.body);if(await p.getTenantByEmail(e.email))return a.status(409).json({éxito:!1,error:\"Correo electrónico ya registrado\"});let{key:c,prefix:d,hash:y}=Ie(),m=H[e.tier],I=await p.createTenant({nombre:e.nombre,correo electrónico:e.correo electrónico,nivel:e.nivel,estado:\"activo\",apiKeyPrefix:d,apiKeyHash:y,hmacSecret:we(),allowedChains:[...m.cadenas],maxAddresses:m.maxAddresses,maxWebhooks:m.maxWebhooks,maxVirtualAccounts:m.maxVirtualAccounts,rateLimit:m.rateLimit,monthlyQuota:m.monthlyQuota,companyName:e.companyName,website:e.website,billingEmail:e.billingEmail});await p.createAuditLog({tenantId:I.id,action:\"tenant.created\",resource:\"tenant\",resourceId:I.id,changes:{tier:e.tier}}),a.status(201).json({success:!0,tenant:{id:I.id,name:I.name,email:I.email,tier:I.tier,status:I.status,apiKey:c,hmacSecret:I.hmacSecret,limits:{chains:I.allowedChains,maxAddresses:I.maxAddresses,maxWebhooks:I.maxWebhooks,maxVirtualAccounts:I.maxVirtualAccounts,rateLimit:I.rateLimit,monthlyQuota:I.monthlyQuota},createdAt:I.createdAt},warning:\"Guarde su clave API ahora. No se puede recuperar de nuevo.\"})}catch(e){if(e.name===\"ZodError\")return a.status(400).json({éxito:!1,error:\"Error de validación\",details:e.errors});console.error(\"Error al crear inquilino:\",e),a.status(500).json({éxito:!1,error:\"Error interno del servidor\"})}}),t.get(\"/api/tenants\",async(s,a)=>{try{let e=await p.getAllTenants(),o=await Promise.all(e.map(async c=>{let d=await be(c.id),y=await p.countAddressesByTenant(c.id); return{id:c.id,name:c.name,email:c.email,tier:c.tier,status:c.status,companyName:c.companyName,addressCount:y,usage:{requests:d.totalRequests,units:Math.floor(d.totalUnits),costUsd:d.costUsd.toFixed(4)},createdAt:c.createdAt}}));a.json({success:!0,tenants:o})}catch(e){console.error(\"Error al obtener inquilinos:\",e),a.status(500).json({success:!1,error:\"Error interno del servidor\"})}}),t.get(\"/api/tenants/:id\",b,async(s,a)=>{try{let e=espera p.getTenant(s.params.id);si(!e)devuelve a.status(404).json({éxito:!1,error:\"No se encontró el inquilino\"}); sea o=await be(e.id),c=await Se(e.id,e.monthlyQuota),d=await p.countAddressesByTenant(e.id),y=await p.countWebhooksByTenant(e.id),m=await p.countVirtualAccountsByTenant(e.id);a.json({éxito:!0, inquilino:{id:e.id, nombre:e.name, correo electrónico:e.email, nivel:e.tier, estado:e.status, nombreDeEmpresa:e.nombreDeEmpresa, sitio web:e.website, correo electrónicoDeFacturación:e.correoElectrónicoDeFacturación, prefijoDeClaveAPI:e.prefijoDeClaveAPI, límites:{cadenas:e.cadenaspermitidas, direccionesmáximas:e.direccionesmáximas, webhooksmáx:e.webhooksmáx, cuentasvirtualesmáx:e.accesoVirtual recuentos, rateLimit:e.rateLimit, monthlyQuota:e.monthlyQuota}, uso:{direcciones:d, webhooks:y, cuentas virtuales:m, solicitudes:o.totalRequests, unidades:Math.floor(o.totalUnits), costoUsd:o.costUsd.toFixed(4), cuota:{usado:c.usado, restante:c.restante, porcentajeUsado:Math.round(c.porcentajeUsado)}}, creadoEn:e.creadoEn, actualizadoEn:e.actualizadoEn}})}catch(e){console.error(\"Obtener Error de inquilino:\",e),a.status(500).json({éxito:!1,error:\"Error interno del servidor\"})}}),t.patch(\"/api/tenants/:id\",b,async(s,a)=>{try{if(s.tenant.id!==s.params.id)return a.status(403).json({éxito:!1,error:\"Solo puede actualizar su propia cuenta\",requestId:s.requestId});let e=s.body,o=[\"nombre\",\"nombreDeEmpresa\",\"sitio web\",\"correo electrónico de facturación\"],c={};for(let y of o)e[y]!==void 0&&(c[y]=e[y]);if(Object.keys(c).length===0)return a.status(400).json({éxito:!1,error:\"No hay campos válidos para actualizar\",requestId:s.requestId});let d=await p.updateTenant(s.params.id,c);if(!d)return a.status(404).json({éxito:!1,error:\"No se encontró el inquilino\"});await p.createAuditLog({tenantId:d.id,acción:\"inquilino.actualizado\",resource:\"inquilino\",resourceId:d.id,cambios:c,ipAddress:s.ip}),a.json({éxito:!0,inquilino:d,requestId:s.requestId})}catch(e){console.error(\"Actualizar inquilino error:\",e),a.status(500).json({éxito:!1,error:\"Error interno del servidor\"})}}),t.post(\"/api/tenants/:id/rotate-key\",b,async(s,a)=>{try{let e=await p.getTenant(s.params.id);if(!e)return a.status(404).json({éxito:!1,error:\"No se encontró el inquilino\"});if(s.tenant.id!==e.id)return a.status(403).json({éxito:!1,error:\"Solo puede rotar su propia clave API\",requestId:s.requestId});let{key:o,prefix:c,hash:d}=Ie();await p.updateTenant(e.id,{apiKeyPrefix:c,apiKeyHash:d}),await p.createAuditLog({tenantId:e.id,action:\"apikey.rotated\",resource:\"tenant\",resourceId:e.id,changes:{rotated:!0}}),a.json({success:!0,apiKey:o,warning:\"Guarde su nueva clave API. La clave anterior ya no es válida y no se puede recuperar.\",requestId:s.requestId})}catch(e){console.error(\"Error al rotar la clave API:\",e),a.status(500).json({success:!1,error:\"Servidor interno error\"})}}),t.patch(\"/api/admin/tenants/:id\",$,async(s,a)=>{try{let e=s.body;if(e.tier){let c=H[e.tier];c&&(e.allowedChains=c.chains,e.maxAddresses=c.maxAddresses,e.maxWebhooks=c.maxWebhooks,e.maxVirtualAccounts=c.maxVirtualAccounts,e.rateLimit=c.rateLimit,e.monthlyQuota=c.monthlyQuota)}let o=await p.updateTenant(s.params.id,e);if(!o)return a.status(404).json({éxito:!1,error:\"No se encontró el inquilino\"});await p.createAuditLog({Id.inquilino:o.id,acción:\"admin.tenant.updated\",recurso:\"inquilino\",Id.recurso:o.id,cambios:e,direcciónIP:s.ip}),a.json({éxito:!0,inquilino:o,Id.solicitud:s.Id.solicitud})}catch(e){console.error(\"El administrador actualiza el inquilino error:\",e),a.status(500).json({éxito:!1,error:\"Error interno del servidor\"})}}),t.post(\"/api/admin/tenants/:id/suspend\",$,async(s,a)=>{try{let e=await p.updateTenant(s.params.id,{status:\"suspendido\"});if(!e)return a.status(404).json({éxito:!1,error:\"Inquilino no encontrado\"});await p.createAuditLog({tenantId:e.id,action:\"admin.tenant.suspended\",resource:\"tenant\",resourceId:e.id,changes:{status:\"suspended\"},ipAddress:s.ip}),a.json({success:!0,message:\"Inquilino suspendido\",requestId:s.requestId})}catch(e){console.error(\"Error de suspensión del inqui
{"mensaje":"","atributos":{"nivel":"información"},"marca de tiempo":"2025-11-30T18:34:53.698591313Z"}
{"mensaje":"> rest-express@1.0.0 inicio","atributos":{"nivel":"información"},"marca de tiempo":"2025-11-30T18:34:53.698599736Z"}
{"mensaje":"> NODE_ENV=nodo de producción dist/index.js","atributos":{"nivel":"información"},"marca de tiempo":"2025-11-30T18:34:53.698607637Z"}
{"mensaje":"","atributos":{"nivel":"información"},"marca de tiempo":"2025-11-30T18:34:53.698615245Z"}
{"mensaje":"archivo:///app/dist/index.js:1","atributos":{"nivel":"error"},"marca de tiempo":"2025-11-30T18:34:53.988160099Z"}
